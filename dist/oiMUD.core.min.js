(()=>{var $t=Object.create;var Tt=Object.defineProperty;var Ht=Object.getOwnPropertyDescriptor;var Xt=Object.getOwnPropertyNames;var Gt=Object.getPrototypeOf,jt=Object.prototype.hasOwnProperty;var Pt=(m,c)=>()=>(c||m((c={exports:{}}).exports,c),c.exports);var zt=(m,c,t,e)=>{if(c&&typeof c=="object"||typeof c=="function")for(let n of Xt(c))!jt.call(m,n)&&n!==t&&Tt(m,n,{get:()=>c[n],enumerable:!(e=Ht(c,n))||e.enumerable});return m};var _t=(m,c,t)=>(t=m!=null?$t(Gt(m)):{},zt(c||!m||!m.__esModule?Tt(t,"default",{value:m,enumerable:!0}):t,m));var Dt=Pt(At=>{(function(){"use strict";var m=void 0,c=!0,t=this;function e(T,L){var F=T.split("."),R=t;!(F[0]in R)&&R.execScript&&R.execScript("var "+F[0]);for(var k;F.length&&(k=F.shift());)!F.length&&L!==m?R[k]=L:R=R[k]?R[k]:R[k]={}}var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u"&&typeof DataView<"u";function s(T){var L=T.length,F=0,R=Number.POSITIVE_INFINITY,k,D,O,j,w,Q,A,I,N,X;for(I=0;I<L;++I)T[I]>F&&(F=T[I]),T[I]<R&&(R=T[I]);for(k=1<<F,D=new(n?Uint32Array:Array)(k),O=1,j=0,w=2;O<=F;){for(I=0;I<L;++I)if(T[I]===O){for(Q=0,A=j,N=0;N<O;++N)Q=Q<<1|A&1,A>>=1;for(X=O<<16|I,N=Q;N<k;N+=w)D[N]=X;++j}++O,j<<=1,w<<=1}return[D,F,R]}function i(T,L,F){this.u=[],this.i=F||32768,this.v=0,this.a=L===m?0:L,this.d=this.e=0,this.input=n?new Uint8Array(T):T,this.b=new(n?Uint8Array:Array)(this.i),this.c=0,this.t=this.l=!1,this.f=0,this.status=o}var o=0;i.prototype.j=function(T,L){var F=!1;for(T!==m&&(this.input=T),L!==m&&(this.a=L);!F;)switch(this.status){case o:case 1:var R,k=m;if(this.status=1,U(this),0>(k=d(this,3)))q(this),R=-1;else{switch(k&1&&(this.l=c),k>>>=1,k){case 0:this.h=0;break;case 1:this.h=1;break;case 2:this.h=2;break;default:throw Error("unknown BTYPE: "+k)}this.status=2,R=m}0>R&&(F=c);break;case 2:case 3:switch(this.h){case 0:var D,O=m,j=m,w=this.input,Q=this.a;if(this.status=3,Q+4>=w.length)D=-1;else{if(O=w[Q++]|w[Q++]<<8,j=w[Q++]|w[Q++]<<8,O===~j)throw Error("invalid uncompressed block header: length verify");this.d=this.e=0,this.a=Q,this.m=O,this.status=4,D=m}0>D&&(F=c);break;case 1:this.status=3,this.k=x,this.n=y,this.status=4;break;case 2:var A;e:{var I=m,N=m,X=m,J=new(n?Uint8Array:Array)(a.length),ae=m;if(this.status=3,U(this),I=d(this,5)+257,N=d(this,5)+1,X=d(this,4)+4,0>I||0>N||0>X)q(this),A=-1;else{try{for(var ne=m,se=m,be=0,he=m,z=m,ue=m,Et=m,ue=0;ue<X;++ue){if(0>(ne=d(this,3)))throw Error("not enough input");J[a[ue]]=ne}for(ae=s(J),z=new(n?Uint8Array:Array)(I+N),ue=0,Et=I+N;ue<Et;){if(se=v(this,ae),0>se)throw Error("not enough input");switch(se){case 16:if(0>(ne=d(this,2)))throw Error("not enough input");for(he=3+ne;he--;)z[ue++]=be;break;case 17:if(0>(ne=d(this,3)))throw Error("not enough input");for(he=3+ne;he--;)z[ue++]=0;be=0;break;case 18:if(0>(ne=d(this,7)))throw Error("not enough input");for(he=11+ne;he--;)z[ue++]=0;be=0;break;default:be=z[ue++]=se}}new(n?Uint8Array:Array)(I),new(n?Uint8Array:Array)(N),this.k=s(n?z.subarray(0,I):z.slice(0,I)),this.n=s(n?z.subarray(I):z.slice(I))}catch{q(this),A=-1;break e}this.status=4,A=0}}0>A&&(F=c)}break;case 4:case 5:switch(this.h){case 0:var ot;e:{var xt=this.input,Xe=this.a,ht=this.b,Ge=this.c,ut=this.m;for(this.status=5;ut--;){if(Ge===ht.length&&(ht=ie(this,{o:2})),Xe>=xt.length){this.a=Xe,this.c=Ge,this.m=ut+1,ot=-1;break e}ht[Ge++]=xt[Xe++]}0>ut&&(this.status=6),this.a=Xe,this.c=Ge,ot=0}0>ot&&(F=c);break;case 1:case 2:0>re(this)&&(F=c)}break;case 6:this.l?F=c:this.status=o}var kt,fe=this.c,Ct;return kt=this.t?n?new Uint8Array(this.b.subarray(this.f,fe)):this.b.slice(this.f,fe):n?this.b.subarray(this.f,fe):this.b.slice(this.f,fe),this.f=fe,fe>32768+this.i&&(this.c=this.f=32768,n?(Ct=this.b,this.b=new Uint8Array(this.i+32768),this.b.set(Ct.subarray(fe-32768,fe))):this.b=this.b.slice(fe-32768)),kt};var r=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],a=n?new Uint16Array(r):r,l=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],f=n?new Uint16Array(l):l,u=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],b=n?new Uint8Array(u):u,h=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],E=n?new Uint16Array(h):h,S=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],p=n?new Uint8Array(S):S,g=new(n?Uint8Array:Array)(288),C,P;for(C=0,P=g.length;C<P;++C)g[C]=143>=C?8:255>=C?9:279>=C?7:8;var x=s(g),G=new(n?Uint8Array:Array)(30),M,_;for(M=0,_=G.length;M<_;++M)G[M]=5;var y=s(G);function d(T,L){for(var F=T.e,R=T.d,k=T.input,D=T.a,O;R<L;){if(k.length<=D)return-1;O=k[D++],F|=O<<R,R+=8}return O=F&(1<<L)-1,T.e=F>>>L,T.d=R-L,T.a=D,O}function v(T,L){for(var F=T.e,R=T.d,k=T.input,D=T.a,O=L[0],j=L[1],w,Q,A;R<j;){if(k.length<=D)return-1;w=k[D++],F|=w<<R,R+=8}if(Q=O[F&(1<<j)-1],A=Q>>>16,A>R)throw Error("invalid code length: "+A);return T.e=F>>A,T.d=R-A,T.a=D,Q&65535}function U(T){T.s=T.a,T.r=T.d,T.q=T.e}function q(T){T.a=T.s,T.d=T.r,T.e=T.q}function re(T){var L=T.b,F=T.c,R,k,D,O,j=T.k,w=T.n,Q=L.length,A;for(T.status=5;;){if(U(T),R=v(T,j),0>R)return T.c=F,q(T),-1;if(R===256)break;if(256>R)F===Q&&(L=ie(T),Q=L.length),L[F++]=R;else{if(k=R-257,O=f[k],0<b[k]){if(A=d(T,b[k]),0>A)return T.c=F,q(T),-1;O+=A}if(R=v(T,w),0>R)return T.c=F,q(T),-1;if(D=E[R],0<p[R]){if(A=d(T,p[R]),0>A)return T.c=F,q(T),-1;D+=A}for(F+O>=Q&&(L=ie(T),Q=L.length);O--;)L[F]=L[F++-D];if(T.a===T.input.length)return T.c=F,-1}}for(;8<=T.d;)T.d-=8,T.a--;T.c=F,T.status=6}function ie(T,L){var F,R=T.input.length/T.a+1|0,k,D,O,j=T.input,w=T.b;return L&&(typeof L.o=="number"&&(R=L.o),typeof L.p=="number"&&(R+=L.p)),2>R?(k=(j.length-T.a)/T.k[2],O=258*(k/2)|0,D=O<w.length?w.length+O:w.length<<1):D=w.length*R,n?(F=new Uint8Array(D),F.set(w)):F=w,T.b=F,T.b}function Y(T){this.input=T===m?new(n?Uint8Array:Array):T,this.a=0,this.g=new i(this.input,this.a),this.b=this.g.b}Y.prototype.j=function(T){var L;if(T!==m)if(n){var F=new Uint8Array(this.input.length+T.length);F.set(this.input,0),F.set(T,this.input.length),this.input=F}else this.input=this.input.concat(T);var R;if(R=this.method===m){var k,D=this.a,O=this.input,j=O[D++],w=O[D++];if(j===m||w===m)k=-1;else{switch(j&15){case 8:this.method=8;break;default:throw Error("unsupported compression method")}if(((j<<8)+w)%31!==0)throw Error("invalid fcheck flag:"+((j<<8)+w)%31);if(w&32)throw Error("fdict flag is not supported");this.a=D,k=m}R=0>k}return R?new(n?Uint8Array:Array):(L=this.g.j(this.input,this.a),this.g.a!==0&&(this.input=n?this.input.subarray(this.g.a):this.input.slice(this.g.a),this.a=0),L)},e("Zlib.InflateStream",Y),e("Zlib.InflateStream.prototype.decompress",Y.prototype.j)}).call(At)});var Ut=Pt((Ft,rt)=>{(function(m,c){"use strict";typeof rt<"u"&&rt.exports?rt.exports=c():typeof define=="function"&&define.amd?define([],c):m.buzz=c()})(Ft,function(){"use strict";var m=window.AudioContext||window.webkitAudioContext,c={defaults:{autoplay:!1,duration:5e3,formats:[],loop:!1,placeholder:"--",preload:"metadata",volume:80,webAudioApi:!1,document:window.document},types:{mp3:"audio/mpeg",ogg:"audio/ogg",wav:"audio/wav",aac:"audio/aac",m4a:"audio/x-m4a"},sounds:[],el:document.createElement("audio"),getAudioContext:function(){if(this.audioCtx===void 0)try{this.audioCtx=m?new m:null}catch{this.audioCtx=null}return this.audioCtx},sound:function(t,e){e=e||{};var n=e.document||c.defaults.document,s=0,i=[],o={},r=c.isSupported();this.load=function(){return r?(this.sound.load(),this):this},this.play=function(){return r?(this.sound.play(),this):this},this.togglePlay=function(){return r?(this.sound.paused?this.sound.play():this.sound.pause(),this):this},this.pause=function(){return r?(this.sound.pause(),this):this},this.isPaused=function(){return r?this.sound.paused:null},this.stop=function(){return r?(this.setTime(0),this.sound.pause(),this):this},this.isEnded=function(){return r?this.sound.ended:null},this.loop=function(){return r?(this.sound.loop="loop",this.bind("ended.buzzloop",function(){this.currentTime=0,this.play()}),this):this},this.unloop=function(){return r?(this.sound.removeAttribute("loop"),this.unbind("ended.buzzloop"),this):this},this.mute=function(){return r?(this.sound.muted=!0,this):this},this.unmute=function(){return r?(this.sound.muted=!1,this):this},this.toggleMute=function(){return r?(this.sound.muted=!this.sound.muted,this):this},this.isMuted=function(){return r?this.sound.muted:null},this.setVolume=function(E){return r?(E<0&&(E=0),E>100&&(E=100),this.volume=E,this.sound.volume=E/100,this):this},this.getVolume=function(){return r?this.volume:this},this.increaseVolume=function(E){return this.setVolume(this.volume+(E||1))},this.decreaseVolume=function(E){return this.setVolume(this.volume-(E||1))},this.setTime=function(E){if(!r)return this;var S=!0;return this.whenReady(function(){S===!0&&(S=!1,this.sound.currentTime=E)}),this},this.getTime=function(){if(!r)return null;var E=Math.round(this.sound.currentTime*100)/100;return isNaN(E)?c.defaults.placeholder:E},this.setPercent=function(E){return r?this.setTime(c.fromPercent(E,this.sound.duration)):this},this.getPercent=function(){if(!r)return null;var E=Math.round(c.toPercent(this.sound.currentTime,this.sound.duration));return isNaN(E)?c.defaults.placeholder:E},this.setSpeed=function(E){return r?(this.sound.playbackRate=E,this):this},this.getSpeed=function(){return r?this.sound.playbackRate:null},this.getDuration=function(){if(!r)return null;var E=Math.round(this.sound.duration*100)/100;return isNaN(E)?c.defaults.placeholder:E},this.getPlayed=function(){return r?a(this.sound.played):null},this.getBuffered=function(){return r?a(this.sound.buffered):null},this.getSeekable=function(){return r?a(this.sound.seekable):null},this.getErrorCode=function(){return r&&this.sound.error?this.sound.error.code:0},this.getErrorMessage=function(){if(!r)return null;switch(this.getErrorCode()){case 1:return"MEDIA_ERR_ABORTED";case 2:return"MEDIA_ERR_NETWORK";case 3:return"MEDIA_ERR_DECODE";case 4:return"MEDIA_ERR_SRC_NOT_SUPPORTED";default:return null}},this.getStateCode=function(){return r?this.sound.readyState:null},this.getStateMessage=function(){if(!r)return null;switch(this.getStateCode()){case 0:return"HAVE_NOTHING";case 1:return"HAVE_METADATA";case 2:return"HAVE_CURRENT_DATA";case 3:return"HAVE_FUTURE_DATA";case 4:return"HAVE_ENOUGH_DATA";default:return null}},this.getNetworkStateCode=function(){return r?this.sound.networkState:null},this.getNetworkStateMessage=function(){if(!r)return null;switch(this.getNetworkStateCode()){case 0:return"NETWORK_EMPTY";case 1:return"NETWORK_IDLE";case 2:return"NETWORK_LOADING";case 3:return"NETWORK_NO_SOURCE";default:return null}},this.set=function(E,S){return r?(this.sound[E]=S,this):this},this.get=function(E){return r?E?this.sound[E]:this.sound:null},this.bind=function(E,S){if(!r)return this;E=E.split(" ");for(var p=this,g=function(G){S.call(p,G)},C=0;C<E.length;C++){var P=E[C],x=P;P=x.split(".")[0],i.push({idx:x,func:g}),this.sound.addEventListener(P,g,!0)}return this},this.unbind=function(E){if(!r)return this;E=E.split(" ");for(var S=0;S<E.length;S++)for(var p=E[S],g=p.split(".")[0],C=0;C<i.length;C++){var P=i[C].idx.split(".");(i[C].idx===p||P[1]&&P[1]===p.replace(".",""))&&(this.sound.removeEventListener(g,i[C].func,!0),i.splice(C,1))}return this},this.bindOnce=function(E,S){if(!r)return this;var p=this;return o[s++]=!1,this.bind(E+"."+s,function(){o[s]||(o[s]=!0,S.call(p)),p.unbind(E+"."+s)}),this},this.trigger=function(E,S){if(!r)return this;E=E.split(" ");for(var p=0;p<E.length;p++)for(var g=E[p],C=0;C<i.length;C++){var P=i[C].idx.split(".");if(i[C].idx===g||P[0]&&P[0]===g.replace(".","")){var x=n.createEvent("HTMLEvents");x.initEvent(P[0],!1,!0),x.originalEvent=S,this.sound.dispatchEvent(x)}}return this},this.fadeTo=function(E,S,p){if(!r)return this;S instanceof Function?(p=S,S=c.defaults.duration):S=S||c.defaults.duration;var g=this.volume,C=S/Math.abs(g-E),P=this;this.play();function x(){setTimeout(function(){g<E&&P.volume<E?(P.setVolume(P.volume+=1),x()):g>E&&P.volume>E?(P.setVolume(P.volume-=1),x()):p instanceof Function&&p.apply(P)},C)}return this.whenReady(function(){x()}),this},this.fadeIn=function(E,S){return r?this.setVolume(0).fadeTo(100,E,S):this},this.fadeOut=function(E,S){return r?this.fadeTo(0,E,S):this},this.fadeWith=function(E,S){return r?(this.fadeOut(S,function(){this.stop()}),E.play().fadeIn(S),this):this},this.whenReady=function(E){if(!r)return null;var S=this;this.sound.readyState===0?this.bind("canplay.buzzwhenready",function(){E.call(S)}):E.call(S)},this.addSource=function(E){var S=this,p=n.createElement("source");return p.src=E,c.types[l(E)]&&(p.type=c.types[l(E)]),this.sound.appendChild(p),p.addEventListener("error",function(g){S.trigger("sourceerror",g)}),p};function a(E){for(var S=[],p=E.length-1,g=0;g<=p;g++)S.push({start:E.start(g),end:E.end(g)});return S}function l(E){return E.split(".").pop()}if(r&&t){for(var f in c.defaults)c.defaults.hasOwnProperty(f)&&e[f]===void 0&&(e[f]=c.defaults[f]);if(this.sound=n.createElement("audio"),e.webAudioApi){var u=c.getAudioContext();u&&(this.source=u.createMediaElementSource(this.sound),this.source.connect(u.destination))}if(t instanceof Array)for(var b in t)t.hasOwnProperty(b)&&this.addSource(t[b]);else if(e.formats.length)for(var h in e.formats)e.formats.hasOwnProperty(h)&&this.addSource(t+"."+e.formats[h]);else this.addSource(t);e.loop&&this.loop(),e.autoplay&&(this.sound.autoplay="autoplay"),e.preload===!0?this.sound.preload="auto":e.preload===!1?this.sound.preload="none":this.sound.preload=e.preload,this.setVolume(e.volume),c.sounds.push(this)}},group:function(t){t=n(t,arguments),this.getSounds=function(){return t},this.add=function(s){s=n(s,arguments);for(var i=0;i<s.length;i++)t.push(s[i])},this.remove=function(s){s=n(s,arguments);for(var i=0;i<s.length;i++)for(var o=0;o<t.length;o++)if(t[o]===s[i]){t.splice(o,1);break}},this.load=function(){return e("load"),this},this.play=function(){return e("play"),this},this.togglePlay=function(){return e("togglePlay"),this},this.pause=function(s){return e("pause",s),this},this.stop=function(){return e("stop"),this},this.mute=function(){return e("mute"),this},this.unmute=function(){return e("unmute"),this},this.toggleMute=function(){return e("toggleMute"),this},this.setVolume=function(s){return e("setVolume",s),this},this.increaseVolume=function(s){return e("increaseVolume",s),this},this.decreaseVolume=function(s){return e("decreaseVolume",s),this},this.loop=function(){return e("loop"),this},this.unloop=function(){return e("unloop"),this},this.setSpeed=function(s){return e("setSpeed",s),this},this.setTime=function(s){return e("setTime",s),this},this.set=function(s,i){return e("set",s,i),this},this.bind=function(s,i){return e("bind",s,i),this},this.unbind=function(s){return e("unbind",s),this},this.bindOnce=function(s,i){return e("bindOnce",s,i),this},this.trigger=function(s){return e("trigger",s),this},this.fade=function(s,i,o,r){return e("fade",s,i,o,r),this},this.fadeIn=function(s,i){return e("fadeIn",s,i),this},this.fadeOut=function(s,i){return e("fadeOut",s,i),this};function e(){for(var s=n(null,arguments),i=s.shift(),o=0;o<t.length;o++)t[o][i].apply(t[o],s)}function n(s,i){return s instanceof Array?s:Array.prototype.slice.call(i)}},all:function(){return new c.group(c.sounds)},isSupported:function(){return!!c.el.canPlayType},isOGGSupported:function(){return!!c.el.canPlayType&&c.el.canPlayType('audio/ogg; codecs="vorbis"')},isWAVSupported:function(){return!!c.el.canPlayType&&c.el.canPlayType('audio/wav; codecs="1"')},isMP3Supported:function(){return!!c.el.canPlayType&&c.el.canPlayType("audio/mpeg;")},isAACSupported:function(){return!!c.el.canPlayType&&(c.el.canPlayType("audio/x-m4a;")||c.el.canPlayType("audio/aac;"))},toTimer:function(t,e){var n,s,i;return n=Math.floor(t/3600),n=isNaN(n)?"--":n>=10?n:"0"+n,s=Math.floor(e?t/60%60:t/60),s=isNaN(s)?"--":s>=10?s:"0"+s,i=Math.floor(t%60),i=isNaN(i)?"--":i>=10?i:"0"+i,e?n+":"+s+":"+i:s+":"+i},fromTimer:function(t){var e=t.toString().split(":");return e&&e.length===3&&(t=parseInt(e[0],10)*3600+parseInt(e[1],10)*60+parseInt(e[2],10)),e&&e.length===2&&(t=parseInt(e[0],10)*60+parseInt(e[1],10)),t},toPercent:function(t,e,n){var s=Math.pow(10,n||0);return Math.round(t*100/e*s)/s},fromPercent:function(t,e,n){var s=Math.pow(10,n||0);return Math.round(e/100*t*s)/s}};return c})});var ee=class{#e={};bind(c,t){(!Array.isArray(this.#e[c])||typeof this.#e[c]>"u")&&(this.#e[c]=[]),this.#e[c].push(t)}on(c,t){this.bind(c,t)}addEventListener(c,t){this.bind(c,t)}fire(c,t,e){if(!c||typeof c!="string")throw new Error("Event missing.");if(Array.isArray(this.#e[c])){!t||t===null||typeof t>"u"?t=[]:Array.isArray(t)||(t=[t]),e=e||this;for(var n=this.#e[c],s=0,i=n.length;s<i;s++)n[s].apply(e,t)}}emit(c,...t){this.fire(c,t)}dispatchEvent(c,t,e){this.fire(c,t,e)}unbind(c,t){if(!c||!t||!Array.isArray(this.#e[c]))return;let e=this.#e[c];for(let n=0,s=e.length;n<s;n++)if(e[n]===t){e.splice(n,1);break}}remove(c,t){this.unbind(c,t)}off(c,t){this.unbind(c,t)}removeListener(c,t){this.unbind(c,t)}removeAllListeners(c){if(!c){this.#e=[];return}Array.isArray(this.#e[c])&&delete this.#e[c]}listeners(c){return c?this.#e[c]||[]:this.#e}};Array.prototype.filter||(Array.prototype.filter=function(m){var c=this.length>>>0;if(typeof m!="function")throw new TypeError;for(var t=[],e=arguments[1],n=0;n<c;n++)if(n in this){var s=this[n];m.call(e,s,n,this)&&t.push(s)}return t});function Qt(m,c){return m.priority>c.priority?-1:m.priority<c.priority?1:0}function Vt(m,c){return m.priority>c.priority?-1:m.priority<c.priority?1:m.index<c.index?-1:m.index>c.index?1:0}function W(m){let c=m.map((t,e)=>({index:e,priority:t.priority}));return c.sort(Vt),c.map(t=>m[t.index])}function Ce(m,c,t){let e=[];if(!m||m.length===0)return e;let n=m.length;for(let s=0;s<n;s++)m[s].enabled&&m[s][c]===t&&e.push(m[s]);return e.length<=1?e:e.sort(Qt)}var je=document.createElement("div");function Te(m){return je.textContent=m,je.innerHTML}function ft(m){return je.innerHTML=m,je.textContent}function B(m){return m=m.replace(/^"(.+(?="$))?"$/,"$1"),m=m.replace(/^'(.+(?='$))?'$/,"$1"),m}var pe=class{constructor(c){this.length=0;typeof c=="string"&&c.length>0?this.buffer=[c]:this.buffer=[],this.length=0}prepend(c){return this.buffer.unshift(c),this.length+=c.length,this}append(c){return this.buffer.push(c),this.length+=c.length,this}push(c){typeof c=="number"?this.appendCode(c):this.append(c)}appendCode(c){return this.buffer.push(String.fromCharCode(c)),this.length++,this}toString(){return this.buffer.join("")}clear(c){return this.buffer=[],this.length=0,c&&typeof c<"u"&&c.length&&(this.buffer.push(c),this.length=c.length),this}concat(c){this.buffer=this.buffer.concat(c)}};function ze(m,c){if(m.length>1)return!1;if(m==="-"||m==="_"||m==="."||m==="~"||m==="!"||m==="*"||m==="'"||m===";"||m===":"||m==="@"||m==="&"||m==="="||m==="+"||m==="$"||m===","||m==="/"||m==="\\"||m==="?"||m==="%"||m==="#"||m==="["||m==="]"||m==="("||m===")")return!c;let t=m.charCodeAt(0);return t>64&&t<91||t>96&&t<123||t>47&&t<58||t>=160&&t<=55295||t>=57344&&t<=64975||t>=65008&&t<=65533||t>=65536&&t<=131069||t>=131072&&t<=196605||t>=196608&&t<=262141||t>=262144&&t<=327677||t>=327680&&t<=393213||t>=393216&&t<=458749||t>=458752&&t<=524285||t>=524288&&t<=589821||t>=589824&&t<=655357||t>=655360&&t<=720893||t>=720896&&t<=786429||t>=786432&&t<=851965||t>=851968&&t<=917501||t>=921600&&t<=983037||t>=983040&&t<=1048573||t>=1048576&&t<=1114109}var pt={3:"Cancel",6:"Help",8:"Backspace",9:"Tab",19:"Pause/Break",20:"Caps Lock",21:"Kana",22:"Eisu",23:"Junja",24:"Final",25:"Hanja",27:"Esc",28:"Convert",29:"Nonconvert",30:"Accept",31:"Modechange",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",41:"Select",42:"Print",43:"Execute",44:"Printscreen",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",58:"Colon",59:"Semicolon",60:"Less Than",61:"Equals2",62:"Greater Than",63:"Question Mark",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",93:"Context Menu",95:"Sleep",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",124:"F13",125:"F14",126:"F15",127:"F16",128:"F17",129:"F18",130:"F19",131:"F20",132:"F21",133:"F22",134:"F23",135:"F24",144:"Num Lock",145:"Scroll Lock",146:"Win Oem Fj Jisho",147:"Win Oem Fj Masshou",148:"Win Oem Fj Touroku",149:"Win Oem Fj Loya",150:"Win Oem Fj Roya",160:"Circumflex",161:"Exclamation",162:"Double Quote",163:"Hash",164:"Dollar",165:"Percent",166:"Ampersand",167:"Underscore",168:"Open Paren",169:"Close Paren",170:"Asterisk",171:"Plus",172:"Pipe",173:"Hyphen Minus",174:"Open Curly Bracket",175:"Close Curly Bracket",176:"Tilde",181:"Volume Mute",182:"Volume Down",183:"Volume Up",186:";",187:"Equals",188:",",189:"Minus",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",227:"Win Ico Help",228:"Win Ico 00",230:"Win Ico Clear",233:"Win Oem Reset",234:"Win Oem Jump",235:"Win Oem Pa1",236:"Win Oem Pa2",237:"Win Oem Pa3",238:"Win Oem Wsctrl",239:"Win Oem Cusel",240:"Win Oem Attn",241:"Win Oem Finish",242:"Win Oem Copy",243:"Win Oem Auto",244:"Win Oem Enlw",245:"Win Oem Backtab",246:"Attn",247:"Crsel",248:"Exsel",249:"Ereof",250:"Play",251:"Zoom",253:"Pa1",254:"Win Oem Clear"};(function(m){m.fn.hasHorizontalScrollBar=function(){return m(this)[0].scrollWidth>m(this).innerWidth()}})(jQuery);function ye(m,c){return JSON.parse(JSON.stringify(m,c))}function Ot(m){!m||m.value.length===0||(m.setSelectionRange?(m.focus(),m.setSelectionRange(0,m.value.length)):m.select())}CanvasRenderingContext2D.prototype.fillRoundedRect=function(m,c,t,e,n){this.beginPath(),this.moveTo(m+n,c),this.lineTo(m+t-n,c),this.quadraticCurveTo(m+t,c,m+t,c+n),this.lineTo(m+t,c+e-n),this.quadraticCurveTo(m+t,c+e,m+t-n,c+e),this.lineTo(m+n,c+e),this.quadraticCurveTo(m,c+e,m,c+e-n),this.lineTo(m,c+n),this.quadraticCurveTo(m,c,m+n,c),this.closePath(),this.fill()};CanvasRenderingContext2D.prototype.strokeRoundedRect=function(m,c,t,e,n){this.beginPath(),this.moveTo(m+n,c),this.lineTo(m+t-n,c),this.quadraticCurveTo(m+t,c,m+t,c+n),this.lineTo(m+t,c+e-n),this.quadraticCurveTo(m+t,c+e,m+t-n,c+e),this.lineTo(m+n,c+e),this.quadraticCurveTo(m,c+e,m,c+e-n),this.lineTo(m,c+n),this.quadraticCurveTo(m,c,m+n,c),this.closePath(),this.stroke()};Object.keys||(Object.keys=function(m){if(m!==Object(m))throw new TypeError("Object.keys called on a non-object");var c=[],t;for(t in m)Object.prototype.hasOwnProperty.call(m,t)&&c.push(t);return c});Object.toType||(Object.toType=function(m){return{}.toString.call(m).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()});typeof String.prototype.startsWith!="function"&&(String.prototype.startsWith=function(m){return this.slice(0,m.length)==m});typeof String.prototype.endsWith!="function"&&(String.prototype.endsWith=function(m){return this.slice(-m.length)==m});typeof String.prototype.splice!="function"&&(String.prototype.splice=function(m,c,t){return typeof t>"u"&&(t=0),this.slice(0,m)+c+this.slice(m+Math.abs(t))});typeof String.prototype.padStart!="function"&&(String.prototype.padStart=function(m){return typeof m=="number"&&(m=" ".repeat(m)),String(m+this).slice(-m.length)});typeof String.prototype.padEnd!="function"&&(String.prototype.padEnd=function(m){return typeof m=="number"?m<=this.length?this:(m=" ".repeat(m-this.length),this+m):m.length<=this.length?this:this+m.slice(-this.length)});String.prototype.replaceAll||(String.prototype.replaceAll=function(m,c){return Object.prototype.toString.call(m).toLowerCase()==="[object regexp]"?this.replace(m,c):this.replace(new RegExp(m,"g"),c)});typeof Uint8Array.prototype.charAt!="function"&&(Uint8Array.prototype.charAt=function(m){return String.fromCharCode(this[m])});typeof Uint8Array.prototype.charCodeAt!="function"&&(Uint8Array.prototype.charCodeAt=function(m){return this[m]});function Yt(m,c){return!m||!m.length?m:c?m.replace(/\\/g,"\\\\").replace(/\u0008/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\u0000/g,"\\0"):m.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"')}String.prototype.addSlashes=function(){return Yt(this)};String.prototype.splitQuote=function(m,c,t,e){if(this.length===0)return[];if(!m||!m.length)return[this];c||(c=3),t||(t=3),e||(e="\\");let n=!1,s=!1,i=[],o=0,r=0,a,l="",f,u=m.length,b,h=this.length;for(;r<h;r++){if(a=this.charAt(r),a==='"'&&(c&2)===2)(t&2)===2?(r===0||l!==e)&&(n=!n):n=!n;else if(a==="'"&&(c&1)===1)(t&1)===1?(r===0||l!==e)&&(s=!s):s=!s;else if(!n&&!s){for(f=0;f<u;f++)if(b=m.charAt(f),a===b)if(r>o||r===0){i.push(this.substr(o,r-o)),o=r+1;break}else if(r===o){i.push(""),o=r+1;break}else r===h-1&&i.push("")}l=a}return r===h&&r===o&&m.indexOf(l)!==-1&&(i.push(""),o=r+1),r>o&&i.push(this.substr(o,r-o)),i};function mt(m){let c,t=[];return c=Math.floor(m/(1e3*60*60*24)),m-=c*(1e3*60*60*24),c===1?t.push(c+" day"):c>0&&t.push(c+" days"),c=Math.floor(m/(1e3*60*60)),m-=c*(1e3*60*60),c===1?t.push(c+" hour"):c>0&&t.push(c+" hours"),c=Math.floor(m/(1e3*60)),m-=c*(1e3*60),c===1?t.push(c+" minute"):c>0&&t.push(c+" minutes"),c=Math.floor(m/1e3),m-=c*1e3,c===1?t.push(c+" second"):c>0&&t.push(c+" seconds"),t.length===0&&t.push("0 seconds"),t.join(", ")}function Qe(m,c,t,e,n){if(typeof t>"u"&&(t=3),typeof e>"u"&&(e=0),typeof n>"u"&&(n="\\"),!m||m.length===0)return[];if(!c||c.length===0)return[m];c=c.split("");let s=!1,i=!1,o=[],r=0,a=0,l=m.length,f;for(;a<l;a++)if(f=m.charAt(a),f==='"'&&(t&2)===2)(e&2)===2&&a>0?a-1>0&&m.charAt(a-1)!==n&&(s=!s):s=!s;else if(f==="'"&&(t&1)===1)(e&1)===1&&a>0?a-1>0&&m.charAt(a-1)!==n&&(i=!i):i=!i;else if(!i&&!s){let u=c.length;for(let b=0;b<u;b++)if(f===c[b])if(a>r||a===0){o.push(m.substring(r,a)),r=a+1;break}else if(a===r){o.push(""),r=a+1;break}else a===l-1&&o.push("")}return a===l&&a===r&&c.indexOf(m.charAt(a-1))>-1&&(o.push(""),r=a+1),a>r&&o.push(m.substring(r,a)),o}function Mt(m){if(!m)return 0;if(typeof m.selectionStart=="number")return m.selectionDirection=="backward"?m.selectionStart:m.selectionEnd;if(document.selection){m.focus();var c=document.selection.createRange();return c.moveStart("character",-m.value.length),c.text.length}return 0}function Ee(m,c){return m&&(/^\d+c$/.test(m)?c?parseInt(m,10)*c+"px":m+"h":/^\d+$/.test(m)?parseInt(m,10)+"px":m)}function me(m){return!m||m.length===0||!m.match(/^[a-zA-Z_$][a-zA-Z_$0-9]*$/g)?!1:["break","case","catch","continue","debugger","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with","class","const","enum","export","extends","import","super","implements","interface","let","package","private","protected","public","static","yield","null","true","false","NaN","Infinity","undefined","eval","arguments"].indexOf(m)===-1}function De(m,c){if(!m)return;let t=document.activeElement;(!t||t!=m)&&m.focus(),document.execCommand("insertText",!1,c),t&&t!=m&&t.focus()}Array.isArray||(Array.isArray=function(m){return Object.prototype.toString.call(m)==="[object Array]"});var It;function xe(m){return window.TextDecoder!==void 0?(It||(It=new TextDecoder)).decode(new Uint8Array(m)):qt(String.fromCharCode.apply(null,Array.prototype.slice.apply(new Uint8Array(m))))}function qt(m){var c;try{return decodeURIComponent(escape(m))}catch(t){if(c=t,c instanceof URIError)return m;throw c}}function Kt(m){var c,t,e,n,s,i;for(s=m.length,c=[],n=!1,e=i=0;0<=s?i<s:i>s;e=0<=s?++i:--i)if(t=String.prototype.charCodeAt.call(m,e),t>255){n=!0,c=null;break}else c.push(t);return n===!0?unescape(encodeURIComponent(m)):String.fromCharCode.apply(null,Array.prototype.slice.apply(c))}var Lt;function ke(m){var c,t,e,n,s,i;if(window.TextEncoder!==void 0)return(Lt||(Lt=new TextEncoder)).encode(m);for(c=Kt(m),t=c.length,e=new ArrayBuffer(t),n=new Uint8Array(e),s=i=0;0<=t?i<t:i>t;s=0<=t?++i:--i)n[s]=String.prototype.charCodeAt.call(c,s);return n}function dt(m,c){if(!m)return null;c||(c=window.location.href),m=m.replace(/[[\]]/g,"\\$&");var t=new RegExp("[?&]"+m+"(=([^&#]*)|&|#|$)"),e=t.exec(c);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function Zt(){var m="download"in document.createElement("a"),c=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,t=window.URL||window.webkitURL||window.mozURL||window.msURL;navigator.saveBlob=navigator.saveBlob||navigator.msSaveBlob||navigator.mozSaveBlob||navigator.webkitSaveBlob,window.saveAs=window.saveAs||window.webkitSaveAs||window.mozSaveAs||window.msSaveAs;var e={"image/jpeg":!0,"image/png":!0,"image/gif":!0,"image/svg+xml":!0,"image/bmp":!0,"image/x-windows-bmp":!0,"image/webp":!0,"audio/wav":!0,"audio/mpeg":!0,"audio/webm":!0,"audio/ogg":!0,"video/mpeg":!0,"video/webm":!0,"video/ogg":!0,"text/plain":!0,"text/html":!0,"text/xml":!0,"application/xhtml+xml":!0,"application/json":!0};c&&(window.saveAs||navigator.saveBlob)?this.show=function(n,s,i){var o=new c;o.append(n);var r=o.getBlob(i||"application/octet-stream");s||(s="Download.bin"),window.saveAs?window.saveAs(r,s):navigator.saveBlob(r,s)}:c&&t?this.show=function(n,s,i){var o,r,a=new c;if(a.append(n),i||(i="application/octet-stream"),m){o=a.getBlob(i),r=t.createObjectURL(o);var l=document.createElement("a");l.setAttribute("href",r),l.setAttribute("download",s||"Download.bin");var f=document.createEvent("MouseEvents");f.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),l.dispatchEvent(f)}else e[i.split(";")[0]]===!0&&(i="application/octet-stream"),o=a.getBlob(i),r=t.createObjectURL(o),window.open(r,"_blank","");setTimeout(function(){t.revokeObjectURL(r)},250)}:Blob&&t?this.show=function(n,s,i){var o,r;if(i||(i="application/octet-stream"),o=new Blob([n],{type:i}),m){r=t.createObjectURL(o);var a=document.createElement("a");a.setAttribute("href",r),a.setAttribute("download",s||"Download.bin");var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(l)}else e[i.split(";")[0]]===!0&&(i="application/octet-stream"),r=t.createObjectURL(o),window.open(r,"_blank","");setTimeout(function(){t.revokeObjectURL(r)},250)}:/\bMSIE\b/.test(navigator.userAgent)||(this.show=function(n,s,i){i||(i="application/octet-stream"),e[i.split(";")[0]]===!0&&(i="application/octet-stream"),window.open("data:"+i+","+encodeURIComponent(n),"_blank","")})}window.fileSaveAs=new Zt;function Jt(){var m,c;function t(e,n){var s=e.charCodeAt(c);if(!(s&128))m=s;else if((s&224)==192)m=(s&31)<<6|e.charCodeAt(c+1)&63,c+=1;else if((s&240)==224)m=(s&15)<<12|(e.charCodeAt(c+1)&63)<<6|e.charCodeAt(c+2)&63,c+=2;else if((s&248)==240)m=(s&7)<<18|(e.charCodeAt(c+1)&63)<<12|(e.charCodeAt(c+2)&63)<<6|e.charCodeAt(c+3)&63,c+=1;else return!1;return!0}this.decode=function(e){var n=new pe,s=e.length;for(c=0;c<s;c++)t(e,s)&&n.appendCode(m);return n.toString()},this.decode2=function(e){var n=new pe,s=e.length,i,o;for(i=0;i<s;i++){if(o=e.charCodeAt(i),o&128)if((o&224)==192)o=(o&31)<<6|e.charCodeAt(i+1)&63,i+=1;else if((o&240)==224)o=(o&15)<<12|(e.charCodeAt(i+1)&63)<<6|e.charCodeAt(i+2)&63,i+=2;else if((o&248)==240)o=(o&7)<<18|(e.charCodeAt(i+1)&63)<<12|(e.charCodeAt(i+2)&63)<<6|e.charCodeAt(i+3)&63,i+=1;else continue;n.appendCode(o)}return n.toString()}}window.UTF8=new Jt;function de(m){if(m===null||typeof m>"u")return m;var c,t,e=0;for(c=m.byteLength,t=new pe;e<c;e++)m[e]<32||m[e]>=127?t.append("<"+m[e]+">"):t.append(String.fromCharCode(m[e]));return t.toString()}function gt(){let m=document.createElement("div");m.style.visibility="hidden",m.style.overflow="scroll",m.style.msOverflowStyle="scrollbar",document.body.appendChild(m);let c=document.createElement("div");m.appendChild(c);let t=m.offsetWidth-c.offsetWidth;return m.parentNode.removeChild(m),t}function Ve(m,c,t){return new Promise((e,n)=>{let s=document.createElement("dialog");if(typeof s.showModal!="function"){n("Browser does not support dialogs.");return}s.id="openFileDialog",s.style.zIndex="2000",s.style.height="155px",s.style.width="350px",s.innerHTML=`<div class="dialog-header" style="font-weight: bold"><button type="button" class="btn btn-close float-end btn-danger" data-dismiss="modal" onclick="document.getElementById('openFileDialog').close();"></button><div>${m||"Open file..."}</div></div><div class="dialog-body"><div class="m-3"><input class="form-control" type="file" id="openFileDialog-files"${c?" multiple":""} required${t&&t.length?' accept="'+t+'"':""}></div></div><div class="dialog-footer"><button id="openFileDialog-cancel" style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('openFileDialog').close();">Cancel</button><button id="openFileDialog-ok" style="float: right" type="button" class="btn btn-primary">Ok</button></div>`,document.body.appendChild(s),s.addEventListener("close",i=>{i.target===s&&(document.body.removeChild(s),s.returnValue!=="file-ok"&&n("closed"))}),s.addEventListener("cancel",i=>{i.target===s&&(document.body.removeChild(s),s.returnValue!=="file-ok"&&n("canceled"))}),document.getElementById("openFileDialog-ok").addEventListener("click",()=>{let i=document.getElementById("openFileDialog-files");if(!i.files||i.files.length===0){i.classList.add("is-invalid");return}i.classList.remove("is-invalid"),s.close(),s.returnValue="files-ok",e(i.files)}),s.showModal()})}function Ye(m){return new Promise((c,t)=>{m||t(new Error("Invalid file"));var e=new FileReader;e.onerror=t,e.onload=n=>{c(n.target.result)},e.readAsText(m)})}var ct={};function bt(m,c,t){t=t||"default",clearTimeout(ct[t]),ct[t]=setTimeout(()=>{m(),delete ct[t]},c)}var Nt=_t(Dt()),Ne=class extends ee{constructor(t){super();this._splitBuffer=[];this._connected=!1;this._MTTS=0;this.zStream=0;this._latencyTime=null;this._doPing=!1;this._closed=!0;this._zlib=!1;this.options={MCCP:!0,MXP:!0,NAWS:!0,MSDP:!0,GMCP:!0,MSSP:!1,ECHO:!0,TTYPE:!0,EOR:!0,NEWENVIRON:!1,ZMP:!1,ATCP:!1,CHARSET:!0};this.host="";this.port=23;this.prompt=!1;this.echo=!0;this.firstSent=!0;this.firstReceived=!0;this.server={NAWS:!1,MSDP:!1,GMCP:!1,MXP:!1,MCCP1:!1,MCCP2:!1,MSSP:!1,NEWENVIRON:!1,ZMP:!1,EOR:!1,ATCP:!1,CHARSET:!1};this.version="2.0";this.terminal="ansi";this.UTF8=!0;this.MSSP={};this.socket=null;this.latency=0;this.latencyAvg=null;this.enableLatency=!1;this.enablePing=!1;this.GMCPSupports=["Core 1","Char 1","Char.Vitals 1","Char.Experience 1"];this.enableDebug=!1;this.scheme="ws://";this.protocol="binary";t&&("host"in t&&(t.host&&t.host.length&&(this.host=t.host),delete t.host),"port"in t&&(this.port=t.port,delete t.port),"scheme"in t&&(t.scheme&&t.scheme.length&&(this.scheme=t.scheme),delete t.scheme),"protocol"in t&&(t.protocol&&t.protocol.length&&(this.protocol=t.protocol),delete t.protocol)),this.options=Object.assign(this.options,t||{})}get connected(){return!this.socket||typeof this.socket>"u"?!1:this._connected}reset(){this._MTTS=0,this.firstSent=!0,this.firstReceived=!0,this.prompt=!1,this.echo=!0,this.server={NAWS:!1,MSDP:!1,GMCP:!1,MXP:!1,MCCP1:!1,MCCP2:!1,MSSP:!1,EOR:!1,NEWENVIRON:!1,ATCP:!1,CHARSET:!1,ZMP:!1},this._splitBuffer=[],this._endMCCP(),this._connected=!1,this._closed=!1,this.enableDebug&&this.emit("debug","Reset")}connect(){this._destroySocket(),this.reset(),this.emit("connecting"),this.socket=this._createSocket(this.host,this.port),this.enableDebug&&this.emit("debug","Connecting to "+this.host+":"+this.port)}close(){this._closed||(this._destroySocket(),this.reset(),this.emit("close"),this._closed=!0,this.enableDebug&&this.emit("debug","Closed"))}receivedData(t,e,n){this.enableLatency&&(this._latencyTime!==null?(this.latency=new Date().getTime()-this._latencyTime.getTime(),this.latencyAvg==null?this.latencyAvg=this.latency:this.latencyAvg=(this.latency+this.latencyAvg)/2,this._latencyTime=null,this._doPing=!1,this.emit("latency-changed",this.latency,this.latencyAvg)):!this._doPing&&this.enablePing?this._doPing=!0:(this._latencyTime=null,this._doPing=!1)),this.enableDebug&&this.emit("debug","PreProcess:"+t,1),t=this.processData(t,e,!1,n),this.enableDebug&&this.emit("debug","PostProcess:"+t,1),this.emit("received-data",t),this.enableLatency&&(this._splitBuffer.length>0?(this.enablePing&&(this._doPing=!0),this._latencyTime=null):this._doPing&&this.enablePing?setTimeout(()=>{this._latencyTime=new Date,this.sendGMCP("Core.Ping "+this.latencyAvg)}):this._doPing=!1)}sendTerminal(){if(this.enableDebug&&(this._MTTS===0?this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>"+this.terminal+"<IAC><SE>"):this._MTTS===1?this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>ANSI-256COLOR<IAC><SE>"):this._MTTS>=2&&this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>MTTS 9<IAC><SE>")),this._MTTS===0){var t=new Uint8Array(6+this.terminal.length);t.set([255,250,24,0],0),t.set(ke(this.terminal),4),t.set([255,240],4+this.terminal.length),this.sendData(t,!0)}else this._MTTS===1?this.sendData([255,250,24,0,65,78,83,73,45,50,53,54,67,79,76,79,82,255,240],!0):this._MTTS>=2&&this.sendData([255,250,24,0,77,84,84,83,32,57,255,240],!0)}sendData(t,e){if(!(t==null||typeof t>"u"||t.length===0)){if(this.connected)try{e||(this.prompt=!1,t=this._escapeData(t),this.enableLatency&&(this._latencyTime=new Date)),this.socket!==null&&(t instanceof Uint8Array?(this.enableDebug&&this.emit("debug","sendDataU8:"+de(t)),this.socket.send(t)):Array.isArray(t)?(this.enableDebug&&this.emit("debug","sendDataBA"+de(new Uint8Array(t))),this.socket.send(new Uint8Array(t))):(this.enableDebug&&this.emit("debug","sendDataR:"+de(ke(t))),this.socket.send(t)),e||(this.firstSent=!1))}catch(n){this.emit("error",n)}else this.enableLatency&&(this._latencyTime=null);this.emit("data-sent",t,e)}}processData(t,e,n,s){let i,o="",r;if(t==null||(e||(t=this._decompressData(t)),i=t.byteLength,i===0))return t;r=this._splitBuffer,r.length>0&&(this.enableDebug&&this.emit("debug","Split buffer length: "+r.length,1),o=new Uint8Array(i+r.length),s?(o.set(t,0),o.set(r,t.byteLength)):(o.set(r,0),o.set(t,r.length)),t=o,r=[],i=t.byteLength);let a=0,l=0,f=new pe,u=this.prompt,b=0,h=0,E="",S="",p,g=0,C,P=0;o="",this.prompt=!1;let x="";try{for(;P<i;P++)switch(g=t[P],a){case 0:if(g===255)this.enableDebug&&(x="TELOP: <IAC>"),r.push(g),a=1;else if(this.UTF8||this.options.CHARSET&&this.server.CHARSET){if((g&128)===128&&P>=i-4){let G=0;if((g&192)===192?G=1:(g&224)===224?G=2:(g&240)===240&&(G=3),P+G>=i){r.push(...t.slice(P)),this.enableDebug&&(this.emit("debug","Unicode split length: "+G,1),this.emit("debug","Split buffer length: "+r.length,1));break}}f.appendCode(g)}else f.appendCode(g);break;case 1:if(g===255)this.enableDebug&&(this.emit("debug",x+"<IAC>"),x=""),f.appendCode(g),r=[],a=0;else if((!this.options.EOR||!this.server.EOR)&&g===239)this.enableDebug&&(this.emit("debug",x+"<NOP>"),x=""),r=[],a=0;else if(g===241||g===130)this.enableDebug&&(this.emit("debug",x+"<NOP>"),x=""),r=[],a=0;else if(g===249||g===239)this.enableDebug&&(g===239?this.emit("debug",x+"<EOR>"):this.emit("debug",x+"<GA>"),x=""),P+1<i&&i-P>2?(f.push(`
`),this.prompt=!1):this.prompt=!0,r=[],a=0;else if(g===253||g===254||g===251||g===252){if(this.enableDebug)switch(g){case 253:x+="<DO>";break;case 254:x+="<DONT>";break;case 251:x+="<WILL>";break;case 252:x+="<WONT>";break}r.push(g),b=g,a=2}else g===250?(this.enableDebug&&(x+="<SB>"),r.push(g),a=3):(this.enableDebug&&(x+=this._formatByte(g)),r=[],a=0);break;case 2:g===1?(this.enableDebug&&(this.emit("debug",x+"<ECHO>"),x=""),b===253?this.options.ECHO?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><ECHO>"),this.replyToOption(g,251,b),this.echo=!1):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(g,254,b)):b===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><ECHO>"),this.replyToOption(g,252,b),this.echo=!0):b===251?this.options.ECHO?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><ECHO>"),this.replyToOption(g,253,b),this.echo=!1):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(g,254,b)):b===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(g,254,b)),a=0,r=[]):g===24?(this.enableDebug&&(this.emit("debug",x+"<TERMINALTYPE>"),x=""),b===253?this.options.TTYPE?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><TERMINALTYPE>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(g,254,b)):b===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><TERMINALTYPE>"),this.replyToOption(g,252,b)):b===251?this.options.TTYPE?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><TERMINALTYPE>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(g,254,b)):b===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(g,254,b)),a=0,r=[]):g===25?(this.enableDebug&&(this.emit("debug",x+"<ENDOFRECORD>"),x=""),b===253?(this.server.EOR=!0,this.options.EOR?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><ENDOFRECORD>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(g,254,b))):b===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><ENDOFRECORD>"),this.replyToOption(g,252,b)):b===251?(this.server.EOR=!0,this.options.EOR?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><ENDOFRECORD>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(g,254,b))):b===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(g,254,b)),a=0,r=[]):g===31?(this.enableDebug&&(this.emit("debug",x+"<NAWS>"),x=""),b===253?(this.server.NAWS=!0,this.options.NAWS?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><NAWS>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(g,254,b))):b===254?(this.server.NAWS=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><NAWS>"),this.replyToOption(g,252,b)):b===251?(this.server.NAWS=!0,this.options.NAWS?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><NAWS>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(g,254,b))):b===252&&(this.server.NAWS=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(g,254,b)),this.emit("windowSize"),a=0,r=[]):g===36||g===39?(this.enableDebug&&(this.emit("debug",x+"<NEWENVIRON>"),x=""),b===253?(this.server.NEWENVIRON=!0,this.options.NEWENVIRON?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><NEWENVIRON>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(g,254,b))):b===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><NEWENVIRON>"),this.replyToOption(g,252,b)):b===251?(this.server.NEWENVIRON=!0,this.options.NEWENVIRON?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><NEWENVIRON>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(g,254,b))):b===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(g,254,b)),a=0,r=[]):g===69?(this.enableDebug&&(this.emit("debug",x+"<MSDP>"),x=""),b===253?(this.server.MSDP=!0,this.options.MSDP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSDP>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(g,254,b))):b===254?(this.server.MSDP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSDP>"),this.replyToOption(g,252,b)):b===251?(this.server.MSDP=!0,this.options.MSDP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSDP>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(g,254,b))):b===252&&(this.server.MSDP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(g,254,b)),a=0,r=[]):g===70?(this.enableDebug&&(this.emit("debug",x+"<MSSP>"),x=""),b===253?(this.server.MSSP=!0,this.options.MSSP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSSP>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(g,254,b))):b===254?(this.server.MSSP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSSP>"),this.replyToOption(g,252,b)):b===251?(this.server.MSSP=!0,this.options.MSSP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSSP>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(g,254,b))):b===252&&(this.server.MSSP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(g,254,b)),a=0,r=[]):g===85?(this.enableDebug&&(this.emit("debug",x+"<MCCP1>"),x=""),b===253?(this.server.MCCP1=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MCCP1>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(g,254,b))):b===254?(this.server.MCCP1=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MCCP1>"),this.replyToOption(g,252,b)):b===251?(this.server.MCCP1=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MCCP1>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(g,254,b))):b===252&&(this.server.MCCP1=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(g,254,b)),a=0,r=[]):g===86?(this.enableDebug&&(this.emit("debug",x+"<MCCP2>"),x=""),b===253?(this.server.MCCP2=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MCCP2>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(g,254,b))):b===254?(this.server.MCCP2=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MCCP2>"),this.replyToOption(g,252,b)):b===251?(this.server.MCCP2=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MCCP2>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(g,254,b))):b===252&&(this.server.MCCP2=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(g,254,b)),a=0,r=[]):g===91?(this.enableDebug&&(this.emit("debug",x+"<MXP>"),x=""),b===253?(this.server.MXP=!0,this.options.MXP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MXP>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(g,254,b))):b===254?(this.server.MXP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MXP>"),this.replyToOption(g,252,b)):b===251?(this.server.MXP=!0,this.options.MXP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MXP>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(g,254,b))):b===252&&(this.server.MXP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(g,254,b)),a=0,r=[]):g===130||g===241?(this.enableDebug&&(this.emit("debug",x+"<NOP>"),x=""),this._fireReceiveOption(g,b,""),r=[],a=0):g===201?(this.enableDebug&&(this.emit("debug",x+"<GMCP>"),x=""),b===253?(this.server.GMCP=!0,this.options.GMCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><GMCP>"),this.replyToOption(g,251,b),this._startGMCP()):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(g,254,b))):b===254?(this.server.GMCP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><GMCP>"),this.replyToOption(g,252,b)):b===251?(this.server.GMCP=!0,this.options.GMCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><GMCP>"),this.replyToOption(g,253,b),this._startGMCP()):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(g,254,b))):b===252&&(this.server.GMCP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(g,254,b)),a=0,r=[]):g===42?(this.enableDebug&&(this.emit("debug",x+"<CHARSET>"),x=""),b===253?(this.server.CHARSET=!0,this.options.CHARSET?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><CHARSET>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(g,254,b))):b===254?(this.server.CHARSET=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><CHARSET>"),this.replyToOption(g,252,b)):b===251?(this.server.CHARSET=!0,this.options.CHARSET?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><CHARSET>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(g,254,b))):b===252&&(this.server.CHARSET=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(g,254,b)),a=0,r=[]):(this.enableDebug&&(this.emit("debug",x+this._formatByte(g)),x=""),b===251||b===252?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><"+g+">"),this.replyToOption(g,254,b)):(b===254||b===253)&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><"+g+">"),this.replyToOption(g,252,b)),a=0,r=[]);break;case 3:h=g,g===24?(this.enableDebug&&(x+="<TERMINALTYPE>"),r.push(g),h=g,a=4):g===36||g===39?(this.enableDebug&&(x+="<NEWENVIRON>"),r.push(g),h=g,a=12,C=-1):g===69?(this.enableDebug&&(x+="<MSDP>"),r.push(g),h=g,a=4):g===70?(this.enableDebug&&(x+="<MSSP>"),r.push(g),h=g,a=8,p={}):g===85||g===86?(this.enableDebug&&(x+=g===85?"<MCCP1>":"<MCCP2>"),r.push(g),h=g,a=11):g===201?(this.enableDebug&&(x+="<GMCP>"),r.push(g),h=g,a=7):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=xe(r.slice(1,r.length-4)),this._fireReceiveOption(h,250,o),o=null,a=0,r=[]):g===42?(this.enableDebug&&(x+="<CHARSET>"),r.push(g),h=g,a=17,E=""):(this.enableDebug&&(x+=this._formatByte(g)),r.push(g));break;case 4:h===24&&g===1?(this.enableDebug&&(x+="<SEND>"),r.push(g),b=1):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),h===24&&b===1&&(o=!1,this._fireReceiveOption(h,250,""),o||(this.sendTerminal(),this.sendTerminal(),this._MTTS++)),a=0,r=[]):h===69&&g===1?(this.enableDebug&&(x+="<MSDP_VAR>"),r.push(g),S="",a=5):(this.enableDebug&&(x+=this._formatByte(g)),r.push(g));break;case 5:g===2?(this.enableDebug&&(x+="<MSDP_VAL>"),r.push(g),E="",a=6):(this.enableDebug&&(x+=this._formatByte(g)),S+=String.fromCharCode(g),r.push(g));break;case 6:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===1?(this.enableDebug&&(x+="<MSDP_VAR>"),this._fireReceiveMSDP(S,E),E="",S="",r.push(g),a=5):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=xe(r.slice(1,r.length-4)),this._fireReceiveOption(h,250,o),o=null,this._fireReceiveMSDP(S,E),E="",S="",a=0,r=[]):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break;case 7:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=xe(r.slice(1,r.length-4)),this._fireReceiveOption(h,250,o),o=null,this._fireReceiveGMCP(E),a=0,E="",r=[]):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break;case 8:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),this.emit("debug",this.MSSP),x=""),o=xe(r.slice(1,r.length-4)),this._fireReceiveOption(h,250,o),o=null,this.emit("receive-MSSP",p),E="",S="",p=0,a=0,r=[]):g===1?(this.enableDebug&&(x+="<MSSP_VAR>"),r.push(g),S="",a=9):(this.enableDebug&&(x+=this._formatByte(g)),r.push(g));break;case 9:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g),a=8):g===1?(this.enableDebug&&(x+="<MSSP_VAR>"),r.push(g),S=""):g===2?(this.enableDebug&&(x+="<MSSP_VAL>"),r.push(g),this.MSSP[S]="",p[S]="",a=10):(this.enableDebug&&(x+=this._formatByte(g)),S+=String.fromCharCode(g),r.push(g));break;case 10:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g),a=8):g===1?(this.enableDebug&&(x+="<MSSP_VAR>"),r.push(g),S="",a=9):g===2?(this.enableDebug&&(x+="<MSSP_VAL>"),r.push(g),this.MSSP[S]="",p[S]=""):(this.enableDebug&&(x+=this._formatByte(g)),this.MSSP[S]+=String.fromCharCode(g),p[S]+=String.fromCharCode(g),r.push(g));break;case 11:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240&&(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),this._fireReceiveOption(h,86,""),this._startMCCP(),a=0,r=[],P<i-1&&f.append(this.processData(t.subarray(P+1),e,!0)),P=i);break;case 12:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=xe(r.slice(1,r.length-4)),this._fireReceiveOption(h,250,o),o=null,this._fireReceiveGMCP(E),a=0,E="",r=[]):g===0?(this.enableDebug&&(x+="<IS>"),r.push(g),a=13,b=g):g===1?(this.enableDebug&&(x+="<SEND>"),r.push(g),a=13,b=g):g===2?(this.enableDebug&&(x+="<SEND>"),r.push(g),a=13,b=g):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break;case 13:g===0?(this.enableDebug&&(x+="<VAR>"),r.push(g),a=14,b=g,S="",C===-1&&(C=0)):g===1?(this.enableDebug&&(x+="<VALUE>"),r.push(g),a=13,b=g,C===-1&&(C=1)):g===3?(this.enableDebug&&(x+="<USERVAR>"),r.push(g),a=13,b=g):g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=xe(r.slice(1,r.length-4)),o=this._fireReceiveOption(h,250,o),this.emit("receive-NEWENVIRON",E),o||(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><NEWENVIRON><IS><IAC><SE>"),this.sendData(new Uint8Array([255,250]),!0),this.sendData(h,!0),this.sendData(new Uint8Array([0,255,240]),!0)),a=0,E="",r=[]):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break;case 14:g===2?(this.enableDebug&&(x+=this._formatByte(g)),r.push(g),a=15,l=14):g===255||g<=3?(P--,a=13):(this.enableDebug&&(x+=this._formatByte(g)),S+=String.fromCharCode(g),r.push(g));break;case 15:this.enableDebug&&(x+=this._formatByte(g)),l===16?E+=String.fromCharCode(g):S+=String.fromCharCode(g),a=l,r.push(g);break;case 16:break;case 17:g===1?(this.enableDebug&&(x+="<REQUEST>"),r.push(g),a=18,E=""):g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=this._fireReceiveOption(h,250,E),this.emit("receive-CHARSET",E),o||(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><CHARSET><REJECTED><IAC><SE>"),this.sendData(new Uint8Array([255,250,42,3,255,240]),!0)),a=0,E="",r=[]):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break;case 18:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=this._fireReceiveOption(h,250,E),this.emit("receive-CHARSET",E.slice(1)),o||(this.options.CHARSET&&E.slice(1).toLowerCase()==="utf-8"?(this.server.CHARSET=!0,this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><ACCEPTED>UTF-8<IAC><SE>"),this.sendData(new Uint8Array([255,250,42,2]),!0),this.sendData("UTF-8",!0),this.sendData(new Uint8Array([255,240]),!0)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><CHARSET><REJECTED><IAC><SE>"),this.sendData(new Uint8Array([255,250,42,3,255,240]),!0))),a=0,E="",r=[]):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break}}catch(G){this.emit("error",G)}return this.enableDebug&&(x.length>0&&this.emit("debug",x),this.emit("debug","Post Split buffer length: "+r.length,1),this.emit("debug","PostSplit buffer  "+de(new Uint8Array(r)),1)),u&&f.length>0?f.prepend(`
`):u&&(this.prompt=!0),f.length>0&&(this.firstReceived=!1),this._splitBuffer=r,n?f:this.UTF8||this.options.CHARSET&&this.server.CHARSET?UTF8.decode2(f.toString()):f.toString()}replyToOption(t,e,n,s){return typeof s>"u"&&(s=""),this._fireReceiveOption(t,n,s)?!1:(this.sendData(new Uint8Array([255,e,t]),!0),!0)}updateWindow(t,e){if(!(e<1||t<1||!this.connected||!this.server.NAWS))try{let n,s,i,o,r=Math.floor;n=r(t/256),n>256&&(n=255),s=t%256,i=r(e/256),i>256&&(i=255),o=e%256,this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><NAWS><"+n+"><"+s+"><"+i+"><"+o+"><IAC><SE>"),this.sendData(new Uint8Array([255,250,31,n,s,i,o,255,240]),!0)}catch(n){this.emit("error",{message:"UpdateWindow Error: "+n,err:n})}}sendGMCP(t){this.connected&&this.server.GMCP&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>"+this._escapeData(t).toString("binary")+"<IAC><SE>"),this.sendData(new Uint8Array([255,250,201]),!0),this.sendData(this._escapeData(t),!0),this.sendData(new Uint8Array([255,240]),!0))}_startGMCP(){this.server.GMCP&&(this.enableDebug&&this.emit("debug",'REPLY: <IAC><SB><GMCP>Core.Hello { "client": "'+this.terminal+'", "version": "'+this.version+'" }<IAC><SE>'),this.sendData(new Uint8Array([255,250,201]),!0),this.sendData('Core.Hello { "client": "'+this.terminal+'", "version": "'+this.version+'" }',!0),this.sendData(new Uint8Array([255,240]),!0),this.sendData(new Uint8Array([255,250,201]),!0),this.GMCPSupports.length>0?(this.GMCPSupports.indexOf("Core 1")===-1&&this.GMCPSupports.unshift("Core 1"),this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>"+JSON.stringify(this.GMCPSupports)+"<IAC><SE>"),this.sendData("Core.Supports.Set "+JSON.stringify(this.GMCPSupports))):(this.enableDebug&&this.emit("debug",'REPLY: <IAC><SB><GMCP>Core.Supports.Set [ "Core 1" ]<IAC><SE>'),this.sendData('Core.Supports.Set [ "Core 1" ]',!0)),this.sendData(new Uint8Array([255,240]),!0))}_startMCCP(){this._zlib=!0}_endMCCP(){this._zlib=!1,this.zStream=0}_decompressData(t){return this._zlib?(this.zStream||(this.zStream=new Nt.Zlib.InflateStream),this.enableDebug&&this.emit("debug","Pre decompress:"+de(t),1),t=this.zStream.decompress(t),this.enableDebug&&this.emit("debug","Post decompress:"+de(t),1),new Uint8Array(t)):t}_escapeData(t){if(t==null||typeof t>"u")return t;let e,n,s=0,i,o;if(t instanceof Uint8Array){for(e=t.byteLength,n=new pe;s<e;s++)n.appendCode(t[s]),t[s]===255?n.appendCode(255):t[s]===13&&e===1?n.append(`\r
`):t[s]===10&&e===1&&n.append("\r\0");return n.toString()}for(e=t.length,n=new pe;s<e;s++)o=t.charAt(s),i=t.charCodeAt(s),n.append(o),i===255?n.append(o):i===13&&e===1?n.append(`\r
`):i===10&&e===1&&n.append("\r\0");return n.toString()}_createSocket(t,e){let n;try{let s=/^[a-z0-9]+:\/\//.test(t);return s&&e>0?n=new WebSocket(t+":"+e,this.protocol||"binary"):s?n=new WebSocket(t,this.protocol||"binary"):t&&e>0?n=new WebSocket((this.scheme||"ws://")+t+":"+e,this.protocol||"binary"):t&&(n=new WebSocket((this.scheme||"ws://")+t,this.protocol||"binary")),n.binaryType="arraybuffer",n.onclose=i=>{i.code===1006&&i.type==="close"&&!this._closed?this.close():i.code!==1e3&&!this._closed&&(this.emit("error",{message:"Closed due to transmission error",err:i}),this.close())},n.onopen=()=>{this._connected=!0,this.emit("connect")},n.onmessage=i=>{if(i.data instanceof ArrayBuffer){var o=new Uint8Array(i.data);this.enableDebug&&this.emit("debug","Data ArrayBuffer received:"+de(o)),this.receivedData(o)}else if(i.data instanceof Blob){var r=new FileReader;r.onloadend=()=>{var a=new Uint8Array(r.result);this.receivedData(a),this.enableDebug&&this.emit("debug","Data Blob received:"+de(r.result))},r.readAsArrayBuffer(i.data)}else this.enableDebug&&this.emit("debug","Data received:"+i.data),this.receivedData(i.data)},n.onerror=i=>{this._closed||this.emit("error",i)},n}catch(s){this.emit("error",s)}return null}_destroySocket(){if(!(!this.socket||this.socket==null)){try{this.socket.onopen=function(){},this.socket.onclose=function(){},this.socket.onmessage=function(){},this.socket.onerror=function(){},this.connected&&this.socket.close(),delete this.socket}catch(t){this.emit("error",t)}this.socket=null}}_fireReceiveOption(t,e,n){let s={telnet:this,option:t,verb:250,value:n,handled:!1};return this.emit("received-option",s),s.handled}_fireReceiveMSDP(t,e){let n={telnet:this,variable:t,value:e,handled:!1};return this.emit("received-MSDP",n),n.handled}_fireReceiveGMCP(t){let e={telnet:this,value:t,handled:!1};return this.emit("received-GMCP",e),e.handled}_formatByte(t){return t<32||t>=127?"<"+t+">":String.fromCharCode(t)}};window.telnet=new Ne;function V(m,c){switch(m.toLowerCase()){case"black":return c?40:30;case"red":return c?41:31;case"green":return c?42:32;case"yellow":return c?43:33;case"blue":return c?44:34;case"magenta":return c?45:35;case"cyan":return c?46:36;case"white":return c?47:37;case"default":return c?49:39}return-1}function yt(m){let c=-1,t=-1,e=!1;switch(m-1024>=0&&(m-=1024),m-512>=0&&(m-=512),m-256>=0&&(m-=256),m-128>=0&&(m-=128,e=!0),m-112>=0&&(m-=112,t=47),m-96>=0&&(m-=96,t=43),m-80>=0&&(m-=80,t=45),m-64>=0&&(m-=64,t=41),m-48>=0&&(m-=48,t=46),m-32>=0&&(m-=32,t=42),m-16>=0&&(m-=16,t=44),m>=8&&(m-=8,e=!0),m){case 0:c=30;break;case 1:c=34;break;case 2:c=32;break;case 3:c=36;break;case 4:c=31;break;case 5:c=35;break;case 6:c=33;break;case 7:c=37;break}return e&&c===-1?c=370:e&&(c*=10),c===-1?`,${t}`:t===-1?c.toString():`${c},${t}`}function te(m){return!m||m.length===0?!1:["indianred","lightcoral","salmon","darksalmon","lightsalmon","crimson","red","firebrick","darkred","pink","lightpink","hotpink","deeppink","mediumvioletred","palevioletred","lightsalmon","coral","tomato","orangered","darkorange","orange","gold","yellow","lightyellow","lemonchiffon","lightgoldenrodyellow","papayawhip","moccasin","peachpuff","palegoldenrod","khaki","darkkhaki","lavender","thistle","plum","violet","orchid","fuchsia","magenta","mediumorchid","mediumpurple","blueviolet","darkviolet","darkorchid","darkmagenta","purple","indigo","slateblue","darkslateblue","mediumslateblue","greenyellow","chartreuse","lawngreen","lime","limegreen","palegreen","lightgreen","mediumspringgreen","springgreen","mediumseagreen","seagreen","forestgreen","green","darkgreen","yellowgreen","olivedrab","olive","darkolivegreen","mediumaquamarine","darkseagreen","lightseagreen","darkcyan","teal","aqua","cyan","lightcyan","paleturquoise","aquamarine","turquoise","mediumturquoise","darkturquoise","cadetblue","steelblue","lightsteelblue","powderblue","lightblue","skyblue","lightskyblue","deepskyblue","dodgerblue","cornflowerblue","mediumslateblue","royalblue","blue","mediumblue","darkblue","navy","midnightblue","cornsilk","blanchedalmond","bisque","navajowhite","wheat","burlywood","tan","rosybrown","sandybrown","goldenrod","darkgoldenrod","peru","chocolate","saddlebrown","sienna","brown","maroon","white","snow","honeydew","mintcream","azure","aliceblue","ghostwhite","whitesmoke","seashell","beige","oldlace","floralwhite","ivory","antiquewhite","linen","lavenderblush","mistyrose","gainsboro","lightgrey","silver","darkgray","gray","dimgray","lightslategray","slategray","darkslategray","black"].indexOf(m.toLowerCase())!=-1}function ge(m,c){switch(m){case"errortextbackground":case"errorbackground":return-12;case"errortext":return c?-12:-11;case"infobackground":return-8;case"infotext":return c?-8:-7;case"localecho":return c?-4:-3;case"localechoback":return-4;case"reset":return 0;case"bold":return 1;case"faint":return 2;case"italic":return 3;case"underline":return 4;case"blink":return 5;case"blinkrapid":return 6;case"reverse":return 7;case"hidden":return 8;case"strikethrough":return 9;case"doubleunderline":return 21;case"boldoff":return 22;case"italicoff":return 23;case"underlineoff":return 24;case"blinkoff":return 25;case"blinkrapidoff":return 26;case"reverseoff":return 27;case"visible":return 28;case"strikethroughoff":return 29;case"black":return c?40:30;case"red":return c?41:31;case"green":return c?42:32;case"yellow":return c?43:33;case"blue":return c?44:34;case"magenta":return c?45:35;case"cyan":return c?46:36;case"white":return c?47:37;case"default":case"defaultfore":return c?49:39;case"blackbackground":return 40;case"redbackground":return 41;case"greenbackground":return 42;case"yellowbackground":return 43;case"bluebackground":return 44;case"magentabackground":return 45;case"cyanbackground":return 46;case"whitebackground":return 47;case"defaultbackground":case"defaultback":return 49;case"overline":return 53;case"subscript":return 74;case"superscript":return 73;case"subsuperoff":return 75;case"xblack":return c?100:90;case"xred":return c?101:91;case"xgreen":return c?102:92;case"xyellow":return c?103:93;case"xblue":return c?104:94;case"xmagenta":return c?105:95;case"xcyan":return c?106:96;case"xwhite":return c?107:97;case"xblackbackground":return 100;case"xredbackground":return 101;case"xgreenbackground":return 102;case"xyellowbackground":return 103;case"xbluebackground":return 104;case"xmagentabackground":return 105;case"xcyanbackground":return 106;case"xwhitebackground":return 107}return-1}var Pe=class{constructor(c,t){this.width=0;this.height=0;this.width=c,this.height=t}};var H=[["bufferSize",0,2,500],["commandDelay",0,2,500],["commandDelayCount",0,2,5],["commandHistorySize",0,2,20],["fontSize",0,0,"1em",0],["cmdfontSize",0,0,"1em",0],["commandEcho",0,1,!0],["flashing",0,1,!1],["autoConnect",0,1,!0],["enableAliases",-1,1,!0],["enableTriggers",-1,1,!0],["enableMacros",-1,1,!0],["showScriptErrors",0,1,!1],["commandStacking",0,1,!0],["commandStackingChar",0,0,";",1],["htmlLog",0,1,!0],["keepLastCommand",0,1,!0],["enableMCCP",0,1,!0],["enableUTF8",0,1,!0],["font",0,5,"'Courier New', Courier, monospace",0],["cmdfont",0,5,"'Courier New', Courier, monospace",0],["aliases",-1,4],["macros",-1,4],["triggers",-1,4],["mapFollow","mapper.follow",1,!0],["mapEnabled","mapper.enabled",1,!0],["MapperSplitArea","mapper.split",1,!1],["MapperFillWalls","mapper.fill",1,!1],["MapperOpen","showMapper",1,!1],["fullScreen",-1,3,!1],["enableMXP",0,1,!0],["enableMSP",0,1,!0],["parseCommands",0,3,!0],["lagMeter",0,1,!1],["enablePing",0,1,!1],["enableEcho",0,1,!0],["enableSpeedpaths",0,1,!0],["speedpathsChar",0,0,"!",1],["parseSpeedpaths",0,1,!0],["profile",-1,0,"Default",1],["parseSingleQuotes",0,1,!1],["parseDoubleQuotes",0,1,!0],["logEnabled",0,1,!1],["logPrepend",0,1,!1],["logOffline",0,1,!1],["logUniqueOnConnect",0,1,!0],["enableURLDetection",0,1,!0],["colors",0,4],["notifyMSPPlay",0,1,!1],["CommandonClick",0,1,!0],["allowEval",0,1,!0],["allowEscape",0,1,!0],["AutoCopySelectedToClipboard",0,1,!1],["enableDebug",0,1,!1],["editorPersistent",0,1,!1],["askonclose",0,1,!0],["dev",0,1,!1],["chat.captureLines",0,1,!1],["chat.captureAllLines",0,1,!1],["chat.captureReviews",0,1,!1],["chat.captureTells",0,1,!1],["chat.captureTalk",0,1,!1],["chat.gag",0,1,!1],["chat.CaptureOnlyOpen",0,1,!1],["checkForUpdates",0,1,!1],["autoCreateCharacter",0,1,!1],["askonchildren",0,1,!0],["mapper.legend",0,1,!1],["mapper.room",0,1,!1],["mapper.importType",0,2,1],["mapper.vscroll",0,2,0],["mapper.hscroll",0,2,0],["mapper.scale",0,2,1],["mapper.alwaysOnTop",0,1,!1],["mapper.alwaysOnTopClient",0,1,!0],["mapper.memory",0,1,!1],["mapper.memorySavePeriod",0,2,9e5],["mapper.active.ID",0,0,null],["mapper.active.x",0,2,0],["mapper.active.y",0,2,0],["mapper.active.z",0,2,0],["mapper.active.area",0,0,null],["mapper.active.zone",0,2,0],["mapper.persistent",0,1,!0],["profiles.split",0,2,-1],["profiles.askoncancel",0,1,!0],["profiles.triggersAdvanced",0,1,!1],["profiles.aliasesAdvanced",0,1,!1],["profiles.buttonsAdvanced",0,1,!1],["profiles.macrosAdvanced",0,1,!1],["profiles.contextsAdvanced",0,1,!1],["profiles.codeEditor",0,1,!0],["profiles.watchFiles",0,1,!0],["chat.alwaysOnTop",0,1,!1],["chat.alwaysOnTopClient",0,1,!0],["chat.log",0,1,!1],["chat.persistent",0,1,!1],["chat.zoom",0,2,1],["chat.font",0,5,"'Courier New', Courier, monospace"],["chat.fontSize",0,0,"1em"],["title",0,0,"$t"],["logGagged",0,1,!1],["logTimeFormat",0,0,"YYYYMMDD-HHmmss"],["autoConnectDelay",0,2,600],["autoLogin",0,1,!0],["onDisconnect",0,2,2],["enableKeepAlive",0,1,!1],["keepAliveDelay",0,2,0],["newlineShortcut",0,2,1],["logWhat",0,2,1],["logErrors",0,1,!0],["showErrorsExtended",0,1,!1],["reportCrashes",0,1,!1],["enableCommands",0,1,!0],["commandChar",0,0,"#",1],["escapeChar",0,0,"\\",1],["enableVerbatim",0,1,!0],["verbatimChar",0,0,"`"],["soundPath",0,0,""],["logPath",0,0,""],["theme",0,0,""],["gamepads",0,1,!1],["buttons.connect",0,1,!0],["buttons.characters",0,1,!0],["buttons.preferences",0,1,!0],["buttons.log",0,1,!0],["buttons.clear",0,1,!0],["buttons.lock",0,1,!0],["buttons.map",0,1,!0],["buttons.user",0,1,!0],["buttons.mail",0,1,!1],["buttons.compose",0,1,!1],["buttons.immortal",0,1,!0],["buttons.codeEditor",0,1,!1],["find.case",0,1,!1],["find.word",0,1,!1],["find.reverse",0,1,!1],["find.regex",0,1,!1],["find.selection",0,1,!1],["find.show",0,1,!1],["display.split",0,1,!1],["display.splitHeight",0,2,-1],["display.splitLive",0,1,!0],["display.roundedOverlays",0,1,!0],["backupLoad",0,2,30],["backupSave",0,2,30],["backupAllProfiles",0,1,!0],["scrollLocked",0,1,!1],["showStatus",0,1,!0],["showCharacterManager",0,1,!1],["showChat",0,1,!1],["showEditor",0,1,!1],["showArmor",0,1,!1],["showStatusWeather",0,1,!0],["showStatusLimbs",0,1,!0],["showStatusHealth",0,1,!0],["showStatusExperience",0,1,!0],["showStatusPartyHealth",0,1,!0],["showStatusCombatHealth",0,1,!0],["showButtonBar",0,1,!0],["allowNegativeNumberNeeded",0,1,!1],["spellchecking",0,1,!0],["hideOnMinimize",0,1,!1],["showTrayIcon",0,1,!1],["statusExperienceNeededProgressbar",0,1,!1],["trayClick",0,2,0],["trayDblClick",0,2,0],["pasteSpecialPrefix",0,0,""],["pasteSpecialPostfix",0,0,""],["pasteSpecialReplace",0,0,""],["pasteSpecialPrefixEnabled",0,1,!0],["pasteSpecialPostfixEnabled",0,1,!0],["pasteSpecialReplaceEnabled",0,1,!0],["display.showSplitButton",0,1,!0],["chat.split",0,1,!1],["chat.splitHeight",0,2,-1],["chat.splitLive",0,1,!0],["chat.roundedOverlays",0,1,!0],["chat.showSplitButton",0,1,!0],["chat.bufferSize",0,2,500],["chat.flashing",0,1,!1],["display.hideTrailingEmptyLine",0,1,!0],["display.enableColors",0,1,!0],["display.enableBackgroundColors",0,1,!0],["enableSound",0,1,!0],["allowHalfOpen",0,1,!0],["editorClearOnSend",0,1,!0],["editorCloseOnSend",0,1,!0],["askOnCloseAll",0,1,!0],["askonloadCharacter",0,1,!0],["mapper.roomWidth",0,2,200],["mapper.roomGroups",0,2,7],["mapper.showInTaskBar",0,1,!1],["profiles.enabled",0,4,[]],["profiles.sortOrder",0,2,12],["profiles.sortDirection",0,2,1],["profiles.showInTaskBar",0,1,!1],["profiles.profileSelected",0,0,"default"],["profiles.profileExpandSelected",0,1,!0],["chat.lines",0,4,[]],["chat.showInTaskBar",0,1,!1],["chat.showTimestamp",0,1,!1],["chat.timestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["chat.tabWidth",0,2,8],["chat.displayControlCodes",0,1,!1],["chat.emulateTerminal",0,1,!1],["chat.emulateControlCodes",0,1,!0],["chat.wordWrap",0,1,!1],["chat.wrapAt",0,2,0],["chat.indent",0,2,4],["chat.scrollLocked",0,1,!1],["chat.find.case",0,1,!1],["chat.find.word",0,1,!1],["chat.find.reverse",0,1,!1],["chat.find.regex",0,1,!1],["chat.find.selection",0,1,!1],["chat.find.show",0,1,!1],["chat.find.highlight",0,1,!1],["chat.find.location",0,4,[5,20]],["codeEditor.showInTaskBar",0,1,!1],["codeEditor.persistent",0,1,!1],["codeEditor.alwaysOnTop",0,1,!1],["codeEditor.alwaysOnTopClient",0,1,!0],["autoTakeoverLogin",0,1,!1],["fixHiddenWindows",0,1,!0],["maxReconnectDelay",0,2,3600],["enableBackgroundThrottling",0,1,!0],["enableBackgroundThrottlingClients",0,1,!1],["showInTaskBar",0,1,!0],["showLagInTitle",0,1,!1],["mspMaxRetriesOnError",0,2,0],["logTimestamp",0,1,!1],["logTimestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["disableTriggerOnError",0,1,!0],["prependTriggeredLine",0,1,!0],["enableParameters",0,1,!0],["parametersChar",0,0,"%",1],["enableNParameters",0,1,!0],["nParametersChar",0,0,"$",1],["enableParsing",0,1,!0],["externalWho",0,1,!0],["externalHelp",0,1,!0],["watchForProfilesChanges",0,1,!1],["onProfileChange",0,2,0],["onProfileDeleted",0,2,0],["enableDoubleParameterEscaping",0,1,!1],["ignoreEvalUndefined",0,1,!0],["enableInlineComments",0,1,!0],["enableBlockComments",0,1,!0],["inlineCommentString",0,0,"//"],["blockCommentString",0,0,"/*"],["allowCommentsFromCommand",0,1,!1],["saveTriggerStateChanges",0,1,!0],["groupProfileSaves",0,1,!1],["groupProfileSaveDelay",0,2,2e4],["returnNewlineOnEmptyValue",0,1,!1],["pathDelay",0,2,0],["pathDelayCount",0,2,1],["echoSpeedpaths",0,1,!1],["alwaysShowTabs",0,1,!1],["scriptEngineType",0,2,4],["initializeScriptEngineOnLoad",0,1,!1],["find.highlight",0,1,!1],["find.location",0,4,[5,20]],["display.showInvalidMXPTags",0,1,!1],["display.showTimestamp",0,1,!1],["display.timestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["display.displayControlCodes",0,1,!1],["display.emulateTerminal",0,1,!1],["display.emulateControlCodes",0,1,!0],["display.wordWrap",0,1,!1],["display.tabWidth",0,2,8],["display.wrapAt",0,2,0],["display.indent",0,2,4],["statusWidth",0,2,-1],["showEditorInTaskBar",0,1,!0],["trayMenu",0,2,0],["lockLayout",0,1,!1],["loadLayout",0,0,""],["useSingleInstance",0,1,!0],["onSecondInstance",0,2,0],["characterManagerDblClick",0,2,0],["enableTabCompletion",1,!0],["ignoreCaseTabCompletion",0,1,!1],["tabCompletionBufferLimit",0,2,100],["enableNotifications",0,1,!0],["echo",0,2,0],["commandAutoSize",0,1,!1],["commandWordWrap",0,1,!1],["commandScrollbars",0,1,!1],["tabCompletionList",0,0,""],["tabCompletionLookupType",0,2,1],["tabCompletionReplaceCasing",0,2,0],["characterManagerAddButtonAction",0,2,0],["enableCrashReporting",0,1,!1],["characterManagerPanelWidth",0,2,0],["ignoreInputLeadingWhitespace",0,1,!1],["profiles.find.case",0,1,!1],["profiles.find.word",0,1,!1],["profiles.find.reverse",0,1,!1],["profiles.find.regex",0,1,!1],["profiles.find.selection",0,1,!1],["profiles.find.show",0,1,!1],["profiles.find.value",0,1,!1],["skipMore",0,1,!1],["skipMoreDelay",0,2,5e3],["commandMinLines",0,2,1],["backupReplaceCharacters",0,1,!0],["simpleAlarms",0,1,!1],["simpleEditor",0,1,!1]];var _e=class m{constructor(){for(var c=0,t=H.length;c<t;c++)H[c][2]!==4&&(this[H[c][0]]=m.getValue(H[c][0]));this.colors=m.getValue("colors")}static{this.settingError=!1}static getValue(c,t){var e;if(m.settingError)return t===null||typeof t>"u"?m.defaultValue(c):t;try{if(e=$.jStorage.get(c),typeof e>"u"||e===null)return t===null||typeof t>"u"?m.defaultValue(c):t;switch(c){case"showChat":case"showStatus":case"showButtons":case"enableCommands":case"enableVerbatim":case"allowEscape":case"autoConnect":case"mapFollow":case"mapEnabled":case"flashing":case"commandEcho":case"enableAliases":case"enableTriggers":case"enableButtons":case"enableMacros":case"commandStacking":case"htmlLog":case"keepLastCommand":case"fullScreen":case"enableMXP":case"enableURLDetection":case"enableMCCP":case"enableUTF8":case"parseCommands":case"lagMeter":case"showScriptErrors":case"enablePing":case"enableEcho":case"enableSpeedpaths":case"parseSpeedpaths":case"MapperSplitArea":case"parseSingleQuotes":case"parseDoubleQuotes":case"logEnabled":case"logOffline":case"logPrepend":case"logUniqueOnConnect":case"toolsPinned":case"notifyMSPPlay":case"CommandonClick":case"allowEval":case"disableTriggerOnError":case"prependTriggeredLine":case"chat.captureLines":case"chat.captureAllLines":case"chat.captureReviews":case"chat.captureTells":case"chat.captureTalk":case"chat.gag":case"chat.CaptureOnlyOpen":case"simpleAlarms":case"simpleEditor":return e==1;case"colors":case"chat.lines":return e===null||typeof e>"u"||e.length===0?[]:JSON.parse(e)}return e}catch(n){return m.settingError||(alert(`Unable to save to localStorage so reverting to default,

Error description: `+n.message),m.settingError=!0),t===null||typeof t>"u"?m.defaultValue(t):t}}static setValue(c,t){switch(c){case"colors":case"chat.lines":t===null||typeof t>"u"||t.length===0?$.jStorage.deleteKey(c):$.jStorage.set(c,JSON.stringify(t));break;default:typeof t=="boolean"?t?$.jStorage.set(c,1):$.jStorage.set(c,0):$.jStorage.set(c,t);break}}static clearValue(c){$.jStorage.deleteKey(c)}static defaultValue(c){switch(c){case"bufferSize":return 500;case"commandDelay":return 500;case"commandDelayCount":return 5;case"commandHistorySize":return 20;case"fontSize":return"1em";case"cmdfontSize":return"1em";case"commandEcho":return!0;case"flashing":return!1;case"autoConnect":return!0;case"enableAliases":return!0;case"enableTriggers":return!0;case"enableMacros":return!0;case"showScriptErrors":return!1;case"commandStacking":return!0;case"commandStackingChar":return";";case"htmlLog":return!0;case"keepLastCommand":return!0;case"enableMCCP":return!0;case"enableUTF8":return!0;case"font":return"'Courier New', Courier, monospace";case"cmdfont":return"'Courier New', Courier, monospace";case"mapFollow":case"mapper.follow":return!0;case"mapEnabled":case"mapper.enabled":return!0;case"MapperSplitArea":case"mapper.split":return!1;case"MapperFillWalls":case"mapper.fill":return!1;case"MapperOpen":case"showMapper":return!1;case"fullScreen":return!1;case"enableMXP":return!0;case"enableMSP":return!0;case"parseCommands":return!0;case"lagMeter":return!1;case"enablePing":return!1;case"enableEcho":return!0;case"enableSpeedpaths":return!0;case"speedpathsChar":return"!";case"parseSpeedpaths":return!0;case"profile":return"Default";case"parseSingleQuotes":return!1;case"parseDoubleQuotes":return!0;case"logEnabled":return!1;case"logPrepend":return!1;case"logOffline":return!1;case"logUniqueOnConnect":return!0;case"enableURLDetection":return!0;case"notifyMSPPlay":return!1;case"CommandonClick":return!0;case"allowEval":return!0;case"allowEscape":return!0;case"AutoCopySelectedToClipboard":return!1;case"enableDebug":return!1;case"editorPersistent":return!1;case"askonclose":return!0;case"dev":return!1;case"chat.captureLines":return!1;case"chat.captureAllLines":return!1;case"chat.captureReviews":return!1;case"chat.captureTells":return!1;case"chat.captureTalk":return!1;case"chat.gag":return!1;case"chat.CaptureOnlyOpen":return!1;case"checkForUpdates":return!1;case"autoCreateCharacter":return!1;case"askonchildren":return!0;case"mapper.legend":return!1;case"mapper.room":return!1;case"mapper.importType":return 1;case"mapper.vscroll":return 0;case"mapper.hscroll":return 0;case"mapper.scale":return 1;case"mapper.active":return{ID:null,x:0,y:0,z:0,area:null,zone:0};case"mapper.active.ID":return null;case"mapper.active.x":return 0;case"mapper.active.y":return 0;case"mapper.active.z":return 0;case"mapper.active.area":return null;case"mapper.active.zone":return 0;case"profiles.split":return-1;case"profiles.askoncancel":return!0;case"profiles.triggersAdvanced":return!1;case"profiles.aliasesAdvanced":return!1;case"profiles.buttonsAdvanced":return!1;case"profiles.macrosAdvanced":return!1;case"profiles.contextsAdvanced":return!1;case"profiles.codeEditor":return!0;case"chat.log":return!1;case"chat.zoom":return 1;case"chat.font":return"'Courier New', Courier, monospace";case"chat.fontSize":return"1em";case"title":return"$t";case"logGagged":return!1;case"logTimeFormat":return"YYYYMMDD-HHmmss";case"autoConnectDelay":return 600;case"autoLogin":return!0;case"onDisconnect":return 2;case"enableKeepAlive":return!1;case"keepAliveDelay":return 0;case"newlineShortcut":return 1;case"logWhat":return 1;case"logErrors":return!0;case"showErrorsExtended":return!1;case"reportCrashes":return!1;case"enableCommands":return!0;case"commandChar":return"#";case"escapeChar":return"\\";case"enableVerbatim":return!0;case"verbatimChar":return"`";case"soundPath":return"";case"logPath":return"";case"theme":return"";case"gamepads":return!1;case"backupLoad":return 30;case"backupSave":return 30;case"backupAllProfiles":return!0;case"backupReplaceCharacters":return!0;case"scrollLocked":return!1;case"showStatus":return!0;case"showChat":return!1;case"showEditor":return!1;case"showArmor":return!1;case"showStatusWeather":return!0;case"showStatusLimbs":return!0;case"showStatusHealth":return!0;case"showStatusExperience":return!0;case"showStatusPartyHealth":return!0;case"showStatusCombatHealth":return!0;case"allowNegativeNumberNeeded":return!1;case"spellchecking":return!0;case"statusExperienceNeededProgressbar":return!1;case"pasteSpecialPrefix":return"";case"pasteSpecialPostfix":return"";case"pasteSpecialReplace":return"";case"pasteSpecialPrefixEnabled":return!0;case"pasteSpecialPostfixEnabled":return!0;case"pasteSpecialReplaceEnabled":return!0;case"display.showSplitButton":return!0;case"chat.bufferSize":return 500;case"chat.flashing":return!1;case"display.hideTrailingEmptyLine":return!0;case"display.enableColors":return!0;case"display.enableBackgroundColors":return!0;case"enableSound":return!0;case"editorClearOnSend":return!0;case"editorCloseOnSend":return!0;case"askOnCloseAll":return!0;case"askonloadCharacter":return!0;case"mapper.roomWidth":return 200;case"mapper.roomGroups":return 7;case"mapper.showInTaskBar":return!1;case"profiles.enabled":return[];case"profiles.sortOrder":return 12;case"profiles.sortDirection":return 1;case"profiles.profileSelected":return"default";case"profiles.profileExpandSelected":return!0;case"chat.lines":return[];case"chat.showTimestamp":return!1;case"chat.timestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"chat.tabWidth":return 8;case"chat.displayControlCodes":return!1;case"chat.emulateTerminal":return!1;case"chat.emulateControlCodes":return!0;case"chat.wordWrap":return!1;case"chat.wrapAt":return 0;case"chat.indent":return 4;case"autoTakeoverLogin":return!1;case"maxReconnectDelay":return 3600;case"showLagInTitle":return!1;case"mspMaxRetriesOnError":return 0;case"logTimestamp":return!1;case"logTimestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"disableTriggerOnError":return!0;case"prependTriggeredLine":return!0;case"enableParameters":return!0;case"parametersChar":return"%";case"enableNParameters":return!0;case"nParametersChar":return"$";case"enableParsing":return!0;case"onProfileChange":return 0;case"onProfileDeleted":return 0;case"enableDoubleParameterEscaping":return!1;case"ignoreEvalUndefined":return!0;case"enableInlineComments":return!0;case"enableBlockComments":return!0;case"inlineCommentString":return"//";case"blockCommentString":return"/*";case"allowCommentsFromCommand":return!1;case"saveTriggerStateChanges":return!0;case"groupProfileSaves":return!1;case"groupProfileSaveDelay":return 2e4;case"returnNewlineOnEmptyValue":return!1;case"pathDelay":return 0;case"pathDelayCount":return 1;case"echoSpeedpaths":return!1;case"scriptEngineType":return 4;case"initializeScriptEngineOnLoad":return!1;case"display.showInvalidMXPTags":return!1;case"display.showTimestamp":return!1;case"display.timestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"display.displayControlCodes":return!1;case"display.emulateTerminal":return!1;case"display.emulateControlCodes":return!0;case"display.wordWrap":return!1;case"display.tabWidth":return 8;case"display.wrapAt":return 0;case"display.indent":return 4;case"statusWidth":return-1;case"extensions":return{};case"warnAdvancedSettings":return!0;case"showAdvancedSettings":return!1;case"enableTabCompletion":return!0;case"ignoreCaseTabCompletion":return!1;case"tabCompletionBufferLimit":return 100;case"enableNotifications":return!0;case"echo":return 0;case"commandAutoSize":return!1;case"commandWordWrap":return!1;case"commandMinLines":return 1;case"tabCompletionLookupType":return 1;case"tabCompletionList":return"";case"tabCompletionReplaceCasing":return 0;case"ignoreInputLeadingWhitespace":return!1;case"skipMore":return!1;case"skipMoreDelay":return 5e3;case"simpleAlarms":return!1;case"simpleEditor":return!1}return null}};var Be=(r=>(r[r.Regular=0]="Regular",r[r.CommandInputRegular=1]="CommandInputRegular",r[r.Event=2]="Event",r[r.Alarm=3]="Alarm",r[r.Pattern=8]="Pattern",r[r.CommandInputPattern=16]="CommandInputPattern",r[r.Expression=64]="Expression",r[r.LoopExpression=128]="LoopExpression",r))(Be||{});var Fe=(a=>(a[a.Skip=512]="Skip",a[a.Wait=1024]="Wait",a[a.LoopPattern=4096]="LoopPattern",a[a.LoopLines=8192]="LoopLines",a[a.Duration=16384]="Duration",a[a.WithinLines=32768]="WithinLines",a[a.Manual=65536]="Manual",a[a.ReParse=131072]="ReParse",a[a.ReParsePattern=262144]="ReParsePattern",a))(Fe||{});function Ue(m){let c=[];if(m.gamepad>0)return c.push("Gamepad "+m.gamepad),m.key>0?c.push("Button "+m.key):m.gamepadAxes<0?c.push("Axis "+-m.gamepadAxes):m.gamepadAxes>0&&c.push("Axis "+m.gamepadAxes),c.length===1?"None":c.join("+");if(m.key===0)return m.name&&m.name.length>0?"None - "+m.name:"None";if((m.modifiers&4)===4&&c.push("Ctrl"),(m.modifiers&2)===2&&c.push("Alt"),(m.modifiers&8)===8&&c.push("Shift"),(m.modifiers&16)===16&&c.push("Meta"),pt[m.key])c.push(pt[m.key]);else return m.name&&m.name.length>0?"None - "+m.name:"None";return m.name&&m.name.length>0?c.join("+")+" - "+m.name:c.join("+")}var le=class m{constructor(c,t){this.temp=!1;this.start=!1;this.seconds=-1;this.secondsWildcard=!0;this.hours=-1;this.hoursWildcard=!0;this.minutes=-1;this.minutesWildcard=!0;this.suspended=0;this.restart=0;typeof c=="string"&&(t=c,c=0),this.parent=c,this.pattern=t,this.startTime=Date.now(),this.prevTime=this.startTime}static parse(c,t,e){if(typeof c=="string"&&(t=c,c=0),!t||t.length===0)if(typeof c=="object")t=c.pattern;else throw new Error("Blank pattern");let n=new m(c,t);for(;t[0]==="-"||t[0]==="+";)t[0]==="-"?n.start=!0:t[0]==="+"&&(n.temp=!0),t=t.substr(1);if(t!=="*"){let s=t.split(":"),i;if(s.length===0)throw new Error("Invalid format: "+t);if(s.length===1)if(s[0]==="*")n.secondsWildcard=!0,n.seconds=-1;else{if(s[0][0]==="*"?(n.secondsWildcard=!0,s[0]=s[0].substr(1)):n.secondsWildcard=!1,i=parseInt(s[0],10),isNaN(i))throw new Error("Invalid Format: "+s[0]);if(i<0)throw new Error("Seconds must be greater than or equal to 0.");i>59&&(n.secondsWildcard=!0),n.seconds=i}else if(s.length===2){if(s[0]==="*")n.minutesWildcard=!0,n.minutes=-1;else{if(s[0][0]==="*"?(n.minutesWildcard=!0,s[0]=s[0].substr(1)):n.minutesWildcard=!1,i=parseInt(s[0],10),isNaN(i))throw new Error("Invalid Format: "+s[0]);if(i<0||i>59)throw new Error("Minutes can only be 0 to 59");n.minutes=i}if(s[1]==="*")n.secondsWildcard=!0,n.seconds=-1;else{if(s[1][0]==="*"?(n.secondsWildcard=!0,s[1]=s[1].substr(1)):n.secondsWildcard=!1,i=parseInt(s[1],10),isNaN(i))throw new Error("Invalid Format: "+s[1]);if(i<0||i>59)throw new Error("Seconds can only be 0 to 59");n.seconds=i}}else{if(s[0]==="*")n.hoursWildcard=!0,n.hours=-1;else{if(s[0][0]==="*"?(n.hoursWildcard=!0,s[0]=s[0].substr(1)):n.hoursWildcard=!1,i=parseInt(s[0],10),isNaN(i))throw new Error("Invalid Format: "+s[0]);if(i<0||i>23)throw new Error("Hours can only be 0 to 23");n.hours=i}if(s[1]==="*")n.minutesWildcard=!0,n.seconds=-1;else{if(s[1][0]==="*"?(n.minutesWildcard=!0,s[1]=s[1].substr(1)):n.minutesWildcard=!1,i=parseInt(s[1],10),isNaN(i))throw new Error("Invalid Format: "+s[1]);if(i<0||i>59)throw new Error("Minutes can only be 0 to 59");n.minutes=i}if(s[2]==="*")n.secondsWildcard=!0,n.seconds=-1;else{if(s[2][0]==="*"?(n.secondsWildcard=!0,s[2]=s[2].substr(2)):n.secondsWildcard=!1,i=parseInt(s[2],10),isNaN(i))throw new Error("Invalid Format: "+s[2]);if(i<0||i>59)throw new Error("Seconds can only be 0 to 59");n.seconds=i}}}return e&&(n.temp=!1),n}setTempTime(c){c?this.tempTime=Date.now()+c:this.tempTime=0}},we=class m{constructor(c,t){this.name="";this.priority=0;this.display="name";this.displaytype=0;this.value="";this.style=1;this.group="";this.enabled=!0;this.notes="";if(typeof c=="object"){let e;for(e in c)c.hasOwnProperty(e)&&(this[e]=c[e])}this.profile=t}clone(){return new m(this)}},Le=class m extends we{constructor(t,e){super(t);this.caption="";this.icon="";this.append=!1;this.send=!0;this.chain=!1;this.stretch=!1;this.parse=!1;this.top=-1;this.left=-1;this.right=-1;this.bottom=-1;this.width=64;this.height=64;if(this.caption="NewButton",this.display="caption",typeof t=="object"){let n;for(n in t)t.hasOwnProperty(n)&&(this[n]=t[n])}this.profile=e}clone(){return new m(this)}},Re=class m extends we{constructor(t,e){super();this.key=0;this.append=!1;this.send=!0;this.modifiers=0;this.chain=!1;this.gamepad=0;this.gamepadAxes=0;if(this.display="return MacroDisplay(item)",this.displaytype=1,typeof t=="object"){let n;for(n in t)t.hasOwnProperty(n)&&(this[n]=t[n])}this.profile=e}clone(){return new m(this)}},Oe=class m extends we{constructor(t,e,n){super();this.pattern="NewAlias";this.regexp=!1;this.multi=!1;this.append=!0;this.params="";if(typeof t=="string"&&(this.pattern=t),e!=null&&(this.value=e),this.display="pattern",typeof t=="object"){let s;for(s in t)t.hasOwnProperty(s)&&(this[s]=t[s])}this.profile=n}clone(){return new m(this)}},oe=class m extends we{constructor(t,e){super(t);this.pattern="NewTrigger";this.verbatim=!1;this.triggerNewline=!0;this.triggerPrompt=!1;this.type=0;this.temp=!1;this.caseSensitive=!1;this.raw=!1;this.state=0;this.params="";this.triggers=[];this.fired=!1;if(this.display="pattern",typeof t=="object"){let n;for(n in t)if(t.hasOwnProperty(n))if(n==="triggers"){this.triggers=[];let s=t.triggers.length;for(let i=0;i<s;i++)this.triggers.push(new m(t.triggers[i]))}else this[n]=t[n]}this.profile=e}clone(){return new m(this)}},wt=class m extends we{constructor(t,e){super(t);this.caption="";this.icon="";this.append=!1;this.send=!0;this.chain=!1;this.parent="";this.items=[];this.parse=!1;if(this.caption="NewContext",this.display="caption",typeof t=="object"){let n;for(n in t)if(t.hasOwnProperty(n))if(n==="items"){let s=0,i=t[n].length;for(;s<i;s++)this.items.push(new m(t[n][s]))}else this[n]=t[n]}this.profile=e}clone(){return new m(this)}},qe=class m extends we{constructor(t,e){super(t);this._type="string";this.type=1;this.defaultValue="";this.useDefault=!1;this.params="";this.profile=e,this.useDefault&&this.setValue(this.defaultValue)}set setValue(t){switch(this.type){case 2:typeof t=="string"?(t=parseInt(t,10),isNaN(t)&&(t=0)):typeof t=="boolean"&&(t=t?1:0);break;case 7:typeof t=="string"?(t=parseFloat(t),isNaN(t)&&(t=0)):typeof t=="boolean"&&(t=t?1:0);break}this.value=t,this._type=typeof t}get getValue(){switch(this.type){case 1:if(typeof this.value!==this._type)switch(this._type){case"number":return Number(this.value);case"string":return this.value.toString();case"boolean":return!!this.value}return this.value;case 7:return parseFloat(this.value);case 2:return parseInt(this.value,10);case 6:if(typeof this.value=="string")try{return JSON.parse(this.value)}catch{return this.value}return this.value;case 5:return typeof this.value=="string"?Qe(this.value,"|"):this.value}return this.value}clone(){return new m(this)}toString(){switch(this.type){case 6:return typeof this.value=="string"?this.value:JSON.stringify(this.value);case 5:return typeof this.value=="string"?this.value:'"'+this.value.join('"|"')+'"'}return this.value?.toString()}},ce=class m{constructor(c,t){this.name="";this.file="";this.priority=0;this.enabled=!0;this.aliases=[];this.triggers=[];this.macros=[];this.buttons=[];this.contexts=[];this.enableMacros=!0;this.enableTriggers=!0;this.enableAliases=!0;this.enableButtons=!0;this.enableContexts=!0;this.enableDefaultContext=!0;typeof c=="string"?(this.name=c,this.file=c.toLowerCase(),(t==null||t)&&(this.macros=m.DefaultMacros)):typeof c=="boolean"?c&&(this.macros=m.DefaultMacros):(t==null||t)&&(this.macros=m.DefaultMacros)}static get Default(){return new m("Default")}static get DefaultMacros(){let c=[{key:97,display:"return MacroDisplay(item)",displaytype:1,value:"sw",style:1,append:!1,send:!0,name:"SouthWest",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:98,display:"return MacroDisplay(item)",displaytype:1,value:"s",style:1,append:!1,send:!0,name:"South",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:99,display:"return MacroDisplay(item)",displaytype:1,value:"se",style:1,append:!1,send:!0,name:"SouthEast",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:100,display:"return MacroDisplay(item)",displaytype:1,value:"w",style:1,append:!1,send:!0,name:"West",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:101,display:"return MacroDisplay(item)",displaytype:1,value:"l",style:1,append:!1,send:!0,name:"Look",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:102,display:"return MacroDisplay(item)",displaytype:1,value:"e",style:1,append:!1,send:!0,name:"East",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:103,display:"return MacroDisplay(item)",displaytype:1,value:"nw",style:1,append:!1,send:!0,name:"NorthWest",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:104,display:"return MacroDisplay(item)",displaytype:1,value:"n",style:1,append:!1,send:!0,name:"North",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:105,display:"return MacroDisplay(item)",displaytype:1,value:"ne",style:1,append:!1,send:!0,name:"NorthEast",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""}],t=[],e=c.length;for(let n=0;n<e;n++)t.push(new Re(c[n]));return t}static load(c){let t,e;if(typeof c=="object")e=c;else return new m;t=new m(!1);let n;for(n in e)e.hasOwnProperty(n)&&(n==="aliases"||n==="triggers"||n==="macros"||n==="buttons"||n==="contexts"||n==="variables"||(t[n]=e[n]));let s,i;if(e.aliases&&e.aliases.length>0)for(i=e.aliases.length,s=0;s<i;s++)t.aliases.push(new Oe(e.aliases[s],null,t));if(e.triggers&&e.triggers.length>0)for(i=e.triggers.length,s=0;s<i;s++)t.triggers.push(new oe(e.triggers[s],t));if(e.macros&&e.macros.length>0)for(i=e.macros.length,t.macros=[],s=0;s<i;s++)t.macros.push(new Re(e.macros[s],t));if(e.buttons&&e.buttons.length>0)for(i=e.buttons.length,s=0;s<i;s++)t.buttons.push(new Le(e.buttons[s],t));if(e.contexts&&e.contexts.length>0)for(i=e.contexts.length,s=0;s<i;s++)t.contexts.push(new wt(e.contexts[s],t));return t.file=t.name,t}clone(c){let t,e,n;if(c===2){if(t={name:this.name,priority:this.priority,enabled:this.enabled,aliases:[],triggers:[],macros:[],buttons:[],contexts:[],enableMacros:this.enableMacros,enableTriggers:this.enableTriggers,enableAliases:this.enableAliases,enableButtons:this.enableButtons,enableContexts:this.enableContexts,enableDefaultContext:this.enableDefaultContext},this.aliases.length>0)for(n=this.aliases.length,e=0;e<n;e++)t.aliases.push({pattern:this.aliases[e].pattern,value:this.aliases[e].value,priority:this.aliases[e].priority,regexp:this.aliases[e].regexp,style:this.aliases[e].style,multi:this.aliases[e].multi,append:this.aliases[e].append,name:this.aliases[e].name,group:this.aliases[e].group,enabled:this.aliases[e].enabled,params:this.aliases[e].params,display:this.aliases[e].display,notes:this.aliases[e].notes||""});if(this.triggers.length>0)for(n=this.triggers.length,e=0;e<n;e++){let o={pattern:this.triggers[e].pattern,value:this.triggers[e].value,priority:this.triggers[e].priority,verbatim:this.triggers[e].verbatim,style:this.triggers[e].style,name:this.triggers[e].name,group:this.triggers[e].group,enabled:this.triggers[e].enabled,display:this.triggers[e].display,triggernewline:this.triggers[e].triggerNewline,caseSensitive:this.triggers[e].caseSensitive,triggerprompt:this.triggers[e].triggerPrompt,raw:this.triggers[e].raw,type:this.triggers[e].type,notes:this.triggers[e].notes||"",state:this.triggers[e].state||0,params:this.triggers[e].params||"",triggers:[]};if(this.triggers[e].triggers&&this.triggers[e].triggers.length){let r=this.triggers[e].triggers.length;for(let a=0;a<r;a++)o.triggers.push({pattern:this.triggers[e].triggers[a].pattern,value:this.triggers[e].triggers[a].value,priority:this.triggers[e].triggers[a].priority,verbatim:this.triggers[e].triggers[a].verbatim,style:this.triggers[e].triggers[a].style,name:this.triggers[e].triggers[a].name,group:this.triggers[e].triggers[a].group,enabled:this.triggers[e].triggers[a].enabled,display:this.triggers[e].triggers[a].display,triggernewline:this.triggers[e].triggers[a].triggerNewline,caseSensitive:this.triggers[e].triggers[a].caseSensitive,triggerprompt:this.triggers[e].triggers[a].triggerPrompt,raw:this.triggers[e].triggers[a].raw,type:this.triggers[e].triggers[a].type,notes:this.triggers[e].triggers[a].notes||"",state:this.triggers[e].triggers[a].state||0,params:this.triggers[e].triggers[a].params||"",triggers:[]})}t.triggers.push(o)}if(this.macros.length>0)for(n=this.macros.length,e=0;e<n;e++)t.macros.push({key:this.macros[e].key,value:this.macros[e].value,style:this.macros[e].style,append:this.macros[e].append,send:this.macros[e].send,name:this.macros[e].name,group:this.macros[e].group,enabled:this.macros[e].enabled,display:'if(item.key === 0) return "None"; return keyCodeToChar[item.key]',displaytype:1,modifiers:this.macros[e].modifiers,chain:this.macros[e].chain,notes:this.macros[e].notes||""});if(this.buttons.length>0)for(n=this.buttons.length,e=0;e<n;e++)t.buttons.push(ye(this.buttons[e],(o,r)=>{if(o!=="profile")return r}));if(this.contexts.length>0)for(n=this.contexts.length,e=0;e<n;e++)t.contexts.push(ye(this.contexts[e],(o,r)=>{if(o!=="profile")return r}));return t}t=ye(this);let s=new m(!1),i;for(i in t)t.hasOwnProperty(i)&&(i==="aliases"||i==="triggers"||i==="macros"||i==="buttons"||i==="contexts"||i==="variables"||(s[i]=t[i]));if(t.aliases&&t.aliases.length>0)for(n=t.aliases.length,e=0;e<n;e++)s.aliases.push(new Oe(t.aliases[e],null,s));if(t.triggers&&t.triggers.length>0)for(n=t.triggers.length,e=0;e<n;e++)s.triggers.push(new oe(t.triggers[e],s));if(t.macros&&t.macros.length>0)for(n=t.macros.length,s.macros=[],e=0;e<n;e++)s.macros.push(new Re(t.macros[e],s));if(t.buttons&&t.buttons.length>0)for(n=t.buttons.length,e=0;e<n;e++)s.buttons.push(new Le(t.buttons[e],s));if(t.contexts&&t.contexts.length>0)for(n=t.contexts.length,e=0;e<n;e++){let o=t.contexts[e].clone();o.profile=s,s.contexts.push(o)}return s}find(c,t,e){let n;if(!c||c.length===0||!this[c]||this[c].length===0)return null;n=W(this[c]);let s=n.length;for(let i=0;i<s;i++)if(n[i][t]===e)return n[i];return null}findAny(c,t,e){let n;if(!c||c.length===0||!this[c]||this[c].length===0)return null;n=W(this[c]);let s=n.length;if(typeof t=="object"){for(let i=0;i<s;i++)for(let o in t)if(t.hasOwnProperty(o)&&n[i][o]===t[o])return n[i];return-1}for(let i=0;i<s;i++)if(n[i][t]===e)return n[i];return null}indexOfAny(c,t,e){let n;if(!c||c.length===0||!this[c]||this[c].length===0)return null;n=W(this[c]);let s=n.length;if(typeof t=="object"){for(let i=0;i<s;i++)for(let o in t)if(t.hasOwnProperty(o)&&n[i][o]===t[o])return this[c].indexOf(n[i]);return-1}for(let i=0;i<s;i++)if(n[i][t]===e)return this[c].indexOf(n[i]);return-1}indexOf(c,t,e){let n;if(!c||c.length===0||!this[c]||this[c].length===0)return null;n=W(this[c]);let s=n.length;if(typeof t=="object"){for(let i=0;i<s;i++){for(let o in t)t.hasOwnProperty(o)&&(n[i][o],t[o]);return this[c].indexOf(n[i])}return-1}for(let i=0;i<s;i++)if(n[i][t]===e)return this[c].indexOf(n[i]);return-1}},Ke=class m{constructor(c){this.items={};this.keys=[];this.add(c??ce.Default)}SortByPriority(){this.keys.sort((c,t)=>{let e=this.items[c].priority,n=this.items[t].priority;return e>n?-1:e<n?1:(e=this.items[c].name,n=this.items[t].name,e==="default"?-1:n==="default"?1:e>n?-1:e<n?1:0)})}enabled(c){return!c||this.keys.length===0?!1:typeof c=="string"?this.items[c.toLowerCase()]?this.items[c.toLowerCase()].enabled:!1:this.items[c.name.toLowerCase()]?this.items[c.name.toLowerCase()].enabled:!1}contains(c){return!c||this.keys.length===0?!1:typeof c=="string"?!!this.items[c.toLowerCase()]:!!this.items[c.name.toLowerCase()]}canDisable(c){if(!c||this.keys.length===0)return!1;let t;if(typeof c=="number"){if(c<0||c>=this.keys.length)return!1;t=this.keys[c]}else if(typeof c=="object")t=c.name.toLowerCase();else if(typeof c=="string")t=c.toLowerCase();else return!1;if(!this.items[t])return!1;if(!!this.items[t].enabled){let n=!1;for(let s in this.items)if(s!==t){this.items[s].enabled&&(n=!0);break}if(!n)return!1}return!0}toggle(c){if(!c||this.keys.length===0)return!1;let t;if(typeof c=="number"){if(c<0||c>=this.keys.length)return!1;t=this.keys[c]}else if(typeof c=="object")t=c.name.toLowerCase();else if(typeof c=="string")t=c.toLowerCase();else return!1;if(!this.items[t])return!1;let e=!this.items[t].enabled;if(!e){let n=!1;for(let s in this.items)if(s!==t){this.items[s].enabled&&(n=!0);break}if(!n)return!1}return this.items[t].enabled=e,!0}update(){this.keys=Object.keys(this.items),this.SortByPriority()}add(c){c&&(this.items[c.name.toLowerCase()]=c,this.update())}remove(c){if(!(!c||this.keys.length===0)){if(typeof c=="string")delete this.items[c.toLowerCase()];else if(typeof c=="number"){if(c<0||c>=this.keys.length)return;delete this.items[this.keys[c]]}else delete this.items[c.name.toLowerCase()];this.update()}}copy(c){return c?this.keys.length===0?null:typeof c=="string"?this.items[c.toLowerCase()]?this.items[c.toLowerCase()].clone():null:typeof c=="number"?c<0||c>=this.keys.length?null:this.items[this.keys[c]].clone():c.clone():ye(this.items)}clone(c){if(c===2){let e={};for(let n in this.items)e[this.items[n].name]=this.items[n].clone(2);return e}let t=new m;for(let e in this.items)t.items[this.items[e].name]=this.items[e].clone();return t.update(),t}load(c){return new Promise((t,e)=>{localforage.getItem(c||"OoMUDProfiles").then(n=>{if(typeof n=="string"&&(n=JSON.parse(n)),!n)this.add(ce.Default);else{let s=Object.keys(n),i=0,o=s.length;for(;i<o;i++)this.add(ce.load(n[s[i]]))}t(this)}).catch(e)})}save(c){localforage.setItem(c||"OoMUDProfiles",JSON.stringify(this.items,(t,e)=>{if(t!=="profile")return e}))}get length(){return this.keys.length}count(){return this.keys.length}get active(){let c=this.keys;if(c.length===0)return this.add(ce.Default),this.items.default;if(c.length===1)return this.items[c[0]].enabled?this.items[c[0]]:this.items[c[0]].name==="Default"?(this.items[c[0]].enable=!0,this.items.default):(this.add(ce.Default),this.items.default);for(let t in c)if(this.items[t].enabled)return this.items[t];return this.items.default?(this.items.default.enabled=!0,this.items.default):(this.add(ce.Default),this.items.default)}get aliases(){let c=this.keys,t=[],e=0,n=c.length;if(n===0)return[];if(n===1)return!this.items[c[0]].enabled||!this.items[c[0]].enableAliases?[]:this.items[c[0]].aliases;for(;e<n;e++)!this.items[c[e]].enabled||!this.items[c[e]].enableAliases||this.items[c[e]].aliases.length===0||(t=t.concat(this.items[c[e]].aliases));return t}get triggers(){let c=this.keys,t=[],e=0,n=c.length;if(n===0)return[];if(n===1)return!this.items[c[0]].enabled||!this.items[c[0]].enableTriggers?[]:this.items[c[0]].triggers;for(;e<n;e++)!this.items[c[e]].enabled||!this.items[c[e]].enableTriggers||this.items[c[e]].triggers.length===0||(t=t.concat(this.items[c[e]].triggers));return t}get macros(){let c=this.keys,t=[],e=0,n=c.length;if(n===0)return[];if(n===1)return!this.items[c[0]].enabled||!this.items[c[0]].enableMacros?[]:this.items[c[0]].macros;for(;e<n;e++)!this.items[c[e]].enabled||!this.items[c[e]].enableMacros||this.items[c[e]].macros.length===0||(t=t.concat(this.items[c[e]].macros));return t}get buttons(){let c=this.keys,t=[],e=0,n=c.length;if(n===0)return[];if(n===1)return!this.items[c[0]].enabled||!this.items[c[0]].enableButtons?[]:this.items[c[0]].buttons;for(;e<n;e++)!this.items[c[e]].enabled||!this.items[c[e]].enableButtons||this.items[c[e]].buttons.length===0||(t=t.concat(this.items[c[e]].buttons));return t}get contexts(){let c=this.keys,t=[],e=0,n=c.length;if(n===0)return[];if(n===1)return!this.items[c[0]].enabled||!this.items[c[0]].enableContexts?[]:this.items[c[0]].contexts;for(;e<n;e++)!this.items[c[e]].enabled||!this.items[c[e]].enableContexts||this.items[c[e]].contexts.length===0||(t=t.concat(this.items[c[e]].contexts));return t}get defaultContext(){let c=this.keys,t=0,e=c.length;if(e===0)return!0;if(e===1)return this.items[c[0]].enabled?this.items[c[0]].enableDefaultContext:!0;for(;t<e;t++)if(this.items[c[t]].enabled&&!this.items[c[t]].enableDefaultContext)return!1;return!0}};function Ie(m,c){if(!m||!m.length)return"";let t;(M=>(M[M.None=0]="None",M[M.Ampersand=1]="Ampersand",M[M.Percent=2]="Percent",M[M.StringMatch=3]="StringMatch",M[M.SubPattern=4]="SubPattern",M[M.AmpersandPercent=5]="AmpersandPercent",M[M.AmpersandPattern=6]="AmpersandPattern",M[M.AmpersandRange=7]="AmpersandRange",M[M.PercentRegex=8]="PercentRegex",M[M.Escape=9]="Escape",M[M.Variable=10]="Variable"))(t||={});let e=0,n=[],s=0,i=m.length,o,r,a,l,f=0;for(s=0;s<i;s++)switch(o=m.charAt(s),r=m.charCodeAt(s),e){case 1:if(a.length===0&&(o==="*"||o==="?"||o==="^"||o==="$"))l=o;else if(a.length===0&&o==="%")e=5;else if(l.length===0&&o==="(")l=o,e=6;else if(l.length===0&&o==="[")l=o,e=7;else{if(o==="{")continue;if(o==="}"||!(r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||r===95||r===36)){if(!me(a))throw new Error("Invalid variable name");!l.length&&/^\d+$/.exec(a)?n.push("{",a,"}"):l.length?n.push("(?<",a,">",Ie(l),")"):n.push("(?<",a,">.*)"),o!=="}"&&s--,e=0}else a+=o}break;case 5:l+="%"+o,e=1;break;case 6:l+=o,o===")"&&(e=1);break;case 7:l+=o,o==="]"&&(e=1);break;case 2:switch(o){case"d":n.push("\\d+"),e=0;break;case"n":n.push("[+-]?\\d+"),e=0;break;case"w":n.push("\\w"),e=0;break;case"a":n.push("[a-zA-Z0-9]*"),e=0;break;case"s":n.push("\\s*"),e=0;break;case"x":n.push("\\S*"),e=0;break;case"y":n.push("\\S*"),e=0;break;case"p":n.push(`[\\.\\?\\!\\:\\;\\-\\\u2014\\(\\)\\[\\]\\'\\"\\\\/\\,]{1}`),e=0;break;case"q":n.push(`[\\.\\?\\!\\:\\;\\-\\\u2014\\(\\)\\[\\]\\'\\"\\\\/\\,]{1}`),e=0;break;case"t":e=0;break;case"e":n.push("\x1B"),e=0;break;case"/":e=8,a="";break}break;case 8:if(o==="%"){if(!a.endsWith("/"))throw new Error("Invalid %/regex/% pattern");n.push(a.substr(0,a.length-1))}else a+=o;break;case 3:o==="^"&&a.length===0?l=!0:o==="}"?(l?n.push("[^",a,"]"):n.push(a),e=0):a+=o;break;case 4:o===":"?(n.push("(?<",a,">"),e=0):o===")"?(n.push("(",Ie(a),")"),e=0,f--):a+=o;break;case 9:n.push("\\",o),e=0;break;case 10:if(o==="{"&&a.length===0)continue;if(o==="}"||!(r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||r===95||r===36)){if(!me(a))throw new Error("Invalid variable name");c&&(c.variables[a]instanceof qe?n.push(c.variables[a].value||""):n.push(c.variables[a]||"")),o!=="}"&&s--,e=0}else a+=o;break;default:o==="*"?n.push(".*"):o==="?"?n.push("."):o==="~"?e=9:o==="@"?(e=10,a=""):o==="&"?(a="",l="",e=1):o==="%"?e=2:o==="{"?(e=3,a=""):o==="("?(e=4,a="",f++):(o===")"&&f--,n.push(o));break}switch(e){case 1:if(!me(a))throw new Error("Invalid variable name");!l.length&&/^\d+$/.exec(a)?n.push("{",a,"}"):l.length?n.push("(?<",a,">",Ie(l),")"):n.push("(?<",a,">.*)");break;case 5:case 6:case 7:throw new Error("Invalid &VarName pattern");case 2:throw new Error("Invalid % pattern");case 8:throw new Error("Invalid %/regex/% pattern");case 3:throw new Error("Invalid string match pattern");case 4:throw new Error("Invalid (sub:pattern) pattern");case 9:throw new Error("Invalid escape pattern");case 10:if(!me(a))throw new Error("Invalid variable name");c&&(c.variables[a]instanceof qe?n.push(c.variables[a].getValue()||""):n.push(c.variables[a]||""));break}if(f)throw new Error("Invalid save matched pattern");return n.join("")}var We,Se,Ze=["$selectedword","$selword","$selectedurl","$selurl","$selectedline","$selline","$selected","$character","$copied","$action","$trigger","$caption","$characterid"];function Je(m){return m.replace(/\w*\S*/g,c=>c.charAt(0).toUpperCase()+c.substr(1).toLowerCase())}function Rt(){switch(~~(Math.random()*6)+1){case 1:case 4:return-1;case 3:case 2:return 1}return 0}var et=class extends ee{constructor(t){super();this._historyIdx=-1;this._tabIdx=-1;this._tabWords=null;this._locked=0;this._TriggerCache=null;this._TriggerStates={};this._TriggerFunctionCache={};this._TriggerRegExCache={};this._LastTriggered="";this._LastTrigger=null;this._scrollLock=!1;this._gag=0;this._gagID=[];this._gags=[];this._stack=[];this._vStack=[];this._controllers={};this._controllersCount=0;this._gamepadCaches=null;this._lastSuspend=-1;this._MacroCache={};this._loops=[];this._pathQueue=[];this._pathTimeout=null;this._pathPaused=!1;this.client=null;this.enableParsing=!0;this.enableTriggers=!0;if(!t)throw new Error("Invalid client!");this.client=t,We=()=>Se||(this.initMathJS(),Se),this._commandHistory=[],document.addEventListener("keydown",e=>{!this.isLocked&&this.ProcessMacros(e.which,e.altKey,e.ctrlKey,e.shiftKey,e.metaKey)?(e.preventDefault(),e.stopPropagation()):e.key==="ScrollLock"&&this.toggleScrollLock()}),this.client.on("parse-command",e=>{this.client.getOption("parseCommands")&&(e.value=this.parseOutgoing(e.value,null,null,null,null,!e.comments))}),this.client.on("add-line",e=>{if(this.ExecuteTriggers(140,e.line,e.raw,e.fragment,!1,!0),this._gag>0&&!e.fragment&&(e.gagged=!0,this._gag--),!e.fragment)for(let n in this._TriggerStates)this._TriggerStates[n].lineCount&&this._TriggerStates[n].lineCount--}),this.client.on("options-loaded",()=>{!Se&&this.client.getOption("initializeScriptEngineOnLoad")&&this.initMathJS(),this.initPads()}),this.client.commandInput.addEventListener("keyup",e=>{e.key!=="Escape"&&e.key!=="ArrowUp"&&e.key!=="ArrowDown"&&(this._historyIdx=this._commandHistory.length)}),this.client.commandInput.addEventListener("keydown",e=>{switch(e.key){case"Escape":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this.client.commandInput.blur(),this.client.commandInput.value="",this.client.commandInput.select(),this._historyIdx=this._commandHistory.length,this._tabIdx=-1,this._tabWords=null,this._tabSearch=null,this.emit("history-navigate",e);break;case"ArrowUp":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this._historyIdx===this._commandHistory.length&&this.client.commandInput.value.length>0&&(this.AddCommandToHistory(this.client.commandInput.value),this.client.commandInput.value===this._commandHistory[this._historyIdx-1]&&this._historyIdx--),this._historyIdx--,this._historyIdx<0&&(this._historyIdx=0),this._commandHistory.length<0?(this._historyIdx=-1,this.client.commandInput.value=""):this._commandHistory.length>0&&this._historyIdx<this._commandHistory.length&&this._historyIdx>=0&&(this.client.commandInput.value=this._commandHistory[this._historyIdx]),setTimeout(()=>this.client.commandInput.select(),0),this.emit("history-navigate",e);break;case"ArrowDown":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this._historyIdx===this._commandHistory.length&&this.client.commandInput.value.length>0&&this.AddCommandToHistory(this.client.commandInput.value),this._historyIdx++,this._historyIdx>=this._commandHistory.length||this._commandHistory.length<1?(this._historyIdx=this._commandHistory.length,this.client.commandInput.value=""):this._commandHistory.length>0&&this._historyIdx<this._commandHistory.length&&this._historyIdx>=0&&(this.client.commandInput.value=this._commandHistory[this._historyIdx]),setTimeout(()=>this.client.commandInput.select(),0),this.emit("history-navigate",e);break;case"Enter":switch(this.client.getOption("newlineShortcut")){case 1:if(e.ctrlKey&&!e.shiftKey&&!e.metaKey&&!e.altKey)return De(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 8:if(e.ctrlKey&&e.shiftKey&&!e.metaKey&&!e.altKey)return De(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 4:if((e.ctrlKey||e.shiftKey)&&!e.metaKey&&!e.altKey)return De(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 2:if(e.ctrlKey&&e.shiftKey&&!e.metaKey&&!e.altKey)return De(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break}!e.ctrlKey&&!e.shiftKey&&!e.metaKey&&!e.altKey&&(this._tabIdx=-1,this._tabWords=null,this._tabSearch=null,e.preventDefault(),this.client.sendCommand(null,null,this.client.getOption("allowCommentsFromCommand")),this.emit("history-navigate",e));break;case"Tab":if(!this.client.getOption("enableTabCompletion")||this.client.commandInput.value.length===0||e.altKey||e.ctrlKey||e.metaKey)return;e.shiftKey?this._tabIdx--:this._tabIdx++;let n=this.client.commandInput.selectionStart,s=this.client.commandInput.selectionEnd;if(this._tabWords===null){let o=Mt(this.client.commandInput),r=this.client.commandInput.value.indexOf(" ",o);r===-1&&(r=this.client.commandInput.value.indexOf(`
`,o));let a=this.client.commandInput.value.lastIndexOf(" ",o-1);a===-1&&(a=this.client.commandInput.value.indexOf(`
`,o-1)),r===-1&&(r=this.client.commandInput.value.length),a===-1?a=0:a++,n=a,s=r,n===s&&s++;let l=this.client.commandInput.value.substring(a,r);if(l.length===0)return;this._tabSearch={start:a,end:r,find:l.length};let f=new RegExp(`^${l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}`,this.client.getOption("ignoreCaseTabCompletion")?"i":"");this.client.getOption("tabCompletionLookupType")===8?this._tabWords=[...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(u=>u.match(f)))]:(this._tabWords=[].concat(...this.client.display.lines.slice(this.client.display.lines.length-this.client.getOption("tabCompletionBufferLimit")).map(u=>u.text.split(/\s+/))).filter(u=>u.match(f)).reverse(),this.client.getOption("tabCompletionLookupType")===1?this._tabWords=[...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(u=>u.match(f)).reverse())].concat(this._tabWords):this.client.getOption("tabCompletionLookupType")===2&&(this._tabWords=this._tabWords.concat([...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(u=>u.match(f)).reverse())])),this._tabWords=[...new Set(this._tabWords)])}else n-=this._tabSearch.find;if(this._tabWords.length===0)return;this._tabIdx<0&&(this._tabIdx=this._tabWords.length-1),this._tabIdx>=this._tabWords.length&&(this._tabIdx=0);let i=this.client.getOption("tabCompletionReplaceCasing");this.client.commandInput.value=this.client.commandInput.value.substring(0,n)+(i===1?this._tabWords[this._tabIdx].toLowerCase():i===2?this._tabWords[this._tabIdx].toUpperCase():this._tabWords[this._tabIdx])+this.client.commandInput.value.substring(s,this.client.commandInput.value.length),this.client.commandInput.selectionStart=this._tabSearch.start+this._tabSearch.find,this.client.commandInput.selectionEnd=this._tabSearch.start+this._tabWords[this._tabIdx].length,e.preventDefault(),this.emit("history-navigate",e);break;case"Shift":case"Control":case"Meta":case"Alt":case"CapsLock":case"Fn":case"NumLock":case"ScrollLock":case"Super":case"PageDown":case"PageUp":case"End":case"Home":case"ArrowLeft":case"ArrowRight":case"ContextMenu":break;default:this._tabIdx=-1,this._tabWords=null,this._tabSearch=null;break}}),this.client.commandInput.addEventListener("mouseup",e=>{this._tabIdx=-1,this._tabWords=null,this._tabSearch=null}),window.addEventListener("gamepadconnected",e=>{this.client.getOption("gamepads")&&(this._gamepadCaches||(this._gamepadCaches=[]),this._controllers[e.gamepad.index]={pad:e.gamepad,axes:ye(e.gamepad.axes),state:{axes:[],buttons:[]},pState:{axes:[],buttons:[]}},this._controllersCount++,this.updatePads())}),window.addEventListener("gamepaddisconnected",e=>{this.client.getOption("gamepads")&&(delete this._controllers[e.gamepad.index],this._controllersCount--)}),this.initPads()}getScope(){let t={};if(Object.assign(t,this.client.variables),Ze.forEach(e=>{t[e]=window[e],t[e.substr(1)]=window[e]}),this._stack.length===0||!this.stack.named&&!this.loops.length)return t;if(this.stack.named&&Object.assign(t,this.stack.named),this.loops.length){t.repeatnum=this.repeatnum;let e=this.loops.length;for(let n=0;n<e&&n<18;n++)t[String.fromCharCode(105+n)]=this.loops[n]}return t}setScope(t){if(t===this.client.variables)return;let e=this.loops.length;for(let n in t)if(!(!Object.prototype.hasOwnProperty.call(t,n)||n==="i"||n==="repeatnum")&&!(Ze.indexOf(n)!==-1||Ze.indexOf("$"+n)!==-1)){switch(n){case"clientid":continue}n.length===1&&e&&n.charCodeAt(0)>=105&&n.charCodeAt(0)<105+e||this.stack.named&&Object.prototype.hasOwnProperty.call(this.stack.named,n)||(this.client.variables[n]=t[n])}}evaluate(t){let e=this.getScope(),n=We().evaluate(t,e);return this.setScope(e),n}get stack(){return this._stack.length===0&&this._stack.push({args:0,named:0,used:0,append:!1}),this._stack[this._stack.length-1]}get repeatnum(){return this.loops.length===0?0:this.loops[this.loops.length-1]}get loops(){return this._stack.length===0||!this.stack.hasOwnProperty("loops")?this._loops:this.stack.loops}get regex(){let t=this._stack.length;if(t===0)return null;for(;t>=0;)if(t--,this._stack[t].hasOwnProperty("regex"))return this._stack[t].regex;return null}get indices(){let t=this._stack.length;if(t===0)return[];for(;t>=0;)if(t--,this._stack[t].hasOwnProperty("indices"))return this._stack[t].indices;return[]}get vStack(){return this._vStack.length===0?{}:this._vStack[this._vStack.length-1]}vStackPush(t){this._vStack.push(t)}vStackPop(){this._vStack.pop()}get scrollLock(){return this._scrollLock}set scrollLock(t){t!==this._scrollLock&&(this._scrollLock=t,this.emit("scroll-lock",this.scrollLock))}get lastTriggerExecuted(){return this._LastTrigger}get lastTriggered(){return this._LastTriggered}set lastTriggered(t){this._LastTriggered=t}getDiceArguments(t,e,n){let s=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString());if(!s||s.length<3)if(s=/(\d+)\s*?d\s*?\/\s*?(100)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!s||s.length<3){if(t=t.compile().evaluate(e),s=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!s||s.length<3){if(s=/(\d+)\s*?d\s*?\/\s*?(100)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!s||s.length<3)throw new Error("Invalid dice for "+(n||"dice"));s[2]="%"}}else s[2]="%";return s}initMathJS(){Se=math;let t={esc:"\x1B",cr:`
`,lf:"\r",crlf:`\r
`,diceavg:(e,n,s)=>{let i,o,r,a,l,f;if(e.length===0)throw new Error("Invalid arguments for diceavg");if(e.length===1)i=this.getDiceArguments(e[0],s,"diceavg"),o=parseInt(i[1]),r=i[2],i.length>3&&(a=i[3]);else if(e.length<4)o=e[0].compile().evaluate(s),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(s)),e.length>2&&(a=e[2].compile().evaluate(s));else throw new Error("Too many arguments for diceavg");return l=1,r==="F"||r==="f"?(l=-1,f=1):r==="%"?(f=1,l=0):f=parseInt(r),a?n.evaluate((l+f)/2*o+a,s):(l+f)/2*o},dicemin:(e,n,s)=>{let i,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for dicemin");if(e.length===1)i=i=this.getDiceArguments(e[0],s,"dicemin"),o=parseInt(i[1]),r=i[2],i.length>3&&(a=i[3]);else if(e.length<4)o=e[0].compile().evaluate(s),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(s)),e.length>2&&(a=e[2].compile().evaluate(s));else throw new Error("Too many arguments for dicemin");return l=1,r==="F"||r==="f"?l=-1:r==="%"&&(l=0),a?n.evaluate(l*o+a,s):l*o},dicemax:(e,n,s)=>{let i,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for dicemax");if(e.length===1)i=this.getDiceArguments(e[0],s,"dicemax"),o=parseInt(i[1]),r=i[2],i.length>3&&(a=i[3]);else if(e.length<4)o=e[0].compile().evaluate(s),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(s)),e.length>2&&(a=e[2].compile().evaluate(s));else throw new Error("Too many arguments for dicemax");return r==="F"||r==="f"||r==="%"?l=1:l=parseInt(r),a?n.evaluate(l*o+a,s):l*o},dicedev:(e,n,s)=>{let i,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for dicedev");if(e.length===1)i=this.getDiceArguments(e[0],s,"dicedev"),o=parseInt(i[1]),r=i[2],i.length>3&&(a=i[3]);else if(e.length<4)o=e[0].compile().evaluate(s),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(s)),e.length>2&&(a=e[2].compile().evaluate(s));else throw new Error("Too many arguments for dicedev");return r==="F"||r==="f"?l=6:r==="%"?l=1:l=parseInt(r),a?n.evaluate(Math.sqrt((l*l-1)/12*o)+a,s):Math.sqrt((l*l-1)/12*o)},zdicedev:(e,n,s)=>{let i,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for zdicedev");if(e.length===1)i=this.getDiceArguments(e[0],s,"zdicedev"),o=parseInt(i[1]),r=i[2],i.length>3&&(a=i[3]);else if(e.length<4)o=e[0].compile().evaluate(s),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(s)),e.length>2&&(a=e[2].compile().evaluate(s));else throw new Error("Too many arguments for zdicedev");return r==="F"||r==="f"?l=6:r==="%"?l=1:l=parseInt(r),l--,a?n.evaluate(Math.sqrt((l*l-1)/12*o)+a,s):Math.sqrt((l*l-1)/12*o)},dice:(e,n,s)=>{let i,o,r,a;if(e.length===1)i=this.getDiceArguments(e[0],s,"dice"),o=parseInt(i[1]),r=i[2],i.length>3&&(a=i[3]);else if(e.length>1)o=e[0].compile().evaluate(s),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(s)),e.length>2&&(a=e[2].compile().evaluate(s));else throw new Error("Invalid arguments for dice");let l=0;for(let f=0;f<o;f++)r==="F"||r==="f"?l+=Rt():r==="%"?l+=~~(Math.random()*100)+1:l+=~~(Math.random()*r)+1;return r==="%"&&(l/=100),a?n.evaluate(l+a,s):l},isdefined:(e,n,s)=>{if(e.length===1)return e[0]=this.stripQuotes(e[0].toString()),this.client.variables.hasOwnProperty(e[0])||s.has(e[0])?1:0;throw new Error("Invalid arguments for isdefined")},defined:(e,n,s)=>{let i;if(e.length===0)throw new Error("Missing arguments for defined");if(e.length===1){e[0]=this.stripQuotes(e[0],!0);let o=this.client.profiles.keys,r=0,a=o.length;if(a===0)return 0;for(;r<a;r++)if(i=W(this.client.profiles.items[o[r]].aliases),i=i.find(l=>l.pattern===e[0]),i||(i=W(this.client.profiles.items[o[r]].triggers),i=i.find(l=>l.pattern===e[0]||l.name===e[0]),i)||(i=W(this.client.profiles.items[o[r]].macros),i=i.find(l=>Ue(l).toLowerCase()===e[0].toLowerCase()||l.name===e[0]),i)||(i=W(this.client.profiles.items[o[r]].aliases),i=i.find(l=>l.caption===e[0]||l.name===e[0]),i))return 1;return this.client.variables.hasOwnProperty(e[0])}else if(e.length===2){e[0]=this.stripQuotes(e[0].toString()),e[0]=this.stripQuotes(e[1].toString());let o=this.client.profiles.keys,r=0,a=o.length;if(a===0)return 0;for(;r<a;r++)switch(e[1]){case"alias":return i=W(this.client.profiles.items[o[r]].aliases),i=i.find(l=>l.pattern===e[0]),i?1:0;case"event":return i=W(this.client.profiles.items[o[r]].triggers),i=i.find(l=>l.type===2&&(l.pattern===e[0]||l.name===e[0])),i?1:0;case"trigger":return i=W(this.client.profiles.items[o[r]].triggers),i=i.find(l=>l.pattern===e[0]||l.name===e[0]),i?1:0;case"macro":return i=W(this.client.profiles.items[o[r]].macros),i=i.find(l=>Ue(l).toLowerCase()===e[0].toLowerCase()||l.name===e[0]),i?1:0;case"button":return i=W(this.client.profiles.items[o[r]].aliases),i=i.find(l=>l.caption===e[0]||l.name===e[0]),i?1:0}if(e[1]==="variable")return this.client.variables.hasOwnProperty(e[0])||s.has(e[0])}else throw new Error("Too many arguments for defined");return 0},time:(e,n,s)=>{if(e.length>1)throw new Error("Too many arguments for time");return moment?e.length?moment().format(e[0].compile().evaluate(s)):moment().format():new Date().toISOString()},clip:(e,n,s)=>{if(e.length>1)throw new Error("Too many arguments for clip");if(e.length){this.client.writeClipboard(e[0].compile().evaluate(s));return}return this.client.readClipboard()},if:(e,n,s)=>{if(e.length<3)throw new Error("Missing arguments for if");if(e.length!==3)throw new Error("Too many arguments for if");return e[0].compile().evaluate(s)?e[1].compile().evaluate(s):e[2].compile().evaluate(s)},len:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for len");if(e.length!==1)throw new Error("Too many arguments for len");return e[0].compile().evaluate(s).toString().length},stripansi:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for len");if(e.length!==1)throw new Error("Too many arguments for len");let i=new RegExp("[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))","g");return e[0].compile().evaluate(s).toString().replace(i,"")},ansi:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for ansi");e=e.map(f=>ge(f.toString())===-1&&f.toString()!=="current"?f.compile().evaluate(s).toString():f.toString());let i=e.length,o=[],r={},a,l;for(a=0;a<i;a++)if(e[a].trim()==="current")o.push(e[a].trim());else{if(l=ge(e[a].trim()),l===-1)throw new Error("Invalid color or style for ansi");l>=0&&l<30?r[l]=1:o.push(e[a])}if(o.length>2)throw new Error("Too many colors for ansi");if(o.length>1&&(o[1]==="current"?o[1]="":o[1]=ge(o[1],!0)),o.length>0&&(r[1]&&o[0]==="white"||o[0]==="current"?o[0]="":o[0]=ge(o[0])),r=[...Object.keys(r),...o],!r.length)throw new Error("Invalid colors or styles for ansi");return r=r.filter(f=>f!==""),`\x1B[${r.join(";")}m`},color:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for color");e=e.map(r=>ge(r.toString())===-1&&r.toString()!=="current"?r.compile().evaluate(s).toString():r.toString());let i,o;if(e.length===1){if(e[0]==="bold")return"370";if(i=V(e[0]),i===-1)throw new Error("Invalid fore color");return i.toString()}else if(e.length===2){if(e[0]==="bold")i=370;else{if(i=V(e[0]),i===-1)throw new Error("Invalid fore color");if(e[1]==="bold")return(i*10).toString()}if(o=i.toString(),i=V(e[1],!0),i===-1)throw new Error("Invalid back color");return o+","+i.toString()}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[2]!=="bold")throw new Error("Only bold is supported as third argument for color");if(i=V(e[0]),i===-1)throw new Error("Invalid fore color");if(o=(i*10).toString(),i=V(e[1],!0),i===-1)throw new Error("Invalid back color");return o+","+i.toString()}throw new Error("Too many arguments")},zcolor:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for zcolor");if(e.length>1)throw new Error("Too many arguments for zcolor");return yt(parseInt(e[0].compile().evaluate(s),10))},case:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for case");let i=e[0].compile().evaluate(s);return i>0&&i<e.length?e[i].compile().evaluate(s):null},switch:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for switch");if(e.length%2===1)throw new Error("All expressions must have a value for switch");let i=e.length;for(let o=0;o<i;o+=2)if(e[o].compile().evaluate(s))return e[o+1].compile().evaluate(s);return null},ascii:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for ascii");if(e.length>1)throw new Error("Too many arguments for ascii");if(e[0].toString().trim().length===0)throw new Error("Invalid argument, empty string for ascii");return e[0].toString().trim().charCodeAt(0)},char:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for char");if(e.length>1)throw new Error("Too many arguments for char");let i=e[0].compile().evaluate(s);if(isNaN(i))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for char");return String.fromCharCode(i)},bitand:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for bitand");if(e.length!==2)throw new Error("Too many arguments for bitand");let i=e[0].compile().evaluate(s);if(isNaN(i))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitand");let o=e[1].compile().evaluate(s);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitand");return i&o},bitnot:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for bitnot");if(e.length!==1)throw new Error("Too many arguments for bitnot");let i=e[0].compile().evaluate(s);if(isNaN(i))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitnot");return~i},bitor:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for bitor");if(e.length!==2)throw new Error("Too many arguments for bitor");let i=e[0].compile().evaluate(s);if(isNaN(i))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitor");let o=e[1].compile().evaluate(s);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitor");return i|o},bitset:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for bitset");if(e.length>3)throw new Error("Too many arguments for bitset");let i=e[0].compile().evaluate(s);if(isNaN(i))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitset");let o=e[1].compile().evaluate(s);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitset");o--;let r=1;if(e.length===3&&(r=e[2].compile().evaluate(s),isNaN(r)))throw new Error("Invalid argument '"+e[2].toString()+"' must be a number for bitset");return i&~(1<<o)|(r?1:0)<<o},bitshift:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for bitshift");if(e.length!==2)throw new Error("Too many arguments for bitshift");let i=e[0].compile().evaluate(s);if(isNaN(i))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitshift");let o=e[1].compile().evaluate(s);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitshift");return o<0?i>>-o:i<<o},bittest:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for bittest");if(e.length!==2)throw new Error("Too many arguments for bittest");let i=e[0].compile().evaluate(s);if(isNaN(i))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bittest");let o=e[1].compile().evaluate(s);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bittest");return o--,(i>>o)%2!=0?1:0},bitxor:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for bitxor");if(e.length!==2)throw new Error("Too many arguments for bitxor");let i=e[0].compile().evaluate(s);if(isNaN(i))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitxor");let o=e[1].compile().evaluate(s);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitxor");return i^o},tonumber:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for number");if(e.length>1)throw new Error("Too many arguments for number");return e[0]=e[0].compile().evaluate(s).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)?parseInt(e[0],10):e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(e[0]):e[0]==="true"?1:(e[0]==="false",0)},isfloat:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for isfloat");if(e.length>1)throw new Error("Too many arguments for isfloat");return e[0]=e[0].compile().evaluate(s).toString(),e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0},isnumber:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for isnumber");if(e.length>1)throw new Error("Too many arguments for isnumber");return e[0]=e[0].compile().evaluate(s).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)||e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0},tostring:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for string");if(e.length>1)throw new Error("Too many arguments for string");return e[0].compile().evaluate(s).toString()},float:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for float");if(e.length>1)throw new Error("Too many arguments for float");return e[0]=e[0].compile().evaluate(s).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)||e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(e[0]):e[0]==="true"?1:(e[0]==="false",0)},trim:(e,n,s)=>{if(e.length!==1)throw new Error("Missing arguments for trim");return e[0].compile().evaluate(s).toString().trim()},trimleft:(e,n,s)=>{if(e.length!==1)throw new Error("Missing arguments for trimleft");return e[0].compile().evaluate(s).toString().trimLeft()},trimright:(e,n,s)=>{if(e.length!==1)throw new Error("Missing arguments for trimright");return e[0].compile().evaluate(s).toString().trimRight()},pos:(e,n,s)=>{if(e.length<2)throw new Error("Missing arguments for pos");if(e.length>2)throw new Error("Too many arguments for pos");return e[0]=e[0].compile().evaluate(s).toString(),e[1]=e[1].compile().evaluate(s).toString(),e[1].indexOf(e[0])+1},ipos:(e,n,s)=>{if(e.length<2)throw new Error("Missing arguments for pos");if(e.length>2)throw new Error("Too many arguments for pos");return e[0]=e[0].compile().evaluate(s).toString().toLowerCase(),e[1]=e[1].compile().evaluate(s).toString().toLowerCase(),e[1].indexOf(e[0])+1},ends:(e,n,s)=>{if(e.length<2)throw new Error("Missing arguments for ends");if(e.length>2)throw new Error("Too many arguments for ends");return e[0]=e[0].compile().evaluate(s).toString().toLowerCase(),e[1]=e[1].compile().evaluate(s).toString().toLowerCase(),e[0].endsWith(e[1])},begins:(e,n,s)=>{if(e.length<2)throw new Error("Missing arguments for begins");if(e.length>2)throw new Error("Too many arguments for begins");return e[0]=e[0].compile().evaluate(s).toString().toLowerCase(),e[1]=e[1].compile().evaluate(s).toString().toLowerCase(),e[0].startsWith(e[1])},alarm:(e,n,s)=>{let i,o,r,a,l;switch(e.length){case 0:throw new Error("Missing arguments for alarm");case 1:if(e[0]=e[0].compile().evaluate(s).toString(),i=this.client.alarms,r=i.length,r===0)throw new Error("No alarms set.");for(o=0;o<r;o++)if(i[o].type===3&&(i[o].name===e[0]||i[o].pattern===e[0]))return i[o].suspended?0:this.client.getRemainingAlarmTime(o);return;case 2:if(a=e[1].compile().evaluate(s),e[0]=e[0].compile().evaluate(s).toString(),i=this.client.alarms,r=i.length,r===0)throw new Error("No alarms set.");if(o=0,typeof a=="string"){for(;o<r;o++)if(i[o].type===3&&(i[o].name===e[0]||i[o].pattern===e[0])){if(i[o].profile.name.toUpperCase()!==a.toUpperCase())continue;return i[o].suspended?0:this.client.getRemainingAlarmTime(o)}throw new Error("Alarm not found in profile: "+a+".")}else{for(;o<r;o++)if(i[o].type===3&&(i[o].name===e[0]||i[o].pattern===e[0]))return i[o].suspended||this.client.setAlarmTempTime(o,a),a;throw new Error("Alarm not found.")}case 3:if(a=e[1].compile().evaluate(s),e[0]=e[0].compile().evaluate(s).toString(),l=e[2].compile().evaluate(s).toString(),i=this.client.alarms,r=i.length,r===0)throw new Error("No alarms set.");for(o=0;o<r;o++)if(i[o].type===3&&(i[o].name===e[0]||i[o].pattern===e[0])){if(i[o].profile.name.toUpperCase()!==l.toUpperCase())continue;return i[o].suspended||this.client.setAlarmTempTime(o,a),a}throw Error("Could not set time, alarm not found in profile: "+e[2]+".")}throw new Error("Too many arguments for alarm")},state:(e,n,s)=>{let i;if(e.length===0)throw new Error("Missing arguments for state");if(e.length>2)throw new Error("Too many arguments for state");if(e[0]=e[0].compile().evaluate(s).toString(),e.length===1){let o=this.client.profiles.keys,r=0,a=o.length;if(a===0)return null;if(a===1){if(!this.client.profiles.items[o[0]].enabled||!this.client.profiles.items[o[0]].enableTriggers)throw Error("No enabled profiles found!");i=W(this.client.profiles.items[o[r]].triggers),i=i.find(l=>l.name===e[0]||l.pattern===e[0])}else for(;r<a&&!(!(!this.client.profiles.items[o[r]].enabled||!this.client.profiles.items[o[r]].enableTriggers||this.client.profiles.items[o[r]].triggers.length===0)&&(i=W(this.client.profiles.items[o[r]].triggers),i=i.find(l=>l.name===e[0]||l.pattern===e[0]),i));r++);}else if(e.length===2){e[1]=e[1].compile().evaluate(s);let o;if(this.client.profiles.contains(e[1]))o=this.client.profiles.items[e[1].toLowerCase()];else throw new Error("Profile not found: "+e[1]);i=W(o.triggers),i=i.find(r=>r.name===e[0]||r.pattern===e[0])}if(i)return i.triggers&&i.triggers.length?i.state:0;throw new Error("Trigger not found")},isnull:(e,n,s)=>{if(e.length===0)return null;if(e.length!==1)throw new Error("Too many arguments for null");return e[0].compile().evaluate(s)?1:0},escape:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for unescape");if(e.length!==1)throw new Error("Too many arguments for unescape");let i;if(e[0]=e[0].compile().evaluate(s).toString(),this.client.getOption("allowEscape")){let o=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";return i=o,o==="\\"&&(i+=o),this.client.getOption("parseDoubleQuotes")&&(i+='"'),this.client.getOption("parseSingleQuotes")&&(i+="'"),this.client.getOption("commandStacking")&&(i+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(i+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(i+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(i+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(i+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(i+=this.client.getOption("nParametersChar")),e.replace(new RegExp(`[${i}]`,"g"),o+"$&")}return e.replace(/[\\"']/g,"$&")},unescape:(e,n,s)=>{if(e.length===0)throw new Error("Missing arguments for unescape");if(e.length!==1)throw new Error("Too many arguments for unescape");let i;if(e[0]=e[0].compile().evaluate(s).toString(),this.client.getOption("allowEscape")){let o=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";return i=o,o==="\\"&&(i+=o),this.client.getOption("parseDoubleQuotes")&&(i+='"'),this.client.getOption("parseSingleQuotes")&&(i+="'"),this.client.getOption("commandStacking")&&(i+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(i+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(i+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(i+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(i+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(i+=this.client.getOption("nParametersChar")),o==="\\"?e[0].replace(new RegExp(`\\\\[${i}]`,"g"),r=>r.substr(1)):e[0].replace(new RegExp(`${o}[${i}]`,"g"),r=>r.substr(1))}return e[0].replace(/\\[\\"']/g,o=>o.substr(1))},prompt:(e,n,s)=>{if(e.length>3)throw new Error("Too many arguments");return e.length===0?window.prompt():(e=e.map(i=>i.compile().evaluate(s).toString()),window.prompt(...e))}};for(let e in t)!t.hasOwnProperty(e)||typeof t[e]!="function"||(t[e].rawArgs=!0);Se.import(t,{})}resetExpressionEngine(){Se&&(Se=void 0)}async initPads(){if(!this.client||!this.client.options){setTimeout(this.initPads,5);return}if(this._controllers=[],this._controllersCount=0,this._gamepadCaches=null,!this.client.getOption("gamepads"))return;let t=navigator.getGamepads(),e=0,n=t.length;for(;e<n;e++)t[e]&&(this._controllers[t[e].index]={pad:t[e],axes:ye(t[e].axes),state:{axes:[],buttons:[]},pState:{axes:[],buttons:[]}},this._controllersCount++);this.updatePads()}updatePads(){if(this._controllersCount===0||!this.client.getOption("gamepads"))return;let t=navigator.getGamepads(),e=0,n=t.length;for(!this._gamepadCaches&&n>0&&(this._gamepadCaches=[]);e<n;e++){let s=t[e];if(!s||!this._controllers[s.index])continue;let i=this._controllers[s.index].state,o=this._controllers[s.index].axes,r=s.buttons.length,a,l;this._gamepadCaches[e]||(this._gamepadCaches[e]=Ce(this.client.macros,"gamepad",e+1)),l=this._gamepadCaches[e];let f=0,u=l.length;if(u===0)continue;for(a=0;a<r;a++){let E=s.buttons[a],S;if(typeof E=="object"?(S=E.pressed,E=E.value):S=E>=.5,i.buttons[a]){if(i.buttons[a].pressed!==S&&(i.buttons[a].pressed=S,!S)){for(;f<u;f++)if(l[f].enabled&&l[f].key===a+1&&this.ExecuteMacro(l[f])){(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()});return}}}else i.buttons[a]={pct:Math.round(E*100),pressed:S}}let b=s.axes.length,h=0;for(a=0;a<b;a++)if(i.axes[a]!==s.axes[a]&&s.axes[a]!==o[a]&&(i.axes[a]=s.axes[a]),i.axes[a]<-.75?h=-(a+1):i.axes[a]>.75&&(h=a+1),h!==0){for(;f<u;f++)if(l[f].enabled&&l[f].gamepadAxes===a+1&&this.ExecuteMacro(l[f])){(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()});return}}}(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()})}adjustLastLine(t,e){return!this.client.display.lines||this.client.display.lines.length===0?0:(e?t===this.client.display.lines.length?(t--,this.client.display.lines[t].text.length===0&&this.client.display.lines[t].raw.length&&t--):t===this.client.display.lines.length-1&&this.client.display.lines[t].text.length===0&&this.client.display.lines[t].raw.length&&t--:t===this.client.display.lines.length?(t--,this.client.display.lines[t].text.length===0&&t--):t===this.client.display.lines.length-1&&this.client.display.lines[t].text.length===0&&t--,t)}get isLocked(){return this._locked!==0}addLock(){this._locked++}removeLock(){this._locked--}AddCommandToHistory(t){(this._commandHistory.length<1||this._commandHistory[this._commandHistory.length-1]!==t)&&t.length>0&&(this._commandHistory.length>=this.client.getOption("commandHistorySize")&&this._commandHistory.shift(),this._commandHistory.push(t),this.emit("command-history-changed",this._commandHistory))}clearCommandHistory(){this._commandHistory=[],this._historyIdx=-1,this.emit("command-history-changed",this._commandHistory)}setHistoryIndex(t){t<0||this._commandHistory.length===0?this._historyIdx=-1:t>=this._commandHistory.length?this._historyIdx=this._commandHistory.length-1:this._historyIdx=t}get commandHistory(){return this._commandHistory}executeScript(t){if(t==null)return t;let e=0,n=0,s,i=t.length,o="",r=[],a="",l,f=0,u=this.client.getOption("parseDoubleQuotes"),b=this.client.getOption("parseSingleQuotes"),h=this.client.getOption("commandChar");for(;n<i;n++)switch(s=t.charAt(n),e){case 1:s===" "?(e=2,l+=s):(o+=s,l+=s);break;case 2:s==="{"?(e=7,a+=s):s==="("?(e=8,a+=s):s===" "?(r.push(a),a=""):(s==='"'&&u?e=3:s==="'"&&b&&(e=4),a+=s),l+=s;break;case 3:s==='"'&&(e=2),a+=s,l+=s;break;case 4:s==="'"&&(e=2),a+=s,l+=s;break;case 7:a+=s,s==="}"?f===0?e=2:f--:s==="{"&&f++,l+=s;break;case 8:a+=s,s===")"?f===0?e=2:f--:s==="("&&f++,l+=s;break;default:if(n===0&&s===h)e=1,o="",r=[],a="",l=s;else return t;break}return o.length>0?(a.endsWith(`
`)&&(a=a.substring(0,a.length-1)),a.length>0&&r.push(a),this.executeFunction(o,r,l,h)):t}executeFunction(t,e,n,s){let i,o=!1,r,a,l,f,u=null,b=null,h,E,S,p,g,C,P;switch(t.toLowerCase()){case"unaction":case"untrigger":case"unt":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),u=null,b=null,S=!0,e.length<1||e.length>2)throw new Error("Invalid syntax use \x1B[4m"+s+"unt\x1B[0;-11;-12mrigger {pattern|name} \x1B[3mprofile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid name or pattern");if(e[0].match(/^\{.*\}$/g)?e[0]=this.parseInline(e[0].substr(1,e[0].length-2)):e[0]=this.parseInline(this.stripQuotes(e[0])),e.length===2&&(u=this.stripQuotes(e[2]),u=this.parseInline(u)),!u||u.length===0){let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");h=this.client.profiles.items[y[d]].findAny("triggers",{name:e[0],pattern:e[0]})}else for(;d<v;d++)if(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(h=this.client.profiles.items[y[d]].findAny("triggers",{name:e[0],pattern:e[0]}),h)){u=this.client.profiles.items[y[d]];break}if(!h)throw new Error("Trigger '"+e[0]+"' not found in '"+u.name+"'!");this.client.removeTrigger(h),this.client.echo("Trigger '"+e[0]+"' removed from '"+u.name+"'.",-7,-8,!0,!0)}else if(u=this.parseInline(u),this.client.profiles.contains(u)){if(u=this.client.profiles.items[u.toLowerCase()],h=u.findAny("triggers",{name:e[0],pattern:e[0]}),!h)throw new Error("Trigger '"+e[0]+"' not found in '"+u.name+"'!");this.client.removeTrigger(h),this.client.echo("Trigger '"+e[0]+"' removed from '"+u.name+"'.",-7,-8,!0,!0)}else throw new Error("Profile not found: "+u);return null;case"suspend":case"sus":switch((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length){case 0:return f=this.client.alarms,f.length===0?this.client.echo("No alarms defined.",-7,-8,!0,!0):(this.client.setAlarmState(0,!1),this._lastSuspend=0,this.client.echo("Last alarm suspended.",-7,-8,!0,!0)),null;case 1:r=this.parseInline(this.stripQuotes(e[0])),f=this.client.alarms,a=f.length;for(let y=f.length-1;y>=0;y--)if(f[y].name===r||f[y].pattern===r){this.client.setAlarmState(y,!1),this.client.echo("Alarm '"+r+"' suspended.",-7,-8,!0,!0),this._lastSuspend=y;break}return null;default:throw new Error("Invalid syntax use \x1B[4m"+s+"sus\x1B[0;-11;-12mpend id \x1B[3mprofile\x1B[0;-11;-12m or \x1B[4m"+s+"sus\x1B[0;-11;-12mpend")}case"resume":case"resu":switch((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length){case 0:return this._lastSuspend===-1||(this.client.setAlarmState(this._lastSuspend,!0),this.client.echo("Last alarm suspended resumed.",-7,-8,!0,!0),this._lastSuspend=-1),null;case 1:r=this.parseInline(this.stripQuotes(e[0])),f=this.client.alarms,a=f.length;for(let y=a-1;y>=0;y--)if(f[y].name===r||f[y].pattern===r){this.client.setAlarmState(y,!0),this.client.echo("Alarm '"+r+"' resumed.",-7,-8,!0,!0);break}return null;default:throw new Error("Invalid syntax use \x1B[4m"+s+"resu\x1B[0;-11;-12mme id \x1B[3mprofile\x1B[0;-11;-12m or \x1B[4m"+s+"resu\x1B[0;-11;-12mme")}case"action":case"ac":case"trigger":case"tr":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),h={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+s+"tr\x1B[0;-11;-12migger name {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or \x1B[4m"+s+"tr\x1B[0;-11;-12migger {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid trigger name or pattern");if(e[0].match(/^\{.*\}$/g))h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2));else{if(h.name=this.parseInline(this.stripQuotes(e.shift())),!h.name||h.name.length===0)throw new Error("Invalid trigger name");e[0].match(/^\{.*\}$/g)&&(h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid trigger option '${y.trim()}'`)}});else throw new Error("Invalid trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid trigger option '${y.trim()}'`)}});else throw new Error("Invalid trigger options");h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))}}return this.createTrigger(h.pattern,h.commands,h.profile,h.options,h.name),null;case"event":case"ev":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),u=null,S=!0,h={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+s+"ev\x1B[0;-11;-12ment name {commands} \x1B[3moptions profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid event name");if(h.name=this.parseInline(this.stripQuotes(e.shift())),!h.name||h.name.length===0)throw new Error("Invalid event name");if(e.length===0)throw new Error("Missing commands or options");if(e[0].match(/^\{[\s\S]*\}$/g))h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2);else throw new Error("Missing commands");if(e.length===1)if(e[0]=e[0].substr(1,e[0].length-2),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"temporary":case"temp":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid event priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid event priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid event option '${y.trim()}'`)}});else throw new Error("Invalid event options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"temporary":case"temp":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid event priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid event priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid event option '${y.trim()}'`)}});else throw new Error("Invalid event options");h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))}if(!h.profile||h.profile.length===0){let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");u=this.client.profiles.items[y[0]],f=W(this.client.profiles.items[y[d]].triggers.filter(U=>U.type===2)),p=f.find(U=>U.name===h.name||U.pattern===h.name)}else{for(;d<v;d++)if(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(f=W(this.client.profiles.items[y[d]].triggers.filter(U=>U.type===2)),p=f.find(U=>U.name===h.name||U.pattern===h.name),p)){u=this.client.profiles.items[y[d]];break}u||(u=this.client.activeProfile)}}else{if(this.client.profiles.contains(h.profile))u=this.client.profiles.items[h.profile.toLowerCase()];else throw new Error("Profile not found: "+h.profile);p=f.find(y=>y.name===h.name||y.pattern===h.name)}return p?this.client.echo("Event '"+p.name+"' updated.",-7,-8,!0,!0):(p=new oe,p.name=h.name,u.triggers.push(p),this.client.echo("Event '"+p.name+"' added.",-7,-8,!0,!0),h.new=!0),p.pattern=h.name,h.commands!==null&&(p.value=h.commands),p.type=2,h.options.prompt&&(p.triggerPrompt=!0),h.options.nocr&&(p.triggerNewline=!1),h.options.case&&(p.caseSensitive=!0),h.options.raw&&(p.raw=!0),h.options.verbatim&&(p.verbatim=!0),h.options.disable?p.enabled=!1:h.options.enable&&(p.enabled=!0),(h.options.temporary||h.options.temp)&&(p.temp=!0),p.priority=h.options.priority,this.client.saveProfiles(),S&&this.client.clearCache(),h.new?this.emit("item-added","trigger",u.name,p):this.emit("item-updated","trigger",u.name,u.triggers.indexOf(p),p),u=null,null;case"unevent":case"une":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"une\x1B[0;-11;-12mvent name or \x1B[4m"+s+"une\x1B[0;-11;-12mvent {name} \x1B[3mprofile\x1B[0;-11;-12m");if(S=!0,u=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+s+"une\x1B[0;-11;-12mvent name or \x1B[4m"+s+"une\x1B[0;-11;-12mvent {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(u=this.parseInline(this.stripQuotes(e[1])).toLowerCase(),this.client.profiles.contains(u))u=this.client.profiles.items[u];else throw new Error("Profile not found: "+u);else u=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?i=this.parseInline(this.stripQuotes(e[0])):i=this.parseInline(e[0].substr(1,e[0].length-2))}else i=this.parseInline(e.join(" ")),u=this.client.activeProfile;return r=W(u.triggers.filter(y=>y.type===2)),i=this.stripQuotes(i),f=i,i=r.findIndex(y=>y.pattern===i||y.name===i),o=i!==-1,o?(this.client.echo("Event '"+(r[i].name||r[i].pattern)+"' removed.",-7,-8,!0,!0),S?this.client.removeTrigger(r[i]):(i=u.triggers.indexOf(r[i]),u.triggers.splice(i,1),this.client.saveProfiles(),this.emit("item-removed","trigger",u.name,i)),u=null):this.client.echo("Event '"+f+"' not found.",-7,-8,!0,!0),null;case"button":case"bu":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===1){if(i=this.parseInline(this.stripQuotes(e[0])),r=document.getElementById("user-buttons").children,/^\s*?\d+\s*?$/.exec(i)){if(i=parseInt(i,10),i<0||i>=r.length)throw new Error("Button index must be >= 0 and < "+r.length);r[i].click()}else if(r[i])r[i].click();else throw new Error(`Button '${i}' not found`);return null}if(u=null,S=!0,h={profile:null,name:null,caption:null,commands:null,icon:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+s+"bu\x1B[0;-11;-12mtton name|index or \x1B[4m"+s+"bu\x1B[0;-11;-12mtton name \x1B[3mcaption\x1B[0;-11;-12m {commands} \x1B[3m{icon} options profile\x1B[0;-11;-12m or \x1B[4m"+s+"by\x1B[0;-11;-12mutton \x1B[3mcaption\x1B[0;-11;-12m {commands} \x1B[3m{icon} {options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid button name, caption or commands");if(e[0].match(/^\{[\s\S]*\}$/g))h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2);else{if(h.name=this.parseInline(this.stripQuotes(e.shift())),!h.name||h.name.length===0)throw new Error("Invalid button name or caption");if(e[0].match(/^\{[\s\S]*\}$/g))h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2);else if(h.caption=this.stripQuotes(e.shift()),!e[0].match(/^\{[\s\S]*\}$/g))throw new Error("Missing commands")}if(e.length!==0){if(e[0].match(/^\{.*\}$/g)&&(h.icon=e.shift(),h.icon=h.icon.substr(1,h.icon.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nosend":case"chain":case"append":case"stretch":case"disable":case"enable":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid button priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid button priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid button option '${y.trim()}'`)}});else throw new Error("Invalid button options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nosend":case"chain":case"append":case"stretch":case"disable":case"enable":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid button priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid button priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid button option '${y.trim()}'`)}});else throw new Error("Invalid button options");h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))}}if(!h.profile||h.profile.length===0){let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");u=this.client.profiles.items[y[0]],h.name!==null?p=this.client.profiles.items[y[d]].find("buttons","name",h.name):p=this.client.profiles.items[y[d]].find("buttons","caption",h.caption)}else{for(;d<v;d++)if(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(h.name!==null?p=this.client.profiles.items[y[d]].find("buttons","name",h.name):p=this.client.profiles.items[y[d]].find("buttons","caption",h.caption),p)){u=this.client.profiles.items[y[d]];break}u||(u=this.client.activeProfile)}}else{if(this.client.profiles.contains(h.profile))u=this.client.profiles.items[h.profile.toLowerCase()];else throw new Error("Profile not found: "+h.profile);h.name!==null?p=u.find("buttons","name",h.name):p=u.find("buttons","caption",h.caption)}return p?this.client.echo("Button '"+(p.name||p.caption||"")+"' updated.",-7,-8,!0,!0):(p=new Le,p.name=h.name||"",p.caption=h.caption||"",u.buttons.push(p),!h.name&&!h.caption?this.client.echo("Button added.",-7,-8,!0,!0):this.client.echo("Button '"+(p.name||p.caption||"")+"' added.",-7,-8,!0,!0),h.new=!0),h.caption!==null&&(p.caption=h.caption),h.commands!==null&&(p.value=h.commands),h.options.icon&&(p.icon=h.options.icon),h.options.nosend&&(p.send=!1),h.options.chain&&(p.chain=!0),h.options.append&&(p.append=!0),h.options.stretch&&(p.stretch=!0),h.options.disable?p.enabled=!1:h.options.enable&&(p.enabled=!0),p.priority=h.options.priority,this.client.saveProfiles(),S&&this.client.clearCache(),h.new?this.emit("item-added","button",u.name,p):this.emit("item-updated","button",u.name,u.buttons.indexOf(p),p),u=null,null;case"unbutton":case"unb":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"unb\x1B[0;-11;-12mtton name or \x1B[4m"+s+"unb\x1B[0;-11;-12mtton {name} \x1B[3mprofile\x1B[0;-11;-12m");if(S=!0,u=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+s+"unb\x1B[0;-11;-12mtton name or \x1B[4m"+s+"unb\x1B[0;-11;-12mtton {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(u=this.parseInline(this.stripQuotes(e[1])),this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);else u=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?i=this.parseInline(this.stripQuotes(e[0])):i=this.parseInline(e[0].substr(1,e[0].length-2))}else i=this.parseInline(e.join(" ")),u=this.client.activeProfile;if(r=W(u.buttons),f=i,/^\s*?\d+\s*?$/.exec(i)){if(i=parseInt(i,10),i<0||i>=r.length)throw new Error("Button index must be >= 0 and < "+r.length);o=!0}else i=this.stripQuotes(i),i=r.findIndex(y=>y.name===i||y.caption===i),o=i!==-1;return o?(r[i].name.length===0&&r[i].caption.length===0?this.client.echo("Button '"+f+"' removed.",-7,-8,!0,!0):this.client.echo("Button '"+(r[i].name||r[i].caption)+"' removed.",-7,-8,!0,!0),i=u.buttons.indexOf(r[i]),u.buttons.splice(i,1),this.client.saveProfiles(),S&&this.client.clearCache(),this.emit("item-removed","button",u.name,i),u=null):this.client.echo("Button '"+f+"' not found.",-7,-8,!0,!0),null;case"alarm":case"ala":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),u=null,b=null,S=!0,i=!1,e.length<2||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+s+"ala\x1B[0;-11;-12mrm name {timepattern} {commands} \x1B[3mprofile\x1B[0;-11;-12m, \x1B[4m"+s+"ala\x1B[0;-11;-12mrm name {timepattern} \x1B[3mprofile\x1B[0;-11;-12m, or \x1B[4m"+s+"ala\x1B[0;-11;-12mrm {timepattern} {commands} \x1B[3mprofile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid name or timepattern");if(e[0].match(/^\{.*\}$/g)){if(e.length>3)throw new Error("Invalid syntax use \x1B[4m"+s+"ala\x1B[0;-11;-12mrm {timepattern} {commands} profile");if(e[0]=e[0].substr(1,e[0].length-2),e[0]=this.parseInline(e[0]),e[1].match(/^\{[\s\S]*\}$/g)&&(e[1]=e[1].substr(1,e[1].length-2)),e.length===3&&(u=this.stripQuotes(e[2]),u=this.parseInline(u)),!u||u.length===0)u=this.client.activeProfile;else if(this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);return p=new oe,p.pattern=e[0],p.value=e[1],p.type=3,u.triggers.push(p),this.client.saveProfiles(),S&&(this._lastSuspend=-1,this.client.updateAlarms()),this.client.echo("Alarm '"+p.pattern+"' added.",-7,-8,!0,!0),this.emit("item-added","trigger",u.name,p),u=null,null}if(b=this.stripQuotes(e[0]),!b||b.length===0)throw new Error("Invalid alarm name");b=this.parseInline(b);let G=e[1],M=null;if(G.match(/^\{.*\}$/g)&&(G=G.substr(1,G.length-2)),G=this.parseInline(G),e.length===3?e[2].match(/^\{[\s\S]*\}$/g)?M=e[2].substr(1,e[2].length-2):u=this.stripQuotes(e[2]):e.length===4&&(M=e[2],u=this.stripQuotes(e[3]),M.match(/^\{[\s\S]*\}$/g)&&(M=M.substr(1,M.length-2))),!u||u.length===0){let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");if(u=this.client.profiles.items[y[0]],p=u.find("triggers","name",b),!p&&!M)throw new Error("Alarm not found!");p?this.client.echo("Alarm '"+p.name+"' updated.",-7,-8,!0,!0):(p=new oe,p.name=b,u.triggers.push(p),this.client.echo("Alarm '"+p.name+"' added.",-7,-8,!0,!0),i=!0)}else{for(;d<v;d++)if(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(p=this.client.profiles.items[y[d]].find("triggers","name",b),p)){u=this.client.profiles.items[y[d]];break}if(!u&&!M)throw new Error("Alarm not found!");u||(u=this.client.activeProfile),p?this.client.echo("Alarm '"+p.name+"' updated.",-7,-8,!0,!0):(p=new oe,i=!0,p.name=b,u.triggers.push(p),this.client.echo("Alarm '"+p.name+"' added.",-7,-8,!0,!0))}}else{if(u=this.parseInline(u),this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);if(p=u.find("triggers","name",b),!p&&!M)throw new Error("Alarm not found!");p?this.client.echo("Alarm '"+p.name+"' updated.",-7,-8,!0,!0):(p=new oe,p.name=b,u.triggers.push(p),i=!0,this.client.echo("Alarm '"+p.name+"' added.",-7,-8,!0,!0))}return p.pattern=G,p.type=3,M&&(p.value=M),this.client.saveProfiles(),i?this.emit("item-added","trigger",u.name,p):this.emit("item-updated","trigger",u.name,u.triggers.indexOf(p),p),u=null,S&&(this._lastSuspend=-1,this.client.updateAlarms()),null;case"ungag":case"ung":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length>0)throw new Error("Invalid syntax use \x1B[4m"+s+"ung\x1B[0;-11;-12mag number or \x1B[4m"+s+"ung\x1B[0;-11;-12mag");return this._gagID.length&&(clearTimeout(this._gagID.pop()),this._gags.pop()),this._gag=0,null;case"gag":case"ga":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)return this._gags.length&&this._gags[this._gags.length-1]==this.client.display.lines.length&&(this._gag=0,this._gags.pop()),this._gags.push(this.client.display.lines.length),this._gagID.push(setTimeout(()=>{if(i=this.adjustLastLine(this._gags.pop()),this._gags.length){let y=this._gags.length;for(;y>=0;)y--,this._gags[y]>i&&this._gags[y]--}this.client.display.removeLine(i)},0)),this._gag=0,null;if(e.length>1)throw new Error("Invalid syntax use \x1B[4m"+s+"ga\x1B[0;-11;-12mg number or \x1B[4m"+s+"ga\x1B[0;-11;-12mg");if(l=parseInt(e[0],10),isNaN(l))throw new Error("Invalid number '"+e[0]+"'");return this._gags.length&&this._gags[this._gags.length-1]==this.client.display.lines.length&&(this._gag=0,this._gags.pop()),this._gags.push(this.client.display.lines.length),l>=0?(this._gagID.push(setTimeout(()=>{if(i=this.adjustLastLine(this._gags.pop()),this._gags.length){let y=this._gags.length;for(;y>=0;)y--,this._gags[y]>i&&this._gags[y]--}this.client.display.removeLine(i),this._gag=l},0)),this._gag=0):(this._gagID.push(setTimeout(()=>{i=this.adjustLastLine(this._gags.pop()),l*=-1,l>this.client.display.lines.length&&(l=this.client.display.lines.length),this.client.display.removeLines(i-l,l),this._gag=0},0)),this._gag=0),null;case"wait":case"wa":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e=e.filter(y=>y),e.length===0||e.length>1)throw new Error("Invalid syntax use \x1B[4m"+s+"wa\x1B[0;-11;-12mit number");if(l=parseInt(this.parseInline(e[0]),10),isNaN(l))throw new Error("Invalid number '"+l+"' for wait");if(l<1)throw new Error("Must be greater then zero for wait");return l;case"showclient":case"showcl":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.show(),null;case"hideclient":case"hidecl":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.hide(),null;case"toggleclient":case"togglecl":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.toggle(),null;case"raiseevent":case"raise":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.getOption("parseDoubleQuotes")&&e.forEach(y=>y.replace(/^\"(.*)\"$/g,(d,v,U)=>v.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(y=>y.replace(/^\'(.*)\'$/g,(d,v,U)=>v.replace(/\\\'/g,"'"))),e.length===0)throw new Error("Invalid syntax use "+s+"\x1B[4mraise\x1B[0;-11;-12mevent name or "+s+"\x1B[4mraise\x1B[0;-11;-12mevent name arguments");return e.length===1?this.client.raise(e[0]):this.client.raise(e[0],e.slice(1)),null;case"window":case"win":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.getOption("parseDoubleQuotes")&&e.forEach(y=>y.replace(/^\"(.*)\"$/g,(d,v,U)=>v.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(y=>y.replace(/^\'(.*)\'$/g,(d,v,U)=>v.replace(/\\\'/g,"'"))),e.length===0||e.length>3)throw new Error("Invalid syntax use "+s+"\x1B[4mwin\x1B[0;-11;-12mdow name \x1B[3mclose\x1B[0;-11;-12m or "+s+"\x1B[4mwin\x1B[0;-11;-12mdow new \x1B[3mcharacter\x1B[0;-11;-12m");return e.length===3?this.client.emit("window",this.stripQuotes(this.parseInline(e[0])),this.stripQuotes(this.parseInline(e[1])),this.stripQuotes(this.parseInline(e.slice(2).join(" ")))):e.length===1?this.client.emit("window",this.stripQuotes(this.parseInline(e[0]))):this.client.emit("window",this.stripQuotes(this.parseInline(e[0])),this.stripQuotes(this.parseInline(e.slice(1).join(" ")))),null;case"raisedelayed":case"raisede":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+s+"raisede\x1B[0;-11;-12mlayed milliseconds name or \x1B[4m"+s+"raisede\x1B[0;-11;-12mlayed milliseconds name arguments");if(l=parseInt(this.stripQuotes(this.parseInline(e[0])),10),isNaN(l))throw new Error("Invalid number '"+e[0]+"' for raisedelayed");if(l<1)throw new Error("Must be greater then zero for raisedelayed");return e.shift(),this.client.getOption("parseDoubleQuotes")&&e.forEach(y=>y.replace(/^\"(.*)\"$/g,(d,v,U)=>v.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(y=>y.replace(/^\'(.*)\'$/g,(d,v,U)=>v.replace(/\\\'/g,"'"))),e.length===1?this.client.raise(e[0],0,l):this.client.raise(e[0],e.slice(1),l),null;case"notify":case"not":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"not\x1B[0;-11;-12mify title \x1B[3mmessage icon\x1B[0;-11;-12m");if(e[0]=this.stripQuotes(e[0]),e[e.length-1].match(/^\{.*\}$/g)&&(h=e.pop(),i={icon:this.parseInline(h.substr(1,h.length-2))}),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"not\x1B[0;-11;-12mify title \x1B[3mmessage icon\x1B[0;-11;-12m");return e.length===1?this.client.notify(this.parseInline(this.stripQuotes(e[0])),null,i):this.client.notify(this.parseInline(this.stripQuotes(e[0])),this.parseInline(e.slice(1).join(" ")),i),null;case"idle":case"idletime":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.lastSendTime?this.client.echo("You have been idle: "+mt(Date.now()-this.client.lastSendTime),-7,-8,!0,!0):this.client.echo("Not connected",-7,-8,!0,!0),null;case"connect":case"connecttime":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.connectTime?this.client.echo("You have been connected: "+mt(Date.now()-this.client.connectTime),-7,-8,!0,!0):!moment&&this.client.disconnectTime?this.client.echo("Disconnected since: "+new Date(this.client.disconnectTime).toLocaleString(),-7,-8,!0,!0):this.client.disconnectTime?this.client.echo("Disconnected since: "+new moment(this.client.disconnectTime).format("MM/DD/YYYY hh:mm:ss A"),-7,-8,!0,!0):this.client.echo("Not connected",-7,-8,!0,!0),null;case"beep":case"be":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.beep(),null;case"version":case"ve":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.echo(this.client.telnet.terminal+" v"+this.client.version,-7,-8,!0,!0),null;case"showprompt":case"showp":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.telnet.receivedData(ke(e),!0,!0),this.client.telnet.prompt=!0,null;case"show":case"sh":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e=this.parseInline(e.join(" ")+`
`),this.client.telnet.receivedData(ke(e),!0,!0),null;case"sayprompt":case"sayp":case"echoprompt":case"echop":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.print("\x1B[-7;-8m"+e+"\x1B[0m",!1),null;case"say":case"sa":case"echo":case"ec":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"print":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),l=this.client.enableTriggers,this.client.enableTriggers=!1,e=this.parseInline(e.join(" ")),this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,this.client.enableTriggers=l,null;case"printprompt":case"printp":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),l=this.client.enableTriggers,this.client.enableTriggers=!1,e=this.parseInline(e.join(" ")),this.client.print("\x1B[-7;-8m"+e+"\x1B[0m",!1),this.client.enableTriggers=l,null;case"alias":case"al":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"al\x1B[0;-11;-12mias name value or \x1B[4m"+s+"al\x1B[0;-11;-12mias name {value} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===1)throw new Error("Must supply an alias value");if(i=this.parseInline(this.stripQuotes(e.shift())),S=!0,u=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+s+"al\x1B[0;-11;-12mias name value or \x1B[4m"+s+"al\x1B[0;-11;-12mias name {value} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(u=this.parseInline(this.stripQuotes(e[1])),this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);else u=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?e=this.parseInline(this.stripQuotes(e[0])):e=this.parseInline(e[0].substr(1,e[0].length-2))}else e=e.join(" "),u=this.client.activeProfile;if(r=u.aliases,e=this.stripQuotes(e),/^\s*?\d+\s*?$/.exec(i)){if(i=parseInt(i,10),i<0||i>=r.length)throw new Error("Alias index must be >= 0 and < "+r.length);r[i].value=e,this.client.echo("Alias '"+r[i].pattern+"' updated.",-7,-8,!0,!0)}else{for(l=0,a=r.length;l<a;l++)if(r[l].pattern===i){r[l].value=e,this.client.echo("Alias '"+i+"' updated.",-7,-8,!0,!0),this.emit("item-updated","alias",u.name,l,f),o=!0;break}o||(f=new Oe(i,e),r.push(f),this.emit("item-added","alias",u.name,f),this.client.echo("Alias '"+i+"' added.",-7,-8,!0,!0))}return u.aliases=r,this.client.saveProfiles(),u=null,S&&this.client.clearCache(),null;case"unalias":case"una":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"una\x1B[0;-11;-12mlias name or \x1B[4m"+s+"una\x1B[0;-11;-12mlias {name} \x1B[3mprofile\x1B[0;-11;-12m");if(S=!0,u=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+s+"una\x1B[0;-11;-12mlias name or \x1B[4m"+s+"una\x1B[0;-11;-12mlias {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(u=this.stripQuotes(e[1]),u=this.parseInline(u),this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);else u=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?i=this.parseInline(this.stripQuotes(e[0])):i=this.parseInline(e[0].substr(1,e[0].length-2))}else i=this.parseInline(e.join(" ")),u=this.client.activeProfile;if(r=u.aliases,i=this.stripQuotes(i),/^\s*?\d+\s*?$/.exec(i)){if(f=i,i=parseInt(i,10),i<0||i>=r.length)throw new Error("Alias index must be >= 0 and < "+r.length);o=!0}else f=i,i=r.findIndex(y=>y.pattern===i),o=i!==-1;return o?(this.client.echo("Alias '"+r[i].pattern+"' removed.",-7,-8,!0,!0),r.splice(i,1),u.aliases=r,this.client.saveProfiles(),S&&this.client.clearCache(),u=null,this.emit("item-removed","alias",u.name,i)):this.client.echo("Alias '"+f+"' not found.",-7,-8,!0,!0),null;case"setsetting":case"sets":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"sets\x1B[0;-11;-12metting name value");if(e.length===1)throw new Error("Must supply a setsetting value");if(i=this.stripQuotes(this.parseInline(e[0])),e=this.stripQuotes(this.parseInline(e.slice(1).join(" "))),/^\s*?\d+\s*?$/.exec(i)){if(f=i,i=parseInt(i,10),i<0||i>=H.length)throw new Error("Setting index must be >= 0 and < "+H.length);o=!0}else for(i=i.toLowerCase(),l=0,a=H.length;l<a;l++)if(H[l][0].toLowerCase()===i){i=l,o=!0;break}if(o)switch(H[i][2]){case 0:if(H[i][4]>0&&e.length>H[i][4])throw new Error("String can not be longer then "+H[i][4]+" characters");this.client.setOption(H[i][1]||H[i][0],e),this.client.echo("Setting '"+H[i][0]+"' set to '"+e+"'.",-7,-8,!0,!0),this.client.loadOptions();break;case 1:case 3:switch(e.toLowerCase()){case"true":case"1":case"yes":this.client.setOption(H[i][1]||H[i][0],!0),this.client.echo("Setting '"+H[i][0]+"' set to true.",-7,-8,!0,!0),this.client.loadOptions();break;case"no":case"false":case"0":this.client.setOption(H[i][1]||H[i][0],!1),this.client.echo("Setting '"+H[i][0]+"' set to false.",-7,-8,!0,!0),this.client.loadOptions();break;case"toggle":e=!this.client.getOption(H[i][1]||H[i][0]),this.client.setOption(H[i][1]||H[i][0],e),this.client.echo("Setting '"+H[i][0]+"' set to "+e+".",-7,-8,!0,!0),this.client.loadOptions();break;default:throw new Error("Invalid value, must be true or false")}break;case 2:if(l=parseInt(e,10),isNaN(l))throw new Error("Invalid number '"+e+"'");this.client.setOption(H[i][1]||H[i][0],l),this.client.echo("Setting '"+H[i][0]+"' set to '"+l+"'.",-7,-8,!0,!0),this.client.loadOptions();break;case 4:case 5:throw new Error("Unsupported setting '"+i+"'")}else throw new Error("Unknown setting '"+f+"'");return null;case"getsetting":case"gets":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"gets\x1B[0;-11;-12metting name");if(i=this.stripQuotes(this.parseInline(e.join(" "))),/^\s*?\d+\s*?$/.exec(i)){if(i=parseInt(i,10),i<0||i>=H.length)throw new Error("Setting index must be >= 0 and < "+H.length);o=!0}else{if(f=i,i=i.toLowerCase(),i!=="all"){for(l=0,a=H.length;l<a;l++)if(H[l][0].toLowerCase()===i){i=l,o=!0;break}}if(i==="all"){for(f=`Current settings:
`,l=0,a=H.length;l<a;l++)switch(H[l][2]){case 0:case 2:f+="    "+H[l][0]+": "+this.client.getOption(H[i][1]||H[i][0])+`
`;break;case 1:case 3:this.client.getOption(H[i][1]||H[i][0])?f+="    "+H[l][0]+`: true
`:f+="    "+H[l][0]+`: false
`;break}this.client.echo(f,-7,-8,!0,!0)}else if(o)switch(H[i][2]){case 0:case 2:this.client.echo("Setting '"+H[i][0]+"' is '"+this.client.getOption(H[i][1]||H[i][0])+"'",-7,-8,!0,!0);break;case 1:case 3:this.client.getOption(H[i][1]||H[i][0])?this.client.echo("Setting '"+H[i][0]+"' is true",-7,-8,!0,!0):this.client.echo("Setting '"+H[i][0]+"' is false",-7,-8,!0,!0);break}else throw new Error("Unknown setting '"+i+"'")}return null;case"profilelist":(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.echo("\x1B[4mProfiles:\x1B[0m",-7,-8,!0,!0);let _=this.client.profiles.keys;for(a=_.length,l=0;l<a;l++)this.client.profiles.items[_[l]]&&this.client.profiles.items[_[l]].enabled?this.client.echo("   "+this.client.profiles.keys[l]+" is enabled",-7,-8,!0,!0):this.client.echo("   "+_[l]+" is disabled",-7,-8,!0,!0);return null;case"profile":case"pro":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+s+"pro\x1B[0;-11;-12mfile name enable/disable");if(e.length===1){if(e[0]=this.parseInline(e[0]),this.client.toggleProfile(e[0]),this.client.profiles.contains(e[0])){if(this.client.profiles.length===1)throw new Error(e[0]+" can not be disabled as it is the only one enabled")}else throw new Error("Profile not found");this.client.profiles.contains(e[0].toLowerCase())?this.client.profiles.items[e[0].toLowerCase()].enabled?e=e[0]+" is enabled":e=e[0]+" is disabled":e="Profile not found"}else{if(e[0]=this.parseInline(e[0]).toLowerCase(),!this.client.profiles.contains(e[0]))throw new Error("Profile not found");if(!e[1])throw new Error("Invalid syntax use \x1B[4m"+s+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+s+"pro\x1B[0;-11;-12mfile name enable/disable");switch(e[1]=this.parseInline(e[1]),e[1].toLowerCase()){case"enable":case"on":case"yes":this.client.profiles.items[e[0].toLowerCase()].enabled?e=e[0]+" is already enabled":(this.client.toggleProfile(e[0]),this.client.profiles.items[e[0].toLowerCase()].enabled!==-1?e=e[0]+" is enabled":e=e[0]+" remains disabled");break;case"disable":case"off":case"no":if(!this.client.profiles.items[e[0].toLowerCase()].enabled)e=e[0]+" is already disabled";else{if(this.client.profiles.length===1)throw new Error(e[0]+" can not be disabled as it is the only one enabled");this.client.toggleProfile(e[0]),e=e[0]+" is disabled"}break;default:throw new Error("Invalid syntax use \x1B[4m"+s+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+s+"pro\x1B[0;-11;-12mfile name enable/disable")}}return this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"color":case"co":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length>1&&e.length<4)return h={profile:null,pattern:null,commands:null},h.pattern=e.shift(),h.pattern.match(/^\{.*\}$/g)?h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)):h.pattern=this.parseInline(this.stripQuotes(h.pattern)),e.length===2?(h.commands=s+"COLOR "+this.parseInline(e[0]),h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))):h.commands=s+"COLOR "+this.parseInline(e[0]),this.createTrigger(h.pattern,h.commands,h.profile),null;if(e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+s+"co\x1B[0;-11;-12mlor color or \x1B[4m"+s+"co\x1B[0;-11;-12mlor {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+s+"co\x1B[0;-11;-12mlor color or \x1B[4m"+s+"co\x1B[0;-11;-12mlor {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(e[0]=this.parseInline(this.stripQuotes(e[0])),i=this.client.display.lines.length,e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{i=this.adjustLastLine(i),this.client.display.colorSubStrByLine(i,parseInt(e[0],10))},0);else if(e[0].trim().match(/^[-|+]?\d+\s*?,\s*?[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{i=this.adjustLastLine(i),this.client.display.colorSubStrByLine(i,parseInt(e[0][0],10),parseInt(e[0][1],10))},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(l=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=V(e[0]),l===-1)if(te(e[0]))l=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{i=this.adjustLastLine(i),this.client.display.colorSubStrByLine(i,l)},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")l=370;else if(e[0]==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=V(e[0]),l===-1)if(te(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{i=this.adjustLastLine(i),l===370?this.client.display.colorSubStrByLine(i,l):this.client.display.colorSubStrByLine(i,l*10)},0);else{if(E=l,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=V(e[1],!0),l===-1)if(te(e[1]))l=e[1];else throw new Error("Invalid back color");setTimeout(()=>{i=this.adjustLastLine(i),this.client.display.colorSubStrByLine(i,E,l)},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=V(e[0]),l===-1)if(te(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(l?E=l*10:l=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=V(e[1],!0),l===-1)if(te(e[1]))l=e[0];else throw new Error("Invalid back color");setTimeout(()=>{i=this.adjustLastLine(i),this.client.display.colorSubStrByLine(i,E,l)},0)}return null;case"cw":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),p=this.stack.regex,e.length>1&&e.length<4)return h={profile:null,pattern:null,commands:null},h.pattern=e.shift(),h.pattern.match(/^\{.*\}$/g)?h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)):h.pattern=this.parseInline(this.stripQuotes(h.pattern)),e.length===2?(h.commands=s+"CW "+this.parseInline(e[0]),h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))):h.commands=s+"CW "+this.parseInline(e[0]),this.createTrigger(h.pattern,h.commands,h.profile),null;if(e.length!==1)throw new Error("Invalid syntax use "+s+"cw color or "+s+"cw {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(!p)return null;if(e[0]=this.parseInline(this.stripQuotes(e[0])),i=this.client.display.lines.length,e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{if(i=this.adjustLastLine(i),p.length===1)this.client.display.colorSubStrByLine(i,parseInt(e[0],10));else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(i,parseInt(e[0],10),null,y.index,y[0].length)}},0);else if(e[0].trim().match(/^[-|+]?\d+,[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{if(i=this.adjustLastLine(i),p.length===1)this.client.display.colorSubStrByLine(i,parseInt(e[0][0],10),parseInt(e[0][1],10));else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(i,parseInt(e[0],10),parseInt(e[0][1],10),y.index,y[0].length)}},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(l=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=V(e[0]),l===-1)if(te(e[0]))l=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{if(i=this.adjustLastLine(i),p.length===1)this.client.display.colorSubStrByLine(i,l);else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(i,l,null,y.index,y[0].length)}},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")l=370;else if(e[0]==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=V(e[0]),l===-1)if(te(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{if(i=this.adjustLastLine(i),l!==370&&(l*=10),p.length===1)this.client.display.colorSubStrByLine(i,l);else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(i,l,null,y.index,y[0].length)}},0);else{if(E=l,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=V(e[1],!0),l===-1)if(te(e[1]))l=e[1];else throw new Error("Invalid back color");setTimeout(()=>{if(i=this.adjustLastLine(i),p.length===1)this.client.display.colorSubStrByLine(i,E,l);else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(i,E,l,y.index,y[0].length)}},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=V(e[0]),l===-1)if(te(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(l?E=l*10:l=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=V(e[1],!0),l===-1)if(te(e[1]))l=e[0];else throw new Error("Invalid back color");setTimeout(()=>{if(i=this.adjustLastLine(i),p.length===1)this.client.display.colorSubStrByLine(i,E,l);else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(i,E,l,y.index,y[0].length)}},0)}return null;case"pcol":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length<1||e.length>5)throw new Error("Invalid syntax use "+s+"pcol color \x1B[3mXStart, XEnd, YStart, YEnd\x1B[0;-11;-12m");if(e.length>1){if(f=[].concat(...e.slice(1).map(y=>this.parseInline(this.stripQuotes(y)).split(" "))),f.length>4)throw new Error("Too many arguments use "+s+"pcol color \x1B[3mXStart, XEnd, YStart, YEnd\x1B[0;-11;-12m");if(h={xStart:0},f.length>0&&(h.xStart=parseInt(f[0],10)),f.length>1&&(h.xEnd=parseInt(f[1],10)),f.length>2&&(h.yStart=parseInt(f[2],10)),f.length>3&&(h.yEnd=parseInt(f[3],10)),h.hasOwnProperty("yEnd")&&h.yEnd>h.yStart)throw new Error("yEnd must be smaller or equal to yStart");if(h.hasOwnProperty("xEnd")&&h.xEnd<h.xStart)throw new Error("xEnd must be larger or equal to xStart")}else h={xStart:0};if(e[0]=this.parseInline(this.stripQuotes(e[0])),i=this.adjustLastLine(this.client.display.lines.length),e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{this.colorPosition(i,parseInt(e[0],10),null,h)},0);else if(e[0].trim().match(/^[-|+]?\d+\s*?,\s*?[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{this.colorPosition(i,parseInt(e[0][0],10),parseInt(e[0][1],10),h)},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(l=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=V(e[0]),l===-1)if(te(e[0]))l=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{this.colorPosition(i,l,null,h)},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")l=370;else if(e[0]==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=V(e[0]),l===-1)if(te(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{this.colorPosition(i,l===370?l:l*10,null,h)},0);else{if(E=l,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=V(e[1],!0),l===-1)if(te(e[1]))l=e[1];else throw new Error("Invalid back color");setTimeout(()=>{this.colorPosition(i,E,l,h)},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=V(e[0]),l===-1)if(te(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(l?E=l*10:l=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=V(e[1],!0),l===-1)if(te(e[1]))l=e[0];else throw new Error("Invalid back color");setTimeout(()=>{this.colorPosition(i,E,l,h)},0)}return null;case"highlight":case"hi":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length>0&&e.length<2)return h={profile:null,pattern:null,commands:s+"HIGHLIGHT"},h.pattern=e.shift(),h.pattern.match(/^\{.*\}$/g)?h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)):h.pattern=this.parseInline(this.stripQuotes(h.pattern)),e.length===1&&(h.profile=this.parseInline(this.stripQuotes(e[0]))),this.createTrigger(h.pattern,h.commands,h.profile),null;if(e.length)throw new Error("Too many arguments use \x1B[4m"+s+"hi\x1B[0;-11;-12mghlight \x1B[3mpattern profile\x1B[0;-11;-12m");return i=this.client.display.lines.length,setTimeout(()=>{i=this.adjustLastLine(i),this.client.display.highlightSubStrByLine(i)},0),null;case"break":case"br":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use \x1B[4m"+s+"br\x1B[0;-11;-12meak\x1B[0;-11;-12m");if(!this.loops.length)throw new Error("\x1B[4m"+s+"br\x1B[0;-11;-12meak\x1B[0;-11;-12m must be used in a loop.");return this.stack.break?this.stack.break++:this.stack.break=1,-1;case"continue":case"cont":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use \x1B[4m"+s+"cont\x1B[0;-11;-12minue\x1B[0;-11;-12m");if(!this.loops.length)throw new Error("\x1B[4m"+s+"cont\x1B[0;-11;-12minue\x1B[0;-11;-12m must be used in a loop.");return this.stack.continue=!0,-2;case"if":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),!e.length||e.length>3)throw new Error("Invalid syntax use "+s+"if {expression} {true-command} \x1B[3m{false-command}\x1B[0;-11;-12m");return e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),f=null,this.evaluate(this.parseInline(e[0]))?(e[1].match(/^\{[\s\S]*\}$/g)&&(e[1]=e[1].substr(1,e[1].length-2)),f=this.parseOutgoing(e[1])):e.length>2&&(e[2].match(/^\{[\s\S]*\}$/g)&&(e[2]=e[2].substr(1,e[2].length-2)),f=this.parseOutgoing(e[2])),f!=null&&f.length>0?f:null;case"case":case"ca":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),!e.length||e.length<2)throw new Error("Invalid syntax use \x1B[4m"+s+"ca\x1B[0;-11;-12mse\x1B[0;-11;-12m index {command 1} \x1B[3m{command n}\x1B[0;-11;-12m");return e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),i=this.evaluate(this.parseInline(e[0])),typeof i!="number"?null:i>0&&i<e.length&&(e[i].match(/^\{[\s\S]*\}$/g)&&(e[i]=e[i].substr(1,e[i].length-2)),f=this.parseOutgoing(e[i]),f!=null&&f.length>0)?f:null;case"switch":case"sw":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),!e.length||e.length<2)throw new Error("Invalid syntax use \x1B[4m"+s+"sw\x1B[0;-11;-12mitch\x1B[0;-11;-12m (expression) {command} \x1B[3m(expression) {command} ... {else_command}\x1B[0;-11;-12m");for(e.length%2===1?i=e.pop():i=null,a=e.length,l=0;l<a;l+=2)if(e[l].match(/^\{[\s\S]*\}$/g)&&(e[l]=e[l].substr(1,e[l].length-2)),this.evaluate(this.parseInline(e[l])))return e[l+1].match(/^\{[\s\S]*\}$/g)&&(e[l+1]=e[l+1].substr(1,e[l+1].length-2)),f=this.parseOutgoing(e[l+1]),f!=null&&f.length>0?f:null;return i&&(i.match(/^\{[\s\S]*\}$/g)&&(i=i.substr(1,i.length-2)),f=this.parseOutgoing(i),f!=null&&f.length>0)?f:null;case"loop":case"loo":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+s+"loo\x1B[0;-11;-12mp\x1B[0;-11;-12m range {commands}");if(i=this.parseInline(e.shift()).split(","),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),i.length===1){if(f=parseInt(i[0],10),isNaN(f))throw new Error("Invalid loop range '"+i[0]+"' must be a number");return this.executeForLoop(0,f,e)}if(f=parseInt(i[0],10),isNaN(f))throw new Error("Invalid loop min '"+i[0]+"' must be a number");if(l=parseInt(i[1],10),isNaN(l))throw new Error("Invalid loop max '"+i[1]+"' must be a number");return f>l?f++:f--,this.executeForLoop(f,l,e);case"repeat":case"rep":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+s+"rep\x1B[0;-11;-12meat\x1B[0;-11;-12m expression {commands}");if(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.evaluate(this.parseInline(l)),typeof l!="number")throw new Error("Arguments must be a number");return e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),l<1?this.executeForLoop(-l+1,1,e):this.executeForLoop(0,l,e);case"until":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use "+s+"until expression {commands}");for(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),f=[],this.loops.push(0);!this.evaluate(this.parseInline(l));){let y=this.parseOutgoing(e);if(y!=null&&y.length>0&&f.push(y),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}return this.loops.pop(),f.length>0?f.map(y=>y.trim()).join(`
`):null;case"while":case"wh":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+s+"wh\x1B[0;-11;-12mile expression {commands}");for(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),f=[],this.loops.push(0);this.evaluate(this.parseInline(l));){let y=this.parseOutgoing(e);if(y!=null&&y.length>0&&f.push(y),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}return this.loops.pop(),f.length>0?f.map(y=>y.trim()).join(`
`):null;case"forall":case"fo":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+s+"fo\x1B[0;-11;-12mrall stringlist {commands}");for(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),f=[],l=this.splitByQuotes(this.stripQuotes(this.parseInline(l)),"|"),a=l.length,i=0;i<a;i++){this.loops.push(l[i]);let y=this.parseOutgoing(e);if(y!=null&&y.length>0&&f.push(y),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}this.loops.pop()}return f.length>0?f.map(y=>y.trim()).join(`
`):null;case"variable":case"var":case"va":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0){for(l=Object.keys(this.client.variables),a=l.length,f=[],i=0;i<a;i++)f.push(l[i]+" = "+this.client.variables[l[i]]);return f.join(`
`)}if(l=e.shift(),l.match(/^\{.*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),!me(l))throw new Error("Invalid variable name");return e.length===0?this.client.variables[l]?.toString():(e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.parseInline(e),e.match(/^\s*?[-|+]?\d+\s*?$/)?this.client.variables[l]=parseInt(e,10):e.match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?this.client.variables[l]=parseFloat(e):e==="true"?this.client.variables[l]=!0:e==="false"?this.client.variables[l]=!1:this.client.variables[l]=this.stripQuotes(e),null);case"unvar":case"unv":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+s+"unv\x1B[0;-11;-12mar name ");return l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),delete this.client.variables[l],null;case"add":case"ad":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+s+"ad\x1B[0;-11;-12md name value");if(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),this.client.variables.hasOwnProperty(l)&&typeof this.client.variables[l]!="number")throw new Error(l+" is not a number for add");if(e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.evaluate(this.parseInline(e)),typeof e!="number")throw new Error("Value is not a number for add");return this.client.variables.hasOwnProperty(l)?this.client.variables[l]+=e:this.client.variables[l]=e,null;case"math":case"mat":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+s+"mat\x1B[0;-11;-12mh name value");if(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.evaluate(this.parseInline(e)),typeof e!="number")throw new Error("Value is not a number for add");return this.client.variables[l]=e,null;case"evaluate":case"eva":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"eva\x1B[0;-11;-12mluate expression");return e=this.evaluate(this.parseInline(e.join(" "))),this.client.getOption("ignoreEvalUndefined")&&typeof e>"u"?e="":e=""+e,this.client.telnet.prompt?this.client.print(`
`+e+`\x1B[0m
`,!1):this.client.print(e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"freeze":case"fr":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)this.scrollLock=!this.scrollLock,this.scrollLock?this.client.display.scrollAtBottom&&this.client.display.scrollUp():this.client.display.scrollDisplay();else if(e.length===1)e[0]==="0"||e[0]==="false"?this.scrollLock&&(this.scrollLock=!1,this.client.display.scrollDisplay()):this.scrollLock||(this.scrollLock=!0,this.client.display.scrollAtBottom&&this.client.display.scrollUp());else if(e.length>1)throw new Error("Invalid syntax use \x1B[4m"+s+"fr\x1B[0;-11;-12meeze \x1B[3mnumber\x1B[0;-11;-12m");return null;case"clr":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use "+s+"CLR");if(this.client.display.lines.length===0)return null;for(l=this.client.display.WindowSize.height+2,i=this.client.display.lines.length;i--&&l&&!this.client.display.lines[i].text.length;)l--;for(f=[];l--;)f.push(`
`);return this.client.print(f.join(""),!0),null;case"fire":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e=this.parseInline(e.join(" ")+`
`),this.ExecuteTriggers(140,e,e,!1,!1),null;case"state":case"sta":switch((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e=e.map(y=>!y||!y.length?y:y.match(/^\{.*\}$/g)?this.parseInline(y.substr(1,y.length-2)):this.parseInline(this.stripQuotes(y))),e.length){case 0:throw new Error("Invalid syntax use \x1B[4m"+s+"sta\x1B[0;-11;-12mte \x1B[3m name|pattern state profile\x1B[0;-11;-12m");case 1:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");p=this._LastTrigger,i=p.state,p.state=parseInt(e[0],10)}else{let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");p=W(this.client.profiles.items[y[d]].triggers),p=p.find(U=>U.name===e[0]||U.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(p=W(this.client.profiles.items[y[d]].triggers),p=p.find(U=>U.name===e[0]||U.pattern===e[0]),p));d++);if(!p)throw new Error("Trigger not found: "+e[0]);i=p.state,p.state=0}break;case 2:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/))throw new Error("Invalid argument to "+s+"state, first argument must be name|pattern");if(e[1].match(/^\s*?[-|+]?\d+\s*?$/)){let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");p=W(this.client.profiles.items[y[d]].triggers),p=p.find(U=>U.name===e[0]||U.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(p=W(this.client.profiles.items[y[d]].triggers),p=p.find(U=>U.name===e[0]||U.pattern===e[0]),p));d++);if(!p)throw new Error("Trigger not found: "+e[0]);i=p.state,p.state=parseInt(e[1],10)}else{if(u=e[1],this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+e[1]);if(p=W(u.triggers),p=p.find(y=>y.name===e[0]||y.pattern===e[0]),!p)throw new Error("Trigger not found: "+e[0]+" in profile: "+u.name);i=p.state,p.state=0}break;case 3:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/))throw new Error("Invalid argument to "+s+"state, first argument must be name|pattern");if(u=e[2],this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+e[2]);if(p=W(u.triggers),p=p.find(y=>y.name===e[0]||y.pattern===e[0]),!p)throw new Error("Trigger not found: "+e[0]);i=p.state,p.state=parseInt(e[1],10);break;default:throw new Error("Invalid syntax use \x1B[4m"+s+"sta\x1B[0;-11;-12mte \x1B[3m name|pattern state profile\x1B[0;-11;-12m")}if(p.state<0||p.state>p.triggers.length)throw p.state=i,new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);return l=p.fired,p.fired=!1,this.resetTriggerState(this._TriggerCache.indexOf(p),i,l),this.client.restartAlarmState(p,i,p.state),this.client.saveProfiles(),this.client.emit("item-updated","trigger",p.profile.name,p.profile.triggers.indexOf(p),p),this.client.echo("Trigger state set to "+p.state+".",-7,-8,!0,!0),null;case"set":switch((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e=e.map(y=>!y||!y.length?y:y.match(/^\{.*\}$/g)?this.parseInline(y.substr(1,y.length-2)):this.parseInline(this.stripQuotes(y))),i=0,l=!1,e.length){case 0:throw new Error("Invalid syntax use "+s+"set \x1B[3mname|pattern\x1B[0;-11;-12m state \x1B[3mvalue profile\x1B[0;-11;-12m");case 1:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");if(p=this._LastTrigger,i=parseInt(e[0],10),i<0||i>p.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);i===0?(l=p.fired,p.fired=!0):(l=p.triggers[i-1].fired,p.triggers[i-1].fired=!0)}else throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);break;case 2:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");if(p=this._LastTrigger,i=parseInt(e[0],10),i<0||i>p.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);if(e[1]!=="0"&&e[1]!=="1"&&e[1]!=="true"&&e[1]!=="false")throw new Error("Value must be 0, 1, true, or false");i===0?(l=p.fired,p.fired=e[1]==="1"||e[1]==="true"):(l=p.triggers[i-1].fired,p.triggers[i-1].fired=e[1]==="1"||e[1]==="true")}else{let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");p=W(this.client.profiles.items[y[d]].triggers),p=p.find(U=>U.name===e[0]||U.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(p=W(this.client.profiles.items[y[d]].triggers),p=p.find(U=>U.name===e[0]||U.pattern===e[0]),p));d++);if(!p)throw new Error("Trigger not found: "+e[0]);if(i=parseInt(e[1],10),i<0||i>p.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);i===0?(l=p.fired,p.fired=!0):(l=p.triggers[i-1].fired,p.triggers[i-1].fired=!0)}break;case 3:if(e[2]==="0"&&e[2]!=="1"&&e[2]!=="true"&&e[21]!=="false"){if(u=e[2],this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);if(p=W(u.triggers),p=p.find(y=>y.name===e[0]||y.pattern===e[0]),!p)throw new Error("Trigger not found: "+e[0]+" in profile: "+u.name);if(i=parseInt(e[1],10),i<0||i>p.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);i===0?(l=p.fired,p.fired=!0):(l=p.triggers[i-1].fired,p.triggers[i-1].fired=!0)}else{let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");p=W(this.client.profiles.items[y[d]].triggers),p=p.find(U=>U.name===e[0]||U.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(p=W(this.client.profiles.items[y[d]].triggers),p=p.find(U=>U.name===e[0]||U.pattern===e[0]),p));d++);if(!p)throw new Error("Trigger not found: "+e[0]);if(i=parseInt(e[1],10),i<0||i>p.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);i===0?(l=p.fired,p.fired=e[2]==="1"||e[2]==="true"):(l=p.triggers[i-1].fired,p.triggers[i-1].fired=e[2]==="1"||e[2]==="true")}break;case 4:if(u=e[2],this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);if(p=W(u.triggers),p=p.find(y=>y.name===e[0]||y.pattern===e[0]),!p)throw new Error("Trigger not found: "+e[0]+" in profile: "+u.name);if(e[2]!=="0"&&e[2]!=="1"&&e[2]!=="true"&&e[2]!=="false")throw new Error("Value must be 0, 1, true, or false");i===0?(l=p.fired,p.fired=e[2]==="1"||e[2]==="true"):(l=p.triggers[i-1].fired,p.triggers[i-1].fired=e[2]==="1"||e[2]==="true");break;default:throw new Error("Invalid syntax use "+s+"set \x1B[3mname|pattern\x1B[0;-11;-12m state \x1B[3mvalue profile\x1B[0;-11;-12m")}return this.client.saveProfiles(),this.client.emit("item-updated","trigger",p.profile.name,p.profile.triggers.indexOf(p),p),this.resetTriggerState(this._TriggerCache.indexOf(p),i,l),i===0?this.client.echo("Trigger state 0 fired state set to "+p.fired+".",-7,-8,!0,!0):(this.client.echo("Trigger state "+i+" fired state set to "+p.triggers[i-1].fired+".",-7,-8,!0,!0),p.enabled&&p.triggers[i-1].enabled&&p.triggers[i-1].type===65536&&(this._LastTriggered="",this.ExecuteTrigger(p,[],!1,this._TriggerCache.indexOf(p),0,0,p))),null;case"condition":case"cond":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),h={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+s+"cond\x1B[0;-11;-12mition name|pattern {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or \x1B[4m"+s+"cond\x1B[0;-11;-12mition {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid trigger name or pattern");if(e[0].match(/^\{.*\}$/g))h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2));else{if(h.name=this.parseInline(this.stripQuotes(e.shift())),!h.name||h.name.length===0)throw new Error("Invalid trigger name");e[0].match(/^\{.*\}$/g)&&(h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":case"reparse":case"reparsepattern":case"manual":case"skip":case"looplines":case"looppattern":case"wait":case"duration":case"withinlines":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1]))throw new Error("Invalid trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid trigger option '${y.trim()}'`)}});else throw new Error("Invalid trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":case"reparse":case"reparsepattern":case"manual":case"skip":case"looplines":case"looppattern":case"wait":case"duration":case"withinlines":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1]))throw new Error("Invalid trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid trigger option '${y.trim()}'`)}});else throw new Error("Invalid trigger options");h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))}}return this.createTrigger(h.pattern,h.commands,h.profile,h.options,h.name,!0),null;case"cr":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.sendBackground(`
`),null;case"send":case"se":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"se\x1B[0;-11;-12mnd file \x1B[3mprefix suffix\x1B[0;-11;-12m or \x1B[4m"+s+"se\x1B[0;-11;-12mnd text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"se\x1B[0;-11;-12mnd file \x1B[3mprefix suffix\x1B[0;-11;-12m or \x1B[4m"+s+"se\x1B[0;-11;-12mnd text");return this.client.sendBackground(this.stripQuotes(e),this.client.getOption("allowCommentsFromCommand")),null;case"sendfile":case"sendf":return((y,d)=>{Ve().then(v=>{Ye(v[0]).then(U=>{(this.client.getOption("echo")&4)===4&&this.client.echo(d,-3,-4,!0,!0),E="",l="",y.length>1&&(E=this.stripQuotes(this.parseInline(y[0]))),y.length>2&&(l=this.stripQuotes(this.parseInline(y[1]))),r=U.split(/\r?\n/),r.forEach(q=>{this.client.sendBackground(E+q+l,null,this.client.getOption("allowCommentsFromCommand"))})}).catch(this.client.error)}).catch(()=>{})})(e,n),null;case"sendfileraw":case"sendfiler":return((y,d)=>{Ve().then(v=>{Ye(v[0]).then(U=>{(this.client.getOption("echo")&4)===4&&this.client.echo(d,-3,-4,!0,!0),E="",l="",y.length>1&&(E=this.stripQuotes(this.parseInline(y[0]))),y.length>2&&(l=this.stripQuotes(this.parseInline(y[1]))),r=U.split(/\r?\n/),r.forEach(q=>{this.client.sendRaw(E+q+l)})}).catch(this.client.error)}).catch(()=>{})})(e,n),null;case"sendraw":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+s+"sendraw text or "+s+"sendraw file \x1B[3mprefix suffix\x1B[0;-11;-12m");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use "+s+"sendraw text or "+s+"sendraw file \x1B[3mprefix suffix\x1B[0;-11;-12m");return e.endsWith(`
`)||(e=e+`
`),this.client.sendRaw(e),null;case"sendprompt":case"sendp":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"sendp\x1B[0;-11;-12mrompt text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+s+"sendp\x1B[0;-11;-12mrompt text");return this.client.sendRaw(e),null;case"character":case"char":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),this.client.sendRaw(window.$character||""),null;case"speak":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+s+"speak text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use "+s+"speak text");return e=this.stripQuotes(this.parseInline(e)),e.length!==0&&window.speechSynthesis.speak(new SpeechSynthesisUtterance(e)),null;case"speakstop":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+s+"speakstop");return window.speechSynthesis.cancel(),null;case"speakpause":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+s+"speakpause");return window.speechSynthesis.pause(),null;case"speakresume":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+s+"speakresume");return window.speechSynthesis.resume(),null;case"comment":case"comm":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),null;case"noop":case"no":return(this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length&&this.parseInline(e.join(" ")),null;case"temp":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),h={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use "+s+"temp name {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or "+s+"temp {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid temporary trigger or pattern");if(e[0].match(/^\{.*\}$/g))h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2));else{if(h.name=this.parseInline(this.stripQuotes(e.shift())),!h.name||h.name.length===0)throw new Error("Invalid temporary trigger name");e[0].match(/^\{.*\}$/g)&&(h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid temporary trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid temporary trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid temporary trigger option '${y.trim()}'`)}});else throw new Error("Invalid temporary trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid temporary trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid temporary trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid temporary trigger option '${y.trim()}'`)}});else throw new Error("Invalid temporary trigger options");h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))}}return h.options.temporary=!0,this.createTrigger(h.pattern,h.commands,h.profile,h.options,h.name),null;case"wrap":case"wr":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e=e.filter(y=>y),e.length>1)throw new Error("Invalid syntax use \x1B[4m"+s+"wr\x1B[0;-11;-12map or \x1B[4m"+s+"wr\x1B[0;-11;-12map number");if(e.length===0)this.client.setOption("display.wordWrap",!this.client.getOption("display.wordWrap")),this.client.display.wordWrap=this.client.getOption("display.wordWrap");else{if(l=parseInt(this.parseInline(e[0]),10),isNaN(l))throw new Error("Invalid number '"+l+"' for wrap");if(l<0)throw new Error("Must be greater then or equal to zero for wrap");this.client.setOption("display.wordWrap",!0),this.client.setOption("display.wordWrap",l),this.client.display.wordWrap=!0,this.client.display.wrapAt=l}return null;case"prompt":case"pr":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+s+"pr\x1B[0;-11;-12mompt variable \x1B[3mmessage defaultValue mask\x1B[0;-11;-12m");if(l=e.shift(),l.match(/^\{.*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),!me(l))throw new Error("Invalid variable name");return e=e.map(y=>this.parseInline(this.stripQuotes(y))),e.length===3&&e[2]&&e[2].toLowerCase()==="true"&&(e[2]=!0),e=window.prompt(...e),e?.match(/^\s*?[-|+]?\d+\s*?$/)?this.client.variables[l]=parseInt(e,10):e?.match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?this.client.variables[l]=parseFloat(e):e==="true"?this.client.variables[l]=!0:e==="false"?this.client.variables[l]=!1:this.client.variables[l]=e,null;case"setmap":if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+s+"setmap file \x1B[3msetCharacter\x1B[0;-11;-12m");if(f=this.stripQuotes(this.parseInline(e.shift()))||"",!f||!f.length)throw new Error("Empty file\x1B[0;-11;-12m");return e.length>1?E=this.stripQuotes(this.parseInline(e.join(" "))).toLocaleLowerCase().trim():E="",this.emit("setmap",f,E==="true"||E==="yes",!0),null}if(t.match(/^[-|+]?\d+$/)){if((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),l=parseInt(t,10),e.length===0)throw new Error("Invalid syntax use "+s+"nnn commands");return e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),l<1?this.executeForLoop(-l+1,1,e):this.executeForLoop(0,l,e)}let x={name:t,args:e,raw:n,handled:!1,return:null};return this.client.emit("function",x),x.handled?((this.client.getOption("echo")&4)===4&&this.client.echo(n,-3,-4,!0,!0),x.return):x.raw.startsWith(s)?s+this.parseOutgoing(x.raw.substr(1),null,null,null,!0):this.parseOutgoing(x.raw+`
`,null,null,null,!0)}executeForLoop(t,e,n){let s=[],i;if(t>e)for(i=t-1;i>=e;i--){this.loops.push(i);try{let o=this.parseOutgoing(n);if(o!=null&&o.length>0&&s.push(o),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}catch(o){throw o}finally{this.loops.pop()}}else for(i=t;i<e;i++){this.loops.push(i+1);try{let o=this.parseOutgoing(n);if(o!=null&&o.length>0&&s.push(o),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}catch(o){throw o}finally{this.loops.pop()}}return s.length>0?s.map(o=>o.trim()).join(`
`):null}parseInline(t){return this.parseOutgoing(t,!1,null,!1,!0)}parseOutgoing(t,e,n,s,i,o){let r=t.length;if(!this.enableParsing||t==null||r===0)return t;let a="",l="",f,u=0,b=this.client.aliases,h=this.client.getOption("commandStackingChar"),E=this.client.getOption("speedpathsChar"),S=this.client.getOption("enableSpeedpaths"),p=this.client.getOption("enableCommands"),g=this.client.getOption("commandChar"),C=this.client.getOption("allowEscape"),P=this.client.getOption("escapeChar"),x=this.client.getOption("verbatimChar"),G=this.client.getOption("enableVerbatim"),M=this.client.getOption("enableDoubleParameterEscaping"),_=this.client.getOption("parametersChar"),y=this.client.getOption("enableParameters"),d=this.client.getOption("nParametersChar"),v=this.client.getOption("enableNParameters"),U=this.client.getOption("allowEval"),q=this.client.getOption("ignoreEvalUndefined"),re=this.client.getOption("enableInlineComments")&&!o,ie=this.client.getOption("enableBlockComments")&&!o,Y=this.client.getOption("inlineCommentString").split(""),T=this.client.getOption("blockCommentString").split(""),L=this.client.getOption("ignoreInputLeadingWhitespace"),F="",R=[],k="",D=!0,O="",j,w,Q,A=0,I,N,X=!0,J=!1,ae=!1,ne=!1,se=0,be=this.client.getOption("parseDoubleQuotes"),he=this.client.getOption("parseSingleQuotes");for(e==null?e=b.length>0:e=e&&b.length>0,h.length===0?n=!1:n==null?n=this.client.getOption("commandStacking"):n=n&&this.client.getOption("commandStacking"),A=0;A<r;A++)switch(w=t.charAt(A),u){case 1:C&&w===P?u=27:(w==='"'&&be&&(u=0),e&&D?l+=w:a+=w),X=!1;break;case 27:u=1,w!=='"'&&w!==P?(A--,e&&D?l+=P:a+=P):e&&D?l+=w:a+=w;break;case 2:C&&w===P?u=27:(w==="'"&&he&&(u=0),e&&D?l+=w:a+=w),X=!1;break;case 28:u=2,w!=="'"&&w!==P?(A--,e&&D?l+=P:a+=P):e&&D?l+=w:a+=w;break;case 3:if(w==='"'&&be)k+=w,u=4,X=!1;else if(w==="'"&&he)k+=w,u=5,X=!1;else if(C&&w===P)u=17,X=!1;else if(A===r-1||w===`
`||n&&w===h){for(w===`
`||n&&w===h||(k+=w),k.length>0&&R.push(this.parseInline(k)),Q=f.length,j=0;j<Q;j++){if(a=this.ExecuteAlias(f[j],R),typeof a=="number")return a>=0&&this.executeWait(t.substr(A+1),a,e,n,s,i,o),O.length===0?null:O;if(a!==null&&(O+=a),a="",!j.multi)break;if(this.stack.continue||this.stack.break)return O.length===0?null:O}l="",u=0,f=null,X=!0}else w===" "?(R.push(this.parseInline(k)),k="",X=!1):(k+=w,X=!1);break;case 4:w==='"'&&(u=3),k+=w,X=!1;break;case 5:w==="'"&&(u=3),k+=w,X=!1;break;case 17:u=3,w===P||n&&w===h||G&&w===x||S&&w===E||p&&w===g||M&&w===_||v&&w===d?k+=w:re&&w==Y[0]||ie&&w==T[0]?N=w:`"'{`.indexOf(w)!==-1?k+=w:k+=P+w;break;case 6:if(C&&w===P)u=18,X=!1;else if(w===`
`||n&&w===h){if(u=0,a=this.ProcessPath(a),a!==null&&(O+=a),a="",X=!0,this.stack.continue||this.stack.break)return O.length===0?null:O}else A===1&&w===E?(u=0,A--,X=!1):(a+=w,X=!1);break;case 18:u=6,w===P||n&&w===h||G&&w===x||S&&w===E||p&&w===g||M&&w===_||v&&w===d?a+=w:re&&w==Y[0]||ie&&w==T[0]?N=w:`"'{`.indexOf(w)!==-1?a+=w:a+=P+w;break;case 7:if(w==="{")X=!1,a+=w,se++;else if(w==="}")X=!1,a+=w,se--;else if(se===0&&C&&w===P)u=19,X=!1;else if(se===0&&(w===`
`||n&&w===h)){if(u=0,a=this.executeScript(g+a),typeof a=="number")return a>=0&&this.executeWait(t.substr(A+1),a,e,n,s,i,o),O.length===0?null:O;if(a!==null&&(O+=F+a+`
`),this.stack.continue||this.stack.break)return O.length===0?null:O;a="",X=!0}else a+=w,X=!1;break;case 19:u=7,a+=P+w;break;case 8:if(w==="{"&&k.length===0){u=9;continue}switch(w){case _:k.length===0&&(e&&D?l+=_:a+=_,u=0,M||A--);break;case"*":if(k.length===0){this.stack.args?(e&&D?l+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):e&&D?l+=_+"*":a+=_+"*",u=0;break}case"-":if(k.length===0){J=!0;break}else if(ae&&k.length==1){J=!0;break}else ne=!0;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":if(!ne){k+=w;break}case"x":if(!ne&&k.length===0){ae=!0;break}default:if(this.stack.args&&k.length>0)I=parseInt(k,10),ae?J&&this.stack.args.indices&&I<this.stack.args.length?I=this.stack.indices.slice(I).map(z=>z?z[0]+" "+z[1]:"0 0").join(" "):this.stack.args.indices&&I<this.stack.args.length?I=this.stack.args.indices[I]?this.stack.args.indices[I][0]+" "+this.stack.args.indices[I][1]:"0 0":J?I=_+"x-"+I:I=_+"x"+I:(J&&I<this.stack.args.length?I=this.stack.args.slice(k).join(" "):I<this.stack.args.length?I=this.stack.args[I]:J?I=_+"-"+I:I=_+I,J?this.stack.used=this.stack.args.length:k>this.stack.used&&(this.stack.used=parseInt(k,10))),e&&D?l+=I:a+=I,A--;else{if(k.length===0&&this.loops.length>0&&(I=w.charCodeAt(0)-105,I>=0&&I<18&&I<this.loops.length)){e&&D?l+=this.loops[I]:a+=this.loops[I],u=0;break}e&&D?(l+=_,J&&(l+="-"),ae&&(l+="x")):(a+=_,J&&(a+="-"),ae&&(a+="x")),A=A-k.length-1}u=0,k="";break}break;case 26:w.match(/[^a-zA-Z0-9_]/g)?(this.stack.named.hasOwnProperty(k)?e&&D?l+=this.stack.named[k]:a+=this.stack.named[k]:e&&D?l+=_+k:a+=_+k,A--,u=0,k=""):k+=w;break;case 9:w==="}"&&se===0?(k==="i"?N=this.loops[0]:k==="repeatnum"?N=this.repeatnum:this.stack.args&&k==="*"?(N=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):this.stack.named&&this.stack.named.hasOwnProperty(k)?N=this.stack.named[k]:this.stack.args&&!isNaN(k)?(I=parseInt(k,10),I<0?-I>=this.stack.args.length?U?N=I:(N=_,A=A-I.length-2):(N=this.stack.args.slice(I).join(" "),this.stack.used=this.stack.args.length):I<this.stack.args.length?(N=this.stack.args[I],k>this.stack.used&&(this.stack.used=I)):U?N=I:(N=_,A=A-k.length-2)):this.stack.args&&this.stack.args.indices&&k.match(/^x[-|+]?\d+$/)?(I=parseInt(k.substring(1),10),I<0?-I>=this.stack.args.length?(N=_,A=A-I.length-2):N=this.stack.indices.slice(I).map(z=>z?z[0]+" "+z[1]:"0 0").join(" "):I<this.stack.args.length?N=this.stack.args.indices[I]?this.stack.args.indices[I][0]+" "+this.stack.args.indices[I][1]:"0 0":(N=_,A=A-k.length-2)):(I=this.parseVariable(k),I!=null?N=I:U?(N=this.evaluate(this.parseInline(k)),q&&typeof N>"u"?N=null:N=""+N):(N=_,A=A-k.length-2)),N!=null&&e&&D?l+=N:N!=null&&(a+=N),u=0,k=""):w==="{"?(se++,k+=w):(w==="}"&&se--,k+=w);break;case 11:w==="{"?u=12:w.match(/[^a-zA-Z_$]/g)?(u=0,A--,e&&D?l+=d:a+=d):(k=w,u=14);break;case 14:w.match(/[^a-zA-Z0-9_]/g)?(this.stack.named&&this.stack.named.hasOwnProperty(k)?e&&D?l+=this.stack.named[k]:a+=this.stack.named[k]:this.client.variables.hasOwnProperty(k)?e&&D?l+=this.client.variables[k]:a+=this.client.variables[k]:e&&D?l+=d+k:a+=d+k,A--,u=0,k=""):k+=w;break;case 12:w==="}"&&se===0?(N=null,k==="i"?N=this.loops[0]:k==="repeatnum"?N=this.repeatnum:this.stack.args&&k==="*"?(N=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):this.stack.named&&this.stack.named.hasOwnProperty(k)?N=this.stack.named[k]:this.stack.args&&!isNaN(k)?(I=parseInt(k,10),I<0?-I>=this.stack.args.length?U?N=I:(N=d,A=A-k.length-2):(N=this.stack.args.slice(I).join(" "),this.stack.used=this.stack.args.length):I<this.stack.args.length?(N=this.stack.args[I],I>this.stack.used&&(this.stack.used=I)):U?N=I:(N=d,A=A-k.length-2)):this.stack.args&&this.stack.args.indices&&k.match(/^x[-|+]?\d+$/)?(I=parseInt(k.substring(1),10),I<0?-I>=this.stack.args.length?(N=d,A=A-k.length-2):N=this.stack.indices.slice(I).map(z=>z?z[0]+" "+z[1]:"0 0").join(" "):I<this.stack.args.length?N=this.stack.args.indices[I]?this.stack.args.indices[I][0]+" "+this.stack.args.indices[I][1]:"0 0":(N=d,A=A-k.length-2)):(w=this.parseVariable(k),w!=null?N=w:U?(N=this.evaluate(this.parseInline(k)),q&&typeof N>"u"?N=null:N=""+N):(N=d,A=A-k.length-2)),N!=null&&e&&D?l+=N:N!=null&&(a+=N),u=0,k=""):w==="{"?(se++,k+=w):(w==="}"&&se--,k+=w);break;case 15:w===P||n&&w===h||G&&w===x||S&&w===E||p&&w===g||M&&w===_||v&&w===d||re&&w==Y[0]||ie&&w==T[0]||`"'{`.indexOf(w)!==-1?N=w:N=P+w,e&&D?l+=N:a+=N,u=0;break;case 16:w===`
`?(u=0,O+=a+w,a="",X=!0):(a+=w,X=!1);break;case 20:re&&w===Y[1]?u=22:ie&&w===T[1]?u=24:(u=0,e&&D?l+=Y[0]:a+=Y[0],A--);break;case 21:w===Y[1]?u=22:(u=0,e&&D?l+=Y[0]:a+=Y[0],A--);break;case 23:ie&&w===T[1]?u=25:(u=0,e&&D?l+=T[0]:a+=T[0],A--);break;case 22:w===`
`&&(u=0,X?(l="",D=!0,X=!0):A--);break;case 24:T.length===1?w===T[0]&&(u=0):w===T[1]&&(u=25);break;case 25:w===T[0]?u=0:u=24;break;default:if((re||ie)&&w===Y[0]&&w===T[0]){re&&Y.length===1?u=22:ie&&T.length===1?u=24:u=20;continue}else if(re&&w===Y[0]){Y.length===1?u=22:u=21;continue}else if(ie&&w===T[0]){T.length===1?u=24:u=23;continue}else if(C&&w===P){u=15,X=!1;continue}else if(y&&w===_)u=8,J=!1,ae=!1,ne=!1,k="",X=!1;else if(v&&w===d)u=11,J=!1,ae=!1,ne=!1,k="",X=!1;else if(!i&&p&&X&&w===g)u=7,X=!1,l.length?(F=l,l=""):(F=a||"",a="");else if(G&&X&&w===x)u=16,X=!1;else if(S&&X&&w===E)u=6,X=!1;else if(w==='"'&&be)e&&D?l+=w:a+=w,u=1,X=!1;else if(w==="'"&&he)e&&D?l+=w:a+=w,u=2,X=!1;else if(X&&L&&(w===" "||w==="	"||w==="\f"||w==="\r"||w==="\v"||w===" "||w==="\xA0"||w==="\u1680"||w==="\u2000-"||w==="\u200A"||w==="\u2028"||w==="\u2029"||w==="\u202F"||w==="\u205F"||w==="\u3000"||w==="\uFEFF"))e&&D?l+=w:a+=w;else if(e&&D&&w===" ")f=Ce(b,"pattern",L?l.trimStart():l),f.length>0?(u=3,R.length=0,k="",R.push(L?l.trimStart():l)):(a+=l+" ",l="",f=null),D=!1,X=!1;else if(w===`
`||n&&w===h){if(e&&D&&l.length>0)if(f=Ce(b,"pattern",L?l.trimStart():l),f.length>0){for(R.push(L?l.trimStart():l),Q=f.length,j=0;j<Q;j++){if(a=this.ExecuteAlias(f[j],R),typeof a=="number")return a>=0&&this.executeWait(t.substr(A+1),a,e,n,s,i,o),O.length===0?null:O;if(a!==null&&(O+=a),!j.multi)break;if(this.stack.continue||this.stack.break)return O.length===0?null:O}a="",R.length=0,k=""}else{if(a=this.ExecuteTriggers(17,l,l,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(A+1),a,e,n,s,i,o),O.length===0?null:O;a!==null&&(O+=a+`
`),a="",f=null}else{if(a=this.ExecuteTriggers(17,a,a,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(A+1),a,e,n,s,i,o),O.length===0?null:O;a!==null&&(O+=a+`
`),a=""}if(this.stack.continue||this.stack.break)return O.length===0?null:O;l="",D=!0,X=!0}else e&&D?(l+=w,X=!1):(a+=w,X=!1);break}if(u===15?a+=P:u===14&&k.length>0?this.stack.named&&this.stack.named[k]?a+=this.stack.named[k]:this.client.variables.hasOwnProperty(k)?a+=this.client.variables[k]:(k=this.parseInline(k),a+=d,k!=null&&(a+=k)):u===8&&k.length>0?this.stack.args?(k=parseInt(k,10),ae&&this.stack.args.indices&&k<this.stack.args.length?a+=this.stack.args.indices[k]?this.stack.args.indices[k][0]+" "+this.stack.args.indices[k][1]:"0 0":(J&&k<this.stack.args.length?a+=this.stack.args.slice(k).join(" "):k<this.stack.args.length&&(a+=this.stack.args[k]),J?this.stack.used=this.stack.args.length:k>this.stack.used&&(this.stack.used=k))):(k=this.parseInline(k),a+=_,J&&(a+="-"),ae&&(a+="x"),k!=null&&(a+=k)):u===9?(k=this.parseInline(k),a+=_+"{",k!=null&&(a+=k)):u===11&&k.length>0?this.stack.named?this.stack.named.hasOwnProperty(k)?a+=this.stack.named[k]:(k=this.parseInline(k),a+=d,k!=null&&(a+=k)):(k=this.parseInline(k),a+=d,k!=null&&(a+=k)):u===12?(k=this.parseInline(k),a+=`${d}{`,k!=null&&(a+=k)):u===6?(a=this.ProcessPath(a),a!==null&&(O+=a),a=""):u===20||u===21?(a+=Y[0],A--):u===23&&(a+=T[0],A--),!i&&u===7){if(a=this.executeScript(g+a),typeof a=="number")return a>=0&&this.executeWait(t.substr(A+1),a,e,n,s,i,o),O.length===0?null:O;if(a!==null){if(s&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let z=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),z=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,z&&(a+=`
`)}O+=F+a}else if(O.length===0)return null;if(this.stack.continue||this.stack.break)return O.length===0?null:O}else if(u===16){if(s&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let z=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),z=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,z&&(a+=`
`)}O+=a}else if(l.length>0&&e&&D){if(s&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let z=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),z=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,z&&(a+=`
`)}if(a.length>0&&(l+=a),f=Ce(b,"pattern",L?l.trimStart():l),f.length>0)for(R.push(L?l.trimStart():l),Q=f.length,j=0;j<Q;j++){if(a=this.ExecuteAlias(f[j],R),typeof a=="number")return a>=0&&this.executeWait(t.substr(A+1),a,e,n,s,i,o),O.length===0?null:O;if(a!==null)O+=a;else if(O.length===0)return null;if(this.stack.continue||this.stack.break)return O;if(!j.multi)break}else{if(a=this.ExecuteTriggers(17,l,l,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(A+1),a,e,n,s,i,o),O.length===0?null:O;if(a!==null)O+=a;else if(O.length===0)return null;if(this.stack.continue||this.stack.break)return O}f=null}else if(l.length>0){if(a.length>0&&(l+=a),a=this.ExecuteTriggers(17,l,l,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(A+1),a,e,n,s,i,o),O.length===0?null:O;if(a!==null){if(s&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let z=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),z=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,z&&(a+=`
`)}O+=a}else if(O.length===0)return null;if(this.stack.continue||this.stack.break)return O.length===0?null:O}else if(a.length>0){if(a=this.ExecuteTriggers(17,a,a,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(A+1),a,e,n,s,i,o),O.length===0?null:O;if(a!==null){if(s&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let z=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),z=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),z&&(a+=`
`)}O+=a}else if(O.length===0)return null;if(this.stack.continue||this.stack.break)return O.length===0?null:O}return R.length=0,R=null,k=null,l=null,O}parseVariable(t){let e;switch(t){case"esc":return"\x1B";case"cr":return`
`;case"lf":return"\r";case"crlf":return`\r
`;case"copied":return window.$copied;case"copied.lower":return window.$copied.toLowerCase();case"copied.upper":return window.$copied.toUpperCase();case"copied.proper":return Je(window.$copied);case"i":return this.loops[0];case"repeatnum":return this.vStack.$repeatnum||this.repeatnum;case"character":return window.$character;case"character.lower":return window.$character.toLowerCase();case"character.upper":return window.$character.toUpperCase();case"character.proper":return Je(window.$character);case"selected":case"selectedurl":case"selectedline":case"selectedword":case"selurl":case"selline":case"selword":case"action":case"trigger":return this.vStack["$"+t]||window["$"+t]||"";case"selected.lower":case"selectedurl.lower":case"selectedline.lower":case"selectedword.lower":case"selurl.lower":case"selline.lower":case"selword.lower":return(this.vStack["$"+t.substr(0,t.length-6)]||window["$"+t.substr(0,t.length-6)]||"").toLowerCase();case"selected.upper":case"selectedurl.upper":case"selectedline.upper":case"selectedword.upper":case"selurl.upper":case"selline.upper":case"selword.upper":return(this.vStack["$"+t.substr(0,t.length-6)]||window["$"+t.substr(0,t.length-6)]||"").toUpperCase();case"selected.proper":case"selectedurl.proper":case"selectedline.proper":case"selectedword.proper":case"selurl.proper":case"selline.proper":case"selword.proper":return Je(this.vStack["$"+t.substr(0,t.length-7)]||window["$"+t.substr(0,t.length-7)]);case"random":return We().randomInt(0,100)}if(Ze.indexOf(t)!==-1)return this.vStack["$"+t]||window["$"+t]||"";if(this.loops.length&&t.length===1){let b=t.charCodeAt(0)-105;if(b>=0&&b<18&&b<this.loops.length)return this.loops[b]}let s=new RegExp("^([a-zA-Z]+)\\((.*)\\)$","g").exec(t);if(!s||!s.length){let b={raw:t,name:t,args:[],handled:!1,return:null};return this.client.emit("variable",b),b.handled?b.return:null}let i,o,r,a,l,f=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";switch(s[1]){case"time":return moment?s[2]&&s[2].length>0?moment().format(this.stripQuotes(this.parseInline(s[2]))):moment().format():new Date().toISOString();case"clip":return s[2]&&s[2].length>0?(this.client.writeClipboard(this.stripQuotes(this.parseInline(s[2]))),null):this.client.readClipboard();case"lower":return this.stripQuotes(this.parseInline(s[2]).toLowerCase());case"upper":return this.stripQuotes(this.parseInline(s[2]).toUpperCase());case"proper":return Je(this.stripQuotes(this.parseInline(s[2])));case"eval":return r=this.evaluate(this.parseInline(s[2])),this.client.getOption("ignoreEvalUndefined")&&typeof r>"u"?null:""+r;case"dice":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Invalid dice");if(r.length===1){if(s=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(r[0]),!s||s.length<3)return null;e=parseInt(s[1]),i=s[2],s.length>3&&(o=s[3])}else if(r.length<4)e=parseInt(r[0]),i=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for dice");i==="F"||i==="f"?i="F":i!=="%"&&(i=parseInt(i));let b=0;for(let S=0;S<e;S++)i==="F"||i==="f"?b+=Rt():i==="%"?b+=~~(Math.random()*100)+1:b+=~~(Math.random()*i)+1;return i==="%"&&(b/=100),o?this.evaluate(b+o):""+b;case"diceavg":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Invalid dice for diceavg");if(r.length===1){if(s=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!s||s.length<3)return null;e=parseInt(s[1]),i=s[2],s.length>3&&(o=s[3])}else if(r.length<4)e=parseInt(r[0]),i=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for diceavg");return a=1,i==="F"||i==="f"?(a=-1,l=1):i==="%"?(a=0,l=1):l=parseInt(i),o?this.evaluate((a+l)/2*e+o):""+(a+l)/2*e;case"dicemin":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Invalid dice for dicemin");if(r.length===1){if(s=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!s||s.length<3)return null;e=parseInt(s[1]),i=s[2],s.length>3&&(o=s[3])}else if(r.length<4)e=parseInt(r[0]),i=r[1].trim(),r.length>2&&(o=r[2]);else throw new Error("Too many arguments for dicemin");return a=1,i==="F"||i==="f"?a=-1:i==="%"&&(a=0),o?this.evaluate(a*e+o):""+a*e;case"dicemax":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Invalid dice for dicemax");if(r.length===1){if(s=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!s||s.length<3)return null;e=parseInt(s[1]),i=s[2],s.length>3&&(o=s[3])}else if(r.length<4)e=parseInt(r[0]),i=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for dicemax");return i==="F"||i==="f"||i==="%"?l=1:l=parseInt(i),o?this.evaluate(l*e+o):""+l*e;case"zdicedev":case"dicedev":let h=s[1];if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Invalid dice for "+h);if(r.length===1){if(s=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!s||s.length<3)return null;e=parseInt(s[1]),i=s[2],s.length>3&&(o=s[3])}else if(r.length<4)e=parseInt(r[0]),i=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for "+h);return i==="F"||i==="f"?l=6:i==="%"?l=1:l=parseInt(i),h==="zdicedev"&&l--,o?this.evaluate(Math.sqrt((l*l-1)/12*e)+o):""+Math.sqrt((l*l-1)/12*e);case"color":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for color");if(r.length===1){if(r[0]==="bold")return"370";if(e=V(r[0]),e===-1)throw new Error("Invalid fore color");return e.toString()}else if(r.length===2){if(r[0]==="bold")e=370;else{if(e=V(r[0]),e===-1)throw new Error("Invalid fore color");if(r[1]==="bold")return(e*10).toString()}if(i=e.toString(),e=V(r[1],!0),e===-1)throw new Error("Invalid back color");return i+","+e.toString()}else if(r.length===3){if(r[0]==="bold"&&(r.shift(),r.push("bold")),r[2]!=="bold")throw new Error("Only bold is supported as third argument for color");if(e=V(r[0]),e===-1)throw new Error("Invalid fore color");if(i=(e*10).toString(),e=V(r[1],!0),e===-1)throw new Error("Invalid back color");return i+","+e.toString()}throw new Error("Too many arguments");case"zcolor":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for zcolor");if(r.length>1)throw new Error("Too many arguments for zcolor");return yt(parseInt(r[0],10));case"ansi":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for ansi");for(e=r.length,o=[],a={},i=0;i<e;i++)if(r[i].trim()==="current")o.push(r[i].trim());else{if(l=ge(r[i].trim()),l===-1)throw new Error("Invalid color or style for ansi");l>=0&&l<30?a[l]=1:o.push(r[i])}if(o.length>2)throw new Error("Too many colors for ansi");if(o.length>1&&(o[1]==="current"?o[1]="":o[1]=ge(o[1],!0)),o.length>0&&(a[1]&&o[0]==="white"||o[0]==="current"?o[0]="":o[0]=ge(o[0])),a=[...Object.keys(a),...o],!a.length)throw new Error("Invalid colors or styles for ansi");return a=a.filter(S=>S!==""),`\x1B[${a.join(";")}m`;case"random":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Invalid random");if(r.length===1)return We().randomInt(0,parseInt(r[0],10)+1);if(r.length===2)return We().randomInt(parseInt(r[0],10),parseInt(r[1],10)+1);throw new Error("Too many arguments for random");case"case":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for case");return e=this.evaluate(this.parseInline(r[0])),typeof e!="number"?"":e>0&&e<r.length?this.stripQuotes(r[e]):"";case"switch":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for switch");if(r.length%2===1)throw new Error("All expressions must have a value for switch");for(i=r.length,e=0;e<i;e+=2)if(this.evaluate(r[e]))return this.stripQuotes(r[e+1]);return"";case"if":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length<3)throw new Error("Missing arguments for if");if(r.length!==3)throw new Error("Too many arguments for if");return this.evaluate(r[0])?this.stripQuotes(r[1].trim()):this.stripQuotes(r[2].trim());case"ascii":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for ascii");if(r.length>1)throw new Error("Too many arguments for ascii");if(r[0].trim().length===0)throw new Error("Invalid argument, empty string for ascii");return r[0].trim().charCodeAt(0);case"char":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for char");if(r.length>1)throw new Error("Too many arguments for char");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for char");return String.fromCharCode(e);case"begins":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length<2)throw new Error("Missing arguments for begins");if(r.length>2)throw new Error("Too many arguments for begins");return this.stripQuotes(r[0]).startsWith(this.stripQuotes(r[1]));case"ends":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length<2)throw new Error("Missing arguments for ends");if(r.length>2)throw new Error("Too many arguments for ends");return this.stripQuotes(r[0]).endsWith(this.stripQuotes(r[1]));case"len":return this.stripQuotes(this.parseInline(s[2])).length;case"stripansi":let E=new RegExp("[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))","g");return this.stripQuotes(this.parseInline(s[2])).replace(E,"");case"pos":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length<2)throw new Error("Missing arguments for pos");if(r.length>2)throw new Error("Too many arguments for pos");return this.stripQuotes(r[1]).indexOf(this.stripQuotes(r[0]))+1;case"ipos":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length<2)throw new Error("Missing arguments for ipos");if(r.length>2)throw new Error("Too many arguments for ipos");return this.stripQuotes(r[1]).toLowerCase().indexOf(this.stripQuotes(r[0]).toLowerCase())+1;case"regex":if(r=this.splitByQuotes(s[2],","),r.length<2)throw new Error("Missing arguments for regex");if(e=new RegExp(this.stripQuotes(r[1]),"gd"),e=e.exec(this.stripQuotes(this.parseInline(r[0]))),r.shift(),r.shift(),e==null||e.length===0)return 0;if(r.length){for(i=1;i<e.length&&r.length;i++)this.client.variables[this.stripQuotes(this.parseInline(r[0]))]=e[i],r.shift();r.length&&(this.client.variables[this.stripQuotes(this.parseInline(r[0]))]=e[0].length)}return e.indices[0]?e.indices[0][0]+1:1;case"trim":return this.stripQuotes(this.parseInline(s[2])).trim();case"trimleft":return this.stripQuotes(this.parseInline(s[2])).trimLeft();case"trimright":return this.stripQuotes(this.parseInline(s[2])).trimRight();case"bitand":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for bitand");if(r.length!==2)throw new Error("Too many arguments for bitand");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitand");if(i=parseInt(r[1],10),isNaN(i))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitand");return e&i;case"bitnot":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for bitnot");if(r.length!==1)throw new Error("Too many arguments for bitnot");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitnot");return~e;case"bitor":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for bitor");if(r.length!==2)throw new Error("Too many arguments for bitor");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitor");if(i=parseInt(r[1],10),isNaN(i))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitor");return e|i;case"bitset":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for bitset");if(r.length>3)throw new Error("Too many arguments for bitset");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitset");if(i=parseInt(r[1],10),isNaN(i))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitset");if(i--,o=1,r.length===3&&(o=parseInt(r[2],10),isNaN(o)))throw new Error("Invalid argument '"+r[2]+"' must be a number for bitset");return e&~(1<<i)|(o?1:0)<<i;case"bitshift":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for bitshift");if(r.length!==2)throw new Error("Too many arguments for bitshift");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitshift");if(i=parseInt(r[1],10),isNaN(i))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitshift");return i<0?e>>-i:e<<i;case"bittest":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for bittest");if(r.length!==2)throw new Error("Too many arguments for bittest");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bittest");if(i=parseInt(r[1],10),isNaN(i))throw new Error("Invalid argument '"+r[1]+"' must be a number for bittest");return i--,(e>>i)%2!=0?1:0;case"bitxor":if(r=this.parseInline(s[2]).split(","),r.length===0)throw new Error("Missing arguments for bitxor");if(r.length!==2)throw new Error("Too many arguments for bitxor");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitxor");if(i=parseInt(r[1],10),isNaN(i))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitxor");return e^i;case"number":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for number");if(r.length>1)throw new Error("Too many arguments for number");return r[0]=this.stripQuotes(r[0],!0),r[0].match(/^\s*?[-|+]?\d+\s*?$/)?parseInt(r[0],10):r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(r[0]):r[0]==="true"?1:(r[0]==="false",0);case"isfloat":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for isfloat");if(r.length>1)throw new Error("Too many arguments for isfloat");return r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0;case"isnumber":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for isnumber");if(r.length>1)throw new Error("Too many arguments for isnumber");return r[0].match(/^\s*?[-|+]?\d+\s*?$/)||r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0;case"string":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for string");if(r.length>1)throw new Error("Too many arguments for string");return`"${this.stripQuotes(r[0]),!0}"`;case"float":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for float");if(r.length>1)throw new Error("Too many arguments for float");return r[0]=this.stripQuotes(r[0],!0),r[0].match(/^\s*?[-|+]?\d+\s*?$/)||r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(r[0]):r[0]==="true"?1:(r[0]==="false",0);case"isdefined":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for isdefined");if(r.length>1)throw new Error("Too many arguments for isdefined");return r[0]=this.stripQuotes(r[0],!0),this.client.variables.hasOwnProperty(r[0])?1:0;case"defined":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for defined");if(r.length===1){r[0]=this.stripQuotes(r[0],!0);let S=this.client.profiles.keys,p=0,g=S.length;if(g===0)return 0;for(;p<g;p++)if(i=W(this.client.profiles.items[S[p]].aliases),i=i.find(C=>C.pattern===r[0]),i||(i=W(this.client.profiles.items[S[p]].triggers),i=i.find(C=>C.pattern===r[0]||C.name===r[0]),i)||(i=W(this.client.profiles.items[S[p]].macros),i=i.find(C=>Ue(C).toLowerCase()===r[0].toLowerCase()||C.name===r[0]),i)||(i=W(this.client.profiles.items[S[p]].aliases),i=i.find(C=>C.caption===r[0]||C.name===r[0]),i))return 1;return this.client.variables.hasOwnProperty(r[0])}else if(r.length===2){r[0]=this.stripQuotes(r[0],!0),r[1]=this.stripQuotes(r[1],!0).toLowerCase();let S=this.client.profiles.keys,p=0,g=S.length;if(g===0)return 0;for(;p<g;p++)switch(r[1]){case"alias":return i=W(this.client.profiles.items[S[p]].aliases),i=i.find(C=>C.pattern===r[0]),i?1:0;case"event":return i=W(this.client.profiles.items[S[p]].triggers),i=i.find(C=>C.type===2&&(C.pattern===r[0]||C.name===r[0])),i?1:0;case"trigger":return i=W(this.client.profiles.items[S[p]].triggers),i=i.find(C=>C.pattern===r[0]||C.name===r[0]),i?1:0;case"macro":return i=W(this.client.profiles.items[S[p]].macros),i=i.find(C=>Ue(C).toLowerCase()===r[0].toLowerCase()||C.name===r[0]),i?1:0;case"button":return i=W(this.client.profiles.items[S[p]].aliases),i=i.find(C=>C.caption===r[0]||C.name===r[0]),i?1:0}if(r[1]==="variable")return this.client.variables.hasOwnProperty(r[0])}else throw new Error("Too many arguments for defined");return 0;case"escape":return r=this.stripQuotes(this.parseInline(s[2])),this.client.getOption("allowEscape")?(e=f,f==="\\"&&(e+=f),this.client.getOption("parseDoubleQuotes")&&(e+='"'),this.client.getOption("parseSingleQuotes")&&(e+="'"),this.client.getOption("commandStacking")&&(e+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(e+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(e+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(e+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(e+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(e+=this.client.getOption("nParametersChar")),r.replace(new RegExp(`[${e}]`,"g"),f+"$&")):r.replace(/[\\"']/g,"$&");case"unescape":return r=this.stripQuotes(this.parseInline(s[2])),this.client.getOption("allowEscape")?(e=f,f==="\\"&&(e+=f),this.client.getOption("parseDoubleQuotes")&&(e+='"'),this.client.getOption("parseSingleQuotes")&&(e+="'"),this.client.getOption("commandStacking")&&(e+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(e+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(e+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(e+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(e+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(e+=this.client.getOption("nParametersChar")),f==="\\"?r.replace(new RegExp(`\\\\[${e}]`,"g"),S=>S.substr(1)):r.replace(new RegExp(`${f}[${e}]`,"g"),S=>S.substr(1))):r.replace(/\\[\\"']/g,S=>S.substr(1));case"alarm":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for alarm");if(r.length>3)throw new Error("Too many arguments for alarm");if(r[0]=this.stripQuotes(r[0]),i=this.client.alarms,l=i.length,l===0)throw new Error("No alarms set.");if(e=0,r.length===1){for(;e<l;e++)if(i[e].type===3&&(i[e].name===r[0]||i[e].pattern===r[0]))return i[e].suspended?0:this.client.getRemainingAlarmTime(e)}else if(r.length===2)if(o=parseInt(r[1],10),isNaN(o)){for(r[1]=this.stripQuotes(r[1].trim());e<l;e++)if(i[e].type===3&&(i[e].name===r[0]||i[e].pattern===r[0])){if(i[e].profile.name.toUpperCase()!==r[1].toUpperCase())continue;return i[e].suspended?0:this.client.getRemainingAlarmTime(e)}throw Error("Alarm not found in profile: "+r[1]+".")}else{for(;e<l;e++)if(i[e].type===3&&(i[e].name===r[0]||i[e].pattern===r[0]))return i[e].suspended||this.client.setAlarmTempTime(e,o),o;throw Error("Alarm not found.")}else if(r.length===3){if(o=parseInt(r[1],10),isNaN(o))throw new Error("Invalid time for alarm");for(r[2]=this.stripQuotes(r[2].trim());e<l;e++)if(i[e].type===3&&(i[e].name===r[0]||i[e].pattern===r[0])){if(i[e].profile.name.toUpperCase()!==r[2].toUpperCase())continue;return i[e].suspended||this.client.setAlarmTempTime(e,o),o}throw Error("Could not set time, alarm not found in profile: "+r[2]+".")}return 0;case"state":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)throw new Error("Missing arguments for state");if(r.length>2)throw new Error("Too many arguments for state");if(r[0]=this.stripQuotes(r[0]),o=null,r.length===1){let S=this.client.profiles.keys,p=0,g=S.length;if(g===0)return null;if(g===1){if(!this.client.profiles.items[S[0]].enabled||!this.client.profiles.items[S[0]].enableTriggers)throw Error("No enabled profiles found!");i=W(this.client.profiles.items[S[p]].triggers),i=i.find(C=>C.name===r[0]||C.pattern===r[0])}else for(;p<g&&!(!(!this.client.profiles.items[S[p]].enabled||!this.client.profiles.items[S[p]].enableTriggers||this.client.profiles.items[S[p]].triggers.length===0)&&(i=W(this.client.profiles.items[S[p]].triggers),i=i.find(C=>C.name===r[0]||C.pattern===r[0]),i));p++);}else if(r.length===2){if(r[1]=this.stripQuotes(r[1].trim()),this.client.profiles.contains(r[1]))o=this.client.profiles.items[r[1].toLowerCase()];else throw new Error("Profile not found: "+r[1]);i=W(o.triggers),i=i.find(S=>S.name===r[0]||S.pattern===r[0])}if(i)return i.triggers&&i.triggers.length?i.state:0;throw new Error("Trigger not found");case"isnull":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)return null;if(r.length!==1)throw new Error("Too many arguments for null");return this.evaluate(r[0])===null?1:0;case"prompt":if(r=this.splitByQuotes(this.parseInline(s[2]),","),r.length===0)return window.prompt()||"";if(r.length>3)throw new Error("Too many arguments");return r=r.map(S=>this.stripQuotes(S)),window.prompt(...r)||""}let u={raw:t,name:s[1],args:s[2]&&s[2].length?this.parseOutgoing(s[2]).split(","):[],handled:!1,return:null};return this.client.emit("variable",u),u.handled?u.return:null}GetNamedArguments(t,e,n){if(t==="*")return e;if(n==null&&(n=!1),t==null||t.length===0)return n?e:[];let s=t.split(","),i=s.length,o=e.length;if(i===0)return n?e:[];let r;n?r=e.slice():r=[];for(let a=0;a<i;a++)s[a]=$.trim(s[a]),!(s[a].length<1)&&(s[a].startsWith("$")&&(s[a]=s[a].substring(1)),s[a].match(/^[a-zA-Z0-9_][a-zA-Z0-9_]+$/g)&&me(s[a])&&(r[s[a]]||(r[s[a]]=a+1<o?e[a+1]:"")));return r}ExecuteAlias(t,e){if(!t.enabled)return;let n;if(t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:e,named:this.GetNamedArguments(t.params,e),append:t.append,used:0}),n=this.parseOutgoing(t.value,null,null,!0),this._stack.pop();break;case 2:(this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0);let s=this.GetNamedArguments(t.params,e);s?n=Object.keys(s).map(o=>`let ${o} = this.input.stack.named["${o}"];`).join("")+`
`:n="";let i=new Function("try { "+n+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`);this._stack.push({loops:[],args:e,named:s,append:t.append,used:0});try{n=i.apply(this.client,e)}catch(o){throw o}finally{this._stack.pop()}typeof n=="string"&&(n=this.parseOutgoing(n,null,null,!0));break;default:n=t.value;break}return n==null||n===void 0||(n=this.ExecuteTriggers(17,n,n,!1,!0),n==null||n===void 0)||(typeof n!="string"&&(n=n.toString()),n.length===0&&!this.client.getOption("returnNewlineOnEmptyValue"))?null:n.endsWith(`
`)?n:n+`
`}ProcessMacros(t,e,n,s,i){if(!t||t>9&&t<19)return!1;let o=this._MacroCache[t]||(this._MacroCache[t]=Ce(this.client.macros,"key",t)),r=0,a=o.length,l=0;for(e&&(l|=2),n&&(l|=4),s&&(l|=8),i&&(l|=16);r<a;r++)if(!(!o[r].enabled||l!==o[r].modifiers)&&this.ExecuteMacro(o[r]))return!0;return!1}ExecuteMacro(t){if(!t.enabled)return!1;let e;if(t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:0,named:0,used:0});try{e=this.parseOutgoing(t.value)}catch(s){throw s}finally{this._stack.pop()}break;case 2:(this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0);let n=new Function("try { "+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`);this._stack.push({loops:[],args:0,named:0,used:0});try{e=n.apply(this.client)}catch(s){throw s}finally{this._stack.pop()}break;default:e=t.value;break}return e==null||e===void 0?!0:(typeof e!="string"&&(e=e.toString()),e.length===0&&!this.client.getOption("returnNewlineOnEmptyValue")?null:(t.send?(e.endsWith(`
`)||(e+=`
`),t.chain&&this.client.commandInput.value.endsWith(" ")?(this.client.commandInput.value=this.client.commandInput.value+e,this.client.sendCommand(null,null,this.client.getOption("allowCommentsFromCommand"))):this.client.send(e,!0)):t.append&&(this.client.commandInput.value=this.client.commandInput.value+e),!0))}ProcessPath(t,e){if(t.length===0)return"";let n=[],s=0,i="",o="",r=0,a,l,f,u,b=0,h=t.length;for(;r<h;r++)switch(a=t.charAt(r),l=t.charCodeAt(r),s){case 1:l>47&&l<58?o+=a:a==="\\"?s=2:(s=0,i=a);break;case 2:l>47&&l<58?i+=a:(i+="\\",r--),s=0;break;case 3:b===0&&a===")"?s=0:(a==="("?b++:a===")"&&b--,i+=a);break;case 4:b===0&&a==="}"?s=0:(a==="{"?b++:a==="}"&&b--,i+=a);break;default:if(l>47&&l<58){if(i.length>0){for(o.length===0?f=1:f=parseInt(o,10),u=0;u<f;u++)n.push(i);i=""}s=1,o=a}else a==="("?(s=3,b=0):a==="{"?(s=4,b=0):a==="\\"?s=2:i+=a;break}if(i.length>0)for(o.length===0?f=1:f=parseInt(o,10),u=0;u<f;u++)n.push(i);return e&&this._pathQueue.length?this._pathQueue[0]={id:t,current:n,previous:[]}:this._pathQueue.push({id:t,current:n,previous:[]}),this.ExecutePath(),null}ExecutePath(){if(this._pathTimeout||!this._pathQueue.length||this._pathPaused)return;let t=this.client.getOption("pathDelay");t<0&&(t=0),this._pathTimeout=setTimeout(()=>{let e=this.client.getOption("parseSpeedpaths"),n=this.client.getOption("echoSpeedpaths"),s=this.client.getOption("pathDelayCount");s<1&&(s=1);let i=this._pathQueue[0];for(;s--;){let o=i.current.shift();if(i.previous.push(o),e?this.client.sendBackground(o+`
`,!n):this.client.send(o+`
`,!n),!i.current.length)break}i.current.length||this._pathQueue.shift(),this._pathTimeout=null,!(this._pathQueue.length&&this._pathQueue[0].manual)&&this.ExecutePath()},t)}toggleScrollLock(){this.scrollLock=!this.scrollLock}hasTriggerType(t,e){return e===3&&(t&32)==32||e===16&&(t&16)==16||e===1&&(t&1)==1||e===2&&(t&2)==2||e===8&&(t&8)==8||e===0&&(t&4)==4||e===128&&(t&128)==128}isSubTriggerType(t){return(t&512)==512||(t&1024)==1024||(t&4096)==4096||(t&8192)==8192||(t&16384)==16384||(t&32768)==32768||(t&65536)==65536||(t&131072)==131072||(t&262144)==262144}getTriggerType(t){return t===0?4:t===3?32:t}ExecuteTriggers(t,e,n,s,i,o){if(!this.enableTriggers||e==null)return e;i==null&&(i=!1),s==null&&(s=!1),n=n||e,this.buildTriggerCache();let r=0,a,l=!1,f,u=this._TriggerCache,b=u.length,h=this._TriggerStates,E=this._TriggerRegExCache,S;for(;r<b;r++){let p=u[r],g=p;if(p.enabled){if((!g.triggers||!g.triggers.length||p.state>g.triggers.length)&&(g.state=0),p.state!==0&&g.triggers&&g.triggers.length){for(p=g.triggers[p.state-1];!p.enabled&&g.state!==0;){if(g.state++,g.state>g.triggers.length){g.state=0,p=g;break}g.state?p=g.triggers[g.state-1]:p=g,l=!0}if(l&&(this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",g.profile.name,g.profile.triggers.indexOf(g),g)),!p.enabled)continue}if(S=this.getTriggerType(p.type),!(p.type!==void 0&&(t&S)!==S&&(!o||o&&!this.isSubTriggerType(p.type)))&&p.type!==65536&&!(s&&!p.triggerPrompt)&&!(!s&&!p.triggerNewline&&p.triggerNewline!==void 0)){if(h[r]){if(h[r].type===1024){if(h[r].time>Date.now())continue;delete h[r]}else if(h[r].type===16384){if(h[r].time<Date.now()){delete h[r],this.advanceTrigger(p,g,r),h[r]?h[r].reParse=!0:h[r]={reParse:!0},r=this.cleanUpTriggerState(r);continue}}else if(h[r].type===512){if(h[r].lineCount>0)continue;delete h[r]}else if(h[r].type===8192){if(h[r].lineCount<1){this.advanceTrigger(p,g,r),h[r]?h[r].reParse=!0:h[r]={reParse:!0},r=this.cleanUpTriggerState(r);continue}}else if(h[r].type===32768&&h[r].lineCount<1){this.advanceTrigger(p,g,r),h[r]?h[r].reParse=!0:h[r]={reParse:!0},r=this.cleanUpTriggerState(r);continue}}try{if(p.type===128)if(this.evaluate(this.parseInline(p.pattern))){if(h[r]){if(h[r].loop!==-1&&h[r].lineCount<1)continue}else{let C=this.createTriggerState(p,!1,g);C&&(h[r]=C)}this._LastTriggered=p.raw?n:e,f=this.ExecuteTrigger(p,[this._LastTriggered],i,r,[this._LastTriggered],0,g)}else{this.advanceTrigger(p,g,r);continue}else if(p.verbatim){if(!p.caseSensitive&&(p.raw?n:e).toLowerCase()!==p.pattern.toLowerCase()){!h[r]&&(p.type===131072||p.type===262144)&&(this.advanceTrigger(p,g,r),r=this.cleanUpTriggerState(r));continue}else if(p.caseSensitive&&(p.raw?n:e)!==p.pattern){!h[r]&&(p.type===131072||p.type===262144)&&(this.advanceTrigger(p,g,r),r=this.cleanUpTriggerState(r));continue}this._LastTriggered=p.raw?n:e,f=this.ExecuteTrigger(p,[this._LastTriggered],i,r,[this._LastTriggered],0,g)}else{let C;p.type===8||p.type===16||p.type===262144?a=Ie(p.pattern,this.client):a=p.pattern,p.caseSensitive?C=E["g"+a]||(E["g"+a]=new RegExp(a,"gd")):C=E["gi"+a]||(E["gi"+a]=new RegExp(a,"gid")),C.lastIndex=0;let P=C.exec(p.raw?n:e);if(!P||!P.length){!h[r]&&(p.type===131072||p.type===262144)&&(this.advanceTrigger(p,g,r),r=this.cleanUpTriggerState(r));continue}let x;this._LastTriggered=p.raw?n:e,(p.raw?n:e)===P[0]||!this.client.getOption("prependTriggeredLine")?x=P:(x=[this._LastTriggered,...P],x.indices=[[0,x[0].length],...P.indices]),P.groups&&Object.keys(P.groups).map(G=>this.client.variables[G]=P.groups[G]),f=this.ExecuteTrigger(p,x,i,r,[this._LastTriggered,C],P.groups,g)}if(h[r]&&h[r].reParse)!h[r].type||h[r].type===131072||h[r].type===262144?delete h[r]:delete h[r].reParse,r--;else if(i)return f}catch(C){this.client.getOption("disableTriggerOnError")&&(p.enabled=!1,setTimeout(()=>{this.client.saveProfiles(),this.emit("item-updated","trigger",g.profile,g.profile.triggers.indexOf(g),g)})),this.client.getOption("showScriptErrors")?this.client.error(C):this.client.debug(C)}}}}return e}TestTrigger(t,e,n,s,i,o){let r,a;try{if(t.verbatim){if(!t.caseSensitive&&(t.raw?i:s).toLowerCase()!==t.pattern.toLowerCase())return this._TriggerStates[n]||(this.advanceTrigger(t,e,n),n=this.cleanUpTriggerState(n)),n;if(t.caseSensitive&&(t.raw?i:s)!==t.pattern)return this._TriggerStates[n]||(this.advanceTrigger(t,e,n),n=this.cleanUpTriggerState(n)),n;this._LastTriggered=t.raw?i:s,r=this.ExecuteTrigger(t,[this._LastTriggered],!1,n,[this._LastTriggered],0,e)}else{let l;t.type===8||t.type===16||t.type===262144?a=Ie(t.pattern,this.client):a=t.pattern,t.caseSensitive?l=this._TriggerRegExCache["g"+a]||(this._TriggerRegExCache["g"+a]=new RegExp(a,"gd")):l=this._TriggerRegExCache["gi"+a]||(this._TriggerRegExCache["gi"+a]=new RegExp(a,"gid")),l.lastIndex=0;let f=l.exec(t.raw?i:s);if(!f||!f.length)return!this._TriggerStates[n]&&(t.type===131072||t.type===262144)&&(this.advanceTrigger(t,e,n),n=this.cleanUpTriggerState(n)),n;let u;this._LastTriggered=t.raw?i:s,(t.raw?i:s)===f[0]||!this.client.getOption("prependTriggeredLine")?u=f:(u=[this._LastTriggered,...f],u.indices=[[0,u[0].length],...f.indices]),f.groups&&Object.keys(f.groups).map(b=>this.client.variables[b]=f.groups[b]),r=this.ExecuteTrigger(t,u,!1,n,[this._LastTriggered,l],f.groups,e)}n=this.cleanUpTriggerState(n)}catch(l){this.client.getOption("disableTriggerOnError")&&(t.enabled=!1,setTimeout(()=>{this.client.saveProfiles(),this.emit("item-updated","trigger",e.profile,e.profile.triggers.indexOf(e),e)})),this.client.getOption("showScriptErrors")?this.client.error(l):this.client.debug(l)}return n}ExecuteTrigger(t,e,n,s,i,o,r){if(n==null&&(n=!1),!t.enabled)return"";if(this._TriggerStates[s]&&this._TriggerStates[s].type===16384&&delete this._TriggerStates[s],t.fired)return t.fired=!1,this.advanceTrigger(t,r,s),this._TriggerStates[s]?this._TriggerStates[s].reParse=!0:this._TriggerStates[s]={reParse:!0},"";this._LastTrigger=t;let a;if(t.temp)if(r.triggers.length)if(r.state===0){let l=r.triggers.shift();l.triggers=r.triggers,l.state=r.state,l.name=r.name,l.profile=r.profile,l.state>l.triggers.length&&(l.state=0),s>=0&&(this._TriggerCache[s]=l),this.client.saveProfiles();let f=r.profile.triggers.indexOf(r);r.profile.triggers[f]=l,this.client.emit("item-updated","trigger",r.profile.name,f,l)}else r.triggers.splice(r.state-1,1),r.state>r.triggers.length&&(r.state=0),this.client.saveProfiles(),this.client.emit("item-updated","trigger",r.profile.name,r.profile.triggers.indexOf(r),r);else s>=0&&this._TriggerCache.splice(s,1),this._TriggerStates[s]&&this.clearTriggerState(s),this.client.removeTrigger(r);else r.triggers.length&&this.advanceTrigger(t,r,s);if((this.client.getOption("echo")&8)===8&&this.client.echo("Trigger fired: "+t.pattern,-7,-8,!0,!0),t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:e,named:0,used:0,regex:i});try{a=this.parseOutgoing(t.value)}catch(l){throw l}finally{this._stack.pop()}break;case 2:if((this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0),t.temp)a=new Function("try { "+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`),a=a.apply(this.client,e);else{this._TriggerFunctionCache[s]||(o?a=Object.keys(o).map(l=>`let ${l} = this.variables["${l}"];`).join("")+`
`:a="",this._TriggerFunctionCache[s]=new Function("try { "+a+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`)),this._stack.push({loops:[],args:e,named:0,used:0,regex:i,indices:e.indices});try{a=this._TriggerFunctionCache[s].apply(this.client,e)}catch(l){throw l}finally{this._stack.pop()}}typeof a=="string"&&(a=this.parseOutgoing(a));break;default:a=t.value;break}if(a==null||a===void 0)return null;if(n)return a;if(typeof a!="string"&&(a=a.toString()),a.length===0&&!this.client.getOption("returnNewlineOnEmptyValue"))return null;a.endsWith(`
`)||(a+=`
`),this.client.connected&&this.client.telnet.sendData(a),this.client.telnet.echo&&this.client.getOption("commandEcho")&&setTimeout(()=>{this.client.echo(a)},1)}advanceTrigger(t,e,n){if(this._TriggerStates[n]){if(this._TriggerStates[n].type===4096){if(this._TriggerStates[n].loop--,this._TriggerStates[n].loop>0)return;this.clearTriggerState(n)}else if(this._TriggerStates[n].type===8192){if(this._TriggerStates[n].lineCount>0)return;this.clearTriggerState(n)}else if(this._TriggerStates[n].type===32768)this.clearTriggerState(n);else if(this._TriggerStates[n].type===128&&(this._TriggerStates[n].loop===-1||this._TriggerStates[n].lineCount>0))return}if(e.state++,e.state>e.triggers.length&&(e.state=0),this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",e.profile.name,e.profile.triggers.indexOf(e),e),e.state!==0){let s=this.createTriggerState(e.triggers[e.state-1]);s&&(this._TriggerStates[n]=s)}}createTriggerState(t,e,n){let s,i;switch(t.type){case 131072:case 262144:i={reParse:!0};break;case 16384:case 1024:s=t.params,s&&s.length?(s=parseInt(s,10),isNaN(s)&&(s=0)):s=0,i={time:Date.now()+s};break;case 32768:case 8192:case 512:s=t.params,s&&s.length?(s=parseInt(s,10),isNaN(s)&&(s=1)):s=1,i={lineCount:s+1};break;case 4096:s=t.params,s&&s.length?(s=parseInt(s,10),isNaN(s)&&(s=0)):s=0,i={loop:s};break;case 128:s=t.params,s&&s.length?(s=parseInt(s,10),isNaN(s)&&(s=1),n===t?i={lineCount:s-1}:i={lineCount:s}):i={loop:-1};break}return i&&(i.type=t.type),!i&&e?{reParse:!0}:(e&&(i.reparse=!0),i)}updateTriggerState(t,e){if(!this._TriggerStates[e])return;let n;switch(this._TriggerStates[e].type){case 1024:case 16384:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=0)):n=0,this._TriggerStates[e].time=Date.now()+n;break;case 32768:case 512:case 8192:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=0)):n=0,this._TriggerStates[e].lineCount=n;break;case 4096:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=0)):n=0,this._TriggerStates[e].loop=n;break;case 128:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=1),this._TriggerStates[e].lineCount=n+1):this._TriggerStates[e].loop=-1;break}}getTriggerState(t){return this._TriggerStates[t]}cleanUpTriggerState(t){return this._TriggerStates[t]&&this._TriggerStates[t].reParse&&(!this._TriggerStates[t].type||this._TriggerStates[t].type===131072||this._TriggerStates[t].type===262144?delete this._TriggerStates[t]:delete this._TriggerStates[t].reParse,t<0?t++:t--),t}clearTriggerState(t){delete this._TriggerStates[t]}setTriggerState(t,e){this._TriggerStates[t]=e}clearTriggerCache(){this._TriggerCache=null,this._TriggerStates={},this._TriggerFunctionCache={},this._TriggerRegExCache={}}resetTriggerState(t,e,n){if(t===-1||t<0||t>=this._TriggerCache.length)return;let s=this._TriggerCache[t],i,o=s,r,a=!1;if(o.state!==0&&(s=o.triggers[o.state-1]),e===0?i=o:i=o.triggers[e-1],e===o.state)this._TriggerStates[t]?s.fired?this.clearTriggerState(t):this.updateTriggerState(s,t):s.fired||this.updateTriggerState(s,t);else if(this._TriggerStates[t]&&(!this._TriggerStates[t].type||this._TriggerStates[t].type!==262144&&this._TriggerStates[t].type!==131072)&&(a=this._TriggerStates[t].reParse),this.clearTriggerState(t),s.fired)this._TriggerStates[t]={reParse:!0};else{let l=this.createTriggerState(s,a);l&&(this._TriggerStates[t]=l)}}buildTriggerCache(){this._TriggerCache==null&&(this._TriggerCache=$.grep(this.client.triggers,t=>{if(t&&t.enabled&&t.triggers.length){if(t.type!==3)return!0;for(let e=0,n=t.triggers.length;e<n;e++)if(t.triggers[e].enabled&&t.triggers[e].type!==3)return!0;return!1}return t.enabled&&t.type!==3}))}clearCaches(){this._TriggerCache=null,this._TriggerStates={},this._TriggerFunctionCache={},this._TriggerRegExCache={},this._gamepadCaches=null,this._lastSuspend=-1,this._MacroCache={}}triggerEvent(t,e){if(!this.enableTriggers)return;this.buildTriggerCache();let n=0;e?Array.isArray(e)?e.unshift(t):e=[t,e]:e=[t];let s=this._TriggerCache.length;for(;n<s;n++){let i=this._TriggerCache[n],o=i,r=!1;if(i.enabled){if(i.state>o.triggers.length&&(i.state=0),i.state!==0&&o.triggers&&o.triggers.length){for(i=o.triggers[i.state-1];!i.enabled&&o.state!==0;){if(o.state++,o.state>o.triggers.length){o.state=0,i=o;break}o.state?i=o.triggers[o.state-1]:i=o,r=!0}if(r&&(this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",o.profile.name,o.profile.triggers.indexOf(o),o)),!i.enabled)continue}if(i.type===131072||i.type===262144){let a=this.adjustLastLine(this.client.display.lines.length,!0),l=this.client.display.lines[a];n=this.TestTrigger(i,o,n,l,this.client.display.lines[a].raw||l,a===this.client.display.lines.length-1);continue}i.type===2&&(i.caseSensitive&&t!==i.pattern||!i.caseSensitive&&t.toLowerCase()!==i.pattern.toLowerCase()||(this._LastTriggered=t,this.ExecuteTrigger(i,e,!1,n,0,0,o),n=this.cleanUpTriggerState(n)))}}}executeWait(t,e,n,s,i,o,r){if(!t||t.length===0)return;let a={loops:this.loops.splice(0),args:0,named:0,used:this.stack.used,append:this.stack.append};this.stack.args&&(a.args=this.stack.args.slice()),this.stack.named&&(a.named=this.stack.named.slice()),e<0&&(e=0),setTimeout(()=>{this._stack.push(a);let l=this.parseOutgoing(t,n,s,i,o,r);this._stack.pop(),!(l==null||typeof l>"u"||l.length===0)&&(l.endsWith(`
`)||(l=l+`
`),this.client.send(l,!0))},e)}buildScript(t){if(!t)return"";let e;this.client.getOption("commandStacking")&&this.client.getOption("commandStackingChar")&&this.client.getOption("commandStackingChar").length>0?e=t.splitQuote(`
`+this.client.getOption("commandStackingChar")):e=t.splitQuote(`
`);let n=0,s=e.length,i=[],o=[],r=this.client.getOption("commandChar");for(;n<s;n++)e[n].trim().startsWith(r+"wait ")?(i.push("setTimeout(()=> {"),o.unshift(parseInt(e[n].trim().substr(5),10)||0)):(i.push("client.sendCommand('"),i.push(e[n]),i.push("\\n');"));let a=o.length;for(n=0;n<a;n++)i.push("}, "),i.push(o[n]),i.push(");");return i.join("")}stripQuotes(t,e,n){return!t||t.length===0||((e||this.client.getOption("parseDoubleQuotes"))&&(t=t.replace(/^\"(.*)\"$/g,(s,i,o)=>i.replace(/\\\"/g,'"'))),(n||this.client.getOption("parseSingleQuotes"))&&(t=t.replace(/^\'(.*)\'$/g,(s,i,o)=>i.replace(/\\\'/g,"'")))),t}splitByQuotes(t,e,n,s){let i=0,o=0;return!t||t.length===0?[]:((n||this.client.getOption("parseDoubleQuotes"))&&(i|=2,o|=this.client.getOption("allowEscape")?2:0),(s||this.client.getOption("parseSingleQuotes"))&&(i|=1,o|=this.client.getOption("allowEscape")?1:0),Qe(t,e,i,o,this.client.getOption("escapeChar")))}createTrigger(t,e,n,s,i,o){let r,a,l=!0,f=!1;if(!t&&!i)throw new Error(`Trigger '${i||""}' not found`);if(n){if(typeof n=="string"){if(this.client.profiles.contains(n.toLowerCase()))n=this.client.profiles.items[n.toLowerCase()];else throw new Error("Profile not found: "+n);if(o)if(i)r=n.findAny("triggers",{name:i,pattern:i});else{if(!n.triggers.length)throw new Error("No triggers exist");r=n.triggers[n.triggers.length-1]}else i!==null?r=n.find("triggers","name",i):r=n.find("triggers","pattern",t)}}else{let u=this.client.profiles.keys,b=0,h=u.length;if(h===0)return;if(h===1){if(!this.client.profiles.items[u[0]].enabled||!this.client.profiles.items[u[0]].enableTriggers)throw Error("No enabled profiles found!");if(n=this.client.profiles.items[u[0]],o)if(i)r=this.client.profiles.items[u[b]].findAny("triggers",{name:i,pattern:i});else{if(!this.client.profiles.items[u[b]].triggers.length)throw new Error("No triggers exist");r=this.client.profiles.items[u[b]].triggers[this.client.profiles.items[u[b]].triggers.length-1]}else i!==null?r=this.client.profiles.items[u[b]].find("triggers","name",i):r=this.client.profiles.items[u[b]].find("triggers","pattern",t)}else{for(;b<h;b++)if(!(!this.client.profiles.items[u[b]].enabled||!this.client.profiles.items[u[b]].enableTriggers||this.client.profiles.items[u[b]].triggers.length===0)){if(o)if(i)r=this.client.profiles.items[u[b]].findAny("triggers",{name:i,pattern:i});else{if(!this.client.profiles.items[u[b]].triggers.length)throw new Error("No triggers exist");r=this.client.profiles.items[u[b]].triggers[this.client.profiles.items[u[b]].triggers.length-1]}else i!==null?r=this.client.profiles.items[u[b]].find("triggers","name",i):r=this.client.profiles.items[u[b]].find("triggers","pattern",t);if(r){n=this.client.profiles.items[u[b]];break}}n||(n=this.client.activeProfile)}}if(o){if(!r)throw new Error(`Trigger '${i||""}' not found`);if(a=new oe,a.pattern=t,l=!1,t!==null&&(a.pattern=t),e!==null&&(a.value=e),s&&(s.cmd&&(a.type=1),s.pattern&&(a.type=8),s.regular&&(a.type=0),s.alarm&&(a.type=3),s.event&&(a.type=2),s.cmdpattern&&(a.type=16),s.loopexpression&&(a.type=128),s.reparse&&(a.type=131072),s.reparsepattern&&(a.type=262144),s.manual&&(a.type=65536),s.skip&&(a.type=512),s.looplines&&(a.type=8192),s.looppattern&&(a.type=4096),s.wait&&(a.type=1024),s.duration&&(a.type=16384),s.withinlines&&(a.type=32768),s.prompt&&(a.triggerPrompt=!0),s.nocr&&(a.triggerNewline=!1),s.case&&(a.caseSensitive=!0),s.raw&&(a.raw=!0),s.verbatim&&(a.verbatim=!0),s.disable?a.enabled=!1:s.enable&&(a.enabled=!0),(s.temporary||s.temp)&&(a.temp=!0),s.params&&(a.params=s.params),s.type))if(this.isTriggerType(s.type))a.type=this.convertTriggerType(s.type);else throw new Error("Invalid trigger type");r.triggers.push(a),this.client.echo("Trigger sub state added.",-7,-8,!0,!0)}else{if(r)this.client.echo("Trigger updated.",-7,-8,!0,!0);else{if(!t)throw new Error(`Trigger '${i||""}' not found`);r=new oe,r.name=i||"",r.pattern=t,n.triggers.push(r),this.client.echo("Trigger added.",-7,-8,!0,!0),f=!0}if(t!==null&&(r.pattern=t),e!==null&&(r.value=e),s){if(s.cmd&&(r.type=1),s.pattern&&(r.type=8),s.regular&&(r.type=0),s.alarm&&(r.type=3),s.event&&(r.type=2),s.cmdpattern&&(r.type=16),s.loopexpression&&(r.type=128),s.prompt&&(r.triggerPrompt=!0),s.nocr&&(r.triggerNewline=!1),s.case&&(r.caseSensitive=!0),s.raw&&(r.raw=!0),s.verbatim&&(r.verbatim=!0),s.disable?r.enabled=!1:s.enable&&(r.enabled=!0),(s.temporary||s.temp)&&(r.temp=!0),s.params&&(r.params=s.params),s.type)if(this.isTriggerType(s.type,1))r.type=this.convertTriggerType(s.type);else throw new Error("Invalid trigger type");r.priority=s.priority}else r.priority=0}this.client.saveProfiles(),l&&this.client.clearCache(),f?this.emit("item-added","trigger",n.name,r):this.emit("item-updated","trigger",n.name,n.triggers.indexOf(r),r),n=null}isTriggerType(t,e){switch(e||(e=3),t.replace(/ /g,"").toUpperCase()){case"REGULAREXPRESSION":case"COMMANDINPUTREGULAREXPRESSION":return(e&1)===1;case"0":case"1":case"2":case"3":case"8":case"16":case"128":case"REGULAR":case"COMMANDINPUTREGULAR":case"EVENT":case"ALARM":case"COMMAND":case"COMMANDINPUTPATTERN":case"LOOPEXPRSSION":return(e&1)===1;case"SKIP":case"512":case"WAIT":case"1024":case"LOOPPATTERN":case"4096":case"LOOPLINES":case"8192":case"DURATION":case"16384":case"WITHINLINES":case"32768":case"MANUAL":case"65536":case"REPARSE":case"131072":case"REPARSEPATTERN":case"262144":return(e&2)===2}return!1}convertTriggerType(t){switch(t.replace(/ /g,"").toUpperCase()){case"REGULAREXPRESSION":return 0;case"COMMANDINPUTREGULAREXPRESSION":return 1;case"0":case"1":case"2":case"3":case"8":case"16":case"128":return Be[parseInt(t,10)];case"REGULAR":case"COMMANDINPUTREGULAR":case"EVENT":case"ALARM":case"COMMAND":case"COMMANDINPUTPATTERN":case"LOOPEXPRSSION":return Be[t];case"512":case"1024":case"4096":case"8192":case"16384":case"32768":case"65536":case"131072":case"262144":return Fe[parseInt(t,10)];case"SKIP":case"WAIT":case"LOOPPATTERN":case"LOOPLINES":case"DURATION":case"WITHINLINES":case"MANUAL":case"REPARSE":case"REPARSEPATTERN":return Fe[t]}throw new Error("Invalid trigger type")}colorPosition(t,e,n,s){if(t=this.adjustLastLine(t),!s.hasOwnProperty("yStart"))this.client.display.colorSubStringByLine(t,e,n,s.xStart,s.hasOwnProperty("xEnd")&&s.xEnd>=0?s.xEnd:null);else{let i=s.hasOwnProperty("xEnd")&&s.xEnd>=0?s.xEnd:null,o=s.xStart,r=t-s.yStart,a=t;for(s.hasOwnProperty("yEnd")&&(a=t-s.yEnd);r<=a;)this.client.display.colorSubStringByLine(r,e,n,o,i),r++}}};function Z(m){this.ok=!1,m.charAt(0)=="#"&&(m=m.substr(1,6)),m=m.replace(/ /g,""),m=m.toLowerCase();var c={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(var t in c)m==t&&(m=c[t]);for(var e=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(l){return[parseInt(l[1],10),parseInt(l[2],10),parseInt(l[3],10)]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(l){return[parseInt(l[1],16),parseInt(l[2],16),parseInt(l[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(l){return[parseInt(l[1]+l[1],16),parseInt(l[2]+l[2],16),parseInt(l[3]+l[3],16)]}}],n=0,s=e.length;n<s;n++){var i=e[n].re,o=e[n].process,r=i.exec(m);if(r){var a=o(r);this.r=a[0],this.g=a[1],this.b=a[2],this.ok=!0}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r,this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g,this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var l=this.r.toString(16),f=this.g.toString(16),u=this.b.toString(16);return l.length==1&&(l="0"+l),f.length==1&&(f="0"+f),u.length==1&&(u="0"+u),"#"+l+f+u}}var K=(w=>(w[w.None=0]="None",w[w.B=1]="B",w[w.BOLD=2]="BOLD",w[w.STRONG=3]="STRONG",w[w.I=4]="I",w[w.ITALIC=5]="ITALIC",w[w.EM=6]="EM",w[w.U=7]="U",w[w.UNDERLINE=8]="UNDERLINE",w[w.S=9]="S",w[w.STRIKEOUT=10]="STRIKEOUT",w[w.STRIKE=11]="STRIKE",w[w.C=12]="C",w[w.COLOR=13]="COLOR",w[w.H=14]="H",w[w.HIGH=15]="HIGH",w[w.FONT=16]="FONT",w[w.HR=17]="HR",w[w.NOBR=18]="NOBR",w[w.P=19]="P",w[w.BR=20]="BR",w[w.SBR=21]="SBR",w[w.A=22]="A",w[w.SEND=23]="SEND",w[w.EXPIRE=24]="EXPIRE",w[w.VERSION=25]="VERSION",w[w.SUPPORT=26]="SUPPORT",w[w.RESET=27]="RESET",w[w.H1=28]="H1",w[w.H2=29]="H2",w[w.H3=30]="H3",w[w.H4=31]="H4",w[w.H5=32]="H5",w[w.H6=33]="H6",w[w.V=34]="V",w[w.VAR=35]="VAR",w[w.USER=36]="USER",w[w.PASSWORD=37]="PASSWORD",w[w.Custom=38]="Custom",w[w.GAUGE=39]="GAUGE",w[w.STAT=40]="STAT",w))(K||{});var tt=class{constructor(){this.on=!1;this.lineType=0;this.locked=!1;this.paragraph=!1;this.noBreak=!1;this.expanded=!1;this.lineExpanded=!1;this.capture=0;this.captured=[];this.gagged=!1}},it=class{constructor(c){this.name="";this.value="";this.description="";this.publish=!1;this.remote=!1;this.remote=c??!1}},St=class{constructor(c){this.name="";this.definition="";this.closeDefinition="";this.attributes={};this.attributeIndexes=[];this.tag=-1;this.flag="";this.open=!1;this.empty=!1;this.remote=!1;this.gagged=!1;this.remote=c??!1}},st=class{constructor(c,t,e,n){this.index=-1;this.window="";this.gag=!1;this.fore="";this.back="";this.enabled=!0;this.remote=!1;this.element="";this.definition="";this.closeDefinition="";c!=null&&(this.index=c),t!=null&&(this.fore=t),e!=null&&(this.back=e),n!=null&&(this.remote=n)}},Me=class{constructor(c,t,e,n,s){this.tag=0;this.custom="";this.font=null;this.fontSize=null;this.style=0;this.fore="";this.back="";this.high=!1;this.obj=null;this.gagged=!1;this.open=!1;this.properties=null;c!=null&&(this.style=c),t!=null&&(this.fore=t),e!=null&&(this.back=e),this.high=n||!1,this.open=s||!1}},nt=class extends ee{constructor(t){super();this.parsing=[];this.protocols=[["m","a","i","l","t","o"],["s","k","y","p","e"],["a","i","m"],["c","a","l","l","t","o"],["g","t","a","l","k"],["i","m"],["i","t","m","s"],["m","s","n","i","m"],["t","e","l"],["y","m","s","g","r"]];this._ColorTable=null;this._CurrentForeColor=37;this._CurrentBackColor=40;this._CurrentAttributes=0;this._SplitBuffer="";this.mxpState=new tt;this.mxpStyles=[];this.mxpEntities={};this.mxpElements={};this.mxpLines=[];this.iMXPDefaultMode=0;this.displayControlCodes=!1;this.emulateControlCodes=!0;this.StyleVersion="";this.EndOfLine=!1;this.textLength=0;this.rawLength=0;this.enableMXP=!0;this.DefaultImgUrl="";this.enableDebug=!1;this.showInvalidMXPTags=!1;this.enableLinks=!0;this.enableMSP=!0;this.enableURLDetection=!0;this.window=new Pe(0,0);this.enableFlashing=!1;this.emulateTerminal=!1;this.enableBell=!0;this.display=null;this.tabWidth=8;this.busy=!1;t!=null&&(t.DefaultImageURL&&(this.DefaultImgUrl=t.DefaultImageURL),t.enableMXP!=null&&(this.enableMXP=t.enableMXP),t.enableDebug!=null&&(this.enableDebug=t.enableDebug),t.showInvalidMXPTags!=null&&(this.showInvalidMXPTags=t.showInvalidMXPTags),t.enableMSP!=null&&(this.enableMSP=t.enableMSP),t.enableURLDetection!=null&&(this.enableURLDetection=t.enableURLDetection),t.window!=null&&(this.window=t.window),t.enableFlashing!=null&&(this.enableFlashing=t.enableFlashing),t.emulateTerminal!=null&&(this.emulateTerminal=t.emulateTerminal),t.enableBell!=null&&(this.enableBell=t.enableBell),t.display!=null&&(this.display=t.display),t.enableLinks&&(this.enableLinks=t.enableLinks))}getColors(t){typeof t>"u"&&(t=this.GetCurrentStyle());let e,n,s=-1,i=-1;return t.fore.length>0?(this._CurrentAttributes&1)===1?e=this.IncreaseColor(t.fore,.5):(this._CurrentAttributes&2)===2?e=this.DecreaseColor(t.fore,.5):e=t.fore:typeof this._CurrentForeColor=="string"?e="rgb("+this._CurrentForeColor.replace(/;/g,",")+")":(e=this._CurrentForeColor,(this._CurrentAttributes&1)===1?(e>999&&(e/=1e3),e>=0&&e<99&&(e*=10),s=e,e<=-16&&(e=this.IncreaseColor(this.GetColor(e),.5))):(this._CurrentAttributes&2)===2?(e>99&&e<999&&(e/=10),e>=0&&e<999&&(e*=100),s=e,e<=-16&&(e=this.DecreaseColor(this.GetColor(e),.15))):s=e),t.high&&(typeof e=="number"?e=this.IncreaseColor(this.GetColor(e),.25):e=this.IncreaseColor(e,.25)),t.back.length>0?n=t.back:typeof this._CurrentBackColor=="string"?n="rgb("+this._CurrentBackColor.replace(/;/g,",")+")":n=i=this._CurrentBackColor,(this._CurrentAttributes&64)===64||(t.style&64)===64?{fore:n,back:e,foreCode:i,backCode:s}:{fore:e,back:n,foreCode:s,backCode:i}}getFormatBlock(t){let e=this.GetCurrentStyle(),n=this.getColors(e);return{formatType:0,offset:t,color:n.fore||0,background:n.back||0,size:e.fontSize||0,font:e.font||0,style:e.style|this._CurrentAttributes&-2,unicode:!1}}ResetColors(){this._CurrentForeColor=37,this._CurrentBackColor=40,this._CurrentAttributes=0}ProcessAnsiColorParams(t){let e=0,n=t.length,s,i;for(;e<n;e++)switch(s=+t[e]||0,s){case 0:this.ResetColors();break;case 1:this._CurrentAttributes|=1,this._CurrentAttributes&=-3;break;case 2:this._CurrentAttributes|=2,this._CurrentAttributes&=-2;break;case 3:this._CurrentAttributes|=4;break;case 4:this._CurrentAttributes|=8;break;case 5:this._CurrentAttributes|=16;break;case 6:this._CurrentAttributes|=32;break;case 7:this._CurrentAttributes|=64;break;case 8:this._CurrentAttributes|=128;break;case 9:this._CurrentAttributes|=256;break;case 21:this._CurrentAttributes|=512;break;case 22:this._CurrentAttributes&=-2,this._CurrentAttributes&=-3;break;case 23:this._CurrentAttributes&=-5;break;case 24:this._CurrentAttributes&=-9,this._CurrentAttributes&=-513;break;case 25:this._CurrentAttributes&=-17;break;case 26:this._CurrentAttributes&=-33;break;case 27:this._CurrentAttributes&=-65;break;case 28:this._CurrentAttributes&=-129;break;case 29:this._CurrentAttributes&=-257;break;case-11:case-7:case-3:case 30:case 31:case 32:case 33:case 34:case 35:case 36:case 37:this._CurrentForeColor=s;break;case 38:if(e+2<n&&t[e+1]==="5")this._CurrentForeColor=+t[e+2],isNaN(this._CurrentForeColor)?this._CurrentForeColor=37:(this._CurrentForeColor+=16,this._CurrentForeColor*=-1),e+=2;else if(e+4<n&&t[e+1]==="2"){if(s=+t[e+2]||0,s<0||s>255||(i=s+";",s=+t[e+3]||0,s<0||s>255)||(i+=s+";",s=+t[e+4]||0,s<0||s>255))continue;i+=s,this._CurrentForeColor=i,e+=4}break;case 39:this._CurrentForeColor=-1;break;case-12:case-8:case-4:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:this._CurrentBackColor=s;break;case 48:if(e+2<n&&t[e+1]==="5")this._CurrentBackColor=+t[e+2],isNaN(this._CurrentBackColor)?this._CurrentBackColor=40:(this._CurrentBackColor+=16,this._CurrentBackColor*=-1),e+=2;else if(e+4<n&&t[e+1]==="2"){if(s=+t[e+2]||0,s<0||s>255||(i=s+";",s=+t[e+3]||0,s<0||s>255)||(i+=s+";",s=+t[e+4]||0,s<0||s>255))continue;i+=s,this._CurrentBackColor=i,e+=4}break;case 49:this._CurrentBackColor=-2;break;case 53:this._CurrentAttributes|=1024;break;case 55:this._CurrentAttributes&=-1025;break;case 50:case 51:case 52:case 54:case 56:case 57:case 58:case 59:this._CurrentForeColor=s-20,this._CurrentAttributes|=1;break;case 90:case 91:case 92:case 93:case 94:case 95:case 96:case 97:this._CurrentForeColor=s;break;case 100:case 101:case 102:case 103:case 104:case 105:case 106:case 107:this._CurrentBackColor=s;break}}buildColorTable(){let t=[],e,n,s,i;for(e=0;e<6;e++)for(n=0;n<6;n++)for(s=0;s<6;s++)i=16+e*36+n*6+s,t[i]="rgb(",e>0?t[i]+=e*40+55:t[i]+="0",t[i]+=",",n>0?t[i]+=n*40+55:t[i]+="0",t[i]+=",",s>0?t[i]+=s*40+55:t[i]+="0",t[i]+=")";for(e=232;e<=255;e++)n=(e-232)*10+8,t[e]=["rgb(",n,",",n,",",n,")"].join("");t[0]="rgb(0,0,0)",t[1]="rgb(128, 0, 0)",t[2]="rgb(0, 128, 0)",t[3]="rgb(128, 128, 0)",t[4]="rgb(0, 0, 238)",t[5]="rgb(128, 0, 128)",t[6]="rgb(0, 128, 128)",t[7]="rgb(187, 187, 187)",t[8]="rgb(128, 128, 128)",t[9]="rgb(255, 0, 0)",t[10]="rgb(0, 255, 0)",t[11]="rgb(255, 255, 0)",t[12]="rgb(92, 92, 255)",t[13]="rgb(255, 0, 255)",t[14]="rgb(0, 255, 255)",t[15]="rgb(255, 255, 255)",t[256]="rgb(0, 0, 0)",t[257]="rgb(118, 0, 0)",t[258]="rgb(0, 108, 0)",t[259]="rgb(145, 136, 0)",t[260]="rgb(0, 0, 167)",t[261]="rgb(108, 0, 108)",t[262]="rgb(0, 108, 108)",t[263]="rgb(161, 161, 161)",t[264]="rgb(0, 0, 0)",t[265]="rgb(128, 0, 0)",t[266]="rgb(0, 128, 0)",t[267]="rgb(128, 128, 0)",t[268]="rgb(0, 0, 238)",t[269]="rgb(128, 0, 128)",t[270]="rgb(0, 128, 128)",t[271]="rgb(187, 187, 187)",t[272]="rgb(0,0,0)",t[273]="rgb(0, 255, 255)",t[274]="rgb(0,0,0)",t[275]="rgb(255, 255, 0)",t[276]="rgb(0, 0, 0)",t[277]="rgb(229, 229, 229)",t[278]="rgb(205, 0, 0)",t[279]="rgb(229, 229, 229)",t[280]="rgb(255,255,255)",this._ColorTable=t}GetColor(t){switch(this._ColorTable==null&&this.buildColorTable(),t){case-12:return this._ColorTable[279];case-11:return this._ColorTable[278];case-10:return this._ColorTable[280];case-8:return this._ColorTable[272];case-7:return this._ColorTable[273];case-4:return this._ColorTable[274];case-3:return this._ColorTable[275];case 49:case-2:return this._ColorTable[276];case 39:case-1:return this._ColorTable[277];case 0:case 30:return this._ColorTable[0];case 1:case 31:return this._ColorTable[1];case 2:case 32:return this._ColorTable[2];case 3:case 33:return this._ColorTable[3];case 4:case 34:return this._ColorTable[4];case 5:case 35:return this._ColorTable[5];case 6:case 36:return this._ColorTable[6];case 7:case 37:return this._ColorTable[7];case 40:return this._ColorTable[264];case 41:return this._ColorTable[265];case 42:return this._ColorTable[266];case 43:return this._ColorTable[267];case 44:return this._ColorTable[268];case 45:return this._ColorTable[269];case 46:return this._ColorTable[270];case 47:return this._ColorTable[271];case 8:case 90:case 100:case 300:case 400:return this._ColorTable[8];case 9:case 91:case 101:case 310:case 410:return this._ColorTable[9];case 10:case 92:case 102:case 320:case 420:return this._ColorTable[10];case 11:case 93:case 103:case 330:case 430:return this._ColorTable[11];case 12:case 94:case 104:case 340:case 440:return this._ColorTable[12];case 13:case 95:case 105:case 350:case 450:return this._ColorTable[13];case 14:case 96:case 106:case 360:case 460:return this._ColorTable[14];case 15:case 97:case 107:case 370:case 470:return this._ColorTable[15];case 4e3:case 3e3:return this._ColorTable[256];case 4100:case 3100:return this._ColorTable[257];case 4200:case 3200:return this._ColorTable[258];case 4300:case 3300:return this._ColorTable[259];case 4400:case 3400:return this._ColorTable[260];case 4500:case 3500:return this._ColorTable[261];case 4600:case 3600:return this._ColorTable[262];case 4700:case 3700:return this._ColorTable[263];default:return t<=-16&&(t+=16,t*=-1),t>=0&&t<281?this._ColorTable[t]:this._ColorTable[277]}}SetColor(t,e){this._ColorTable==null&&this.buildColorTable(),!(t<0||t>=this._ColorTable.length)&&(e=new Z(e),e.ok&&(this._ColorTable[t]=e.toRGB()))}AddLine(t,e,n,s,i,o){let r={raw:e,line:t,fragment:n,gagged:s,formats:this.pruneFormats(i,t.length,n),remote:o};this.emit("add-line",r),this.EndOfLine=!n}pruneFormats(t,e,n){if(!t||t.length<2)return t;let s=t.length,i=[];for(let o=0;o<s;o++){let r=t[o],a;if(o<s-1){let l=t[o+1];if(r.offset===l.offset&&l.formatType===r.formatType||(a=l.offset,r.formatType===1&&a-r.offset===0&&l.formatType===2)||r.formatType===7&&a-r.offset===0&&l.formatType===8||r.formatType===3&&a-r.offset===0&&l.formatType===4)continue}else if(!n&&r.offset===e&&e!==0&&(r.formatType===0&&!r.hr||r.formatType===1||r.formatType===7||r.formatType===3))continue;i.push(r)}return i}GetEntity(t){return t==="text"?t:this.mxpEntities[t]?(this.mxpState.expanded=!0,this.mxpEntities[t].value):t}ClearMXPToTag(t,e,n){e==null&&(e="");let s=new Me;s.tag=0;let i=this.mxpStyles.length-1;for(;i>=0&&(this.mxpStyles[i].tag!==t&&this.mxpStyles[i].custom!==e);i--){if(!this.mxpStyles[i].open&&!n)continue;s=this.mxpStyles.splice(i,1)[0]}return i>=0&&this.mxpStyles.length>0?s=this.mxpStyles.splice(i,1)[0]:this.mxpStyles.length===0&&this.ResetMXP(),s}ClearMXPOpen(){let t=this.mxpStyles.length;for(;t--;)this.mxpStyles[t].open&&this.mxpStyles.splice(t,1);this.mxpStyles.length===0&&this.ResetMXP()}getMXPOpenFormatBlocks(){if(!this.mxpState.on)return[];let t=0,e=this.mxpStyles.length,n=[];for(;t<e;t++)(this.mxpStyles[t].tag===22||this.mxpStyles[t].tag===23)&&n.push(Object.assign({},this.mxpStyles[t].properties));return n}getMXPCloseFormatBlocks(){if(!this.mxpState.on)return[];let t=this.mxpStyles.length,e=[];for(;t--;)this.mxpStyles[t].tag===22?e.push({formatType:4}):this.mxpStyles[t].tag===23&&e.push({formatType:8});return e}getMXPBlock(t,e,n,s,i){let o,r,a,l,f,u,b=e.length,h,E,S,p="",g="",C="",P=!1;switch(t=t.toUpperCase(),this.enableDebug&&(this.emit("debug","MXP Tag: "+t),this.emit("debug","MXP Tag Args: "+e)),t){case"C":case"COLOR":if(o=this.CloneCurrentStyle(),o.tag=K[t],o.open=!0,b>0)if(r=e[0].split("="),r.length>1){if(f=new Z(B(r[1])),!f.ok)return null;r[0].toUpperCase()==="BACK"?o.back=f.toRGB():o.fore=f.toRGB()}else f=new Z(B(r[0])),f.ok&&(o.fore=f.toRGB());if(b>1)if(r=e[1].split("="),r.length>1){if(f=new Z(B(r[1])),!f.ok)return null;r[0].toUpperCase()==="FORE"?o.fore=f.toRGB():o.back=f.toRGB()}else f=new Z(B(r[0])),f.ok&&(o.back=f.toRGB());return o.custom="",this.mxpStyles.push(o),null;case"B":case"BOLD":case"STRONG":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=K[t],o.style|=1,o.custom="",this.mxpStyles.push(o),null;case"FONT":for(o=this.CloneCurrentStyle(),o.open=!0,o.tag=K[t],u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"SIZE":this.isNumber(r[1])?o.fontSize=r[1]+"pt":o.fontSize=r[1]||0;break;case"COLOR":for(l=r[1].split(","),f=new Z(B(l[0])),f.ok&&(o.fore=f.toRGB()),S=1,E=l.length;S<E;S++)switch(l[S].toLowerCase()){case"bold":o.style|=1;break;case"italic":o.style|=4;break;case"underline":o.style|=8;break;case"blink":o.style|=16;break;case"inverse":o.style|=64;break;case"hidden":o.style|=128;break;case"strikeout":o.style|=256;break;case"overline":o.style|=1024;break;case"doubleunderline":o.style|=512;break}break;case"BACK":f=new Z(B(r[1])),f.ok&&(o.back=f.toRGB());break;case"FACE":o.font=B(r[1])||0;break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+r[0]);break}else u===0?o.font=B(e[u])||0:u===1?this.isNumber(e[u])?o.fontSize=e[u]+"pt":o.fontSize=e[u]||0:u===2?(f=new Z(B(e[u])),f.ok&&(o.fore=f.toRGB())):u===3&&(f=new Z(B(e[u])),f.ok&&(o.back=f.toRGB()));return o.custom="",this.mxpStyles.push(o),null;case"H":case"HIGH":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=K[t],o.high=!0,o.custom="",this.mxpStyles.push(o),null;case"I":case"ITALIC":case"EM":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=K[t],o.style|=4,o.custom="",this.mxpStyles.push(o),null;case"U":case"UNDERLINE":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=K[t],o.style|=8,o.custom="",this.mxpStyles.push(o),null;case"S":case"STRIKEOUT":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=K[t],o.style|=256,o.custom="",this.mxpStyles.push(o),null;case"/B":case"/BOLD":case"/STRONG":case"/H":case"/HIGH":case"/I":case"/ITALIC":case"/EM":case"/U":case"/UNDERLINE":case"/S":case"/STRIKEOUT":case"/C":case"/COLOR":case"/FONT":return this.ClearMXPToTag(K[t.substring(1)]),null}if(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4)switch(t){case"IMAGE":for(h={formatType:5,name:"",url:this.DefaultImgUrl,t:"",h:"",w:"",hspace:"",vspace:"",align:"bottom",ismap:!1},u=0;u<b;u++)switch(r=e[u].split("="),r[0].toUpperCase()){case"FNAME":h.name=B(r[1]);break;case"URL":h.url=B(r[1]);break;case"TYPE":case"T":r[1].length>0&&(h.type=r[1]);break;case"HEIGHT":case"H":h.h=B(r[1]);break;case"WIDTH":case"W":h.w=B(r[1]);break;case"HSPACE":h.hspace=r[1];break;case"VSPACE":h.vspace=r[1];break;case"ALIGN":h.align=r[1].toLowerCase();break;case"ISMAP":h.ismap=!0;break;default:u===0?h.name=B(e[u]):u===1?h.url=B(e[u]):u===2&&e[u].length>0?h.type=e[u]:u===3?h.h=B(e[u]):u===4?h.w=B(e[u]):u===5?h.hspace=e[u]:u===6?h.vspace=e[u]:u===7&&(h.align=e[u].toLowerCase());break}return{format:h,text:null};case"!AT":case"!ATTLIST":if(e.length===0||(h=e[0],!this.mxpElements[h]||this.mxpEntities[h].remote!==h.remote&&!this.mxpEntities[h].open))return null;for(this.mxpElements[h].attributes={},this.mxpElements[h].attributeIndexes=[],u=1;u<b;u++)l=e[u].split("="),l.length>1?this.mxpElements[h].attributes[l[0].toLowerCase()]=l[1]:this.mxpElements[h].attributes[l[0].toLowerCase()]="",this.mxpElements[h].attributeIndexes.push(l[0].toLowerCase());break;case"!TAG":for(h=new st,h.remote=n,u=0;u<b;u++)switch(r=e[u].split("="),r[0].toUpperCase()){case"WINDOWNAME":h.window=B(r[1]);break;case"FORE":f=new Z(B(r[1])),f.ok&&(h.fore=f.toRGB());break;case"BACK":f=new Z(B(r[1])),f.ok&&(h.back=f.toRGB());break;case"GAG":h.gag=!0;break;case"ENABLE":h.enabled=!0;break;case"DISABLE":h.enabled=!1;break;default:u===0?(o=+e[u],isNaN(o)||(h.index=o)):u===1?h.window=B(e[u]):u===2?(f=new Z(B(e[u])),f.ok&&(h.fore=f.toRGB())):u===3&&(f=new Z(B(e[u])),f.ok&&(h.back=f.toRGB()));break}h.fore.length>0&&h.back.length>0?h.definition=`<C "${h.fore}" "${h.back}">`:h.fore.length>0?h.definition=`<C "${h.fore}">`:h.back.length>0&&(h.definition=`<C BACK="${h.fore}">`),h.definition.length>0&&(h.closeDefinition="</C>"),this.mxpLines[h.index]?(h.remote||this.mxpLines[h.index].remote===h.remote)&&(this.mxpLines[h.index]=h):this.mxpLines[h.index]=h;break;case"!EL":case"!ELEMENT":for(h=new St(n),u=0;u<b;u++){if(e[u].toUpperCase().startsWith("ATT=")){for(r=B(e[u]).substring(4).split(" "),S=0,E=r.length;S<E;S++)l=B(r[S]).split("="),l.length>1?h.attributes[l[0].toLowerCase()]=B(l[1]):h.attributes[l[0].toLowerCase()]="",h.attributeIndexes.push(l[0].toLowerCase());continue}switch(r=e[u].split("="),r[0].toUpperCase()){case"TAG":o=+r[1],isNaN(o)||(h.tag=o);break;case"FLAG":h.flag=B(r[1]);break;case"OPEN":h.open=!0;break;case"DELETE":return this.mxpElements[h.name]&&(this.mxpEntities[h.name].remote===h.remote||this.mxpEntities[h.name].open)&&delete this.mxpEntities[h.name],null;case"EMPTY":h.empty=!0;break;case"SECURE":h.open=!1;break;default:if(u===0)h.name=B(e[u]).toUpperCase();else if(u===1)h.definition=B(e[u]),h.closeDefinition=this.GetCloseTags(h.definition),this.enableDebug&&this.emit("debug","MXP close definition: "+h.closeDefinition);else if(u===2)for(r=e[u].substring(4).split(" "),S=0,E=r.length;S<E;S++)l=r[S].split("="),l.length>1?h.attributes[l[0]]=l[1]:h.attributes[l[0]]="",h.attributeIndexes.push(l[0]);else u===3?(o=+e[u],isNaN(o)||(h.tag=o)):u===4&&(h.flag=B(e[u]));break}}h.tag>19&&h.tag<100&&(o=new st(h.tag),o.element=h.name,this.mxpLines[o.index]?(h.remote||this.mxpLines[o.index].remote===h.remote)&&(this.mxpLines[o.index]=o):this.mxpLines[o.index]=o),this.mxpElements[h.name]?(this.mxpElements[h.name].remote===h.remote||this.mxpEntities[h.name].open)&&(this.mxpElements[h.name]=h):this.mxpElements[h.name]=h;break;case"!EN":case"!ENTITY":for(h=new it(n),u=0;u<b;u++)switch(r=e[u].split("="),r[0].toUpperCase()){case"DESC":h.description=B(r[1]);break;case"PRIVATE":h.publish=!1;break;case"PUBLISH":h.publish=!0;break;case"DELETE":return this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote&&delete this.mxpEntities[h.name],null;case"ADD":if(this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote)return this.mxpEntities[h.name].value?this.mxpEntities[h.name].value+="|"+h.value:this.mxpEntities[h.name].value=h.value,null;break;case"REMOVE":if(this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote&&this.mxpEntities[h.name].value){for(l=this.mxpEntities[h.name].value.split("|"),a=[],S=0,E=l.length;S<E;S++)l[S]!==h.value&&a.push(l[S]);this.mxpEntities[h.name].value=a.join("|")}return null;default:u===0?h.name=B(e[u]):u===1?h.value=B(e[u]):u===2&&(h.description=B(e[u]));break}this.mxpEntities[h.name]?this.mxpEntities[h.name].remote===h.remote&&(this.mxpEntities[h.name]=h):this.mxpEntities[h.name]=h;break;case"/V":case"/VAR":for(o=this.ClearMXPToTag(K[t.substring(1)]),h=new it(n),this.mxpState.captured.length>0?h.value=this.mxpState.captured.pop().join(""):h.value="",this.mxpState.capture--,this.enableDebug&&this.emit("debug","MXP captured: "+h.value),e=o.obj,b=e.length,u=0;u<b;u++)switch(r=e[u].split("="),r[0].toUpperCase()){case"DESC":h.description=B(r[1]);break;case"PRIVATE":h.publish=!1;break;case"PUBLISH":h.publish=!0;break;case"DELETE":return this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote&&delete this.mxpEntities[h.name],null;case"ADD":if(this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote)return this.mxpEntities[h.name].value?this.mxpEntities[h.name].value+="|"+h.value:this.mxpEntities[h.name].value=h.value,null;break;case"REMOVE":if(this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote&&this.mxpEntities[h.name].value){for(l=this.mxpEntities[h.name].value.split("|"),a=[],S=0,E=l.length;S<E;S++)l[S]!==h.value&&a.push(l[S]);this.mxpEntities[h.name].value=a.join("|")}return null;default:u===0?h.name=B(e[u]):u===1&&(h.description=B(e[u]));break}this.mxpEntities[h.name]?this.mxpEntities[h.name].remote===h.remote&&(this.mxpEntities[h.name]=h):this.mxpEntities[h.name]=h;break;case"V":case"VAR":return this.mxpState.captured.push([]),this.mxpState.capture++,o=this.CloneCurrentStyle(),o.open=!1,o.tag=K[t],o.obj=e,o.custom="",this.mxpStyles.push(o),null;case"GAUGE":for(h={value:0,max:1,caption:"",color:0},u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"VALUE":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),h.value=o;break;case"MAX":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),h.max=o;break;case"CAPTION":r[1].length>0&&(h.caption=B(r[1]));break;case"COLOR":f=new Z(B(r[1])),f.ok&&(h.color=f.toRGB());break}else u===0?(o=parseFloat(this.GetEntity(e[u])),isNaN(o)&&(o=this.GetEntity(e[u])),h.value=o):u===1?(o=parseFloat(this.GetEntity(e[u])),isNaN(o)&&(o=this.GetEntity(e[u])),h.max=o):u===2&&e[u].length>0?h.caption=B(e[u]):u===3&&e[u].length>0&&(f=new Z(B(r[1])),f.ok&&(h.color=f.toRGB()));this.mxpState.expanded=!1,this.emit("gauge",h);break;case"STAT":for(h={value:0,max:1,caption:""},u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"VALUE":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),h.value=o;break;case"MAX":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),h.max=o;break;case"CAPTION":r[1].length>0&&(h.caption=B(r[1]));break}else u===0?(o=parseFloat(this.GetEntity(e[u])),isNaN(o)&&(o=this.GetEntity(e[u])),h.value=o):u===1?(o=parseFloat(this.GetEntity(e[u])),isNaN(o)&&(o=this.GetEntity(e[u])),h.max=o):u===2&&e[u].length>0&&(h.caption=B(e[u]));this.mxpState.expanded=!1,this.emit("stat",h);break;case"MUSIC":for(h={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"FNAME":h.file=B(r[1]),h.file.toLowerCase()==="off"&&(h.off=!0,h.file="");break;case"V":o=+r[1],isNaN(o)&&(o=100),h.volume=o;break;case"L":o=+r[1],isNaN(o)&&(o=1),h.repeat=o;break;case"C":h.continue=r[1]!=="0";break;case"T":r[1].length>0&&(h.type=r[1]);break;case"U":h.url=B(r[1]),!h.url.endsWith("/")&&h.url.length>0&&(h.url+="/");break}else u===0?(h.file=B(e[u]),h.file.toLowerCase()==="off"&&(h.off=!0,h.file="")):u===1?(o=+e[u],isNaN(o)&&(o=100),h.volume=o):u===2?(o=+e[u],isNaN(o)&&(o=1),h.repeat=o):u===3?h.continue=e[u]!=="0":u===4?e[u].length>0&&(h.type=e[u]):u===5&&(h.url=B(e[u]),!h.url.endsWith("/")&&h.url.length>0&&(h.url+="/"));this.emit("music",h);break;case"SOUND":for(h={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"FNAME":h.file=B(r[1]),h.file.toLowerCase()==="off"&&(h.off=!0,h.file="");break;case"V":o=+r[1],isNaN(o)&&(o=100),h.volume=o;break;case"L":o=+r[1],isNaN(o)&&(o=1),h.repeat=o;break;case"P":o=+r[1],isNaN(o)&&(o=1),h.priority=o;break;case"T":r[1].length>0&&(h.type=r[1]);break;case"U":h.url=B(r[1]),!h.url.endsWith("/")&&h.url.length>0&&(h.url+="/");break}else u===0?(h.file=B(e[u]),h.file.toLowerCase()==="off"&&(h.off=!0,h.file="")):u===1?(o=+e[u],isNaN(o)&&(o=100),h.volume=o):u===2?(o=+e[u],isNaN(o)&&(o=1),h.repeat=o):u===3?(o=+e[u],isNaN(o)&&(o=1),h.priority=o):u===4?e[u].length>0&&(h.type=e[u]):u===5&&(h.url=B(e[u]),!h.url.endsWith("/")&&h.url.length>0&&(h.url+="/"));this.emit("sound",h);break;case"EXPIRE":this.emit("expire-links",e),this.cleanMXPExpired(i,e?.[0]||"");break;case"VERSION":b>0?this.StyleVersion=e[0]:this.emit("MXP-tag-reply",t,[]);break;case"USER":case"PASSWORD":this.emit("MXP-tag-reply",t,e);break;case"SUPPORT":if(l=[],b>0)for(u=0;u<b;u++)if(r=B(e[u]),r.indexOf(".")===-1)switch(r=r.toUpperCase(),r){case"IMAGE":case"HR":case"A":case"SEND":case"B":case"I":case"COLOR":case"C":case"EM":case"ITALIC":case"STRONG":case"BOLD":case"UNDERLINE":case"U":case"S":case"STRIKEOUT":case"STRIKE":case"H":case"HIGH":case"EXPIRE":case"VERSION":case"SUPPORT":case"NOBR":case"P":case"BR":case"SBR":case"SOUND":case"MUSIC":case"VAR":case"USER":case"PASSWORD":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"RESET":case"GAUGE":case"STAT":l.push("+"+name);break;default:l.push("-"+name);break}else switch(r=e[u].split("."),r[0]=r[0].toUpperCase(),r[0]){case"IMAGE":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+image.fname"),l.push("+image.url"),l.push("+image.t"),l.push("+image.h"),l.push("+image.w"),l.push("+image.hspace"),l.push("+image.vspace"),l.push("+image.align"),l.push("+image.ismap"));break;case"SOUND":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+sound.v"),l.push("+sound.l"),l.push("+sound.p"),l.push("+sound.t"),l.push("+sound.u"));break;case"MUSIC":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+music.v"),l.push("+music.l"),l.push("+music.c"),l.push("+music.t"),l.push("+music.u"));break;case"A":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+a.href"),l.push("+a.hint"),l.push("+a.expire"));break;case"SEND":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+send.href"),l.push("+send.hint"),l.push("+send.prompt"),l.push("+send.expire"));break;case"COLOR":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+color.fore"),l.push("+color.back"));break;case"C":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+c.fore"),l.push("+c.back"));break;case"FONT":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("-font.face"),l.push("-font.size"),l.push("+font.color"),l.push("+font.back"));break;case"EXPIRE":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):l.push("+expire.Name");break;case"GAUGE":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+gauge.max"),l.push("+gauge.caption"),l.push("+gauge.color"));break;case"STAT":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+stat.max"),l.push("+stat.caption"));break;default:r[1]!=="*"?l.push("-"+r[0]+"."+r[1]):l.push("-"+r[0]);break}else l=["+A","+SEND","+B","+I","+COLOR","+C","+EM","+ITALIC","+STRONG","+BOLD","+UNDERLINE","+U","+S","+STRIKEOUT","+H","+HIGH","-FONT","+EXPIRE","+VERSION","+SUPPORT","+NOBR","+P","+BR","+SBR","+VAR","+SOUND","+MUSIC","+USER","+PASSWORD","+RESET","+STRIKE","+H1","+H2","+H3","+H4","+H5","+H6","+IMAGE","+STAT","+GAUGE"];this.emit("MXP-tag-reply",t,l);break;case"A":for(o=this.CloneCurrentStyle(),o.open=!1,o.tag=K[t],u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"HREF":p=B(r[1]);break;case"HINT":g=B(r[1]);break;case"EXPIRE":C=B(r[1]);break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+r[0]);break}else u===0?p=B(e[u]):u===1?g=B(e[u]):u===2&&(C=B(e[u]));return o.custom="",o.properties={formatType:3,href:p,hint:g,expire:C},this.mxpStyles.push(o),g.length===0&&(g=p),{format:{formatType:3,href:p,hint:g,expire:C},text:null};case"SEND":for(o=this.CloneCurrentStyle(),o.open=!1,o.tag=K[t],u=0;u<b;u++)if(r=e[u].split("="),r[0]==="PROMPT")P=!0;else if(r.length>1)switch(r[0].toUpperCase()){case"HREF":p=B(r[1]);break;case"HINT":g=B(r[1]);break;case"EXPIRE":C=B(r[1]);break;case"PROMPT":P=!0;break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+r[0]);break}else u===0?p=B(e[u]):u===1?g=B(e[u]):u===2?P=!0:u===3&&(C=B(e[u]));o.custom="",this.mxpStyles.push(o),p.length===0&&(p="&text;"),g.length===0&&(g=p);let x=p.split("|"),G;if(x.length>1){let y=g.split("|");y.length===x.length+1&&(g=y[0],y.shift(),G="['"+y.join("','")+"']"),p="['"+x.join("','")+"']"}else p="'"+p+"'";return o.properties={formatType:7,href:p,hint:g,expire:C,prompt:P,tt:G||""},{format:{formatType:7,href:p,hint:g,expire:C,prompt:P,tt:G||""},text:null};case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=K[t],o.style|=1,o.custom="",this.mxpStyles.push(o),null;case"/A":return this.ClearMXPToTag(K[t.substring(1)]),{format:{formatType:4},text:null};case"/SEND":return this.ClearMXPToTag(K[t.substring(1)]),{format:{formatType:8},text:null};case"/H1":case"/H2":case"/H3":case"/H4":case"/H5":case"/H6":return this.ClearMXPToTag(K[t.substring(1)]),null;case"NOBR":return this.mxpState.noBreak=!0,null;case"/P":return this.ClearMXPToTag(K[t.substring(1)]),this.mxpState.paragraph=!1,null;case"P":return o=this.CloneCurrentStyle(),o.open=!1,o.tag=K[t],o.custom="",this.mxpStyles.push(o),this.mxpState.paragraph=!0,null;case"SBR":return{format:null,text:" \u200B"};case"RESET":return this.ResetMXP(),null;case"HR":let M=this.GetCurrentStyle(),_=this.getColors(M);return{format:{formatType:0,offset:0,color:_.fore,background:_.back,size:M.fontSize,font:M.font,style:M.style|this._CurrentAttributes&-2,hr:!0},text:null}}if(this.mxpElements[t]){if(h=this.mxpElements[t],!h.open&&this.mxpState.lineType!==1&&this.mxpState.lineType!==6&&this.mxpState.lineType!==4)return null;for(o=this.CloneCurrentStyle(),o.open=h.open,o.tag=38,o.custom=h.name,r=h.definition,l={},S=0,E=h.attributeIndexes.length;S<E;S++)l[h.attributeIndexes[S]]=h.attributes[h.attributeIndexes[S]];for(u=0;u<b;u++)a=e[u].split("="),a[0]=a[0].toLowerCase(),h.attributes[a[0]]?l[a[0]]=a[1]:u<h.attributeIndexes.length&&(l[h.attributeIndexes[u]]=a[0]);for(a in l)l.hasOwnProperty(a)&&(r=r.replace("&"+a+";",l[a]));return h.empty||(this.mxpState.captured.push([]),this.mxpState.capture++),h.tag>19&&h.tag<100&&this.mxpLines[h.tag].enabled&&this.mxpLines[h.tag].definition.length>0&&(r=this.mxpLines[h.tag].definition+r,o.gagged=this.mxpLines[h.tag].gag),this.mxpState.gagged=o.gagged,this.mxpState.expanded=!0,{format:null,text:r}}else if(t.startsWith("/")&&this.mxpElements[t.substring(1)]&&!this.mxpElements[t.substring(1)].empty)return t=t.substring(1),h=this.mxpElements[t],!h.open&&this.mxpState.lineType!==1&&this.mxpState.lineType!==6&&this.mxpState.lineType!==4||(!h.empty&&this.mxpState.capture>0&&(this.mxpState.captured.length>0&&(a=this.mxpState.captured.pop().join("")),this.mxpState.capture--),r=h.closeDefinition,h.flag.length>0&&(h.flag.length>4&&h.flag.toLowerCase().startsWith("set ")&&this.emit("set-variable",h.flag.substring(4),a),this.emit("MXP-flag",h.flag,a)),h.tag>19&&h.tag<100&&this.mxpLines[h.tag].enabled&&this.mxpLines[h.tag].closeDefinition.length>0&&(r+=this.mxpLines[h.tag].closeDefinition),this.mxpState.gagged=!h.gagged,h.empty)?null:(this.mxpState.expanded=!0,{format:null,text:r});if(this.showInvalidMXPTags){switch(t){case"IMAGE":case"!AT":case"!ATTLIST":case"!TAG":case"!EL":case"!ELEMENT":case"!EN":case"!ENTITY":case"/V":case"/VAR":case"V":case"VAR":case"GAUGE":case"STAT":case"MUSIC":case"SOUND":case"EXPIRE":case"VERSION":case"USER":case"PASSWORD":case"SUPPORT":case"A":case"SEND":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"/A":case"/SEND":case"/H1":case"/H2":case"/H3":case"/H4":case"/H5":case"/H6":case"NOBR":case"/P":case"P":case"SBR":case"RESET":case"HR":return null}return{format:null,text:"<"+s+">"}}return null}cleanMXPExpired(t,e){if(!t||t.length===0||e===null)return;let n=t.length;for(let s=0;s<n;s++){let i=t[s];if(!(i.formatType!==7&&i.formatType!==3)&&(e.length===0||i.expire===e)){let o,r=0,a=0,l=i.formatType;for(i.formatType===3?o=4:o=8,i.formatType=9;a<n;a++)if(t[a].formatType===o)if(r===0){t[a].formatType=10;break}else r--;else t[a]===l&&r++}}}GetCloseTags(t){if(typeof t>"u"||t.length===0)return"";let e=0,n=t.length,s=[],i=[],o,r=0;for(;e<n;e++)switch(o=t.charAt(e),r){case 1:o===" "?(s.push(i.join("")),i=[],r=2):o===">"?(s.push(i.join("")),i=[],r=0):i.push(o);break;case 2:o===">"&&(r=0);break;default:o==="<"&&(r=1);break}return r===1&&s.push(i.join("")),s.length===0?"":"</"+s.reverse().join("></")+">"}CloneCurrentStyle(){let t;return this.mxpStyles.length===0&&this.mxpStyles.push(new Me(0,"","",!1)),t=this.mxpStyles[this.mxpStyles.length-1],this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(t.gagged=this.mxpLines[this.mxpState.lineType].gag),Object.assign({},t)}GetCurrentStyle(){let t;return this.mxpStyles.length===0&&this.mxpStyles.push(new Me(0,"","",!1)),t=this.mxpStyles[this.mxpStyles.length-1],this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(t.gagged=this.mxpLines[this.mxpState.lineType].gag),t}DecreaseColor(t,e){let n=new Z(t);return n.ok?(n.b-=Math.ceil(n.b*e),n.b<0&&(n.b=0),n.g-=Math.ceil(n.g*e),n.g<0&&(n.g=0),n.r-=Math.ceil(n.r*e),n.r<0&&(n.r=0),n.toRGB()):t}IncreaseColor(t,e){let n=new Z(t);return n.ok?(n.b+=Math.ceil(n.b*e),n.b>255&&(n.b=255),n.g+=Math.ceil(n.g*e),n.g>255&&(n.g=255),n.r+=Math.ceil(n.r*e),n.r>255&&(n.r=255),n.toRGB()):t}MXPCapture(t){if(this.mxpState.capture<1)return;let e=this.mxpState.captured.length;for(let n=0;n<e;n++)this.mxpState.captured[n].push(t)}MXPDeCapture(t){if(this.mxpState.capture<1)return;let e=this.mxpState.captured.length;for(let n=0;n<e;n++)for(let s=0;s<t;s++)this.mxpState.captured[n].pop()}isNumber(t){return/^\d+$/.test(t)}CurrentAnsiCode(){let t="\x1B[";return typeof this._CurrentForeColor=="string"?t+="38;2;"+this._CurrentForeColor:this._CurrentForeColor<=-16?t+="38;5;"+(this._CurrentForeColor*-1-16)+";":t+=this._CurrentForeColor+";",typeof this._CurrentBackColor=="string"?t+="48;2;"+this._CurrentBackColor:this._CurrentBackColor<=-16?t+="38;5;"+(this._CurrentBackColor*-1-16)+";":t+=this._CurrentBackColor+";",this._CurrentAttributes>0&&((this._CurrentAttributes&64)===64&&(t+="7;"),(this._CurrentAttributes&1)===1&&(t+="1;"),(this._CurrentAttributes&4)===4&&(t+="3;"),(this._CurrentAttributes&8)===8&&(t+="4;"),(this._CurrentAttributes&16)===16&&(t+="5;"),(this._CurrentAttributes&32)===32&&(t+="6;"),(this._CurrentAttributes&256)===256&&(t+="9;"),(this._CurrentAttributes&2)===2&&(t+="2;"),(this._CurrentAttributes&512)===512&&(t+="21;"),(this._CurrentAttributes&1024)===1024&&(t+="53;")),t+"m"}get parseQueueLength(){return this.parsing.length}get parseQueueEndOfLine(){return this.parsing.length?this.parsing[this.parsing.length-1][0].endsWith(`
`):!1}parse(t,e,n,s){if(t==null||t.length===0)return t;if(e==null&&(e=!1),this.parsing.length>0&&!n){this.parsing.push([t,e,s]);return}let i="",o=null,r=null,a=[],l=[],f=[],u=0,b=0,h=0,E,S=0,p,g,C,P,x,G=!1;this.busy=!0,this.parsing.unshift([t,e,s]);let M;if(this._SplitBuffer.length>0&&(s?t=t+this._SplitBuffer:t=this._SplitBuffer+t,this._SplitBuffer=""),!this.EndOfLine&&(this.textLength>0||this.rawLength>0)){let w=this.display.lines;w.length>0?(E=this.display.lines[w.length-1].text,P=this.display.lines[w.length-1].raw,l.push.apply(l,this.display.lines[w.length-1].formats),this.display.removeLine(w.length-1,!0),M=l[l.length-1],M.formatType===1&&(l.pop(),M=l[l.length-1]),M.width=0,M.height=0,M.marginWidth=0,M.marginHeight=0,h=M.offset,M.offset!==0?(a.push(E.substring(0,M.offset)),E=E.substring(M.offset),(this.mxpState.locked||this.mxpState.on)&&(S=E.length),t=E+t):((this.mxpState.locked||this.mxpState.on)&&(S=E.length),t=E+t),P.endsWith(E)?f.push(P.substr(0,P.length-E.length)):f.push(P)):l.push(M=this.getFormatBlock(h)),w=null}else l.push(M=this.getFormatBlock(h));let _=0,y=t.length,d,v,U=this.emulateControlCodes,q=this.displayControlCodes,re=this.emulateTerminal,ie=this.enableURLDetection,Y=this.enableMSP,T=this.tabWidth,L=0,F=0,R=0,k=0,D=null,O,j=this.protocols.length;try{for(_=0;_<y;_++)switch(d=t.charAt(_),v=t.charCodeAt(_),_>=S&&f.push(d),this.rawLength++,u){case 2:if(d==="C"||d==="K"||d==="s"||d==="u"||d==="l"||d==="h"||d==="A"||d==="B"||d==="D"||d==="E"||d==="F"||d==="f"||d==="G"||d==="H"||d==="n"||d==="S"||d==="T"||d==="r")this.ClearMXPOpen(),this._SplitBuffer="",r=null,u=0;else if(d==="z"){p=r.split(";"),r=0;for(let w=p.length-1;w>=0;w--)if(p[w].length>0){r=p[0];break}switch(E=+r,isNaN(E)&&(E=0),this.mxpState.on=!0,this.mxpState.noBreak=!1,this.mxpState.paragraph=!1,this.mxpState.lineType===0&&this.ClearMXPOpen(),E){case 2:this.mxpState.on=!1,this.mxpState.locked=!1,this.mxpState.lineType=2,this.ClearMXPOpen();break;case 3:this.ResetMXP();break;case 4:if(this.mxpState.lineType=4,_+1>=y){this._SplitBuffer+=d;break}t.charAt(_+1)!=="<"&&(this.mxpState.lineType=0,this.mxpState.on=!1),this.mxpState.locked=!1,this.ClearMXPOpen();break;case 5:this.iMXPDefaultMode=0,this.mxpState.locked=!0,this.mxpState.lineType=5,this.ClearMXPOpen();break;case 6:this.iMXPDefaultMode=1,this.mxpState.lineType=6,this.mxpState.locked=!0,this.ClearMXPOpen();break;case 7:this.iMXPDefaultMode=2,this.mxpState.lineType=7,this.mxpState.locked=!0,this.ClearMXPOpen();break;default:E<0||E>99?this.ClearMXPOpen():(this.mxpState.lineType=E,this.mxpState.locked=!1,this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(E="",this.mxpLines[this.mxpState.lineType].element.length>0&&(E+="<"+this.mxpLines[this.mxpState.lineType].element+">"),this.mxpLines[this.mxpState.lineType].definition.length>0&&(E+=this.mxpLines[this.mxpState.lineType].definition),E.length>0&&(t=t.splice(_+1,E),y=t.length)));break}this._SplitBuffer="",r=null,u=0}else if(d==="J"){if(this.ClearMXPOpen(),r.length>0&&+r==2){h=0,E=this.window.height,l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),M=this.getFormatBlock(h),...this.getMXPCloseFormatBlocks()];for(let w=0;w<E;w++)this.AddLine("",`
`,!1,!1,l,e),this.MXPCapture(`
`);this.textLength+=E,this.mxpState.noBreak=!1}l=[...this.getMXPOpenFormatBlocks(),M=this.getFormatBlock(h)],this._SplitBuffer="",r=null,u=0}else d==="m"?(this.ProcessAnsiColorParams(r.split(";")),l.push(M=this.getFormatBlock(h)),this._SplitBuffer="",r=null,u=0):d===`
`||d==="\x1B"?(_--,f.pop(),this.rawLength--,u=0,this._SplitBuffer="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen()):(this._SplitBuffer+=d,r+=d);break;case 3:v===7?(this._SplitBuffer="",this.emit("set-title",i,o??0),i="",o=null,u=0):d===";"&&o==null?(o=+i,isNaN(o)&&(o=0),i="",this._SplitBuffer+=d):d==="\x1B"?this._SplitBuffer.charAt(this._SplitBuffer.length-1)===`
`&&(this._SplitBuffer=""):(this._SplitBuffer+=d,i+=d);break;case 1:d==="["?(this._SplitBuffer+=d,r="",u=2):d==="]"?(this._SplitBuffer+=d,i="",u=3):(d==="D"||d==="E"||d==="M"||d==="1"||d==="2"||d==="7"||d==="8"||d===">"||d==="="||d==="#")&&(q&&(a.push("\u241B"),v<16?(a.push(String.fromCharCode(parseInt("240"+v.toString(16),16))),this.MXPCapture("&#x241B&#x240"+v.toString(16)+";")):(a.push(String.fromCharCode(parseInt("24"+v.toString(16),16))),this.MXPCapture("&#x241B&#x24"+v.toString(16)+";")),h+=2,this.textLength+=2,this.mxpState.noBreak=!1),u=0,this._SplitBuffer="");break;case 4:if(p==="!--")_--,f.pop(),this.rawLength--,b=0,u=8,P="<!--",p="",x=[];else if(p.endsWith("<!--"))_--,f.pop(),this.rawLength--,b=u,u=8,P="<!--",p=p.substring(0,p.length-4),x=[];else if(d==='"')u=6,x[x.length-1]+=d,this._SplitBuffer+=d;else if(d==="'")u=5,x[x.length-1]+=d,this._SplitBuffer+=d;else if(d==="&")C="",b=u,u=7,this._SplitBuffer="";else if(d===`
`||d==="\x1B")_--,f.pop(),this.rawLength--,u=0,this._SplitBuffer="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen();else if(d===" ")u=9,x.push(""),this._SplitBuffer+=d;else if(d===">"){if(g=p,p=p.toUpperCase(),p==="HR"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))h>0&&(h=0,this.MXPCapture(`
`),l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),M=this.getFormatBlock(h)]),p=this.getMXPBlock(p,[],e),p&&p.format&&(p.format.offset=h,l.push(p.format),l[0].hr=p.format.hr),l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),this.textLength++,a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),M=this.getFormatBlock(h)];else if(p==="BR"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))this.MXPCapture(`
`),l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),G=!1,h=0,a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),M=this.getFormatBlock(h)],this.textLength++;else if(p==="IMAGE"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))p=this.getMXPBlock(p,x,e),p&&p.format!==null&&(l.push(p.format),h+=p.length,this.textLength+=p.length),l.push(M=this.getFormatBlock(h));else{if(p=this.getMXPBlock(p,[],e,g,l),this.mxpState.expanded){p&&p.text!==null&&(t=t.splice(_+1,p.text)),y=t.length,this.mxpState.expanded=!1,u=0,p="",this._SplitBuffer="";continue}p?(p.format&&(p.format.offset=h,l.push(p.format)),l.push(M=this.getFormatBlock(h)),p.text!==null&&p.text.length>0&&(a.push(p.text),h+=p.text.length,this.textLength+=p.text.length)):l.push(M=this.getFormatBlock(h))}u=0,this._SplitBuffer=""}else d==="<"?(this.enableDebug&&this.emit("debug","Malformed MXP Tag: "+p),_--,f.pop(),this.rawLength--,a.push("<"+p),h+=p.length+1,this.textLength+=p.length+1,u=0,this._SplitBuffer=""):(this._SplitBuffer+=d,p+=d);break;case 5:d==="'"?(u=9,this._SplitBuffer+=d,x[x.length-1]+=d):(this._SplitBuffer+=d,x[x.length-1]+=d);break;case 6:d==='"'?(u=9,this._SplitBuffer+=d,x[x.length-1]+=d):(this._SplitBuffer+=d,x[x.length-1]+=d);break;case 9:if(d==="'")u=5,x[x.length-1]+=d,this._SplitBuffer+=d;else if(d==='"')u=6,x[x.length-1]+=d,this._SplitBuffer+=d;else if(d===`
`||d==="\x1B")_--,f.pop(),this.rawLength--,u=0,this._SplitBuffer="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen();else if(d===" ")u=9,x.push(""),this._SplitBuffer+=d;else if(d===">"){if(p.toUpperCase()==="IMAGE"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))p=this.getMXPBlock(p,x,e,p),p!==null&&p.format!==null&&(p.format.offset=h,l.push(p.format)),l.push(M=this.getFormatBlock(h));else{if(p=this.getMXPBlock(p,x,e,p,l),this.mxpState.expanded){p!==null&&(t=t.splice(_+1,p.text)),y=t.length,this.mxpState.expanded=!1,u=0,this._SplitBuffer="";continue}p!==null?(p!==null&&p.format&&(p.format.offset=h,l.push(p.format)),l.push(M=this.getFormatBlock(h)),p.text!==null&&(a.push(p.text),h+=p.text.length,this.textLength+=p.text.length)):l.push(M=this.getFormatBlock(h))}u=0,this._SplitBuffer=""}else this._SplitBuffer+=d,x[x.length-1]+=d;break;case 7:if(d===`
`||d==="\x1B"){if(_--,f.pop(),this.rawLength--,this.enableDebug&&this.emit("debug","MXP Entity: "+C),b===4)p+="&"+C,u=b;else{if(C=this.GetEntity(C),this.mxpState.expanded){p!==null&&(t=t.splice(_+1,C)),y=t.length,this.mxpState.expanded=!1,u=0,this._SplitBuffer="";continue}g=ft("&"+C),a.push(g),this.MXPCapture("&"+C),h+=g.length,this.textLength+=g.length,this.mxpState.noBreak=!1,u=0,this._SplitBuffer="",M.unicode=!0}this.mxpState.on&&d===`
`&&this.ClearMXPOpen()}else if(d===";"){if(this.enableDebug&&this.emit("debug","MXP Entity: "+C),b!==4){if(C=this.GetEntity(C),this.mxpState.expanded){t=t.splice(_+1,C),y=t.length,this.mxpState.expanded=!1,u=b,this._SplitBuffer="";continue}g=ft("&"+C+";"),a.push(g),this.MXPCapture("&"),this.MXPCapture(C),this.MXPCapture(";"),h+=g.length,this.textLength+=g.length,this.mxpState.noBreak=!1,this._SplitBuffer=""}else p+="&"+C+";";M.unicode=!0,u=b}else d==="&"?(this.enableDebug&&this.emit("debug","Malformed MXP Entity: "+C),b!==4?(a.push("&"+C),this.MXPCapture("&"),this.MXPCapture(C),h+=C.length+1,this.textLength+=C.length+1,this.mxpState.noBreak=!1,this._SplitBuffer="",_--,f.pop(),this.rawLength--):p+="&"+C,M.unicode=!0,u=b):(this._SplitBuffer+=d,C+=d);break;case 8:P.endsWith("-->")?(this.enableDebug&&this.emit("debug","MXP Comment: "+P),_--,f.pop(),this.rawLength--,u=b,u===0&&(this._SplitBuffer=""),P=""):d===`
`||d==="\x1B"?(this.enableDebug&&this.emit("debug","MXP Comment: "+P),_--,f.pop(),this.rawLength--,u=b,P="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen()):P+=d;break;case 10:if(_>L+2)a.pop(),a.pop(),f.pop(),f.pop(),this.rawLength-=2,h-=2,this.textLength-=2,this.MXPDeCapture(2),_=L,u=0;else if(d==="/"){if(a.push(d),this.MXPCapture(d),h++,this.textLength++,_===L+2){for(u=11,L=a.length-4,k=a.length-1,F=l.length,R-=2;L>0&&ze(a[L],!0);)L--,R--;ze(a[L],!0)||(L++,R++),D=[],L>0&&a[L-1]==="("&&D.push(")"),L>0&&a[L-1]==="["&&D.push("]")}}else _>L+1?(a.pop(),f.pop(),this.rawLength--,h--,this.textLength--,this.MXPDeCapture(1),_=L,u=0):(_=L,u=0,f.pop(),this.rawLength--);break;case 11:ze(d,!1)?D.length>1&&D[D.length-1]===d?(D.pop(),a.push(d),this.MXPCapture(d),h++,this.textLength++,v>255&&(M.unicode=!0)):D.length>0&&d==="("?(D.push(")"),a.push(d),this.MXPCapture(d),h++,this.textLength++,v>255&&(M.unicode=!0)):D.length>0&&d==="["?(D.push("]"),a.push(d),this.MXPCapture(d),h++,this.textLength++,v>255&&(M.unicode=!0)):D.length===1&&D[D.length-1]===d?(k!==a.length-1&&(P+=a.slice(L).join(""),this.enableDebug&&this.emit("debug","URL Found: "+P),l.splice(F,0,{formatType:1,href:P,offset:R}),l.push({formatType:2,href:P,offset:h}),l.push(M=this.getFormatBlock(h))),u=0,_--,f.pop(),this.rawLength--):(v>255&&(M.unicode=!0),a.push(d),this.MXPCapture(d),h++,this.textLength++):(k!==a.length-1&&(P+=a.slice(L).join(""),this.enableDebug&&this.emit("debug","URL Found: "+P),l.splice(F,0,{formatType:1,offset:R,href:P}),l.push({formatType:2,offset:h,href:P}),l.push(M=this.getFormatBlock(h))),u=0,_--,f.pop(),this.rawLength--);break;case 12:d===")"?(L=this.mxpState.lineType,this.mxpState.lineType=4,this.getMXPBlock("SOUND",x,e),this.mxpState.lineType=L,u=0,_+1<y&&t.charAt(_+1)===`
`?(_++,G=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),M=this.getFormatBlock(h)],this.mxpState.noBreak=!1,h=0):_+2<y&&t[_+1]==="\r"&&t[_+2]===`
`&&(_+=2,G=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),M=this.getFormatBlock(h)],this.mxpState.noBreak=!1,h=0)):d===" "?x.push(""):x[x.length-1]+=d;break;case 13:d===")"?(L=this.mxpState.lineType,this.mxpState.lineType=4,this.getMXPBlock("MUSIC",x,e),this.mxpState.lineType=L,u=0,_+1<y&&t.charAt(_+1)===`
`?(_++,G=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),M=this.getFormatBlock(h)],this.mxpState.noBreak=!1,h=0):_+2<y&&t[_+1]==="\r"&&t[_+2]===`
`&&(_+=2,G=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),M=this.getFormatBlock(h)],this.mxpState.noBreak=!1,h=0)):d===" "?x.push(""):x[x.length-1]+=d;break;default:if(U&&v===7)re?(d="\u2407",a.push(d),this.MXPCapture(d),h++,this.textLength++,this.mxpState.noBreak=!1):q&&(a.push(d),this.MXPCapture("&#x2407;"),h++,this.textLength++,this.mxpState.noBreak=!1),this.emit("bell");else if(U&&d==="\b"){if(G=!1,h>0){if(a.length){for(;a[a.length-1].length===0;)a.pop();a[a.length-1].length===1?a.pop():a[a.length-1]=a[a.length-1].substring(0,a[a.length-1].length-1)}M.offset===h&&M.offset--,h--,this.textLength--}q&&(d="\u25D8",a.push(d),this.MXPCapture(d),h++,this.textLength++),this.mxpState.noBreak=!1}else if(U&&d==="	"){let w=T-h%T;w>0&&(a.push(Array(w+1).join(" ")),this.MXPCapture(Array(w+1).join(" ")),h+=w,this.textLength+=w,this.mxpState.noBreak=!1)}else if(d===`
`){if(this.mxpState.noBreak||this.mxpState.paragraph)continue;if(this.mxpState.locked)l.push(...this.getMXPCloseFormatBlocks()),this.mxpState.on&&this.ClearMXPOpen();else{if(this.mxpState.lineType!==0&&this.emit("MXP-tag-end",this.mxpState.lineType,a.join(""),l),!this.mxpState.lineExpanded&&this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(E="",this.mxpLines[this.mxpState.lineType].element.length>0&&(E+="</"+this.mxpLines[this.mxpState.lineType].element+">"),this.mxpLines[this.mxpState.lineType].closeDefinition.length>0&&(E+=this.mxpLines[this.mxpState.lineType].closeDefinition),E.length>0)){t=t.splice(_,E),y=t.length,_--,f.pop(),this.rawLength--,this.mxpState.lineExpanded=!0;continue}this.mxpState.lineExpanded=!1,l.push(...this.getMXPCloseFormatBlocks()),this.mxpState.on&&this.ClearMXPOpen(),this.mxpState.on=!1,this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&this.mxpLines[this.mxpState.lineType].gag&&(G=!0),this.mxpState.lineType=this.iMXPDefaultMode,this.mxpState.lineType!==2&&!this.enableMXP&&this.ResetMXP()}h=0,G||this.MXPCapture(`
`),this.AddLine(a.join(""),f.join(""),!1,G,l,e),G=!1,a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),M=this.getFormatBlock(h)],this.textLength++,this.mxpState.noBreak=!1}else{if(U&&d==="\r")continue;if(U&&d==="\x1B")this._SplitBuffer+=d,u=1;else if(v<32||v===127)if(re)v===1?d="\u263A":v===2?d="\u263B":v===3?d="\u2665":v===4?d="\u2666":v===5?d="\u2663":v===6?d="\u2660":v===7?d="\u2407":v===8?d="\u25D8":v===9?d="\u25CB":v===10?d="\u25D9":v===11?d="\u2642":v===12?d="\u2640":v===13?d="\u266A":v===14?d="\u266B":v===15?d="\u263C":v===16?d="\u25BA":v===17?d="\u25C4":v===18?d="\u2195":v===19?d="\u203C":v===20?d="\xB6":v===21?d="\xA7":v===22?d="\u25AC":v===23?d="\u21A8":v===24?d="\u2191":v===25?d="\u2193":v===26?d="\u2192":v===27?d="\u2190":v===28?d="\u221F":v===29?d="\u2194":v===30?d="\u25B2":v===31?d="\u25BC":v===127&&(d="\u2302"),a.push(d),this.MXPCapture(d),h++,this.textLength++,this.mxpState.noBreak=!1;else if(q)v=9216+v,a.push(String.fromCharCode(v)),this.MXPCapture("&#"),this.MXPCapture(v.toString()),this.MXPCapture(";"),h++,this.textLength++,this.mxpState.noBreak=!1;else continue;else if(d===" "||this._CurrentAttributes>0&&(this._CurrentAttributes&128)===128)a.push(" "),this.MXPCapture(" "),h++,this.textLength++,this.mxpState.noBreak=!1;else if(d==="<"&&_>=S)this.enableMXP&&this.mxpState.on?(p="",x=[],this._SplitBuffer+=d,u=4):(a.push("<"),this.MXPCapture("&lt;"),h++,this.textLength++);else if(d===">")a.push(">"),this.MXPCapture("&gt;"),h++,this.textLength++,this.mxpState.noBreak=!1;else if(d==="&"&&_>=S)this.enableMXP&&this.mxpState.on?(C="",this._SplitBuffer+=d,b=u,u=7):(a.push(d),h++,this.textLength++,this.mxpState.noBreak=!1);else if(d==='"')a.push(d),this.MXPCapture("&quot;"),h++,this.textLength++,this.mxpState.noBreak=!1;else if(d==="'")a.push(d),this.MXPCapture("&apos;"),h++,this.textLength++,this.mxpState.noBreak=!1;else if(d===":"){if(a.push(d),this.MXPCapture(d),h++,this.textLength++,this.mxpState.noBreak=!1,ie){P="";let w,Q=!1;for(O=0;O<j;O++){if(_-this.protocols[O].length<0)continue;w=!1;let A=this.protocols[O].length;for(let I=0;I<A;I++)if(t[_-(A-I)]!==this.protocols[O][I]){w=!0;break}if(!w&&(L=a.length,R=h,F=l.length,!(L>1+A&&a[L-(2+A)].length===1&&/\S/.test(a[L-(2+A)])&&a[L-(2+A)]!=="("&&a[L-(2+A)]!=="[")&&(D=[],L=a.length-(1+A),R-=1+A,k=a.length-1,L>0&&a[L-1]==="("&&D.push(")"),L>0&&a[L-1]==="["&&D.push("]"),u=11,Q=!0,Q)))break}Q||(u=10,L=_,R=h)}}else if(d==="."){if(a.push(d),this.MXPCapture(d),h++,this.textLength++,this.mxpState.noBreak=!1,ie&&_-3>=0&&(P="http://",(t[_-1]==="w"||_[L-1]==="W")&&(t[_-2]==="w"||_[L-2]==="W")&&(t[_-3]==="w"||_[L-3]==="W"))){if(L=a.length,R=h,F=l.length,L>4&&a[L-5].length===1&&/\S/.test(a[L-5])&&a[L-5]!=="("&&a[L-5]!=="[")continue;D=[],L=a.length-4,R-=4,k=a.length-1,L>0&&a[L-1]==="("&&D.push(")"),L>0&&a[L-1]==="["&&D.push("]"),u=11}}else Y&&h===0&&t.substring(_,_+8)==="!!MUSIC("?(x=[""],u=13,_+=7,this.mxpState.noBreak=!1):Y&&h===0&&t.substring(_,_+8)==="!!SOUND("?(x=[""],u=12,_+=7,this.mxpState.noBreak=!1):(re&&v>127&&v<255?v===128?d="\xC7":v===129?d="\xFC":v===130?d="\xE9":v===131?d="\xE2":v===132?d="\xE4":v===133?d="\xE0":v===134?d="\xE5":v===135?d="\xE7":v===136?d="\xEA":v===137?d="\xEB":v===138?d="\xE8":v===139?d="\xEF":v===140?d="\xEE":v===141?d="\xEC":v===142?d="\xC4":v===143?d="\xC5":v===144?d="\xC9":v===145?d="\xE6":v===146?d="\xC6":v===147?d="\xF4":v===148?d="\xF6":v===149?d="\xF2":v===150?d="\xFB":v===151?d="\xF9":v===152?d="\xFF":v===153?d="\xD6":v===154?d="\xDC":v===155?d="\xA2":v===156?d="\xA3":v===157?d="\xA5":v===158?d="\u20A7":v===159?d="\u0192":v===160?d="\xE1":v===161?d="\xED":v===162?d="\xF3":v===163?d="\xFA":v===164?d="\xF1":v===165?d="\xD1":v===166?d="\xAA":v===167?d="\xBA":v===168?d="\xBF":v===169?d="\u2310":v===170?d="\xAC":v===171?d="\xBD":v===172?d="\xBC":v===173?d="\xA1":v===174?d="\xAB":v===175?d="\xBB":v===176?d="\u2591":v===177?d="\u2592":v===178?d="\u2593":v===179?d="\u2502":v===180?d="\u2524":v===181?d="\u2561":v===182?d="\u2562":v===183?d="\u2556":v===184?d="\u2555":v===185?d="\u2563":v===186?d="\u2551":v===187?d="\u2557":v===188?d="\u255D":v===189?d="\u255C":v===190?d="\u255B":v===191?d="\u2510":v===192?d="\u2514":v===193?d="\u2534":v===194?d="\u252C":v===195?d="\u251C":v===196?d="\u2500":v===197?d="\u253C":v===198?d="\u255E":v===199?d="\u255F":v===200?d="\u255A":v===201?d="\u2554":v===202?d="\u2569":v===203?d="\u2566":v===204?d="\u2560":v===205?d="\u2550":v===206?d="\u256C":v===207?d="\u2567":v===208?d="\u2568":v===209?d="\u2564":v===210?d="\u2565":v===211?d="\u2559":v===212?d="\u2558":v===213?d="\u2552":v===214?d="\u2553":v===215?d="\u256B":v===216?d="\u256A":v===217?d="\u2518":v===218?d="\u250C":v===219?d="\u2588":v===220?d="\u2584":v===221?d="\u258C":v===222?d="\u2590":v===223?d="\u2580":v===224?d="\u03B1":v===225?d="\u03B2":v===226?d="\u0393":v===227?d="\u03C0":v===228?d="\u03A3":v===229?d="\u03C3":v===230?d="\xB5":v===231?d="\u03C4":v===232?d="\u03A6":v===233?d="\u0398":v===234?d="\u03A9":v===235?d="\u03B4":v===236?d="\u221E":v===237?d="\u2205":v===238?d="\u2208":v===239?d="\u2229":v===240?d="\u2261":v===241?d="\xB1":v===242?d="\u2265":v===243?d="\u2264":v===244?d="\u2320":v===245?d="\u2321":v===246?d="\xF7":v===247?d="\u2248":v===248?d="\xB0":v===249?d="\u2219":v===250?d="\xB7":v===251?d="\u221A":v===252?d="\u207F":v===253?d="\xB2":v===254&&(d="\u25A0"):v>255&&(M.unicode=!0),a.push(d),this.MXPCapture(d),h++,this.textLength++,this.mxpState.noBreak=!1)}break}this._SplitBuffer.length&&(this.rawLength-=this._SplitBuffer.length,f.splice(f.length-this._SplitBuffer.length,this._SplitBuffer.length)),l.push(...this.getMXPCloseFormatBlocks()),u===11&&l.splice(F,0,{formatType:1,offset:R,href:P+=a.slice(L).join("")}),this.AddLine(a.join(""),f.join(""),!0,!1,l,e)}catch(w){this.enableDebug&&this.emit("debug",w)}this.busy=!1,this.emit("parse-done"),this.parsing.shift(),this.parsing.length>0&&setTimeout(this.parseNext(),0)}parseNext(){let t=this.parsing.shift();return()=>{this.parse(t[0],t[1],!0,t[2])}}updateWindow(t,e){this.window={width:t,height:e}}Clear(){this.ResetColors(),this.textLength=0,this._SplitBuffer=""}ClearMXP(){this.mxpEntities={},this.ResetMXP(),this.mxpElements={},this.mxpState=new tt}ResetMXP(){this.mxpStyles=[],this.mxpStyles.push(new Me(0,"","",!1))}ResetMXPLine(){this.iMXPDefaultMode=0,this.mxpState.lineType=0}GetPublicEntity(t){return this.mxpEntities[t]&&this.mxpEntities[t].publish?this.mxpEntities[t].value:t}};var $e=class extends ee{constructor(t,e){super();this._updating=0;this._enableDebug=!1;this._maxView=0;this._padding=[0,0,0,0];this._enableColors=!0;this._enableBackgroundColors=!0;this._hideTrailingEmptyLine=!0;this._maxLines=500;this._wordWrap=!1;this._indent=4;this._indentPadding=0;this._wrapAt=0;this._scrollAtEnd=!1;this._lineCache=[];this._expireCache=[];this._timestamp=0;this._timestampFormat="[[]MM-DD HH:mm:ss.SSS[]] ";this._timestampWidth=new Date().toISOString().length+1;this.scrollLock=!1;if(!t)throw new Error("Container must be a selector, element or jquery object");if(typeof t=="object"&&"container"in t&&(e=Object.assign(e||{},t),t=e.container,delete e.container),typeof t=="string"){if(this._container=document.querySelector(t),!this._container)throw new Error("Invalid selector for display.")}else if(t instanceof $)this._container=t[0];else if(t instanceof HTMLElement)this._container=t;else throw new Error("Container must be a selector, element or jquery object");this._styles=document.createElement("style"),this._container.appendChild(this._styles),this._character=document.createElement("span"),this._character.id=this.id+"-Character",this._character.className="line",this._character.innerHTML='<span style="border-bottom: 1px solid rgb(0, 0, 0);">W</span>',this._character.style.visibility="hidden",this._container.appendChild(this._character),this._view=document.createElement("div"),this._view.className="view",this._view.addEventListener("scroll",()=>{this._scrollAtEnd=this._view.clientHeight+this._view.scrollTop>=this._view.scrollHeight}),this._view.addEventListener("click",n=>{this.emit("click",n)}),this._container.appendChild(this._view),this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width),e?e.display=this:e={display:this},this.model=new vt(e),this._wResize=n=>{this._scrollAtEnd&&this.scrollDisplay(),bt(()=>{this.doUpdate(17)},250,"resize")},window.addEventListener("resize",this._wResize.bind(this)),this._resizeObserver=new ResizeObserver((n,s)=>{n.length!==0&&(!n[0].contentRect||n[0].contentRect.width===0||n[0].contentRect.height===0||bt(()=>{(!this._resizeObserverCache||this._resizeObserverCache.width!==n[0].contentRect.width||this._resizeObserverCache.height!==n[0].contentRect.height)&&(this._scrollAtEnd&&this.scrollDisplay(),this._resizeObserverCache={width:n[0].contentRect.width,height:n[0].contentRect.height},this.doUpdate(17),this.emit("resize"))},250,"resize"))}),this._resizeObserver.observe(this._container),this._observer=new MutationObserver(n=>{let s;for(s of n)s.type==="attributes"&&s.attributeName==="style"&&(this._scrollAtEnd&&this.scrollDisplay(),this.doUpdate(17),this.emit("resize"))}),this._observer.observe(this._container,{attributes:!0,attributeOldValue:!0,attributeFilter:["style"]}),!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.updateFont()}get showTimestamp(){return this._timestamp}set showTimestamp(t){t!==this._timestamp&&(this._timestamp=t,!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.buildStyleSheet(),this.doUpdate(35))}get timestampFormat(){return this._timestampFormat}set timestampFormat(t){this._timestampFormat!==t&&(this._timestampFormat=t,!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.doUpdate(51))}get wordWrap(){return this._wordWrap}set wordWrap(t){t!==this._wordWrap&&(this._wordWrap=t,this.buildStyleSheet(),this.doUpdate(1))}get wrapAt(){return this._wrapAt}set wrapAt(t){t!==this._wrapAt&&(this._wrapAt=t,this.buildStyleSheet(),this.doUpdate(3))}get indent(){return this._indent}set indent(t){t!==this._indent&&(this._indent=t,this.buildStyleSheet(),this.doUpdate(3))}get linkFunction(){return this._linkFunction||"doLink"}set linkFunction(t){this._linkFunction=t}get mxpLinkFunction(){return this._mxpLinkFunction||"doMXPLink"}set mxpLinkFunction(t){this._mxpLinkFunction=t}get mxpSendFunction(){return this._mxpSendFunction||"doMXPSend"}set mxpSendFunction(t){this._mxpSendFunction=t}get mxpTooltipFunction(){return this._mxpTooltipFunction||"doMXPTooltip"}set mxpTooltipFunction(t){this._mxpTooltipFunction=t}get id(){return this._container?this._container.id:""}get container(){return this._container}get lines(){return this._model.lines}get model(){return this._model}set model(t){this._model!==t&&(this._model&&this._model.removeAllListeners(),this._model=t,this._model.on("debug",this.debug),this._model.on("bell",()=>{this.emit("bell")}),this._model.on("add-line",e=>{this.emit("add-line",e)}),this._model.on("add-line-done",e=>{this.emit("add-line-done",e)}),this._model.on("line-added",(e,n)=>{this._lineCache.push(this.getLineHTML(e.idx))}),this._model.on("expire-links",e=>{if(this._expireCache.length){let n,s;for(let i=0,o=this._expireCache.length;i<o;i++)this.rebuildLine(this._expireCache[i])}this._expireCache=[],this.emit("expire-links")}),this._model.on("parse-done",()=>{this._view.insertAdjacentHTML("beforeend",this._lineCache.join("")),this._lineCache=[],this.doUpdate(2),this.emit("parse-done")}),this._model.on("set-title",(e,n)=>{this.emit("set-title",e,n)}),this._model.on("music",e=>{this.emit("music",e)}),this._model.on("sound",e=>{this.emit("sound",e)}),this._model.on("MXP-tag-reply",(e,n)=>{this.emit("MXP-tag-reply",e,n)}),this._model.on("expire-link-line",e=>{this._expireCache.push(e),this.doUpdate(2)}))}get maxLines(){return this._maxLines}set maxLines(t){t!==this._maxLines&&(this._maxLines=t,this.doUpdate(4))}get enableDebug(){return this._enableDebug}get enableColors(){return this._enableColors}set enableColors(t){t!==this._enableColors&&(this._enableColors=t,this.buildStyleSheet())}get enableBackgroundColors(){return this._enableBackgroundColors}set enableBackgroundColors(t){t!==this._enableBackgroundColors&&(this._enableBackgroundColors=t,this.buildStyleSheet())}get hideTrailingEmptyLine(){return this._hideTrailingEmptyLine}set hideTrailingEmptyLine(t){t!==this._hideTrailingEmptyLine&&(this._hideTrailingEmptyLine=t,this.doUpdate(2))}set enableDebug(t){this._enableDebug=t,this._model.enableDebug=t}get tabWidth(){return this._model.tabWidth}set tabWidth(t){this._model.tabWidth=t}get textLength(){return this._model.textLength}get EndOfLine(){return this._model.EndOfLine}get parseQueueLength(){return this._model.parseQueueLength}get parseQueueEndOfLine(){return this._model.parseQueueEndOfLine}get EndOfLineLength(){return this.lines.length===0?0:this.lines[this.lines.length-1].text.length}set enableFlashing(t){this._model.enableFlashing=t}get enableFlashing(){return this._model.enableFlashing}set enableMXP(t){this._model.enableMXP=t}get enableMXP(){return this._model.enableMXP}set showInvalidMXPTags(t){this._model.showInvalidMXPTags=t}get showInvalidMXPTags(){return this._model.showInvalidMXPTags}set enableBell(t){this._model.enableBell=t}get enableBell(){return this._model.enableBell}set enableURLDetection(t){this._model.enableURLDetection=t}get enableURLDetection(){return this._model.enableURLDetection}set enableMSP(t){this._model.enableMSP=t}get enableMSP(){return this._model.enableMSP}set displayControlCodes(t){this._model.displayControlCodes=t}get displayControlCodes(){return this._model.displayControlCodes}set emulateTerminal(t){this._model.emulateTerminal=t}get emulateTerminal(){return this._model.emulateTerminal}set MXPStyleVersion(t){this._model.MXPStyleVersion=t}get MXPStyleVersion(){return this._model.MXPStyleVersion}get WindowSize(){return new Pe(this.WindowWidth,this.WindowHeight)}get WindowWidth(){return Math.trunc(this._maxView/this._charWidth)}get WindowHeight(){return this._view.scrollWidth>this._view.clientWidth?Math.trunc((this._innerHeight-gt()-this._padding[0]-this._padding[2])/this._charHeight):Math.trunc((this._innerHeight-this._padding[0]-this._padding[2])/this._charHeight)}get html(){let t=this.lines.length,e=[];for(let n=0;n<t;n++)e.push(this.getLineHTML(n));return e.join("")}get text(){return this._model.text}get raw(){return this._model.raw}get scrollAtBottom(){return this._scrollAtEnd}debug(t){this.emit("debug",t)}scrollDisplay(){this.scrollLock||(this._view.scrollTop=this._view.scrollHeight)}scrollTo(t,e){this._view.scrollTo(t,e)}scrollToCharacter(t,e){this._view.scrollTo(t*this._charHeight,e*this._charWidth)}scrollBy(t,e){this._view.scrollBy(t,e)}scrollUp(){this._view.scrollBy(0,-this._charHeight)}scrollDown(){this._view.scrollBy(0,this._charHeight)}pageUp(){this._view.scrollBy(0,-this._view.clientHeight)}pageDown(){this._view.scrollBy(0,this._view.clientHeight)}trimLines(){if(this._maxLines!==-1&&this.lines.length>this._maxLines){let t=this.lines.length-this._maxLines,e=t;for(;e-- >0;)this._view.removeChild(this._view.firstChild);this._model.removeLines(0,t)}}append(t,e,n,s){this._model.append(t,e||!1,n||!1,s||!1)}CurrentAnsiCode(){return this._model.CurrentAnsiCode()}removeLine(t,e){if(t<0||t>=this.lines.length)return;this.emit("line-removed",t,this.lines[t].text);let n=this._model.getLineID(t),s=document.querySelector(`[data-id="${n}"]`);this._view.removeChild(s),this._model.removeLine(t)}removeLines(t,e){t<0||t>=this.lines.length||(e<1&&(e=1),this.emit("lines-removed",t,this.lines.slice(t,t+e-1)),this._view.replaceChildren(...[].slice.call(this._view.children,0,t),...[].slice.call(this._view.children,t+e)),this._model.removeLines(t,e))}updateDisplay(){this._view.classList.remove("animate"),this.doUpdate(4),this._hideTrailingEmptyLine&&this.lines.length&&this.lines[this.lines.length-1].text.length===0&&(this._view.lastChild.style.display="none"),this.doUpdate(24),this._view.classList.add("animate")}updateWindow(t,e){t===void 0&&(t=this.WindowWidth,e=this.WindowHeight),this._model.updateWindow(t,e),this.emit("update-window",t,e)}clear(){this._model.clear(),this._view.innerHTML=""}dispose(){for(document.body.removeChild(this._character),document.body.removeChild(this._styles);this._container.firstChild;)this._view.removeChild(this._view.firstChild);window.removeEventListener("resize",this._wResize)}update(){let t=gt();this._maxView=this._view.clientWidth-this._padding[1]-this._padding[3]-t-this._indentPadding,this._timestamp!==0&&(this._maxView-=this._timestampWidth*this._charWidth),this._innerHeight=this._view.clientHeight}updateFont(t,e){!t||t.length===0?t='"Courier New", Courier, monospace':t+=", monospace",(!e||e.length===0)&&(e="1em"),(t!==this._container.style.fontFamily||e!==this._container.style.fontSize)&&(this._container.style.fontSize=e,this._container.style.fontFamily=t,this._character.style.fontSize=e,this._character.style.fontFamily=t,this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width),setTimeout(()=>{this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width)},250),this.buildStyleSheet(),this.doUpdate(25));let n=window.getComputedStyle(this._view),s=[parseInt(n.getPropertyValue("padding-top"))||0,parseInt(n.getPropertyValue("padding-right"))||0,parseInt(n.getPropertyValue("padding-bottom"))||0,parseInt(n.getPropertyValue("padding-left"))||0];(s[0]!==this._padding[0]||s[1]!==this._padding[1]||s[2]!==this._padding[2]||s[3]!==this._padding[3])&&(this._padding=s,this.doUpdate(1))}buildStyleSheet(){let t="";this._enableColors||(t+=".view > span span {color: inherit !important;}"),(!this._enableColors||!this._enableBackgroundColors)&&(t+=".background > span span {background-color: inherit !important;}"),this._wordWrap?t+=".view {white-space: break-spaces; }":this._wrapAt>0&&(t+=`.view {white-space: break-spaces; } .line {width: ${this._wrapAt*this._charWidth}px !important;max-width:  ${this._wrapAt*this._charWidth}px;min-width:  ${this._wrapAt*this._charWidth}px;display: block;}`),(this._wordWrap||this._wrapAt>0)&&this._indent>0&&(t+=`.view {  padding-left: 0px !important; text-indent: ${this._indent*this._charWidth}px hanging; }`),t+=`.line > span { min-height: ${this._charHeight}}`,this._timestamp!==0&&(t+=".timestamp { display: inline-block; }"),this._styles.innerHTML=t,(this._wordWrap||this._wrapAt>0)&&this._indent>0?this._indentPadding=parseFloat(window.getComputedStyle(this._view).paddingLeft)/2:this._indentPadding=0}getLineHTML(t,e,n,s){t===void 0||t>=this.lines.length?t=this.lines.length-1:t<0&&(t=0),(e===void 0||e<0)&&(e=0),(n===void 0||n===-1)&&(n=this.lines[t].text.length);let i=[],o=0,r="",a="",l=this.lines[t].text,f=this.lines[t].formats,u=f.length,b=!1,h=this._model.getLineID(t);this._timestamp===2&&moment?i.push('<span class="timestamp" style="color:',this._model.GetColor(-7),";background:",this._model.GetColor(-8),';"',a,">",moment(this.lines[t].timestamp).format(this._timestampFormat),"</span>"):this._timestamp===1&&i.push('<span class="timestamp" style="color:',this._model.GetColor(-7),";background:",this._model.GetColor(-8),';"',a,">",new Date(this.lines[t].timestamp).toISOString()," </span>");for(let E=0;E<u;E++){let S=f[E],p,g,C=[];if(E<u-1){if(p=f[E+1],S.offset===p.offset&&p.formatType===S.formatType)continue;g=p.offset}else g=l.length;if(o=S.offset,g>n&&(g=n),o<e&&(o=e),S.formatType===0){if(r=[],a=[],typeof S.background=="number"?r.push("background:",this._model.GetColor(S.background),";"):S.background&&r.push("background:",S.background,";"),typeof S.color=="number"?r.push("color:",this._model.GetColor(S.color),";"):S.color&&r.push("color:",S.color,";"),S.font&&r.push("font-family: ",S.font,";"),S.size&&r.push("font-size: ",S.size,";"),S.style!==0?((S.style&1)===1&&r.push("font-weight: bold;"),(S.style&4)===4&&r.push("font-style: italic;"),(S.style&1024)===1024&&C.push("overline "),((S.style&512)===512||(S.style&8)===8)&&C.push("underline "),(S.style&512)===512?r.push("border-bottom: 1px solid ",typeof S.color=="number"?this._model.GetColor(S.color):S.color,";"):r.push("border-bottom: 1px solid ",typeof S.background=="number"?this._model.GetColor(S.background):S.background,";"),((S.style&32)===32||(S.style&16)===16)&&(this.enableFlashing?a.push(" ansi-blink"):(S.style&512)!==512&&(S.style&8)!==8&&C.push("underline ")),(S.style&256)===256&&C.push("line-through "),C.length>0&&r.push("text-decoration:",C.join("").trim(),";")):r.push("border-bottom: 1px solid ",typeof S.background=="number"?this._model.GetColor(S.background):S.background,";"),o<e||g<e)continue;r=r.join("").trim(),a.length!==0?a=' class="'+a.join("").trim()+'"':a="",S.hr?i.push('<span style="',r,'min-width:100%;width:100%;"',a,'><div style="position:relative;top: 50%;transform: translateY(-50%);height:4px;width:100%; background-color:',typeof S.color=="number"?this._model.GetColor(S.color):S.color,'"></div></span>'):g-o!==0&&i.push('<span style="',r,'"',a,">",Te(l.substring(o,g)),"</span>")}else if(S.formatType===1){if(o<e||g<e||(i.push('<a draggable="false" class="URLLink" href="javascript:void(0);" title="'),i.push(S.href.replace(/"/g,"&quot;")),i.push('" onclick="',this.linkFunction,"('",S.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),`');return false;">`),g-o===0))continue;i.push('<span style="',r,'"',a,">"),i.push(Te(l.substring(o,g))),i.push("</span>")}else if(S.formatType===2||S.formatType===4||S.formatType===8){if(o<e||g<e)continue;i.push("</a>")}else if(S.formatType===3){if(o<e||g<e||(i.push('<a draggable="false" class="MXPLink" href="javascript:void(0);" title="'),i.push(S.href.replace(/"/g,"&quot;")),i.push('"'),S.expire&&S.expire.length&&i.push(` data-expire="${S.expire}"`),i.push(' onclick="',this.mxpLinkFunction,"(this, '",S.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),`');return false;">`),g-o===0))continue;i.push('<span style="',r,'"',a,">"),i.push(Te(l.substring(o,g))),i.push("</span>")}else if(S.formatType===7){if(o<e||g<e||(i.push('<a draggable="false" class="MXPLink" href="javascript:void(0);" title="'),i.push(S.hint.replace(/"/g,"&quot;")),i.push('"'),S.expire&&S.expire.length&&i.push(` data-expire="${S.expire}"`),i.push(' onmouseover="',this.mxpTooltipFunction,'(this);"'),i.push(' onclick="',this.mxpSendFunction,"(event||window.event, this, ",S.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),", ",S.prompt?"1":"0",", ",S.tt.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),');return false;">'),g-o===0))continue;i.push('<span style="',r,'"',a,">"),i.push(Te(l.substring(o,g))),i.push("</span>")}else if(S.formatType===9&&g-o!==0){if(o<e||g<e)continue;i.push('<span style="',r,'"',a,">"),i.push(Te(l.substring(o,g))),i.push("</span>")}else if(S.formatType===5){if(o<e||g<e)continue;let P="";switch(i.push('<img src="'),S.url.length>0&&(i.push(S.url),P+=S.url,S.url.endsWith("/")||(i.push("/"),P+="/")),S.t.length>0&&(i.push(S.t),P+=S.t,S.t.endsWith("/")||(i.push("/"),P+="/")),P+=S.name,i.push(S.name,'"  style="'),S.w.length>0&&i.push("width:",Ee(S.w,this._charWidth),";"),S.h.length>0&&i.push("height:",Ee(S.h,this._charHeight),";"),S.align.toLowerCase()){case"left":i.push("float:left;");break;case"right":i.push("float:right;"),b=!0;break;case"top":case"middle":case"bottom":i.push("vertical-align:",S.align,";");break}S.hspace.length>0&&S.vspace.length>0?(i.push("margin:"),i.push(Ee(S.vspace,this._charWidth)," "),i.push(Ee(S.hspace,this._charHeight),";")):S.hspace.length>0?(i.push("margin:"),i.push("0px ",Ee(S.hspace,this._charHeight),";")):S.vspace.length>0&&(i.push("margin:"),i.push(Ee(S.vspace,this._charWidth)," 0px;")),i.push('"'),S.ismap&&i.push(' ismap onclick="return false;"'),i.push(`src="${P}"/>`)}}return s?b&&n<this.lines[t].text.length?i.join(""):b?i.join("")+"<br>":n<this.lines[t].text.length?i.join(""):i.join("")+"<br>":b&&n<this.lines[t].text.length?`<span data-id="${h}" class="line" style="min-width:100%">${i.join("")}</span>`:b?`<span data-id="${h}" class="line" style="min-width:100%">${i.join("")}<br></span>`:n<this.lines[t].text.length?`<span data-id="${h}" class="line">${i.join("")}</span>`:`<span  data-id="${h}" class="line">${i.join("")}<br></span>`}getLineText(t,e){return t<0||t>=this.lines.length||!this.lines[t]?"":this.lines[t].text}rebuildLine(t){this.rebuildLines(t,t)}rebuildLines(t,e){if(!this.lines.length)return;(t===void 0||t<0)&&(t=0),(e===void 0||e===-1||e>=this.lines.length)&&(e=this.lines.length-1);let n=this.lines,s=[],i=t;for(;i<=e;i++)s.push(this.getLineHTML(i));t===0&&e===this.lines.length-1?this._view.innerHTML=s.join(""):(this._view.replaceChildren(...[].slice.call(this._view.children,0,t),...[].slice.call(this._view.children,e+1)),t===0?this._view.firstElementChild.insertAdjacentHTML("beforebegin",s.join("")):this._view.children[t-1].insertAdjacentHTML("afterend",s.join("")))}doUpdate(t){t&&(this._updating|=t,this._updating!==0&&window.requestAnimationFrame(()=>{this._updating!==0&&((this._updating&32)===32&&(this.rebuildLines(),this._updating&=-33),(this._updating&1)===1&&(this.update(),this._updating&=-2),(this._updating&2)===2&&(this.updateDisplay(),this._updating&=-3),(this._updating&4)===4&&(this.trimLines(),this._updating&=-5),(this._updating&8)===8&&(this.scrollDisplay(),this._updating&=-9),(this._updating&16)===16&&(this.updateWindow(),this._updating&=-17),this.doUpdate(this._updating))}))}colorSubStrByLine(t,e,n,s,i,o){this.colorSubStringByLine(t,e,n,s,(s||0)+(i||0),o)}colorSubStringByLine(t,e,n,s,i,o){this._model.colorSubStringByLine(t,e,n,s,i,o)&&this.rebuildLine(t)}removeStyleSubStrByLine(t,e,n,s){this.removeStyleSubStringByLine(t,e,n,(n||0)+(s||0))}removeStyleSubStringByLine(t,e,n,s){this._model.removeStyleSubStringByLine(t,e,n,s)&&this.rebuildLine(t)}highlightSubStrByLine(t,e,n){this.highlightStyleSubStringByLine(t,e,(e||0)+(n||0))}highlightStyleSubStringByLine(t,e,n,s){this._model.highlightStyleSubStringByLine(t,e,n,s)&&this.rebuildLine(t)}SetColor(t,e){this._model.SetColor(t,e)}ClearMXP(){this._model.ClearMXP()}ResetMXPLine(){this._model.ResetMXPLine()}},vt=class extends ee{constructor(t){super();this._lineID=0;this.lines=[];this.lineIDs=[];this._expire={};this._expire2=[];this._parser=new nt(t),this._parser.on("debug",e=>{this.emit(e)}),this._parser.on("bell",()=>{this.emit("bell")}),this._parser.on("add-line",e=>{this.addParserLine(e,!0)}),this._parser.on("expire-links",e=>{let n,s,i;if(!e||e.length===0){for(s in this._expire2)this._expire2.hasOwnProperty(s)&&this.expireLineLinkFormat(this._expire2[s],+s);for(i in this._expire)if(this._expire.hasOwnProperty(i)){n=this._expire[i];for(s in n)n.hasOwnProperty(s)&&this.expireLineLinkFormat(n[s],+s)}this._expire2=[],this._expire={},this.emit("expire-links",e)}else if(this._expire[e]){n=this._expire[e];for(s in n)n.hasOwnProperty(s)&&this.expireLineLinkFormat(n[s],+s);delete this._expire[e],this.emit("expire-links",e)}}),this._parser.on("parse-done",()=>{this.emit("parse-done")}),this._parser.on("set-title",(e,n)=>{this.emit("set-title",e,n)}),this._parser.on("music",e=>{this.emit("music",e)}),this._parser.on("sound",e=>{this.emit("sound",e)}),this._parser.on("MXP-tag-reply",(e,n)=>{this.emit("MXP-tag-reply",e,n)})}get enableDebug(){return this._parser.enableDebug}set enableDebug(t){this._parser.enableDebug=t}get tabWidth(){return this._parser.tabWidth}set tabWidth(t){this._parser.tabWidth=t}get textLength(){return this._parser.textLength}get EndOfLine(){return this._parser.EndOfLine}get parseQueueLength(){return this._parser.parseQueueLength}get parseQueueEndOfLine(){return this._parser.parseQueueEndOfLine}set enableFlashing(t){this._parser.enableFlashing=t}get enableFlashing(){return this._parser.enableFlashing}set enableMXP(t){this._parser.enableMXP=t}get enableMXP(){return this._parser.enableMXP}set showInvalidMXPTags(t){this._parser.showInvalidMXPTags=t}get showInvalidMXPTags(){return this._parser.showInvalidMXPTags}set enableBell(t){this._parser.enableBell=t}get enableBell(){return this._parser.enableBell}set enableURLDetection(t){this._parser.enableURLDetection=t}get enableURLDetection(){return this._parser.enableURLDetection}set enableMSP(t){this._parser.enableMSP=t}get enableMSP(){return this._parser.enableMSP}set displayControlCodes(t){this._parser.displayControlCodes=t}get displayControlCodes(){return this._parser.displayControlCodes}set emulateTerminal(t){this._parser.emulateTerminal=t}get emulateTerminal(){return this._parser.emulateTerminal}set emulateControlCodes(t){this._parser.emulateControlCodes=t}get emulateControlCodes(){return this._parser.emulateControlCodes}set MXPStyleVersion(t){this._parser.StyleVersion=t}get MXPStyleVersion(){return this._parser.StyleVersion}addParserLine(t,e){if(t.timestamp=Date.now(),this.emit("add-line",t),t==null||typeof t>"u"||t.line==null||typeof t.line>"u"||(this.emit("add-line-done",t),t.gagged))return;let n={text:t.line===`
`||t.line.length===0?"":t.line,raw:t.raw,formats:t.formats,id:this._lineID,timestamp:t.timestamp};this.lines.push(n),this.lineIDs.push(this._lineID),this._lineID++,this.buildLineExpires(this.lines.length-1),this.emit("line-added",t,e)}expireLineLinkFormat(t,e){let n,s,i,o,r,a,l,f=0;for(s=0,o=t.length;s<o;s++)for(i=this.lines[e].formats.length,n=t[s],l=this.lines[e].formats[n],r=l.formatType,l.formatType===3?a=4:a=8,l.formatType=9,n++;n<i;n++)if(this.lines[e].formats[n]===a)if(f===0){this.lines[e].formats[n].formatType=10;break}else f--;else this.lines[e].formats[n]===r&&f++;this.emit("expire-link-line",e)}clear(){this._parser.Clear(),this.lines=[],this._expire={},this._expire2=[],this.lineIDs=[],this._lineID=0}IncreaseColor(t,e){return this._parser.IncreaseColor(t,e)}GetColor(t){return this._parser.GetColor(t)}append(t,e,n,s){this._parser.parse(t,e||!1,n||!1,s||!1)}CurrentAnsiCode(){return this._parser.CurrentAnsiCode()}updateWindow(t,e){this._parser.updateWindow(t,e)}SetColor(t,e){this._parser.SetColor(t,e)}ClearMXP(){this._parser.ClearMXP()}ResetMXPLine(){this._parser.ResetMXPLine()}get busy(){return this._parser.busy}removeLine(t){this.lines.splice(t,1),this.lineIDs.splice(t,1),this._expire2.splice(t,1)}removeLines(t,e){this.lines.splice(t,e),this.lineIDs.splice(t,e),this._expire2.splice(t,e);for(let n in this._expire)!this._expire.hasOwnProperty(n)||this._expire[n].length===0||t>=this._expire[n].length||this._expire[n].splice(t,e)}getLineID(t){return t<0||t>=this.lineIDs.length?-1:this.lineIDs[t]}get getNextLineID(){return this._lineID}getLineFromID(t){return this.lineIDs.indexOf(t)}buildLineExpires(t){t===void 0&&(t=this.lines.length-1);let e=this.lines[t].formats;for(let i in this._expire)this._expire.hasOwnProperty(i)&&this._expire[i][t]&&delete this._expire[i][t];delete this._expire2[t];let n=e.length,s;for(;n--;)s=e[n],(s.formatType===7||s.formatType===3)&&(s.expire&&s.expire.length>0?(this._expire[s.expire]||(this._expire[s.expire]=[]),this._expire[s.expire][t]||(this._expire[s.expire][t]=[]),this._expire[s.expire][t].push(n)):(this._expire2[t]||(this._expire2[t]=[]),this._expire2[t].push(n)))}colorSubStrByLine(t,e,n,s,i,o){return this.colorSubStringByLine(t,e,n,s,s+i,o)}colorSubStringByLine(t,e,n,s,i,o){if(t<0||t>=this.lines.length)return!1;let r=this.lines[t].text.length;if(s>=r||((!s||s<0)&&(s=0),(!i||i>r)&&(i=r),s===i))return!1;let a=this.lines[t].formats,l=a.length,f=!1;if(s===0&&i>=r){for(let u=0;u<l;u++){let b=a[u];b.formatType===0&&(f=!0,b.bStyle&&(b.bStyle=0,b.fStyle=0,b.fCls=0),b.color=e||b.color,b.background=n||b.background,b.style|=o||0)}f||a.unshift({formatType:0,offset:0,color:e||0,background:n||0,size:0,font:0,style:o||0,unicode:!1})}else{let u,b;for(let h=0;h<l;h++){let E=a[h];if(E.formatType===0){if(h<l-1){let S=h+1;if(u=a[S],E.offset===u.offset&&u.formatType===E.formatType)continue;for(;E.offset===u.offset&&u.formatType===E.formatType&&S<l-1;)u=a[++S];S===l&&E.offset===u.offset?b=r:b=u.offset}else b=r;s<E.offset||s>=b||(f=!0,E.bStyle&&(E.bStyle=0,E.fStyle=0,E.fCls=0),i<b&&(E.width=0,a.splice(h+1,0,{formatType:E.formatType,offset:i,color:E.color,background:E.background,size:E.size,font:E.font,style:E.style,unicode:E.unicode}),l++),s!=E.offset?(E.width=0,a.splice(h+1,0,{formatType:E.formatType,offset:s,color:e||E.color,background:n||E.background,size:E.size,font:E.font,style:E.style|(o||0),unicode:E.unicode}),l++):(E.color=e||E.color,E.background=n||E.background,E.style|=o||0),i>b&&(s=b))}}this.lines[t].formats=this.pruneFormats(a,this.textLength)}return!0}removeStyleSubStrByLine(t,e,n,s){return this.removeStyleSubStringByLine(t,e,n,n+s)}removeStyleSubStringByLine(t,e,n,s){if(t<0||t>=this.lines.length)return!1;let i=this.lines[t].text.length;if(n>=i)return!1;(!n||n<0)&&(n=0),(!s||s>i)&&(s=i);let o=this.lines[t].formats,r=o.length,a=!1;if(n===0&&s>=i){for(let l=0;l<r;l++){let f=o[l];f.formatType===0&&(a=!0,f.bStyle&&(f.bStyle=0,f.fStyle=0,f.fCls=0),f.style&=~(e||0))}a||o.unshift({formatType:0,offset:0,color:0,background:0,size:0,font:0,style:0,unicode:!1})}else{let l,f;for(let u=0;u<r;u++){let b=o[u];if(b.formatType===0){if(u<r-1){let h=u+1;if(l=o[h],b.offset===l.offset&&l.formatType===b.formatType)continue;for(;b.offset===l.offset&&l.formatType===b.formatType&&h<r-1;)l=o[++h];h===r&&b.offset===l.offset?f=i:f=l.offset}else f=i;n<b.offset||n>=f||(a=!0,b.bStyle&&(b.bStyle=0,b.fStyle=0,b.fCls=0),s<f&&(b.width=0,o.splice(u+1,0,{formatType:b.formatType,offset:s,color:b.color,background:b.background,size:b.size,font:b.font,style:b.style,unicode:b.unicode}),r++),n!=b.offset?(b.width=0,o.splice(u+1,0,{formatType:b.formatType,offset:n,color:b.color,background:b.background,size:b.size,font:b.font,style:b.style&~(e||0),unicode:b.unicode}),r++):b.style&=~(e||0),s>f&&(n=f))}}this.lines[t].formats=this.pruneFormats(o,this.textLength)}return!0}highlightSubStrByLine(t,e,n){return this.highlightStyleSubStringByLine(t,e,e+n)}highlightStyleSubStringByLine(t,e,n,s){if(t<0||t>=this.lines.length)return!1;let i=this.lines[t].text.length;if(e>=i)return!1;(!e||e<0)&&(e=0),(!n||n>i)&&(n=i);let o=this.lines[t].formats,r=o.length,a=!1;if(e===0&&n>=i){for(let l=0;l<r;l++){let f=o[l];f.formatType===0&&(a=!0,f.bStyle&&(f.bStyle=0,f.fStyle=0,f.fCls=0),s||(f.style&1)===1?typeof f.color=="number"?f.color=this._parser.IncreaseColor(this._parser.GetColor(f.color),.25):f.color=this._parser.IncreaseColor(f.color,.25):f.style|=1)}a||o.unshift({formatType:0,offset:0,color:s?370:0,background:0,size:0,font:0,style:s?0:1,unicode:!1})}else{let l,f;for(let u=0;u<r;u++){let b=o[u];if(b.formatType===0){if(u<r-1){let h=u+1;if(l=o[h],b.offset===l.offset&&l.formatType===b.formatType)continue;for(;b.offset===l.offset&&l.formatType===b.formatType&&h<r-1;)l=o[++h];h===r&&b.offset===l.offset?f=i:f=l.offset}else f=i;e<b.offset||e>=f||(a=!0,b.bStyle&&(b.bStyle=0,b.fStyle=0,b.fCls=0),n<f&&(b.width=0,o.splice(u+1,0,{formatType:b.formatType,offset:n,color:b.color,background:b.background,size:b.size,font:b.font,style:b.style,unicode:b.unicode}),r++),e!=b.offset?(b.width=0,l={formatType:b.formatType,offset:e,color:b.color,background:b.background,size:b.size,font:b.font,style:b.style,unicode:b.unicode},s||(b.style&1)===1?typeof b.color=="number"?l.color=this._parser.IncreaseColor(this._parser.GetColor(b.color),.25):l.color=this._parser.IncreaseColor(b.color,.25):l.style|=1,o.splice(u+1,0,l),r++):s||(b.style&1)===1?typeof b.color=="number"?b.color=this._parser.IncreaseColor(this._parser.GetColor(b.color),.25):b.color=this._parser.IncreaseColor(b.color,.25):b.style|=1,n>f&&(e=f))}}this.lines[t].formats=this.pruneFormats(o,this.textLength)}return!0}pruneFormats(t,e){if(!t||t.length<2)return t;let n=t.length,s=[];for(let i=0;i<n;i++){let o=t[i],r;if(i<n-1){let a=t[i+1];if(o.offset===a.offset&&a.formatType===o.formatType||(r=a.offset,o.formatType===1&&r-o.offset===0&&a.formatType===2)||o.formatType===7&&r-o.offset===0&&a.formatType===8||o.formatType===3&&r-o.offset===0&&a.formatType===4)continue;if(o.formatType===a.formatType&&o.color===a.color&&o.background===a.background&&o.size===a.size&&o.font===a.font&&o.style===a.style&&o.unicode===a.unicode){a.offset=o.offset,a.width=0;continue}}else if(o.offset===e&&e!==0&&(o.formatType===0&&!o.hr||o.formatType===1||o.formatType===7||o.formatType===3))continue;s.push(o)}return s}get text(){return this.lines.map(t=>t.text).join(`
`)}get raw(){return this.lines.map(t=>t.raw).join("")}getText(t,e,n){return t<0||t>=this.lines.length?"":(e<0&&(e=0),typeof n>"u"||n>this.lines[t].text.length?this.lines[t].text.substring(e):this.lines[t].text.substring(e,n))}};var Bt="0.0.1";var ve=_t(Ut());var He=class extends ee{#e;get client(){return this.#e}set client(c){c!==this.#e&&(this.remove(),this.#e=c,this.initialize())}constructor(c){super(),this.#e=c}};var lt=class extends ee{constructor(){super(...arguments);this._file="";this._repeats=1;this._volume=100;this._priority=50;this._retries=0;this.current=0;this.sound=null;this.playing=!1;this.url="";this.continue=!0;this.maxErrorRetries=0}set file(t){this.continue||this.close(),this._file=t}get file(){return this._file}set repeats(t){t>=-1?this._repeats=t:this._repeats=1,this.current=0}get repeats(){return this._repeats}set volume(t){t>=0&&t<=100?this._volume=t:this._volume=1}get volume(){return this._volume}set priority(t){t>=0&&t<=100?this._priority=t:this._priority=50}get priority(){return this._priority}play(){this.playing=!0,this._repeats>0&&this.current<this._repeats?(this.current++,this.close(),this.open().then(()=>{this._retries=0,this.sound.setVolume(this._volume).play(),this.current<this._repeats?this.sound.bind("ended abort",t=>{this.play()}):this.sound.bind("ended abort",t=>{this.playing=!1,this.emit("ended")}),this.sound.isEnded()&&(this.playing=!1)}).catch(t=>{this._retries<this.maxErrorRetries?(this.current--,this.play(),this._retries++):this._retries=0})):this._repeats===-1?(this.close(),this.open().then(()=>{this._retries=0,this.sound.setVolume(this._volume).loop().play(),this.sound.isEnded()&&(this.playing=!1)}).catch(t=>{this._retries<this.maxErrorRetries?(this.play(),this._retries++):this._retries=0})):this.playing=!1}async open(){return this.close(),new Promise((t,e)=>{this.sound=new ve.sound()(this.url+this._file),this.sound.bind("loadeddata",n=>{this.emit("playing",{file:this._file,sound:this.sound,state:this,duration:ve.toTimer(this.sound.getDuration())}),t(1)}),this.sound.bind("error",n=>{if(n&&n.currentTarget&&n.currentTarget.error)switch(n.currentTarget.error.code){case 1:this.emit("error",new Error(`MSP - Aborted: ${this.url}${this._file}`));break;case 2:this.emit("error",new Error(`MSP - Network error: ${this.url}${this._file}`));break;case 3:this.emit("error",new Error(`MSP - Could not decode: ${this.url}${this._file}`));break;case 4:this.emit("error",new Error(`MSP - Source not supported: ${this.url}${this._file}`));break}else n&&n.currentTarget&&n.currentTarget.networkState===3?this.emit("error",new Error(`MSP - Source not found or unable to play: ${this.url}${this._file}`)):this.emit("error",new Error("MSP - Unknown error"));e()}),this.emit("opened")})}close(){this.sound?(this.stop(),delete this.sound,this.sound=null):this.playing&&(this.playing=!1),this.emit("closed")}stop(){this.sound&&this.sound.stop(),this.playing=!1,this.emit("stopped")}},at=class extends He{constructor(t){super(t instanceof Ae?t:t?.client);this._enabled=!0;this._enableSound=!0;this._maxErrorRetries=1;this.server=!1;this.enableDebug=!1;this.defaultSoundURL="";this.defaultMusicURL="";this.forcedDefaultMusicURL="http://"+window.location.hostname+"/sounds/";this.forcedDefaultSoundURL="http://"+window.location.hostname+"/sounds/";this.defaultSoundExt=".m4a";this.defaultMusicExt=".m4a";this.MusicState=new lt;this.SoundState=new lt;this.parseMode=0;t&&!(t instanceof Ae)&&("forcedDefaultMusicURL"in t&&(this.forcedDefaultMusicURL=t.forcedDefaultMusicURL),"forcedDefaultSoundURL"in t&&(this.forcedDefaultSoundURL=t.forcedDefaultSoundURL)),this.MusicState.on("playing",e=>{e.type=1,this.emit("playing",e)}),this.SoundState.on("playing",e=>{e.type=0,this.emit("playing",e)}),this.MusicState.on("error",e=>{this.emit("error",e)}),this.SoundState.on("error",e=>{this.emit("error",e)}),this.MusicState.maxErrorRetries=this._maxErrorRetries,this.SoundState.maxErrorRetries=this._maxErrorRetries}remove(){this.client&&(this.client.off("connecting",this.reset),this.client.off("close",this.reset),this.client.off("received-option",this.processOption),this.client.off("received-GMCP",this.processGMCP),this.client.off("music",this.music),this.client.off("sound",this.sound),this.client.off("options-loaded",this.loadOptions),this.client.off("option-loaded",this.setOption),this.client.off("function",this.processFunction),this.off("error",this.client.error),this.off("debug",this.client.debug))}initialize(){this.client&&(this.client.on("connecting",this.reset),this.client.on("close",this.reset),this.client.on("received-option",this.processOption),this.client.on("received-GMCP",this.processGMCP),this.client.on("music",this.music),this.client.on("sound",this.sound),this.client.on("options-loaded",this.loadOptions),this.client.on("option-loaded",this.setOption),this.client.on("function",this.processFunction),this.on("playing",t=>{this.client&&(this.debug("MSP "+(t.type?"Music":"Sound")+" Playing "+t.file+" for "+t.duration),this.debug(t),this.client.getOption("notifyMSPPlay")&&this.client.echo((t.type?"Music":"Sound")+" Playing "+t.file+" for "+t.duration,-7,-8,!0,!0))}),this.on("debug",this.client.debug),this.on("error",this.client.error),this.loadOptions())}get menu(){return[]}loadOptions(){this.enableDebug=this.client.getOption("enableDebug"),this.enabled=this.client.getOption("enableMSP"),this.enableSound=this.client.getOption("enableSound"),this.maxErrorRetries=this.client.getOption("mspMaxRetriesOnError")}setOption(t,e){switch(t){case"enableMSP":this.enabled=this.client.getOption("enableMSP");break;case"mspMaxRetriesOnError":this.maxErrorRetries=this.client.getOption("mspMaxRetriesOnError");break;case"enableSound":case"enableDebug":this[t]=e;break}}get enabled(){return this._enabled}set enabled(t){t!==this._enabled&&(this._enabled=t,this.MusicState?.close(),this.SoundState?.close())}get maxErrorRetries(){return this._maxErrorRetries}set maxErrorRetries(t){t!==this._maxErrorRetries&&(this._maxErrorRetries=t,this.MusicState&&(this.MusicState.maxErrorRetries=t),this.SoundState&&(this.SoundState.maxErrorRetries=t))}get enableSound(){return this._enableSound}set enableSound(t){t!==this._enableSound&&(this._enableSound=t,this.MusicState?.close(),this.SoundState?.close())}getArguments(t,e){let n={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},s=[],i=0,o=[],r=0,a=t.length,l,f,u;for(;r<a;r++)switch(l=t.charAt(r),i){case 1:l==="'"&&(i=0),o.push(l);break;case 2:l==="'"&&(i=0),o.push(l);break;default:l===" "?(s.push(o.join("")),o=[]):l==="'"?(i=1,o.push(l)):(l==="'"&&(i=2),o.push(l));break}for(o.length>0&&(s.push(o.join("")),o=[]),r=0,a=s.length,this.debug("MSP arguments found: "+s),r=0;r<a;r++)if(f=s[r].split("="),f.length>1)switch(f[0].toUpperCase()){case"FNAME":n.file=B(f[1]),n.file.toLowerCase()==="off"&&(n.off=!0,n.file="");break;case"V":u=parseInt(f[1],10),isNaN(u)&&(u=100),n.volume=u;break;case"L":u=parseInt(f[1],10),isNaN(u)&&(u=1),n.repeat=u;break;case"P":u=parseInt(f[1],10),isNaN(u)&&(u=1),n.priority=u;break;case"C":n.continue=f[1]!=="0";break;case"T":f[1].length>0&&(n.type=f[1]);break;case"U":n.url=B(f[1]),!n.url.endsWith("/")&&n.url.length>0&&(n.url+="/");break}else r===0?(n.file=B(s[r]),n.file.toLowerCase()==="off"&&(n.off=!0,n.file="")):r===1?(u=parseInt(s[r],10),isNaN(u)&&(u=100),n.volume=u):r===2?(u=parseInt(s[r],10),isNaN(u)&&(u=1),n.repeat=u):r===3&&e===1?n.continue=s[r]!=="0":r===3?(u=parseInt(s[r],10),isNaN(u)&&(u=1),n.priority=u):r===4?s[r].length>0&&(n.type=s[r]):r===5&&(n.url=B(s[r]),!n.url.endsWith("/")&&n.url.length>0&&(n.url+="/"));return this.debug(n),n}reset(){this.server=!1}music(t){if(!this.enabled&&!this.enableSound)return!1;if(!t.file||t.file.length===0){t.off&&t.url&&t.url.length>0?this.defaultMusicURL=t.url:t.off&&this.MusicState.stop();return}else if(t.off){this.MusicState.stop();return}this.MusicState.volume=t.volume,this.MusicState.repeats=t.repeat,this.MusicState.continue=t.continue;let e=this.MusicState.file;t.file.lastIndexOf(".")===-1?this.MusicState.file=t.file+this.defaultMusicExt:this.MusicState.file=t.file,t.url&&t.url.length>0?this.MusicState.url=t.url:this.forcedDefaultMusicURL&&this.forcedDefaultMusicURL.length>0?this.MusicState.url=this.forcedDefaultMusicURL:this.defaultMusicURL&&this.defaultMusicURL.length>0?this.MusicState.url=this.defaultMusicURL:this.MusicState.url="",this.MusicState.url.length>0&&!this.MusicState.url.endsWith("/")&&(this.MusicState.url+="/"),t.type&&t.type.length>0&&(this.MusicState.url+=t.type,this.MusicState.url.length>0&&!this.MusicState.url.endsWith("/")&&(this.MusicState.url+="/")),(e!==this.MusicState.file||!t.continue||!this.MusicState.playing)&&(this.enableSound?this.MusicState.play():this.emit("playing",{type:1,file:this.MusicState.file,sound:this.MusicState.sound,state:this.MusicState,duration:"--:--"}))}sound(t){if(!this.enabled&&!this.enableSound)return!1;if(!t.file||t.file.length===0){t.off&&t.url&&t.url.length>0?this.defaultSoundURL=t.url:t.off&&this.SoundState.stop();return}else if(t.off){this.SoundState.stop();return}if(this.SoundState.playing&&t.priority<this.SoundState.priority)return!1;this.SoundState.volume=t.volume,this.SoundState.repeats=t.repeat,this.SoundState.priority=t.priority,t.file.lastIndexOf(".")===-1?this.SoundState.file=t.file+this.defaultSoundExt:this.SoundState.file=t.file,t.url&&t.url.length>0?this.SoundState.url=t.url:this.forcedDefaultSoundURL&&this.forcedDefaultSoundURL.length>0?this.SoundState.url=this.forcedDefaultSoundURL:this.defaultSoundURL&&this.defaultSoundURL.length>0?this.SoundState.url=this.defaultSoundURL:this.SoundState.url="",this.SoundState.url.length>0&&!this.SoundState.url.endsWith("/")&&(this.SoundState.url+="/"),t.type&&t.type.length>0&&(this.SoundState.url+=t.type,this.SoundState.url.length>0&&!this.SoundState.url.endsWith("/")&&(this.SoundState.url+="/")),this.enableSound?this.SoundState.play():this.emit("playing",{type:0,file:this.SoundState.file,sound:this.SoundState.sound,state:this.SoundState,duration:"--:--"})}processOption(t){t.option===90&&(this.debug("<MSP>"),t.verb===253?(this.server=!0,this.enabled?(this.debug("REPLY: <IAC><WILL><MSP>"),t.telnet.sendData([255,251,90],!0)):(this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0))):t.verb===254?(this.server=!1,this.debug("REPLY: <IAC><WONT><MSP>"),t.telnet.sendData([255,252,90],!0)):t.verb===251?(this.server=!0,this.enabled?(this.debug("REPLY: <IAC><DO><MSP>"),t.telnet.sendData([255,253,90],!0)):(this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0))):t.verb===252&&(this.server=!1,this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0)),t.handled=!0)}async processGMCP(t,e){switch(t){case"Client.Media.Default":e.type==="sound"||!e.type?this.sound({off:!0,url:e.url}):e.type==="music"&&this.music({off:!0,url:e.url});break;case"Client.Media.Load":break;case"Client.Media.Play":let n={off:!1,file:e.name,url:"",volume:50,repeat:1,priority:50,type:"",continue:!0};e.hasOwnProperty("url")&&(n.url=e.url),e.hasOwnProperty("tag")&&(n.type=e.tag),e.hasOwnProperty("volume")&&(n.volume=e.volume),e.hasOwnProperty("loops")&&(n.repeat=e.loops),e.hasOwnProperty("priority")&&(n.priority=e.priority),e.type==="sound"||!e.type?this.sound(n):e.type==="music"&&(e.hasOwnProperty("continue")&&(e.continue==="false"||!e.continue)&&(n.continue=!1),this.music(n));break;case"Client.Media.Stop":e.type==="sound"||!e.type?this.sound({off:!0}):e.type==="music"&&this.music({off:!0});break}}debug(t){this.enableDebug&&this.emit("debug",t)}processFunction(t){let e,n,s;if(t)switch(t.name.toLowerCase()){case"soundinfo":this.SoundState.playing?this.client.echo("Playing Sound - "+this.SoundState.file+" - "+ve.toTimer(this.SoundState.sound.getTime())+"/"+ve.toTimer(this.SoundState.sound.getDuration()),-7,-8,!0,!0):this.client.echo("No sound currently playing.",-7,-8,!0,!0),t.handled=!0;break;case"musicinfo":this.MusicState.playing?this.client.echo("Playing Music - "+this.MusicState.file+" -  "+ve.toTimer(this.MusicState.sound.getTime())+"/"+ve.toTimer(this.MusicState.sound.getDuration()),-7,-8,!0,!0):this.client.echo("No music currently playing.",-7,-8,!0,!0),t.handled=!0;break;case"playmusic":case"playm":e=this.client.input.parseOutgoing(t.args.join(" "),!1),n={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},s=e.lastIndexOf("/"),s===-1?n.file=e:(n.file=e.substring(s+1),n.url=e.substring(0,s+1)),this.music(n),t.handled=!0;break;case"playsound":case"plays":e=this.client.input.parseOutgoing(t.args.join(" "),!1),n={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},s=e.lastIndexOf("/"),s===-1?n.file=e:(n.file=e.substring(s+1),n.url=e.substring(0,s+1)),this.sound(n),t.handled=!0;break;case"stopmusic":case"stopm":this.MusicState.close(),t.handled=!0;break;case"stopsound":case"stops":this.SoundState.close(),t.handled=!0;break;case"stopallsound":case"stopa":this.MusicState.close(),this.SoundState.close(),t.handled=!0;break}}};var Ae=class extends ee{constructor(t){super();this._enableDebug=!1;this._itemCache={triggers:null,aliases:null,macros:null,buttons:null,alarms:null,alarmPatterns:[]};this._variables={};this._options={};this.active=!0;this.connecting=!1;this.version=Bt;this.connectTime=0;this.disconnectTime=0;this.lastSendTime=0;this.defaultTitle="oiMUD";this.errored=!1;if(window.client=this,window.oiMUD=this,this._plugins=[],t=Object.assign({display:"#display",commandInput:"#commandInput"},t||{}),(!("display"in t)||typeof t.display===void 0)&&(t.display="#display"),(!("commandInput"in t)||typeof t.commandInput===void 0)&&(t.commandInput="#commandInput"),this._display=new $e(t.display),this.display.on("click",n=>{this.getOption("CommandonClick")&&this._commandInput.focus()}),this.display.on("update-window",(n,s)=>{this.telnet.updateWindow(n,s)}),this.display.on("update-window",(n,s)=>{this.telnet.updateWindow(n,s)}),this.display.on("debug",n=>{this.debug(n)}),this.display.on("add-line",n=>{this.emit("add-line",n)}),this.display.on("add-line-done",n=>{this.emit("add-line-done",n)}),this.display.on("MXP-tag-reply",(n,s)=>{let i={tag:n,args:s,preventDefault:!1};if(this.emit("MXP-tag-reply",i),!i.preventDefault)switch(n){case"VERSION":this.display.MXPStyleVersion&&this.display.MXPStyleVersion.length?(this.debug(`MXP Tag REPLY: <VERSION MXP=1.0 STYLE=${this.display.MXPStyleVersion} CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>`),this.send(`\x1B[1z<VERSION MXP=1.0 STYLE=${this.display.MXPStyleVersion} CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>\r
`)):(this.debug(`MXP Tag REPLY: <VERSION MXP=1.0 CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>`),this.send(`\x1B[1z<VERSION MXP=1.0 CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>\r
`));break;case"SUPPORT":this.debug(`MXP Tag REPLY: <SUPPORTS ${s.join(" ")}>`),this.send(`\x1B[1z<SUPPORTS ${s.join(" ")}>\r
`);break;case"USER":this.emit("sendUsername",i);break;case"PASSWORD":this.emit("sendPassword",i);break}}),this.display.on("expire-links",n=>{this.emit("expire-links",n)}),this.display.on("parse-done",()=>{this.emit("parse-done")}),this.display.on("set-title",(n,s)=>{typeof n>"u"||n==null||n.length===0?window.document.title=this.getOption("defaultTitle"):s!==1&&(window.document.title=this.getOption("title").replace("$t",n))}),this.display.on("music",n=>{this.emit("music",n)}),this.display.on("sound",n=>{this.emit("sound",n)}),this.display.on("bell",()=>{this.emit("bell")}),typeof t.commandInput=="string"){if(this._commandInput=document.querySelector(t.commandInput),!this._commandInput)throw new Error("Invalid selector for command input.")}else if(t.commandInput instanceof $)this._commandInput=t.commandInput[0];else if(t.commandInput instanceof HTMLElement)this._commandInput=t.commandInput;else throw new Error("Command input must be a selector, element or jquery object");this._telnet=new Ne({protocol:t.protocol,scheme:t.scheme}),this._telnet.terminal="oiMUD",this._telnet.version=this.version,this._telnet.GMCPSupports.push("oMUD 1"),this._telnet.GMCPSupports.push("Client.Media 1"),this._telnet.on("error",n=>{if(n){if(n.type=="close"&&n.code==1006)return;var s=[];n.type&&s.push(n.type),n.text&&s.push(n.text),n.message&&s.push(n.message),n.reason&&s.push(n.reason),n.code?this.error(n.code+" - "+s.join(", ")):this.error(s.join(", "))}else this.error("Unknown telnet error.");this.getOption("autoConnect")&&!this._telnet.connected&&setTimeout(()=>{this.connect()},600)}),this.telnet.on("connecting",()=>{this.connecting=!0,this.echo("Trying to connect to "+this.host+":"+this.port,-7,-8,!0,!0)}),this.telnet.on("connect",()=>{this.connecting=!1,this.echo("Connected...",-7,-8,!0,!0),this.connectTime=Date.now(),this.disconnectTime=0,this.lastSendTime=Date.now(),this.emit("connected"),this.raise("connected")}),this.telnet.on("debug",n=>{this.debug(n)}),this.telnet.on("receive-option",n=>{this.emit("received-option",n)}),this._telnet.on("close",()=>{this.connecting=!1,this.echo("Connection closed to "+this.host+":"+this.port,-7,-8,!0,!0),this.disconnectTime=Date.now(),this.emit("closed"),this.raise("disconnected"),this.connectTime=0,this.lastSendTime=0}),this.telnet.on("received-data",n=>{n={value:n},this.emit("received-data",n),!(n===null||typeof n>"u"||n.value===null||typeof n.value>"u")&&(this.printInternal(n.value,!1,!0),this.debug("Latency: "+this.telnet.latency+"ms"),this.debug("Latency: "+this.telnet.latency/1e3+"s"))}),this.telnet.on("received-MSDP",n=>{this.emit("received-MSDP",n)}),this.telnet.on("received-GMCP",n=>{let s=n.value,i,o=0,r=s.length,a;if(r===0)return;for(o=0;o<r&&(a=s.charAt(o),!(a===" "||a==="{"||a==="["));o++);i=s.substr(0,o).trim(),s=s.substr(o).trim(),this.debug("GMCP Module: "+i),this.debug("GMCP Data: "+s);let l;if(i.toLowerCase()==="client.gui"){l=s.split("/n"),s.length>=2?l={version:parseInt(l[0],10),url:l[1]}:s.length>0?l={version:parseInt(l[0],10),url:l[1]}:l={version:l,url:""},this.emit("received-GMCP",i,l);return}try{s.length>0&&(l=JSON.parse(s))}catch{this.error("Invalid GMCP");return}this.emit("received-GMCP",i,l)}),this.telnet.on("windowSize",()=>{this.UpdateWindow()});let e=dt("host");e!==null&&e.length?this.host=e:t&&"host"in t?this.host=t.host:this.host="127.0.0.1",e=+dt("port"),!isNaN(e)&&e>0?this.port=e:t&&"port"in t?this.port=t.port:this.port=23,this._input=new et(this),this._input.on("scroll-lock",n=>{this.display.scrollLock=n,this.emit("scroll-lock",n)}),this._input.on("command-history-changed",n=>this.emit("command-history-changed",n)),this._input.on("item-added",(n,s,i)=>{this.emit("item-added",n,s,i)}),this._input.on("item-updated",(n,s,i,o)=>{this.emit("item-updated",n,s,i,o)}),this._input.on("item-removed",(n,s,i)=>{this.emit("item-removed",n,s,i)}),this.loadOptions(),this._commandInput.value="",this._commandInput.focus(),window.addEventListener("blur",()=>{this.active=!1,this.emit("blur"),this.raise("blur")}),window.addEventListener("focus",()=>{this.active=!0,this.emit("focus"),this.raise("focus")}),window.addEventListener("beforeunload",n=>{if(this.connected)return n&&(n.returnValue="Closing or reloading will disconnect you from the mud."),"Closing or reloading will disconnect you from the mud.";this.raise("closed")}),window.addEventListener("unload",()=>{this.connected&&this.close()}),this.addPlugin(new at(this)),this.options.autoConnect&&setTimeout(()=>{this.connect()},600),this.emit("initialized")}get telnet(){return this._telnet}get variables(){return this._variables}get commandInput(){return this._commandInput}get display(){return this._display}get profiles(){return this._profiles}get plugins(){return this._plugins}get options(){return this._options}get input(){return this._input}set simpleAlarms(t){this.setOption("simpleAlarms",t)}get simpleAlarms(){return this.getOption("simpleAlarms")}set enableParsing(t){this.setOption("enableParsing",t),this._input.enableParsing=t}get enableParsing(){return this.getOption("enableParsing")}set enableTriggers(t){this.setOption("enableTriggers",t),this._input.enableTriggers=t,this.startAlarms()}get enableTriggers(){return this.getOption("enableTriggers")}get enableDebug(){return this._enableDebug}set enableDebug(t){this._enableDebug=t,this._telnet.enableDebug=t,this._display.enableDebug=t}get host(){return this._telnet.host}set host(t){this._telnet.host=t}get port(){return this._telnet.port}set port(t){this._telnet.port=t}get connected(){return this._telnet.connected}get activeProfile(){return this._profiles.active}get commandHistory(){return this._input.commandHistory}get aliases(){if(this._itemCache.aliases)return this._itemCache.aliases;let t=this.profiles.keys,e=[],n=0,s=t.length;if(s===0)return[];if(s===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableAliases?this._itemCache.aliases=[]:this._itemCache.aliases=W(this.profiles.items[t[n]].aliases),this._itemCache.aliases;for(;n<s;n++)!this.profiles.items[t[n]].enabled||!this.profiles.items[t[n]].enableAliases||this.profiles.items[t[n]].aliases.length===0||e.push.apply(e,W(this.profiles.items[t[n]].aliases));return this._itemCache.aliases=e,this._itemCache.aliases}get macros(){if(this._itemCache.macros)return this._itemCache.macros;let t=this.profiles.keys,e=[],n=0,s=t.length;if(s===0)return[];if(s===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableMacros?this._itemCache.macros=[]:this._itemCache.macros=W(this.profiles.items[t[n]].macros),this._itemCache.macros;for(;n<s;n++)!this.profiles.items[t[n]].enabled||!this.profiles.items[t[n]].enableMacros||this.profiles.items[t[n]].macros.length===0||e.push.apply(e,W(this.profiles.items[t[n]].macros));return this._itemCache.macros=e,this._itemCache.macros}get triggers(){if(this._itemCache.triggers)return this._itemCache.triggers;let t=this.profiles.keys,e=[],n=0,s=t.length;if(s===0)return[];if(s===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableTriggers?this._itemCache.triggers=[]:this._itemCache.triggers=W(this.profiles.items[t[0]].triggers),this._itemCache.triggers;for(;n<s;n++)!this.profiles.items[t[n]].enabled||!this.profiles.items[t[n]].enableTriggers||this.profiles.items[t[n]].triggers.length===0||e.push.apply(e,W(this.profiles.items[t[n]].triggers));return this._itemCache.triggers=e,this._itemCache.triggers}removeTrigger(t){let e=this.profiles.keys,n=0,s=e.length,i=-1;if(s!==0){if(s===1){if(!this.profiles.items[e[0]].enabled||!this.profiles.items[e[0]].enableTriggers)return;i=this.profiles.items[e[n]].triggers.indexOf(t)}else for(;n<s&&i!==-1&&!(!(!this.profiles.items[e[n]].enabled||!this.profiles.items[e[n]].enableTriggers||this.profiles.items[e[n]].triggers.length===0)&&(i=this.profiles.items[e[n]].triggers.indexOf(t),i!==-1));n++);i!==-1&&(this.profiles.items[e[n]].triggers.splice(i,1),this._itemCache.triggers=null,(t.triggers.length||t.type===3)&&this._itemCache.alarms&&(i=this._itemCache.alarms.indexOf(t),i!==-1&&(this._itemCache.alarms.splice(i,1),this._itemCache.alarmPatterns.splice(i,1))),this.saveProfiles(),this.emit("item-removed","trigger",e[n],i))}}get alarms(){if(this._itemCache.alarms)return this._itemCache.alarms;let t=this.profiles.keys,e=[],n=0,s=t.length;if(s===0)return[];if(s===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableTriggers?this._itemCache.alarms=[]:this._itemCache.alarms=$.grep(W(this.profiles.items[t[n]].triggers),i=>{if(i&&i.enabled&&i.triggers.length){if(i.type===3)return!0;for(let o=0,r=i.triggers.length;o<r;o++)if(i.triggers[o].enabled&&i.triggers[o].type===3)return!0;return!1}return i&&i.enabled&&i.type===3}),this._itemCache.alarms.reverse(),this._itemCache.alarms;for(;n<s;n++)!this.profiles.items[t[n]].enabled||!this.profiles.items[t[n]].enableTriggers||this.profiles.items[t[n]].triggers.length===0||e.push.apply(e,W(this.profiles.items[t[n]].triggers));return this._itemCache.alarms=$.grep(e,i=>{if(i&&i.enabled&&i.triggers.length){if(i.type===3)return!0;for(let o=0,r=i.triggers.length;o<r;o++)if(i.triggers[o].enabled&&i.triggers[o].type===3)return!0;return!1}return i&&i.enabled&&i.type===3}),this._itemCache.alarms.reverse(),this._itemCache.alarms}get buttons(){if(this._itemCache.buttons)return this._itemCache.buttons;let t=this.profiles.keys,e=[],n=0,s=t.length;if(s===0)return[];if(s===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableButtons?this._itemCache.buttons=[]:this._itemCache.buttons=W(this.profiles.items[t[n]].buttons),this._itemCache.buttons;for(;n<s;n++)!this.profiles.items[t[n]].enabled||!this.profiles.items[t[n]].enableButtons||this.profiles.items[t[n]].buttons.length===0||e.push.apply(e,W(this.profiles.items[t[n]].buttons));return this._itemCache.buttons=e,this._itemCache.buttons}addPlugin(t){t&&(this.plugins.push(t),t.initialize())}removePlugin(t){if(!this.plugins.length)return;let e=this.plugins.indexOf(t);e!==-1&&(t.remove(),this.plugins.splice(e,1))}getVariable(t){return this.variables[t]}setVariable(t,e){this.variables[t]=e}setVariables(t){let e=Object.keys(t);if(e.length===0)return;let n=e.length,s;for(let i=0;i<n;i++)s=e[i],this.variables[s]=t[s]}hasVariable(t){return this.variables.hasOwnProperty(t)}removeVariable(t){this.variables.hasOwnProperty(t)&&delete this.variables[t]}setHistoryIndex(t){this._input.setHistoryIndex(t)}clearCommandHistory(){this._input.clearCommandHistory()}AddCommandToHistory(t){this._input.AddCommandToHistory(t)}loadProfiles(){this._profiles=new Ke,this._profiles.load().then(()=>{this.profiles.contains("default")||(this.profiles.add(ce.Default),this.saveProfiles()),this.clearCache(),this.startAlarms(),this.emit("profiles-loaded")})}removeProfile(t){t&&(this.profiles.remove(t),this.clearCache(),this.startAlarms(),this.emit("profile-removed",t))}saveProfiles(){this._profiles.save(),this.clearCache(),this.emit("profiles-updated")}toggleProfile(t){this.profiles.toggle(t),this.saveProfiles(),this.clearCache(),this.startAlarms(),this.emit("profile-toggled",t,this.profiles[t].enabled)}startAlarms(){let t=this.alarms.length;(t===0||!this.getOption("enableTriggers"))&&this._alarm?(clearInterval(this._alarm),this._alarm=null):t&&!this._alarm&&(this._alarm=setInterval(e=>{e.process_alarms()},1e3,this))}setAlarmState(t,e){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length)return;let n=this._itemCache.alarmPatterns[t];if(!n){n={},this.alarms[t].type===3&&(n[0]=le.parse(this.alarms[t]));for(let s=0,i=this.alarms[t].triggers.length;s<i;s++)this.alarms[t].triggers[s].enabled&&this.alarms[t].triggers[s].type===3&&(n[s]=le.parse(this.alarms[t].triggers[s]));this._itemCache.alarmPatterns[t]=n}for(let s in n)n.hasOwnProperty(s)&&(e?(n[s].startTime+=Date.now()-n[s].suspended,n[s].prevTime+=Date.now()-n[s].suspended,n[s].tempTime&&(n[s].tempTime+=Date.now()-n[s].suspended),n[s].suspended=0):n[s].suspended=Date.now())}setAlarmTempTime(t,e){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length)return;let n=this._itemCache.alarmPatterns[t];if(!n){n={},this.alarms[t].type===3&&(n[0]=le.parse(this.alarms[t]));for(let s=0,i=this.alarms[t].triggers.length;s<i;s++)this.alarms[t].triggers[s].enabled&&this.alarms[t].triggers[s].type===3&&(n[s]=le.parse(this.alarms[t].triggers[s]));this._itemCache.alarmPatterns[t]=n}n[0]&&n[0].setTempTime(e)}restartAlarmState(t,e,n){if(e===n||(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length))return;let s=this._itemCache.alarmPatterns[t];if(!s){s={},this.alarms[t].type===3&&(s[0]=le.parse(this.alarms[t]));for(let i=0,o=this.alarms[t].triggers.length;i<o;i++)this.alarms[t].triggers[i].enabled&&this.alarms[t].triggers[i].type===3&&(s[i]=le.parse(this.alarms[t].triggers[i]));this._itemCache.alarmPatterns[t]=s}s[e]&&(s[e].restart=Date.now()),s[n]&&(s[n].restart=Date.now())}getRemainingAlarmTime(t){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length||!this.alarms[t].enabled)return 0;let e=this._itemCache.alarmPatterns[t];if(!e){e={},this.alarms[t].type===3&&(e[0]=le.parse(this.alarms[t]));for(let n=0,s=this.alarms[t].triggers.length;n<s;n++)this.alarms[t].triggers[n].enabled&&this.alarms[t].triggers[n].type===3&&(e[n]=le.parse(this.alarms[t].triggers[n]));this._itemCache.alarmPatterns[t]=e}if(e[0]){let n=e[0],s=Date.now(),i=new Date,o=s,r=o+9e7,a=1e3;if(n.seconds!==-1?a=1e3:n.minutes!==-1?a=6e4:n.hours!==-1&&(a=36e5),n.tempTime)return n.tempTime-s>0?n.tempTime-s:0;for(;o<r;){if(this.alarm_match(n,o,i))return o-s;o+=a,i.setTime(i.getTime()+a)}return-1}return 0}updateAlarms(){if(this._itemCache.alarmPatterns){let t=this._itemCache.alarmPatterns,e=this.alarms;this._itemCache.alarmPatterns=[],this._itemCache.alarms=null;let n=this.alarms.length,s=-1;for(let i=0;i<n;i++)s=e.indexOf(this.alarms[i]),s!==-1&&(this._itemCache.alarmPatterns[i]=t[s])}this.startAlarms()}process_alarms(){if(!this.getOption("enableTriggers"))return;let t=0,e=!1,n=this.alarms.length;if(n===0&&this._alarm){clearInterval(this._alarm),this._alarm=null;return}let s=this._itemCache.alarmPatterns,i=Date.now(),o=this.alarms,r=new Date;for(t=n-1;t>=0;t--){let a=o[t],l=a;if(!a.enabled)continue;if(a.state>a.triggers.length&&(a.state=0),a.state!==0&&a.triggers&&a.triggers.length){for(a=a.triggers[a.state-1];!a.enabled&&l.state!==0;){if(l.state++,l.state>l.triggers.length){l.state=0,a=a.triggers[l.state-1];break}l.state?a=a.triggers[l.state-1]:a=l,e=!0}if(e&&(this.getOption("saveTriggerStateChanges")&&this.saveProfiles(),this.emit("item-updated","trigger",l.profile.name,l.profile.triggers.indexOf(l))),!a.enabled)continue}if(a.type===131072||a.type===262144){let b=this._input.adjustLastLine(this.display.lines.length,!0),h=this.display.lines[b];t=this._input.TestTrigger(a,l,t,h,this.display.lines[b].raw||h,b===this.display.lines.length-1);continue}if(a.type!==3)continue;let f=s[t];if(!f){try{s[t]={},a.type===3&&(s[t][0]=le.parse(a));for(let b=0,h=a.triggers.length;b<h;b++)a.triggers[b].type===3&&(s[t][b]=le.parse(a.triggers[b]))}catch(b){throw s[t]=null,this.getOption("disableTriggerOnError")&&(a.enabled=!1,setTimeout(()=>{this.saveProfiles(),this.emit("item-updated","trigger",l.profile,l.profile.triggers.indexOf(l),l)})),b}if(f=s[t],!f)continue}f=f[a.state],f.restart&&(f.startTime=Date.now(),f.prevTime=f.startTime,f.tempTime&&(f.tempTime+=Date.now()-f.restart),f.restart=0);let u=!0;if(f.tempTime?(u=i>=f.tempTime,u&&(f.tempTime=0)):u=this.alarm_match(f,i,r),u&&!f.suspended){f.prevTime=i;let b=l.state;if(this._input.lastTriggered=f.pattern,this._input.ExecuteTrigger(a,[f.pattern],!1,-t,null,null,l),b!==l.state&&(f.restart=Date.now()),f.temp)if(l.triggers.length)if(b===0){let h=l.triggers.shift();h.state=b,h.priority=l.priority,h.name=l.name,h.profile=l.profile,h.state>h.triggers.length&&(h.state=0),h.triggers=l.triggers,o[t]=h,s[t]=null,this.saveProfiles();let E=l.profile.triggers.indexOf(l);l.profile.triggers[E]=h,this.emit("item-updated","trigger",l.profile.name,E,h)}else{l.triggers.splice(b-1,1),s[t].splice(b-1,1),l.state=b,l.state>l.triggers.length&&(l.state=0),this.saveProfiles();let h=l.profile.triggers.indexOf(l);this.emit("item-updated","trigger",l.profile.name,h,l)}else this._input.clearTriggerState(t),this.removeTrigger(l);t=-this._input.cleanUpTriggerState(-t)}}}alarm_match(t,e,n){if(!t||t.suspended)return!1;let s=!0,i,o,r,a,l,f,u;if(!moment||this.simpleAlarms){if(i=e-this.connectTime,i<1e3)return!1;o=Math.round(i/1e3),r=Math.floor(o/60),a=Math.floor(r/60),l=a,f=Math.floor(r%60),u=Math.floor(o%60)}else{if(t.start?i=moment.duration(e-this.connectTime):i=moment.duration(e-t.startTime),i.asMilliseconds()<1e3)return!1;o=Math.round(i.asMilliseconds()/1e3),r=Math.floor(o/60),a=Math.floor(r/60),l=i.hours(),f=i.minutes(),u=i.seconds()}return t.hoursWildCard?t.hours===0?s=s&&l===0:t.hours!==-1&&(s=s&&a!==0&&a%t.hours===0):t.hours!==-1&&(s=s&&t.hours===(t.start?l:n.getHours())),t.minutesWildcard?t.minutes===0?s=s&&f===0:t.minutes!==-1&&(s=s&&r!==0&&r%t.minutes===0):t.minutes!==-1&&(s=s&&t.minutes===(t.start?f:n.getMinutes())),t.secondsWildcard?t.seconds===0?s=s&&u===0:t.seconds!==-1&&(s=s&&o%t.seconds===0):t.seconds!==-1&&(s=s&&t.seconds===(t.start?u:n.getSeconds())),s}loadOptions(){if(this._options=new _e,this.loadProfiles(),this.enableDebug=this._options.enableDebug,this.display.maxLines=this._options.bufferSize,this.display.enableFlashing=this._options.flashing,this.display.enableMXP=this._options.enableMXP,this.display.showInvalidMXPTags=this._options["display.showInvalidMXPTags"],this.display.enableURLDetection=this._options.enableURLDetection,this.display.enableMSP=this._options.enableMSP,this.display.enableColors=this._options["display.enableColors"],this.display.enableBackgroundColors=this._options["display.enableBackgroundColors"],this._options.colors&&this._options.colors?.length>0)for(var t=this._options.colors,e=0,n=t.length;e<n;e++)!t[e]||t[e].length===0||this.display.SetColor(e,t[e]);this._telnet&&(this._telnet.options.MCCP=this._options.enableMCCP,this._telnet.options.MXP=this._options.enableMXP,this._telnet.UTF8=this._options.enableUTF8,this._telnet.options.ECHO=this._options.enableEcho,this._telnet.enableLatency=this._options.lagMeter,this._telnet.enablePing=this._options.enablePing),this._input.scrollLock=this._options.scrollLocked,this._input.enableParsing=this._options.enableParsing,this._input.enableTriggers=this._options.enableTriggers,this.display.scrollLock=this._options.scrollLocked,this.display.hideTrailingEmptyLine=this._options["display.hideTrailingEmptyLine"],this.UpdateFonts&&this.UpdateFonts(),this.display.scrollDisplay(),this.emit("options-loaded")}setOption(t,e){t===-1||t==="-1"||(this._options[t]=e,_e.setValue(t,e),this.emit("option=changed",t,e))}getOption(t){return this._options&&t in this._options?this._options[t]:this._options[t]=_e.getValue(t)}UpdateFonts(){this.display&&(this.display.updateFont(this._options.font,this._options.fontSize),this._commandInput.style.fontSize=this._options.cmdfontSize,this._commandInput.style.fontFamily=this._options.cmdfont+", monospace")}parse(t){this.parseInternal(t,!1,!1,!0)}parseInternal(t,e,n,s){this.display.append(t,e,n,s)}error(t){this.enableDebug&&this.debug(t);let e="";t==null||typeof t>"u"?t=new Error("Unknown"):typeof t=="string"&&t.length===0&&(t=new Error("Unknown")),t.stack&&this.getOption("showErrorsExtended")?e=t.stack:t instanceof Error||t instanceof TypeError?e=t.name+": "+t.message:t.message?e=t.message:e=""+t,e.match(/^.*Error: /g)||e.match(/^.*Error - /g)?this.echo(e,-11,-12,!0,!0):this.echo("Error: "+e,-11,-12,!0,!0),this.getOption("logErrors")&&(this.getOption("showErrorsExtended")?t.stack||(t=new Error(t||e),e=t.stack):(t.stack||(t=new Error(t||e)),e=t.stack),window.console.log(new Date().toLocaleString()),window.console.log(e)),t==="Error: ECONNRESET - read ECONNRESET."&&this.telnet.connected&&this.close(),this.raise("error",e)}echo(t,e,n,s,i){t==null&&(t=""),s==null&&(s=!1),i==null&&(i=!1),e==null&&(e=-3),n==null&&(n=-4);let o="\x1B[0m"+this.display.CurrentAnsiCode()+`
`;t=""+t,t.endsWith(`
`)&&(t=t.substr(0,t.length-1)),this.telnet.prompt&&i?(this.print(`
\x1B[`+e+";"+n+"m"+t+o,s),this.telnet.prompt=!1):this.print("\x1B["+e+";"+n+"m"+t+o,s)}print(t,e){this.printInternal(t,e,!1,!0)}printInternal(t,e,n,s){t==null||typeof t>"u"||(e==null&&(e=!1),n==null&&(n=!1),e&&this.display.textLength>0&&!this.display.EndOfLine&&this.display.EndOfLineLength!==0&&!this.telnet.prompt&&!this.display.parseQueueEndOfLine&&(t=`
`+t),this.parseInternal(t,n,!1,s))}send(t,e){this.telnet.sendData(t),this.lastSendTime=Date.now(),e&&this.telnet.echo&&this.getOption("commandEcho")?this.echo(t):e&&this.echo(`
`)}sendRaw(t){this.telnet.sendData(t,!0),this.lastSendTime=Date.now()}sendGMCP(t){this.telnet.sendGMCP(t),this.lastSendTime=Date.now()}debug(t,e){let n={value:t};this.emit("debug",n),!(!this._enableDebug||n==null||typeof n>"u"||n.value==null||typeof n.value>"u"||n.value.length===0)&&window.console&&(e?window.console.log("%c"+t,e):window.console.log(n.value))}sendCommand(t,e,n){t==null&&(t=this._commandInput.value,this.telnet.echo?this._input.AddCommandToHistory(t):this._commandInput.value=""),t=""+t,t.endsWith(`
`)||(t=t+`
`);let s={value:t,handled:!1,comments:n};this.emit("parse-command",s),!(s==null||typeof s>"u")&&(s.handled||s.value==null||typeof s.value>"u"||(s.value.length>0&&this.send(s.value,!e),this.getOption("keepLastCommand")?Ot(this._commandInput):this._commandInput.value=""))}sendBackground(t,e,n){t==null&&(t=this._commandInput.value,this.telnet.echo?this._input.AddCommandToHistory(t):this._commandInput.value=""),t=""+t,t.endsWith(`
`)||(t=t+`
`);let s={value:t,handled:!1,comments:n};this.emit("parse-command",s),!(s==null||typeof s>"u")&&(s.value==null||typeof s.value>"u"||!s.handled&&s.value.length>0&&this.send(s.value,!e))}get scrollLock(){return this._input.scrollLock}set scrollLock(t){this._input.scrollLock=t}toggleScrollLock(){this._input.toggleScrollLock()}UpdateWindow(){this.display.updateWindow()}close(){this.telnet.close()}connect(){this.errored=!1,this.emit("connecting"),this.display.ClearMXP(),this.display.ResetMXPLine(),this.telnet.connect(),this.emit("connect"),this._commandInput.focus()}receivedData(t){this.telnet.receivedData(t)}notify(t,e,n){this.enableDebug&&(this.emit("debug","notify title: "+t),this.emit("debug","notify msg: "+e)),this.emit("notify",t,e,n)}clear(){this.display.clear(),this.emit("cleared")}parseInline(t){return this._input.parseInline(t)}parseOutgoing(t,e,n,s){return this._input.parseOutgoing(t,e,n,s)}clearCache(){this._input.clearCaches(),this._itemCache={triggers:null,aliases:null,macros:null,buttons:null,alarms:null,alarmPatterns:[]}}beep(){this.emit("bell")}raise(t,e,n){!n||n<1?this._input.triggerEvent(t,e):setTimeout(()=>{this._input.triggerEvent(t,e)},n)}show(){this.emit("show")}hide(){this.emit("hide")}toggle(){this.emit("toggle")}};window.Client=Ae;window.Display=$e;})();
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
/**
 * A class to parse color values
 * @author Stoyan Stefanov <sstoo@gmail.com>
 * @link   http://www.phpied.com/rgb-color-parser-in-javascript/
 * @license Use it if you like it
 */
//# sourceMappingURL=oiMUD.core.min.js.map
