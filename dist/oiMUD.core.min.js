(()=>{var Xt=Object.create;var It=Object.defineProperty;var jt=Object.getOwnPropertyDescriptor;var Gt=Object.getOwnPropertyNames;var zt=Object.getPrototypeOf,Qt=Object.prototype.hasOwnProperty;var Lt=(m,c)=>()=>(c||m((c={exports:{}}).exports,c),c.exports);var Vt=(m,c,t,e)=>{if(c&&typeof c=="object"||typeof c=="function")for(let i of Gt(c))!Qt.call(m,i)&&i!==t&&It(m,i,{get:()=>c[i],enumerable:!(e=jt(c,i))||e.enumerable});return m};var Ot=(m,c,t)=>(t=m!=null?Xt(zt(m)):{},Vt(c||!m||!m.__esModule?It(t,"default",{value:m,enumerable:!0}):t,m));var Bt=Lt(Rt=>{(function(){"use strict";var m=void 0,c=!0,t=this;function e(_,O){var U=_.split("."),B=t;!(U[0]in B)&&B.execScript&&B.execScript("var "+U[0]);for(var C;U.length&&(C=U.shift());)!U.length&&O!==m?B[C]=O:B=B[C]?B[C]:B[C]={}}var i=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u"&&typeof DataView<"u";function n(_){var O=_.length,U=0,B=Number.POSITIVE_INFINITY,C,N,M,z,w,V,D,L,R,j;for(L=0;L<O;++L)_[L]>U&&(U=_[L]),_[L]<B&&(B=_[L]);for(C=1<<U,N=new(i?Uint32Array:Array)(C),M=1,z=0,w=2;M<=U;){for(L=0;L<O;++L)if(_[L]===M){for(V=0,D=z,R=0;R<M;++R)V=V<<1|D&1,D>>=1;for(j=M<<16|L,R=V;R<C;R+=w)N[R]=j;++z}++M,z<<=1,w<<=1}return[N,U,B]}function s(_,O,U){this.u=[],this.i=U||32768,this.v=0,this.a=O===m?0:O,this.d=this.e=0,this.input=i?new Uint8Array(_):_,this.b=new(i?Uint8Array:Array)(this.i),this.c=0,this.t=this.l=!1,this.f=0,this.status=o}var o=0;s.prototype.j=function(_,O){var U=!1;for(_!==m&&(this.input=_),O!==m&&(this.a=O);!U;)switch(this.status){case o:case 1:var B,C=m;if(this.status=1,W(this),0>(C=d(this,3)))K(this),B=-1;else{switch(C&1&&(this.l=c),C>>>=1,C){case 0:this.h=0;break;case 1:this.h=1;break;case 2:this.h=2;break;default:throw Error("unknown BTYPE: "+C)}this.status=2,B=m}0>B&&(U=c);break;case 2:case 3:switch(this.h){case 0:var N,M=m,z=m,w=this.input,V=this.a;if(this.status=3,V+4>=w.length)N=-1;else{if(M=w[V++]|w[V++]<<8,z=w[V++]|w[V++]<<8,M===~z)throw Error("invalid uncompressed block header: length verify");this.d=this.e=0,this.a=V,this.m=M,this.status=4,N=m}0>N&&(U=c);break;case 1:this.status=3,this.k=x,this.n=y,this.status=4;break;case 2:var D;e:{var L=m,R=m,j=m,te=new(i?Uint8Array:Array)(a.length),he=m;if(this.status=3,W(this),L=d(this,5)+257,R=d(this,5)+1,j=d(this,4)+4,0>L||0>R||0>j)K(this),D=-1;else{try{for(var le=m,re=m,Se=0,ce=m,Q=m,fe=m,Tt=m,fe=0;fe<j;++fe){if(0>(le=d(this,3)))throw Error("not enough input");te[a[fe]]=le}for(he=n(te),Q=new(i?Uint8Array:Array)(L+R),fe=0,Tt=L+R;fe<Tt;){if(re=v(this,he),0>re)throw Error("not enough input");switch(re){case 16:if(0>(le=d(this,2)))throw Error("not enough input");for(ce=3+le;ce--;)Q[fe++]=Se;break;case 17:if(0>(le=d(this,3)))throw Error("not enough input");for(ce=3+le;ce--;)Q[fe++]=0;Se=0;break;case 18:if(0>(le=d(this,7)))throw Error("not enough input");for(ce=11+le;ce--;)Q[fe++]=0;Se=0;break;default:Se=Q[fe++]=re}}new(i?Uint8Array:Array)(L),new(i?Uint8Array:Array)(R),this.k=n(i?Q.subarray(0,L):Q.slice(0,L)),this.n=n(i?Q.subarray(L):Q.slice(L))}catch{K(this),D=-1;break e}this.status=4,D=0}}0>D&&(U=c)}break;case 4:case 5:switch(this.h){case 0:var mt;e:{var _t=this.input,Ve=this.a,dt=this.b,Ye=this.c,gt=this.m;for(this.status=5;gt--;){if(Ye===dt.length&&(dt=ne(this,{o:2})),Ve>=_t.length){this.a=Ve,this.c=Ye,this.m=gt+1,mt=-1;break e}dt[Ye++]=_t[Ve++]}0>gt&&(this.status=6),this.a=Ve,this.c=Ye,mt=0}0>mt&&(U=c);break;case 1:case 2:0>ae(this)&&(U=c)}break;case 6:this.l?U=c:this.status=o}var k,me=this.c,Pt;return k=this.t?i?new Uint8Array(this.b.subarray(this.f,me)):this.b.slice(this.f,me):i?this.b.subarray(this.f,me):this.b.slice(this.f,me),this.f=me,me>32768+this.i&&(this.c=this.f=32768,i?(Pt=this.b,this.b=new Uint8Array(this.i+32768),this.b.set(Pt.subarray(me-32768,me))):this.b=this.b.slice(me-32768)),k};var r=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],a=i?new Uint16Array(r):r,l=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],f=i?new Uint16Array(l):l,u=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],b=i?new Uint8Array(u):u,h=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],E=i?new Uint16Array(h):h,S=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],p=i?new Uint8Array(S):S,g=new(i?Uint8Array:Array)(288),T,P;for(T=0,P=g.length;T<P;++T)g[T]=143>=T?8:255>=T?9:279>=T?7:8;var x=n(g),G=new(i?Uint8Array:Array)(30),A,I;for(A=0,I=G.length;A<I;++A)G[A]=5;var y=n(G);function d(_,O){for(var U=_.e,B=_.d,C=_.input,N=_.a,M;B<O;){if(C.length<=N)return-1;M=C[N++],U|=M<<B,B+=8}return M=U&(1<<O)-1,_.e=U>>>O,_.d=B-O,_.a=N,M}function v(_,O){for(var U=_.e,B=_.d,C=_.input,N=_.a,M=O[0],z=O[1],w,V,D;B<z;){if(C.length<=N)return-1;w=C[N++],U|=w<<B,B+=8}if(V=M[U&(1<<z)-1],D=V>>>16,D>B)throw Error("invalid code length: "+D);return _.e=U>>D,_.d=B-D,_.a=N,V&65535}function W(_){_.s=_.a,_.r=_.d,_.q=_.e}function K(_){_.a=_.s,_.d=_.r,_.e=_.q}function ae(_){var O=_.b,U=_.c,B,C,N,M,z=_.k,w=_.n,V=O.length,D;for(_.status=5;;){if(W(_),B=v(_,z),0>B)return _.c=U,K(_),-1;if(B===256)break;if(256>B)U===V&&(O=ne(_),V=O.length),O[U++]=B;else{if(C=B-257,M=f[C],0<b[C]){if(D=d(_,b[C]),0>D)return _.c=U,K(_),-1;M+=D}if(B=v(_,w),0>B)return _.c=U,K(_),-1;if(N=E[B],0<p[B]){if(D=d(_,p[B]),0>D)return _.c=U,K(_),-1;N+=D}for(U+M>=V&&(O=ne(_),V=O.length);M--;)O[U]=O[U++-N];if(_.a===_.input.length)return _.c=U,-1}}for(;8<=_.d;)_.d-=8,_.a--;_.c=U,_.status=6}function ne(_,O){var U,B=_.input.length/_.a+1|0,C,N,M,z=_.input,w=_.b;return O&&(typeof O.o=="number"&&(B=O.o),typeof O.p=="number"&&(B+=O.p)),2>B?(C=(z.length-_.a)/_.k[2],M=258*(C/2)|0,N=M<w.length?w.length+M:w.length<<1):N=w.length*B,i?(U=new Uint8Array(N),U.set(w)):U=w,_.b=U,_.b}function q(_){this.input=_===m?new(i?Uint8Array:Array):_,this.a=0,this.g=new s(this.input,this.a),this.b=this.g.b}q.prototype.j=function(_){var O;if(_!==m)if(i){var U=new Uint8Array(this.input.length+_.length);U.set(this.input,0),U.set(_,this.input.length),this.input=U}else this.input=this.input.concat(_);var B;if(B=this.method===m){var C,N=this.a,M=this.input,z=M[N++],w=M[N++];if(z===m||w===m)C=-1;else{switch(z&15){case 8:this.method=8;break;default:throw Error("unsupported compression method")}if(((z<<8)+w)%31!==0)throw Error("invalid fcheck flag:"+((z<<8)+w)%31);if(w&32)throw Error("fdict flag is not supported");this.a=N,C=m}B=0>C}return B?new(i?Uint8Array:Array):(O=this.g.j(this.input,this.a),this.g.a!==0&&(this.input=i?this.input.subarray(this.g.a):this.input.slice(this.g.a),this.a=0),O)},e("Zlib.InflateStream",q),e("Zlib.InflateStream.prototype.decompress",q.prototype.j)}).call(Rt)});var Ht=Lt(($t,ut)=>{(function(m,c){"use strict";typeof ut<"u"&&ut.exports?ut.exports=c():typeof define=="function"&&define.amd?define([],c):m.buzz=c()})($t,function(){"use strict";var m=window.AudioContext||window.webkitAudioContext,c={defaults:{autoplay:!1,duration:5e3,formats:[],loop:!1,placeholder:"--",preload:"metadata",volume:80,webAudioApi:!1,document:window.document},types:{mp3:"audio/mpeg",ogg:"audio/ogg",wav:"audio/wav",aac:"audio/aac",m4a:"audio/x-m4a"},sounds:[],el:document.createElement("audio"),getAudioContext:function(){if(this.audioCtx===void 0)try{this.audioCtx=m?new m:null}catch{this.audioCtx=null}return this.audioCtx},sound:function(t,e){e=e||{};var i=e.document||c.defaults.document,n=0,s=[],o={},r=c.isSupported();this.load=function(){return r?(this.sound.load(),this):this},this.play=function(){return r?(this.sound.play(),this):this},this.togglePlay=function(){return r?(this.sound.paused?this.sound.play():this.sound.pause(),this):this},this.pause=function(){return r?(this.sound.pause(),this):this},this.isPaused=function(){return r?this.sound.paused:null},this.stop=function(){return r?(this.setTime(0),this.sound.pause(),this):this},this.isEnded=function(){return r?this.sound.ended:null},this.loop=function(){return r?(this.sound.loop="loop",this.bind("ended.buzzloop",function(){this.currentTime=0,this.play()}),this):this},this.unloop=function(){return r?(this.sound.removeAttribute("loop"),this.unbind("ended.buzzloop"),this):this},this.mute=function(){return r?(this.sound.muted=!0,this):this},this.unmute=function(){return r?(this.sound.muted=!1,this):this},this.toggleMute=function(){return r?(this.sound.muted=!this.sound.muted,this):this},this.isMuted=function(){return r?this.sound.muted:null},this.setVolume=function(E){return r?(E<0&&(E=0),E>100&&(E=100),this.volume=E,this.sound.volume=E/100,this):this},this.getVolume=function(){return r?this.volume:this},this.increaseVolume=function(E){return this.setVolume(this.volume+(E||1))},this.decreaseVolume=function(E){return this.setVolume(this.volume-(E||1))},this.setTime=function(E){if(!r)return this;var S=!0;return this.whenReady(function(){S===!0&&(S=!1,this.sound.currentTime=E)}),this},this.getTime=function(){if(!r)return null;var E=Math.round(this.sound.currentTime*100)/100;return isNaN(E)?c.defaults.placeholder:E},this.setPercent=function(E){return r?this.setTime(c.fromPercent(E,this.sound.duration)):this},this.getPercent=function(){if(!r)return null;var E=Math.round(c.toPercent(this.sound.currentTime,this.sound.duration));return isNaN(E)?c.defaults.placeholder:E},this.setSpeed=function(E){return r?(this.sound.playbackRate=E,this):this},this.getSpeed=function(){return r?this.sound.playbackRate:null},this.getDuration=function(){if(!r)return null;var E=Math.round(this.sound.duration*100)/100;return isNaN(E)?c.defaults.placeholder:E},this.getPlayed=function(){return r?a(this.sound.played):null},this.getBuffered=function(){return r?a(this.sound.buffered):null},this.getSeekable=function(){return r?a(this.sound.seekable):null},this.getErrorCode=function(){return r&&this.sound.error?this.sound.error.code:0},this.getErrorMessage=function(){if(!r)return null;switch(this.getErrorCode()){case 1:return"MEDIA_ERR_ABORTED";case 2:return"MEDIA_ERR_NETWORK";case 3:return"MEDIA_ERR_DECODE";case 4:return"MEDIA_ERR_SRC_NOT_SUPPORTED";default:return null}},this.getStateCode=function(){return r?this.sound.readyState:null},this.getStateMessage=function(){if(!r)return null;switch(this.getStateCode()){case 0:return"HAVE_NOTHING";case 1:return"HAVE_METADATA";case 2:return"HAVE_CURRENT_DATA";case 3:return"HAVE_FUTURE_DATA";case 4:return"HAVE_ENOUGH_DATA";default:return null}},this.getNetworkStateCode=function(){return r?this.sound.networkState:null},this.getNetworkStateMessage=function(){if(!r)return null;switch(this.getNetworkStateCode()){case 0:return"NETWORK_EMPTY";case 1:return"NETWORK_IDLE";case 2:return"NETWORK_LOADING";case 3:return"NETWORK_NO_SOURCE";default:return null}},this.set=function(E,S){return r?(this.sound[E]=S,this):this},this.get=function(E){return r?E?this.sound[E]:this.sound:null},this.bind=function(E,S){if(!r)return this;E=E.split(" ");for(var p=this,g=function(G){S.call(p,G)},T=0;T<E.length;T++){var P=E[T],x=P;P=x.split(".")[0],s.push({idx:x,func:g}),this.sound.addEventListener(P,g,!0)}return this},this.unbind=function(E){if(!r)return this;E=E.split(" ");for(var S=0;S<E.length;S++)for(var p=E[S],g=p.split(".")[0],T=0;T<s.length;T++){var P=s[T].idx.split(".");(s[T].idx===p||P[1]&&P[1]===p.replace(".",""))&&(this.sound.removeEventListener(g,s[T].func,!0),s.splice(T,1))}return this},this.bindOnce=function(E,S){if(!r)return this;var p=this;return o[n++]=!1,this.bind(E+"."+n,function(){o[n]||(o[n]=!0,S.call(p)),p.unbind(E+"."+n)}),this},this.trigger=function(E,S){if(!r)return this;E=E.split(" ");for(var p=0;p<E.length;p++)for(var g=E[p],T=0;T<s.length;T++){var P=s[T].idx.split(".");if(s[T].idx===g||P[0]&&P[0]===g.replace(".","")){var x=i.createEvent("HTMLEvents");x.initEvent(P[0],!1,!0),x.originalEvent=S,this.sound.dispatchEvent(x)}}return this},this.fadeTo=function(E,S,p){if(!r)return this;S instanceof Function?(p=S,S=c.defaults.duration):S=S||c.defaults.duration;var g=this.volume,T=S/Math.abs(g-E),P=this;this.play();function x(){setTimeout(function(){g<E&&P.volume<E?(P.setVolume(P.volume+=1),x()):g>E&&P.volume>E?(P.setVolume(P.volume-=1),x()):p instanceof Function&&p.apply(P)},T)}return this.whenReady(function(){x()}),this},this.fadeIn=function(E,S){return r?this.setVolume(0).fadeTo(100,E,S):this},this.fadeOut=function(E,S){return r?this.fadeTo(0,E,S):this},this.fadeWith=function(E,S){return r?(this.fadeOut(S,function(){this.stop()}),E.play().fadeIn(S),this):this},this.whenReady=function(E){if(!r)return null;var S=this;this.sound.readyState===0?this.bind("canplay.buzzwhenready",function(){E.call(S)}):E.call(S)},this.addSource=function(E){var S=this,p=i.createElement("source");return p.src=E,c.types[l(E)]&&(p.type=c.types[l(E)]),this.sound.appendChild(p),p.addEventListener("error",function(g){S.trigger("sourceerror",g)}),p};function a(E){for(var S=[],p=E.length-1,g=0;g<=p;g++)S.push({start:E.start(g),end:E.end(g)});return S}function l(E){return E.split(".").pop()}if(r&&t){for(var f in c.defaults)c.defaults.hasOwnProperty(f)&&e[f]===void 0&&(e[f]=c.defaults[f]);if(this.sound=i.createElement("audio"),e.webAudioApi){var u=c.getAudioContext();u&&(this.source=u.createMediaElementSource(this.sound),this.source.connect(u.destination))}if(t instanceof Array)for(var b in t)t.hasOwnProperty(b)&&this.addSource(t[b]);else if(e.formats.length)for(var h in e.formats)e.formats.hasOwnProperty(h)&&this.addSource(t+"."+e.formats[h]);else this.addSource(t);e.loop&&this.loop(),e.autoplay&&(this.sound.autoplay="autoplay"),e.preload===!0?this.sound.preload="auto":e.preload===!1?this.sound.preload="none":this.sound.preload=e.preload,this.setVolume(e.volume),c.sounds.push(this)}},group:function(t){t=i(t,arguments),this.getSounds=function(){return t},this.add=function(n){n=i(n,arguments);for(var s=0;s<n.length;s++)t.push(n[s])},this.remove=function(n){n=i(n,arguments);for(var s=0;s<n.length;s++)for(var o=0;o<t.length;o++)if(t[o]===n[s]){t.splice(o,1);break}},this.load=function(){return e("load"),this},this.play=function(){return e("play"),this},this.togglePlay=function(){return e("togglePlay"),this},this.pause=function(n){return e("pause",n),this},this.stop=function(){return e("stop"),this},this.mute=function(){return e("mute"),this},this.unmute=function(){return e("unmute"),this},this.toggleMute=function(){return e("toggleMute"),this},this.setVolume=function(n){return e("setVolume",n),this},this.increaseVolume=function(n){return e("increaseVolume",n),this},this.decreaseVolume=function(n){return e("decreaseVolume",n),this},this.loop=function(){return e("loop"),this},this.unloop=function(){return e("unloop"),this},this.setSpeed=function(n){return e("setSpeed",n),this},this.setTime=function(n){return e("setTime",n),this},this.set=function(n,s){return e("set",n,s),this},this.bind=function(n,s){return e("bind",n,s),this},this.unbind=function(n){return e("unbind",n),this},this.bindOnce=function(n,s){return e("bindOnce",n,s),this},this.trigger=function(n){return e("trigger",n),this},this.fade=function(n,s,o,r){return e("fade",n,s,o,r),this},this.fadeIn=function(n,s){return e("fadeIn",n,s),this},this.fadeOut=function(n,s){return e("fadeOut",n,s),this};function e(){for(var n=i(null,arguments),s=n.shift(),o=0;o<t.length;o++)t[o][s].apply(t[o],n)}function i(n,s){return n instanceof Array?n:Array.prototype.slice.call(s)}},all:function(){return new c.group(c.sounds)},isSupported:function(){return!!c.el.canPlayType},isOGGSupported:function(){return!!c.el.canPlayType&&c.el.canPlayType('audio/ogg; codecs="vorbis"')},isWAVSupported:function(){return!!c.el.canPlayType&&c.el.canPlayType('audio/wav; codecs="1"')},isMP3Supported:function(){return!!c.el.canPlayType&&c.el.canPlayType("audio/mpeg;")},isAACSupported:function(){return!!c.el.canPlayType&&(c.el.canPlayType("audio/x-m4a;")||c.el.canPlayType("audio/aac;"))},toTimer:function(t,e){var i,n,s;return i=Math.floor(t/3600),i=isNaN(i)?"--":i>=10?i:"0"+i,n=Math.floor(e?t/60%60:t/60),n=isNaN(n)?"--":n>=10?n:"0"+n,s=Math.floor(t%60),s=isNaN(s)?"--":s>=10?s:"0"+s,e?i+":"+n+":"+s:n+":"+s},fromTimer:function(t){var e=t.toString().split(":");return e&&e.length===3&&(t=parseInt(e[0],10)*3600+parseInt(e[1],10)*60+parseInt(e[2],10)),e&&e.length===2&&(t=parseInt(e[0],10)*60+parseInt(e[1],10)),t},toPercent:function(t,e,i){var n=Math.pow(10,i||0);return Math.round(t*100/e*n)/n},fromPercent:function(t,e,i){var n=Math.pow(10,i||0);return Math.round(e/100*t*n)/n}};return c})});var ie=class{#e={};bind(c,t,e){(!Array.isArray(this.#e[c])||typeof this.#e[c]>"u")&&(this.#e[c]=[]),this.#e[c].push({listener:t,caller:e})}on(c,t,e){this.bind(c,t,e)}addEventListener(c,t,e){this.bind(c,t,e)}fire(c,t,e){if(!c||typeof c!="string")throw new Error("Event missing.");if(Array.isArray(this.#e[c])){!t||t===null||typeof t>"u"?t=[]:Array.isArray(t)||(t=[t]),e=e||this;for(var i=this.#e[c],n=0,s=i.length;n<s;n++)i[n].listener.apply(i[n].caller||e,t)}}emit(c,...t){this.fire(c,t)}dispatchEvent(c,t,e){this.fire(c,t,e)}unbind(c,t){if(!c||!t||!Array.isArray(this.#e[c]))return;let e=this.#e[c];for(let i=e.length-1;i>=0;i--)if(e[i].listener===t){e.splice(i,1);break}}remove(c,t){this.unbind(c,t)}off(c,t){this.unbind(c,t)}removeListener(c,t){this.unbind(c,t)}removeAllListeners(c){if(!c){this.#e=[];return}Array.isArray(this.#e[c])&&delete this.#e[c]}removeListenersFromCaller(c,t){if(!t){Object.keys(this.#e).forEach(i=>{let n=this.#e[i];for(let s=n.length-1;s>=0;s--)if(n[s].caller===c){n.splice(s,1);break}});return}if(!Array.isArray(this.#e[t]))return;let e=this.#e[t];for(let i=0,n=e.length;i<n;i++)if(e[i].caller===c){e.splice(i,1);break}}listeners(c){return c?this.#e[c]||[]:this.#e}};Array.prototype.filter||(Array.prototype.filter=function(m){var c=this.length>>>0;if(typeof m!="function")throw new TypeError;for(var t=[],e=arguments[1],i=0;i<c;i++)if(i in this){var n=this[i];m.call(e,n,i,this)&&t.push(n)}return t});function Yt(m,c){return m.priority>c.priority?-1:m.priority<c.priority?1:0}function qt(m,c){return m.priority>c.priority?-1:m.priority<c.priority?1:m.index<c.index?-1:m.index>c.index?1:0}function H(m){let c=m.map((t,e)=>({index:e,priority:t.priority}));return c.sort(qt),c.map(t=>m[t.index])}function Ie(m,c,t){let e=[];if(!m||m.length===0)return e;let i=m.length;for(let n=0;n<i;n++)m[n].enabled&&m[n][c]===t&&e.push(m[n]);return e.length<=1?e:e.sort(Yt)}var qe=document.createElement("div");function Le(m){return qe.textContent=m,qe.innerHTML}function yt(m){return qe.innerHTML=m,qe.textContent}function F(m){return m=m.replace(/^"(.+(?="$))?"$/,"$1"),m=m.replace(/^'(.+(?='$))?'$/,"$1"),m}var de=class{constructor(c){this.length=0;typeof c=="string"&&c.length>0?this.buffer=[c]:this.buffer=[],this.length=0}prepend(c){return this.buffer.unshift(c),this.length+=c.length,this}append(c){return this.buffer.push(c),this.length+=c.length,this}push(c){typeof c=="number"?this.appendCode(c):this.append(c)}appendCode(c){return this.buffer.push(String.fromCharCode(c)),this.length++,this}toString(){return this.buffer.join("")}clear(c){return this.buffer=[],this.length=0,c&&typeof c<"u"&&c.length&&(this.buffer.push(c),this.length=c.length),this}concat(c){this.buffer=this.buffer.concat(c)}};function Ke(m,c){if(m.length>1)return!1;if(m==="-"||m==="_"||m==="."||m==="~"||m==="!"||m==="*"||m==="'"||m===";"||m===":"||m==="@"||m==="&"||m==="="||m==="+"||m==="$"||m===","||m==="/"||m==="\\"||m==="?"||m==="%"||m==="#"||m==="["||m==="]"||m==="("||m===")")return!c;let t=m.charCodeAt(0);return t>64&&t<91||t>96&&t<123||t>47&&t<58||t>=160&&t<=55295||t>=57344&&t<=64975||t>=65008&&t<=65533||t>=65536&&t<=131069||t>=131072&&t<=196605||t>=196608&&t<=262141||t>=262144&&t<=327677||t>=327680&&t<=393213||t>=393216&&t<=458749||t>=458752&&t<=524285||t>=524288&&t<=589821||t>=589824&&t<=655357||t>=655360&&t<=720893||t>=720896&&t<=786429||t>=786432&&t<=851965||t>=851968&&t<=917501||t>=921600&&t<=983037||t>=983040&&t<=1048573||t>=1048576&&t<=1114109}var wt={3:"Cancel",6:"Help",8:"Backspace",9:"Tab",19:"Pause/Break",20:"Caps Lock",21:"Kana",22:"Eisu",23:"Junja",24:"Final",25:"Hanja",27:"Esc",28:"Convert",29:"Nonconvert",30:"Accept",31:"Modechange",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",41:"Select",42:"Print",43:"Execute",44:"Printscreen",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",58:"Colon",59:"Semicolon",60:"Less Than",61:"Equals2",62:"Greater Than",63:"Question Mark",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",93:"Context Menu",95:"Sleep",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",124:"F13",125:"F14",126:"F15",127:"F16",128:"F17",129:"F18",130:"F19",131:"F20",132:"F21",133:"F22",134:"F23",135:"F24",144:"Num Lock",145:"Scroll Lock",146:"Win Oem Fj Jisho",147:"Win Oem Fj Masshou",148:"Win Oem Fj Touroku",149:"Win Oem Fj Loya",150:"Win Oem Fj Roya",160:"Circumflex",161:"Exclamation",162:"Double Quote",163:"Hash",164:"Dollar",165:"Percent",166:"Ampersand",167:"Underscore",168:"Open Paren",169:"Close Paren",170:"Asterisk",171:"Plus",172:"Pipe",173:"Hyphen Minus",174:"Open Curly Bracket",175:"Close Curly Bracket",176:"Tilde",181:"Volume Mute",182:"Volume Down",183:"Volume Up",186:";",187:"Equals",188:",",189:"Minus",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",227:"Win Ico Help",228:"Win Ico 00",230:"Win Ico Clear",233:"Win Oem Reset",234:"Win Oem Jump",235:"Win Oem Pa1",236:"Win Oem Pa2",237:"Win Oem Pa3",238:"Win Oem Wsctrl",239:"Win Oem Cusel",240:"Win Oem Attn",241:"Win Oem Finish",242:"Win Oem Copy",243:"Win Oem Auto",244:"Win Oem Enlw",245:"Win Oem Backtab",246:"Attn",247:"Crsel",248:"Exsel",249:"Ereof",250:"Play",251:"Zoom",253:"Pa1",254:"Win Oem Clear"};(function(m){m.fn.hasHorizontalScrollBar=function(){return m(this)[0].scrollWidth>m(this).innerWidth()}})(jQuery);function ve(m,c){return JSON.parse(JSON.stringify(m,c))}function Dt(m){!m||m.value.length===0||(m.setSelectionRange?(m.focus(),m.setSelectionRange(0,m.value.length)):m.select())}CanvasRenderingContext2D.prototype.fillRoundedRect=function(m,c,t,e,i){this.beginPath(),this.moveTo(m+i,c),this.lineTo(m+t-i,c),this.quadraticCurveTo(m+t,c,m+t,c+i),this.lineTo(m+t,c+e-i),this.quadraticCurveTo(m+t,c+e,m+t-i,c+e),this.lineTo(m+i,c+e),this.quadraticCurveTo(m,c+e,m,c+e-i),this.lineTo(m,c+i),this.quadraticCurveTo(m,c,m+i,c),this.closePath(),this.fill()};CanvasRenderingContext2D.prototype.strokeRoundedRect=function(m,c,t,e,i){this.beginPath(),this.moveTo(m+i,c),this.lineTo(m+t-i,c),this.quadraticCurveTo(m+t,c,m+t,c+i),this.lineTo(m+t,c+e-i),this.quadraticCurveTo(m+t,c+e,m+t-i,c+e),this.lineTo(m+i,c+e),this.quadraticCurveTo(m,c+e,m,c+e-i),this.lineTo(m,c+i),this.quadraticCurveTo(m,c,m+i,c),this.closePath(),this.stroke()};Object.keys||(Object.keys=function(m){if(m!==Object(m))throw new TypeError("Object.keys called on a non-object");var c=[],t;for(t in m)Object.prototype.hasOwnProperty.call(m,t)&&c.push(t);return c});Object.toType||(Object.toType=function(m){return{}.toString.call(m).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()});typeof String.prototype.startsWith!="function"&&(String.prototype.startsWith=function(m){return this.slice(0,m.length)==m});typeof String.prototype.endsWith!="function"&&(String.prototype.endsWith=function(m){return this.slice(-m.length)==m});typeof String.prototype.splice!="function"&&(String.prototype.splice=function(m,c,t){return typeof t>"u"&&(t=0),this.slice(0,m)+c+this.slice(m+Math.abs(t))});typeof String.prototype.padStart!="function"&&(String.prototype.padStart=function(m){return typeof m=="number"&&(m=" ".repeat(m)),String(m+this).slice(-m.length)});typeof String.prototype.padEnd!="function"&&(String.prototype.padEnd=function(m){return typeof m=="number"?m<=this.length?this:(m=" ".repeat(m-this.length),this+m):m.length<=this.length?this:this+m.slice(-this.length)});String.prototype.replaceAll||(String.prototype.replaceAll=function(m,c){return Object.prototype.toString.call(m).toLowerCase()==="[object regexp]"?this.replace(m,c):this.replace(new RegExp(m,"g"),c)});typeof Uint8Array.prototype.charAt!="function"&&(Uint8Array.prototype.charAt=function(m){return String.fromCharCode(this[m])});typeof Uint8Array.prototype.charCodeAt!="function"&&(Uint8Array.prototype.charCodeAt=function(m){return this[m]});function Kt(m,c){return!m||!m.length?m:c?m.replace(/\\/g,"\\\\").replace(/\u0008/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\u0000/g,"\\0"):m.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"')}String.prototype.addSlashes=function(){return Kt(this)};String.prototype.splitQuote=function(m,c,t,e){if(this.length===0)return[];if(!m||!m.length)return[this];c||(c=3),t||(t=3),e||(e="\\");let i=!1,n=!1,s=[],o=0,r=0,a,l="",f,u=m.length,b,h=this.length;for(;r<h;r++){if(a=this.charAt(r),a==='"'&&(c&2)===2)(t&2)===2?(r===0||l!==e)&&(i=!i):i=!i;else if(a==="'"&&(c&1)===1)(t&1)===1?(r===0||l!==e)&&(n=!n):n=!n;else if(!i&&!n){for(f=0;f<u;f++)if(b=m.charAt(f),a===b)if(r>o||r===0){s.push(this.substr(o,r-o)),o=r+1;break}else if(r===o){s.push(""),o=r+1;break}else r===h-1&&s.push("")}l=a}return r===h&&r===o&&m.indexOf(l)!==-1&&(s.push(""),o=r+1),r>o&&s.push(this.substr(o,r-o)),s};function St(m){let c,t=[];return c=Math.floor(m/(1e3*60*60*24)),m-=c*(1e3*60*60*24),c===1?t.push(c+" day"):c>0&&t.push(c+" days"),c=Math.floor(m/(1e3*60*60)),m-=c*(1e3*60*60),c===1?t.push(c+" hour"):c>0&&t.push(c+" hours"),c=Math.floor(m/(1e3*60)),m-=c*(1e3*60),c===1?t.push(c+" minute"):c>0&&t.push(c+" minutes"),c=Math.floor(m/1e3),m-=c*1e3,c===1?t.push(c+" second"):c>0&&t.push(c+" seconds"),t.length===0&&t.push("0 seconds"),t.join(", ")}function Ze(m,c,t,e,i){if(typeof t>"u"&&(t=3),typeof e>"u"&&(e=0),typeof i>"u"&&(i="\\"),!m||m.length===0)return[];if(!c||c.length===0)return[m];c=c.split("");let n=!1,s=!1,o=[],r=0,a=0,l=m.length,f;for(;a<l;a++)if(f=m.charAt(a),f==='"'&&(t&2)===2)(e&2)===2&&a>0?a-1>0&&m.charAt(a-1)!==i&&(n=!n):n=!n;else if(f==="'"&&(t&1)===1)(e&1)===1&&a>0?a-1>0&&m.charAt(a-1)!==i&&(s=!s):s=!s;else if(!s&&!n){let u=c.length;for(let b=0;b<u;b++)if(f===c[b])if(a>r||a===0){o.push(m.substring(r,a)),r=a+1;break}else if(a===r){o.push(""),r=a+1;break}else a===l-1&&o.push("")}return a===l&&a===r&&c.indexOf(m.charAt(a-1))>-1&&(o.push(""),r=a+1),a>r&&o.push(m.substring(r,a)),o}function Nt(m){if(!m)return 0;if(typeof m.selectionStart=="number")return m.selectionDirection=="backward"?m.selectionStart:m.selectionEnd;if(document.selection){m.focus();var c=document.selection.createRange();return c.moveStart("character",-m.value.length),c.text.length}return 0}function _e(m,c){return m&&(/^\d+c$/.test(m)?c?parseInt(m,10)*c+"px":m+"h":/^\d+$/.test(m)?parseInt(m,10)+"px":m)}function ge(m){return!m||m.length===0||!m.match(/^[a-zA-Z_$][a-zA-Z_$0-9]*$/g)?!1:["break","case","catch","continue","debugger","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with","class","const","enum","export","extends","import","super","implements","interface","let","package","private","protected","public","static","yield","null","true","false","NaN","Infinity","undefined","eval","arguments"].indexOf(m)===-1}function Ue(m,c){if(!m)return;let t=document.activeElement;(!t||t!=m)&&m.focus(),document.execCommand("insertText",!1,c),t&&t!=m&&t.focus()}Array.isArray||(Array.isArray=function(m){return Object.prototype.toString.call(m)==="[object Array]"});var Mt;function Pe(m){return window.TextDecoder!==void 0?(Mt||(Mt=new TextDecoder)).decode(new Uint8Array(m)):Zt(String.fromCharCode.apply(null,Array.prototype.slice.apply(new Uint8Array(m))))}function Zt(m){var c;try{return decodeURIComponent(escape(m))}catch(t){if(c=t,c instanceof URIError)return m;throw c}}function Jt(m){var c,t,e,i,n,s;for(n=m.length,c=[],i=!1,e=s=0;0<=n?s<n:s>n;e=0<=n?++s:--s)if(t=String.prototype.charCodeAt.call(m,e),t>255){i=!0,c=null;break}else c.push(t);return i===!0?unescape(encodeURIComponent(m)):String.fromCharCode.apply(null,Array.prototype.slice.apply(c))}var At;function be(m){var c,t,e,i,n,s;if(window.TextEncoder!==void 0)return(At||(At=new TextEncoder)).encode(m);for(c=Jt(m),t=c.length,e=new ArrayBuffer(t),i=new Uint8Array(e),n=s=0;0<=t?s<t:s>t;n=0<=t?++s:--s)i[n]=String.prototype.charCodeAt.call(c,n);return i}function vt(m,c){if(!m)return null;c||(c=window.location.href),m=m.replace(/[[\]]/g,"\\$&");var t=new RegExp("[?&]"+m+"(=([^&#]*)|&|#|$)"),e=t.exec(c);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function ei(){var m="download"in document.createElement("a"),c=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,t=window.URL||window.webkitURL||window.mozURL||window.msURL;navigator.saveBlob=navigator.saveBlob||navigator.msSaveBlob||navigator.mozSaveBlob||navigator.webkitSaveBlob,window.saveAs=window.saveAs||window.webkitSaveAs||window.mozSaveAs||window.msSaveAs;var e={"image/jpeg":!0,"image/png":!0,"image/gif":!0,"image/svg+xml":!0,"image/bmp":!0,"image/x-windows-bmp":!0,"image/webp":!0,"audio/wav":!0,"audio/mpeg":!0,"audio/webm":!0,"audio/ogg":!0,"video/mpeg":!0,"video/webm":!0,"video/ogg":!0,"text/plain":!0,"text/html":!0,"text/xml":!0,"application/xhtml+xml":!0,"application/json":!0};c&&(window.saveAs||navigator.saveBlob)?this.show=function(i,n,s){var o=new c;o.append(i);var r=o.getBlob(s||"application/octet-stream");n||(n="Download.bin"),window.saveAs?window.saveAs(r,n):navigator.saveBlob(r,n)}:c&&t?this.show=function(i,n,s){var o,r,a=new c;if(a.append(i),s||(s="application/octet-stream"),m){o=a.getBlob(s),r=t.createObjectURL(o);var l=document.createElement("a");l.setAttribute("href",r),l.setAttribute("download",n||"Download.bin");var f=document.createEvent("MouseEvents");f.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),l.dispatchEvent(f)}else e[s.split(";")[0]]===!0&&(s="application/octet-stream"),o=a.getBlob(s),r=t.createObjectURL(o),window.open(r,"_blank","");setTimeout(function(){t.revokeObjectURL(r)},250)}:Blob&&t?this.show=function(i,n,s){var o,r;if(s||(s="application/octet-stream"),o=new Blob([i],{type:s}),m){r=t.createObjectURL(o);var a=document.createElement("a");a.setAttribute("href",r),a.setAttribute("download",n||"Download.bin");var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(l)}else e[s.split(";")[0]]===!0&&(s="application/octet-stream"),r=t.createObjectURL(o),window.open(r,"_blank","");setTimeout(function(){t.revokeObjectURL(r)},250)}:/\bMSIE\b/.test(navigator.userAgent)||(this.show=function(i,n,s){s||(s="application/octet-stream"),e[s.split(";")[0]]===!0&&(s="application/octet-stream"),window.open("data:"+s+","+encodeURIComponent(i),"_blank","")})}window.fileSaveAs=new ei;function ti(){var m,c;function t(e,i){var n=e.charCodeAt(c);if(!(n&128))m=n;else if((n&224)==192)m=(n&31)<<6|e.charCodeAt(c+1)&63,c+=1;else if((n&240)==224)m=(n&15)<<12|(e.charCodeAt(c+1)&63)<<6|e.charCodeAt(c+2)&63,c+=2;else if((n&248)==240)m=(n&7)<<18|(e.charCodeAt(c+1)&63)<<12|(e.charCodeAt(c+2)&63)<<6|e.charCodeAt(c+3)&63,c+=1;else return!1;return!0}this.decode=function(e){var i=new de,n=e.length;for(c=0;c<n;c++)t(e,n)&&i.appendCode(m);return i.toString()},this.decode2=function(e){var i=new de,n=e.length,s,o;for(s=0;s<n;s++){if(o=e.charCodeAt(s),o&128)if((o&224)==192)o=(o&31)<<6|e.charCodeAt(s+1)&63,s+=1;else if((o&240)==224)o=(o&15)<<12|(e.charCodeAt(s+1)&63)<<6|e.charCodeAt(s+2)&63,s+=2;else if((o&248)==240)o=(o&7)<<18|(e.charCodeAt(s+1)&63)<<12|(e.charCodeAt(s+2)&63)<<6|e.charCodeAt(s+3)&63,s+=1;else continue;i.appendCode(o)}return i.toString()}}window.UTF8=new ti;function ye(m){if(m===null||typeof m>"u")return m;var c,t,e=0;for(c=m.byteLength,t=new de;e<c;e++)m[e]<32||m[e]>=127?t.append("<"+m[e]+">"):t.append(String.fromCharCode(m[e]));return t.toString()}function Et(){let m=document.createElement("div");m.style.visibility="hidden",m.style.overflow="scroll",m.style.msOverflowStyle="scrollbar",document.body.appendChild(m);let c=document.createElement("div");m.appendChild(c);let t=m.offsetWidth-c.offsetWidth;return m.parentNode.removeChild(m),t}function Ee(m,c,t){return new Promise((e,i)=>{let n=document.createElement("dialog");if(typeof n.showModal!="function"){i("Browser does not support dialogs.");return}n.id="openFileDialog",n.style.zIndex="2000",n.style.height="158px",n.style.width="350px",n.innerHTML=`<div class="dialog-header" style="font-weight: bold"><button type="button" class="btn btn-close float-end btn-danger" data-dismiss="modal" onclick="document.getElementById('openFileDialog').close();"></button><div>${m||"Open file..."}</div></div><div class="dialog-body"><div class="m-3"><input class="form-control" type="file" id="openFileDialog-files"${c?" multiple":""} required${t&&t.length?' accept="'+t+'"':""}></div></div><div class="dialog-footer"><button id="openFileDialog-cancel" style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('openFileDialog').close();">Cancel</button><button id="openFileDialog-ok" style="float: right" type="button" class="btn btn-primary">Ok</button></div>`,document.body.appendChild(n),n.addEventListener("close",s=>{s.target===n&&(document.body.removeChild(n),n.returnValue!=="file-ok"&&i("closed"))}),n.addEventListener("cancel",s=>{s.target===n&&(document.body.removeChild(n),n.returnValue!=="file-ok"&&i("canceled"))}),document.getElementById("openFileDialog-ok").addEventListener("click",()=>{let s=document.getElementById("openFileDialog-files");if(!s.files||s.files.length===0){s.classList.add("is-invalid");return}s.classList.remove("is-invalid"),n.close(),n.returnValue="files-ok",e(s.files)}),n.showModal()})}function xe(m){return new Promise((c,t)=>{m||t(new Error("Invalid file"));var e=new FileReader;e.onerror=t,e.onload=i=>{c(i.target.result)},e.readAsText(m)})}var bt={};function Je(m,c,t){t=t||"default",clearTimeout(bt[t]),bt[t]=setTimeout(()=>{m(),delete bt[t]},c)}var Ft=Ot(Bt()),We=class extends ie{constructor(t){super();this._splitBuffer=[];this._connected=!1;this._MTTS=0;this.zStream=0;this._latencyTime=null;this._doPing=!1;this._closed=!0;this._zlib=!1;this.options={MCCP:!0,MXP:!0,NAWS:!0,MSDP:!0,GMCP:!0,MSSP:!1,ECHO:!0,TTYPE:!0,EOR:!0,NEWENVIRON:!1,ZMP:!1,ATCP:!1,CHARSET:!0};this.host="";this.port=23;this.prompt=!1;this.echo=!0;this.firstSent=!0;this.firstReceived=!0;this.server={NAWS:!1,MSDP:!1,GMCP:!1,MXP:!1,MCCP1:!1,MCCP2:!1,MSSP:!1,NEWENVIRON:!1,ZMP:!1,EOR:!1,ATCP:!1,CHARSET:!1};this.version="2.0";this.terminal="ansi";this.UTF8=!0;this.MSSP={};this.socket=null;this.latency=0;this.latencyAvg=null;this.enableLatency=!1;this.enablePing=!1;this.GMCPSupports=["Core 1","Char 1","Char.Vitals 1","Char.Experience 1"];this.enableDebug=!1;this.scheme="ws://";this.protocol="binary";t&&("host"in t&&(t.host&&t.host.length&&(this.host=t.host),delete t.host),"port"in t&&(this.port=t.port,delete t.port),"scheme"in t&&(t.scheme&&t.scheme.length&&(this.scheme=t.scheme),delete t.scheme),"protocol"in t&&(t.protocol&&t.protocol.length&&(this.protocol=t.protocol),delete t.protocol)),this.options=Object.assign(this.options,t||{})}get connected(){return!this.socket||typeof this.socket>"u"?!1:this._connected}reset(){this._MTTS=0,this.firstSent=!0,this.firstReceived=!0,this.prompt=!1,this.echo=!0,this.server={NAWS:!1,MSDP:!1,GMCP:!1,MXP:!1,MCCP1:!1,MCCP2:!1,MSSP:!1,EOR:!1,NEWENVIRON:!1,ATCP:!1,CHARSET:!1,ZMP:!1},this._splitBuffer=[],this._endMCCP(),this._connected=!1,this._closed=!1,this.enableDebug&&this.emit("debug","Reset")}connect(){this._destroySocket(),this.reset(),this.emit("connecting"),this.socket=this._createSocket(this.host,this.port),this.enableDebug&&this.emit("debug","Connecting to "+this.host+":"+this.port)}close(){this._closed||(this._destroySocket(),this.reset(),this.emit("close"),this._closed=!0,this.enableDebug&&this.emit("debug","Closed"))}receivedData(t,e,i){this.enableLatency&&(this._latencyTime!==null?(this.latency=new Date().getTime()-this._latencyTime.getTime(),this.latencyAvg==null?this.latencyAvg=this.latency:this.latencyAvg=(this.latency+this.latencyAvg)/2,this._latencyTime=null,this._doPing=!1,this.emit("latency-changed",this.latency,this.latencyAvg)):!this._doPing&&this.enablePing?this._doPing=!0:(this._latencyTime=null,this._doPing=!1)),this.enableDebug&&this.emit("debug","PreProcess:"+t,1),t=this.processData(t,e,!1,i),this.enableDebug&&this.emit("debug","PostProcess:"+t,1),this.emit("received-data",t),this.enableLatency&&(this._splitBuffer.length>0?(this.enablePing&&(this._doPing=!0),this._latencyTime=null):this._doPing&&this.enablePing?setTimeout(()=>{this._latencyTime=new Date,this.sendGMCP("Core.Ping "+this.latencyAvg)}):this._doPing=!1)}sendTerminal(){if(this.enableDebug&&(this._MTTS===0?this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>"+this.terminal+"<IAC><SE>"):this._MTTS===1?this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>ANSI-256COLOR<IAC><SE>"):this._MTTS>=2&&this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>MTTS 9<IAC><SE>")),this._MTTS===0){var t=new Uint8Array(6+this.terminal.length);t.set([255,250,24,0],0),t.set(be(this.terminal),4),t.set([255,240],4+this.terminal.length),this.sendData(t,!0)}else this._MTTS===1?this.sendData([255,250,24,0,65,78,83,73,45,50,53,54,67,79,76,79,82,255,240],!0):this._MTTS>=2&&this.sendData([255,250,24,0,77,84,84,83,32,57,255,240],!0)}sendData(t,e){if(!(t==null||typeof t>"u"||t.length===0)){if(this.connected)try{e||(this.prompt=!1,t=this._escapeData(t),this.enableLatency&&(this._latencyTime=new Date)),this.socket!==null&&(t instanceof Uint8Array?(this.enableDebug&&this.emit("debug","sendDataU8:"+ye(t)),this.socket.send(t)):Array.isArray(t)?(this.enableDebug&&this.emit("debug","sendDataBA"+ye(new Uint8Array(t))),this.socket.send(new Uint8Array(t))):(this.enableDebug&&this.emit("debug","sendDataR:"+ye(be(t))),this.socket.send(t)),e||(this.firstSent=!1))}catch(i){this.emit("error",i)}else this.enableLatency&&(this._latencyTime=null);this.emit("data-sent",t,e)}}processData(t,e,i,n){let s,o="",r;if(t==null||(e||(t=this._decompressData(t)),s=t.byteLength,s===0))return t;r=this._splitBuffer,r.length>0&&(this.enableDebug&&this.emit("debug","Split buffer length: "+r.length,1),o=new Uint8Array(s+r.length),n?(o.set(t,0),o.set(r,t.byteLength)):(o.set(r,0),o.set(t,r.length)),t=o,r=[],s=t.byteLength);let a=0,l=0,f=new de,u=this.prompt,b=0,h=0,E="",S="",p,g=0,T,P=0;o="",this.prompt=!1;let x="";try{for(;P<s;P++)switch(g=t[P],a){case 0:if(g===255)this.enableDebug&&(x="TELOP: <IAC>"),r.push(g),a=1;else if(this.UTF8||this.options.CHARSET&&this.server.CHARSET){if((g&128)===128&&P>=s-4){let G=0;if((g&192)===192?G=1:(g&224)===224?G=2:(g&240)===240&&(G=3),P+G>=s){r.push(...t.slice(P)),this.enableDebug&&(this.emit("debug","Unicode split length: "+G,1),this.emit("debug","Split buffer length: "+r.length,1));break}}f.appendCode(g)}else f.appendCode(g);break;case 1:if(g===255)this.enableDebug&&(this.emit("debug",x+"<IAC>"),x=""),f.appendCode(g),r=[],a=0;else if((!this.options.EOR||!this.server.EOR)&&g===239)this.enableDebug&&(this.emit("debug",x+"<NOP>"),x=""),r=[],a=0;else if(g===241||g===130)this.enableDebug&&(this.emit("debug",x+"<NOP>"),x=""),r=[],a=0;else if(g===249||g===239)this.enableDebug&&(g===239?this.emit("debug",x+"<EOR>"):this.emit("debug",x+"<GA>"),x=""),P+1<s&&s-P>2?(f.push(`
`),this.prompt=!1):this.prompt=!0,r=[],a=0;else if(g===253||g===254||g===251||g===252){if(this.enableDebug)switch(g){case 253:x+="<DO>";break;case 254:x+="<DONT>";break;case 251:x+="<WILL>";break;case 252:x+="<WONT>";break}r.push(g),b=g,a=2}else g===250?(this.enableDebug&&(x+="<SB>"),r.push(g),a=3):(this.enableDebug&&(x+=this._formatByte(g)),r=[],a=0);break;case 2:g===1?(this.enableDebug&&(this.emit("debug",x+"<ECHO>"),x=""),b===253?this.options.ECHO?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><ECHO>"),this.replyToOption(g,251,b),this.echo=!1):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(g,254,b)):b===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><ECHO>"),this.replyToOption(g,252,b),this.echo=!0):b===251?this.options.ECHO?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><ECHO>"),this.replyToOption(g,253,b),this.echo=!1):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(g,254,b)):b===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(g,254,b)),a=0,r=[]):g===24?(this.enableDebug&&(this.emit("debug",x+"<TERMINALTYPE>"),x=""),b===253?this.options.TTYPE?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><TERMINALTYPE>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(g,254,b)):b===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><TERMINALTYPE>"),this.replyToOption(g,252,b)):b===251?this.options.TTYPE?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><TERMINALTYPE>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(g,254,b)):b===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(g,254,b)),a=0,r=[]):g===25?(this.enableDebug&&(this.emit("debug",x+"<ENDOFRECORD>"),x=""),b===253?(this.server.EOR=!0,this.options.EOR?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><ENDOFRECORD>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(g,254,b))):b===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><ENDOFRECORD>"),this.replyToOption(g,252,b)):b===251?(this.server.EOR=!0,this.options.EOR?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><ENDOFRECORD>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(g,254,b))):b===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(g,254,b)),a=0,r=[]):g===31?(this.enableDebug&&(this.emit("debug",x+"<NAWS>"),x=""),b===253?(this.server.NAWS=!0,this.options.NAWS?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><NAWS>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(g,254,b))):b===254?(this.server.NAWS=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><NAWS>"),this.replyToOption(g,252,b)):b===251?(this.server.NAWS=!0,this.options.NAWS?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><NAWS>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(g,254,b))):b===252&&(this.server.NAWS=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(g,254,b)),this.emit("windowSize"),a=0,r=[]):g===36||g===39?(this.enableDebug&&(this.emit("debug",x+"<NEWENVIRON>"),x=""),b===253?(this.server.NEWENVIRON=!0,this.options.NEWENVIRON?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><NEWENVIRON>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(g,254,b))):b===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><NEWENVIRON>"),this.replyToOption(g,252,b)):b===251?(this.server.NEWENVIRON=!0,this.options.NEWENVIRON?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><NEWENVIRON>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(g,254,b))):b===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(g,254,b)),a=0,r=[]):g===69?(this.enableDebug&&(this.emit("debug",x+"<MSDP>"),x=""),b===253?(this.server.MSDP=!0,this.options.MSDP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSDP>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(g,254,b))):b===254?(this.server.MSDP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSDP>"),this.replyToOption(g,252,b)):b===251?(this.server.MSDP=!0,this.options.MSDP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSDP>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(g,254,b))):b===252&&(this.server.MSDP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(g,254,b)),a=0,r=[]):g===70?(this.enableDebug&&(this.emit("debug",x+"<MSSP>"),x=""),b===253?(this.server.MSSP=!0,this.options.MSSP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSSP>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(g,254,b))):b===254?(this.server.MSSP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSSP>"),this.replyToOption(g,252,b)):b===251?(this.server.MSSP=!0,this.options.MSSP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSSP>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(g,254,b))):b===252&&(this.server.MSSP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(g,254,b)),a=0,r=[]):g===85?(this.enableDebug&&(this.emit("debug",x+"<MCCP1>"),x=""),b===253?(this.server.MCCP1=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MCCP1>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(g,254,b))):b===254?(this.server.MCCP1=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MCCP1>"),this.replyToOption(g,252,b)):b===251?(this.server.MCCP1=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MCCP1>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(g,254,b))):b===252&&(this.server.MCCP1=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(g,254,b)),a=0,r=[]):g===86?(this.enableDebug&&(this.emit("debug",x+"<MCCP2>"),x=""),b===253?(this.server.MCCP2=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MCCP2>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(g,254,b))):b===254?(this.server.MCCP2=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MCCP2>"),this.replyToOption(g,252,b)):b===251?(this.server.MCCP2=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MCCP2>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(g,254,b))):b===252&&(this.server.MCCP2=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(g,254,b)),a=0,r=[]):g===91?(this.enableDebug&&(this.emit("debug",x+"<MXP>"),x=""),b===253?(this.server.MXP=!0,this.options.MXP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MXP>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(g,254,b))):b===254?(this.server.MXP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MXP>"),this.replyToOption(g,252,b)):b===251?(this.server.MXP=!0,this.options.MXP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MXP>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(g,254,b))):b===252&&(this.server.MXP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(g,254,b)),a=0,r=[]):g===130||g===241?(this.enableDebug&&(this.emit("debug",x+"<NOP>"),x=""),this._fireReceiveOption(g,b,""),r=[],a=0):g===201?(this.enableDebug&&(this.emit("debug",x+"<GMCP>"),x=""),b===253?(this.server.GMCP=!0,this.options.GMCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><GMCP>"),this.replyToOption(g,251,b),this._startGMCP()):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(g,254,b))):b===254?(this.server.GMCP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><GMCP>"),this.replyToOption(g,252,b)):b===251?(this.server.GMCP=!0,this.options.GMCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><GMCP>"),this.replyToOption(g,253,b),this._startGMCP()):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(g,254,b))):b===252&&(this.server.GMCP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(g,254,b)),a=0,r=[]):g===42?(this.enableDebug&&(this.emit("debug",x+"<CHARSET>"),x=""),b===253?(this.server.CHARSET=!0,this.options.CHARSET?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><CHARSET>"),this.replyToOption(g,251,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(g,254,b))):b===254?(this.server.CHARSET=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><CHARSET>"),this.replyToOption(g,252,b)):b===251?(this.server.CHARSET=!0,this.options.CHARSET?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><CHARSET>"),this.replyToOption(g,253,b)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(g,254,b))):b===252&&(this.server.CHARSET=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(g,254,b)),a=0,r=[]):(this.enableDebug&&(this.emit("debug",x+this._formatByte(g)),x=""),b===251||b===252?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><"+g+">"),this.replyToOption(g,254,b)):(b===254||b===253)&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><"+g+">"),this.replyToOption(g,252,b)),a=0,r=[]);break;case 3:h=g,g===24?(this.enableDebug&&(x+="<TERMINALTYPE>"),r.push(g),h=g,a=4):g===36||g===39?(this.enableDebug&&(x+="<NEWENVIRON>"),r.push(g),h=g,a=12,T=-1):g===69?(this.enableDebug&&(x+="<MSDP>"),r.push(g),h=g,a=4):g===70?(this.enableDebug&&(x+="<MSSP>"),r.push(g),h=g,a=8,p={}):g===85||g===86?(this.enableDebug&&(x+=g===85?"<MCCP1>":"<MCCP2>"),r.push(g),h=g,a=11):g===201?(this.enableDebug&&(x+="<GMCP>"),r.push(g),h=g,a=7):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=Pe(r.slice(1,r.length-4)),this._fireReceiveOption(h,250,o),o=null,a=0,r=[]):g===42?(this.enableDebug&&(x+="<CHARSET>"),r.push(g),h=g,a=17,E=""):(this.enableDebug&&(x+=this._formatByte(g)),r.push(g));break;case 4:h===24&&g===1?(this.enableDebug&&(x+="<SEND>"),r.push(g),b=1):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),h===24&&b===1&&(o=!1,this._fireReceiveOption(h,250,""),o||(this.sendTerminal(),this.sendTerminal(),this._MTTS++)),a=0,r=[]):h===69&&g===1?(this.enableDebug&&(x+="<MSDP_VAR>"),r.push(g),S="",a=5):(this.enableDebug&&(x+=this._formatByte(g)),r.push(g));break;case 5:g===2?(this.enableDebug&&(x+="<MSDP_VAL>"),r.push(g),E="",a=6):(this.enableDebug&&(x+=this._formatByte(g)),S+=String.fromCharCode(g),r.push(g));break;case 6:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===1?(this.enableDebug&&(x+="<MSDP_VAR>"),this._fireReceiveMSDP(S,E),E="",S="",r.push(g),a=5):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=Pe(r.slice(1,r.length-4)),this._fireReceiveOption(h,250,o),o=null,this._fireReceiveMSDP(S,E),E="",S="",a=0,r=[]):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break;case 7:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=Pe(r.slice(1,r.length-4)),this._fireReceiveOption(h,250,o),o=null,this._fireReceiveGMCP(E),a=0,E="",r=[]):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break;case 8:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),this.emit("debug",this.MSSP),x=""),o=Pe(r.slice(1,r.length-4)),this._fireReceiveOption(h,250,o),o=null,this.emit("receive-MSSP",p),E="",S="",p=0,a=0,r=[]):g===1?(this.enableDebug&&(x+="<MSSP_VAR>"),r.push(g),S="",a=9):(this.enableDebug&&(x+=this._formatByte(g)),r.push(g));break;case 9:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g),a=8):g===1?(this.enableDebug&&(x+="<MSSP_VAR>"),r.push(g),S=""):g===2?(this.enableDebug&&(x+="<MSSP_VAL>"),r.push(g),this.MSSP[S]="",p[S]="",a=10):(this.enableDebug&&(x+=this._formatByte(g)),S+=String.fromCharCode(g),r.push(g));break;case 10:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g),a=8):g===1?(this.enableDebug&&(x+="<MSSP_VAR>"),r.push(g),S="",a=9):g===2?(this.enableDebug&&(x+="<MSSP_VAL>"),r.push(g),this.MSSP[S]="",p[S]=""):(this.enableDebug&&(x+=this._formatByte(g)),this.MSSP[S]+=String.fromCharCode(g),p[S]+=String.fromCharCode(g),r.push(g));break;case 11:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240&&(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),this._fireReceiveOption(h,86,""),this._startMCCP(),a=0,r=[],P<s-1&&f.append(this.processData(t.subarray(P+1),e,!0)),P=s);break;case 12:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=Pe(r.slice(1,r.length-4)),this._fireReceiveOption(h,250,o),o=null,this._fireReceiveGMCP(E),a=0,E="",r=[]):g===0?(this.enableDebug&&(x+="<IS>"),r.push(g),a=13,b=g):g===1?(this.enableDebug&&(x+="<SEND>"),r.push(g),a=13,b=g):g===2?(this.enableDebug&&(x+="<SEND>"),r.push(g),a=13,b=g):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break;case 13:g===0?(this.enableDebug&&(x+="<VAR>"),r.push(g),a=14,b=g,S="",T===-1&&(T=0)):g===1?(this.enableDebug&&(x+="<VALUE>"),r.push(g),a=13,b=g,T===-1&&(T=1)):g===3?(this.enableDebug&&(x+="<USERVAR>"),r.push(g),a=13,b=g):g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=Pe(r.slice(1,r.length-4)),o=this._fireReceiveOption(h,250,o),this.emit("receive-NEWENVIRON",E),o||(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><NEWENVIRON><IS><IAC><SE>"),this.sendData(new Uint8Array([255,250]),!0),this.sendData(h,!0),this.sendData(new Uint8Array([0,255,240]),!0)),a=0,E="",r=[]):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break;case 14:g===2?(this.enableDebug&&(x+=this._formatByte(g)),r.push(g),a=15,l=14):g===255||g<=3?(P--,a=13):(this.enableDebug&&(x+=this._formatByte(g)),S+=String.fromCharCode(g),r.push(g));break;case 15:this.enableDebug&&(x+=this._formatByte(g)),l===16?E+=String.fromCharCode(g):S+=String.fromCharCode(g),a=l,r.push(g);break;case 16:break;case 17:g===1?(this.enableDebug&&(x+="<REQUEST>"),r.push(g),a=18,E=""):g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=this._fireReceiveOption(h,250,E),this.emit("receive-CHARSET",E),o||(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><CHARSET><REJECTED><IAC><SE>"),this.sendData(new Uint8Array([255,250,42,3,255,240]),!0)),a=0,E="",r=[]):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break;case 18:g===255?(this.enableDebug&&(x+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",x+"<SE>"),x=""),o=this._fireReceiveOption(h,250,E),this.emit("receive-CHARSET",E.slice(1)),o||(this.options.CHARSET&&E.slice(1).toLowerCase()==="utf-8"?(this.server.CHARSET=!0,this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><ACCEPTED>UTF-8<IAC><SE>"),this.sendData(new Uint8Array([255,250,42,2]),!0),this.sendData("UTF-8",!0),this.sendData(new Uint8Array([255,240]),!0)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><CHARSET><REJECTED><IAC><SE>"),this.sendData(new Uint8Array([255,250,42,3,255,240]),!0))),a=0,E="",r=[]):(this.enableDebug&&(x+=this._formatByte(g)),E+=String.fromCharCode(g),r.push(g));break}}catch(G){this.emit("error",G)}return this.enableDebug&&(x.length>0&&this.emit("debug",x),this.emit("debug","Post Split buffer length: "+r.length,1),this.emit("debug","PostSplit buffer  "+ye(new Uint8Array(r)),1)),u&&f.length>0?f.prepend(`
`):u&&(this.prompt=!0),f.length>0&&(this.firstReceived=!1),this._splitBuffer=r,i?f:this.UTF8||this.options.CHARSET&&this.server.CHARSET?UTF8.decode2(f.toString()):f.toString()}replyToOption(t,e,i,n){return typeof n>"u"&&(n=""),this._fireReceiveOption(t,i,n)?!1:(this.sendData(new Uint8Array([255,e,t]),!0),!0)}updateWindow(t,e){if(!(e<1||t<1||!this.connected||!this.server.NAWS))try{let i,n,s,o,r=Math.floor;i=r(t/256),i>256&&(i=255),n=t%256,s=r(e/256),s>256&&(s=255),o=e%256,this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><NAWS><"+i+"><"+n+"><"+s+"><"+o+"><IAC><SE>"),this.sendData(new Uint8Array([255,250,31,i,n,s,o,255,240]),!0)}catch(i){this.emit("error",{message:"UpdateWindow Error: "+i,err:i})}}sendGMCP(t){this.connected&&this.server.GMCP&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>"+this._escapeData(t).toString("binary")+"<IAC><SE>"),this.sendData(new Uint8Array([255,250,201]),!0),this.sendData(this._escapeData(t),!0),this.sendData(new Uint8Array([255,240]),!0))}_startGMCP(){this.server.GMCP&&(this.enableDebug&&this.emit("debug",'REPLY: <IAC><SB><GMCP>Core.Hello { "client": "'+this.terminal+'", "version": "'+this.version+'" }<IAC><SE>'),this.sendData(new Uint8Array([255,250,201]),!0),this.sendData('Core.Hello { "client": "'+this.terminal+'", "version": "'+this.version+'" }',!0),this.sendData(new Uint8Array([255,240]),!0),this.sendData(new Uint8Array([255,250,201]),!0),this.GMCPSupports.length>0?(this.GMCPSupports.indexOf("Core 1")===-1&&this.GMCPSupports.unshift("Core 1"),this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>"+JSON.stringify(this.GMCPSupports)+"<IAC><SE>"),this.sendData("Core.Supports.Set "+JSON.stringify(this.GMCPSupports))):(this.enableDebug&&this.emit("debug",'REPLY: <IAC><SB><GMCP>Core.Supports.Set [ "Core 1" ]<IAC><SE>'),this.sendData('Core.Supports.Set [ "Core 1" ]',!0)),this.sendData(new Uint8Array([255,240]),!0))}_startMCCP(){this._zlib=!0}_endMCCP(){this._zlib=!1,this.zStream=0}_decompressData(t){return this._zlib?(this.zStream||(this.zStream=new Ft.Zlib.InflateStream),this.enableDebug&&this.emit("debug","Pre decompress:"+ye(t),1),t=this.zStream.decompress(t),this.enableDebug&&this.emit("debug","Post decompress:"+ye(t),1),new Uint8Array(t)):t}_escapeData(t){if(t==null||typeof t>"u")return t;let e,i,n=0,s,o;if(t instanceof Uint8Array){for(e=t.byteLength,i=new de;n<e;n++)i.appendCode(t[n]),t[n]===255?i.appendCode(255):t[n]===13&&e===1?i.append(`\r
`):t[n]===10&&e===1&&i.append("\r\0");return i.toString()}for(e=t.length,i=new de;n<e;n++)o=t.charAt(n),s=t.charCodeAt(n),i.append(o),s===255?i.append(o):s===13&&e===1?i.append(`\r
`):s===10&&e===1&&i.append("\r\0");return i.toString()}_createSocket(t,e){let i;try{let n=/^[a-z0-9]+:\/\//.test(t);return n&&e>0?i=new WebSocket(t+":"+e,this.protocol||"binary"):n?i=new WebSocket(t,this.protocol||"binary"):t&&e>0?i=new WebSocket((this.scheme||"ws://")+t+":"+e,this.protocol||"binary"):t&&(i=new WebSocket((this.scheme||"ws://")+t,this.protocol||"binary")),i.binaryType="arraybuffer",i.onclose=s=>{s.code===1006&&s.type==="close"&&!this._closed?this.close():s.code!==1e3&&!this._closed&&(this.emit("error",{message:"Closed due to transmission error",err:s}),this.close())},i.onopen=()=>{this._connected=!0,this.emit("connect")},i.onmessage=s=>{if(s.data instanceof ArrayBuffer){var o=new Uint8Array(s.data);this.enableDebug&&this.emit("debug","Data ArrayBuffer received:"+ye(o)),this.receivedData(o)}else if(s.data instanceof Blob){var r=new FileReader;r.onloadend=()=>{var a=new Uint8Array(r.result);this.receivedData(a),this.enableDebug&&this.emit("debug","Data Blob received:"+ye(r.result))},r.readAsArrayBuffer(s.data)}else this.enableDebug&&this.emit("debug","Data received:"+s.data),this.receivedData(s.data)},i.onerror=s=>{this._closed||this.emit("error",s)},i}catch(n){this.emit("error",n)}return null}_destroySocket(){if(!(!this.socket||this.socket==null)){try{this.socket.onopen=function(){},this.socket.onclose=function(){},this.socket.onmessage=function(){},this.socket.onerror=function(){},this.connected&&this.socket.close(),delete this.socket}catch(t){this.emit("error",t)}this.socket=null}}_fireReceiveOption(t,e,i){let n={telnet:this,option:t,verb:250,value:i,handled:!1};return this.emit("received-option",n),n.handled}_fireReceiveMSDP(t,e){let i={telnet:this,variable:t,value:e,handled:!1};return this.emit("received-MSDP",i),i.handled}_fireReceiveGMCP(t){let e={telnet:this,value:t,handled:!1};return this.emit("received-GMCP",e),e.handled}_formatByte(t){return t<32||t>=127?"<"+t+">":String.fromCharCode(t)}};window.telnet=new We;var Oe=(u=>(u[u.None=0]="None",u[u.Bold=1]="Bold",u[u.Faint=2]="Faint",u[u.Underline=4]="Underline",u[u.Italic=3]="Italic",u[u.Slow=5]="Slow",u[u.Rapid=6]="Rapid",u[u.Inverse=7]="Inverse",u[u.Hidden=8]="Hidden",u[u.Strikeout=9]="Strikeout",u[u.DoubleUnderline=21]="DoubleUnderline",u[u.Overline=53]="Overline",u))(Oe||{}),$e=(k=>(k[k.ErrorBackground=-12]="ErrorBackground",k[k.ErrorText=-11]="ErrorText",k[k.InfoBackground=-8]="InfoBackground",k[k.InfoText=-7]="InfoText",k[k.LocalEcho=-3]="LocalEcho",k[k.LocalEchoBack=-4]="LocalEchoBack",k[k.Reset=0]="Reset",k[k.Bold=1]="Bold",k[k.Faint=2]="Faint",k[k.Italic=3]="Italic",k[k.Underline=4]="Underline",k[k.Blink=5]="Blink",k[k.BlinkRapid=6]="BlinkRapid",k[k.Reverse=7]="Reverse",k[k.Hidden=8]="Hidden",k[k.StrikeThrough=9]="StrikeThrough",k[k.DoubleUnderline=21]="DoubleUnderline",k[k.BoldOff=22]="BoldOff",k[k.ItalicOff=23]="ItalicOff",k[k.UnderlineOff=24]="UnderlineOff",k[k.BlinkOff=25]="BlinkOff",k[k.BlinkRapidOff=26]="BlinkRapidOff",k[k.ReverseOff=27]="ReverseOff",k[k.Visible=28]="Visible",k[k.StrikeThroughOff=29]="StrikeThroughOff",k[k.Black=30]="Black",k[k.Red=31]="Red",k[k.Green=32]="Green",k[k.Yellow=33]="Yellow",k[k.Blue=34]="Blue",k[k.Magenta=35]="Magenta",k[k.Cyan=36]="Cyan",k[k.White=37]="White",k[k.DefaultFore=39]="DefaultFore",k[k.BlackBackground=40]="BlackBackground",k[k.RedBackground=41]="RedBackground",k[k.GreenBackground=42]="GreenBackground",k[k.YellowBackground=43]="YellowBackground",k[k.BlueBackground=44]="BlueBackground",k[k.MagentaBackground=45]="MagentaBackground",k[k.CyanBackground=46]="CyanBackground",k[k.WhiteBackground=47]="WhiteBackground",k[k.DefaultBack=49]="DefaultBack",k[k.Subscript=74]="Subscript",k[k.Superscript=73]="Superscript",k[k.SubSuperOff=75]="SubSuperOff",k[k.XBlack=90]="XBlack",k[k.XRed=91]="XRed",k[k.XGreen=92]="XGreen",k[k.XYellow=93]="XYellow",k[k.XBlue=94]="XBlue",k[k.XMagenta=95]="XMagenta",k[k.XCyan=96]="XCyan",k[k.XWhite=97]="XWhite",k[k.XBlackBackground=100]="XBlackBackground",k[k.XRedBackground=101]="XRedBackground",k[k.XGreenBackground=102]="XGreenBackground",k[k.XYellowBackground=103]="XYellowBackground",k[k.XBlueBackground=104]="XBlueBackground",k[k.XMagentaBackground=105]="XMagentaBackground",k[k.XCyanBackground=106]="XCyanBackground",k[k.XWhiteBackground=107]="XWhiteBackground",k))($e||{});function Y(m,c){switch(m.toLowerCase()){case"black":return c?40:30;case"red":return c?41:31;case"green":return c?42:32;case"yellow":return c?43:33;case"blue":return c?44:34;case"magenta":return c?45:35;case"cyan":return c?46:36;case"white":return c?47:37;case"default":return c?49:39}return-1}function xt(m){let c=-1,t=-1,e=!1;switch(m-1024>=0&&(m-=1024),m-512>=0&&(m-=512),m-256>=0&&(m-=256),m-128>=0&&(m-=128,e=!0),m-112>=0&&(m-=112,t=47),m-96>=0&&(m-=96,t=43),m-80>=0&&(m-=80,t=45),m-64>=0&&(m-=64,t=41),m-48>=0&&(m-=48,t=46),m-32>=0&&(m-=32,t=42),m-16>=0&&(m-=16,t=44),m>=8&&(m-=8,e=!0),m){case 0:c=30;break;case 1:c=34;break;case 2:c=32;break;case 3:c=36;break;case 4:c=31;break;case 5:c=35;break;case 6:c=33;break;case 7:c=37;break}return e&&c===-1?c=370:e&&(c*=10),c===-1?`,${t}`:t===-1?c.toString():`${c},${t}`}function se(m){return!m||m.length===0?!1:["indianred","lightcoral","salmon","darksalmon","lightsalmon","crimson","red","firebrick","darkred","pink","lightpink","hotpink","deeppink","mediumvioletred","palevioletred","lightsalmon","coral","tomato","orangered","darkorange","orange","gold","yellow","lightyellow","lemonchiffon","lightgoldenrodyellow","papayawhip","moccasin","peachpuff","palegoldenrod","khaki","darkkhaki","lavender","thistle","plum","violet","orchid","fuchsia","magenta","mediumorchid","mediumpurple","blueviolet","darkviolet","darkorchid","darkmagenta","purple","indigo","slateblue","darkslateblue","mediumslateblue","greenyellow","chartreuse","lawngreen","lime","limegreen","palegreen","lightgreen","mediumspringgreen","springgreen","mediumseagreen","seagreen","forestgreen","green","darkgreen","yellowgreen","olivedrab","olive","darkolivegreen","mediumaquamarine","darkseagreen","lightseagreen","darkcyan","teal","aqua","cyan","lightcyan","paleturquoise","aquamarine","turquoise","mediumturquoise","darkturquoise","cadetblue","steelblue","lightsteelblue","powderblue","lightblue","skyblue","lightskyblue","deepskyblue","dodgerblue","cornflowerblue","mediumslateblue","royalblue","blue","mediumblue","darkblue","navy","midnightblue","cornsilk","blanchedalmond","bisque","navajowhite","wheat","burlywood","tan","rosybrown","sandybrown","goldenrod","darkgoldenrod","peru","chocolate","saddlebrown","sienna","brown","maroon","white","snow","honeydew","mintcream","azure","aliceblue","ghostwhite","whitesmoke","seashell","beige","oldlace","floralwhite","ivory","antiquewhite","linen","lavenderblush","mistyrose","gainsboro","lightgrey","silver","darkgray","gray","dimgray","lightslategray","slategray","darkslategray","black"].indexOf(m.toLowerCase())!=-1}function we(m,c){switch(m){case"errortextbackground":case"errorbackground":return-12;case"errortext":return c?-12:-11;case"infobackground":return-8;case"infotext":return c?-8:-7;case"localecho":return c?-4:-3;case"localechoback":return-4;case"reset":return 0;case"bold":return 1;case"faint":return 2;case"italic":return 3;case"underline":return 4;case"blink":return 5;case"blinkrapid":return 6;case"reverse":return 7;case"hidden":return 8;case"strikethrough":return 9;case"doubleunderline":return 21;case"boldoff":return 22;case"italicoff":return 23;case"underlineoff":return 24;case"blinkoff":return 25;case"blinkrapidoff":return 26;case"reverseoff":return 27;case"visible":return 28;case"strikethroughoff":return 29;case"black":return c?40:30;case"red":return c?41:31;case"green":return c?42:32;case"yellow":return c?43:33;case"blue":return c?44:34;case"magenta":return c?45:35;case"cyan":return c?46:36;case"white":return c?47:37;case"default":case"defaultfore":return c?49:39;case"blackbackground":return 40;case"redbackground":return 41;case"greenbackground":return 42;case"yellowbackground":return 43;case"bluebackground":return 44;case"magentabackground":return 45;case"cyanbackground":return 46;case"whitebackground":return 47;case"defaultbackground":case"defaultback":return 49;case"overline":return 53;case"subscript":return 74;case"superscript":return 73;case"subsuperoff":return 75;case"xblack":return c?100:90;case"xred":return c?101:91;case"xgreen":return c?102:92;case"xyellow":return c?103:93;case"xblue":return c?104:94;case"xmagenta":return c?105:95;case"xcyan":return c?106:96;case"xwhite":return c?107:97;case"xblackbackground":return 100;case"xredbackground":return 101;case"xgreenbackground":return 102;case"xyellowbackground":return 103;case"xbluebackground":return 104;case"xmagentabackground":return 105;case"xcyanbackground":return 106;case"xwhitebackground":return 107}return-1}var Me=class{constructor(c,t){this.width=0;this.height=0;this.width=c,this.height=t}};var X=[["bufferSize",0,2,500],["commandDelay",0,2,500],["commandDelayCount",0,2,5],["commandHistorySize",0,2,20],["fontSize",0,0,"1em",0],["cmdfontSize",0,0,"1em",0],["commandEcho",0,1,!0],["flashing",0,1,!1],["autoConnect",0,1,!0],["enableAliases",-1,1,!0],["enableTriggers",-1,1,!0],["enableMacros",-1,1,!0],["showScriptErrors",0,1,!1],["commandStacking",0,1,!0],["commandStackingChar",0,0,";",1],["htmlLog",0,1,!0],["keepLastCommand",0,1,!0],["enableMCCP",0,1,!0],["enableUTF8",0,1,!0],["font",0,5,"'Courier New', Courier, monospace",0],["cmdfont",0,5,"'Courier New', Courier, monospace",0],["aliases",-1,4],["macros",-1,4],["triggers",-1,4],["mapFollow","mapper.follow",1,!0],["mapEnabled","mapper.enabled",1,!0],["MapperSplitArea","mapper.split",1,!1],["MapperFillWalls","mapper.fill",1,!1],["MapperOpen","showMapper",1,!1],["fullScreen",-1,3,!1],["enableMXP",0,1,!0],["enableMSP",0,1,!0],["parseCommands",0,3,!0],["lagMeter",0,1,!1],["enablePing",0,1,!1],["enableEcho",0,1,!0],["enableSpeedpaths",0,1,!0],["speedpathsChar",0,0,"!",1],["parseSpeedpaths",0,1,!0],["profile",-1,0,"Default",1],["parseSingleQuotes",0,1,!1],["parseDoubleQuotes",0,1,!0],["logEnabled",0,1,!1],["logPrepend",0,1,!1],["logOffline",0,1,!1],["logUniqueOnConnect",0,1,!0],["enableURLDetection",0,1,!0],["colors",0,4],["notifyMSPPlay",0,1,!1],["CommandonClick",0,1,!0],["allowEval",0,1,!0],["allowEscape",0,1,!0],["AutoCopySelectedToClipboard",0,1,!1],["enableDebug",0,1,!1],["editorPersistent",0,1,!1],["askonclose",0,1,!0],["dev",0,1,!1],["chat.captureLines",0,1,!1],["chat.captureAllLines",0,1,!1],["chat.captureReviews",0,1,!1],["chat.captureTells",0,1,!1],["chat.captureTalk",0,1,!1],["chat.gag",0,1,!1],["chat.CaptureOnlyOpen",0,1,!1],["checkForUpdates",0,1,!1],["autoCreateCharacter",0,1,!1],["askonchildren",0,1,!0],["mapper.legend",0,1,!1],["mapper.room",0,1,!1],["mapper.importType",0,2,1],["mapper.vscroll",0,2,0],["mapper.hscroll",0,2,0],["mapper.scale",0,2,1],["mapper.alwaysOnTop",0,1,!1],["mapper.alwaysOnTopClient",0,1,!0],["mapper.memory",0,1,!1],["mapper.memorySavePeriod",0,2,9e5],["mapper.active.ID",0,0,null],["mapper.active.x",0,2,0],["mapper.active.y",0,2,0],["mapper.active.z",0,2,0],["mapper.active.area",0,0,null],["mapper.active.zone",0,2,0],["mapper.persistent",0,1,!0],["profiles.split",0,2,-1],["profiles.askoncancel",0,1,!0],["profiles.triggersAdvanced",0,1,!1],["profiles.aliasesAdvanced",0,1,!1],["profiles.buttonsAdvanced",0,1,!1],["profiles.macrosAdvanced",0,1,!1],["profiles.contextsAdvanced",0,1,!1],["profiles.codeEditor",0,1,!0],["profiles.watchFiles",0,1,!0],["chat.alwaysOnTop",0,1,!1],["chat.alwaysOnTopClient",0,1,!0],["chat.log",0,1,!1],["chat.persistent",0,1,!1],["chat.zoom",0,2,1],["chat.font",0,5,"'Courier New', Courier, monospace"],["chat.fontSize",0,0,"1em"],["title",0,0,"$t"],["logGagged",0,1,!1],["logTimeFormat",0,0,"YYYYMMDD-HHmmss"],["autoConnectDelay",0,2,600],["autoLogin",0,1,!0],["onDisconnect",0,2,2],["enableKeepAlive",0,1,!1],["keepAliveDelay",0,2,0],["newlineShortcut",0,2,1],["logWhat",0,2,1],["logErrors",0,1,!0],["showErrorsExtended",0,1,!1],["reportCrashes",0,1,!1],["enableCommands",0,1,!0],["commandChar",0,0,"#",1],["escapeChar",0,0,"\\",1],["enableVerbatim",0,1,!0],["verbatimChar",0,0,"`"],["soundPath",0,0,""],["logPath",0,0,""],["theme",0,0,""],["gamepads",0,1,!1],["buttons.connect",0,1,!0],["buttons.characters",0,1,!0],["buttons.preferences",0,1,!0],["buttons.log",0,1,!0],["buttons.clear",0,1,!0],["buttons.lock",0,1,!0],["buttons.map",0,1,!0],["buttons.user",0,1,!0],["buttons.mail",0,1,!1],["buttons.compose",0,1,!1],["buttons.immortal",0,1,!0],["buttons.codeEditor",0,1,!1],["find.case",0,1,!1],["find.word",0,1,!1],["find.reverse",0,1,!1],["find.regex",0,1,!1],["find.selection",0,1,!1],["find.show",0,1,!1],["display.split",0,1,!1],["display.splitHeight",0,2,-1],["display.splitLive",0,1,!0],["display.roundedOverlays",0,1,!0],["backupLoad",0,2,30],["backupSave",0,2,30],["backupAllProfiles",0,1,!0],["scrollLocked",0,1,!1],["showStatus",0,1,!0],["showCharacterManager",0,1,!1],["showChat",0,1,!1],["showEditor",0,1,!1],["showArmor",0,1,!1],["showStatusWeather",0,1,!0],["showStatusLimbs",0,1,!0],["showStatusHealth",0,1,!0],["showStatusExperience",0,1,!0],["showStatusPartyHealth",0,1,!0],["showStatusCombatHealth",0,1,!0],["showButtonBar",0,1,!0],["allowNegativeNumberNeeded",0,1,!1],["spellchecking",0,1,!0],["hideOnMinimize",0,1,!1],["showTrayIcon",0,1,!1],["statusExperienceNeededProgressbar",0,1,!1],["trayClick",0,2,0],["trayDblClick",0,2,0],["pasteSpecialPrefix",0,0,""],["pasteSpecialPostfix",0,0,""],["pasteSpecialReplace",0,0,""],["pasteSpecialPrefixEnabled",0,1,!0],["pasteSpecialPostfixEnabled",0,1,!0],["pasteSpecialReplaceEnabled",0,1,!0],["display.showSplitButton",0,1,!0],["chat.split",0,1,!1],["chat.splitHeight",0,2,-1],["chat.splitLive",0,1,!0],["chat.roundedOverlays",0,1,!0],["chat.showSplitButton",0,1,!0],["chat.bufferSize",0,2,500],["chat.flashing",0,1,!1],["display.hideTrailingEmptyLine",0,1,!0],["display.enableColors",0,1,!0],["display.enableBackgroundColors",0,1,!0],["enableSound",0,1,!0],["allowHalfOpen",0,1,!0],["editorClearOnSend",0,1,!0],["editorCloseOnSend",0,1,!0],["askOnCloseAll",0,1,!0],["askonloadCharacter",0,1,!0],["mapper.roomWidth",0,2,200],["mapper.roomGroups",0,2,7],["mapper.showInTaskBar",0,1,!1],["profiles.enabled",0,4,[]],["profiles.sortOrder",0,2,12],["profiles.sortDirection",0,2,1],["profiles.showInTaskBar",0,1,!1],["profiles.profileSelected",0,0,"default"],["profiles.profileExpandSelected",0,1,!0],["chat.lines",0,4,[]],["chat.showInTaskBar",0,1,!1],["chat.showTimestamp",0,1,!1],["chat.timestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["chat.tabWidth",0,2,8],["chat.displayControlCodes",0,1,!1],["chat.emulateTerminal",0,1,!1],["chat.emulateControlCodes",0,1,!0],["chat.wordWrap",0,1,!1],["chat.wrapAt",0,2,0],["chat.indent",0,2,4],["chat.scrollLocked",0,1,!1],["chat.find.case",0,1,!1],["chat.find.word",0,1,!1],["chat.find.reverse",0,1,!1],["chat.find.regex",0,1,!1],["chat.find.selection",0,1,!1],["chat.find.show",0,1,!1],["chat.find.highlight",0,1,!1],["chat.find.location",0,4,[5,20]],["codeEditor.showInTaskBar",0,1,!1],["codeEditor.persistent",0,1,!1],["codeEditor.alwaysOnTop",0,1,!1],["codeEditor.alwaysOnTopClient",0,1,!0],["autoTakeoverLogin",0,1,!1],["fixHiddenWindows",0,1,!0],["maxReconnectDelay",0,2,3600],["enableBackgroundThrottling",0,1,!0],["enableBackgroundThrottlingClients",0,1,!1],["showInTaskBar",0,1,!0],["showLagInTitle",0,1,!1],["mspMaxRetriesOnError",0,2,0],["logTimestamp",0,1,!1],["logTimestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["disableTriggerOnError",0,1,!0],["prependTriggeredLine",0,1,!0],["enableParameters",0,1,!0],["parametersChar",0,0,"%",1],["enableNParameters",0,1,!0],["nParametersChar",0,0,"$",1],["enableParsing",0,1,!0],["externalWho",0,1,!0],["externalHelp",0,1,!0],["watchForProfilesChanges",0,1,!1],["onProfileChange",0,2,0],["onProfileDeleted",0,2,0],["enableDoubleParameterEscaping",0,1,!1],["ignoreEvalUndefined",0,1,!0],["enableInlineComments",0,1,!0],["enableBlockComments",0,1,!0],["inlineCommentString",0,0,"//"],["blockCommentString",0,0,"/*"],["allowCommentsFromCommand",0,1,!1],["saveTriggerStateChanges",0,1,!0],["groupProfileSaves",0,1,!1],["groupProfileSaveDelay",0,2,2e4],["returnNewlineOnEmptyValue",0,1,!1],["pathDelay",0,2,0],["pathDelayCount",0,2,1],["echoSpeedpaths",0,1,!1],["alwaysShowTabs",0,1,!1],["scriptEngineType",0,2,4],["initializeScriptEngineOnLoad",0,1,!1],["find.highlight",0,1,!1],["find.location",0,4,[5,20]],["display.showInvalidMXPTags",0,1,!1],["display.showTimestamp",0,1,!1],["display.timestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["display.displayControlCodes",0,1,!1],["display.emulateTerminal",0,1,!1],["display.emulateControlCodes",0,1,!0],["display.wordWrap",0,1,!1],["display.tabWidth",0,2,8],["display.wrapAt",0,2,0],["display.indent",0,2,4],["statusWidth",0,2,-1],["showEditorInTaskBar",0,1,!0],["trayMenu",0,2,0],["lockLayout",0,1,!1],["loadLayout",0,0,""],["useSingleInstance",0,1,!0],["onSecondInstance",0,2,0],["characterManagerDblClick",0,2,0],["enableTabCompletion",1,!0],["ignoreCaseTabCompletion",0,1,!1],["tabCompletionBufferLimit",0,2,100],["enableNotifications",0,1,!0],["echo",0,2,0],["commandAutoSize",0,1,!1],["commandWordWrap",0,1,!1],["commandScrollbars",0,1,!1],["tabCompletionList",0,0,""],["tabCompletionLookupType",0,2,1],["tabCompletionReplaceCasing",0,2,0],["characterManagerAddButtonAction",0,2,0],["enableCrashReporting",0,1,!1],["characterManagerPanelWidth",0,2,0],["ignoreInputLeadingWhitespace",0,1,!1],["profiles.find.case",0,1,!1],["profiles.find.word",0,1,!1],["profiles.find.reverse",0,1,!1],["profiles.find.regex",0,1,!1],["profiles.find.selection",0,1,!1],["profiles.find.show",0,1,!1],["profiles.find.value",0,1,!1],["skipMore",0,1,!1],["skipMoreDelay",0,2,5e3],["commandMinLines",0,2,1],["backupReplaceCharacters",0,1,!0],["simpleAlarms",0,1,!1],["simpleEditor",0,1,!1],["selectLastCommand",0,1,!0]];var Ae=class m{constructor(){for(var c=0,t=X.length;c<t;c++)X[c][2]!==4&&(this[X[c][0]]=m.getValue(X[c][0]));this.colors=m.getValue("colors")}static{this.settingError=!1}static getValue(c,t){var e;if(m.settingError)return t===null||typeof t>"u"?m.defaultValue(c):t;try{if(e=$.jStorage.get(c),typeof e>"u"||e===null)return t===null||typeof t>"u"?m.defaultValue(c):t;switch(c){case"showChat":case"showStatus":case"showButtons":case"enableCommands":case"enableVerbatim":case"allowEscape":case"autoConnect":case"mapFollow":case"mapEnabled":case"flashing":case"commandEcho":case"enableAliases":case"enableTriggers":case"enableButtons":case"enableMacros":case"commandStacking":case"htmlLog":case"keepLastCommand":case"fullScreen":case"enableMXP":case"enableURLDetection":case"enableMCCP":case"enableUTF8":case"parseCommands":case"lagMeter":case"showScriptErrors":case"enablePing":case"enableEcho":case"enableSpeedpaths":case"parseSpeedpaths":case"MapperSplitArea":case"parseSingleQuotes":case"parseDoubleQuotes":case"logEnabled":case"logOffline":case"logPrepend":case"logUniqueOnConnect":case"toolsPinned":case"notifyMSPPlay":case"CommandonClick":case"allowEval":case"disableTriggerOnError":case"prependTriggeredLine":case"chat.captureLines":case"chat.captureAllLines":case"chat.captureReviews":case"chat.captureTells":case"chat.captureTalk":case"chat.gag":case"chat.CaptureOnlyOpen":case"simpleAlarms":case"simpleEditor":case"selectLastCommand":return e==1;case"colors":case"chat.lines":return e===null||typeof e>"u"||e.length===0?[]:JSON.parse(e)}return e}catch(i){return m.settingError||(alert(`Unable to save to localStorage so reverting to default,

Error description: `+i.message),m.settingError=!0),t===null||typeof t>"u"?m.defaultValue(t):t}}static setValue(c,t){switch(c){case"colors":case"chat.lines":t===null||typeof t>"u"||t.length===0?$.jStorage.deleteKey(c):$.jStorage.set(c,JSON.stringify(t));break;default:typeof t=="boolean"?t?$.jStorage.set(c,1):$.jStorage.set(c,0):$.jStorage.set(c,t);break}}static clearValue(c){$.jStorage.deleteKey(c)}static defaultValue(c){switch(c){case"bufferSize":return 500;case"commandDelay":return 500;case"commandDelayCount":return 5;case"commandHistorySize":return 20;case"fontSize":return"1em";case"cmdfontSize":return"1em";case"commandEcho":return!0;case"flashing":return!1;case"autoConnect":return!0;case"enableAliases":return!0;case"enableTriggers":return!0;case"enableMacros":return!0;case"showScriptErrors":return!1;case"commandStacking":return!0;case"commandStackingChar":return";";case"htmlLog":return!0;case"keepLastCommand":return!0;case"enableMCCP":return!0;case"enableUTF8":return!0;case"font":return"'Courier New', Courier, monospace";case"cmdfont":return"'Courier New', Courier, monospace";case"mapFollow":case"mapper.follow":return!0;case"mapEnabled":case"mapper.enabled":return!0;case"MapperSplitArea":case"mapper.split":return!1;case"MapperFillWalls":case"mapper.fill":return!1;case"MapperOpen":case"showMapper":return!1;case"fullScreen":return!1;case"enableMXP":return!0;case"enableMSP":return!0;case"parseCommands":return!0;case"lagMeter":return!1;case"enablePing":return!1;case"enableEcho":return!0;case"enableSpeedpaths":return!0;case"speedpathsChar":return"!";case"parseSpeedpaths":return!0;case"profile":return"Default";case"parseSingleQuotes":return!1;case"parseDoubleQuotes":return!0;case"logEnabled":return!1;case"logPrepend":return!1;case"logOffline":return!1;case"logUniqueOnConnect":return!0;case"enableURLDetection":return!0;case"notifyMSPPlay":return!1;case"CommandonClick":return!0;case"allowEval":return!0;case"allowEscape":return!0;case"AutoCopySelectedToClipboard":return!1;case"enableDebug":return!1;case"editorPersistent":return!1;case"askonclose":return!0;case"dev":return!1;case"chat.captureLines":return!1;case"chat.captureAllLines":return!1;case"chat.captureReviews":return!1;case"chat.captureTells":return!1;case"chat.captureTalk":return!1;case"chat.gag":return!1;case"chat.CaptureOnlyOpen":return!1;case"checkForUpdates":return!1;case"autoCreateCharacter":return!1;case"askonchildren":return!0;case"mapper.legend":return!1;case"mapper.room":return!1;case"mapper.importType":return 1;case"mapper.vscroll":return 0;case"mapper.hscroll":return 0;case"mapper.scale":return 1;case"mapper.active":return{ID:null,x:0,y:0,z:0,area:null,zone:0};case"mapper.active.ID":return null;case"mapper.active.x":return 0;case"mapper.active.y":return 0;case"mapper.active.z":return 0;case"mapper.active.area":return null;case"mapper.active.zone":return 0;case"profiles.split":return-1;case"profiles.askoncancel":return!0;case"profiles.triggersAdvanced":return!1;case"profiles.aliasesAdvanced":return!1;case"profiles.buttonsAdvanced":return!1;case"profiles.macrosAdvanced":return!1;case"profiles.contextsAdvanced":return!1;case"profiles.codeEditor":return!0;case"chat.log":return!1;case"chat.zoom":return 1;case"chat.font":return"'Courier New', Courier, monospace";case"chat.fontSize":return"1em";case"title":return"$t";case"logGagged":return!1;case"logTimeFormat":return"YYYYMMDD-HHmmss";case"autoConnectDelay":return 600;case"autoLogin":return!0;case"onDisconnect":return 2;case"enableKeepAlive":return!1;case"keepAliveDelay":return 0;case"newlineShortcut":return 1;case"logWhat":return 1;case"logErrors":return!0;case"showErrorsExtended":return!1;case"reportCrashes":return!1;case"enableCommands":return!0;case"commandChar":return"#";case"escapeChar":return"\\";case"enableVerbatim":return!0;case"verbatimChar":return"`";case"soundPath":return"";case"logPath":return"";case"theme":return"";case"gamepads":return!1;case"backupLoad":return 30;case"backupSave":return 30;case"backupAllProfiles":return!0;case"backupReplaceCharacters":return!0;case"scrollLocked":return!1;case"showStatus":return!0;case"showChat":return!1;case"showEditor":return!1;case"showArmor":return!1;case"showStatusWeather":return!0;case"showStatusLimbs":return!0;case"showStatusHealth":return!0;case"showStatusExperience":return!0;case"showStatusPartyHealth":return!0;case"showStatusCombatHealth":return!0;case"allowNegativeNumberNeeded":return!1;case"spellchecking":return!0;case"statusExperienceNeededProgressbar":return!1;case"pasteSpecialPrefix":return"";case"pasteSpecialPostfix":return"";case"pasteSpecialReplace":return"";case"pasteSpecialPrefixEnabled":return!0;case"pasteSpecialPostfixEnabled":return!0;case"pasteSpecialReplaceEnabled":return!0;case"display.showSplitButton":return!0;case"chat.bufferSize":return 500;case"chat.flashing":return!1;case"display.hideTrailingEmptyLine":return!0;case"display.enableColors":return!0;case"display.enableBackgroundColors":return!0;case"enableSound":return!0;case"editorClearOnSend":return!0;case"editorCloseOnSend":return!0;case"askOnCloseAll":return!0;case"askonloadCharacter":return!0;case"mapper.roomWidth":return 200;case"mapper.roomGroups":return 7;case"mapper.showInTaskBar":return!1;case"profiles.enabled":return[];case"profiles.sortOrder":return 12;case"profiles.sortDirection":return 1;case"profiles.profileSelected":return"default";case"profiles.profileExpandSelected":return!0;case"chat.lines":return[];case"chat.showTimestamp":return!1;case"chat.timestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"chat.tabWidth":return 8;case"chat.displayControlCodes":return!1;case"chat.emulateTerminal":return!1;case"chat.emulateControlCodes":return!0;case"chat.wordWrap":return!1;case"chat.wrapAt":return 0;case"chat.indent":return 4;case"autoTakeoverLogin":return!1;case"maxReconnectDelay":return 3600;case"showLagInTitle":return!1;case"mspMaxRetriesOnError":return 0;case"logTimestamp":return!1;case"logTimestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"disableTriggerOnError":return!0;case"prependTriggeredLine":return!0;case"enableParameters":return!0;case"parametersChar":return"%";case"enableNParameters":return!0;case"nParametersChar":return"$";case"enableParsing":return!0;case"onProfileChange":return 0;case"onProfileDeleted":return 0;case"enableDoubleParameterEscaping":return!1;case"ignoreEvalUndefined":return!0;case"enableInlineComments":return!0;case"enableBlockComments":return!0;case"inlineCommentString":return"//";case"blockCommentString":return"/*";case"allowCommentsFromCommand":return!1;case"saveTriggerStateChanges":return!0;case"groupProfileSaves":return!1;case"groupProfileSaveDelay":return 2e4;case"returnNewlineOnEmptyValue":return!1;case"pathDelay":return 0;case"pathDelayCount":return 1;case"echoSpeedpaths":return!1;case"scriptEngineType":return 4;case"initializeScriptEngineOnLoad":return!1;case"display.showInvalidMXPTags":return!1;case"display.showTimestamp":return!1;case"display.timestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"display.displayControlCodes":return!1;case"display.emulateTerminal":return!1;case"display.emulateControlCodes":return!0;case"display.wordWrap":return!1;case"display.tabWidth":return 8;case"display.wrapAt":return 0;case"display.indent":return 4;case"statusWidth":return-1;case"extensions":return{};case"warnAdvancedSettings":return!0;case"showAdvancedSettings":return!1;case"enableTabCompletion":return!0;case"ignoreCaseTabCompletion":return!1;case"tabCompletionBufferLimit":return 100;case"enableNotifications":return!0;case"echo":return 0;case"commandAutoSize":return!1;case"commandWordWrap":return!1;case"commandMinLines":return 1;case"tabCompletionLookupType":return 1;case"tabCompletionList":return"";case"tabCompletionReplaceCasing":return 0;case"ignoreInputLeadingWhitespace":return!1;case"skipMore":return!1;case"skipMoreDelay":return 5e3;case"simpleAlarms":return!1;case"simpleEditor":return!1;case"selectLastCommand":return!0}return null}save(){for(var c in this)this.hasOwnProperty(c)&&m.setValue(c,this[c])}reset(){for(var c=0,t=X.length;c<t;c++)X[c][2]!==4&&(this[X[c][0]]=m.defaultValue(X[c][0]));this.colors=[]}};var Xe=(r=>(r[r.Regular=0]="Regular",r[r.CommandInputRegular=1]="CommandInputRegular",r[r.Event=2]="Event",r[r.Alarm=3]="Alarm",r[r.Pattern=8]="Pattern",r[r.CommandInputPattern=16]="CommandInputPattern",r[r.Expression=64]="Expression",r[r.LoopExpression=128]="LoopExpression",r))(Xe||{});var je=(a=>(a[a.Skip=512]="Skip",a[a.Wait=1024]="Wait",a[a.LoopPattern=4096]="LoopPattern",a[a.LoopLines=8192]="LoopLines",a[a.Duration=16384]="Duration",a[a.WithinLines=32768]="WithinLines",a[a.Manual=65536]="Manual",a[a.ReParse=131072]="ReParse",a[a.ReParsePattern=262144]="ReParsePattern",a))(je||{});function Ge(m){let c=[];if(m.gamepad>0)return c.push("Gamepad "+m.gamepad),m.key>0?c.push("Button "+m.key):m.gamepadAxes<0?c.push("Axis "+-m.gamepadAxes):m.gamepadAxes>0&&c.push("Axis "+m.gamepadAxes),c.length===1?"None":c.join("+");if(m.key===0)return m.name&&m.name.length>0?"None - "+m.name:"None";if((m.modifiers&4)===4&&c.push("Ctrl"),(m.modifiers&2)===2&&c.push("Alt"),(m.modifiers&8)===8&&c.push("Shift"),(m.modifiers&16)===16&&c.push("Meta"),wt[m.key])c.push(wt[m.key]);else return m.name&&m.name.length>0?"None - "+m.name:"None";return m.name&&m.name.length>0?c.join("+")+" - "+m.name:c.join("+")}var oe=class m{constructor(c,t){this.temp=!1;this.start=!1;this.seconds=-1;this.secondsWildcard=!0;this.hours=-1;this.hoursWildcard=!0;this.minutes=-1;this.minutesWildcard=!0;this.suspended=0;this.restart=0;typeof c=="string"&&(t=c,c=0),this.parent=c,this.pattern=t,this.startTime=Date.now(),this.prevTime=this.startTime}static parse(c,t,e){if(typeof c=="string"&&(t=c,c=0),!t||t.length===0)if(typeof c=="object")t=c.pattern;else throw new Error("Blank pattern");let i=new m(c,t);for(;t[0]==="-"||t[0]==="+";)t[0]==="-"?i.start=!0:t[0]==="+"&&(i.temp=!0),t=t.substr(1);if(t!=="*"){let n=t.split(":"),s;if(n.length===0)throw new Error("Invalid format: "+t);if(n.length===1)if(n[0]==="*")i.secondsWildcard=!0,i.seconds=-1;else{if(n[0][0]==="*"?(i.secondsWildcard=!0,n[0]=n[0].substr(1)):i.secondsWildcard=!1,s=parseInt(n[0],10),isNaN(s))throw new Error("Invalid Format: "+n[0]);if(s<0)throw new Error("Seconds must be greater than or equal to 0.");s>59&&(i.secondsWildcard=!0),i.seconds=s}else if(n.length===2){if(n[0]==="*")i.minutesWildcard=!0,i.minutes=-1;else{if(n[0][0]==="*"?(i.minutesWildcard=!0,n[0]=n[0].substr(1)):i.minutesWildcard=!1,s=parseInt(n[0],10),isNaN(s))throw new Error("Invalid Format: "+n[0]);if(s<0||s>59)throw new Error("Minutes can only be 0 to 59");i.minutes=s}if(n[1]==="*")i.secondsWildcard=!0,i.seconds=-1;else{if(n[1][0]==="*"?(i.secondsWildcard=!0,n[1]=n[1].substr(1)):i.secondsWildcard=!1,s=parseInt(n[1],10),isNaN(s))throw new Error("Invalid Format: "+n[1]);if(s<0||s>59)throw new Error("Seconds can only be 0 to 59");i.seconds=s}}else{if(n[0]==="*")i.hoursWildcard=!0,i.hours=-1;else{if(n[0][0]==="*"?(i.hoursWildcard=!0,n[0]=n[0].substr(1)):i.hoursWildcard=!1,s=parseInt(n[0],10),isNaN(s))throw new Error("Invalid Format: "+n[0]);if(s<0||s>23)throw new Error("Hours can only be 0 to 23");i.hours=s}if(n[1]==="*")i.minutesWildcard=!0,i.seconds=-1;else{if(n[1][0]==="*"?(i.minutesWildcard=!0,n[1]=n[1].substr(1)):i.minutesWildcard=!1,s=parseInt(n[1],10),isNaN(s))throw new Error("Invalid Format: "+n[1]);if(s<0||s>59)throw new Error("Minutes can only be 0 to 59");i.minutes=s}if(n[2]==="*")i.secondsWildcard=!0,i.seconds=-1;else{if(n[2][0]==="*"?(i.secondsWildcard=!0,n[2]=n[2].substr(2)):i.secondsWildcard=!1,s=parseInt(n[2],10),isNaN(s))throw new Error("Invalid Format: "+n[2]);if(s<0||s>59)throw new Error("Seconds can only be 0 to 59");i.seconds=s}}}return e&&(i.temp=!1),i}setTempTime(c){c?this.tempTime=Date.now()+c:this.tempTime=0}},Ce=class m{constructor(c,t){this.name="";this.priority=0;this.display="name";this.displaytype=0;this.value="";this.style=1;this.group="";this.enabled=!0;this.notes="";if(typeof c=="object"){let e;for(e in c)c.hasOwnProperty(e)&&(this[e]=c[e])}this.profile=t}clone(){return new m(this)}},J=class m extends Ce{constructor(t,e){super(t);this.caption="";this.icon="";this.append=!1;this.send=!0;this.chain=!1;this.stretch=!1;this.parse=!1;this.top=-1;this.left=-1;this.right=-1;this.bottom=-1;this.width=64;this.height=64;this.iconOnly=!1;if(this.caption="NewButton",this.display="caption",typeof t=="object"){let i;for(i in t)t.hasOwnProperty(i)&&(this[i]=t[i])}this.profile=e}clone(){return new m(this)}},He=class m extends Ce{constructor(t,e){super();this.key=0;this.append=!1;this.send=!0;this.modifiers=0;this.chain=!1;this.gamepad=0;this.gamepadAxes=0;if(this.display="return MacroDisplay(item)",this.displaytype=1,typeof t=="object"){let i;for(i in t)t.hasOwnProperty(i)&&(this[i]=t[i])}this.profile=e}clone(){return new m(this)}},Ne=class m extends Ce{constructor(t,e,i){super();this.pattern="NewAlias";this.regexp=!1;this.multi=!1;this.append=!0;this.params="";if(typeof t=="string"&&(this.pattern=t),e!=null&&(this.value=e),this.display="pattern",typeof t=="object"){let n;for(n in t)t.hasOwnProperty(n)&&(this[n]=t[n])}this.profile=i}clone(){return new m(this)}},ue=class m extends Ce{constructor(t,e){super(t);this.pattern="NewTrigger";this.verbatim=!1;this.triggerNewline=!0;this.triggerPrompt=!1;this.type=0;this.temp=!1;this.caseSensitive=!1;this.raw=!1;this.state=0;this.params="";this.triggers=[];this.fired=!1;if(this.display="pattern",typeof t=="object"){let i;for(i in t)if(t.hasOwnProperty(i))if(i==="triggers"){this.triggers=[];let n=t.triggers.length;for(let s=0;s<n;s++)this.triggers.push(new m(t.triggers[s]))}else this[i]=t[i]}this.profile=e}clone(){return new m(this)}getState(t){return t===0?this:(t--,t>=this.triggers.length||t<0?null:this.triggers[t])}},et=class m extends Ce{constructor(t,e){super(t);this.caption="";this.icon="";this.append=!1;this.send=!0;this.chain=!1;this.parent="";this.items=[];this.parse=!1;if(this.caption="NewContext",this.display="caption",typeof t=="object"){let i;for(i in t)if(t.hasOwnProperty(i))if(i==="items"){let n=0,s=t[i].length;for(;n<s;n++)this.items.push(new m(t[i][n]))}else this[i]=t[i]}this.profile=e}clone(){return new m(this)}},tt=class m extends Ce{constructor(t,e){super(t);this._type="string";this.type=1;this.defaultValue="";this.useDefault=!1;this.params="";this.profile=e,this.useDefault&&this.setValue(this.defaultValue)}set setValue(t){switch(this.type){case 2:typeof t=="string"?(t=parseInt(t,10),isNaN(t)&&(t=0)):typeof t=="boolean"&&(t=t?1:0);break;case 7:typeof t=="string"?(t=parseFloat(t),isNaN(t)&&(t=0)):typeof t=="boolean"&&(t=t?1:0);break}this.value=t,this._type=typeof t}get getValue(){switch(this.type){case 1:if(typeof this.value!==this._type)switch(this._type){case"number":return Number(this.value);case"string":return this.value.toString();case"boolean":return!!this.value}return this.value;case 7:return parseFloat(this.value);case 2:return parseInt(this.value,10);case 6:if(typeof this.value=="string")try{return JSON.parse(this.value)}catch{return this.value}return this.value;case 5:return typeof this.value=="string"?Ze(this.value,"|"):this.value}return this.value}clone(){return new m(this)}toString(){switch(this.type){case 6:return typeof this.value=="string"?this.value:JSON.stringify(this.value);case 5:return typeof this.value=="string"?this.value:'"'+this.value.join('"|"')+'"'}return this.value?.toString()}},pe=class m{constructor(c,t){this.name="";this.file="";this.priority=0;this.enabled=!0;this.aliases=[];this.triggers=[];this.macros=[];this.buttons=[];this.contexts=[];this.enableMacros=!0;this.enableTriggers=!0;this.enableAliases=!0;this.enableButtons=!0;this.enableContexts=!0;this.enableDefaultContext=!0;typeof c=="string"?(this.name=c,this.file=c.toLowerCase(),(t==null||t)&&(this.macros=m.DefaultMacros)):typeof c=="boolean"?c&&(this.macros=m.DefaultMacros):(t==null||t)&&(this.macros=m.DefaultMacros)}static get Default(){return new m("Default")}static get DefaultMacros(){let c=[{key:97,display:"return MacroDisplay(item)",displaytype:1,value:"sw",style:1,append:!1,send:!0,name:"SouthWest",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:98,display:"return MacroDisplay(item)",displaytype:1,value:"s",style:1,append:!1,send:!0,name:"South",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:99,display:"return MacroDisplay(item)",displaytype:1,value:"se",style:1,append:!1,send:!0,name:"SouthEast",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:100,display:"return MacroDisplay(item)",displaytype:1,value:"w",style:1,append:!1,send:!0,name:"West",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:101,display:"return MacroDisplay(item)",displaytype:1,value:"l",style:1,append:!1,send:!0,name:"Look",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:102,display:"return MacroDisplay(item)",displaytype:1,value:"e",style:1,append:!1,send:!0,name:"East",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:103,display:"return MacroDisplay(item)",displaytype:1,value:"nw",style:1,append:!1,send:!0,name:"NorthWest",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:104,display:"return MacroDisplay(item)",displaytype:1,value:"n",style:1,append:!1,send:!0,name:"North",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:105,display:"return MacroDisplay(item)",displaytype:1,value:"ne",style:1,append:!1,send:!0,name:"NorthEast",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""}],t=[],e=c.length;for(let i=0;i<e;i++)t.push(new He(c[i]));return t}static get DefaultButtons(){let c=[],t;return t=new J,t.right=176,t.top=14,t.caption="fa-solid fa-angle-double-up",t.value="up",t.width=48,t.height=48,c.push(t),t=new J,t.right=124,t.top=14,t.caption="fa-solid fa-caret-up,rotate--45",t.value="northwest",t.width=48,t.height=48,c.push(t),t=new J,t.right=72,t.top=14,t.caption="fa-solid fa-caret-up",t.value="north",t.width=48,t.height=48,c.push(t),t=new J,t.right=20,t.top=14,t.caption="fa-solid fa-caret-up,rotate-45",t.value="northeast",t.width=48,t.height=48,c.push(t),t=new J,t.right=176,t.top=66,t.caption="fa-solid fa-crosshairs",t.value="kill ${selected}",t.width=48,t.height=48,c.push(t),t=new J,t.right=124,t.top=66,t.caption="fa-solid fa-caret-left",t.value="west",t.width=48,t.height=48,c.push(t),t=new J,t.right=72,t.top=66,t.caption="fa-solid fa-magnifying-glass",t.value="look ${selected}",t.width=48,t.height=48,c.push(t),t=new J,t.right=20,t.top=66,t.caption="fa-solid fa-caret-right",t.value="east",t.width=48,t.height=48,c.push(t),t=new J,t.right=176,t.top=118,t.caption="fa-solid fa-angle-double-down",t.value="down",t.width=48,t.height=48,c.push(t),t=new J,t.right=124,t.top=118,t.caption="fa-solid fa-caret-down,rotate-45",t.value="southwest",t.width=48,t.height=48,c.push(t),t=new J,t.right=72,t.top=118,t.caption="fa-solid fa-caret-down",t.value="south",t.width=48,t.height=48,c.push(t),t=new J,t.right=20,t.top=118,t.caption="fa-solid fa-caret-down,rotate--45",t.value="southeast",t.width=48,t.height=48,c.push(t),c}static load(c){let t,e;if(typeof c=="object")e=c;else return new m;t=new m(!1);let i;for(i in e)e.hasOwnProperty(i)&&(i==="aliases"||i==="triggers"||i==="macros"||i==="buttons"||i==="contexts"||i==="variables"||(t[i]=e[i]));let n,s;if(e.aliases&&e.aliases.length>0)for(s=e.aliases.length,n=0;n<s;n++)t.aliases.push(new Ne(e.aliases[n],null,t));if(e.triggers&&e.triggers.length>0)for(s=e.triggers.length,n=0;n<s;n++)t.triggers.push(new ue(e.triggers[n],t));if(e.macros&&e.macros.length>0)for(s=e.macros.length,t.macros=[],n=0;n<s;n++)t.macros.push(new He(e.macros[n],t));if(e.buttons&&e.buttons.length>0)for(s=e.buttons.length,n=0;n<s;n++)t.buttons.push(new J(e.buttons[n],t));if(e.contexts&&e.contexts.length>0)for(s=e.contexts.length,n=0;n<s;n++)t.contexts.push(new et(e.contexts[n],t));return t.file=t.name,t}clone(c){let t,e,i;if(c===2){if(t={name:this.name,priority:this.priority,enabled:this.enabled,aliases:[],triggers:[],macros:[],buttons:[],contexts:[],enableMacros:this.enableMacros,enableTriggers:this.enableTriggers,enableAliases:this.enableAliases,enableButtons:this.enableButtons,enableContexts:this.enableContexts,enableDefaultContext:this.enableDefaultContext},this.aliases.length>0)for(i=this.aliases.length,e=0;e<i;e++)t.aliases.push({pattern:this.aliases[e].pattern,value:this.aliases[e].value,priority:this.aliases[e].priority,regexp:this.aliases[e].regexp,style:this.aliases[e].style,multi:this.aliases[e].multi,append:this.aliases[e].append,name:this.aliases[e].name,group:this.aliases[e].group,enabled:this.aliases[e].enabled,params:this.aliases[e].params,display:this.aliases[e].display,notes:this.aliases[e].notes||""});if(this.triggers.length>0)for(i=this.triggers.length,e=0;e<i;e++){let o={pattern:this.triggers[e].pattern,value:this.triggers[e].value,priority:this.triggers[e].priority,verbatim:this.triggers[e].verbatim,style:this.triggers[e].style,name:this.triggers[e].name,group:this.triggers[e].group,enabled:this.triggers[e].enabled,display:this.triggers[e].display,triggernewline:this.triggers[e].triggerNewline,caseSensitive:this.triggers[e].caseSensitive,triggerprompt:this.triggers[e].triggerPrompt,raw:this.triggers[e].raw,type:this.triggers[e].type,notes:this.triggers[e].notes||"",state:this.triggers[e].state||0,params:this.triggers[e].params||"",triggers:[]};if(this.triggers[e].triggers&&this.triggers[e].triggers.length){let r=this.triggers[e].triggers.length;for(let a=0;a<r;a++)o.triggers.push({pattern:this.triggers[e].triggers[a].pattern,value:this.triggers[e].triggers[a].value,priority:this.triggers[e].triggers[a].priority,verbatim:this.triggers[e].triggers[a].verbatim,style:this.triggers[e].triggers[a].style,name:this.triggers[e].triggers[a].name,group:this.triggers[e].triggers[a].group,enabled:this.triggers[e].triggers[a].enabled,display:this.triggers[e].triggers[a].display,triggernewline:this.triggers[e].triggers[a].triggerNewline,caseSensitive:this.triggers[e].triggers[a].caseSensitive,triggerprompt:this.triggers[e].triggers[a].triggerPrompt,raw:this.triggers[e].triggers[a].raw,type:this.triggers[e].triggers[a].type,notes:this.triggers[e].triggers[a].notes||"",state:this.triggers[e].triggers[a].state||0,params:this.triggers[e].triggers[a].params||"",triggers:[]})}t.triggers.push(o)}if(this.macros.length>0)for(i=this.macros.length,e=0;e<i;e++)t.macros.push({key:this.macros[e].key,value:this.macros[e].value,style:this.macros[e].style,append:this.macros[e].append,send:this.macros[e].send,name:this.macros[e].name,group:this.macros[e].group,enabled:this.macros[e].enabled,display:'if(item.key === 0) return "None"; return keyCodeToChar[item.key]',displaytype:1,modifiers:this.macros[e].modifiers,chain:this.macros[e].chain,notes:this.macros[e].notes||""});if(this.buttons.length>0)for(i=this.buttons.length,e=0;e<i;e++)t.buttons.push(ve(this.buttons[e],(o,r)=>{if(o!=="profile")return r}));if(this.contexts.length>0)for(i=this.contexts.length,e=0;e<i;e++)t.contexts.push(ve(this.contexts[e],(o,r)=>{if(o!=="profile")return r}));return t}t=ve(this,(o,r)=>{if(o!=="profile")return r});let n=new m(!1),s;for(s in t)t.hasOwnProperty(s)&&(s==="aliases"||s==="triggers"||s==="macros"||s==="buttons"||s==="contexts"||s==="variables"||(n[s]=t[s]));if(t.aliases&&t.aliases.length>0)for(i=t.aliases.length,e=0;e<i;e++)n.aliases.push(new Ne(t.aliases[e],null,n));if(t.triggers&&t.triggers.length>0)for(i=t.triggers.length,e=0;e<i;e++)n.triggers.push(new ue(t.triggers[e],n));if(t.macros&&t.macros.length>0)for(i=t.macros.length,n.macros=[],e=0;e<i;e++)n.macros.push(new He(t.macros[e],n));if(t.buttons&&t.buttons.length>0)for(i=t.buttons.length,e=0;e<i;e++)n.buttons.push(new J(t.buttons[e],n));if(t.contexts&&t.contexts.length>0)for(i=t.contexts.length,e=0;e<i;e++)n.contexts.push(new et(t.contexts[e],n));return n}find(c,t,e){let i;if(!c||c.length===0||!this[c]||this[c].length===0)return null;i=H(this[c]);let n=i.length;for(let s=0;s<n;s++)if(i[s][t]===e)return i[s];return null}findAny(c,t,e){let i;if(!c||c.length===0||!this[c]||this[c].length===0)return null;i=H(this[c]);let n=i.length;if(typeof t=="object"){for(let s=0;s<n;s++)for(let o in t)if(t.hasOwnProperty(o)&&i[s][o]===t[o])return i[s];return-1}for(let s=0;s<n;s++)if(i[s][t]===e)return i[s];return null}indexOfAny(c,t,e){let i;if(!c||c.length===0||!this[c]||this[c].length===0)return null;i=H(this[c]);let n=i.length;if(typeof t=="object"){for(let s=0;s<n;s++)for(let o in t)if(t.hasOwnProperty(o)&&i[s][o]===t[o])return this[c].indexOf(i[s]);return-1}for(let s=0;s<n;s++)if(i[s][t]===e)return this[c].indexOf(i[s]);return-1}indexOf(c,t,e){let i;if(!c||c.length===0||!this[c]||this[c].length===0)return null;i=H(this[c]);let n=i.length;if(typeof t=="object"){for(let s=0;s<n;s++){for(let o in t)t.hasOwnProperty(o)&&(i[s][o],t[o]);return this[c].indexOf(i[s])}return-1}for(let s=0;s<n;s++)if(i[s][t]===e)return this[c].indexOf(i[s]);return-1}},it=class m{constructor(c){this.items={};this.keys=[];this.add(c??pe.Default)}SortByPriority(){this.keys.sort((c,t)=>{let e=this.items[c].priority,i=this.items[t].priority;return e>i?-1:e<i?1:c==="default"?-1:t==="default"||(e=this.items[c].name,i=this.items[t].name,e>i)?1:e<i?-1:0})}enabled(c){return!c||this.keys.length===0?!1:typeof c=="string"?this.items[c.toLowerCase()]?this.items[c.toLowerCase()].enabled:!1:this.items[c.name.toLowerCase()]?this.items[c.name.toLowerCase()].enabled:!1}contains(c){return!c||this.keys.length===0?!1:typeof c=="string"?!!this.items[c.toLowerCase()]:!!this.items[c.name.toLowerCase()]}canDisable(c){if(!c||this.keys.length===0)return!1;let t;if(typeof c=="number"){if(c<0||c>=this.keys.length)return!1;t=this.keys[c]}else if(typeof c=="object")t=c.name.toLowerCase();else if(typeof c=="string")t=c.toLowerCase();else return!1;if(!this.items[t])return!1;if(!!this.items[t].enabled){let i=!1;for(let n in this.items)if(n!==t){this.items[n].enabled&&(i=!0);break}if(!i)return!1}return!0}toggle(c){if(!c||this.keys.length===0)return!1;let t;if(typeof c=="number"){if(c<0||c>=this.keys.length)return!1;t=this.keys[c]}else if(typeof c=="object")t=c.name.toLowerCase();else if(typeof c=="string")t=c.toLowerCase();else return!1;if(!this.items[t])return!1;let e=!this.items[t].enabled;if(!e){let i=!1;for(let n in this.items)if(n!==t){this.items[n].enabled&&(i=!0);break}if(!i)return!1}return this.items[t].enabled=e,!0}update(){this.keys=Object.keys(this.items),this.SortByPriority()}add(c){c&&(this.items[c.name.toLowerCase()]=c,this.update())}remove(c){if(!(!c||this.keys.length===0)){if(typeof c=="string")delete this.items[c.toLowerCase()];else if(typeof c=="number"){if(c<0||c>=this.keys.length)return;delete this.items[this.keys[c]]}else delete this.items[c.name.toLowerCase()];this.update()}}copy(c){return c?this.keys.length===0?null:typeof c=="string"?this.items[c.toLowerCase()]?this.items[c.toLowerCase()].clone():null:typeof c=="number"?c<0||c>=this.keys.length?null:this.items[this.keys[c]].clone():c.clone():ve(this.items)}clone(c){if(c===2){let e={};for(let i in this.items)e[this.items[i].name.toLowerCase()]=this.items[i].clone(2);return e}let t=new m;for(let e in this.items)t.items[this.items[e].name.toLowerCase()]=this.items[e].clone();return t.update(),t}static load(c){return new Promise((t,e)=>{let i=new m;localforage.getItem(c||"OoMUDProfiles").then(n=>{if(typeof n=="string"&&(n=JSON.parse(n)),!n)i.add(pe.Default);else{let s=Object.keys(n),o=0,r=s.length;for(;o<r;o++)i.add(pe.load(n[s[o]]))}t(i)}).catch(e)})}save(c){return localforage.setItem(c||"OoMUDProfiles",JSON.stringify(this.items,(t,e)=>{if(t!=="profile")return e}))}get length(){return this.keys.length}count(){return this.keys.length}get active(){let c=this.keys;if(c.length===0)return this.add(pe.Default),this.items.default;if(c.length===1)return this.items[c[0]].enabled?this.items[c[0]]:this.items[c[0]].name==="Default"?(this.items[c[0]].enable=!0,this.items.default):(this.add(pe.Default),this.items.default);for(let t in c)if(this.items[t].enabled)return this.items[t];return this.items.default?(this.items.default.enabled=!0,this.items.default):(this.add(pe.Default),this.items.default)}get aliases(){let c=this.keys,t=[],e=0,i=c.length;if(i===0)return[];if(i===1)return!this.items[c[0]].enabled||!this.items[c[0]].enableAliases?[]:this.items[c[0]].aliases;for(;e<i;e++)!this.items[c[e]].enabled||!this.items[c[e]].enableAliases||this.items[c[e]].aliases.length===0||(t=t.concat(this.items[c[e]].aliases));return t}get triggers(){let c=this.keys,t=[],e=0,i=c.length;if(i===0)return[];if(i===1)return!this.items[c[0]].enabled||!this.items[c[0]].enableTriggers?[]:this.items[c[0]].triggers;for(;e<i;e++)!this.items[c[e]].enabled||!this.items[c[e]].enableTriggers||this.items[c[e]].triggers.length===0||(t=t.concat(this.items[c[e]].triggers));return t}get macros(){let c=this.keys,t=[],e=0,i=c.length;if(i===0)return[];if(i===1)return!this.items[c[0]].enabled||!this.items[c[0]].enableMacros?[]:this.items[c[0]].macros;for(;e<i;e++)!this.items[c[e]].enabled||!this.items[c[e]].enableMacros||this.items[c[e]].macros.length===0||(t=t.concat(this.items[c[e]].macros));return t}get buttons(){let c=this.keys,t=[],e=0,i=c.length;if(i===0)return[];if(i===1)return!this.items[c[0]].enabled||!this.items[c[0]].enableButtons?[]:this.items[c[0]].buttons;for(;e<i;e++)!this.items[c[e]].enabled||!this.items[c[e]].enableButtons||this.items[c[e]].buttons.length===0||(t=t.concat(this.items[c[e]].buttons));return t}get contexts(){let c=this.keys,t=[],e=0,i=c.length;if(i===0)return[];if(i===1)return!this.items[c[0]].enabled||!this.items[c[0]].enableContexts?[]:this.items[c[0]].contexts;for(;e<i;e++)!this.items[c[e]].enabled||!this.items[c[e]].enableContexts||this.items[c[e]].contexts.length===0||(t=t.concat(this.items[c[e]].contexts));return t}get defaultContext(){let c=this.keys,t=0,e=c.length;if(e===0)return!0;if(e===1)return this.items[c[0]].enabled?this.items[c[0]].enableDefaultContext:!0;for(;t<e;t++)if(this.items[c[t]].enabled&&!this.items[c[t]].enableDefaultContext)return!1;return!0}};function De(m,c){if(!m||!m.length)return"";let t;(A=>(A[A.None=0]="None",A[A.Ampersand=1]="Ampersand",A[A.Percent=2]="Percent",A[A.StringMatch=3]="StringMatch",A[A.SubPattern=4]="SubPattern",A[A.AmpersandPercent=5]="AmpersandPercent",A[A.AmpersandPattern=6]="AmpersandPattern",A[A.AmpersandRange=7]="AmpersandRange",A[A.PercentRegex=8]="PercentRegex",A[A.Escape=9]="Escape",A[A.Variable=10]="Variable"))(t||={});let e=0,i=[],n=0,s=m.length,o,r,a,l,f=0;for(n=0;n<s;n++)switch(o=m.charAt(n),r=m.charCodeAt(n),e){case 1:if(a.length===0&&(o==="*"||o==="?"||o==="^"||o==="$"))l=o;else if(a.length===0&&o==="%")e=5;else if(l.length===0&&o==="(")l=o,e=6;else if(l.length===0&&o==="[")l=o,e=7;else{if(o==="{")continue;if(o==="}"||!(r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||r===95||r===36)){if(!ge(a))throw new Error("Invalid variable name");!l.length&&/^\d+$/.exec(a)?i.push("{",a,"}"):l.length?i.push("(?<",a,">",De(l),")"):i.push("(?<",a,">.*)"),o!=="}"&&n--,e=0}else a+=o}break;case 5:l+="%"+o,e=1;break;case 6:l+=o,o===")"&&(e=1);break;case 7:l+=o,o==="]"&&(e=1);break;case 2:switch(o){case"d":i.push("\\d+"),e=0;break;case"n":i.push("[+-]?\\d+"),e=0;break;case"w":i.push("\\w"),e=0;break;case"a":i.push("[a-zA-Z0-9]*"),e=0;break;case"s":i.push("\\s*"),e=0;break;case"x":i.push("\\S*"),e=0;break;case"y":i.push("\\S*"),e=0;break;case"p":i.push(`[\\.\\?\\!\\:\\;\\-\\\u2014\\(\\)\\[\\]\\'\\"\\\\/\\,]{1}`),e=0;break;case"q":i.push(`[\\.\\?\\!\\:\\;\\-\\\u2014\\(\\)\\[\\]\\'\\"\\\\/\\,]{1}`),e=0;break;case"t":e=0;break;case"e":i.push("\x1B"),e=0;break;case"/":e=8,a="";break}break;case 8:if(o==="%"){if(!a.endsWith("/"))throw new Error("Invalid %/regex/% pattern");i.push(a.substr(0,a.length-1))}else a+=o;break;case 3:o==="^"&&a.length===0?l=!0:o==="}"?(l?i.push("[^",a,"]"):i.push(a),e=0):a+=o;break;case 4:o===":"?(i.push("(?<",a,">"),e=0):o===")"?(i.push("(",De(a),")"),e=0,f--):a+=o;break;case 9:i.push("\\",o),e=0;break;case 10:if(o==="{"&&a.length===0)continue;if(o==="}"||!(r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||r===95||r===36)){if(!ge(a))throw new Error("Invalid variable name");c&&(c.variables[a]instanceof tt?i.push(c.variables[a].value||""):i.push(c.variables[a]||"")),o!=="}"&&n--,e=0}else a+=o;break;default:o==="*"?i.push(".*"):o==="?"?i.push("."):o==="~"?e=9:o==="@"?(e=10,a=""):o==="&"?(a="",l="",e=1):o==="%"?e=2:o==="{"?(e=3,a=""):o==="("?(e=4,a="",f++):(o===")"&&f--,i.push(o));break}switch(e){case 1:if(!ge(a))throw new Error("Invalid variable name");!l.length&&/^\d+$/.exec(a)?i.push("{",a,"}"):l.length?i.push("(?<",a,">",De(l),")"):i.push("(?<",a,">.*)");break;case 5:case 6:case 7:throw new Error("Invalid &VarName pattern");case 2:throw new Error("Invalid % pattern");case 8:throw new Error("Invalid %/regex/% pattern");case 3:throw new Error("Invalid string match pattern");case 4:throw new Error("Invalid (sub:pattern) pattern");case 9:throw new Error("Invalid escape pattern");case 10:if(!ge(a))throw new Error("Invalid variable name");c&&(c.variables[a]instanceof tt?i.push(c.variables[a].getValue()||""):i.push(c.variables[a]||""));break}if(f)throw new Error("Invalid save matched pattern");return i.join("")}var ze,ke,st=["$selectedword","$selword","$selectedurl","$selurl","$selectedline","$selline","$selected","$character","$copied","$action","$trigger","$caption","$characterid"];function nt(m){return m.replace(/\w*\S*/g,c=>c.charAt(0).toUpperCase()+c.substr(1).toLowerCase())}function Ut(){switch(~~(Math.random()*6)+1){case 1:case 4:return-1;case 3:case 2:return 1}return 0}var rt=class extends ie{constructor(t){super();this._historyIdx=-1;this._tabIdx=-1;this._tabWords=null;this._locked=0;this._TriggerCache=null;this._TriggerStates={};this._TriggerFunctionCache={};this._TriggerRegExCache={};this._LastTriggered="";this._LastTrigger=null;this._scrollLock=!1;this._gag=0;this._gagID=[];this._gags=[];this._stack=[];this._vStack=[];this._controllers={};this._controllersCount=0;this._gamepadCaches=null;this._lastSuspend=-1;this._MacroCache={};this._loops=[];this._pathQueue=[];this._pathTimeout=null;this._pathPaused=!1;this.client=null;this.enableParsing=!0;this.enableTriggers=!0;if(!t)throw new Error("Invalid client!");this.client=t,ze=()=>ke||(this.initMathJS(),ke),this._commandHistory=[],document.addEventListener("keydown",e=>{!this.isLocked&&this.ProcessMacros(e.which,e.altKey,e.ctrlKey,e.shiftKey,e.metaKey)?(e.preventDefault(),e.stopPropagation()):e.key==="ScrollLock"&&this.toggleScrollLock()}),this.client.on("parse-command",e=>{this.client.getOption("parseCommands")&&(e.value=this.parseOutgoing(e.value,null,null,null,null,!e.comments))}),this.client.on("add-line",e=>{if(this.ExecuteTriggers(140,e.line,e.raw,e.fragment,!1,!0),this._gag>0&&!e.fragment&&(e.gagged=!0,this._gag--),!e.fragment)for(let i in this._TriggerStates)this._TriggerStates[i].lineCount&&this._TriggerStates[i].lineCount--}),this.client.on("options-loaded",()=>{!ke&&this.client.getOption("initializeScriptEngineOnLoad")&&this.initMathJS(),this.initPads()}),this.client.commandInput.addEventListener("keyup",e=>{e.key!=="Escape"&&e.key!=="ArrowUp"&&e.key!=="ArrowDown"&&(this._historyIdx=this._commandHistory.length)}),this.client.commandInput.addEventListener("keydown",e=>{switch(e.key){case"Escape":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this.client.commandInput.blur(),this.client.commandInput.value="",this.client.commandInput.select(),this._historyIdx=this._commandHistory.length,this._tabIdx=-1,this._tabWords=null,this._tabSearch=null,this.emit("history-navigate",e);break;case"ArrowUp":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this._historyIdx===this._commandHistory.length&&this.client.commandInput.value.length>0&&(this.AddCommandToHistory(this.client.commandInput.value),this.client.commandInput.value===this._commandHistory[this._historyIdx-1]&&this._historyIdx--),this._historyIdx--,this._historyIdx<0&&(this._historyIdx=0),this._commandHistory.length<0?(this._historyIdx=-1,this.client.commandInput.value=""):this._commandHistory.length>0&&this._historyIdx<this._commandHistory.length&&this._historyIdx>=0&&(this.client.commandInput.value=this._commandHistory[this._historyIdx]),setTimeout(()=>this.client.commandInput.select(),0),this.emit("history-navigate",e);break;case"ArrowDown":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this._historyIdx===this._commandHistory.length&&this.client.commandInput.value.length>0&&this.AddCommandToHistory(this.client.commandInput.value),this._historyIdx++,this._historyIdx>=this._commandHistory.length||this._commandHistory.length<1?(this._historyIdx=this._commandHistory.length,this.client.commandInput.value=""):this._commandHistory.length>0&&this._historyIdx<this._commandHistory.length&&this._historyIdx>=0&&(this.client.commandInput.value=this._commandHistory[this._historyIdx]),setTimeout(()=>this.client.commandInput.select(),0),this.emit("history-navigate",e);break;case"Enter":switch(this.client.getOption("newlineShortcut")){case 1:if(e.ctrlKey&&!e.shiftKey&&!e.metaKey&&!e.altKey)return Ue(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 8:if(e.ctrlKey&&e.shiftKey&&!e.metaKey&&!e.altKey)return Ue(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 4:if((e.ctrlKey||e.shiftKey)&&!e.metaKey&&!e.altKey)return Ue(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 2:if(e.ctrlKey&&e.shiftKey&&!e.metaKey&&!e.altKey)return Ue(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break}!e.ctrlKey&&!e.shiftKey&&!e.metaKey&&!e.altKey&&(this._tabIdx=-1,this._tabWords=null,this._tabSearch=null,this.client.sendCommand(null,null,this.client.getOption("allowCommentsFromCommand")),this.emit("history-navigate",e)),e.preventDefault();break;case"Tab":if(!this.client.getOption("enableTabCompletion")||this.client.commandInput.value.length===0||e.altKey||e.ctrlKey||e.metaKey)return;e.shiftKey?this._tabIdx--:this._tabIdx++;let i=this.client.commandInput.selectionStart,n=this.client.commandInput.selectionEnd;if(this._tabWords===null){let o=Nt(this.client.commandInput),r=this.client.commandInput.value.indexOf(" ",o);r===-1&&(r=this.client.commandInput.value.indexOf(`
`,o));let a=this.client.commandInput.value.lastIndexOf(" ",o-1);a===-1&&(a=this.client.commandInput.value.indexOf(`
`,o-1)),r===-1&&(r=this.client.commandInput.value.length),a===-1?a=0:a++,i=a,n=r,i===n&&n++;let l=this.client.commandInput.value.substring(a,r);if(l.length===0)return;this._tabSearch={start:a,end:r,find:l.length};let f=new RegExp(`^${l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}`,this.client.getOption("ignoreCaseTabCompletion")?"i":"");this.client.getOption("tabCompletionLookupType")===8?this._tabWords=[...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(u=>u.match(f)))]:(this._tabWords=[].concat(...this.client.display.lines.slice(this.client.display.lines.length-this.client.getOption("tabCompletionBufferLimit")).map(u=>u.text.split(/\s+/))).filter(u=>u.match(f)).reverse(),this.client.getOption("tabCompletionLookupType")===1?this._tabWords=[...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(u=>u.match(f)).reverse())].concat(this._tabWords):this.client.getOption("tabCompletionLookupType")===2&&(this._tabWords=this._tabWords.concat([...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(u=>u.match(f)).reverse())])),this._tabWords=[...new Set(this._tabWords)])}else i-=this._tabSearch.find;if(this._tabWords.length===0)return;this._tabIdx<0&&(this._tabIdx=this._tabWords.length-1),this._tabIdx>=this._tabWords.length&&(this._tabIdx=0);let s=this.client.getOption("tabCompletionReplaceCasing");this.client.commandInput.value=this.client.commandInput.value.substring(0,i)+(s===1?this._tabWords[this._tabIdx].toLowerCase():s===2?this._tabWords[this._tabIdx].toUpperCase():this._tabWords[this._tabIdx])+this.client.commandInput.value.substring(n,this.client.commandInput.value.length),this.client.commandInput.selectionStart=this._tabSearch.start+this._tabSearch.find,this.client.commandInput.selectionEnd=this._tabSearch.start+this._tabWords[this._tabIdx].length,e.preventDefault(),this.emit("history-navigate",e);break;case"Shift":case"Control":case"Meta":case"Alt":case"CapsLock":case"Fn":case"NumLock":case"ScrollLock":case"Super":case"PageDown":case"PageUp":case"End":case"Home":case"ArrowLeft":case"ArrowRight":case"ContextMenu":break;default:this._tabIdx=-1,this._tabWords=null,this._tabSearch=null;break}}),this.client.commandInput.addEventListener("mouseup",e=>{this._tabIdx=-1,this._tabWords=null,this._tabSearch=null}),window.addEventListener("gamepadconnected",e=>{this.client.getOption("gamepads")&&(this._gamepadCaches||(this._gamepadCaches=[]),this._controllers[e.gamepad.index]={pad:e.gamepad,axes:ve(e.gamepad.axes),state:{axes:[],buttons:[]},pState:{axes:[],buttons:[]}},this._controllersCount++,this.updatePads())}),window.addEventListener("gamepaddisconnected",e=>{this.client.getOption("gamepads")&&(delete this._controllers[e.gamepad.index],this._controllersCount--)}),this.initPads()}getScope(){let t={};if(Object.assign(t,this.client.variables),st.forEach(e=>{t[e]=window[e],t[e.substr(1)]=window[e]}),this._stack.length===0||!this.stack.named&&!this.loops.length)return t;if(this.stack.named&&Object.assign(t,this.stack.named),this.loops.length){t.repeatnum=this.repeatnum;let e=this.loops.length;for(let i=0;i<e&&i<18;i++)t[String.fromCharCode(105+i)]=this.loops[i]}return t}setScope(t){if(t===this.client.variables)return;let e=this.loops.length;for(let i in t)if(!(!Object.prototype.hasOwnProperty.call(t,i)||i==="i"||i==="repeatnum")&&!(st.indexOf(i)!==-1||st.indexOf("$"+i)!==-1)){switch(i){case"clientid":continue}i.length===1&&e&&i.charCodeAt(0)>=105&&i.charCodeAt(0)<105+e||this.stack.named&&Object.prototype.hasOwnProperty.call(this.stack.named,i)||(this.client.variables[i]=t[i])}}evaluate(t){let e=this.getScope(),i=ze().evaluate(t,e);return this.setScope(e),i}get stack(){return this._stack.length===0&&this._stack.push({args:0,named:0,used:0,append:!1}),this._stack[this._stack.length-1]}get repeatnum(){return this.loops.length===0?0:this.loops[this.loops.length-1]}get loops(){return this._stack.length===0||!this.stack.hasOwnProperty("loops")?this._loops:this.stack.loops}get regex(){let t=this._stack.length;if(t===0)return null;for(;t>=0;)if(t--,this._stack[t].hasOwnProperty("regex"))return this._stack[t].regex;return null}get indices(){let t=this._stack.length;if(t===0)return[];for(;t>=0;)if(t--,this._stack[t].hasOwnProperty("indices"))return this._stack[t].indices;return[]}get vStack(){return this._vStack.length===0?{}:this._vStack[this._vStack.length-1]}vStackPush(t){this._vStack.push(t)}vStackPop(){this._vStack.pop()}get scrollLock(){return this._scrollLock}set scrollLock(t){t!==this._scrollLock&&(this._scrollLock=t,this.emit("scroll-lock",this.scrollLock))}get lastTriggerExecuted(){return this._LastTrigger}get lastTriggered(){return this._LastTriggered}set lastTriggered(t){this._LastTriggered=t}getDiceArguments(t,e,i){let n=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString());if(!n||n.length<3)if(n=/(\d+)\s*?d\s*?\/\s*?(100)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!n||n.length<3){if(t=t.compile().evaluate(e),n=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!n||n.length<3){if(n=/(\d+)\s*?d\s*?\/\s*?(100)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!n||n.length<3)throw new Error("Invalid dice for "+(i||"dice"));n[2]="%"}}else n[2]="%";return n}initMathJS(){ke=math;let t={esc:"\x1B",cr:`
`,lf:"\r",crlf:`\r
`,diceavg:(e,i,n)=>{let s,o,r,a,l,f;if(e.length===0)throw new Error("Invalid arguments for diceavg");if(e.length===1)s=this.getDiceArguments(e[0],n,"diceavg"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length<4)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Too many arguments for diceavg");return l=1,r==="F"||r==="f"?(l=-1,f=1):r==="%"?(f=1,l=0):f=parseInt(r),a?i.evaluate((l+f)/2*o+a,n):(l+f)/2*o},dicemin:(e,i,n)=>{let s,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for dicemin");if(e.length===1)s=s=this.getDiceArguments(e[0],n,"dicemin"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length<4)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Too many arguments for dicemin");return l=1,r==="F"||r==="f"?l=-1:r==="%"&&(l=0),a?i.evaluate(l*o+a,n):l*o},dicemax:(e,i,n)=>{let s,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for dicemax");if(e.length===1)s=this.getDiceArguments(e[0],n,"dicemax"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length<4)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Too many arguments for dicemax");return r==="F"||r==="f"||r==="%"?l=1:l=parseInt(r),a?i.evaluate(l*o+a,n):l*o},dicedev:(e,i,n)=>{let s,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for dicedev");if(e.length===1)s=this.getDiceArguments(e[0],n,"dicedev"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length<4)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Too many arguments for dicedev");return r==="F"||r==="f"?l=6:r==="%"?l=1:l=parseInt(r),a?i.evaluate(Math.sqrt((l*l-1)/12*o)+a,n):Math.sqrt((l*l-1)/12*o)},zdicedev:(e,i,n)=>{let s,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for zdicedev");if(e.length===1)s=this.getDiceArguments(e[0],n,"zdicedev"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length<4)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Too many arguments for zdicedev");return r==="F"||r==="f"?l=6:r==="%"?l=1:l=parseInt(r),l--,a?i.evaluate(Math.sqrt((l*l-1)/12*o)+a,n):Math.sqrt((l*l-1)/12*o)},dice:(e,i,n)=>{let s,o,r,a;if(e.length===1)s=this.getDiceArguments(e[0],n,"dice"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length>1)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Invalid arguments for dice");let l=0;for(let f=0;f<o;f++)r==="F"||r==="f"?l+=Ut():r==="%"?l+=~~(Math.random()*100)+1:l+=~~(Math.random()*r)+1;return r==="%"&&(l/=100),a?i.evaluate(l+a,n):l},isdefined:(e,i,n)=>{if(e.length===1)return e[0]=this.stripQuotes(e[0].toString()),this.client.variables.hasOwnProperty(e[0])||n.has(e[0])?1:0;throw new Error("Invalid arguments for isdefined")},defined:(e,i,n)=>{let s;if(e.length===0)throw new Error("Missing arguments for defined");if(e.length===1){e[0]=this.stripQuotes(e[0],!0);let o=this.client.profiles.keys,r=0,a=o.length;if(a===0)return 0;for(;r<a;r++)if(s=H(this.client.profiles.items[o[r]].aliases),s=s.find(l=>l.pattern===e[0]),s||(s=H(this.client.profiles.items[o[r]].triggers),s=s.find(l=>l.pattern===e[0]||l.name===e[0]),s)||(s=H(this.client.profiles.items[o[r]].macros),s=s.find(l=>Ge(l).toLowerCase()===e[0].toLowerCase()||l.name===e[0]),s)||(s=H(this.client.profiles.items[o[r]].aliases),s=s.find(l=>l.caption===e[0]||l.name===e[0]),s))return 1;return this.client.variables.hasOwnProperty(e[0])}else if(e.length===2){e[0]=this.stripQuotes(e[0].toString()),e[0]=this.stripQuotes(e[1].toString());let o=this.client.profiles.keys,r=0,a=o.length;if(a===0)return 0;for(;r<a;r++)switch(e[1]){case"alias":return s=H(this.client.profiles.items[o[r]].aliases),s=s.find(l=>l.pattern===e[0]),s?1:0;case"event":return s=H(this.client.profiles.items[o[r]].triggers),s=s.find(l=>l.type===2&&(l.pattern===e[0]||l.name===e[0])),s?1:0;case"trigger":return s=H(this.client.profiles.items[o[r]].triggers),s=s.find(l=>l.pattern===e[0]||l.name===e[0]),s?1:0;case"macro":return s=H(this.client.profiles.items[o[r]].macros),s=s.find(l=>Ge(l).toLowerCase()===e[0].toLowerCase()||l.name===e[0]),s?1:0;case"button":return s=H(this.client.profiles.items[o[r]].aliases),s=s.find(l=>l.caption===e[0]||l.name===e[0]),s?1:0}if(e[1]==="variable")return this.client.variables.hasOwnProperty(e[0])||n.has(e[0])}else throw new Error("Too many arguments for defined");return 0},time:(e,i,n)=>{if(e.length>1)throw new Error("Too many arguments for time");return moment?e.length?moment().format(e[0].compile().evaluate(n)):moment().format():new Date().toISOString()},clip:(e,i,n)=>{if(e.length>1)throw new Error("Too many arguments for clip");if(e.length){this.client.writeClipboard(e[0].compile().evaluate(n));return}return this.client.readClipboard()},if:(e,i,n)=>{if(e.length<3)throw new Error("Missing arguments for if");if(e.length!==3)throw new Error("Too many arguments for if");return e[0].compile().evaluate(n)?e[1].compile().evaluate(n):e[2].compile().evaluate(n)},len:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for len");if(e.length!==1)throw new Error("Too many arguments for len");return e[0].compile().evaluate(n).toString().length},stripansi:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for len");if(e.length!==1)throw new Error("Too many arguments for len");let s=new RegExp("[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))","g");return e[0].compile().evaluate(n).toString().replace(s,"")},ansi:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for ansi");e=e.map(f=>we(f.toString())===-1&&f.toString()!=="current"?f.compile().evaluate(n).toString():f.toString());let s=e.length,o=[],r={},a,l;for(a=0;a<s;a++)if(e[a].trim()==="current")o.push(e[a].trim());else{if(l=we(e[a].trim()),l===-1)throw new Error("Invalid color or style for ansi");l>=0&&l<30?r[l]=1:o.push(e[a])}if(o.length>2)throw new Error("Too many colors for ansi");if(o.length>1&&(o[1]==="current"?o[1]="":o[1]=we(o[1],!0)),o.length>0&&(r[1]&&o[0]==="white"||o[0]==="current"?o[0]="":o[0]=we(o[0])),r=[...Object.keys(r),...o],!r.length)throw new Error("Invalid colors or styles for ansi");return r=r.filter(f=>f!==""),`\x1B[${r.join(";")}m`},color:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for color");e=e.map(r=>we(r.toString())===-1&&r.toString()!=="current"?r.compile().evaluate(n).toString():r.toString());let s,o;if(e.length===1){if(e[0]==="bold")return"370";if(s=Y(e[0]),s===-1)throw new Error("Invalid fore color");return s.toString()}else if(e.length===2){if(e[0]==="bold")s=370;else{if(s=Y(e[0]),s===-1)throw new Error("Invalid fore color");if(e[1]==="bold")return(s*10).toString()}if(o=s.toString(),s=Y(e[1],!0),s===-1)throw new Error("Invalid back color");return o+","+s.toString()}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[2]!=="bold")throw new Error("Only bold is supported as third argument for color");if(s=Y(e[0]),s===-1)throw new Error("Invalid fore color");if(o=(s*10).toString(),s=Y(e[1],!0),s===-1)throw new Error("Invalid back color");return o+","+s.toString()}throw new Error("Too many arguments")},zcolor:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for zcolor");if(e.length>1)throw new Error("Too many arguments for zcolor");return xt(parseInt(e[0].compile().evaluate(n),10))},case:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for case");let s=e[0].compile().evaluate(n);return s>0&&s<e.length?e[s].compile().evaluate(n):null},switch:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for switch");if(e.length%2===1)throw new Error("All expressions must have a value for switch");let s=e.length;for(let o=0;o<s;o+=2)if(e[o].compile().evaluate(n))return e[o+1].compile().evaluate(n);return null},ascii:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for ascii");if(e.length>1)throw new Error("Too many arguments for ascii");if(e[0].toString().trim().length===0)throw new Error("Invalid argument, empty string for ascii");return e[0].toString().trim().charCodeAt(0)},char:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for char");if(e.length>1)throw new Error("Too many arguments for char");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for char");return String.fromCharCode(s)},bitand:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitand");if(e.length!==2)throw new Error("Too many arguments for bitand");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitand");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitand");return s&o},bitnot:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitnot");if(e.length!==1)throw new Error("Too many arguments for bitnot");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitnot");return~s},bitor:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitor");if(e.length!==2)throw new Error("Too many arguments for bitor");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitor");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitor");return s|o},bitset:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitset");if(e.length>3)throw new Error("Too many arguments for bitset");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitset");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitset");o--;let r=1;if(e.length===3&&(r=e[2].compile().evaluate(n),isNaN(r)))throw new Error("Invalid argument '"+e[2].toString()+"' must be a number for bitset");return s&~(1<<o)|(r?1:0)<<o},bitshift:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitshift");if(e.length!==2)throw new Error("Too many arguments for bitshift");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitshift");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitshift");return o<0?s>>-o:s<<o},bittest:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bittest");if(e.length!==2)throw new Error("Too many arguments for bittest");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bittest");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bittest");return o--,(s>>o)%2!=0?1:0},bitxor:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitxor");if(e.length!==2)throw new Error("Too many arguments for bitxor");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitxor");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitxor");return s^o},tonumber:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for number");if(e.length>1)throw new Error("Too many arguments for number");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)?parseInt(e[0],10):e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(e[0]):e[0]==="true"?1:(e[0]==="false",0)},isfloat:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for isfloat");if(e.length>1)throw new Error("Too many arguments for isfloat");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0},isnumber:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for isnumber");if(e.length>1)throw new Error("Too many arguments for isnumber");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)||e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0},tostring:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for string");if(e.length>1)throw new Error("Too many arguments for string");return e[0].compile().evaluate(n).toString()},float:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for float");if(e.length>1)throw new Error("Too many arguments for float");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)||e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(e[0]):e[0]==="true"?1:(e[0]==="false",0)},trim:(e,i,n)=>{if(e.length!==1)throw new Error("Missing arguments for trim");return e[0].compile().evaluate(n).toString().trim()},trimleft:(e,i,n)=>{if(e.length!==1)throw new Error("Missing arguments for trimleft");return e[0].compile().evaluate(n).toString().trimLeft()},trimright:(e,i,n)=>{if(e.length!==1)throw new Error("Missing arguments for trimright");return e[0].compile().evaluate(n).toString().trimRight()},pos:(e,i,n)=>{if(e.length<2)throw new Error("Missing arguments for pos");if(e.length>2)throw new Error("Too many arguments for pos");return e[0]=e[0].compile().evaluate(n).toString(),e[1]=e[1].compile().evaluate(n).toString(),e[1].indexOf(e[0])+1},ipos:(e,i,n)=>{if(e.length<2)throw new Error("Missing arguments for pos");if(e.length>2)throw new Error("Too many arguments for pos");return e[0]=e[0].compile().evaluate(n).toString().toLowerCase(),e[1]=e[1].compile().evaluate(n).toString().toLowerCase(),e[1].indexOf(e[0])+1},ends:(e,i,n)=>{if(e.length<2)throw new Error("Missing arguments for ends");if(e.length>2)throw new Error("Too many arguments for ends");return e[0]=e[0].compile().evaluate(n).toString().toLowerCase(),e[1]=e[1].compile().evaluate(n).toString().toLowerCase(),e[0].endsWith(e[1])},begins:(e,i,n)=>{if(e.length<2)throw new Error("Missing arguments for begins");if(e.length>2)throw new Error("Too many arguments for begins");return e[0]=e[0].compile().evaluate(n).toString().toLowerCase(),e[1]=e[1].compile().evaluate(n).toString().toLowerCase(),e[0].startsWith(e[1])},alarm:(e,i,n)=>{let s,o,r,a,l;switch(e.length){case 0:throw new Error("Missing arguments for alarm");case 1:if(e[0]=e[0].compile().evaluate(n).toString(),s=this.client.alarms,r=s.length,r===0)throw new Error("No alarms set.");for(o=0;o<r;o++)if(s[o].type===3&&(s[o].name===e[0]||s[o].pattern===e[0]))return s[o].suspended?0:this.client.getRemainingAlarmTime(o);return;case 2:if(a=e[1].compile().evaluate(n),e[0]=e[0].compile().evaluate(n).toString(),s=this.client.alarms,r=s.length,r===0)throw new Error("No alarms set.");if(o=0,typeof a=="string"){for(;o<r;o++)if(s[o].type===3&&(s[o].name===e[0]||s[o].pattern===e[0])){if(s[o].profile.name.toUpperCase()!==a.toUpperCase())continue;return s[o].suspended?0:this.client.getRemainingAlarmTime(o)}throw new Error("Alarm not found in profile: "+a+".")}else{for(;o<r;o++)if(s[o].type===3&&(s[o].name===e[0]||s[o].pattern===e[0]))return s[o].suspended||this.client.setAlarmTempTime(o,a),a;throw new Error("Alarm not found.")}case 3:if(a=e[1].compile().evaluate(n),e[0]=e[0].compile().evaluate(n).toString(),l=e[2].compile().evaluate(n).toString(),s=this.client.alarms,r=s.length,r===0)throw new Error("No alarms set.");for(o=0;o<r;o++)if(s[o].type===3&&(s[o].name===e[0]||s[o].pattern===e[0])){if(s[o].profile.name.toUpperCase()!==l.toUpperCase())continue;return s[o].suspended||this.client.setAlarmTempTime(o,a),a}throw Error("Could not set time, alarm not found in profile: "+e[2]+".")}throw new Error("Too many arguments for alarm")},state:(e,i,n)=>{let s;if(e.length===0)throw new Error("Missing arguments for state");if(e.length>2)throw new Error("Too many arguments for state");if(e[0]=e[0].compile().evaluate(n).toString(),e.length===1){let o=this.client.profiles.keys,r=0,a=o.length;if(a===0)return null;if(a===1){if(!this.client.profiles.items[o[0]].enabled||!this.client.profiles.items[o[0]].enableTriggers)throw Error("No enabled profiles found!");s=H(this.client.profiles.items[o[r]].triggers),s=s.find(l=>l.name===e[0]||l.pattern===e[0])}else for(;r<a&&!(!(!this.client.profiles.items[o[r]].enabled||!this.client.profiles.items[o[r]].enableTriggers||this.client.profiles.items[o[r]].triggers.length===0)&&(s=H(this.client.profiles.items[o[r]].triggers),s=s.find(l=>l.name===e[0]||l.pattern===e[0]),s));r++);}else if(e.length===2){e[1]=e[1].compile().evaluate(n);let o;if(this.client.profiles.contains(e[1]))o=this.client.profiles.items[e[1].toLowerCase()];else throw new Error("Profile not found: "+e[1]);s=H(o.triggers),s=s.find(r=>r.name===e[0]||r.pattern===e[0])}if(s)return s.triggers&&s.triggers.length?s.state:0;throw new Error("Trigger not found")},isnull:(e,i,n)=>{if(e.length===0)return null;if(e.length!==1)throw new Error("Too many arguments for null");return e[0].compile().evaluate(n)?1:0},escape:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for unescape");if(e.length!==1)throw new Error("Too many arguments for unescape");let s;if(e[0]=e[0].compile().evaluate(n).toString(),this.client.getOption("allowEscape")){let o=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";return s=o,o==="\\"&&(s+=o),this.client.getOption("parseDoubleQuotes")&&(s+='"'),this.client.getOption("parseSingleQuotes")&&(s+="'"),this.client.getOption("commandStacking")&&(s+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(s+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(s+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(s+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(s+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(s+=this.client.getOption("nParametersChar")),e.replace(new RegExp(`[${s}]`,"g"),o+"$&")}return e.replace(/[\\"']/g,"$&")},unescape:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for unescape");if(e.length!==1)throw new Error("Too many arguments for unescape");let s;if(e[0]=e[0].compile().evaluate(n).toString(),this.client.getOption("allowEscape")){let o=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";return s=o,o==="\\"&&(s+=o),this.client.getOption("parseDoubleQuotes")&&(s+='"'),this.client.getOption("parseSingleQuotes")&&(s+="'"),this.client.getOption("commandStacking")&&(s+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(s+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(s+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(s+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(s+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(s+=this.client.getOption("nParametersChar")),o==="\\"?e[0].replace(new RegExp(`\\\\[${s}]`,"g"),r=>r.substr(1)):e[0].replace(new RegExp(`${o}[${s}]`,"g"),r=>r.substr(1))}return e[0].replace(/\\[\\"']/g,o=>o.substr(1))},prompt:(e,i,n)=>{if(e.length>3)throw new Error("Too many arguments");return e.length===0?window.prompt():(e=e.map(s=>s.compile().evaluate(n).toString()),window.prompt(...e))}};for(let e in t)!t.hasOwnProperty(e)||typeof t[e]!="function"||(t[e].rawArgs=!0);ke.import(t,{})}resetExpressionEngine(){ke&&(ke=void 0)}async initPads(){if(!this.client||!this.client.options){setTimeout(this.initPads,5);return}if(this._controllers=[],this._controllersCount=0,this._gamepadCaches=null,!this.client.getOption("gamepads"))return;let t=navigator.getGamepads(),e=0,i=t.length;for(;e<i;e++)t[e]&&(this._controllers[t[e].index]={pad:t[e],axes:ve(t[e].axes),state:{axes:[],buttons:[]},pState:{axes:[],buttons:[]}},this._controllersCount++);this.updatePads()}updatePads(){if(this._controllersCount===0||!this.client.getOption("gamepads"))return;let t=navigator.getGamepads(),e=0,i=t.length;for(!this._gamepadCaches&&i>0&&(this._gamepadCaches=[]);e<i;e++){let n=t[e];if(!n||!this._controllers[n.index])continue;let s=this._controllers[n.index].state,o=this._controllers[n.index].axes,r=n.buttons.length,a,l;this._gamepadCaches[e]||(this._gamepadCaches[e]=Ie(this.client.macros,"gamepad",e+1)),l=this._gamepadCaches[e];let f=0,u=l.length;if(u===0)continue;for(a=0;a<r;a++){let E=n.buttons[a],S;if(typeof E=="object"?(S=E.pressed,E=E.value):S=E>=.5,s.buttons[a]){if(s.buttons[a].pressed!==S&&(s.buttons[a].pressed=S,!S)){for(;f<u;f++)if(l[f].enabled&&l[f].key===a+1&&this.ExecuteMacro(l[f])){(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()});return}}}else s.buttons[a]={pct:Math.round(E*100),pressed:S}}let b=n.axes.length,h=0;for(a=0;a<b;a++)if(s.axes[a]!==n.axes[a]&&n.axes[a]!==o[a]&&(s.axes[a]=n.axes[a]),s.axes[a]<-.75?h=-(a+1):s.axes[a]>.75&&(h=a+1),h!==0){for(;f<u;f++)if(l[f].enabled&&l[f].gamepadAxes===a+1&&this.ExecuteMacro(l[f])){(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()});return}}}(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()})}adjustLastLine(t,e){return!this.client.display.lines||this.client.display.lines.length===0?0:(e?t===this.client.display.lines.length?(t--,this.client.display.lines[t].text.length===0&&this.client.display.lines[t].raw.length&&t--):t===this.client.display.lines.length-1&&this.client.display.lines[t].text.length===0&&this.client.display.lines[t].raw.length&&t--:t===this.client.display.lines.length?(t--,this.client.display.lines[t].text.length===0&&t--):t===this.client.display.lines.length-1&&this.client.display.lines[t].text.length===0&&t--,t)}get isLocked(){return this._locked!==0}addLock(){this._locked++}removeLock(){this._locked--}AddCommandToHistory(t){(this._commandHistory.length<1||this._commandHistory[this._commandHistory.length-1]!==t)&&t.length>0&&(this._commandHistory.length>=this.client.getOption("commandHistorySize")&&this._commandHistory.shift(),this._commandHistory.push(t),this.emit("command-history-changed",this._commandHistory))}clearCommandHistory(){this._commandHistory=[],this._historyIdx=-1,this.emit("command-history-changed",this._commandHistory)}setHistoryIndex(t){t<0||this._commandHistory.length===0?this._historyIdx=-1:t>=this._commandHistory.length?this._historyIdx=this._commandHistory.length-1:this._historyIdx=t}get commandHistory(){return this._commandHistory}executeScript(t){if(t==null)return t;let e=0,i=0,n,s=t.length,o="",r=[],a="",l,f=0,u=this.client.getOption("parseDoubleQuotes"),b=this.client.getOption("parseSingleQuotes"),h=this.client.getOption("commandChar");for(;i<s;i++)switch(n=t.charAt(i),e){case 1:n===" "?(e=2,l+=n):(o+=n,l+=n);break;case 2:n==="{"?(e=7,a+=n):n==="("?(e=8,a+=n):n===" "?(r.push(a),a=""):(n==='"'&&u?e=3:n==="'"&&b&&(e=4),a+=n),l+=n;break;case 3:n==='"'&&(e=2),a+=n,l+=n;break;case 4:n==="'"&&(e=2),a+=n,l+=n;break;case 7:a+=n,n==="}"?f===0?e=2:f--:n==="{"&&f++,l+=n;break;case 8:a+=n,n===")"?f===0?e=2:f--:n==="("&&f++,l+=n;break;default:if(i===0&&n===h)e=1,o="",r=[],a="",l=n;else return t;break}return o.length>0?(a.endsWith(`
`)&&(a=a.substring(0,a.length-1)),a.length>0&&r.push(a),this.executeFunction(o,r,l,h)):t}executeFunction(t,e,i,n){let s,o=!1,r,a,l,f,u=null,b=null,h,E,S,p,g,T,P;switch(t.toLowerCase()){case"unaction":case"untrigger":case"unt":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),u=null,b=null,S=!0,e.length<1||e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"unt\x1B[0;-11;-12mrigger {pattern|name} \x1B[3mprofile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid name or pattern");if(e[0].match(/^\{.*\}$/g)?e[0]=this.parseInline(e[0].substr(1,e[0].length-2)):e[0]=this.parseInline(this.stripQuotes(e[0])),e.length===2&&(u=this.stripQuotes(e[2]),u=this.parseInline(u)),!u||u.length===0){let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");h=this.client.profiles.items[y[d]].findAny("triggers",{name:e[0],pattern:e[0]})}else for(;d<v;d++)if(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(h=this.client.profiles.items[y[d]].findAny("triggers",{name:e[0],pattern:e[0]}),h)){u=this.client.profiles.items[y[d]];break}if(!h)throw new Error("Trigger '"+e[0]+"' not found in '"+u.name+"'!");this.client.removeTrigger(h),this.client.echo("Trigger '"+e[0]+"' removed from '"+u.name+"'.",-7,-8,!0,!0)}else if(u=this.parseInline(u),this.client.profiles.contains(u)){if(u=this.client.profiles.items[u.toLowerCase()],h=u.findAny("triggers",{name:e[0],pattern:e[0]}),!h)throw new Error("Trigger '"+e[0]+"' not found in '"+u.name+"'!");this.client.removeTrigger(h),this.client.echo("Trigger '"+e[0]+"' removed from '"+u.name+"'.",-7,-8,!0,!0)}else throw new Error("Profile not found: "+u);return null;case"suspend":case"sus":switch((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length){case 0:return f=this.client.alarms,f.length===0?this.client.echo("No alarms defined.",-7,-8,!0,!0):(this.client.setAlarmState(0,!1),this._lastSuspend=0,this.client.echo("Last alarm suspended.",-7,-8,!0,!0)),null;case 1:r=this.parseInline(this.stripQuotes(e[0])),f=this.client.alarms,a=f.length;for(let y=f.length-1;y>=0;y--)if(f[y].name===r||f[y].pattern===r){this.client.setAlarmState(y,!1),this.client.echo("Alarm '"+r+"' suspended.",-7,-8,!0,!0),this._lastSuspend=y;break}return null;default:throw new Error("Invalid syntax use \x1B[4m"+n+"sus\x1B[0;-11;-12mpend id \x1B[3mprofile\x1B[0;-11;-12m or \x1B[4m"+n+"sus\x1B[0;-11;-12mpend")}case"resume":case"resu":switch((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length){case 0:return this._lastSuspend===-1||(this.client.setAlarmState(this._lastSuspend,!0),this.client.echo("Last alarm suspended resumed.",-7,-8,!0,!0),this._lastSuspend=-1),null;case 1:r=this.parseInline(this.stripQuotes(e[0])),f=this.client.alarms,a=f.length;for(let y=a-1;y>=0;y--)if(f[y].name===r||f[y].pattern===r){this.client.setAlarmState(y,!0),this.client.echo("Alarm '"+r+"' resumed.",-7,-8,!0,!0);break}return null;default:throw new Error("Invalid syntax use \x1B[4m"+n+"resu\x1B[0;-11;-12mme id \x1B[3mprofile\x1B[0;-11;-12m or \x1B[4m"+n+"resu\x1B[0;-11;-12mme")}case"action":case"ac":case"trigger":case"tr":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),h={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+n+"tr\x1B[0;-11;-12migger name {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or \x1B[4m"+n+"tr\x1B[0;-11;-12migger {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid trigger name or pattern");if(e[0].match(/^\{.*\}$/g))h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2));else{if(h.name=this.parseInline(this.stripQuotes(e.shift())),!h.name||h.name.length===0)throw new Error("Invalid trigger name");e[0].match(/^\{.*\}$/g)&&(h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid trigger option '${y.trim()}'`)}});else throw new Error("Invalid trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid trigger option '${y.trim()}'`)}});else throw new Error("Invalid trigger options");h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))}}return this.createTrigger(h.pattern,h.commands,h.profile,h.options,h.name),null;case"event":case"ev":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),u=null,S=!0,h={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+n+"ev\x1B[0;-11;-12ment name {commands} \x1B[3moptions profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid event name");if(h.name=this.parseInline(this.stripQuotes(e.shift())),!h.name||h.name.length===0)throw new Error("Invalid event name");if(e.length===0)throw new Error("Missing commands or options");if(e[0].match(/^\{[\s\S]*\}$/g))h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2);else throw new Error("Missing commands");if(e.length===1)if(e[0]=e[0].substr(1,e[0].length-2),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"temporary":case"temp":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid event priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid event priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid event option '${y.trim()}'`)}});else throw new Error("Invalid event options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"temporary":case"temp":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid event priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid event priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid event option '${y.trim()}'`)}});else throw new Error("Invalid event options");h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))}if(!h.profile||h.profile.length===0){let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");u=this.client.profiles.items[y[0]],f=H(this.client.profiles.items[y[d]].triggers.filter(W=>W.type===2)),p=f.find(W=>W.name===h.name||W.pattern===h.name)}else{for(;d<v;d++)if(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(f=H(this.client.profiles.items[y[d]].triggers.filter(W=>W.type===2)),p=f.find(W=>W.name===h.name||W.pattern===h.name),p)){u=this.client.profiles.items[y[d]];break}u||(u=this.client.activeProfile)}}else{if(this.client.profiles.contains(h.profile))u=this.client.profiles.items[h.profile.toLowerCase()];else throw new Error("Profile not found: "+h.profile);p=f.find(y=>y.name===h.name||y.pattern===h.name)}return p?this.client.echo("Event '"+p.name+"' updated.",-7,-8,!0,!0):(p=new ue,p.name=h.name,u.triggers.push(p),this.client.echo("Event '"+p.name+"' added.",-7,-8,!0,!0),h.new=!0),p.pattern=h.name,h.commands!==null&&(p.value=h.commands),p.type=2,h.options.prompt&&(p.triggerPrompt=!0),h.options.nocr&&(p.triggerNewline=!1),h.options.case&&(p.caseSensitive=!0),h.options.raw&&(p.raw=!0),h.options.verbatim&&(p.verbatim=!0),h.options.disable?p.enabled=!1:h.options.enable&&(p.enabled=!0),(h.options.temporary||h.options.temp)&&(p.temp=!0),p.priority=h.options.priority,this.client.saveProfiles(),S&&this.client.clearCache(),h.new?this.emit("item-added","trigger",u.name,p):this.emit("item-updated","trigger",u.name,u.triggers.indexOf(p),p),u=null,null;case"unevent":case"une":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"une\x1B[0;-11;-12mvent name or \x1B[4m"+n+"une\x1B[0;-11;-12mvent {name} \x1B[3mprofile\x1B[0;-11;-12m");if(S=!0,u=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"une\x1B[0;-11;-12mvent name or \x1B[4m"+n+"une\x1B[0;-11;-12mvent {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(u=this.parseInline(this.stripQuotes(e[1])).toLowerCase(),this.client.profiles.contains(u))u=this.client.profiles.items[u];else throw new Error("Profile not found: "+u);else u=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?s=this.parseInline(this.stripQuotes(e[0])):s=this.parseInline(e[0].substr(1,e[0].length-2))}else s=this.parseInline(e.join(" ")),u=this.client.activeProfile;return r=H(u.triggers.filter(y=>y.type===2)),s=this.stripQuotes(s),f=s,s=r.findIndex(y=>y.pattern===s||y.name===s),o=s!==-1,o?(this.client.echo("Event '"+(r[s].name||r[s].pattern)+"' removed.",-7,-8,!0,!0),S?this.client.removeTrigger(r[s]):(s=u.triggers.indexOf(r[s]),u.triggers.splice(s,1),this.client.saveProfiles(),this.emit("item-removed","trigger",u.name,s)),u=null):this.client.echo("Event '"+f+"' not found.",-7,-8,!0,!0),null;case"button":case"bu":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===1){if(s=this.parseInline(this.stripQuotes(e[0])),r=document.getElementById("user-buttons").children,/^\s*?\d+\s*?$/.exec(s)){if(s=parseInt(s,10),s<0||s>=r.length)throw new Error("Button index must be >= 0 and < "+r.length);r[s].click()}else if(r[s])r[s].click();else throw new Error(`Button '${s}' not found`);return null}if(u=null,S=!0,h={profile:null,name:null,caption:null,commands:null,icon:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+n+"bu\x1B[0;-11;-12mtton name|index or \x1B[4m"+n+"bu\x1B[0;-11;-12mtton name \x1B[3mcaption\x1B[0;-11;-12m {commands} \x1B[3m{icon} options profile\x1B[0;-11;-12m or \x1B[4m"+n+"by\x1B[0;-11;-12mutton \x1B[3mcaption\x1B[0;-11;-12m {commands} \x1B[3m{icon} {options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid button name, caption or commands");if(e[0].match(/^\{[\s\S]*\}$/g))h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2);else{if(h.name=this.parseInline(this.stripQuotes(e.shift())),!h.name||h.name.length===0)throw new Error("Invalid button name or caption");if(e[0].match(/^\{[\s\S]*\}$/g))h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2);else if(h.caption=this.stripQuotes(e.shift()),!e[0].match(/^\{[\s\S]*\}$/g))throw new Error("Missing commands")}if(e.length!==0){if(e[0].match(/^\{.*\}$/g)&&(h.icon=e.shift(),h.icon=h.icon.substr(1,h.icon.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nosend":case"chain":case"append":case"stretch":case"disable":case"enable":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid button priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid button priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid button option '${y.trim()}'`)}});else throw new Error("Invalid button options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nosend":case"chain":case"append":case"stretch":case"disable":case"enable":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid button priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid button priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid button option '${y.trim()}'`)}});else throw new Error("Invalid button options");h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))}}if(!h.profile||h.profile.length===0){let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");u=this.client.profiles.items[y[0]],h.name!==null?p=this.client.profiles.items[y[d]].find("buttons","name",h.name):p=this.client.profiles.items[y[d]].find("buttons","caption",h.caption)}else{for(;d<v;d++)if(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(h.name!==null?p=this.client.profiles.items[y[d]].find("buttons","name",h.name):p=this.client.profiles.items[y[d]].find("buttons","caption",h.caption),p)){u=this.client.profiles.items[y[d]];break}u||(u=this.client.activeProfile)}}else{if(this.client.profiles.contains(h.profile))u=this.client.profiles.items[h.profile.toLowerCase()];else throw new Error("Profile not found: "+h.profile);h.name!==null?p=u.find("buttons","name",h.name):p=u.find("buttons","caption",h.caption)}return p?this.client.echo("Button '"+(p.name||p.caption||"")+"' updated.",-7,-8,!0,!0):(p=new J,p.name=h.name||"",p.caption=h.caption||"",u.buttons.push(p),!h.name&&!h.caption?this.client.echo("Button added.",-7,-8,!0,!0):this.client.echo("Button '"+(p.name||p.caption||"")+"' added.",-7,-8,!0,!0),h.new=!0),h.caption!==null&&(p.caption=h.caption),h.commands!==null&&(p.value=h.commands),h.options.icon&&(p.icon=h.options.icon),h.options.nosend&&(p.send=!1),h.options.chain&&(p.chain=!0),h.options.append&&(p.append=!0),h.options.stretch&&(p.stretch=!0),h.options.disable?p.enabled=!1:h.options.enable&&(p.enabled=!0),p.priority=h.options.priority,this.client.saveProfiles(),S&&this.client.clearCache(),h.new?this.emit("item-added","button",u.name,p):this.emit("item-updated","button",u.name,u.buttons.indexOf(p),p),u=null,null;case"unbutton":case"unb":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"unb\x1B[0;-11;-12mtton name or \x1B[4m"+n+"unb\x1B[0;-11;-12mtton {name} \x1B[3mprofile\x1B[0;-11;-12m");if(S=!0,u=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"unb\x1B[0;-11;-12mtton name or \x1B[4m"+n+"unb\x1B[0;-11;-12mtton {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(u=this.parseInline(this.stripQuotes(e[1])),this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);else u=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?s=this.parseInline(this.stripQuotes(e[0])):s=this.parseInline(e[0].substr(1,e[0].length-2))}else s=this.parseInline(e.join(" ")),u=this.client.activeProfile;if(r=H(u.buttons),f=s,/^\s*?\d+\s*?$/.exec(s)){if(s=parseInt(s,10),s<0||s>=r.length)throw new Error("Button index must be >= 0 and < "+r.length);o=!0}else s=this.stripQuotes(s),s=r.findIndex(y=>y.name===s||y.caption===s),o=s!==-1;return o?(r[s].name.length===0&&r[s].caption.length===0?this.client.echo("Button '"+f+"' removed.",-7,-8,!0,!0):this.client.echo("Button '"+(r[s].name||r[s].caption)+"' removed.",-7,-8,!0,!0),s=u.buttons.indexOf(r[s]),u.buttons.splice(s,1),this.client.saveProfiles(),S&&this.client.clearCache(),this.emit("item-removed","button",u.name,s),u=null):this.client.echo("Button '"+f+"' not found.",-7,-8,!0,!0),null;case"alarm":case"ala":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),u=null,b=null,S=!0,s=!1,e.length<2||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+n+"ala\x1B[0;-11;-12mrm name {timepattern} {commands} \x1B[3mprofile\x1B[0;-11;-12m, \x1B[4m"+n+"ala\x1B[0;-11;-12mrm name {timepattern} \x1B[3mprofile\x1B[0;-11;-12m, or \x1B[4m"+n+"ala\x1B[0;-11;-12mrm {timepattern} {commands} \x1B[3mprofile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid name or timepattern");if(e[0].match(/^\{.*\}$/g)){if(e.length>3)throw new Error("Invalid syntax use \x1B[4m"+n+"ala\x1B[0;-11;-12mrm {timepattern} {commands} profile");if(e[0]=e[0].substr(1,e[0].length-2),e[0]=this.parseInline(e[0]),e[1].match(/^\{[\s\S]*\}$/g)&&(e[1]=e[1].substr(1,e[1].length-2)),e.length===3&&(u=this.stripQuotes(e[2]),u=this.parseInline(u)),!u||u.length===0)u=this.client.activeProfile;else if(this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);return p=new ue,p.pattern=e[0],p.value=e[1],p.type=3,u.triggers.push(p),this.client.saveProfiles(),S&&(this._lastSuspend=-1,this.client.updateAlarms()),this.client.echo("Alarm '"+p.pattern+"' added.",-7,-8,!0,!0),this.emit("item-added","trigger",u.name,p),u=null,null}if(b=this.stripQuotes(e[0]),!b||b.length===0)throw new Error("Invalid alarm name");b=this.parseInline(b);let G=e[1],A=null;if(G.match(/^\{.*\}$/g)&&(G=G.substr(1,G.length-2)),G=this.parseInline(G),e.length===3?e[2].match(/^\{[\s\S]*\}$/g)?A=e[2].substr(1,e[2].length-2):u=this.stripQuotes(e[2]):e.length===4&&(A=e[2],u=this.stripQuotes(e[3]),A.match(/^\{[\s\S]*\}$/g)&&(A=A.substr(1,A.length-2))),!u||u.length===0){let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");if(u=this.client.profiles.items[y[0]],p=u.find("triggers","name",b),!p&&!A)throw new Error("Alarm not found!");p?this.client.echo("Alarm '"+p.name+"' updated.",-7,-8,!0,!0):(p=new ue,p.name=b,u.triggers.push(p),this.client.echo("Alarm '"+p.name+"' added.",-7,-8,!0,!0),s=!0)}else{for(;d<v;d++)if(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(p=this.client.profiles.items[y[d]].find("triggers","name",b),p)){u=this.client.profiles.items[y[d]];break}if(!u&&!A)throw new Error("Alarm not found!");u||(u=this.client.activeProfile),p?this.client.echo("Alarm '"+p.name+"' updated.",-7,-8,!0,!0):(p=new ue,s=!0,p.name=b,u.triggers.push(p),this.client.echo("Alarm '"+p.name+"' added.",-7,-8,!0,!0))}}else{if(u=this.parseInline(u),this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);if(p=u.find("triggers","name",b),!p&&!A)throw new Error("Alarm not found!");p?this.client.echo("Alarm '"+p.name+"' updated.",-7,-8,!0,!0):(p=new ue,p.name=b,u.triggers.push(p),s=!0,this.client.echo("Alarm '"+p.name+"' added.",-7,-8,!0,!0))}return p.pattern=G,p.type=3,A&&(p.value=A),this.client.saveProfiles(),s?this.emit("item-added","trigger",u.name,p):this.emit("item-updated","trigger",u.name,u.triggers.indexOf(p),p),u=null,S&&(this._lastSuspend=-1,this.client.updateAlarms()),null;case"ungag":case"ung":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length>0)throw new Error("Invalid syntax use \x1B[4m"+n+"ung\x1B[0;-11;-12mag number or \x1B[4m"+n+"ung\x1B[0;-11;-12mag");return this._gagID.length&&(clearTimeout(this._gagID.pop()),this._gags.pop()),this._gag=0,null;case"gag":case"ga":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)return this._gags.length&&this._gags[this._gags.length-1]==this.client.display.lines.length&&(this._gag=0,this._gags.pop()),this._gags.push(this.client.display.lines.length),this._gagID.push(setTimeout(()=>{if(s=this.adjustLastLine(this._gags.pop()),this._gags.length){let y=this._gags.length;for(;y>=0;)y--,this._gags[y]>s&&this._gags[y]--}this.client.display.removeLine(s)},0)),this._gag=0,null;if(e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"ga\x1B[0;-11;-12mg number or \x1B[4m"+n+"ga\x1B[0;-11;-12mg");if(l=parseInt(e[0],10),isNaN(l))throw new Error("Invalid number '"+e[0]+"'");return this._gags.length&&this._gags[this._gags.length-1]==this.client.display.lines.length&&(this._gag=0,this._gags.pop()),this._gags.push(this.client.display.lines.length),l>=0?(this._gagID.push(setTimeout(()=>{if(s=this.adjustLastLine(this._gags.pop()),this._gags.length){let y=this._gags.length;for(;y>=0;)y--,this._gags[y]>s&&this._gags[y]--}this.client.display.removeLine(s),this._gag=l},0)),this._gag=0):(this._gagID.push(setTimeout(()=>{s=this.adjustLastLine(this._gags.pop()),l*=-1,l>this.client.display.lines.length&&(l=this.client.display.lines.length),this.client.display.removeLines(s-l,l),this._gag=0},0)),this._gag=0),null;case"wait":case"wa":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=e.filter(y=>y),e.length===0||e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"wa\x1B[0;-11;-12mit number");if(l=parseInt(this.parseInline(e[0]),10),isNaN(l))throw new Error("Invalid number '"+l+"' for wait");if(l<1)throw new Error("Must be greater then zero for wait");return l;case"showclient":case"showcl":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.show(),null;case"hideclient":case"hidecl":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.hide(),null;case"toggleclient":case"togglecl":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.toggle(),null;case"raiseevent":case"raise":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.getOption("parseDoubleQuotes")&&e.forEach(y=>y.replace(/^\"(.*)\"$/g,(d,v,W)=>v.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(y=>y.replace(/^\'(.*)\'$/g,(d,v,W)=>v.replace(/\\\'/g,"'"))),e.length===0)throw new Error("Invalid syntax use "+n+"\x1B[4mraise\x1B[0;-11;-12mevent name or "+n+"\x1B[4mraise\x1B[0;-11;-12mevent name arguments");return e.length===1?this.client.raise(e[0]):this.client.raise(e[0],e.slice(1)),null;case"window":case"win":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.getOption("parseDoubleQuotes")&&e.forEach(y=>y.replace(/^\"(.*)\"$/g,(d,v,W)=>v.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(y=>y.replace(/^\'(.*)\'$/g,(d,v,W)=>v.replace(/\\\'/g,"'"))),e.length===0||e.length>3)throw new Error("Invalid syntax use "+n+"\x1B[4mwin\x1B[0;-11;-12mdow name \x1B[3mclose\x1B[0;-11;-12m or "+n+"\x1B[4mwin\x1B[0;-11;-12mdow new \x1B[3mcharacter\x1B[0;-11;-12m");return e.length===3?this.client.emit("window",this.stripQuotes(this.parseInline(e[0])),this.stripQuotes(this.parseInline(e[1])),this.stripQuotes(this.parseInline(e.slice(2).join(" ")))):e.length===1?this.client.emit("window",this.stripQuotes(this.parseInline(e[0]))):this.client.emit("window",this.stripQuotes(this.parseInline(e[0])),this.stripQuotes(this.parseInline(e.slice(1).join(" ")))),null;case"raisedelayed":case"raisede":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"raisede\x1B[0;-11;-12mlayed milliseconds name or \x1B[4m"+n+"raisede\x1B[0;-11;-12mlayed milliseconds name arguments");if(l=parseInt(this.stripQuotes(this.parseInline(e[0])),10),isNaN(l))throw new Error("Invalid number '"+e[0]+"' for raisedelayed");if(l<1)throw new Error("Must be greater then zero for raisedelayed");return e.shift(),this.client.getOption("parseDoubleQuotes")&&e.forEach(y=>y.replace(/^\"(.*)\"$/g,(d,v,W)=>v.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(y=>y.replace(/^\'(.*)\'$/g,(d,v,W)=>v.replace(/\\\'/g,"'"))),e.length===1?this.client.raise(e[0],0,l):this.client.raise(e[0],e.slice(1),l),null;case"notify":case"not":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"not\x1B[0;-11;-12mify title \x1B[3mmessage icon\x1B[0;-11;-12m");if(e[0]=this.stripQuotes(e[0]),e[e.length-1].match(/^\{.*\}$/g)&&(h=e.pop(),s={icon:this.parseInline(h.substr(1,h.length-2))}),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"not\x1B[0;-11;-12mify title \x1B[3mmessage icon\x1B[0;-11;-12m");return e.length===1?this.client.notify(this.parseInline(this.stripQuotes(e[0])),null,s):this.client.notify(this.parseInline(this.stripQuotes(e[0])),this.parseInline(e.slice(1).join(" ")),s),null;case"idle":case"idletime":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.lastSendTime?this.client.echo("You have been idle: "+St(Date.now()-this.client.lastSendTime),-7,-8,!0,!0):this.client.echo("Not connected",-7,-8,!0,!0),null;case"connect":case"connecttime":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.connectTime?this.client.echo("You have been connected: "+St(Date.now()-this.client.connectTime),-7,-8,!0,!0):!moment&&this.client.disconnectTime?this.client.echo("Disconnected since: "+new Date(this.client.disconnectTime).toLocaleString(),-7,-8,!0,!0):this.client.disconnectTime?this.client.echo("Disconnected since: "+new moment(this.client.disconnectTime).format("MM/DD/YYYY hh:mm:ss A"),-7,-8,!0,!0):this.client.echo("Not connected",-7,-8,!0,!0),null;case"beep":case"be":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.beep(),null;case"version":case"ve":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.echo(this.client.telnet.terminal+" v"+this.client.version,-7,-8,!0,!0),null;case"showprompt":case"showp":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.telnet.receivedData(be(e),!0,!0),this.client.telnet.prompt=!0,null;case"show":case"sh":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=this.parseInline(e.join(" ")+`
`),this.client.telnet.receivedData(be(e),!0,!0),null;case"sayprompt":case"sayp":case"echoprompt":case"echop":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.print("\x1B[-7;-8m"+e+"\x1B[0m",!1),null;case"say":case"sa":case"echo":case"ec":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"print":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),l=this.client.enableTriggers,this.client.enableTriggers=!1,e=this.parseInline(e.join(" ")),this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,this.client.enableTriggers=l,null;case"printprompt":case"printp":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),l=this.client.enableTriggers,this.client.enableTriggers=!1,e=this.parseInline(e.join(" ")),this.client.print("\x1B[-7;-8m"+e+"\x1B[0m",!1),this.client.enableTriggers=l,null;case"alias":case"al":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"al\x1B[0;-11;-12mias name value or \x1B[4m"+n+"al\x1B[0;-11;-12mias name {value} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===1)throw new Error("Must supply an alias value");if(s=this.parseInline(this.stripQuotes(e.shift())),S=!0,u=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"al\x1B[0;-11;-12mias name value or \x1B[4m"+n+"al\x1B[0;-11;-12mias name {value} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(u=this.parseInline(this.stripQuotes(e[1])),this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);else u=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?e=this.parseInline(this.stripQuotes(e[0])):e=this.parseInline(e[0].substr(1,e[0].length-2))}else e=e.join(" "),u=this.client.activeProfile;if(r=u.aliases,e=this.stripQuotes(e),/^\s*?\d+\s*?$/.exec(s)){if(s=parseInt(s,10),s<0||s>=r.length)throw new Error("Alias index must be >= 0 and < "+r.length);r[s].value=e,this.client.echo("Alias '"+r[s].pattern+"' updated.",-7,-8,!0,!0)}else{for(l=0,a=r.length;l<a;l++)if(r[l].pattern===s){r[l].value=e,this.client.echo("Alias '"+s+"' updated.",-7,-8,!0,!0),this.emit("item-updated","alias",u.name,l,f),o=!0;break}o||(f=new Ne(s,e),r.push(f),this.emit("item-added","alias",u.name,f),this.client.echo("Alias '"+s+"' added.",-7,-8,!0,!0))}return u.aliases=r,this.client.saveProfiles(),u=null,S&&this.client.clearCache(),null;case"unalias":case"una":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"una\x1B[0;-11;-12mlias name or \x1B[4m"+n+"una\x1B[0;-11;-12mlias {name} \x1B[3mprofile\x1B[0;-11;-12m");if(S=!0,u=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"una\x1B[0;-11;-12mlias name or \x1B[4m"+n+"una\x1B[0;-11;-12mlias {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(u=this.stripQuotes(e[1]),u=this.parseInline(u),this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);else u=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?s=this.parseInline(this.stripQuotes(e[0])):s=this.parseInline(e[0].substr(1,e[0].length-2))}else s=this.parseInline(e.join(" ")),u=this.client.activeProfile;if(r=u.aliases,s=this.stripQuotes(s),/^\s*?\d+\s*?$/.exec(s)){if(f=s,s=parseInt(s,10),s<0||s>=r.length)throw new Error("Alias index must be >= 0 and < "+r.length);o=!0}else f=s,s=r.findIndex(y=>y.pattern===s),o=s!==-1;return o?(this.client.echo("Alias '"+r[s].pattern+"' removed.",-7,-8,!0,!0),r.splice(s,1),u.aliases=r,this.client.saveProfiles(),S&&this.client.clearCache(),u=null,this.emit("item-removed","alias",u.name,s)):this.client.echo("Alias '"+f+"' not found.",-7,-8,!0,!0),null;case"setsetting":case"sets":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"sets\x1B[0;-11;-12metting name value");if(e.length===1)throw new Error("Must supply a setsetting value");if(s=this.stripQuotes(this.parseInline(e[0])),e=this.stripQuotes(this.parseInline(e.slice(1).join(" "))),/^\s*?\d+\s*?$/.exec(s)){if(f=s,s=parseInt(s,10),s<0||s>=X.length)throw new Error("Setting index must be >= 0 and < "+X.length);o=!0}else for(s=s.toLowerCase(),l=0,a=X.length;l<a;l++)if(X[l][0].toLowerCase()===s){s=l,o=!0;break}if(o)switch(X[s][2]){case 0:if(X[s][4]>0&&e.length>X[s][4])throw new Error("String can not be longer then "+X[s][4]+" characters");this.client.setOption(X[s][1]||X[s][0],e),this.client.echo("Setting '"+X[s][0]+"' set to '"+e+"'.",-7,-8,!0,!0),this.client.loadOptions();break;case 1:case 3:switch(e.toLowerCase()){case"true":case"1":case"yes":this.client.setOption(X[s][1]||X[s][0],!0),this.client.echo("Setting '"+X[s][0]+"' set to true.",-7,-8,!0,!0),this.client.loadOptions();break;case"no":case"false":case"0":this.client.setOption(X[s][1]||X[s][0],!1),this.client.echo("Setting '"+X[s][0]+"' set to false.",-7,-8,!0,!0),this.client.loadOptions();break;case"toggle":e=!this.client.getOption(X[s][1]||X[s][0]),this.client.setOption(X[s][1]||X[s][0],e),this.client.echo("Setting '"+X[s][0]+"' set to "+e+".",-7,-8,!0,!0),this.client.loadOptions();break;default:throw new Error("Invalid value, must be true or false")}break;case 2:if(l=parseInt(e,10),isNaN(l))throw new Error("Invalid number '"+e+"'");this.client.setOption(X[s][1]||X[s][0],l),this.client.echo("Setting '"+X[s][0]+"' set to '"+l+"'.",-7,-8,!0,!0),this.client.loadOptions();break;case 4:case 5:throw new Error("Unsupported setting '"+s+"'")}else throw new Error("Unknown setting '"+f+"'");return null;case"getsetting":case"gets":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"gets\x1B[0;-11;-12metting name");if(s=this.stripQuotes(this.parseInline(e.join(" "))),/^\s*?\d+\s*?$/.exec(s)){if(s=parseInt(s,10),s<0||s>=X.length)throw new Error("Setting index must be >= 0 and < "+X.length);o=!0}else{if(f=s,s=s.toLowerCase(),s!=="all"){for(l=0,a=X.length;l<a;l++)if(X[l][0].toLowerCase()===s){s=l,o=!0;break}}if(s==="all"){for(f=`Current settings:
`,l=0,a=X.length;l<a;l++)switch(X[l][2]){case 0:case 2:f+="    "+X[l][0]+": "+this.client.getOption(X[s][1]||X[s][0])+`
`;break;case 1:case 3:this.client.getOption(X[s][1]||X[s][0])?f+="    "+X[l][0]+`: true
`:f+="    "+X[l][0]+`: false
`;break}this.client.echo(f,-7,-8,!0,!0)}else if(o)switch(X[s][2]){case 0:case 2:this.client.echo("Setting '"+X[s][0]+"' is '"+this.client.getOption(X[s][1]||X[s][0])+"'",-7,-8,!0,!0);break;case 1:case 3:this.client.getOption(X[s][1]||X[s][0])?this.client.echo("Setting '"+X[s][0]+"' is true",-7,-8,!0,!0):this.client.echo("Setting '"+X[s][0]+"' is false",-7,-8,!0,!0);break}else throw new Error("Unknown setting '"+s+"'")}return null;case"profilelist":(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.echo("\x1B[4mProfiles:\x1B[0m",-7,-8,!0,!0);let I=this.client.profiles.keys;for(a=I.length,l=0;l<a;l++)this.client.profiles.items[I[l]]&&this.client.profiles.items[I[l]].enabled?this.client.echo("   "+this.client.profiles.keys[l]+" is enabled",-7,-8,!0,!0):this.client.echo("   "+I[l]+" is disabled",-7,-8,!0,!0);return null;case"profile":case"pro":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name enable/disable");if(e.length===1){if(e[0]=this.parseInline(e[0]),this.client.toggleProfile(e[0]),this.client.profiles.contains(e[0])){if(this.client.profiles.length===1)throw new Error(e[0]+" can not be disabled as it is the only one enabled")}else throw new Error("Profile not found");this.client.profiles.contains(e[0].toLowerCase())?this.client.profiles.items[e[0].toLowerCase()].enabled?e=e[0]+" is enabled":e=e[0]+" is disabled":e="Profile not found"}else{if(e[0]=this.parseInline(e[0]).toLowerCase(),!this.client.profiles.contains(e[0]))throw new Error("Profile not found");if(!e[1])throw new Error("Invalid syntax use \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name enable/disable");switch(e[1]=this.parseInline(e[1]),e[1].toLowerCase()){case"enable":case"on":case"yes":this.client.profiles.items[e[0].toLowerCase()].enabled?e=e[0]+" is already enabled":(this.client.toggleProfile(e[0]),this.client.profiles.items[e[0].toLowerCase()].enabled!==-1?e=e[0]+" is enabled":e=e[0]+" remains disabled");break;case"disable":case"off":case"no":if(!this.client.profiles.items[e[0].toLowerCase()].enabled)e=e[0]+" is already disabled";else{if(this.client.profiles.length===1)throw new Error(e[0]+" can not be disabled as it is the only one enabled");this.client.toggleProfile(e[0]),e=e[0]+" is disabled"}break;default:throw new Error("Invalid syntax use \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name enable/disable")}}return this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"color":case"co":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length>1&&e.length<4)return h={profile:null,pattern:null,commands:null},h.pattern=e.shift(),h.pattern.match(/^\{.*\}$/g)?h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)):h.pattern=this.parseInline(this.stripQuotes(h.pattern)),e.length===2?(h.commands=n+"COLOR "+this.parseInline(e[0]),h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))):h.commands=n+"COLOR "+this.parseInline(e[0]),this.createTrigger(h.pattern,h.commands,h.profile),null;if(e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+n+"co\x1B[0;-11;-12mlor color or \x1B[4m"+n+"co\x1B[0;-11;-12mlor {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+n+"co\x1B[0;-11;-12mlor color or \x1B[4m"+n+"co\x1B[0;-11;-12mlor {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(e[0]=this.parseInline(this.stripQuotes(e[0])),s=this.client.display.lines.length,e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.colorSubStrByLine(s,parseInt(e[0],10))},0);else if(e[0].trim().match(/^[-|+]?\d+\s*?,\s*?[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.colorSubStrByLine(s,parseInt(e[0][0],10),parseInt(e[0][1],10))},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(l=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Y(e[0]),l===-1)if(se(e[0]))l=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.colorSubStrByLine(s,l)},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")l=370;else if(e[0]==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Y(e[0]),l===-1)if(se(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{s=this.adjustLastLine(s),l===370?this.client.display.colorSubStrByLine(s,l):this.client.display.colorSubStrByLine(s,l*10)},0);else{if(E=l,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Y(e[1],!0),l===-1)if(se(e[1]))l=e[1];else throw new Error("Invalid back color");setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.colorSubStrByLine(s,E,l)},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Y(e[0]),l===-1)if(se(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(l?E=l*10:l=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Y(e[1],!0),l===-1)if(se(e[1]))l=e[0];else throw new Error("Invalid back color");setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.colorSubStrByLine(s,E,l)},0)}return null;case"cw":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),p=this.stack.regex,e.length>1&&e.length<4)return h={profile:null,pattern:null,commands:null},h.pattern=e.shift(),h.pattern.match(/^\{.*\}$/g)?h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)):h.pattern=this.parseInline(this.stripQuotes(h.pattern)),e.length===2?(h.commands=n+"CW "+this.parseInline(e[0]),h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))):h.commands=n+"CW "+this.parseInline(e[0]),this.createTrigger(h.pattern,h.commands,h.profile),null;if(e.length!==1)throw new Error("Invalid syntax use "+n+"cw color or "+n+"cw {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(!p)return null;if(e[0]=this.parseInline(this.stripQuotes(e[0])),s=this.client.display.lines.length,e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{if(s=this.adjustLastLine(s),p.length===1)this.client.display.colorSubStrByLine(s,parseInt(e[0],10));else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(s,parseInt(e[0],10),null,y.index,y[0].length)}},0);else if(e[0].trim().match(/^[-|+]?\d+,[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{if(s=this.adjustLastLine(s),p.length===1)this.client.display.colorSubStrByLine(s,parseInt(e[0][0],10),parseInt(e[0][1],10));else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(s,parseInt(e[0],10),parseInt(e[0][1],10),y.index,y[0].length)}},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(l=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Y(e[0]),l===-1)if(se(e[0]))l=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{if(s=this.adjustLastLine(s),p.length===1)this.client.display.colorSubStrByLine(s,l);else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(s,l,null,y.index,y[0].length)}},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")l=370;else if(e[0]==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Y(e[0]),l===-1)if(se(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{if(s=this.adjustLastLine(s),l!==370&&(l*=10),p.length===1)this.client.display.colorSubStrByLine(s,l);else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(s,l,null,y.index,y[0].length)}},0);else{if(E=l,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Y(e[1],!0),l===-1)if(se(e[1]))l=e[1];else throw new Error("Invalid back color");setTimeout(()=>{if(s=this.adjustLastLine(s),p.length===1)this.client.display.colorSubStrByLine(s,E,l);else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(s,E,l,y.index,y[0].length)}},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Y(e[0]),l===-1)if(se(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(l?E=l*10:l=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Y(e[1],!0),l===-1)if(se(e[1]))l=e[0];else throw new Error("Invalid back color");setTimeout(()=>{if(s=this.adjustLastLine(s),p.length===1)this.client.display.colorSubStrByLine(s,E,l);else{p[1].lastIndex=0,f=p[0].matchAll(p[1]);for(let y of f)this.client.display.colorSubStrByLine(s,E,l,y.index,y[0].length)}},0)}return null;case"pcol":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<1||e.length>5)throw new Error("Invalid syntax use "+n+"pcol color \x1B[3mXStart, XEnd, YStart, YEnd\x1B[0;-11;-12m");if(e.length>1){if(f=[].concat(...e.slice(1).map(y=>this.parseInline(this.stripQuotes(y)).split(" "))),f.length>4)throw new Error("Too many arguments use "+n+"pcol color \x1B[3mXStart, XEnd, YStart, YEnd\x1B[0;-11;-12m");if(h={xStart:0},f.length>0&&(h.xStart=parseInt(f[0],10)),f.length>1&&(h.xEnd=parseInt(f[1],10)),f.length>2&&(h.yStart=parseInt(f[2],10)),f.length>3&&(h.yEnd=parseInt(f[3],10)),h.hasOwnProperty("yEnd")&&h.yEnd>h.yStart)throw new Error("yEnd must be smaller or equal to yStart");if(h.hasOwnProperty("xEnd")&&h.xEnd<h.xStart)throw new Error("xEnd must be larger or equal to xStart")}else h={xStart:0};if(e[0]=this.parseInline(this.stripQuotes(e[0])),s=this.adjustLastLine(this.client.display.lines.length),e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{this.colorPosition(s,parseInt(e[0],10),null,h)},0);else if(e[0].trim().match(/^[-|+]?\d+\s*?,\s*?[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{this.colorPosition(s,parseInt(e[0][0],10),parseInt(e[0][1],10),h)},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(l=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Y(e[0]),l===-1)if(se(e[0]))l=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{this.colorPosition(s,l,null,h)},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")l=370;else if(e[0]==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Y(e[0]),l===-1)if(se(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{this.colorPosition(s,l===370?l:l*10,null,h)},0);else{if(E=l,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Y(e[1],!0),l===-1)if(se(e[1]))l=e[1];else throw new Error("Invalid back color");setTimeout(()=>{this.colorPosition(s,E,l,h)},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Y(e[0]),l===-1)if(se(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(l?E=l*10:l=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Y(e[1],!0),l===-1)if(se(e[1]))l=e[0];else throw new Error("Invalid back color");setTimeout(()=>{this.colorPosition(s,E,l,h)},0)}return null;case"highlight":case"hi":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length>0&&e.length<2)return h={profile:null,pattern:null,commands:n+"HIGHLIGHT"},h.pattern=e.shift(),h.pattern.match(/^\{.*\}$/g)?h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)):h.pattern=this.parseInline(this.stripQuotes(h.pattern)),e.length===1&&(h.profile=this.parseInline(this.stripQuotes(e[0]))),this.createTrigger(h.pattern,h.commands,h.profile),null;if(e.length)throw new Error("Too many arguments use \x1B[4m"+n+"hi\x1B[0;-11;-12mghlight \x1B[3mpattern profile\x1B[0;-11;-12m");return s=this.client.display.lines.length,setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.highlightSubStrByLine(s)},0),null;case"break":case"br":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use \x1B[4m"+n+"br\x1B[0;-11;-12meak\x1B[0;-11;-12m");if(!this.loops.length)throw new Error("\x1B[4m"+n+"br\x1B[0;-11;-12meak\x1B[0;-11;-12m must be used in a loop.");return this.stack.break?this.stack.break++:this.stack.break=1,-1;case"continue":case"cont":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use \x1B[4m"+n+"cont\x1B[0;-11;-12minue\x1B[0;-11;-12m");if(!this.loops.length)throw new Error("\x1B[4m"+n+"cont\x1B[0;-11;-12minue\x1B[0;-11;-12m must be used in a loop.");return this.stack.continue=!0,-2;case"if":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),!e.length||e.length>3)throw new Error("Invalid syntax use "+n+"if {expression} {true-command} \x1B[3m{false-command}\x1B[0;-11;-12m");return e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),f=null,this.evaluate(this.parseInline(e[0]))?(e[1].match(/^\{[\s\S]*\}$/g)&&(e[1]=e[1].substr(1,e[1].length-2)),f=this.parseOutgoing(e[1])):e.length>2&&(e[2].match(/^\{[\s\S]*\}$/g)&&(e[2]=e[2].substr(1,e[2].length-2)),f=this.parseOutgoing(e[2])),f!=null&&f.length>0?f:null;case"case":case"ca":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),!e.length||e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"ca\x1B[0;-11;-12mse\x1B[0;-11;-12m index {command 1} \x1B[3m{command n}\x1B[0;-11;-12m");return e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),s=this.evaluate(this.parseInline(e[0])),typeof s!="number"?null:s>0&&s<e.length&&(e[s].match(/^\{[\s\S]*\}$/g)&&(e[s]=e[s].substr(1,e[s].length-2)),f=this.parseOutgoing(e[s]),f!=null&&f.length>0)?f:null;case"switch":case"sw":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),!e.length||e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"sw\x1B[0;-11;-12mitch\x1B[0;-11;-12m (expression) {command} \x1B[3m(expression) {command} ... {else_command}\x1B[0;-11;-12m");for(e.length%2===1?s=e.pop():s=null,a=e.length,l=0;l<a;l+=2)if(e[l].match(/^\{[\s\S]*\}$/g)&&(e[l]=e[l].substr(1,e[l].length-2)),this.evaluate(this.parseInline(e[l])))return e[l+1].match(/^\{[\s\S]*\}$/g)&&(e[l+1]=e[l+1].substr(1,e[l+1].length-2)),f=this.parseOutgoing(e[l+1]),f!=null&&f.length>0?f:null;return s&&(s.match(/^\{[\s\S]*\}$/g)&&(s=s.substr(1,s.length-2)),f=this.parseOutgoing(s),f!=null&&f.length>0)?f:null;case"loop":case"loo":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"loo\x1B[0;-11;-12mp\x1B[0;-11;-12m range {commands}");if(s=this.parseInline(e.shift()).split(","),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),s.length===1){if(f=parseInt(s[0],10),isNaN(f))throw new Error("Invalid loop range '"+s[0]+"' must be a number");return this.executeForLoop(0,f,e)}if(f=parseInt(s[0],10),isNaN(f))throw new Error("Invalid loop min '"+s[0]+"' must be a number");if(l=parseInt(s[1],10),isNaN(l))throw new Error("Invalid loop max '"+s[1]+"' must be a number");return f>l?f++:f--,this.executeForLoop(f,l,e);case"repeat":case"rep":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"rep\x1B[0;-11;-12meat\x1B[0;-11;-12m expression {commands}");if(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.evaluate(this.parseInline(l)),typeof l!="number")throw new Error("Arguments must be a number");return e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),l<1?this.executeForLoop(-l+1,1,e):this.executeForLoop(0,l,e);case"until":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use "+n+"until expression {commands}");for(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),f=[],this.loops.push(0);!this.evaluate(this.parseInline(l));){let y=this.parseOutgoing(e);if(y!=null&&y.length>0&&f.push(y),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}return this.loops.pop(),f.length>0?f.map(y=>y.trim()).join(`
`):null;case"while":case"wh":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"wh\x1B[0;-11;-12mile expression {commands}");for(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),f=[],this.loops.push(0);this.evaluate(this.parseInline(l));){let y=this.parseOutgoing(e);if(y!=null&&y.length>0&&f.push(y),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}return this.loops.pop(),f.length>0?f.map(y=>y.trim()).join(`
`):null;case"forall":case"fo":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"fo\x1B[0;-11;-12mrall stringlist {commands}");for(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),f=[],l=this.splitByQuotes(this.stripQuotes(this.parseInline(l)),"|"),a=l.length,s=0;s<a;s++){this.loops.push(l[s]);let y=this.parseOutgoing(e);if(y!=null&&y.length>0&&f.push(y),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}this.loops.pop()}return f.length>0?f.map(y=>y.trim()).join(`
`):null;case"variable":case"var":case"va":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0){for(l=Object.keys(this.client.variables),a=l.length,f=[],s=0;s<a;s++)f.push(l[s]+" = "+this.client.variables[l[s]]);return f.join(`
`)}if(l=e.shift(),l.match(/^\{.*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),!ge(l))throw new Error("Invalid variable name");return e.length===0?this.client.variables[l]?.toString():(e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.parseInline(e),e.match(/^\s*?[-|+]?\d+\s*?$/)?this.client.variables[l]=parseInt(e,10):e.match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?this.client.variables[l]=parseFloat(e):e==="true"?this.client.variables[l]=!0:e==="false"?this.client.variables[l]=!1:this.client.variables[l]=this.stripQuotes(e),null);case"unvar":case"unv":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+n+"unv\x1B[0;-11;-12mar name ");return l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),delete this.client.variables[l],null;case"add":case"ad":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"ad\x1B[0;-11;-12md name value");if(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),this.client.variables.hasOwnProperty(l)&&typeof this.client.variables[l]!="number")throw new Error(l+" is not a number for add");if(e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.evaluate(this.parseInline(e)),typeof e!="number")throw new Error("Value is not a number for add");return this.client.variables.hasOwnProperty(l)?this.client.variables[l]+=e:this.client.variables[l]=e,null;case"math":case"mat":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"mat\x1B[0;-11;-12mh name value");if(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.evaluate(this.parseInline(e)),typeof e!="number")throw new Error("Value is not a number for add");return this.client.variables[l]=e,null;case"evaluate":case"eva":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"eva\x1B[0;-11;-12mluate expression");return e=this.evaluate(this.parseInline(e.join(" "))),this.client.getOption("ignoreEvalUndefined")&&typeof e>"u"?e="":e=""+e,this.client.telnet.prompt?this.client.print(`
`+e+`\x1B[0m
`,!1):this.client.print(e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"freeze":case"fr":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)this.scrollLock=!this.scrollLock,this.scrollLock?this.client.display.scrollAtBottom&&this.client.display.scrollUp():this.client.display.scrollDisplay();else if(e.length===1)e[0]==="0"||e[0]==="false"?this.scrollLock&&(this.scrollLock=!1,this.client.display.scrollDisplay()):this.scrollLock||(this.scrollLock=!0,this.client.display.scrollAtBottom&&this.client.display.scrollUp());else if(e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"fr\x1B[0;-11;-12meeze \x1B[3mnumber\x1B[0;-11;-12m");return null;case"clr":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use "+n+"CLR");if(this.client.display.lines.length===0)return null;for(l=this.client.display.WindowSize.height+2,s=this.client.display.lines.length;s--&&l&&!this.client.display.lines[s].text.length;)l--;for(f=[];l--;)f.push(`
`);return this.client.print(f.join(""),!0),null;case"fire":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=this.parseInline(e.join(" ")+`
`),this.ExecuteTriggers(140,e,e,!1,!1),null;case"state":case"sta":switch((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=e.map(y=>!y||!y.length?y:y.match(/^\{.*\}$/g)?this.parseInline(y.substr(1,y.length-2)):this.parseInline(this.stripQuotes(y))),e.length){case 0:throw new Error("Invalid syntax use \x1B[4m"+n+"sta\x1B[0;-11;-12mte \x1B[3m name|pattern state profile\x1B[0;-11;-12m");case 1:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");p=this._LastTrigger,s=p.state,p.state=parseInt(e[0],10)}else{let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");p=H(this.client.profiles.items[y[d]].triggers),p=p.find(W=>W.name===e[0]||W.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(p=H(this.client.profiles.items[y[d]].triggers),p=p.find(W=>W.name===e[0]||W.pattern===e[0]),p));d++);if(!p)throw new Error("Trigger not found: "+e[0]);s=p.state,p.state=0}break;case 2:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/))throw new Error("Invalid argument to "+n+"state, first argument must be name|pattern");if(e[1].match(/^\s*?[-|+]?\d+\s*?$/)){let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");p=H(this.client.profiles.items[y[d]].triggers),p=p.find(W=>W.name===e[0]||W.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(p=H(this.client.profiles.items[y[d]].triggers),p=p.find(W=>W.name===e[0]||W.pattern===e[0]),p));d++);if(!p)throw new Error("Trigger not found: "+e[0]);s=p.state,p.state=parseInt(e[1],10)}else{if(u=e[1],this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+e[1]);if(p=H(u.triggers),p=p.find(y=>y.name===e[0]||y.pattern===e[0]),!p)throw new Error("Trigger not found: "+e[0]+" in profile: "+u.name);s=p.state,p.state=0}break;case 3:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/))throw new Error("Invalid argument to "+n+"state, first argument must be name|pattern");if(u=e[2],this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+e[2]);if(p=H(u.triggers),p=p.find(y=>y.name===e[0]||y.pattern===e[0]),!p)throw new Error("Trigger not found: "+e[0]);s=p.state,p.state=parseInt(e[1],10);break;default:throw new Error("Invalid syntax use \x1B[4m"+n+"sta\x1B[0;-11;-12mte \x1B[3m name|pattern state profile\x1B[0;-11;-12m")}if(p.state<0||p.state>p.triggers.length)throw p.state=s,new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);return l=p.fired,p.fired=!1,this.resetTriggerState(this._TriggerCache.indexOf(p),s,l),this.client.restartAlarmState(p,s,p.state),this.client.saveProfiles(),this.client.emit("item-updated","trigger",p.profile.name,p.profile.triggers.indexOf(p),p),this.client.echo("Trigger state set to "+p.state+".",-7,-8,!0,!0),null;case"set":switch((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=e.map(y=>!y||!y.length?y:y.match(/^\{.*\}$/g)?this.parseInline(y.substr(1,y.length-2)):this.parseInline(this.stripQuotes(y))),s=0,l=!1,e.length){case 0:throw new Error("Invalid syntax use "+n+"set \x1B[3mname|pattern\x1B[0;-11;-12m state \x1B[3mvalue profile\x1B[0;-11;-12m");case 1:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");if(p=this._LastTrigger,s=parseInt(e[0],10),s<0||s>p.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);s===0?(l=p.fired,p.fired=!0):(l=p.triggers[s-1].fired,p.triggers[s-1].fired=!0)}else throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);break;case 2:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");if(p=this._LastTrigger,s=parseInt(e[0],10),s<0||s>p.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);if(e[1]!=="0"&&e[1]!=="1"&&e[1]!=="true"&&e[1]!=="false")throw new Error("Value must be 0, 1, true, or false");s===0?(l=p.fired,p.fired=e[1]==="1"||e[1]==="true"):(l=p.triggers[s-1].fired,p.triggers[s-1].fired=e[1]==="1"||e[1]==="true")}else{let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");p=H(this.client.profiles.items[y[d]].triggers),p=p.find(W=>W.name===e[0]||W.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(p=H(this.client.profiles.items[y[d]].triggers),p=p.find(W=>W.name===e[0]||W.pattern===e[0]),p));d++);if(!p)throw new Error("Trigger not found: "+e[0]);if(s=parseInt(e[1],10),s<0||s>p.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);s===0?(l=p.fired,p.fired=!0):(l=p.triggers[s-1].fired,p.triggers[s-1].fired=!0)}break;case 3:if(e[2]==="0"&&e[2]!=="1"&&e[2]!=="true"&&e[21]!=="false"){if(u=e[2],this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);if(p=H(u.triggers),p=p.find(y=>y.name===e[0]||y.pattern===e[0]),!p)throw new Error("Trigger not found: "+e[0]+" in profile: "+u.name);if(s=parseInt(e[1],10),s<0||s>p.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);s===0?(l=p.fired,p.fired=!0):(l=p.triggers[s-1].fired,p.triggers[s-1].fired=!0)}else{let y=this.client.profiles.keys,d=0,v=y.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[y[0]].enabled||!this.client.profiles.items[y[0]].enableTriggers)throw Error("No enabled profiles found!");p=H(this.client.profiles.items[y[d]].triggers),p=p.find(W=>W.name===e[0]||W.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[y[d]].enabled||!this.client.profiles.items[y[d]].enableTriggers||this.client.profiles.items[y[d]].triggers.length===0)&&(p=H(this.client.profiles.items[y[d]].triggers),p=p.find(W=>W.name===e[0]||W.pattern===e[0]),p));d++);if(!p)throw new Error("Trigger not found: "+e[0]);if(s=parseInt(e[1],10),s<0||s>p.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+p.triggers.length);s===0?(l=p.fired,p.fired=e[2]==="1"||e[2]==="true"):(l=p.triggers[s-1].fired,p.triggers[s-1].fired=e[2]==="1"||e[2]==="true")}break;case 4:if(u=e[2],this.client.profiles.contains(u))u=this.client.profiles.items[u.toLowerCase()];else throw new Error("Profile not found: "+u);if(p=H(u.triggers),p=p.find(y=>y.name===e[0]||y.pattern===e[0]),!p)throw new Error("Trigger not found: "+e[0]+" in profile: "+u.name);if(e[2]!=="0"&&e[2]!=="1"&&e[2]!=="true"&&e[2]!=="false")throw new Error("Value must be 0, 1, true, or false");s===0?(l=p.fired,p.fired=e[2]==="1"||e[2]==="true"):(l=p.triggers[s-1].fired,p.triggers[s-1].fired=e[2]==="1"||e[2]==="true");break;default:throw new Error("Invalid syntax use "+n+"set \x1B[3mname|pattern\x1B[0;-11;-12m state \x1B[3mvalue profile\x1B[0;-11;-12m")}return this.client.saveProfiles(),this.client.emit("item-updated","trigger",p.profile.name,p.profile.triggers.indexOf(p),p),this.resetTriggerState(this._TriggerCache.indexOf(p),s,l),s===0?this.client.echo("Trigger state 0 fired state set to "+p.fired+".",-7,-8,!0,!0):(this.client.echo("Trigger state "+s+" fired state set to "+p.triggers[s-1].fired+".",-7,-8,!0,!0),p.enabled&&p.triggers[s-1].enabled&&p.triggers[s-1].type===65536&&(this._LastTriggered="",this.ExecuteTrigger(p,[],!1,this._TriggerCache.indexOf(p),0,0,p))),null;case"condition":case"cond":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),h={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+n+"cond\x1B[0;-11;-12mition name|pattern {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or \x1B[4m"+n+"cond\x1B[0;-11;-12mition {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid trigger name or pattern");if(e[0].match(/^\{.*\}$/g))h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2));else{if(h.name=this.parseInline(this.stripQuotes(e.shift())),!h.name||h.name.length===0)throw new Error("Invalid trigger name");e[0].match(/^\{.*\}$/g)&&(h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":case"reparse":case"reparsepattern":case"manual":case"skip":case"looplines":case"looppattern":case"wait":case"duration":case"withinlines":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1]))throw new Error("Invalid trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid trigger option '${y.trim()}'`)}});else throw new Error("Invalid trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":case"reparse":case"reparsepattern":case"manual":case"skip":case"looplines":case"looppattern":case"wait":case"duration":case"withinlines":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1]))throw new Error("Invalid trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid trigger option '${y.trim()}'`)}});else throw new Error("Invalid trigger options");h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))}}return this.createTrigger(h.pattern,h.commands,h.profile,h.options,h.name,!0),null;case"cr":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.sendBackground(`
`),null;case"send":case"se":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"se\x1B[0;-11;-12mnd file \x1B[3mprefix suffix\x1B[0;-11;-12m or \x1B[4m"+n+"se\x1B[0;-11;-12mnd text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"se\x1B[0;-11;-12mnd file \x1B[3mprefix suffix\x1B[0;-11;-12m or \x1B[4m"+n+"se\x1B[0;-11;-12mnd text");return this.client.sendBackground(this.stripQuotes(e),this.client.getOption("allowCommentsFromCommand")),null;case"sendfile":case"sendf":return((y,d)=>{Ee().then(v=>{xe(v[0]).then(W=>{(this.client.getOption("echo")&4)===4&&this.client.echo(d,-3,-4,!0,!0),E="",l="",y.length>1&&(E=this.stripQuotes(this.parseInline(y[0]))),y.length>2&&(l=this.stripQuotes(this.parseInline(y[1]))),r=W.split(/\r?\n/),r.forEach(K=>{this.client.sendBackground(E+K+l,null,this.client.getOption("allowCommentsFromCommand"))})}).catch(this.client.error)}).catch(()=>{})})(e,i),null;case"sendfileraw":case"sendfiler":return((y,d)=>{Ee().then(v=>{xe(v[0]).then(W=>{(this.client.getOption("echo")&4)===4&&this.client.echo(d,-3,-4,!0,!0),E="",l="",y.length>1&&(E=this.stripQuotes(this.parseInline(y[0]))),y.length>2&&(l=this.stripQuotes(this.parseInline(y[1]))),r=W.split(/\r?\n/),r.forEach(K=>{this.client.sendRaw(E+K+l)})}).catch(this.client.error)}).catch(()=>{})})(e,i),null;case"sendraw":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+n+"sendraw text or "+n+"sendraw file \x1B[3mprefix suffix\x1B[0;-11;-12m");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use "+n+"sendraw text or "+n+"sendraw file \x1B[3mprefix suffix\x1B[0;-11;-12m");return e.endsWith(`
`)||(e=e+`
`),this.client.sendRaw(e),null;case"sendprompt":case"sendp":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"sendp\x1B[0;-11;-12mrompt text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"sendp\x1B[0;-11;-12mrompt text");return this.client.sendRaw(e),null;case"character":case"char":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.sendRaw(window.$character||""),null;case"speak":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+n+"speak text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use "+n+"speak text");return e=this.stripQuotes(this.parseInline(e)),e.length!==0&&window.speechSynthesis.speak(new SpeechSynthesisUtterance(e)),null;case"speakstop":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+n+"speakstop");return window.speechSynthesis.cancel(),null;case"speakpause":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+n+"speakpause");return window.speechSynthesis.pause(),null;case"speakresume":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+n+"speakresume");return window.speechSynthesis.resume(),null;case"comment":case"comm":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),null;case"noop":case"no":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length&&this.parseInline(e.join(" ")),null;case"temp":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),h={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use "+n+"temp name {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or "+n+"temp {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid temporary trigger or pattern");if(e[0].match(/^\{.*\}$/g))h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2));else{if(h.name=this.parseInline(this.stripQuotes(e.shift())),!h.name||h.name.length===0)throw new Error("Invalid temporary trigger name");e[0].match(/^\{.*\}$/g)&&(h.pattern=e.shift(),h.pattern=this.parseInline(h.pattern.substr(1,h.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(h.commands=e.shift(),h.commands=h.commands.substr(1,h.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid temporary trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid temporary trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid temporary trigger option '${y.trim()}'`)}});else throw new Error("Invalid temporary trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(y=>{switch(y.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":h.options[y.trim()]=!0;break;default:if(y.trim().startsWith("param=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger param option '${y.trim()}'`);h.options.params=f[1]}else if(y.trim().startsWith("type=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger type option '${y.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid temporary trigger type");h.options.type=f[1]}else if(y.trim().startsWith("pri=")||y.trim().startsWith("priority=")){if(f=y.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger priority option '${y.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid temporary trigger priority value '"+f[1]+"' must be a number");h.options.priority=l}else throw new Error(`Invalid temporary trigger option '${y.trim()}'`)}});else throw new Error("Invalid temporary trigger options");h.profile=this.stripQuotes(e[1]),h.profile.length!==0&&(h.profile=this.parseInline(h.profile))}}return h.options.temporary=!0,this.createTrigger(h.pattern,h.commands,h.profile,h.options,h.name),null;case"wrap":case"wr":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=e.filter(y=>y),e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"wr\x1B[0;-11;-12map or \x1B[4m"+n+"wr\x1B[0;-11;-12map number");if(e.length===0)this.client.setOption("display.wordWrap",!this.client.getOption("display.wordWrap")),this.client.display.wordWrap=this.client.getOption("display.wordWrap");else{if(l=parseInt(this.parseInline(e[0]),10),isNaN(l))throw new Error("Invalid number '"+l+"' for wrap");if(l<0)throw new Error("Must be greater then or equal to zero for wrap");this.client.setOption("display.wordWrap",!0),this.client.setOption("display.wordWrap",l),this.client.display.wordWrap=!0,this.client.display.wrapAt=l}return null;case"prompt":case"pr":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+n+"pr\x1B[0;-11;-12mompt variable \x1B[3mmessage defaultValue mask\x1B[0;-11;-12m");if(l=e.shift(),l.match(/^\{.*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),!ge(l))throw new Error("Invalid variable name");return e=e.map(y=>this.parseInline(this.stripQuotes(y))),e.length===3&&e[2]&&e[2].toLowerCase()==="true"&&(e[2]=!0),e=window.prompt(...e),e?.match(/^\s*?[-|+]?\d+\s*?$/)?this.client.variables[l]=parseInt(e,10):e?.match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?this.client.variables[l]=parseFloat(e):e==="true"?this.client.variables[l]=!0:e==="false"?this.client.variables[l]=!1:this.client.variables[l]=e,null;case"setmap":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+n+"setmap file \x1B[3msetCharacter\x1B[0;-11;-12m");if(f=this.stripQuotes(this.parseInline(e.shift()))||"",!f||!f.length)throw new Error("Empty file\x1B[0;-11;-12m");return e.length>1?E=this.stripQuotes(this.parseInline(e.join(" "))).toLocaleLowerCase().trim():E="",this.emit("setmap",f,E==="true"||E==="yes",!0),null}if(t.match(/^[-|+]?\d+$/)){if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),l=parseInt(t,10),e.length===0)throw new Error("Invalid syntax use "+n+"nnn commands");return e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),l<1?this.executeForLoop(-l+1,1,e):this.executeForLoop(0,l,e)}let x={name:t,args:e,raw:i,handled:!1,return:null};return this.client.emit("function",x),x.handled?((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),x.return):x.raw.startsWith(n)?n+this.parseOutgoing(x.raw.substr(1),null,null,null,!0):this.parseOutgoing(x.raw+`
`,null,null,null,!0)}executeForLoop(t,e,i){let n=[],s;if(t>e)for(s=t-1;s>=e;s--){this.loops.push(s);try{let o=this.parseOutgoing(i);if(o!=null&&o.length>0&&n.push(o),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}catch(o){throw o}finally{this.loops.pop()}}else for(s=t;s<e;s++){this.loops.push(s+1);try{let o=this.parseOutgoing(i);if(o!=null&&o.length>0&&n.push(o),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}catch(o){throw o}finally{this.loops.pop()}}return n.length>0?n.map(o=>o.trim()).join(`
`):null}parseInline(t){return this.parseOutgoing(t,!1,null,!1,!0)}parseOutgoing(t,e,i,n,s,o){let r=t.length;if(!this.enableParsing||t==null||r===0)return t;let a="",l="",f,u=0,b=this.client.aliases,h=this.client.getOption("commandStackingChar"),E=this.client.getOption("speedpathsChar"),S=this.client.getOption("enableSpeedpaths"),p=this.client.getOption("enableCommands"),g=this.client.getOption("commandChar"),T=this.client.getOption("allowEscape"),P=this.client.getOption("escapeChar"),x=this.client.getOption("verbatimChar"),G=this.client.getOption("enableVerbatim"),A=this.client.getOption("enableDoubleParameterEscaping"),I=this.client.getOption("parametersChar"),y=this.client.getOption("enableParameters"),d=this.client.getOption("nParametersChar"),v=this.client.getOption("enableNParameters"),W=this.client.getOption("allowEval"),K=this.client.getOption("ignoreEvalUndefined"),ae=this.client.getOption("enableInlineComments")&&!o,ne=this.client.getOption("enableBlockComments")&&!o,q=this.client.getOption("inlineCommentString").split(""),_=this.client.getOption("blockCommentString").split(""),O=this.client.getOption("ignoreInputLeadingWhitespace"),U="",B=[],C="",N=!0,M="",z,w,V,D=0,L,R,j=!0,te=!1,he=!1,le=!1,re=0,Se=this.client.getOption("parseDoubleQuotes"),ce=this.client.getOption("parseSingleQuotes");for(e==null?e=b.length>0:e=e&&b.length>0,h.length===0?i=!1:i==null?i=this.client.getOption("commandStacking"):i=i&&this.client.getOption("commandStacking"),D=0;D<r;D++)switch(w=t.charAt(D),u){case 1:T&&w===P?u=27:(w==='"'&&Se&&(u=0),e&&N?l+=w:a+=w),j=!1;break;case 27:u=1,w!=='"'&&w!==P?(D--,e&&N?l+=P:a+=P):e&&N?l+=w:a+=w;break;case 2:T&&w===P?u=27:(w==="'"&&ce&&(u=0),e&&N?l+=w:a+=w),j=!1;break;case 28:u=2,w!=="'"&&w!==P?(D--,e&&N?l+=P:a+=P):e&&N?l+=w:a+=w;break;case 3:if(w==='"'&&Se)C+=w,u=4,j=!1;else if(w==="'"&&ce)C+=w,u=5,j=!1;else if(T&&w===P)u=17,j=!1;else if(D===r-1||w===`
`||i&&w===h){for(w===`
`||i&&w===h||(C+=w),C.length>0&&B.push(this.parseInline(C)),V=f.length,z=0;z<V;z++){if(a=this.ExecuteAlias(f[z],B),typeof a=="number")return a>=0&&this.executeWait(t.substr(D+1),a,e,i,n,s,o),M.length===0?null:M;if(a!==null&&(M+=a),a="",!z.multi)break;if(this.stack.continue||this.stack.break)return M.length===0?null:M}l="",u=0,f=null,j=!0}else w===" "?(B.push(this.parseInline(C)),C="",j=!1):(C+=w,j=!1);break;case 4:w==='"'&&(u=3),C+=w,j=!1;break;case 5:w==="'"&&(u=3),C+=w,j=!1;break;case 17:u=3,w===P||i&&w===h||G&&w===x||S&&w===E||p&&w===g||A&&w===I||v&&w===d?C+=w:ae&&w==q[0]||ne&&w==_[0]?R=w:`"'{`.indexOf(w)!==-1?C+=w:C+=P+w;break;case 6:if(T&&w===P)u=18,j=!1;else if(w===`
`||i&&w===h){if(u=0,a=this.ProcessPath(a),a!==null&&(M+=a),a="",j=!0,this.stack.continue||this.stack.break)return M.length===0?null:M}else D===1&&w===E?(u=0,D--,j=!1):(a+=w,j=!1);break;case 18:u=6,w===P||i&&w===h||G&&w===x||S&&w===E||p&&w===g||A&&w===I||v&&w===d?a+=w:ae&&w==q[0]||ne&&w==_[0]?R=w:`"'{`.indexOf(w)!==-1?a+=w:a+=P+w;break;case 7:if(w==="{")j=!1,a+=w,re++;else if(w==="}")j=!1,a+=w,re--;else if(re===0&&T&&w===P)u=19,j=!1;else if(re===0&&(w===`
`||i&&w===h)){if(u=0,a=this.executeScript(g+a),typeof a=="number")return a>=0&&this.executeWait(t.substr(D+1),a,e,i,n,s,o),M.length===0?null:M;if(a!==null&&(M+=U+a+`
`),this.stack.continue||this.stack.break)return M.length===0?null:M;a="",j=!0}else a+=w,j=!1;break;case 19:u=7,a+=P+w;break;case 8:if(w==="{"&&C.length===0){u=9;continue}switch(w){case I:C.length===0&&(e&&N?l+=I:a+=I,u=0,A||D--);break;case"*":if(C.length===0){this.stack.args?(e&&N?l+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):e&&N?l+=I+"*":a+=I+"*",u=0;break}case"-":if(C.length===0){te=!0;break}else if(he&&C.length==1){te=!0;break}else le=!0;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":if(!le){C+=w;break}case"x":if(!le&&C.length===0){he=!0;break}default:if(this.stack.args&&C.length>0)L=parseInt(C,10),he?te&&this.stack.args.indices&&L<this.stack.args.length?L=this.stack.indices.slice(L).map(Q=>Q?Q[0]+" "+Q[1]:"0 0").join(" "):this.stack.args.indices&&L<this.stack.args.length?L=this.stack.args.indices[L]?this.stack.args.indices[L][0]+" "+this.stack.args.indices[L][1]:"0 0":te?L=I+"x-"+L:L=I+"x"+L:(te&&L<this.stack.args.length?L=this.stack.args.slice(C).join(" "):L<this.stack.args.length?L=this.stack.args[L]:te?L=I+"-"+L:L=I+L,te?this.stack.used=this.stack.args.length:C>this.stack.used&&(this.stack.used=parseInt(C,10))),e&&N?l+=L:a+=L,D--;else{if(C.length===0&&this.loops.length>0&&(L=w.charCodeAt(0)-105,L>=0&&L<18&&L<this.loops.length)){e&&N?l+=this.loops[L]:a+=this.loops[L],u=0;break}e&&N?(l+=I,te&&(l+="-"),he&&(l+="x")):(a+=I,te&&(a+="-"),he&&(a+="x")),D=D-C.length-1}u=0,C="";break}break;case 26:w.match(/[^a-zA-Z0-9_]/g)?(this.stack.named.hasOwnProperty(C)?e&&N?l+=this.stack.named[C]:a+=this.stack.named[C]:e&&N?l+=I+C:a+=I+C,D--,u=0,C=""):C+=w;break;case 9:w==="}"&&re===0?(C==="i"?R=this.loops[0]:C==="repeatnum"?R=this.repeatnum:this.stack.args&&C==="*"?(R=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):this.stack.named&&this.stack.named.hasOwnProperty(C)?R=this.stack.named[C]:this.stack.args&&!isNaN(C)?(L=parseInt(C,10),L<0?-L>=this.stack.args.length?W?R=L:(R=I,D=D-L.length-2):(R=this.stack.args.slice(L).join(" "),this.stack.used=this.stack.args.length):L<this.stack.args.length?(R=this.stack.args[L],C>this.stack.used&&(this.stack.used=L)):W?R=L:(R=I,D=D-C.length-2)):this.stack.args&&this.stack.args.indices&&C.match(/^x[-|+]?\d+$/)?(L=parseInt(C.substring(1),10),L<0?-L>=this.stack.args.length?(R=I,D=D-L.length-2):R=this.stack.indices.slice(L).map(Q=>Q?Q[0]+" "+Q[1]:"0 0").join(" "):L<this.stack.args.length?R=this.stack.args.indices[L]?this.stack.args.indices[L][0]+" "+this.stack.args.indices[L][1]:"0 0":(R=I,D=D-C.length-2)):(L=this.parseVariable(C),L!=null?R=L:W?(R=this.evaluate(this.parseInline(C)),K&&typeof R>"u"?R=null:R=""+R):(R=I,D=D-C.length-2)),R!=null&&e&&N?l+=R:R!=null&&(a+=R),u=0,C=""):w==="{"?(re++,C+=w):(w==="}"&&re--,C+=w);break;case 11:w==="{"?u=12:w.match(/[^a-zA-Z_$]/g)?(u=0,D--,e&&N?l+=d:a+=d):(C=w,u=14);break;case 14:w.match(/[^a-zA-Z0-9_]/g)?(this.stack.named&&this.stack.named.hasOwnProperty(C)?e&&N?l+=this.stack.named[C]:a+=this.stack.named[C]:this.client.variables.hasOwnProperty(C)?e&&N?l+=this.client.variables[C]:a+=this.client.variables[C]:e&&N?l+=d+C:a+=d+C,D--,u=0,C=""):C+=w;break;case 12:w==="}"&&re===0?(R=null,C==="i"?R=this.loops[0]:C==="repeatnum"?R=this.repeatnum:this.stack.args&&C==="*"?(R=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):this.stack.named&&this.stack.named.hasOwnProperty(C)?R=this.stack.named[C]:this.stack.args&&!isNaN(C)?(L=parseInt(C,10),L<0?-L>=this.stack.args.length?W?R=L:(R=d,D=D-C.length-2):(R=this.stack.args.slice(L).join(" "),this.stack.used=this.stack.args.length):L<this.stack.args.length?(R=this.stack.args[L],L>this.stack.used&&(this.stack.used=L)):W?R=L:(R=d,D=D-C.length-2)):this.stack.args&&this.stack.args.indices&&C.match(/^x[-|+]?\d+$/)?(L=parseInt(C.substring(1),10),L<0?-L>=this.stack.args.length?(R=d,D=D-C.length-2):R=this.stack.indices.slice(L).map(Q=>Q?Q[0]+" "+Q[1]:"0 0").join(" "):L<this.stack.args.length?R=this.stack.args.indices[L]?this.stack.args.indices[L][0]+" "+this.stack.args.indices[L][1]:"0 0":(R=d,D=D-C.length-2)):(w=this.parseVariable(C),w!=null?R=w:W?(R=this.evaluate(this.parseInline(C)),K&&typeof R>"u"?R=null:R=""+R):(R=d,D=D-C.length-2)),R!=null&&e&&N?l+=R:R!=null&&(a+=R),u=0,C=""):w==="{"?(re++,C+=w):(w==="}"&&re--,C+=w);break;case 15:w===P||i&&w===h||G&&w===x||S&&w===E||p&&w===g||A&&w===I||v&&w===d||ae&&w==q[0]||ne&&w==_[0]||`"'{`.indexOf(w)!==-1?R=w:R=P+w,e&&N?l+=R:a+=R,u=0;break;case 16:w===`
`?(u=0,M+=a+w,a="",j=!0):(a+=w,j=!1);break;case 20:ae&&w===q[1]?u=22:ne&&w===_[1]?u=24:(u=0,e&&N?l+=q[0]:a+=q[0],D--);break;case 21:w===q[1]?u=22:(u=0,e&&N?l+=q[0]:a+=q[0],D--);break;case 23:ne&&w===_[1]?u=25:(u=0,e&&N?l+=_[0]:a+=_[0],D--);break;case 22:w===`
`&&(u=0,j?(l="",N=!0,j=!0):D--);break;case 24:_.length===1?w===_[0]&&(u=0):w===_[1]&&(u=25);break;case 25:w===_[0]?u=0:u=24;break;default:if((ae||ne)&&w===q[0]&&w===_[0]){ae&&q.length===1?u=22:ne&&_.length===1?u=24:u=20;continue}else if(ae&&w===q[0]){q.length===1?u=22:u=21;continue}else if(ne&&w===_[0]){_.length===1?u=24:u=23;continue}else if(T&&w===P){u=15,j=!1;continue}else if(y&&w===I)u=8,te=!1,he=!1,le=!1,C="",j=!1;else if(v&&w===d)u=11,te=!1,he=!1,le=!1,C="",j=!1;else if(!s&&p&&j&&w===g)u=7,j=!1,l.length?(U=l,l=""):(U=a||"",a="");else if(G&&j&&w===x)u=16,j=!1;else if(S&&j&&w===E)u=6,j=!1;else if(w==='"'&&Se)e&&N?l+=w:a+=w,u=1,j=!1;else if(w==="'"&&ce)e&&N?l+=w:a+=w,u=2,j=!1;else if(j&&O&&(w===" "||w==="	"||w==="\f"||w==="\r"||w==="\v"||w===" "||w==="\xA0"||w==="\u1680"||w==="\u2000-"||w==="\u200A"||w==="\u2028"||w==="\u2029"||w==="\u202F"||w==="\u205F"||w==="\u3000"||w==="\uFEFF"))e&&N?l+=w:a+=w;else if(e&&N&&w===" ")f=Ie(b,"pattern",O?l.trimStart():l),f.length>0?(u=3,B.length=0,C="",B.push(O?l.trimStart():l)):(a+=l+" ",l="",f=null),N=!1,j=!1;else if(w===`
`||i&&w===h){if(e&&N&&l.length>0)if(f=Ie(b,"pattern",O?l.trimStart():l),f.length>0){for(B.push(O?l.trimStart():l),V=f.length,z=0;z<V;z++){if(a=this.ExecuteAlias(f[z],B),typeof a=="number")return a>=0&&this.executeWait(t.substr(D+1),a,e,i,n,s,o),M.length===0?null:M;if(a!==null&&(M+=a),!z.multi)break;if(this.stack.continue||this.stack.break)return M.length===0?null:M}a="",B.length=0,C=""}else{if(a=this.ExecuteTriggers(17,l,l,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(D+1),a,e,i,n,s,o),M.length===0?null:M;a!==null&&(M+=a+`
`),a="",f=null}else{if(a=this.ExecuteTriggers(17,a,a,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(D+1),a,e,i,n,s,o),M.length===0?null:M;a!==null&&(M+=a+`
`),a=""}if(this.stack.continue||this.stack.break)return M.length===0?null:M;l="",N=!0,j=!0}else e&&N?(l+=w,j=!1):(a+=w,j=!1);break}if(u===15?a+=P:u===14&&C.length>0?this.stack.named&&this.stack.named[C]?a+=this.stack.named[C]:this.client.variables.hasOwnProperty(C)?a+=this.client.variables[C]:(C=this.parseInline(C),a+=d,C!=null&&(a+=C)):u===8&&C.length>0?this.stack.args?(C=parseInt(C,10),he&&this.stack.args.indices&&C<this.stack.args.length?a+=this.stack.args.indices[C]?this.stack.args.indices[C][0]+" "+this.stack.args.indices[C][1]:"0 0":(te&&C<this.stack.args.length?a+=this.stack.args.slice(C).join(" "):C<this.stack.args.length&&(a+=this.stack.args[C]),te?this.stack.used=this.stack.args.length:C>this.stack.used&&(this.stack.used=C))):(C=this.parseInline(C),a+=I,te&&(a+="-"),he&&(a+="x"),C!=null&&(a+=C)):u===9?(C=this.parseInline(C),a+=I+"{",C!=null&&(a+=C)):u===11&&C.length>0?this.stack.named?this.stack.named.hasOwnProperty(C)?a+=this.stack.named[C]:(C=this.parseInline(C),a+=d,C!=null&&(a+=C)):(C=this.parseInline(C),a+=d,C!=null&&(a+=C)):u===12?(C=this.parseInline(C),a+=`${d}{`,C!=null&&(a+=C)):u===6?(a=this.ProcessPath(a),a!==null&&(M+=a),a=""):u===20||u===21?(a+=q[0],D--):u===23&&(a+=_[0],D--),!s&&u===7){if(a=this.executeScript(g+a),typeof a=="number")return a>=0&&this.executeWait(t.substr(D+1),a,e,i,n,s,o),M.length===0?null:M;if(a!==null){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let Q=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),Q=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,Q&&(a+=`
`)}M+=U+a}else if(M.length===0)return null;if(this.stack.continue||this.stack.break)return M.length===0?null:M}else if(u===16){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let Q=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),Q=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,Q&&(a+=`
`)}M+=a}else if(l.length>0&&e&&N){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let Q=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),Q=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,Q&&(a+=`
`)}if(a.length>0&&(l+=a),f=Ie(b,"pattern",O?l.trimStart():l),f.length>0)for(B.push(O?l.trimStart():l),V=f.length,z=0;z<V;z++){if(a=this.ExecuteAlias(f[z],B),typeof a=="number")return a>=0&&this.executeWait(t.substr(D+1),a,e,i,n,s,o),M.length===0?null:M;if(a!==null)M+=a;else if(M.length===0)return null;if(this.stack.continue||this.stack.break)return M;if(!z.multi)break}else{if(a=this.ExecuteTriggers(17,l,l,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(D+1),a,e,i,n,s,o),M.length===0?null:M;if(a!==null)M+=a;else if(M.length===0)return null;if(this.stack.continue||this.stack.break)return M}f=null}else if(l.length>0){if(a.length>0&&(l+=a),a=this.ExecuteTriggers(17,l,l,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(D+1),a,e,i,n,s,o),M.length===0?null:M;if(a!==null){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let Q=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),Q=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,Q&&(a+=`
`)}M+=a}else if(M.length===0)return null;if(this.stack.continue||this.stack.break)return M.length===0?null:M}else if(a.length>0){if(a=this.ExecuteTriggers(17,a,a,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(D+1),a,e,i,n,s,o),M.length===0?null:M;if(a!==null){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let Q=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),Q=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),Q&&(a+=`
`)}M+=a}else if(M.length===0)return null;if(this.stack.continue||this.stack.break)return M.length===0?null:M}return B.length=0,B=null,C=null,l=null,M}parseVariable(t){let e;switch(t){case"esc":return"\x1B";case"cr":return`
`;case"lf":return"\r";case"crlf":return`\r
`;case"copied":return window.$copied;case"copied.lower":return window.$copied.toLowerCase();case"copied.upper":return window.$copied.toUpperCase();case"copied.proper":return nt(window.$copied);case"i":return this.loops[0];case"repeatnum":return this.vStack.$repeatnum||this.repeatnum;case"character":return window.$character;case"character.lower":return window.$character.toLowerCase();case"character.upper":return window.$character.toUpperCase();case"character.proper":return nt(window.$character);case"selected":case"selectedurl":case"selectedline":case"selectedword":case"selurl":case"selline":case"selword":case"action":case"trigger":return this.vStack["$"+t]||window["$"+t]||"";case"selected.lower":case"selectedurl.lower":case"selectedline.lower":case"selectedword.lower":case"selurl.lower":case"selline.lower":case"selword.lower":return(this.vStack["$"+t.substr(0,t.length-6)]||window["$"+t.substr(0,t.length-6)]||"").toLowerCase();case"selected.upper":case"selectedurl.upper":case"selectedline.upper":case"selectedword.upper":case"selurl.upper":case"selline.upper":case"selword.upper":return(this.vStack["$"+t.substr(0,t.length-6)]||window["$"+t.substr(0,t.length-6)]||"").toUpperCase();case"selected.proper":case"selectedurl.proper":case"selectedline.proper":case"selectedword.proper":case"selurl.proper":case"selline.proper":case"selword.proper":return nt(this.vStack["$"+t.substr(0,t.length-7)]||window["$"+t.substr(0,t.length-7)]);case"random":return ze().randomInt(0,100)}if(st.indexOf(t)!==-1)return this.vStack["$"+t]||window["$"+t]||"";if(this.loops.length&&t.length===1){let b=t.charCodeAt(0)-105;if(b>=0&&b<18&&b<this.loops.length)return this.loops[b]}let n=new RegExp("^([a-zA-Z]+)\\((.*)\\)$","g").exec(t);if(!n||!n.length){let b={raw:t,name:t,args:[],handled:!1,return:null};return this.client.emit("variable",b),b.handled?b.return:null}let s,o,r,a,l,f=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";switch(n[1]){case"time":return moment?n[2]&&n[2].length>0?moment().format(this.stripQuotes(this.parseInline(n[2]))):moment().format():new Date().toISOString();case"clip":return n[2]&&n[2].length>0?(this.client.writeClipboard(this.stripQuotes(this.parseInline(n[2]))),null):this.client.readClipboard();case"lower":return this.stripQuotes(this.parseInline(n[2]).toLowerCase());case"upper":return this.stripQuotes(this.parseInline(n[2]).toUpperCase());case"proper":return nt(this.stripQuotes(this.parseInline(n[2])));case"eval":return r=this.evaluate(this.parseInline(n[2])),this.client.getOption("ignoreEvalUndefined")&&typeof r>"u"?null:""+r;case"dice":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid dice");if(r.length===1){if(n=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(r[0]),!n||n.length<3)return null;e=parseInt(n[1]),s=n[2],n.length>3&&(o=n[3])}else if(r.length<4)e=parseInt(r[0]),s=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for dice");s==="F"||s==="f"?s="F":s!=="%"&&(s=parseInt(s));let b=0;for(let S=0;S<e;S++)s==="F"||s==="f"?b+=Ut():s==="%"?b+=~~(Math.random()*100)+1:b+=~~(Math.random()*s)+1;return s==="%"&&(b/=100),o?this.evaluate(b+o):""+b;case"diceavg":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid dice for diceavg");if(r.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!n||n.length<3)return null;e=parseInt(n[1]),s=n[2],n.length>3&&(o=n[3])}else if(r.length<4)e=parseInt(r[0]),s=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for diceavg");return a=1,s==="F"||s==="f"?(a=-1,l=1):s==="%"?(a=0,l=1):l=parseInt(s),o?this.evaluate((a+l)/2*e+o):""+(a+l)/2*e;case"dicemin":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid dice for dicemin");if(r.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!n||n.length<3)return null;e=parseInt(n[1]),s=n[2],n.length>3&&(o=n[3])}else if(r.length<4)e=parseInt(r[0]),s=r[1].trim(),r.length>2&&(o=r[2]);else throw new Error("Too many arguments for dicemin");return a=1,s==="F"||s==="f"?a=-1:s==="%"&&(a=0),o?this.evaluate(a*e+o):""+a*e;case"dicemax":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid dice for dicemax");if(r.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!n||n.length<3)return null;e=parseInt(n[1]),s=n[2],n.length>3&&(o=n[3])}else if(r.length<4)e=parseInt(r[0]),s=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for dicemax");return s==="F"||s==="f"||s==="%"?l=1:l=parseInt(s),o?this.evaluate(l*e+o):""+l*e;case"zdicedev":case"dicedev":let h=n[1];if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid dice for "+h);if(r.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!n||n.length<3)return null;e=parseInt(n[1]),s=n[2],n.length>3&&(o=n[3])}else if(r.length<4)e=parseInt(r[0]),s=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for "+h);return s==="F"||s==="f"?l=6:s==="%"?l=1:l=parseInt(s),h==="zdicedev"&&l--,o?this.evaluate(Math.sqrt((l*l-1)/12*e)+o):""+Math.sqrt((l*l-1)/12*e);case"color":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for color");if(r.length===1){if(r[0]==="bold")return"370";if(e=Y(r[0]),e===-1)throw new Error("Invalid fore color");return e.toString()}else if(r.length===2){if(r[0]==="bold")e=370;else{if(e=Y(r[0]),e===-1)throw new Error("Invalid fore color");if(r[1]==="bold")return(e*10).toString()}if(s=e.toString(),e=Y(r[1],!0),e===-1)throw new Error("Invalid back color");return s+","+e.toString()}else if(r.length===3){if(r[0]==="bold"&&(r.shift(),r.push("bold")),r[2]!=="bold")throw new Error("Only bold is supported as third argument for color");if(e=Y(r[0]),e===-1)throw new Error("Invalid fore color");if(s=(e*10).toString(),e=Y(r[1],!0),e===-1)throw new Error("Invalid back color");return s+","+e.toString()}throw new Error("Too many arguments");case"zcolor":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for zcolor");if(r.length>1)throw new Error("Too many arguments for zcolor");return xt(parseInt(r[0],10));case"ansi":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for ansi");for(e=r.length,o=[],a={},s=0;s<e;s++)if(r[s].trim()==="current")o.push(r[s].trim());else{if(l=we(r[s].trim()),l===-1)throw new Error("Invalid color or style for ansi");l>=0&&l<30?a[l]=1:o.push(r[s])}if(o.length>2)throw new Error("Too many colors for ansi");if(o.length>1&&(o[1]==="current"?o[1]="":o[1]=we(o[1],!0)),o.length>0&&(a[1]&&o[0]==="white"||o[0]==="current"?o[0]="":o[0]=we(o[0])),a=[...Object.keys(a),...o],!a.length)throw new Error("Invalid colors or styles for ansi");return a=a.filter(S=>S!==""),`\x1B[${a.join(";")}m`;case"random":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid random");if(r.length===1)return ze().randomInt(0,parseInt(r[0],10)+1);if(r.length===2)return ze().randomInt(parseInt(r[0],10),parseInt(r[1],10)+1);throw new Error("Too many arguments for random");case"case":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for case");return e=this.evaluate(this.parseInline(r[0])),typeof e!="number"?"":e>0&&e<r.length?this.stripQuotes(r[e]):"";case"switch":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for switch");if(r.length%2===1)throw new Error("All expressions must have a value for switch");for(s=r.length,e=0;e<s;e+=2)if(this.evaluate(r[e]))return this.stripQuotes(r[e+1]);return"";case"if":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length<3)throw new Error("Missing arguments for if");if(r.length!==3)throw new Error("Too many arguments for if");return this.evaluate(r[0])?this.stripQuotes(r[1].trim()):this.stripQuotes(r[2].trim());case"ascii":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for ascii");if(r.length>1)throw new Error("Too many arguments for ascii");if(r[0].trim().length===0)throw new Error("Invalid argument, empty string for ascii");return r[0].trim().charCodeAt(0);case"char":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for char");if(r.length>1)throw new Error("Too many arguments for char");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for char");return String.fromCharCode(e);case"begins":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length<2)throw new Error("Missing arguments for begins");if(r.length>2)throw new Error("Too many arguments for begins");return this.stripQuotes(r[0]).startsWith(this.stripQuotes(r[1]));case"ends":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length<2)throw new Error("Missing arguments for ends");if(r.length>2)throw new Error("Too many arguments for ends");return this.stripQuotes(r[0]).endsWith(this.stripQuotes(r[1]));case"len":return this.stripQuotes(this.parseInline(n[2])).length;case"stripansi":let E=new RegExp("[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))","g");return this.stripQuotes(this.parseInline(n[2])).replace(E,"");case"pos":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length<2)throw new Error("Missing arguments for pos");if(r.length>2)throw new Error("Too many arguments for pos");return this.stripQuotes(r[1]).indexOf(this.stripQuotes(r[0]))+1;case"ipos":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length<2)throw new Error("Missing arguments for ipos");if(r.length>2)throw new Error("Too many arguments for ipos");return this.stripQuotes(r[1]).toLowerCase().indexOf(this.stripQuotes(r[0]).toLowerCase())+1;case"regex":if(r=this.splitByQuotes(n[2],","),r.length<2)throw new Error("Missing arguments for regex");if(e=new RegExp(this.stripQuotes(r[1]),"gd"),e=e.exec(this.stripQuotes(this.parseInline(r[0]))),r.shift(),r.shift(),e==null||e.length===0)return 0;if(r.length){for(s=1;s<e.length&&r.length;s++)this.client.variables[this.stripQuotes(this.parseInline(r[0]))]=e[s],r.shift();r.length&&(this.client.variables[this.stripQuotes(this.parseInline(r[0]))]=e[0].length)}return e.indices[0]?e.indices[0][0]+1:1;case"trim":return this.stripQuotes(this.parseInline(n[2])).trim();case"trimleft":return this.stripQuotes(this.parseInline(n[2])).trimLeft();case"trimright":return this.stripQuotes(this.parseInline(n[2])).trimRight();case"bitand":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitand");if(r.length!==2)throw new Error("Too many arguments for bitand");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitand");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitand");return e&s;case"bitnot":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitnot");if(r.length!==1)throw new Error("Too many arguments for bitnot");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitnot");return~e;case"bitor":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitor");if(r.length!==2)throw new Error("Too many arguments for bitor");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitor");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitor");return e|s;case"bitset":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitset");if(r.length>3)throw new Error("Too many arguments for bitset");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitset");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitset");if(s--,o=1,r.length===3&&(o=parseInt(r[2],10),isNaN(o)))throw new Error("Invalid argument '"+r[2]+"' must be a number for bitset");return e&~(1<<s)|(o?1:0)<<s;case"bitshift":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitshift");if(r.length!==2)throw new Error("Too many arguments for bitshift");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitshift");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitshift");return s<0?e>>-s:e<<s;case"bittest":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bittest");if(r.length!==2)throw new Error("Too many arguments for bittest");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bittest");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bittest");return s--,(e>>s)%2!=0?1:0;case"bitxor":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitxor");if(r.length!==2)throw new Error("Too many arguments for bitxor");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitxor");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitxor");return e^s;case"number":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for number");if(r.length>1)throw new Error("Too many arguments for number");return r[0]=this.stripQuotes(r[0],!0),r[0].match(/^\s*?[-|+]?\d+\s*?$/)?parseInt(r[0],10):r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(r[0]):r[0]==="true"?1:(r[0]==="false",0);case"isfloat":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for isfloat");if(r.length>1)throw new Error("Too many arguments for isfloat");return r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0;case"isnumber":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for isnumber");if(r.length>1)throw new Error("Too many arguments for isnumber");return r[0].match(/^\s*?[-|+]?\d+\s*?$/)||r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0;case"string":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for string");if(r.length>1)throw new Error("Too many arguments for string");return`"${this.stripQuotes(r[0]),!0}"`;case"float":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for float");if(r.length>1)throw new Error("Too many arguments for float");return r[0]=this.stripQuotes(r[0],!0),r[0].match(/^\s*?[-|+]?\d+\s*?$/)||r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(r[0]):r[0]==="true"?1:(r[0]==="false",0);case"isdefined":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for isdefined");if(r.length>1)throw new Error("Too many arguments for isdefined");return r[0]=this.stripQuotes(r[0],!0),this.client.variables.hasOwnProperty(r[0])?1:0;case"defined":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for defined");if(r.length===1){r[0]=this.stripQuotes(r[0],!0);let S=this.client.profiles.keys,p=0,g=S.length;if(g===0)return 0;for(;p<g;p++)if(s=H(this.client.profiles.items[S[p]].aliases),s=s.find(T=>T.pattern===r[0]),s||(s=H(this.client.profiles.items[S[p]].triggers),s=s.find(T=>T.pattern===r[0]||T.name===r[0]),s)||(s=H(this.client.profiles.items[S[p]].macros),s=s.find(T=>Ge(T).toLowerCase()===r[0].toLowerCase()||T.name===r[0]),s)||(s=H(this.client.profiles.items[S[p]].aliases),s=s.find(T=>T.caption===r[0]||T.name===r[0]),s))return 1;return this.client.variables.hasOwnProperty(r[0])}else if(r.length===2){r[0]=this.stripQuotes(r[0],!0),r[1]=this.stripQuotes(r[1],!0).toLowerCase();let S=this.client.profiles.keys,p=0,g=S.length;if(g===0)return 0;for(;p<g;p++)switch(r[1]){case"alias":return s=H(this.client.profiles.items[S[p]].aliases),s=s.find(T=>T.pattern===r[0]),s?1:0;case"event":return s=H(this.client.profiles.items[S[p]].triggers),s=s.find(T=>T.type===2&&(T.pattern===r[0]||T.name===r[0])),s?1:0;case"trigger":return s=H(this.client.profiles.items[S[p]].triggers),s=s.find(T=>T.pattern===r[0]||T.name===r[0]),s?1:0;case"macro":return s=H(this.client.profiles.items[S[p]].macros),s=s.find(T=>Ge(T).toLowerCase()===r[0].toLowerCase()||T.name===r[0]),s?1:0;case"button":return s=H(this.client.profiles.items[S[p]].aliases),s=s.find(T=>T.caption===r[0]||T.name===r[0]),s?1:0}if(r[1]==="variable")return this.client.variables.hasOwnProperty(r[0])}else throw new Error("Too many arguments for defined");return 0;case"escape":return r=this.stripQuotes(this.parseInline(n[2])),this.client.getOption("allowEscape")?(e=f,f==="\\"&&(e+=f),this.client.getOption("parseDoubleQuotes")&&(e+='"'),this.client.getOption("parseSingleQuotes")&&(e+="'"),this.client.getOption("commandStacking")&&(e+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(e+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(e+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(e+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(e+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(e+=this.client.getOption("nParametersChar")),r.replace(new RegExp(`[${e}]`,"g"),f+"$&")):r.replace(/[\\"']/g,"$&");case"unescape":return r=this.stripQuotes(this.parseInline(n[2])),this.client.getOption("allowEscape")?(e=f,f==="\\"&&(e+=f),this.client.getOption("parseDoubleQuotes")&&(e+='"'),this.client.getOption("parseSingleQuotes")&&(e+="'"),this.client.getOption("commandStacking")&&(e+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(e+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(e+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(e+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(e+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(e+=this.client.getOption("nParametersChar")),f==="\\"?r.replace(new RegExp(`\\\\[${e}]`,"g"),S=>S.substr(1)):r.replace(new RegExp(`${f}[${e}]`,"g"),S=>S.substr(1))):r.replace(/\\[\\"']/g,S=>S.substr(1));case"alarm":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for alarm");if(r.length>3)throw new Error("Too many arguments for alarm");if(r[0]=this.stripQuotes(r[0]),s=this.client.alarms,l=s.length,l===0)throw new Error("No alarms set.");if(e=0,r.length===1){for(;e<l;e++)if(s[e].type===3&&(s[e].name===r[0]||s[e].pattern===r[0]))return s[e].suspended?0:this.client.getRemainingAlarmTime(e)}else if(r.length===2)if(o=parseInt(r[1],10),isNaN(o)){for(r[1]=this.stripQuotes(r[1].trim());e<l;e++)if(s[e].type===3&&(s[e].name===r[0]||s[e].pattern===r[0])){if(s[e].profile.name.toUpperCase()!==r[1].toUpperCase())continue;return s[e].suspended?0:this.client.getRemainingAlarmTime(e)}throw Error("Alarm not found in profile: "+r[1]+".")}else{for(;e<l;e++)if(s[e].type===3&&(s[e].name===r[0]||s[e].pattern===r[0]))return s[e].suspended||this.client.setAlarmTempTime(e,o),o;throw Error("Alarm not found.")}else if(r.length===3){if(o=parseInt(r[1],10),isNaN(o))throw new Error("Invalid time for alarm");for(r[2]=this.stripQuotes(r[2].trim());e<l;e++)if(s[e].type===3&&(s[e].name===r[0]||s[e].pattern===r[0])){if(s[e].profile.name.toUpperCase()!==r[2].toUpperCase())continue;return s[e].suspended||this.client.setAlarmTempTime(e,o),o}throw Error("Could not set time, alarm not found in profile: "+r[2]+".")}return 0;case"state":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for state");if(r.length>2)throw new Error("Too many arguments for state");if(r[0]=this.stripQuotes(r[0]),o=null,r.length===1){let S=this.client.profiles.keys,p=0,g=S.length;if(g===0)return null;if(g===1){if(!this.client.profiles.items[S[0]].enabled||!this.client.profiles.items[S[0]].enableTriggers)throw Error("No enabled profiles found!");s=H(this.client.profiles.items[S[p]].triggers),s=s.find(T=>T.name===r[0]||T.pattern===r[0])}else for(;p<g&&!(!(!this.client.profiles.items[S[p]].enabled||!this.client.profiles.items[S[p]].enableTriggers||this.client.profiles.items[S[p]].triggers.length===0)&&(s=H(this.client.profiles.items[S[p]].triggers),s=s.find(T=>T.name===r[0]||T.pattern===r[0]),s));p++);}else if(r.length===2){if(r[1]=this.stripQuotes(r[1].trim()),this.client.profiles.contains(r[1]))o=this.client.profiles.items[r[1].toLowerCase()];else throw new Error("Profile not found: "+r[1]);s=H(o.triggers),s=s.find(S=>S.name===r[0]||S.pattern===r[0])}if(s)return s.triggers&&s.triggers.length?s.state:0;throw new Error("Trigger not found");case"isnull":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)return null;if(r.length!==1)throw new Error("Too many arguments for null");return this.evaluate(r[0])===null?1:0;case"prompt":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)return window.prompt()||"";if(r.length>3)throw new Error("Too many arguments");return r=r.map(S=>this.stripQuotes(S)),window.prompt(...r)||""}let u={raw:t,name:n[1],args:n[2]&&n[2].length?this.parseOutgoing(n[2]).split(","):[],handled:!1,return:null};return this.client.emit("variable",u),u.handled?u.return:null}GetNamedArguments(t,e,i){if(t==="*")return e;if(i==null&&(i=!1),t==null||t.length===0)return i?e:[];let n=t.split(","),s=n.length,o=e.length;if(s===0)return i?e:[];let r;i?r=e.slice():r=[];for(let a=0;a<s;a++)n[a]=$.trim(n[a]),!(n[a].length<1)&&(n[a].startsWith("$")&&(n[a]=n[a].substring(1)),n[a].match(/^[a-zA-Z0-9_][a-zA-Z0-9_]+$/g)&&ge(n[a])&&(r[n[a]]||(r[n[a]]=a+1<o?e[a+1]:"")));return r}ExecuteAlias(t,e){if(!t.enabled)return;let i;if(t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:e,named:this.GetNamedArguments(t.params,e),append:t.append,used:0}),i=this.parseOutgoing(t.value,null,null,!0),this._stack.pop();break;case 2:(this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0);let n=this.GetNamedArguments(t.params,e);n?i=Object.keys(n).map(o=>`let ${o} = this.input.stack.named["${o}"];`).join("")+`
`:i="";let s=new Function("try { "+i+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`);this._stack.push({loops:[],args:e,named:n,append:t.append,used:0});try{i=s.apply(this.client,e)}catch(o){throw o}finally{this._stack.pop()}typeof i=="string"&&(i=this.parseOutgoing(i,null,null,!0));break;default:i=t.value;break}return i==null||i===void 0||(i=this.ExecuteTriggers(17,i,i,!1,!0),i==null||i===void 0)||(typeof i!="string"&&(i=i.toString()),i.length===0&&!this.client.getOption("returnNewlineOnEmptyValue"))?null:i.endsWith(`
`)?i:i+`
`}ProcessMacros(t,e,i,n,s){if(!t||t>9&&t<19)return!1;let o=this._MacroCache[t]||(this._MacroCache[t]=Ie(this.client.macros,"key",t)),r=0,a=o.length,l=0;for(e&&(l|=2),i&&(l|=4),n&&(l|=8),s&&(l|=16);r<a;r++)if(!(!o[r].enabled||l!==o[r].modifiers)&&this.ExecuteMacro(o[r]))return!0;return!1}ExecuteMacro(t){if(!t.enabled)return!1;let e;if(t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:0,named:0,used:0});try{e=this.parseOutgoing(t.value)}catch(n){throw n}finally{this._stack.pop()}break;case 2:(this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0);let i=new Function("try { "+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`);this._stack.push({loops:[],args:0,named:0,used:0});try{e=i.apply(this.client)}catch(n){throw n}finally{this._stack.pop()}break;default:e=t.value;break}return e==null||e===void 0?!0:(typeof e!="string"&&(e=e.toString()),e.length===0&&!this.client.getOption("returnNewlineOnEmptyValue")?null:(t.send?(e.endsWith(`
`)||(e+=`
`),t.chain&&this.client.commandInput.value.endsWith(" ")?(this.client.commandInput.value=this.client.commandInput.value+e,this.client.sendCommand(null,null,this.client.getOption("allowCommentsFromCommand"))):this.client.send(e,!0)):t.append&&(this.client.commandInput.value=this.client.commandInput.value+e),!0))}ProcessPath(t,e){if(t.length===0)return"";let i=[],n=0,s="",o="",r=0,a,l,f,u,b=0,h=t.length;for(;r<h;r++)switch(a=t.charAt(r),l=t.charCodeAt(r),n){case 1:l>47&&l<58?o+=a:a==="\\"?n=2:(n=0,s=a);break;case 2:l>47&&l<58?s+=a:(s+="\\",r--),n=0;break;case 3:b===0&&a===")"?n=0:(a==="("?b++:a===")"&&b--,s+=a);break;case 4:b===0&&a==="}"?n=0:(a==="{"?b++:a==="}"&&b--,s+=a);break;default:if(l>47&&l<58){if(s.length>0){for(o.length===0?f=1:f=parseInt(o,10),u=0;u<f;u++)i.push(s);s=""}n=1,o=a}else a==="("?(n=3,b=0):a==="{"?(n=4,b=0):a==="\\"?n=2:s+=a;break}if(s.length>0)for(o.length===0?f=1:f=parseInt(o,10),u=0;u<f;u++)i.push(s);return e&&this._pathQueue.length?this._pathQueue[0]={id:t,current:i,previous:[]}:this._pathQueue.push({id:t,current:i,previous:[]}),this.ExecutePath(),null}ExecutePath(){if(this._pathTimeout||!this._pathQueue.length||this._pathPaused)return;let t=this.client.getOption("pathDelay");t<0&&(t=0),this._pathTimeout=setTimeout(()=>{let e=this.client.getOption("parseSpeedpaths"),i=this.client.getOption("echoSpeedpaths"),n=this.client.getOption("pathDelayCount");n<1&&(n=1);let s=this._pathQueue[0];for(;n--;){let o=s.current.shift();if(s.previous.push(o),e?this.client.sendBackground(o+`
`,!i):this.client.send(o+`
`,!i),!s.current.length)break}s.current.length||this._pathQueue.shift(),this._pathTimeout=null,!(this._pathQueue.length&&this._pathQueue[0].manual)&&this.ExecutePath()},t)}toggleScrollLock(){this.scrollLock=!this.scrollLock}hasTriggerType(t,e){return e===3&&(t&32)==32||e===16&&(t&16)==16||e===1&&(t&1)==1||e===2&&(t&2)==2||e===8&&(t&8)==8||e===0&&(t&4)==4||e===128&&(t&128)==128}isSubTriggerType(t){return(t&512)==512||(t&1024)==1024||(t&4096)==4096||(t&8192)==8192||(t&16384)==16384||(t&32768)==32768||(t&65536)==65536||(t&131072)==131072||(t&262144)==262144}getTriggerType(t){return t===0?4:t===3?32:t}ExecuteTriggers(t,e,i,n,s,o){if(!this.enableTriggers||e==null)return e;s==null&&(s=!1),n==null&&(n=!1),i=i||e,this.buildTriggerCache();let r=0,a,l=!1,f,u=this._TriggerCache,b=u.length,h=this._TriggerStates,E=this._TriggerRegExCache,S;for(;r<b;r++){let p=u[r],g=p;if(p.enabled){if((!g.triggers||!g.triggers.length||p.state>g.triggers.length)&&(g.state=0),p.state!==0&&g.triggers&&g.triggers.length){for(p=g.triggers[p.state-1];!p.enabled&&g.state!==0;){if(g.state++,g.state>g.triggers.length){g.state=0,p=g;break}g.state?p=g.triggers[g.state-1]:p=g,l=!0}if(l&&(this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",g.profile.name,g.profile.triggers.indexOf(g),g)),!p.enabled)continue}if(S=this.getTriggerType(p.type),!(p.type!==void 0&&(t&S)!==S&&(!o||o&&!this.isSubTriggerType(p.type)))&&p.type!==65536&&!(n&&!p.triggerPrompt)&&!(!n&&!p.triggerNewline&&p.triggerNewline!==void 0)){if(h[r]){if(h[r].type===1024){if(h[r].time>Date.now())continue;delete h[r]}else if(h[r].type===16384){if(h[r].time<Date.now()){delete h[r],this.advanceTrigger(p,g,r),h[r]?h[r].reParse=!0:h[r]={reParse:!0},r=this.cleanUpTriggerState(r);continue}}else if(h[r].type===512){if(h[r].lineCount>0)continue;delete h[r]}else if(h[r].type===8192){if(h[r].lineCount<1){this.advanceTrigger(p,g,r),h[r]?h[r].reParse=!0:h[r]={reParse:!0},r=this.cleanUpTriggerState(r);continue}}else if(h[r].type===32768&&h[r].lineCount<1){this.advanceTrigger(p,g,r),h[r]?h[r].reParse=!0:h[r]={reParse:!0},r=this.cleanUpTriggerState(r);continue}}try{if(p.type===128)if(this.evaluate(this.parseInline(p.pattern))){if(h[r]){if(h[r].loop!==-1&&h[r].lineCount<1)continue}else{let T=this.createTriggerState(p,!1,g);T&&(h[r]=T)}this._LastTriggered=p.raw?i:e,f=this.ExecuteTrigger(p,[this._LastTriggered],s,r,[this._LastTriggered],0,g)}else{this.advanceTrigger(p,g,r);continue}else if(p.verbatim){if(!p.caseSensitive&&(p.raw?i:e).toLowerCase()!==p.pattern.toLowerCase()){!h[r]&&(p.type===131072||p.type===262144)&&(this.advanceTrigger(p,g,r),r=this.cleanUpTriggerState(r));continue}else if(p.caseSensitive&&(p.raw?i:e)!==p.pattern){!h[r]&&(p.type===131072||p.type===262144)&&(this.advanceTrigger(p,g,r),r=this.cleanUpTriggerState(r));continue}this._LastTriggered=p.raw?i:e,f=this.ExecuteTrigger(p,[this._LastTriggered],s,r,[this._LastTriggered],0,g)}else{let T;p.type===8||p.type===16||p.type===262144?a=De(p.pattern,this.client):a=p.pattern,p.caseSensitive?T=E["g"+a]||(E["g"+a]=new RegExp(a,"gd")):T=E["gi"+a]||(E["gi"+a]=new RegExp(a,"gid")),T.lastIndex=0;let P=T.exec(p.raw?i:e);if(!P||!P.length){!h[r]&&(p.type===131072||p.type===262144)&&(this.advanceTrigger(p,g,r),r=this.cleanUpTriggerState(r));continue}let x;this._LastTriggered=p.raw?i:e,(p.raw?i:e)===P[0]||!this.client.getOption("prependTriggeredLine")?x=P:(x=[this._LastTriggered,...P],x.indices=[[0,x[0].length],...P.indices]),P.groups&&Object.keys(P.groups).map(G=>this.client.variables[G]=P.groups[G]),f=this.ExecuteTrigger(p,x,s,r,[this._LastTriggered,T],P.groups,g)}if(h[r]&&h[r].reParse)!h[r].type||h[r].type===131072||h[r].type===262144?delete h[r]:delete h[r].reParse,r--;else if(s)return f}catch(T){this.client.getOption("disableTriggerOnError")&&(p.enabled=!1,setTimeout(()=>{this.client.saveProfiles(),this.emit("item-updated","trigger",g.profile,g.profile.triggers.indexOf(g),g)})),this.client.getOption("showScriptErrors")?this.client.error(T):this.client.debug(T)}}}}return e}TestTrigger(t,e,i,n,s,o){let r,a;try{if(t.verbatim){if(!t.caseSensitive&&(t.raw?s:n).toLowerCase()!==t.pattern.toLowerCase())return this._TriggerStates[i]||(this.advanceTrigger(t,e,i),i=this.cleanUpTriggerState(i)),i;if(t.caseSensitive&&(t.raw?s:n)!==t.pattern)return this._TriggerStates[i]||(this.advanceTrigger(t,e,i),i=this.cleanUpTriggerState(i)),i;this._LastTriggered=t.raw?s:n,r=this.ExecuteTrigger(t,[this._LastTriggered],!1,i,[this._LastTriggered],0,e)}else{let l;t.type===8||t.type===16||t.type===262144?a=De(t.pattern,this.client):a=t.pattern,t.caseSensitive?l=this._TriggerRegExCache["g"+a]||(this._TriggerRegExCache["g"+a]=new RegExp(a,"gd")):l=this._TriggerRegExCache["gi"+a]||(this._TriggerRegExCache["gi"+a]=new RegExp(a,"gid")),l.lastIndex=0;let f=l.exec(t.raw?s:n);if(!f||!f.length)return!this._TriggerStates[i]&&(t.type===131072||t.type===262144)&&(this.advanceTrigger(t,e,i),i=this.cleanUpTriggerState(i)),i;let u;this._LastTriggered=t.raw?s:n,(t.raw?s:n)===f[0]||!this.client.getOption("prependTriggeredLine")?u=f:(u=[this._LastTriggered,...f],u.indices=[[0,u[0].length],...f.indices]),f.groups&&Object.keys(f.groups).map(b=>this.client.variables[b]=f.groups[b]),r=this.ExecuteTrigger(t,u,!1,i,[this._LastTriggered,l],f.groups,e)}i=this.cleanUpTriggerState(i)}catch(l){this.client.getOption("disableTriggerOnError")&&(t.enabled=!1,setTimeout(()=>{this.client.saveProfiles(),this.emit("item-updated","trigger",e.profile,e.profile.triggers.indexOf(e),e)})),this.client.getOption("showScriptErrors")?this.client.error(l):this.client.debug(l)}return i}ExecuteTrigger(t,e,i,n,s,o,r){if(i==null&&(i=!1),!t.enabled)return"";if(this._TriggerStates[n]&&this._TriggerStates[n].type===16384&&delete this._TriggerStates[n],t.fired)return t.fired=!1,this.advanceTrigger(t,r,n),this._TriggerStates[n]?this._TriggerStates[n].reParse=!0:this._TriggerStates[n]={reParse:!0},"";this._LastTrigger=t;let a;if(t.temp)if(r.triggers.length)if(r.state===0){let l=r.triggers.shift();l.triggers=r.triggers,l.state=r.state,l.name=r.name,l.profile=r.profile,l.state>l.triggers.length&&(l.state=0),n>=0&&(this._TriggerCache[n]=l),this.client.saveProfiles();let f=r.profile.triggers.indexOf(r);r.profile.triggers[f]=l,this.client.emit("item-updated","trigger",r.profile.name,f,l)}else r.triggers.splice(r.state-1,1),r.state>r.triggers.length&&(r.state=0),this.client.saveProfiles(),this.client.emit("item-updated","trigger",r.profile.name,r.profile.triggers.indexOf(r),r);else n>=0&&this._TriggerCache.splice(n,1),this._TriggerStates[n]&&this.clearTriggerState(n),this.client.removeTrigger(r);else r.triggers.length&&this.advanceTrigger(t,r,n);if((this.client.getOption("echo")&8)===8&&this.client.echo("Trigger fired: "+t.pattern,-7,-8,!0,!0),t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:e,named:0,used:0,regex:s});try{a=this.parseOutgoing(t.value)}catch(l){throw l}finally{this._stack.pop()}break;case 2:if((this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0),t.temp)a=new Function("try { "+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`),a=a.apply(this.client,e);else{this._TriggerFunctionCache[n]||(o?a=Object.keys(o).map(l=>`let ${l} = this.variables["${l}"];`).join("")+`
`:a="",this._TriggerFunctionCache[n]=new Function("try { "+a+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`)),this._stack.push({loops:[],args:e,named:0,used:0,regex:s,indices:e.indices});try{a=this._TriggerFunctionCache[n].apply(this.client,e)}catch(l){throw l}finally{this._stack.pop()}}typeof a=="string"&&(a=this.parseOutgoing(a));break;default:a=t.value;break}if(a==null||a===void 0)return null;if(i)return a;if(typeof a!="string"&&(a=a.toString()),a.length===0&&!this.client.getOption("returnNewlineOnEmptyValue"))return null;a.endsWith(`
`)||(a+=`
`),this.client.connected&&this.client.telnet.sendData(a),this.client.telnet.echo&&this.client.getOption("commandEcho")&&setTimeout(()=>{this.client.echo(a)},1)}advanceTrigger(t,e,i){if(this._TriggerStates[i]){if(this._TriggerStates[i].type===4096){if(this._TriggerStates[i].loop--,this._TriggerStates[i].loop>0)return;this.clearTriggerState(i)}else if(this._TriggerStates[i].type===8192){if(this._TriggerStates[i].lineCount>0)return;this.clearTriggerState(i)}else if(this._TriggerStates[i].type===32768)this.clearTriggerState(i);else if(this._TriggerStates[i].type===128&&(this._TriggerStates[i].loop===-1||this._TriggerStates[i].lineCount>0))return}if(e.state++,e.state>e.triggers.length&&(e.state=0),this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",e.profile.name,e.profile.triggers.indexOf(e),e),e.state!==0){let n=this.createTriggerState(e.triggers[e.state-1]);n&&(this._TriggerStates[i]=n)}}createTriggerState(t,e,i){let n,s;switch(t.type){case 131072:case 262144:s={reParse:!0};break;case 16384:case 1024:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=0)):n=0,s={time:Date.now()+n};break;case 32768:case 8192:case 512:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=1)):n=1,s={lineCount:n+1};break;case 4096:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=0)):n=0,s={loop:n};break;case 128:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=1),i===t?s={lineCount:n-1}:s={lineCount:n}):s={loop:-1};break}return s&&(s.type=t.type),!s&&e?{reParse:!0}:(e&&(s.reparse=!0),s)}updateTriggerState(t,e){if(!this._TriggerStates[e])return;let i;switch(this._TriggerStates[e].type){case 1024:case 16384:i=t.params,i&&i.length?(i=parseInt(i,10),isNaN(i)&&(i=0)):i=0,this._TriggerStates[e].time=Date.now()+i;break;case 32768:case 512:case 8192:i=t.params,i&&i.length?(i=parseInt(i,10),isNaN(i)&&(i=0)):i=0,this._TriggerStates[e].lineCount=i;break;case 4096:i=t.params,i&&i.length?(i=parseInt(i,10),isNaN(i)&&(i=0)):i=0,this._TriggerStates[e].loop=i;break;case 128:i=t.params,i&&i.length?(i=parseInt(i,10),isNaN(i)&&(i=1),this._TriggerStates[e].lineCount=i+1):this._TriggerStates[e].loop=-1;break}}getTriggerState(t){return this._TriggerStates[t]}cleanUpTriggerState(t){return this._TriggerStates[t]&&this._TriggerStates[t].reParse&&(!this._TriggerStates[t].type||this._TriggerStates[t].type===131072||this._TriggerStates[t].type===262144?delete this._TriggerStates[t]:delete this._TriggerStates[t].reParse,t<0?t++:t--),t}clearTriggerState(t){delete this._TriggerStates[t]}setTriggerState(t,e){this._TriggerStates[t]=e}clearTriggerCache(){this._TriggerCache=null,this._TriggerStates={},this._TriggerFunctionCache={},this._TriggerRegExCache={}}resetTriggerState(t,e,i){if(t===-1||t<0||t>=this._TriggerCache.length)return;let n=this._TriggerCache[t],s,o=n,r,a=!1;if(o.state!==0&&(n=o.triggers[o.state-1]),e===0?s=o:s=o.triggers[e-1],e===o.state)this._TriggerStates[t]?n.fired?this.clearTriggerState(t):this.updateTriggerState(n,t):n.fired||this.updateTriggerState(n,t);else if(this._TriggerStates[t]&&(!this._TriggerStates[t].type||this._TriggerStates[t].type!==262144&&this._TriggerStates[t].type!==131072)&&(a=this._TriggerStates[t].reParse),this.clearTriggerState(t),n.fired)this._TriggerStates[t]={reParse:!0};else{let l=this.createTriggerState(n,a);l&&(this._TriggerStates[t]=l)}}buildTriggerCache(){this._TriggerCache==null&&(this._TriggerCache=$.grep(this.client.triggers,t=>{if(t&&t.enabled&&t.triggers.length){if(t.type!==3)return!0;for(let e=0,i=t.triggers.length;e<i;e++)if(t.triggers[e].enabled&&t.triggers[e].type!==3)return!0;return!1}return t.enabled&&t.type!==3}))}clearCaches(){this._TriggerCache=null,this._TriggerStates={},this._TriggerFunctionCache={},this._TriggerRegExCache={},this._gamepadCaches=null,this._lastSuspend=-1,this._MacroCache={}}triggerEvent(t,e){if(!this.enableTriggers)return;this.buildTriggerCache();let i=0;e?Array.isArray(e)?e.unshift(t):e=[t,e]:e=[t];let n=this._TriggerCache.length;for(;i<n;i++){let s=this._TriggerCache[i],o=s,r=!1;if(s.enabled){if(s.state>o.triggers.length&&(s.state=0),s.state!==0&&o.triggers&&o.triggers.length){for(s=o.triggers[s.state-1];!s.enabled&&o.state!==0;){if(o.state++,o.state>o.triggers.length){o.state=0,s=o;break}o.state?s=o.triggers[o.state-1]:s=o,r=!0}if(r&&(this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",o.profile.name,o.profile.triggers.indexOf(o),o)),!s.enabled)continue}if(s.type===131072||s.type===262144){let a=this.adjustLastLine(this.client.display.lines.length,!0),l=this.client.display.lines[a];i=this.TestTrigger(s,o,i,l,this.client.display.lines[a].raw||l,a===this.client.display.lines.length-1);continue}s.type===2&&(s.caseSensitive&&t!==s.pattern||!s.caseSensitive&&t.toLowerCase()!==s.pattern.toLowerCase()||(this._LastTriggered=t,this.ExecuteTrigger(s,e,!1,i,0,0,o),i=this.cleanUpTriggerState(i)))}}}executeWait(t,e,i,n,s,o,r){if(!t||t.length===0)return;let a={loops:this.loops.splice(0),args:0,named:0,used:this.stack.used,append:this.stack.append};this.stack.args&&(a.args=this.stack.args.slice()),this.stack.named&&(a.named=this.stack.named.slice()),e<0&&(e=0),setTimeout(()=>{this._stack.push(a);let l=this.parseOutgoing(t,i,n,s,o,r);this._stack.pop(),!(l==null||typeof l>"u"||l.length===0)&&(l.endsWith(`
`)||(l=l+`
`),this.client.send(l,!0))},e)}buildScript(t){if(!t)return"";let e;this.client.getOption("commandStacking")&&this.client.getOption("commandStackingChar")&&this.client.getOption("commandStackingChar").length>0?e=t.splitQuote(`
`+this.client.getOption("commandStackingChar")):e=t.splitQuote(`
`);let i=0,n=e.length,s=[],o=[],r=this.client.getOption("commandChar");for(;i<n;i++)e[i].trim().startsWith(r+"wait ")?(s.push("setTimeout(()=> {"),o.unshift(parseInt(e[i].trim().substr(5),10)||0)):(s.push("client.sendCommand('"),s.push(e[i]),s.push("\\n');"));let a=o.length;for(i=0;i<a;i++)s.push("}, "),s.push(o[i]),s.push(");");return s.join("")}stripQuotes(t,e,i){return!t||t.length===0||((e||this.client.getOption("parseDoubleQuotes"))&&(t=t.replace(/^\"(.*)\"$/g,(n,s,o)=>s.replace(/\\\"/g,'"'))),(i||this.client.getOption("parseSingleQuotes"))&&(t=t.replace(/^\'(.*)\'$/g,(n,s,o)=>s.replace(/\\\'/g,"'")))),t}splitByQuotes(t,e,i,n){let s=0,o=0;return!t||t.length===0?[]:((i||this.client.getOption("parseDoubleQuotes"))&&(s|=2,o|=this.client.getOption("allowEscape")?2:0),(n||this.client.getOption("parseSingleQuotes"))&&(s|=1,o|=this.client.getOption("allowEscape")?1:0),Ze(t,e,s,o,this.client.getOption("escapeChar")))}createTrigger(t,e,i,n,s,o){let r,a,l=!0,f=!1;if(!t&&!s)throw new Error(`Trigger '${s||""}' not found`);if(i){if(typeof i=="string"){if(this.client.profiles.contains(i.toLowerCase()))i=this.client.profiles.items[i.toLowerCase()];else throw new Error("Profile not found: "+i);if(o)if(s)r=i.findAny("triggers",{name:s,pattern:s});else{if(!i.triggers.length)throw new Error("No triggers exist");r=i.triggers[i.triggers.length-1]}else s!==null?r=i.find("triggers","name",s):r=i.find("triggers","pattern",t)}}else{let u=this.client.profiles.keys,b=0,h=u.length;if(h===0)return;if(h===1){if(!this.client.profiles.items[u[0]].enabled||!this.client.profiles.items[u[0]].enableTriggers)throw Error("No enabled profiles found!");if(i=this.client.profiles.items[u[0]],o)if(s)r=this.client.profiles.items[u[b]].findAny("triggers",{name:s,pattern:s});else{if(!this.client.profiles.items[u[b]].triggers.length)throw new Error("No triggers exist");r=this.client.profiles.items[u[b]].triggers[this.client.profiles.items[u[b]].triggers.length-1]}else s!==null?r=this.client.profiles.items[u[b]].find("triggers","name",s):r=this.client.profiles.items[u[b]].find("triggers","pattern",t)}else{for(;b<h;b++)if(!(!this.client.profiles.items[u[b]].enabled||!this.client.profiles.items[u[b]].enableTriggers||this.client.profiles.items[u[b]].triggers.length===0)){if(o)if(s)r=this.client.profiles.items[u[b]].findAny("triggers",{name:s,pattern:s});else{if(!this.client.profiles.items[u[b]].triggers.length)throw new Error("No triggers exist");r=this.client.profiles.items[u[b]].triggers[this.client.profiles.items[u[b]].triggers.length-1]}else s!==null?r=this.client.profiles.items[u[b]].find("triggers","name",s):r=this.client.profiles.items[u[b]].find("triggers","pattern",t);if(r){i=this.client.profiles.items[u[b]];break}}i||(i=this.client.activeProfile)}}if(o){if(!r)throw new Error(`Trigger '${s||""}' not found`);if(a=new ue,a.pattern=t,l=!1,t!==null&&(a.pattern=t),e!==null&&(a.value=e),n&&(n.cmd&&(a.type=1),n.pattern&&(a.type=8),n.regular&&(a.type=0),n.alarm&&(a.type=3),n.event&&(a.type=2),n.cmdpattern&&(a.type=16),n.loopexpression&&(a.type=128),n.reparse&&(a.type=131072),n.reparsepattern&&(a.type=262144),n.manual&&(a.type=65536),n.skip&&(a.type=512),n.looplines&&(a.type=8192),n.looppattern&&(a.type=4096),n.wait&&(a.type=1024),n.duration&&(a.type=16384),n.withinlines&&(a.type=32768),n.prompt&&(a.triggerPrompt=!0),n.nocr&&(a.triggerNewline=!1),n.case&&(a.caseSensitive=!0),n.raw&&(a.raw=!0),n.verbatim&&(a.verbatim=!0),n.disable?a.enabled=!1:n.enable&&(a.enabled=!0),(n.temporary||n.temp)&&(a.temp=!0),n.params&&(a.params=n.params),n.type))if(this.isTriggerType(n.type))a.type=this.convertTriggerType(n.type);else throw new Error("Invalid trigger type");r.triggers.push(a),this.client.echo("Trigger sub state added.",-7,-8,!0,!0)}else{if(r)this.client.echo("Trigger updated.",-7,-8,!0,!0);else{if(!t)throw new Error(`Trigger '${s||""}' not found`);r=new ue,r.name=s||"",r.pattern=t,i.triggers.push(r),this.client.echo("Trigger added.",-7,-8,!0,!0),f=!0}if(t!==null&&(r.pattern=t),e!==null&&(r.value=e),n){if(n.cmd&&(r.type=1),n.pattern&&(r.type=8),n.regular&&(r.type=0),n.alarm&&(r.type=3),n.event&&(r.type=2),n.cmdpattern&&(r.type=16),n.loopexpression&&(r.type=128),n.prompt&&(r.triggerPrompt=!0),n.nocr&&(r.triggerNewline=!1),n.case&&(r.caseSensitive=!0),n.raw&&(r.raw=!0),n.verbatim&&(r.verbatim=!0),n.disable?r.enabled=!1:n.enable&&(r.enabled=!0),(n.temporary||n.temp)&&(r.temp=!0),n.params&&(r.params=n.params),n.type)if(this.isTriggerType(n.type,1))r.type=this.convertTriggerType(n.type);else throw new Error("Invalid trigger type");r.priority=n.priority}else r.priority=0}this.client.saveProfiles(),l&&this.client.clearCache(),f?this.emit("item-added","trigger",i.name,r):this.emit("item-updated","trigger",i.name,i.triggers.indexOf(r),r),i=null}isTriggerType(t,e){switch(e||(e=3),t.replace(/ /g,"").toUpperCase()){case"REGULAREXPRESSION":case"COMMANDINPUTREGULAREXPRESSION":return(e&1)===1;case"0":case"1":case"2":case"3":case"8":case"16":case"128":case"REGULAR":case"COMMANDINPUTREGULAR":case"EVENT":case"ALARM":case"COMMAND":case"COMMANDINPUTPATTERN":case"LOOPEXPRSSION":return(e&1)===1;case"SKIP":case"512":case"WAIT":case"1024":case"LOOPPATTERN":case"4096":case"LOOPLINES":case"8192":case"DURATION":case"16384":case"WITHINLINES":case"32768":case"MANUAL":case"65536":case"REPARSE":case"131072":case"REPARSEPATTERN":case"262144":return(e&2)===2}return!1}convertTriggerType(t){switch(t.replace(/ /g,"").toUpperCase()){case"REGULAREXPRESSION":return 0;case"COMMANDINPUTREGULAREXPRESSION":return 1;case"0":case"1":case"2":case"3":case"8":case"16":case"128":return Xe[parseInt(t,10)];case"REGULAR":case"COMMANDINPUTREGULAR":case"EVENT":case"ALARM":case"COMMAND":case"COMMANDINPUTPATTERN":case"LOOPEXPRSSION":return Xe[t];case"512":case"1024":case"4096":case"8192":case"16384":case"32768":case"65536":case"131072":case"262144":return je[parseInt(t,10)];case"SKIP":case"WAIT":case"LOOPPATTERN":case"LOOPLINES":case"DURATION":case"WITHINLINES":case"MANUAL":case"REPARSE":case"REPARSEPATTERN":return je[t]}throw new Error("Invalid trigger type")}colorPosition(t,e,i,n){if(t=this.adjustLastLine(t),!n.hasOwnProperty("yStart"))this.client.display.colorSubStringByLine(t,e,i,n.xStart,n.hasOwnProperty("xEnd")&&n.xEnd>=0?n.xEnd:null);else{let s=n.hasOwnProperty("xEnd")&&n.xEnd>=0?n.xEnd:null,o=n.xStart,r=t-n.yStart,a=t;for(n.hasOwnProperty("yEnd")&&(a=t-n.yEnd);r<=a;)this.client.display.colorSubStringByLine(r,e,i,o,s),r++}}};function ee(m){this.ok=!1,m.charAt(0)=="#"&&(m=m.substr(1,6)),m=m.replace(/ /g,""),m=m.toLowerCase();var c={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(var t in c)m==t&&(m=c[t]);for(var e=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(l){return[parseInt(l[1],10),parseInt(l[2],10),parseInt(l[3],10)]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(l){return[parseInt(l[1],16),parseInt(l[2],16),parseInt(l[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(l){return[parseInt(l[1]+l[1],16),parseInt(l[2]+l[2],16),parseInt(l[3]+l[3],16)]}}],i=0,n=e.length;i<n;i++){var s=e[i].re,o=e[i].process,r=s.exec(m);if(r){var a=o(r);this.r=a[0],this.g=a[1],this.b=a[2],this.ok=!0}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r,this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g,this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var l=this.r.toString(16),f=this.g.toString(16),u=this.b.toString(16);return l.length==1&&(l="0"+l),f.length==1&&(f="0"+f),u.length==1&&(u="0"+u),"#"+l+f+u}}var Z=(w=>(w[w.None=0]="None",w[w.B=1]="B",w[w.BOLD=2]="BOLD",w[w.STRONG=3]="STRONG",w[w.I=4]="I",w[w.ITALIC=5]="ITALIC",w[w.EM=6]="EM",w[w.U=7]="U",w[w.UNDERLINE=8]="UNDERLINE",w[w.S=9]="S",w[w.STRIKEOUT=10]="STRIKEOUT",w[w.STRIKE=11]="STRIKE",w[w.C=12]="C",w[w.COLOR=13]="COLOR",w[w.H=14]="H",w[w.HIGH=15]="HIGH",w[w.FONT=16]="FONT",w[w.HR=17]="HR",w[w.NOBR=18]="NOBR",w[w.P=19]="P",w[w.BR=20]="BR",w[w.SBR=21]="SBR",w[w.A=22]="A",w[w.SEND=23]="SEND",w[w.EXPIRE=24]="EXPIRE",w[w.VERSION=25]="VERSION",w[w.SUPPORT=26]="SUPPORT",w[w.RESET=27]="RESET",w[w.H1=28]="H1",w[w.H2=29]="H2",w[w.H3=30]="H3",w[w.H4=31]="H4",w[w.H5=32]="H5",w[w.H6=33]="H6",w[w.V=34]="V",w[w.VAR=35]="VAR",w[w.USER=36]="USER",w[w.PASSWORD=37]="PASSWORD",w[w.Custom=38]="Custom",w[w.GAUGE=39]="GAUGE",w[w.STAT=40]="STAT",w))(Z||{});var lt=class{constructor(){this.on=!1;this.lineType=0;this.locked=!1;this.paragraph=!1;this.noBreak=!1;this.expanded=!1;this.lineExpanded=!1;this.capture=0;this.captured=[];this.gagged=!1}},at=class{constructor(c){this.name="";this.value="";this.description="";this.publish=!1;this.remote=!1;this.remote=c??!1}},Ct=class{constructor(c){this.name="";this.definition="";this.closeDefinition="";this.attributes={};this.attributeIndexes=[];this.tag=-1;this.flag="";this.open=!1;this.empty=!1;this.remote=!1;this.gagged=!1;this.remote=c??!1}},ot=class{constructor(c,t,e,i){this.index=-1;this.window="";this.gag=!1;this.fore="";this.back="";this.enabled=!0;this.remote=!1;this.element="";this.definition="";this.closeDefinition="";c!=null&&(this.index=c),t!=null&&(this.fore=t),e!=null&&(this.back=e),i!=null&&(this.remote=i)}},Re=class{constructor(c,t,e,i,n){this.tag=0;this.custom="";this.font=null;this.fontSize=null;this.style=0;this.fore="";this.back="";this.high=!1;this.obj=null;this.gagged=!1;this.open=!1;this.properties=null;c!=null&&(this.style=c),t!=null&&(this.fore=t),e!=null&&(this.back=e),this.high=i||!1,this.open=n||!1}},ht=class extends ie{constructor(t){super();this.parsing=[];this.protocols=[["m","a","i","l","t","o"],["s","k","y","p","e"],["a","i","m"],["c","a","l","l","t","o"],["g","t","a","l","k"],["i","m"],["i","t","m","s"],["m","s","n","i","m"],["t","e","l"],["y","m","s","g","r"]];this._ColorTable=null;this._CurrentForeColor=37;this._CurrentBackColor=40;this._CurrentAttributes=0;this._SplitBuffer="";this.mxpState=new lt;this.mxpStyles=[];this.mxpEntities={};this.mxpElements={};this.mxpLines=[];this.iMXPDefaultMode=0;this.displayControlCodes=!1;this.emulateControlCodes=!0;this.StyleVersion="";this.EndOfLine=!1;this.textLength=0;this.rawLength=0;this.enableMXP=!0;this.DefaultImgUrl="";this.enableDebug=!1;this.showInvalidMXPTags=!1;this.enableLinks=!0;this.enableMSP=!0;this.enableURLDetection=!0;this.window=new Me(0,0);this.enableFlashing=!1;this.emulateTerminal=!1;this.enableBell=!0;this.display=null;this.tabWidth=8;this.busy=!1;t!=null&&(t.DefaultImageURL&&(this.DefaultImgUrl=t.DefaultImageURL),t.enableMXP!=null&&(this.enableMXP=t.enableMXP),t.enableDebug!=null&&(this.enableDebug=t.enableDebug),t.showInvalidMXPTags!=null&&(this.showInvalidMXPTags=t.showInvalidMXPTags),t.enableMSP!=null&&(this.enableMSP=t.enableMSP),t.enableURLDetection!=null&&(this.enableURLDetection=t.enableURLDetection),t.window!=null&&(this.window=t.window),t.enableFlashing!=null&&(this.enableFlashing=t.enableFlashing),t.emulateTerminal!=null&&(this.emulateTerminal=t.emulateTerminal),t.enableBell!=null&&(this.enableBell=t.enableBell),t.display!=null&&(this.display=t.display),t.enableLinks&&(this.enableLinks=t.enableLinks))}getColors(t){typeof t>"u"&&(t=this.GetCurrentStyle());let e,i,n=-1,s=-1;return t.fore.length>0?(this._CurrentAttributes&1)===1?e=this.IncreaseColor(t.fore,.5):(this._CurrentAttributes&2)===2?e=this.DecreaseColor(t.fore,.5):e=t.fore:typeof this._CurrentForeColor=="string"?e="rgb("+this._CurrentForeColor.replace(/;/g,",")+")":(e=this._CurrentForeColor,(this._CurrentAttributes&1)===1?(e>999&&(e/=1e3),e>=0&&e<99&&(e*=10),n=e,e<=-16&&(e=this.IncreaseColor(this.GetColor(e),.5))):(this._CurrentAttributes&2)===2?(e>99&&e<999&&(e/=10),e>=0&&e<999&&(e*=100),n=e,e<=-16&&(e=this.DecreaseColor(this.GetColor(e),.15))):n=e),t.high&&(typeof e=="number"?e=this.IncreaseColor(this.GetColor(e),.25):e=this.IncreaseColor(e,.25)),t.back.length>0?i=t.back:typeof this._CurrentBackColor=="string"?i="rgb("+this._CurrentBackColor.replace(/;/g,",")+")":i=s=this._CurrentBackColor,(this._CurrentAttributes&64)===64||(t.style&64)===64?{fore:i,back:e,foreCode:s,backCode:n}:{fore:e,back:i,foreCode:n,backCode:s}}getFormatBlock(t){let e=this.GetCurrentStyle(),i=this.getColors(e);return{formatType:0,offset:t,color:i.fore||0,background:i.back||0,size:e.fontSize||0,font:e.font||0,style:e.style|this._CurrentAttributes&-2,unicode:!1}}ResetColors(){this._CurrentForeColor=37,this._CurrentBackColor=40,this._CurrentAttributes=0}ProcessAnsiColorParams(t){let e=0,i=t.length,n,s;for(;e<i;e++)switch(n=+t[e]||0,n){case 0:this.ResetColors();break;case 1:this._CurrentAttributes|=1,this._CurrentAttributes&=-3;break;case 2:this._CurrentAttributes|=2,this._CurrentAttributes&=-2;break;case 3:this._CurrentAttributes|=4;break;case 4:this._CurrentAttributes|=8;break;case 5:this._CurrentAttributes|=16;break;case 6:this._CurrentAttributes|=32;break;case 7:this._CurrentAttributes|=64;break;case 8:this._CurrentAttributes|=128;break;case 9:this._CurrentAttributes|=256;break;case 21:this._CurrentAttributes|=512;break;case 22:this._CurrentAttributes&=-2,this._CurrentAttributes&=-3;break;case 23:this._CurrentAttributes&=-5;break;case 24:this._CurrentAttributes&=-9,this._CurrentAttributes&=-513;break;case 25:this._CurrentAttributes&=-17;break;case 26:this._CurrentAttributes&=-33;break;case 27:this._CurrentAttributes&=-65;break;case 28:this._CurrentAttributes&=-129;break;case 29:this._CurrentAttributes&=-257;break;case-11:case-7:case-3:case 30:case 31:case 32:case 33:case 34:case 35:case 36:case 37:this._CurrentForeColor=n;break;case 38:if(e+2<i&&t[e+1]==="5")this._CurrentForeColor=+t[e+2],isNaN(this._CurrentForeColor)?this._CurrentForeColor=37:(this._CurrentForeColor+=16,this._CurrentForeColor*=-1),e+=2;else if(e+4<i&&t[e+1]==="2"){if(n=+t[e+2]||0,n<0||n>255||(s=n+";",n=+t[e+3]||0,n<0||n>255)||(s+=n+";",n=+t[e+4]||0,n<0||n>255))continue;s+=n,this._CurrentForeColor=s,e+=4}break;case 39:this._CurrentForeColor=-1;break;case-12:case-8:case-4:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:this._CurrentBackColor=n;break;case 48:if(e+2<i&&t[e+1]==="5")this._CurrentBackColor=+t[e+2],isNaN(this._CurrentBackColor)?this._CurrentBackColor=40:(this._CurrentBackColor+=16,this._CurrentBackColor*=-1),e+=2;else if(e+4<i&&t[e+1]==="2"){if(n=+t[e+2]||0,n<0||n>255||(s=n+";",n=+t[e+3]||0,n<0||n>255)||(s+=n+";",n=+t[e+4]||0,n<0||n>255))continue;s+=n,this._CurrentBackColor=s,e+=4}break;case 49:this._CurrentBackColor=-2;break;case 53:this._CurrentAttributes|=1024;break;case 55:this._CurrentAttributes&=-1025;break;case 50:case 51:case 52:case 54:case 56:case 57:case 58:case 59:this._CurrentForeColor=n-20,this._CurrentAttributes|=1;break;case 90:case 91:case 92:case 93:case 94:case 95:case 96:case 97:this._CurrentForeColor=n;break;case 100:case 101:case 102:case 103:case 104:case 105:case 106:case 107:this._CurrentBackColor=n;break}}buildColorTable(){let t=[],e,i,n,s;for(e=0;e<6;e++)for(i=0;i<6;i++)for(n=0;n<6;n++)s=16+e*36+i*6+n,t[s]="rgb(",e>0?t[s]+=e*40+55:t[s]+="0",t[s]+=",",i>0?t[s]+=i*40+55:t[s]+="0",t[s]+=",",n>0?t[s]+=n*40+55:t[s]+="0",t[s]+=")";for(e=232;e<=255;e++)i=(e-232)*10+8,t[e]=["rgb(",i,",",i,",",i,")"].join("");t[0]="rgb(0,0,0)",t[1]="rgb(128, 0, 0)",t[2]="rgb(0, 128, 0)",t[3]="rgb(128, 128, 0)",t[4]="rgb(0, 0, 238)",t[5]="rgb(128, 0, 128)",t[6]="rgb(0, 128, 128)",t[7]="rgb(187, 187, 187)",t[8]="rgb(128, 128, 128)",t[9]="rgb(255, 0, 0)",t[10]="rgb(0, 255, 0)",t[11]="rgb(255, 255, 0)",t[12]="rgb(92, 92, 255)",t[13]="rgb(255, 0, 255)",t[14]="rgb(0, 255, 255)",t[15]="rgb(255, 255, 255)",t[256]="rgb(0, 0, 0)",t[257]="rgb(118, 0, 0)",t[258]="rgb(0, 108, 0)",t[259]="rgb(145, 136, 0)",t[260]="rgb(0, 0, 167)",t[261]="rgb(108, 0, 108)",t[262]="rgb(0, 108, 108)",t[263]="rgb(161, 161, 161)",t[264]="rgb(0, 0, 0)",t[265]="rgb(128, 0, 0)",t[266]="rgb(0, 128, 0)",t[267]="rgb(128, 128, 0)",t[268]="rgb(0, 0, 238)",t[269]="rgb(128, 0, 128)",t[270]="rgb(0, 128, 128)",t[271]="rgb(187, 187, 187)",t[272]="rgb(0,0,0)",t[273]="rgb(0, 255, 255)",t[274]="rgb(0,0,0)",t[275]="rgb(255, 255, 0)",t[276]="rgb(0, 0, 0)",t[277]="rgb(229, 229, 229)",t[278]="rgb(205, 0, 0)",t[279]="rgb(229, 229, 229)",t[280]="rgb(255,255,255)",this._ColorTable=t}GetColor(t){switch(this._ColorTable==null&&this.buildColorTable(),t){case-12:return this._ColorTable[279];case-11:return this._ColorTable[278];case-10:return this._ColorTable[280];case-8:return this._ColorTable[272];case-7:return this._ColorTable[273];case-4:return this._ColorTable[274];case-3:return this._ColorTable[275];case 49:case-2:return this._ColorTable[276];case 39:case-1:return this._ColorTable[277];case 0:case 30:return this._ColorTable[0];case 1:case 31:return this._ColorTable[1];case 2:case 32:return this._ColorTable[2];case 3:case 33:return this._ColorTable[3];case 4:case 34:return this._ColorTable[4];case 5:case 35:return this._ColorTable[5];case 6:case 36:return this._ColorTable[6];case 7:case 37:return this._ColorTable[7];case 40:return this._ColorTable[264];case 41:return this._ColorTable[265];case 42:return this._ColorTable[266];case 43:return this._ColorTable[267];case 44:return this._ColorTable[268];case 45:return this._ColorTable[269];case 46:return this._ColorTable[270];case 47:return this._ColorTable[271];case 8:case 90:case 100:case 300:case 400:return this._ColorTable[8];case 9:case 91:case 101:case 310:case 410:return this._ColorTable[9];case 10:case 92:case 102:case 320:case 420:return this._ColorTable[10];case 11:case 93:case 103:case 330:case 430:return this._ColorTable[11];case 12:case 94:case 104:case 340:case 440:return this._ColorTable[12];case 13:case 95:case 105:case 350:case 450:return this._ColorTable[13];case 14:case 96:case 106:case 360:case 460:return this._ColorTable[14];case 15:case 97:case 107:case 370:case 470:return this._ColorTable[15];case 4e3:case 3e3:return this._ColorTable[256];case 4100:case 3100:return this._ColorTable[257];case 4200:case 3200:return this._ColorTable[258];case 4300:case 3300:return this._ColorTable[259];case 4400:case 3400:return this._ColorTable[260];case 4500:case 3500:return this._ColorTable[261];case 4600:case 3600:return this._ColorTable[262];case 4700:case 3700:return this._ColorTable[263];default:return t<=-16&&(t+=16,t*=-1),t>=0&&t<281?this._ColorTable[t]:this._ColorTable[277]}}SetColor(t,e){this._ColorTable==null&&this.buildColorTable(),!(t<0||t>=this._ColorTable.length)&&(e=new ee(e),e.ok&&(this._ColorTable[t]=e.toRGB()))}AddLine(t,e,i,n,s,o){let r={raw:e,line:t,fragment:i,gagged:n,formats:this.pruneFormats(s,t.length,i),remote:o};this.emit("add-line",r),this.EndOfLine=!i}pruneFormats(t,e,i){if(!t||t.length<2)return t;let n=t.length,s=[];for(let o=0;o<n;o++){let r=t[o],a;if(o<n-1){let l=t[o+1];if(r.offset===l.offset&&l.formatType===r.formatType||(a=l.offset,r.formatType===1&&a-r.offset===0&&l.formatType===2)||r.formatType===7&&a-r.offset===0&&l.formatType===8||r.formatType===3&&a-r.offset===0&&l.formatType===4)continue}else if(!i&&r.offset===e&&e!==0&&(r.formatType===0&&!r.hr||r.formatType===1||r.formatType===7||r.formatType===3))continue;s.push(r)}return s}GetEntity(t){return t==="text"?t:this.mxpEntities[t]?(this.mxpState.expanded=!0,this.mxpEntities[t].value):t}ClearMXPToTag(t,e,i){e==null&&(e="");let n=new Re;n.tag=0;let s=this.mxpStyles.length-1;for(;s>=0&&(this.mxpStyles[s].tag!==t&&this.mxpStyles[s].custom!==e);s--){if(!this.mxpStyles[s].open&&!i)continue;n=this.mxpStyles.splice(s,1)[0]}return s>=0&&this.mxpStyles.length>0?n=this.mxpStyles.splice(s,1)[0]:this.mxpStyles.length===0&&this.ResetMXP(),n}ClearMXPOpen(){let t=this.mxpStyles.length;for(;t--;)this.mxpStyles[t].open&&this.mxpStyles.splice(t,1);this.mxpStyles.length===0&&this.ResetMXP()}getMXPOpenFormatBlocks(){if(!this.mxpState.on)return[];let t=0,e=this.mxpStyles.length,i=[];for(;t<e;t++)(this.mxpStyles[t].tag===22||this.mxpStyles[t].tag===23)&&i.push(Object.assign({},this.mxpStyles[t].properties));return i}getMXPCloseFormatBlocks(){if(!this.mxpState.on)return[];let t=this.mxpStyles.length,e=[];for(;t--;)this.mxpStyles[t].tag===22?e.push({formatType:4}):this.mxpStyles[t].tag===23&&e.push({formatType:8});return e}getMXPBlock(t,e,i,n,s){let o,r,a,l,f,u,b=e.length,h,E,S,p="",g="",T="",P=!1;switch(t=t.toUpperCase(),this.enableDebug&&(this.emit("debug","MXP Tag: "+t),this.emit("debug","MXP Tag Args: "+e)),t){case"C":case"COLOR":if(o=this.CloneCurrentStyle(),o.tag=Z[t],o.open=!0,b>0)if(r=e[0].split("="),r.length>1){if(f=new ee(F(r[1])),!f.ok)return null;r[0].toUpperCase()==="BACK"?o.back=f.toRGB():o.fore=f.toRGB()}else f=new ee(F(r[0])),f.ok&&(o.fore=f.toRGB());if(b>1)if(r=e[1].split("="),r.length>1){if(f=new ee(F(r[1])),!f.ok)return null;r[0].toUpperCase()==="FORE"?o.fore=f.toRGB():o.back=f.toRGB()}else f=new ee(F(r[0])),f.ok&&(o.back=f.toRGB());return o.custom="",this.mxpStyles.push(o),null;case"B":case"BOLD":case"STRONG":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=Z[t],o.style|=1,o.custom="",this.mxpStyles.push(o),null;case"FONT":for(o=this.CloneCurrentStyle(),o.open=!0,o.tag=Z[t],u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"SIZE":this.isNumber(r[1])?o.fontSize=r[1]+"pt":o.fontSize=r[1]||0;break;case"COLOR":for(l=r[1].split(","),f=new ee(F(l[0])),f.ok&&(o.fore=f.toRGB()),S=1,E=l.length;S<E;S++)switch(l[S].toLowerCase()){case"bold":o.style|=1;break;case"italic":o.style|=4;break;case"underline":o.style|=8;break;case"blink":o.style|=16;break;case"inverse":o.style|=64;break;case"hidden":o.style|=128;break;case"strikeout":o.style|=256;break;case"overline":o.style|=1024;break;case"doubleunderline":o.style|=512;break}break;case"BACK":f=new ee(F(r[1])),f.ok&&(o.back=f.toRGB());break;case"FACE":o.font=F(r[1])||0;break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+r[0]);break}else u===0?o.font=F(e[u])||0:u===1?this.isNumber(e[u])?o.fontSize=e[u]+"pt":o.fontSize=e[u]||0:u===2?(f=new ee(F(e[u])),f.ok&&(o.fore=f.toRGB())):u===3&&(f=new ee(F(e[u])),f.ok&&(o.back=f.toRGB()));return o.custom="",this.mxpStyles.push(o),null;case"H":case"HIGH":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=Z[t],o.high=!0,o.custom="",this.mxpStyles.push(o),null;case"I":case"ITALIC":case"EM":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=Z[t],o.style|=4,o.custom="",this.mxpStyles.push(o),null;case"U":case"UNDERLINE":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=Z[t],o.style|=8,o.custom="",this.mxpStyles.push(o),null;case"S":case"STRIKEOUT":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=Z[t],o.style|=256,o.custom="",this.mxpStyles.push(o),null;case"/B":case"/BOLD":case"/STRONG":case"/H":case"/HIGH":case"/I":case"/ITALIC":case"/EM":case"/U":case"/UNDERLINE":case"/S":case"/STRIKEOUT":case"/C":case"/COLOR":case"/FONT":return this.ClearMXPToTag(Z[t.substring(1)]),null}if(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4)switch(t){case"IMAGE":for(h={formatType:5,name:"",url:this.DefaultImgUrl,t:"",h:"",w:"",hspace:"",vspace:"",align:"bottom",ismap:!1},u=0;u<b;u++)switch(r=e[u].split("="),r[0].toUpperCase()){case"FNAME":h.name=F(r[1]);break;case"URL":h.url=F(r[1]);break;case"TYPE":case"T":r[1].length>0&&(h.type=r[1]);break;case"HEIGHT":case"H":h.h=F(r[1]);break;case"WIDTH":case"W":h.w=F(r[1]);break;case"HSPACE":h.hspace=r[1];break;case"VSPACE":h.vspace=r[1];break;case"ALIGN":h.align=r[1].toLowerCase();break;case"ISMAP":h.ismap=!0;break;default:u===0?h.name=F(e[u]):u===1?h.url=F(e[u]):u===2&&e[u].length>0?h.type=e[u]:u===3?h.h=F(e[u]):u===4?h.w=F(e[u]):u===5?h.hspace=e[u]:u===6?h.vspace=e[u]:u===7&&(h.align=e[u].toLowerCase());break}return{format:h,text:null};case"!AT":case"!ATTLIST":if(e.length===0||(h=e[0],!this.mxpElements[h]||this.mxpEntities[h].remote!==h.remote&&!this.mxpEntities[h].open))return null;for(this.mxpElements[h].attributes={},this.mxpElements[h].attributeIndexes=[],u=1;u<b;u++)l=e[u].split("="),l.length>1?this.mxpElements[h].attributes[l[0].toLowerCase()]=l[1]:this.mxpElements[h].attributes[l[0].toLowerCase()]="",this.mxpElements[h].attributeIndexes.push(l[0].toLowerCase());break;case"!TAG":for(h=new ot,h.remote=i,u=0;u<b;u++)switch(r=e[u].split("="),r[0].toUpperCase()){case"WINDOWNAME":h.window=F(r[1]);break;case"FORE":f=new ee(F(r[1])),f.ok&&(h.fore=f.toRGB());break;case"BACK":f=new ee(F(r[1])),f.ok&&(h.back=f.toRGB());break;case"GAG":h.gag=!0;break;case"ENABLE":h.enabled=!0;break;case"DISABLE":h.enabled=!1;break;default:u===0?(o=+e[u],isNaN(o)||(h.index=o)):u===1?h.window=F(e[u]):u===2?(f=new ee(F(e[u])),f.ok&&(h.fore=f.toRGB())):u===3&&(f=new ee(F(e[u])),f.ok&&(h.back=f.toRGB()));break}h.fore.length>0&&h.back.length>0?h.definition=`<C "${h.fore}" "${h.back}">`:h.fore.length>0?h.definition=`<C "${h.fore}">`:h.back.length>0&&(h.definition=`<C BACK="${h.fore}">`),h.definition.length>0&&(h.closeDefinition="</C>"),this.mxpLines[h.index]?(h.remote||this.mxpLines[h.index].remote===h.remote)&&(this.mxpLines[h.index]=h):this.mxpLines[h.index]=h;break;case"!EL":case"!ELEMENT":for(h=new Ct(i),u=0;u<b;u++){if(e[u].toUpperCase().startsWith("ATT=")){for(r=F(e[u]).substring(4).split(" "),S=0,E=r.length;S<E;S++)l=F(r[S]).split("="),l.length>1?h.attributes[l[0].toLowerCase()]=F(l[1]):h.attributes[l[0].toLowerCase()]="",h.attributeIndexes.push(l[0].toLowerCase());continue}switch(r=e[u].split("="),r[0].toUpperCase()){case"TAG":o=+r[1],isNaN(o)||(h.tag=o);break;case"FLAG":h.flag=F(r[1]);break;case"OPEN":h.open=!0;break;case"DELETE":return this.mxpElements[h.name]&&(this.mxpEntities[h.name].remote===h.remote||this.mxpEntities[h.name].open)&&delete this.mxpEntities[h.name],null;case"EMPTY":h.empty=!0;break;case"SECURE":h.open=!1;break;default:if(u===0)h.name=F(e[u]).toUpperCase();else if(u===1)h.definition=F(e[u]),h.closeDefinition=this.GetCloseTags(h.definition),this.enableDebug&&this.emit("debug","MXP close definition: "+h.closeDefinition);else if(u===2)for(r=e[u].substring(4).split(" "),S=0,E=r.length;S<E;S++)l=r[S].split("="),l.length>1?h.attributes[l[0]]=l[1]:h.attributes[l[0]]="",h.attributeIndexes.push(l[0]);else u===3?(o=+e[u],isNaN(o)||(h.tag=o)):u===4&&(h.flag=F(e[u]));break}}h.tag>19&&h.tag<100&&(o=new ot(h.tag),o.element=h.name,this.mxpLines[o.index]?(h.remote||this.mxpLines[o.index].remote===h.remote)&&(this.mxpLines[o.index]=o):this.mxpLines[o.index]=o),this.mxpElements[h.name]?(this.mxpElements[h.name].remote===h.remote||this.mxpEntities[h.name].open)&&(this.mxpElements[h.name]=h):this.mxpElements[h.name]=h;break;case"!EN":case"!ENTITY":for(h=new at(i),u=0;u<b;u++)switch(r=e[u].split("="),r[0].toUpperCase()){case"DESC":h.description=F(r[1]);break;case"PRIVATE":h.publish=!1;break;case"PUBLISH":h.publish=!0;break;case"DELETE":return this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote&&delete this.mxpEntities[h.name],null;case"ADD":if(this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote)return this.mxpEntities[h.name].value?this.mxpEntities[h.name].value+="|"+h.value:this.mxpEntities[h.name].value=h.value,null;break;case"REMOVE":if(this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote&&this.mxpEntities[h.name].value){for(l=this.mxpEntities[h.name].value.split("|"),a=[],S=0,E=l.length;S<E;S++)l[S]!==h.value&&a.push(l[S]);this.mxpEntities[h.name].value=a.join("|")}return null;default:u===0?h.name=F(e[u]):u===1?h.value=F(e[u]):u===2&&(h.description=F(e[u]));break}this.mxpEntities[h.name]?this.mxpEntities[h.name].remote===h.remote&&(this.mxpEntities[h.name]=h):this.mxpEntities[h.name]=h;break;case"/V":case"/VAR":for(o=this.ClearMXPToTag(Z[t.substring(1)]),h=new at(i),this.mxpState.captured.length>0?h.value=this.mxpState.captured.pop().join(""):h.value="",this.mxpState.capture--,this.enableDebug&&this.emit("debug","MXP captured: "+h.value),e=o.obj,b=e.length,u=0;u<b;u++)switch(r=e[u].split("="),r[0].toUpperCase()){case"DESC":h.description=F(r[1]);break;case"PRIVATE":h.publish=!1;break;case"PUBLISH":h.publish=!0;break;case"DELETE":return this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote&&delete this.mxpEntities[h.name],null;case"ADD":if(this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote)return this.mxpEntities[h.name].value?this.mxpEntities[h.name].value+="|"+h.value:this.mxpEntities[h.name].value=h.value,null;break;case"REMOVE":if(this.mxpEntities[h.name]&&this.mxpEntities[h.name].remote===h.remote&&this.mxpEntities[h.name].value){for(l=this.mxpEntities[h.name].value.split("|"),a=[],S=0,E=l.length;S<E;S++)l[S]!==h.value&&a.push(l[S]);this.mxpEntities[h.name].value=a.join("|")}return null;default:u===0?h.name=F(e[u]):u===1&&(h.description=F(e[u]));break}this.mxpEntities[h.name]?this.mxpEntities[h.name].remote===h.remote&&(this.mxpEntities[h.name]=h):this.mxpEntities[h.name]=h;break;case"V":case"VAR":return this.mxpState.captured.push([]),this.mxpState.capture++,o=this.CloneCurrentStyle(),o.open=!1,o.tag=Z[t],o.obj=e,o.custom="",this.mxpStyles.push(o),null;case"GAUGE":for(h={value:0,max:1,caption:"",color:0},u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"VALUE":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),h.value=o;break;case"MAX":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),h.max=o;break;case"CAPTION":r[1].length>0&&(h.caption=F(r[1]));break;case"COLOR":f=new ee(F(r[1])),f.ok&&(h.color=f.toRGB());break}else u===0?(o=parseFloat(this.GetEntity(e[u])),isNaN(o)&&(o=this.GetEntity(e[u])),h.value=o):u===1?(o=parseFloat(this.GetEntity(e[u])),isNaN(o)&&(o=this.GetEntity(e[u])),h.max=o):u===2&&e[u].length>0?h.caption=F(e[u]):u===3&&e[u].length>0&&(f=new ee(F(r[1])),f.ok&&(h.color=f.toRGB()));this.mxpState.expanded=!1,this.emit("gauge",h);break;case"STAT":for(h={value:0,max:1,caption:""},u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"VALUE":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),h.value=o;break;case"MAX":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),h.max=o;break;case"CAPTION":r[1].length>0&&(h.caption=F(r[1]));break}else u===0?(o=parseFloat(this.GetEntity(e[u])),isNaN(o)&&(o=this.GetEntity(e[u])),h.value=o):u===1?(o=parseFloat(this.GetEntity(e[u])),isNaN(o)&&(o=this.GetEntity(e[u])),h.max=o):u===2&&e[u].length>0&&(h.caption=F(e[u]));this.mxpState.expanded=!1,this.emit("stat",h);break;case"MUSIC":for(h={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"FNAME":h.file=F(r[1]),h.file.toLowerCase()==="off"&&(h.off=!0,h.file="");break;case"V":o=+r[1],isNaN(o)&&(o=100),h.volume=o;break;case"L":o=+r[1],isNaN(o)&&(o=1),h.repeat=o;break;case"C":h.continue=r[1]!=="0";break;case"T":r[1].length>0&&(h.type=r[1]);break;case"U":h.url=F(r[1]),!h.url.endsWith("/")&&h.url.length>0&&(h.url+="/");break}else u===0?(h.file=F(e[u]),h.file.toLowerCase()==="off"&&(h.off=!0,h.file="")):u===1?(o=+e[u],isNaN(o)&&(o=100),h.volume=o):u===2?(o=+e[u],isNaN(o)&&(o=1),h.repeat=o):u===3?h.continue=e[u]!=="0":u===4?e[u].length>0&&(h.type=e[u]):u===5&&(h.url=F(e[u]),!h.url.endsWith("/")&&h.url.length>0&&(h.url+="/"));this.emit("music",h);break;case"SOUND":for(h={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"FNAME":h.file=F(r[1]),h.file.toLowerCase()==="off"&&(h.off=!0,h.file="");break;case"V":o=+r[1],isNaN(o)&&(o=100),h.volume=o;break;case"L":o=+r[1],isNaN(o)&&(o=1),h.repeat=o;break;case"P":o=+r[1],isNaN(o)&&(o=1),h.priority=o;break;case"T":r[1].length>0&&(h.type=r[1]);break;case"U":h.url=F(r[1]),!h.url.endsWith("/")&&h.url.length>0&&(h.url+="/");break}else u===0?(h.file=F(e[u]),h.file.toLowerCase()==="off"&&(h.off=!0,h.file="")):u===1?(o=+e[u],isNaN(o)&&(o=100),h.volume=o):u===2?(o=+e[u],isNaN(o)&&(o=1),h.repeat=o):u===3?(o=+e[u],isNaN(o)&&(o=1),h.priority=o):u===4?e[u].length>0&&(h.type=e[u]):u===5&&(h.url=F(e[u]),!h.url.endsWith("/")&&h.url.length>0&&(h.url+="/"));this.emit("sound",h);break;case"EXPIRE":this.emit("expire-links",e),this.cleanMXPExpired(s,e?.[0]||"");break;case"VERSION":b>0?this.StyleVersion=e[0]:this.emit("MXP-tag-reply",t,[]);break;case"USER":case"PASSWORD":this.emit("MXP-tag-reply",t,e);break;case"SUPPORT":if(l=[],b>0)for(u=0;u<b;u++)if(r=F(e[u]),r.indexOf(".")===-1)switch(r=r.toUpperCase(),r){case"IMAGE":case"HR":case"A":case"SEND":case"B":case"I":case"COLOR":case"C":case"EM":case"ITALIC":case"STRONG":case"BOLD":case"UNDERLINE":case"U":case"S":case"STRIKEOUT":case"STRIKE":case"H":case"HIGH":case"EXPIRE":case"VERSION":case"SUPPORT":case"NOBR":case"P":case"BR":case"SBR":case"SOUND":case"MUSIC":case"VAR":case"USER":case"PASSWORD":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"RESET":case"GAUGE":case"STAT":l.push("+"+name);break;default:l.push("-"+name);break}else switch(r=e[u].split("."),r[0]=r[0].toUpperCase(),r[0]){case"IMAGE":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+image.fname"),l.push("+image.url"),l.push("+image.t"),l.push("+image.h"),l.push("+image.w"),l.push("+image.hspace"),l.push("+image.vspace"),l.push("+image.align"),l.push("+image.ismap"));break;case"SOUND":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+sound.v"),l.push("+sound.l"),l.push("+sound.p"),l.push("+sound.t"),l.push("+sound.u"));break;case"MUSIC":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+music.v"),l.push("+music.l"),l.push("+music.c"),l.push("+music.t"),l.push("+music.u"));break;case"A":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+a.href"),l.push("+a.hint"),l.push("+a.expire"));break;case"SEND":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+send.href"),l.push("+send.hint"),l.push("+send.prompt"),l.push("+send.expire"));break;case"COLOR":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+color.fore"),l.push("+color.back"));break;case"C":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+c.fore"),l.push("+c.back"));break;case"FONT":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("-font.face"),l.push("-font.size"),l.push("+font.color"),l.push("+font.back"));break;case"EXPIRE":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):l.push("+expire.Name");break;case"GAUGE":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+gauge.max"),l.push("+gauge.caption"),l.push("+gauge.color"));break;case"STAT":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+stat.max"),l.push("+stat.caption"));break;default:r[1]!=="*"?l.push("-"+r[0]+"."+r[1]):l.push("-"+r[0]);break}else l=["+A","+SEND","+B","+I","+COLOR","+C","+EM","+ITALIC","+STRONG","+BOLD","+UNDERLINE","+U","+S","+STRIKEOUT","+H","+HIGH","-FONT","+EXPIRE","+VERSION","+SUPPORT","+NOBR","+P","+BR","+SBR","+VAR","+SOUND","+MUSIC","+USER","+PASSWORD","+RESET","+STRIKE","+H1","+H2","+H3","+H4","+H5","+H6","+IMAGE","+STAT","+GAUGE"];this.emit("MXP-tag-reply",t,l);break;case"A":for(o=this.CloneCurrentStyle(),o.open=!1,o.tag=Z[t],u=0;u<b;u++)if(r=e[u].split("="),r.length>1)switch(r[0].toUpperCase()){case"HREF":p=F(r[1]);break;case"HINT":g=F(r[1]);break;case"EXPIRE":T=F(r[1]);break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+r[0]);break}else u===0?p=F(e[u]):u===1?g=F(e[u]):u===2&&(T=F(e[u]));return o.custom="",o.properties={formatType:3,href:p,hint:g,expire:T},this.mxpStyles.push(o),g.length===0&&(g=p),{format:{formatType:3,href:p,hint:g,expire:T},text:null};case"SEND":for(o=this.CloneCurrentStyle(),o.open=!1,o.tag=Z[t],u=0;u<b;u++)if(r=e[u].split("="),r[0]==="PROMPT")P=!0;else if(r.length>1)switch(r[0].toUpperCase()){case"HREF":p=F(r[1]);break;case"HINT":g=F(r[1]);break;case"EXPIRE":T=F(r[1]);break;case"PROMPT":P=!0;break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+r[0]);break}else u===0?p=F(e[u]):u===1?g=F(e[u]):u===2?P=!0:u===3&&(T=F(e[u]));o.custom="",this.mxpStyles.push(o),p.length===0&&(p="&text;"),g.length===0&&(g=p);let x=p.split("|"),G;if(x.length>1){let y=g.split("|");y.length===x.length+1&&(g=y[0],y.shift(),G="['"+y.join("','")+"']"),p="['"+x.join("','")+"']"}else p="'"+p+"'";return o.properties={formatType:7,href:p,hint:g,expire:T,prompt:P,tt:G||""},{format:{formatType:7,href:p,hint:g,expire:T,prompt:P,tt:G||""},text:null};case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=Z[t],o.style|=1,o.custom="",this.mxpStyles.push(o),null;case"/A":return this.ClearMXPToTag(Z[t.substring(1)]),{format:{formatType:4},text:null};case"/SEND":return this.ClearMXPToTag(Z[t.substring(1)]),{format:{formatType:8},text:null};case"/H1":case"/H2":case"/H3":case"/H4":case"/H5":case"/H6":return this.ClearMXPToTag(Z[t.substring(1)]),null;case"NOBR":return this.mxpState.noBreak=!0,null;case"/P":return this.ClearMXPToTag(Z[t.substring(1)]),this.mxpState.paragraph=!1,null;case"P":return o=this.CloneCurrentStyle(),o.open=!1,o.tag=Z[t],o.custom="",this.mxpStyles.push(o),this.mxpState.paragraph=!0,null;case"SBR":return{format:null,text:" \u200B"};case"RESET":return this.ResetMXP(),null;case"HR":let A=this.GetCurrentStyle(),I=this.getColors(A);return{format:{formatType:0,offset:0,color:I.fore,background:I.back,size:A.fontSize,font:A.font,style:A.style|this._CurrentAttributes&-2,hr:!0},text:null}}if(this.mxpElements[t]){if(h=this.mxpElements[t],!h.open&&this.mxpState.lineType!==1&&this.mxpState.lineType!==6&&this.mxpState.lineType!==4)return null;for(o=this.CloneCurrentStyle(),o.open=h.open,o.tag=38,o.custom=h.name,r=h.definition,l={},S=0,E=h.attributeIndexes.length;S<E;S++)l[h.attributeIndexes[S]]=h.attributes[h.attributeIndexes[S]];for(u=0;u<b;u++)a=e[u].split("="),a[0]=a[0].toLowerCase(),h.attributes[a[0]]?l[a[0]]=a[1]:u<h.attributeIndexes.length&&(l[h.attributeIndexes[u]]=a[0]);for(a in l)l.hasOwnProperty(a)&&(r=r.replace("&"+a+";",l[a]));return h.empty||(this.mxpState.captured.push([]),this.mxpState.capture++),h.tag>19&&h.tag<100&&this.mxpLines[h.tag].enabled&&this.mxpLines[h.tag].definition.length>0&&(r=this.mxpLines[h.tag].definition+r,o.gagged=this.mxpLines[h.tag].gag),this.mxpState.gagged=o.gagged,this.mxpState.expanded=!0,{format:null,text:r}}else if(t.startsWith("/")&&this.mxpElements[t.substring(1)]&&!this.mxpElements[t.substring(1)].empty)return t=t.substring(1),h=this.mxpElements[t],!h.open&&this.mxpState.lineType!==1&&this.mxpState.lineType!==6&&this.mxpState.lineType!==4||(!h.empty&&this.mxpState.capture>0&&(this.mxpState.captured.length>0&&(a=this.mxpState.captured.pop().join("")),this.mxpState.capture--),r=h.closeDefinition,h.flag.length>0&&(h.flag.length>4&&h.flag.toLowerCase().startsWith("set ")&&this.emit("set-variable",h.flag.substring(4),a),this.emit("MXP-flag",h.flag,a)),h.tag>19&&h.tag<100&&this.mxpLines[h.tag].enabled&&this.mxpLines[h.tag].closeDefinition.length>0&&(r+=this.mxpLines[h.tag].closeDefinition),this.mxpState.gagged=!h.gagged,h.empty)?null:(this.mxpState.expanded=!0,{format:null,text:r});if(this.showInvalidMXPTags){switch(t){case"IMAGE":case"!AT":case"!ATTLIST":case"!TAG":case"!EL":case"!ELEMENT":case"!EN":case"!ENTITY":case"/V":case"/VAR":case"V":case"VAR":case"GAUGE":case"STAT":case"MUSIC":case"SOUND":case"EXPIRE":case"VERSION":case"USER":case"PASSWORD":case"SUPPORT":case"A":case"SEND":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"/A":case"/SEND":case"/H1":case"/H2":case"/H3":case"/H4":case"/H5":case"/H6":case"NOBR":case"/P":case"P":case"SBR":case"RESET":case"HR":return null}return{format:null,text:"<"+n+">"}}return null}cleanMXPExpired(t,e){if(!t||t.length===0||e===null)return;let i=t.length;for(let n=0;n<i;n++){let s=t[n];if(!(s.formatType!==7&&s.formatType!==3)&&(e.length===0||s.expire===e)){let o,r=0,a=0,l=s.formatType;for(s.formatType===3?o=4:o=8,s.formatType=9;a<i;a++)if(t[a].formatType===o)if(r===0){t[a].formatType=10;break}else r--;else t[a]===l&&r++}}}GetCloseTags(t){if(typeof t>"u"||t.length===0)return"";let e=0,i=t.length,n=[],s=[],o,r=0;for(;e<i;e++)switch(o=t.charAt(e),r){case 1:o===" "?(n.push(s.join("")),s=[],r=2):o===">"?(n.push(s.join("")),s=[],r=0):s.push(o);break;case 2:o===">"&&(r=0);break;default:o==="<"&&(r=1);break}return r===1&&n.push(s.join("")),n.length===0?"":"</"+n.reverse().join("></")+">"}CloneCurrentStyle(){let t;return this.mxpStyles.length===0&&this.mxpStyles.push(new Re(0,"","",!1)),t=this.mxpStyles[this.mxpStyles.length-1],this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(t.gagged=this.mxpLines[this.mxpState.lineType].gag),Object.assign({},t)}GetCurrentStyle(){let t;return this.mxpStyles.length===0&&this.mxpStyles.push(new Re(0,"","",!1)),t=this.mxpStyles[this.mxpStyles.length-1],this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(t.gagged=this.mxpLines[this.mxpState.lineType].gag),t}DecreaseColor(t,e){let i=new ee(t);return i.ok?(i.b-=Math.ceil(i.b*e),i.b<0&&(i.b=0),i.g-=Math.ceil(i.g*e),i.g<0&&(i.g=0),i.r-=Math.ceil(i.r*e),i.r<0&&(i.r=0),i.toRGB()):t}IncreaseColor(t,e){let i=new ee(t);return i.ok?(i.b+=Math.ceil(i.b*e),i.b>255&&(i.b=255),i.g+=Math.ceil(i.g*e),i.g>255&&(i.g=255),i.r+=Math.ceil(i.r*e),i.r>255&&(i.r=255),i.toRGB()):t}MXPCapture(t){if(this.mxpState.capture<1)return;let e=this.mxpState.captured.length;for(let i=0;i<e;i++)this.mxpState.captured[i].push(t)}MXPDeCapture(t){if(this.mxpState.capture<1)return;let e=this.mxpState.captured.length;for(let i=0;i<e;i++)for(let n=0;n<t;n++)this.mxpState.captured[i].pop()}isNumber(t){return/^\d+$/.test(t)}CurrentAnsiCode(){let t="\x1B[";return typeof this._CurrentForeColor=="string"?t+="38;2;"+this._CurrentForeColor:this._CurrentForeColor<=-16?t+="38;5;"+(this._CurrentForeColor*-1-16)+";":t+=this._CurrentForeColor+";",typeof this._CurrentBackColor=="string"?t+="48;2;"+this._CurrentBackColor:this._CurrentBackColor<=-16?t+="38;5;"+(this._CurrentBackColor*-1-16)+";":t+=this._CurrentBackColor+";",this._CurrentAttributes>0&&((this._CurrentAttributes&64)===64&&(t+="7;"),(this._CurrentAttributes&1)===1&&(t+="1;"),(this._CurrentAttributes&4)===4&&(t+="3;"),(this._CurrentAttributes&8)===8&&(t+="4;"),(this._CurrentAttributes&16)===16&&(t+="5;"),(this._CurrentAttributes&32)===32&&(t+="6;"),(this._CurrentAttributes&256)===256&&(t+="9;"),(this._CurrentAttributes&2)===2&&(t+="2;"),(this._CurrentAttributes&512)===512&&(t+="21;"),(this._CurrentAttributes&1024)===1024&&(t+="53;")),t+"m"}get parseQueueLength(){return this.parsing.length}get parseQueueEndOfLine(){return this.parsing.length?this.parsing[this.parsing.length-1][0].endsWith(`
`):!1}parse(t,e,i,n){if(t==null||t.length===0)return t;if(e==null&&(e=!1),this.parsing.length>0&&!i){this.parsing.push([t,e,n]);return}let s="",o=null,r=null,a=[],l=[],f=[],u=0,b=0,h=0,E,S=0,p,g,T,P,x,G=!1;this.busy=!0,this.parsing.unshift([t,e,n]);let A;if(this._SplitBuffer.length>0&&(n?t=t+this._SplitBuffer:t=this._SplitBuffer+t,this._SplitBuffer=""),!this.EndOfLine&&(this.textLength>0||this.rawLength>0)){let w=this.display.lines;w.length>0?(E=this.display.lines[w.length-1].text,P=this.display.lines[w.length-1].raw,l.push.apply(l,this.display.lines[w.length-1].formats),this.display.removeLine(w.length-1,!0),A=l[l.length-1],A.formatType===1&&(l.pop(),A=l[l.length-1]),A.width=0,A.height=0,A.marginWidth=0,A.marginHeight=0,h=A.offset,A.offset!==0?(a.push(E.substring(0,A.offset)),E=E.substring(A.offset),(this.mxpState.locked||this.mxpState.on)&&(S=E.length),t=E+t):((this.mxpState.locked||this.mxpState.on)&&(S=E.length),t=E+t),P.endsWith(E)?f.push(P.substr(0,P.length-E.length)):f.push(P)):l.push(A=this.getFormatBlock(h)),w=null}else l.push(A=this.getFormatBlock(h));let I=0,y=t.length,d,v,W=this.emulateControlCodes,K=this.displayControlCodes,ae=this.emulateTerminal,ne=this.enableURLDetection,q=this.enableMSP,_=this.tabWidth,O=0,U=0,B=0,C=0,N=null,M,z=this.protocols.length;try{for(I=0;I<y;I++)switch(d=t.charAt(I),v=t.charCodeAt(I),I>=S&&f.push(d),this.rawLength++,u){case 2:if(d==="C"||d==="K"||d==="s"||d==="u"||d==="l"||d==="h"||d==="A"||d==="B"||d==="D"||d==="E"||d==="F"||d==="f"||d==="G"||d==="H"||d==="n"||d==="S"||d==="T"||d==="r")this.ClearMXPOpen(),this._SplitBuffer="",r=null,u=0;else if(d==="z"){p=r.split(";"),r=0;for(let w=p.length-1;w>=0;w--)if(p[w].length>0){r=p[0];break}switch(E=+r,isNaN(E)&&(E=0),this.mxpState.on=!0,this.mxpState.noBreak=!1,this.mxpState.paragraph=!1,this.mxpState.lineType===0&&this.ClearMXPOpen(),E){case 2:this.mxpState.on=!1,this.mxpState.locked=!1,this.mxpState.lineType=2,this.ClearMXPOpen();break;case 3:this.ResetMXP();break;case 4:if(this.mxpState.lineType=4,I+1>=y){this._SplitBuffer+=d;break}t.charAt(I+1)!=="<"&&(this.mxpState.lineType=0,this.mxpState.on=!1),this.mxpState.locked=!1,this.ClearMXPOpen();break;case 5:this.iMXPDefaultMode=0,this.mxpState.locked=!0,this.mxpState.lineType=5,this.ClearMXPOpen();break;case 6:this.iMXPDefaultMode=1,this.mxpState.lineType=6,this.mxpState.locked=!0,this.ClearMXPOpen();break;case 7:this.iMXPDefaultMode=2,this.mxpState.lineType=7,this.mxpState.locked=!0,this.ClearMXPOpen();break;default:E<0||E>99?this.ClearMXPOpen():(this.mxpState.lineType=E,this.mxpState.locked=!1,this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(E="",this.mxpLines[this.mxpState.lineType].element.length>0&&(E+="<"+this.mxpLines[this.mxpState.lineType].element+">"),this.mxpLines[this.mxpState.lineType].definition.length>0&&(E+=this.mxpLines[this.mxpState.lineType].definition),E.length>0&&(t=t.splice(I+1,E),y=t.length)));break}this._SplitBuffer="",r=null,u=0}else if(d==="J"){if(this.ClearMXPOpen(),r.length>0&&+r==2){h=0,E=this.window.height,l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),A=this.getFormatBlock(h),...this.getMXPCloseFormatBlocks()];for(let w=0;w<E;w++)this.AddLine("",`
`,!1,!1,l,e),this.MXPCapture(`
`);this.textLength+=E,this.mxpState.noBreak=!1}l=[...this.getMXPOpenFormatBlocks(),A=this.getFormatBlock(h)],this._SplitBuffer="",r=null,u=0}else d==="m"?(this.ProcessAnsiColorParams(r.split(";")),l.push(A=this.getFormatBlock(h)),this._SplitBuffer="",r=null,u=0):d===`
`||d==="\x1B"?(I--,f.pop(),this.rawLength--,u=0,this._SplitBuffer="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen()):(this._SplitBuffer+=d,r+=d);break;case 3:v===7?(this._SplitBuffer="",this.emit("set-title",s,o??0),s="",o=null,u=0):d===";"&&o==null?(o=+s,isNaN(o)&&(o=0),s="",this._SplitBuffer+=d):d==="\x1B"?this._SplitBuffer.charAt(this._SplitBuffer.length-1)===`
`&&(this._SplitBuffer=""):(this._SplitBuffer+=d,s+=d);break;case 1:d==="["?(this._SplitBuffer+=d,r="",u=2):d==="]"?(this._SplitBuffer+=d,s="",u=3):(d==="D"||d==="E"||d==="M"||d==="1"||d==="2"||d==="7"||d==="8"||d===">"||d==="="||d==="#")&&(K&&(a.push("\u241B"),v<16?(a.push(String.fromCharCode(parseInt("240"+v.toString(16),16))),this.MXPCapture("&#x241B&#x240"+v.toString(16)+";")):(a.push(String.fromCharCode(parseInt("24"+v.toString(16),16))),this.MXPCapture("&#x241B&#x24"+v.toString(16)+";")),h+=2,this.textLength+=2,this.mxpState.noBreak=!1),u=0,this._SplitBuffer="");break;case 4:if(p==="!--")I--,f.pop(),this.rawLength--,b=0,u=8,P="<!--",p="",x=[];else if(p.endsWith("<!--"))I--,f.pop(),this.rawLength--,b=u,u=8,P="<!--",p=p.substring(0,p.length-4),x=[];else if(d==='"')u=6,x[x.length-1]+=d,this._SplitBuffer+=d;else if(d==="'")u=5,x[x.length-1]+=d,this._SplitBuffer+=d;else if(d==="&")T="",b=u,u=7,this._SplitBuffer="";else if(d===`
`||d==="\x1B")I--,f.pop(),this.rawLength--,u=0,this._SplitBuffer="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen();else if(d===" ")u=9,x.push(""),this._SplitBuffer+=d;else if(d===">"){if(g=p,p=p.toUpperCase(),p==="HR"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))h>0&&(h=0,this.MXPCapture(`
`),l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),A=this.getFormatBlock(h)]),p=this.getMXPBlock(p,[],e),p&&p.format&&(p.format.offset=h,l.push(p.format),l[0].hr=p.format.hr),l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),this.textLength++,a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),A=this.getFormatBlock(h)];else if(p==="BR"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))this.MXPCapture(`
`),l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),G=!1,h=0,a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),A=this.getFormatBlock(h)],this.textLength++;else if(p==="IMAGE"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))p=this.getMXPBlock(p,x,e),p&&p.format!==null&&(l.push(p.format),h+=p.length,this.textLength+=p.length),l.push(A=this.getFormatBlock(h));else{if(p=this.getMXPBlock(p,[],e,g,l),this.mxpState.expanded){p&&p.text!==null&&(t=t.splice(I+1,p.text)),y=t.length,this.mxpState.expanded=!1,u=0,p="",this._SplitBuffer="";continue}p?(p.format&&(p.format.offset=h,l.push(p.format)),l.push(A=this.getFormatBlock(h)),p.text!==null&&p.text.length>0&&(a.push(p.text),h+=p.text.length,this.textLength+=p.text.length)):l.push(A=this.getFormatBlock(h))}u=0,this._SplitBuffer=""}else d==="<"?(this.enableDebug&&this.emit("debug","Malformed MXP Tag: "+p),I--,f.pop(),this.rawLength--,a.push("<"+p),h+=p.length+1,this.textLength+=p.length+1,u=0,this._SplitBuffer=""):(this._SplitBuffer+=d,p+=d);break;case 5:d==="'"?(u=9,this._SplitBuffer+=d,x[x.length-1]+=d):(this._SplitBuffer+=d,x[x.length-1]+=d);break;case 6:d==='"'?(u=9,this._SplitBuffer+=d,x[x.length-1]+=d):(this._SplitBuffer+=d,x[x.length-1]+=d);break;case 9:if(d==="'")u=5,x[x.length-1]+=d,this._SplitBuffer+=d;else if(d==='"')u=6,x[x.length-1]+=d,this._SplitBuffer+=d;else if(d===`
`||d==="\x1B")I--,f.pop(),this.rawLength--,u=0,this._SplitBuffer="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen();else if(d===" ")u=9,x.push(""),this._SplitBuffer+=d;else if(d===">"){if(p.toUpperCase()==="IMAGE"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))p=this.getMXPBlock(p,x,e,p),p!==null&&p.format!==null&&(p.format.offset=h,l.push(p.format)),l.push(A=this.getFormatBlock(h));else{if(p=this.getMXPBlock(p,x,e,p,l),this.mxpState.expanded){p!==null&&(t=t.splice(I+1,p.text)),y=t.length,this.mxpState.expanded=!1,u=0,this._SplitBuffer="";continue}p!==null?(p!==null&&p.format&&(p.format.offset=h,l.push(p.format)),l.push(A=this.getFormatBlock(h)),p.text!==null&&(a.push(p.text),h+=p.text.length,this.textLength+=p.text.length)):l.push(A=this.getFormatBlock(h))}u=0,this._SplitBuffer=""}else this._SplitBuffer+=d,x[x.length-1]+=d;break;case 7:if(d===`
`||d==="\x1B"){if(I--,f.pop(),this.rawLength--,this.enableDebug&&this.emit("debug","MXP Entity: "+T),b===4)p+="&"+T,u=b;else{if(T=this.GetEntity(T),this.mxpState.expanded){p!==null&&(t=t.splice(I+1,T)),y=t.length,this.mxpState.expanded=!1,u=0,this._SplitBuffer="";continue}g=yt("&"+T),a.push(g),this.MXPCapture("&"+T),h+=g.length,this.textLength+=g.length,this.mxpState.noBreak=!1,u=0,this._SplitBuffer="",A.unicode=!0}this.mxpState.on&&d===`
`&&this.ClearMXPOpen()}else if(d===";"){if(this.enableDebug&&this.emit("debug","MXP Entity: "+T),b!==4){if(T=this.GetEntity(T),this.mxpState.expanded){t=t.splice(I+1,T),y=t.length,this.mxpState.expanded=!1,u=b,this._SplitBuffer="";continue}g=yt("&"+T+";"),a.push(g),this.MXPCapture("&"),this.MXPCapture(T),this.MXPCapture(";"),h+=g.length,this.textLength+=g.length,this.mxpState.noBreak=!1,this._SplitBuffer=""}else p+="&"+T+";";A.unicode=!0,u=b}else d==="&"?(this.enableDebug&&this.emit("debug","Malformed MXP Entity: "+T),b!==4?(a.push("&"+T),this.MXPCapture("&"),this.MXPCapture(T),h+=T.length+1,this.textLength+=T.length+1,this.mxpState.noBreak=!1,this._SplitBuffer="",I--,f.pop(),this.rawLength--):p+="&"+T,A.unicode=!0,u=b):(this._SplitBuffer+=d,T+=d);break;case 8:P.endsWith("-->")?(this.enableDebug&&this.emit("debug","MXP Comment: "+P),I--,f.pop(),this.rawLength--,u=b,u===0&&(this._SplitBuffer=""),P=""):d===`
`||d==="\x1B"?(this.enableDebug&&this.emit("debug","MXP Comment: "+P),I--,f.pop(),this.rawLength--,u=b,P="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen()):P+=d;break;case 10:if(I>O+2)a.pop(),a.pop(),f.pop(),f.pop(),this.rawLength-=2,h-=2,this.textLength-=2,this.MXPDeCapture(2),I=O,u=0;else if(d==="/"){if(a.push(d),this.MXPCapture(d),h++,this.textLength++,I===O+2){for(u=11,O=a.length-4,C=a.length-1,U=l.length,B-=2;O>0&&Ke(a[O],!0);)O--,B--;Ke(a[O],!0)||(O++,B++),N=[],O>0&&a[O-1]==="("&&N.push(")"),O>0&&a[O-1]==="["&&N.push("]")}}else I>O+1?(a.pop(),f.pop(),this.rawLength--,h--,this.textLength--,this.MXPDeCapture(1),I=O,u=0):(I=O,u=0,f.pop(),this.rawLength--);break;case 11:Ke(d,!1)?N.length>1&&N[N.length-1]===d?(N.pop(),a.push(d),this.MXPCapture(d),h++,this.textLength++,v>255&&(A.unicode=!0)):N.length>0&&d==="("?(N.push(")"),a.push(d),this.MXPCapture(d),h++,this.textLength++,v>255&&(A.unicode=!0)):N.length>0&&d==="["?(N.push("]"),a.push(d),this.MXPCapture(d),h++,this.textLength++,v>255&&(A.unicode=!0)):N.length===1&&N[N.length-1]===d?(C!==a.length-1&&(P+=a.slice(O).join(""),this.enableDebug&&this.emit("debug","URL Found: "+P),l.splice(U,0,{formatType:1,href:P,offset:B}),l.push({formatType:2,href:P,offset:h}),l.push(A=this.getFormatBlock(h))),u=0,I--,f.pop(),this.rawLength--):(v>255&&(A.unicode=!0),a.push(d),this.MXPCapture(d),h++,this.textLength++):(C!==a.length-1&&(P+=a.slice(O).join(""),this.enableDebug&&this.emit("debug","URL Found: "+P),l.splice(U,0,{formatType:1,offset:B,href:P}),l.push({formatType:2,offset:h,href:P}),l.push(A=this.getFormatBlock(h))),u=0,I--,f.pop(),this.rawLength--);break;case 12:d===")"?(O=this.mxpState.lineType,this.mxpState.lineType=4,this.getMXPBlock("SOUND",x,e),this.mxpState.lineType=O,u=0,I+1<y&&t.charAt(I+1)===`
`?(I++,G=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),A=this.getFormatBlock(h)],this.mxpState.noBreak=!1,h=0):I+2<y&&t[I+1]==="\r"&&t[I+2]===`
`&&(I+=2,G=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),A=this.getFormatBlock(h)],this.mxpState.noBreak=!1,h=0)):d===" "?x.push(""):x[x.length-1]+=d;break;case 13:d===")"?(O=this.mxpState.lineType,this.mxpState.lineType=4,this.getMXPBlock("MUSIC",x,e),this.mxpState.lineType=O,u=0,I+1<y&&t.charAt(I+1)===`
`?(I++,G=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),A=this.getFormatBlock(h)],this.mxpState.noBreak=!1,h=0):I+2<y&&t[I+1]==="\r"&&t[I+2]===`
`&&(I+=2,G=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),A=this.getFormatBlock(h)],this.mxpState.noBreak=!1,h=0)):d===" "?x.push(""):x[x.length-1]+=d;break;default:if(W&&v===7)ae?(d="\u2407",a.push(d),this.MXPCapture(d),h++,this.textLength++,this.mxpState.noBreak=!1):K&&(a.push(d),this.MXPCapture("&#x2407;"),h++,this.textLength++,this.mxpState.noBreak=!1),this.emit("bell");else if(W&&d==="\b"){if(G=!1,h>0){if(a.length){for(;a[a.length-1].length===0;)a.pop();a[a.length-1].length===1?a.pop():a[a.length-1]=a[a.length-1].substring(0,a[a.length-1].length-1)}A.offset===h&&A.offset--,h--,this.textLength--}K&&(d="\u25D8",a.push(d),this.MXPCapture(d),h++,this.textLength++),this.mxpState.noBreak=!1}else if(W&&d==="	"){let w=_-h%_;w>0&&(a.push(Array(w+1).join(" ")),this.MXPCapture(Array(w+1).join(" ")),h+=w,this.textLength+=w,this.mxpState.noBreak=!1)}else if(d===`
`){if(this.mxpState.noBreak||this.mxpState.paragraph)continue;if(this.mxpState.locked)l.push(...this.getMXPCloseFormatBlocks()),this.mxpState.on&&this.ClearMXPOpen();else{if(this.mxpState.lineType!==0&&this.emit("MXP-tag-end",this.mxpState.lineType,a.join(""),l),!this.mxpState.lineExpanded&&this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(E="",this.mxpLines[this.mxpState.lineType].element.length>0&&(E+="</"+this.mxpLines[this.mxpState.lineType].element+">"),this.mxpLines[this.mxpState.lineType].closeDefinition.length>0&&(E+=this.mxpLines[this.mxpState.lineType].closeDefinition),E.length>0)){t=t.splice(I,E),y=t.length,I--,f.pop(),this.rawLength--,this.mxpState.lineExpanded=!0;continue}this.mxpState.lineExpanded=!1,l.push(...this.getMXPCloseFormatBlocks()),this.mxpState.on&&this.ClearMXPOpen(),this.mxpState.on=!1,this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&this.mxpLines[this.mxpState.lineType].gag&&(G=!0),this.mxpState.lineType=this.iMXPDefaultMode,this.mxpState.lineType!==2&&!this.enableMXP&&this.ResetMXP()}h=0,G||this.MXPCapture(`
`),this.AddLine(a.join(""),f.join(""),!1,G,l,e),G=!1,a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),A=this.getFormatBlock(h)],this.textLength++,this.mxpState.noBreak=!1}else{if(W&&d==="\r")continue;if(W&&d==="\x1B")this._SplitBuffer+=d,u=1;else if(v<32||v===127)if(ae)v===1?d="\u263A":v===2?d="\u263B":v===3?d="\u2665":v===4?d="\u2666":v===5?d="\u2663":v===6?d="\u2660":v===7?d="\u2407":v===8?d="\u25D8":v===9?d="\u25CB":v===10?d="\u25D9":v===11?d="\u2642":v===12?d="\u2640":v===13?d="\u266A":v===14?d="\u266B":v===15?d="\u263C":v===16?d="\u25BA":v===17?d="\u25C4":v===18?d="\u2195":v===19?d="\u203C":v===20?d="\xB6":v===21?d="\xA7":v===22?d="\u25AC":v===23?d="\u21A8":v===24?d="\u2191":v===25?d="\u2193":v===26?d="\u2192":v===27?d="\u2190":v===28?d="\u221F":v===29?d="\u2194":v===30?d="\u25B2":v===31?d="\u25BC":v===127&&(d="\u2302"),a.push(d),this.MXPCapture(d),h++,this.textLength++,this.mxpState.noBreak=!1;else if(K)v=9216+v,a.push(String.fromCharCode(v)),this.MXPCapture("&#"),this.MXPCapture(v.toString()),this.MXPCapture(";"),h++,this.textLength++,this.mxpState.noBreak=!1;else continue;else if(d===" "||this._CurrentAttributes>0&&(this._CurrentAttributes&128)===128)a.push(" "),this.MXPCapture(" "),h++,this.textLength++,this.mxpState.noBreak=!1;else if(d==="<"&&I>=S)this.enableMXP&&this.mxpState.on?(p="",x=[],this._SplitBuffer+=d,u=4):(a.push("<"),this.MXPCapture("&lt;"),h++,this.textLength++);else if(d===">")a.push(">"),this.MXPCapture("&gt;"),h++,this.textLength++,this.mxpState.noBreak=!1;else if(d==="&"&&I>=S)this.enableMXP&&this.mxpState.on?(T="",this._SplitBuffer+=d,b=u,u=7):(a.push(d),h++,this.textLength++,this.mxpState.noBreak=!1);else if(d==='"')a.push(d),this.MXPCapture("&quot;"),h++,this.textLength++,this.mxpState.noBreak=!1;else if(d==="'")a.push(d),this.MXPCapture("&apos;"),h++,this.textLength++,this.mxpState.noBreak=!1;else if(d===":"){if(a.push(d),this.MXPCapture(d),h++,this.textLength++,this.mxpState.noBreak=!1,ne){P="";let w,V=!1;for(M=0;M<z;M++){if(I-this.protocols[M].length<0)continue;w=!1;let D=this.protocols[M].length;for(let L=0;L<D;L++)if(t[I-(D-L)]!==this.protocols[M][L]){w=!0;break}if(!w&&(O=a.length,B=h,U=l.length,!(O>1+D&&a[O-(2+D)].length===1&&/\S/.test(a[O-(2+D)])&&a[O-(2+D)]!=="("&&a[O-(2+D)]!=="[")&&(N=[],O=a.length-(1+D),B-=1+D,C=a.length-1,O>0&&a[O-1]==="("&&N.push(")"),O>0&&a[O-1]==="["&&N.push("]"),u=11,V=!0,V)))break}V||(u=10,O=I,B=h)}}else if(d==="."){if(a.push(d),this.MXPCapture(d),h++,this.textLength++,this.mxpState.noBreak=!1,ne&&I-3>=0&&(P="http://",(t[I-1]==="w"||I[O-1]==="W")&&(t[I-2]==="w"||I[O-2]==="W")&&(t[I-3]==="w"||I[O-3]==="W"))){if(O=a.length,B=h,U=l.length,O>4&&a[O-5].length===1&&/\S/.test(a[O-5])&&a[O-5]!=="("&&a[O-5]!=="[")continue;N=[],O=a.length-4,B-=4,C=a.length-1,O>0&&a[O-1]==="("&&N.push(")"),O>0&&a[O-1]==="["&&N.push("]"),u=11}}else q&&h===0&&t.substring(I,I+8)==="!!MUSIC("?(x=[""],u=13,I+=7,this.mxpState.noBreak=!1):q&&h===0&&t.substring(I,I+8)==="!!SOUND("?(x=[""],u=12,I+=7,this.mxpState.noBreak=!1):(ae&&v>127&&v<255?v===128?d="\xC7":v===129?d="\xFC":v===130?d="\xE9":v===131?d="\xE2":v===132?d="\xE4":v===133?d="\xE0":v===134?d="\xE5":v===135?d="\xE7":v===136?d="\xEA":v===137?d="\xEB":v===138?d="\xE8":v===139?d="\xEF":v===140?d="\xEE":v===141?d="\xEC":v===142?d="\xC4":v===143?d="\xC5":v===144?d="\xC9":v===145?d="\xE6":v===146?d="\xC6":v===147?d="\xF4":v===148?d="\xF6":v===149?d="\xF2":v===150?d="\xFB":v===151?d="\xF9":v===152?d="\xFF":v===153?d="\xD6":v===154?d="\xDC":v===155?d="\xA2":v===156?d="\xA3":v===157?d="\xA5":v===158?d="\u20A7":v===159?d="\u0192":v===160?d="\xE1":v===161?d="\xED":v===162?d="\xF3":v===163?d="\xFA":v===164?d="\xF1":v===165?d="\xD1":v===166?d="\xAA":v===167?d="\xBA":v===168?d="\xBF":v===169?d="\u2310":v===170?d="\xAC":v===171?d="\xBD":v===172?d="\xBC":v===173?d="\xA1":v===174?d="\xAB":v===175?d="\xBB":v===176?d="\u2591":v===177?d="\u2592":v===178?d="\u2593":v===179?d="\u2502":v===180?d="\u2524":v===181?d="\u2561":v===182?d="\u2562":v===183?d="\u2556":v===184?d="\u2555":v===185?d="\u2563":v===186?d="\u2551":v===187?d="\u2557":v===188?d="\u255D":v===189?d="\u255C":v===190?d="\u255B":v===191?d="\u2510":v===192?d="\u2514":v===193?d="\u2534":v===194?d="\u252C":v===195?d="\u251C":v===196?d="\u2500":v===197?d="\u253C":v===198?d="\u255E":v===199?d="\u255F":v===200?d="\u255A":v===201?d="\u2554":v===202?d="\u2569":v===203?d="\u2566":v===204?d="\u2560":v===205?d="\u2550":v===206?d="\u256C":v===207?d="\u2567":v===208?d="\u2568":v===209?d="\u2564":v===210?d="\u2565":v===211?d="\u2559":v===212?d="\u2558":v===213?d="\u2552":v===214?d="\u2553":v===215?d="\u256B":v===216?d="\u256A":v===217?d="\u2518":v===218?d="\u250C":v===219?d="\u2588":v===220?d="\u2584":v===221?d="\u258C":v===222?d="\u2590":v===223?d="\u2580":v===224?d="\u03B1":v===225?d="\u03B2":v===226?d="\u0393":v===227?d="\u03C0":v===228?d="\u03A3":v===229?d="\u03C3":v===230?d="\xB5":v===231?d="\u03C4":v===232?d="\u03A6":v===233?d="\u0398":v===234?d="\u03A9":v===235?d="\u03B4":v===236?d="\u221E":v===237?d="\u2205":v===238?d="\u2208":v===239?d="\u2229":v===240?d="\u2261":v===241?d="\xB1":v===242?d="\u2265":v===243?d="\u2264":v===244?d="\u2320":v===245?d="\u2321":v===246?d="\xF7":v===247?d="\u2248":v===248?d="\xB0":v===249?d="\u2219":v===250?d="\xB7":v===251?d="\u221A":v===252?d="\u207F":v===253?d="\xB2":v===254&&(d="\u25A0"):v>255&&(A.unicode=!0),a.push(d),this.MXPCapture(d),h++,this.textLength++,this.mxpState.noBreak=!1)}break}this._SplitBuffer.length&&(this.rawLength-=this._SplitBuffer.length,f.splice(f.length-this._SplitBuffer.length,this._SplitBuffer.length)),l.push(...this.getMXPCloseFormatBlocks()),u===11&&l.splice(U,0,{formatType:1,offset:B,href:P+=a.slice(O).join("")}),this.AddLine(a.join(""),f.join(""),!0,!1,l,e)}catch(w){this.enableDebug&&this.emit("debug",w)}this.busy=!1,this.emit("parse-done"),this.parsing.shift(),this.parsing.length>0&&setTimeout(this.parseNext(),0)}parseNext(){let t=this.parsing.shift();return()=>{this.parse(t[0],t[1],!0,t[2])}}updateWindow(t,e){this.window={width:t,height:e}}Clear(){this.ResetColors(),this.textLength=0,this._SplitBuffer=""}ClearMXP(){this.mxpEntities={},this.ResetMXP(),this.mxpElements={},this.mxpState=new lt}ResetMXP(){this.mxpStyles=[],this.mxpStyles.push(new Re(0,"","",!1))}ResetMXPLine(){this.iMXPDefaultMode=0,this.mxpState.lineType=0}GetPublicEntity(t){return this.mxpEntities[t]&&this.mxpEntities[t].publish?this.mxpEntities[t].value:t}};var Qe=class extends ie{constructor(t,e){super();this._updating=0;this._enableDebug=!1;this._maxView=0;this._padding=[0,0,0,0];this._enableColors=!0;this._enableBackgroundColors=!0;this._hideTrailingEmptyLine=!0;this._maxLines=500;this._wordWrap=!1;this._indent=4;this._indentPadding=0;this._wrapAt=0;this._scrollAtEnd=!1;this._lineCache=[];this._expireCache=[];this._timestamp=0;this._timestampFormat="[[]MM-DD HH:mm:ss.SSS[]] ";this._timestampWidth=new Date().toISOString().length+1;this._mouseDown=!1;this.scrollLock=!1;if(!t)throw new Error("Container must be a selector, element or jquery object");if(typeof t=="object"&&"container"in t&&(e=Object.assign(e||{},t),t=e.container,delete e.container),typeof t=="string"){if(this._container=document.querySelector(t),!this._container)throw new Error("Invalid selector for display.")}else if(t instanceof $)this._container=t[0];else if(t instanceof HTMLElement)this._container=t;else throw new Error("Container must be a selector, element or jquery object");this._styles=document.createElement("style"),this._container.appendChild(this._styles),this._character=document.createElement("span"),this._character.id=this.id+"-Character",this._character.className="line",this._character.innerHTML='<span style="border-bottom: 1px solid rgb(0, 0, 0);">W</span>',this._character.style.visibility="hidden",this._container.appendChild(this._character),this._view=document.createElement("div"),this._view.className="view",this._view.addEventListener("scroll",()=>{this._scrollAtEnd=this._view.clientHeight+this._view.scrollTop>=this._view.scrollHeight}),this._view.addEventListener("click",i=>{this.emit("click",i)}),this._view.addEventListener("contextmenu",i=>{this.emit("contextmenu",i)}),this._view.addEventListener("mousedown",i=>{this.emit("mousedown",i),this._mouseDown=!0}),this._view.addEventListener("mouseup",i=>{this.emit("mouseup",i),this._mouseDown&&this.emit("selection-done"),this._mouseDown=!1}),this._container.appendChild(this._view),this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width),e?e.display=this:e={display:this},this.model=new kt(e),this._wResize=i=>{this._scrollAtEnd&&this.scrollDisplay(),Je(()=>{this.doUpdate(17)},250,"resize")},this._selection=i=>{this._mouseDown&&Je(()=>{this.emit("selection-changed")},250,"selection-changed")},window.addEventListener("resize",this._wResize.bind(this)),document.addEventListener("selectionchange",this._selection.bind(this)),this._resizeObserver=new ResizeObserver((i,n)=>{i.length!==0&&(!i[0].contentRect||i[0].contentRect.width===0||i[0].contentRect.height===0||Je(()=>{(!this._resizeObserverCache||this._resizeObserverCache.width!==i[0].contentRect.width||this._resizeObserverCache.height!==i[0].contentRect.height)&&(this._scrollAtEnd&&this.scrollDisplay(),this._resizeObserverCache={width:i[0].contentRect.width,height:i[0].contentRect.height},this.doUpdate(17),this.emit("resize"))},250,"resize"))}),this._resizeObserver.observe(this._container),this._observer=new MutationObserver(i=>{let n;for(n of i)n.type==="attributes"&&n.attributeName==="style"&&(this._scrollAtEnd&&this.scrollDisplay(),this.doUpdate(17),this.emit("resize"))}),this._observer.observe(this._container,{attributes:!0,attributeOldValue:!0,attributeFilter:["style"]}),!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.updateFont()}get showTimestamp(){return this._timestamp}set showTimestamp(t){t!==this._timestamp&&(this._timestamp=t,!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.buildStyleSheet(),this.doUpdate(35))}get timestampFormat(){return this._timestampFormat}set timestampFormat(t){this._timestampFormat!==t&&(this._timestampFormat=t,!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.doUpdate(51))}get wordWrap(){return this._wordWrap}set wordWrap(t){t!==this._wordWrap&&(this._wordWrap=t,this.buildStyleSheet(),this.doUpdate(1))}get wrapAt(){return this._wrapAt}set wrapAt(t){t!==this._wrapAt&&(this._wrapAt=t,this.buildStyleSheet(),this.doUpdate(3))}get indent(){return this._indent}set indent(t){t!==this._indent&&(this._indent=t,this.buildStyleSheet(),this.doUpdate(3))}get linkFunction(){return this._linkFunction||"doLink"}set linkFunction(t){this._linkFunction=t}get mxpLinkFunction(){return this._mxpLinkFunction||"doMXPLink"}set mxpLinkFunction(t){this._mxpLinkFunction=t}get mxpSendFunction(){return this._mxpSendFunction||"doMXPSend"}set mxpSendFunction(t){this._mxpSendFunction=t}get mxpTooltipFunction(){return this._mxpTooltipFunction||"doMXPTooltip"}set mxpTooltipFunction(t){this._mxpTooltipFunction=t}get id(){return this._container?this._container.id:""}get container(){return this._container}get lines(){return this._model.lines}get model(){return this._model}set model(t){this._model!==t&&(this._model&&this._model.removeAllListeners(),this._model=t,this._model.on("debug",this.debug,this),this._model.on("bell",()=>{this.emit("bell")}),this._model.on("add-line",e=>{this.emit("add-line",e)}),this._model.on("add-line-done",e=>{this.emit("add-line-done",e)}),this._model.on("line-added",(e,i)=>{this._lineCache.push(this.getLineHTML(e.idx))}),this._model.on("expire-links",e=>{if(this._expireCache.length){let i,n;for(let s=0,o=this._expireCache.length;s<o;s++)this.rebuildLine(this._expireCache[s])}this._expireCache=[],this.emit("expire-links")}),this._model.on("parse-done",()=>{this._view.insertAdjacentHTML("beforeend",this._lineCache.join("")),this._lineCache=[],this.doUpdate(2),this.emit("parse-done")}),this._model.on("set-title",(e,i)=>{this.emit("set-title",e,i)}),this._model.on("music",e=>{this.emit("music",e)}),this._model.on("sound",e=>{this.emit("sound",e)}),this._model.on("MXP-tag-reply",(e,i)=>{this.emit("MXP-tag-reply",e,i)}),this._model.on("expire-link-line",e=>{this._expireCache.push(e),this.doUpdate(2)}))}get maxLines(){return this._maxLines}set maxLines(t){t!==this._maxLines&&(this._maxLines=t,this.doUpdate(4))}get enableDebug(){return this._enableDebug}get enableColors(){return this._enableColors}set enableColors(t){t!==this._enableColors&&(this._enableColors=t,this.buildStyleSheet())}get enableBackgroundColors(){return this._enableBackgroundColors}set enableBackgroundColors(t){t!==this._enableBackgroundColors&&(this._enableBackgroundColors=t,this.buildStyleSheet())}get hideTrailingEmptyLine(){return this._hideTrailingEmptyLine}set hideTrailingEmptyLine(t){t!==this._hideTrailingEmptyLine&&(this._hideTrailingEmptyLine=t,this.doUpdate(2))}set enableDebug(t){this._enableDebug=t,this._model.enableDebug=t}get tabWidth(){return this._model.tabWidth}set tabWidth(t){this._model.tabWidth=t}get textLength(){return this._model.textLength}get EndOfLine(){return this._model.EndOfLine}get parseQueueLength(){return this._model.parseQueueLength}get parseQueueEndOfLine(){return this._model.parseQueueEndOfLine}get EndOfLineLength(){return this.lines.length===0?0:this.lines[this.lines.length-1].text.length}set enableFlashing(t){this._model.enableFlashing=t}get enableFlashing(){return this._model.enableFlashing}set enableMXP(t){this._model.enableMXP=t}get enableMXP(){return this._model.enableMXP}set showInvalidMXPTags(t){this._model.showInvalidMXPTags=t}get showInvalidMXPTags(){return this._model.showInvalidMXPTags}set enableBell(t){this._model.enableBell=t}get enableBell(){return this._model.enableBell}set enableURLDetection(t){this._model.enableURLDetection=t}get enableURLDetection(){return this._model.enableURLDetection}set enableMSP(t){this._model.enableMSP=t}get enableMSP(){return this._model.enableMSP}set displayControlCodes(t){this._model.displayControlCodes=t}get displayControlCodes(){return this._model.displayControlCodes}set emulateTerminal(t){this._model.emulateTerminal=t}get emulateTerminal(){return this._model.emulateTerminal}set emulateControlCodes(t){this._model.emulateControlCodes=t}get emulateControlCodes(){return this._model.emulateControlCodes}set MXPStyleVersion(t){this._model.MXPStyleVersion=t}get MXPStyleVersion(){return this._model.MXPStyleVersion}get WindowSize(){return new Me(this.WindowWidth,this.WindowHeight)}get WindowWidth(){return Math.trunc(this._maxView/this._charWidth)}get WindowHeight(){return this._view.scrollWidth>this._view.clientWidth?Math.trunc((this._innerHeight-Et()-this._padding[0]-this._padding[2])/this._charHeight):Math.trunc((this._innerHeight-this._padding[0]-this._padding[2])/this._charHeight)}get html(){let t=this.lines.length,e=[];for(let i=0;i<t;i++)e.push(this.getLineHTML(i));return e.join("")}get text(){return this._model.text}get raw(){return this._model.raw}get scrollAtBottom(){return this._scrollAtEnd}debug(t){this.emit("debug",t)}scrollDisplay(){this.scrollLock||(this._view.scrollTop=this._view.scrollHeight)}scrollTo(t,e){this._view.scrollTo(t,e)}scrollToCharacter(t,e){this._view.scrollTo(t*this._charHeight,e*this._charWidth)}scrollBy(t,e){this._view.scrollBy(t,e)}scrollUp(){this._view.scrollBy(0,-this._charHeight)}scrollDown(){this._view.scrollBy(0,this._charHeight)}pageUp(){this._view.scrollBy(0,-this._view.clientHeight)}pageDown(){this._view.scrollBy(0,this._view.clientHeight)}trimLines(){if(this._maxLines!==-1&&this.lines.length>this._maxLines){let t=this.lines.length-this._maxLines,e=t;for(;e-- >0;)this._view.removeChild(this._view.firstChild);this._model.removeLines(0,t)}}append(t,e,i,n){this._model.append(t,e||!1,i||!1,n||!1)}CurrentAnsiCode(){return this._model.CurrentAnsiCode()}removeLine(t,e){if(t<0||t>=this.lines.length)return;this.emit("line-removed",t,this.lines[t].text);let i=this._model.getLineID(t),n=document.querySelector(`[data-id="${i}"]`);this._view.removeChild(n),this._model.removeLine(t)}removeLines(t,e){t<0||t>=this.lines.length||(e<1&&(e=1),this.emit("lines-removed",t,this.lines.slice(t,t+e-1)),this._view.replaceChildren(...[].slice.call(this._view.children,0,t),...[].slice.call(this._view.children,t+e)),this._model.removeLines(t,e))}updateDisplay(){this._view.classList.remove("animate"),this.doUpdate(4),this._hideTrailingEmptyLine&&this.lines.length&&this.lines[this.lines.length-1].text.length===0&&(this._view.lastChild.style.display="none"),this.doUpdate(24),this._view.classList.add("animate")}updateWindow(t,e){t===void 0&&(t=this.WindowWidth,e=this.WindowHeight),this._model.updateWindow(t,e),this.emit("update-window",t,e)}clear(){this._model.clear(),this._view.innerHTML=""}dispose(){for(document.body.removeChild(this._character),document.body.removeChild(this._styles);this._container.firstChild;)this._view.removeChild(this._view.firstChild);window.removeEventListener("resize",this._wResize),document.removeEventListener("selectionchange",this._selection)}update(){let t=Et();this._maxView=this._view.clientWidth-this._padding[1]-this._padding[3]-t-this._indentPadding,this._timestamp!==0&&(this._maxView-=this._timestampWidth*this._charWidth),this._innerHeight=this._view.clientHeight}updateFont(t,e){!t||t.length===0?t='"Courier New", Courier, monospace':t+=", monospace",(!e||e.length===0)&&(e="1em"),(t!==this._container.style.fontFamily||e!==this._container.style.fontSize)&&(this._container.style.fontSize=e,this._container.style.fontFamily=t,this._character.style.fontSize=e,this._character.style.fontFamily=t,this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width),setTimeout(()=>{this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width)},250),this.buildStyleSheet(),this.doUpdate(25));let i=window.getComputedStyle(this._view),n=[parseInt(i.getPropertyValue("padding-top"))||0,parseInt(i.getPropertyValue("padding-right"))||0,parseInt(i.getPropertyValue("padding-bottom"))||0,parseInt(i.getPropertyValue("padding-left"))||0];(n[0]!==this._padding[0]||n[1]!==this._padding[1]||n[2]!==this._padding[2]||n[3]!==this._padding[3])&&(this._padding=n,this.doUpdate(1))}buildStyleSheet(){let t="";this._enableColors||(t+=".view > span span {color: inherit !important;}"),(!this._enableColors||!this._enableBackgroundColors)&&(t+=".background > span span {background-color: inherit !important;}"),this._wordWrap?t+=".view {white-space: break-spaces; }":this._wrapAt>0&&(t+=`.view {white-space: break-spaces; } .line {width: ${this._wrapAt*this._charWidth}px !important;max-width:  ${this._wrapAt*this._charWidth}px;min-width:  ${this._wrapAt*this._charWidth}px;display: block;}`),(this._wordWrap||this._wrapAt>0)&&this._indent>0&&(t+=`.view {  padding-left: 0px !important; text-indent: ${this._indent*this._charWidth}px hanging; }`),t+=`.line > span { min-height: ${this._charHeight}}`,this._timestamp!==0&&(t+=".timestamp { display: inline-block; }"),this._styles.innerHTML=t,(this._wordWrap||this._wrapAt>0)&&this._indent>0?this._indentPadding=parseFloat(window.getComputedStyle(this._view).paddingLeft)/2:this._indentPadding=0}getLineHTML(t,e,i,n){t===void 0||t>=this.lines.length?t=this.lines.length-1:t<0&&(t=0),(e===void 0||e<0)&&(e=0),(i===void 0||i===-1)&&(i=this.lines[t].text.length);let s=[],o=0,r="",a="",l=this.lines[t].text,f=this.lines[t].formats,u=f.length,b=!1,h=this._model.getLineID(t);this._timestamp===2&&moment?s.push('<span class="timestamp" style="color:',this._model.GetColor(-7),";background:",this._model.GetColor(-8),';"',a,">",moment(this.lines[t].timestamp).format(this._timestampFormat),"</span>"):this._timestamp===1&&s.push('<span class="timestamp" style="color:',this._model.GetColor(-7),";background:",this._model.GetColor(-8),';"',a,">",new Date(this.lines[t].timestamp).toISOString()," </span>");for(let E=0;E<u;E++){let S=f[E],p,g,T=[];if(E<u-1){if(p=f[E+1],S.offset===p.offset&&p.formatType===S.formatType)continue;g=p.offset}else g=l.length;if(o=S.offset,g>i&&(g=i),o<e&&(o=e),S.formatType===0){if(r=[],a=[],typeof S.background=="number"?r.push("background:",this._model.GetColor(S.background),";"):S.background&&r.push("background:",S.background,";"),typeof S.color=="number"?r.push("color:",this._model.GetColor(S.color),";"):S.color&&r.push("color:",S.color,";"),S.font&&r.push("font-family: ",S.font,";"),S.size&&r.push("font-size: ",S.size,";"),S.style!==0?((S.style&1)===1&&r.push("font-weight: bold;"),(S.style&4)===4&&r.push("font-style: italic;"),(S.style&1024)===1024&&T.push("overline "),((S.style&512)===512||(S.style&8)===8)&&T.push("underline "),(S.style&512)===512?r.push("border-bottom: 1px solid ",typeof S.color=="number"?this._model.GetColor(S.color):S.color,";"):r.push("border-bottom: 1px solid ",typeof S.background=="number"?this._model.GetColor(S.background):S.background,";"),((S.style&32)===32||(S.style&16)===16)&&(this.enableFlashing?a.push(" ansi-blink"):(S.style&512)!==512&&(S.style&8)!==8&&T.push("underline ")),(S.style&256)===256&&T.push("line-through "),T.length>0&&r.push("text-decoration:",T.join("").trim(),";")):r.push("border-bottom: 1px solid ",typeof S.background=="number"?this._model.GetColor(S.background):S.background,";"),o<e||g<e)continue;r=r.join("").trim(),a.length!==0?a=' class="'+a.join("").trim()+'"':a="",S.hr?s.push('<span style="',r,'min-width:100%;width:100%;"',a,'><div style="position:relative;top: 50%;transform: translateY(-50%);height:4px;width:100%; background-color:',typeof S.color=="number"?this._model.GetColor(S.color):S.color,'"></div></span>'):g-o!==0&&s.push('<span style="',r,'"',a,">",Le(l.substring(o,g)),"</span>")}else if(S.formatType===1){if(o<e||g<e||(s.push('<a draggable="false" class="URLLink" href="javascript:void(0);" title="'),s.push(S.href.replace(/"/g,"&quot;")),s.push('" onclick="',this.linkFunction,"('",S.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),`');return false;">`),g-o===0))continue;s.push('<span style="',r,'"',a,">"),s.push(Le(l.substring(o,g))),s.push("</span>")}else if(S.formatType===2||S.formatType===4||S.formatType===8){if(o<e||g<e)continue;s.push("</a>")}else if(S.formatType===3){if(o<e||g<e||(s.push('<a draggable="false" class="MXPLink" href="javascript:void(0);" title="'),s.push(S.href.replace(/"/g,"&quot;")),s.push('"'),S.expire&&S.expire.length&&s.push(` data-expire="${S.expire}"`),s.push(' onclick="',this.mxpLinkFunction,"(this, '",S.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),`');return false;">`),g-o===0))continue;s.push('<span style="',r,'"',a,">"),s.push(Le(l.substring(o,g))),s.push("</span>")}else if(S.formatType===7){if(o<e||g<e||(s.push('<a draggable="false" class="MXPLink" href="javascript:void(0);" title="'),s.push(S.hint.replace(/"/g,"&quot;")),s.push('"'),S.expire&&S.expire.length&&s.push(` data-expire="${S.expire}"`),s.push(' onmouseover="',this.mxpTooltipFunction,'(this);"'),s.push(' onclick="',this.mxpSendFunction,"(event||window.event, this, ",S.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),", ",S.prompt?"1":"0",", ",S.tt.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),');return false;">'),g-o===0))continue;s.push('<span style="',r,'"',a,">"),s.push(Le(l.substring(o,g))),s.push("</span>")}else if(S.formatType===9&&g-o!==0){if(o<e||g<e)continue;s.push('<span style="',r,'"',a,">"),s.push(Le(l.substring(o,g))),s.push("</span>")}else if(S.formatType===5){if(o<e||g<e)continue;let P="";switch(s.push('<img src="'),S.url.length>0&&(s.push(S.url),P+=S.url,S.url.endsWith("/")||(s.push("/"),P+="/")),S.t.length>0&&(s.push(S.t),P+=S.t,S.t.endsWith("/")||(s.push("/"),P+="/")),P+=S.name,s.push(S.name,'"  style="'),S.w.length>0&&s.push("width:",_e(S.w,this._charWidth),";"),S.h.length>0&&s.push("height:",_e(S.h,this._charHeight),";"),S.align.toLowerCase()){case"left":s.push("float:left;");break;case"right":s.push("float:right;"),b=!0;break;case"top":case"middle":case"bottom":s.push("vertical-align:",S.align,";");break}S.hspace.length>0&&S.vspace.length>0?(s.push("margin:"),s.push(_e(S.vspace,this._charWidth)," "),s.push(_e(S.hspace,this._charHeight),";")):S.hspace.length>0?(s.push("margin:"),s.push("0px ",_e(S.hspace,this._charHeight),";")):S.vspace.length>0&&(s.push("margin:"),s.push(_e(S.vspace,this._charWidth)," 0px;")),s.push('"'),S.ismap&&s.push(' ismap onclick="return false;"'),s.push(`src="${P}"/>`)}}return n?b&&i<this.lines[t].text.length?s.join(""):b?s.join("")+"<br>":i<this.lines[t].text.length?s.join(""):s.join("")+"<br>":b&&i<this.lines[t].text.length?`<span data-id="${h}" class="line" style="min-width:100%">${s.join("")}</span>`:b?`<span data-id="${h}" class="line" style="min-width:100%">${s.join("")}<br></span>`:i<this.lines[t].text.length?`<span data-id="${h}" class="line">${s.join("")}</span>`:`<span  data-id="${h}" class="line">${s.join("")}<br></span>`}getLineText(t,e){return t<0||t>=this.lines.length||!this.lines[t]?"":this.lines[t].text}rebuildLine(t){this.rebuildLines(t,t)}rebuildLines(t,e){if(!this.lines.length)return;(t===void 0||t<0)&&(t=0),(e===void 0||e===-1||e>=this.lines.length)&&(e=this.lines.length-1);let i=this.lines,n=[],s=t;for(;s<=e;s++)n.push(this.getLineHTML(s));t===0&&e===this.lines.length-1?this._view.innerHTML=n.join(""):(this._view.replaceChildren(...[].slice.call(this._view.children,0,t),...[].slice.call(this._view.children,e+1)),t===0?this._view.firstElementChild.insertAdjacentHTML("beforebegin",n.join("")):this._view.children[t-1].insertAdjacentHTML("afterend",n.join("")))}doUpdate(t){t&&(this._updating|=t,this._updating!==0&&window.requestAnimationFrame(()=>{this._updating!==0&&((this._updating&32)===32&&(this.rebuildLines(),this._updating&=-33),(this._updating&1)===1&&(this.update(),this._updating&=-2),(this._updating&2)===2&&(this.updateDisplay(),this._updating&=-3),(this._updating&4)===4&&(this.trimLines(),this._updating&=-5),(this._updating&8)===8&&(this.scrollDisplay(),this._updating&=-9),(this._updating&16)===16&&(this.updateWindow(),this._updating&=-17),this.doUpdate(this._updating))}))}colorSubStrByLine(t,e,i,n,s,o){this.colorSubStringByLine(t,e,i,n,(n||0)+(s||0),o)}colorSubStringByLine(t,e,i,n,s,o){this._model.colorSubStringByLine(t,e,i,n,s,o)&&this.rebuildLine(t)}removeStyleSubStrByLine(t,e,i,n){this.removeStyleSubStringByLine(t,e,i,(i||0)+(n||0))}removeStyleSubStringByLine(t,e,i,n){this._model.removeStyleSubStringByLine(t,e,i,n)&&this.rebuildLine(t)}highlightSubStrByLine(t,e,i){this.highlightStyleSubStringByLine(t,e,(e||0)+(i||0))}highlightStyleSubStringByLine(t,e,i,n){this._model.highlightStyleSubStringByLine(t,e,i,n)&&this.rebuildLine(t)}SetColor(t,e){this._model.SetColor(t,e)}ClearMXP(){this._model.ClearMXP()}ResetMXPLine(){this._model.ResetMXPLine()}get hasSelection(){let t=window.getSelection();if(t.rangeCount>0){let e=t.getRangeAt(0);return this._view.contains(e.commonAncestorContainer)&&t.toString().length!==0}return!1}get selection(){if(window.getSelection){let t=window.getSelection();if(t.rangeCount>0){let e=t.getRangeAt(0);if(this._view.contains(e.startContainer)||this._view.contains(e.endContainer))return t.toString()}}return""}get selectionAsHTML(){var t;if(window.getSelection){var e=window.getSelection();if(e.rangeCount>0){if(t=e.getRangeAt(0),!this._view.contains(t.startContainer)&&!this._view.contains(t.endContainer))return"";var i=t.cloneContents(),n=document.createElement("div");return n.appendChild(i),n.innerHTML}else return""}else return document.selection&&document.selection.createRange?(t=document.selection.createRange(),t.htmlText):""}selectAll(){let t;window.getSelection?window.getSelection().selectAllChildren?window.getSelection().selectAllChildren(this._view):(t=document.createRange(),t.selectNode(this._view),window.getSelection().addRange(t)):document.selection&&(t=document.body.createTextRange(),t.moveToElementText(this._view),t.select())}clearSelection(){let t=window.getSelection();if(t.rangeCount>0){let e=t.getRangeAt(0);(this._view.contains(e.startContainer)||this._view.contains(e.endContainer))&&t.removeAllRanges()}}},kt=class extends ie{constructor(t){super();this._lineID=0;this.lines=[];this.lineIDs=[];this._expire={};this._expire2=[];this._parser=new ht(t),this._parser.on("debug",e=>{this.emit(e)}),this._parser.on("bell",()=>{this.emit("bell")}),this._parser.on("add-line",e=>{this.addParserLine(e,!0)}),this._parser.on("expire-links",e=>{let i,n,s;if(!e||e.length===0){for(n in this._expire2)this._expire2.hasOwnProperty(n)&&this.expireLineLinkFormat(this._expire2[n],+n);for(s in this._expire)if(this._expire.hasOwnProperty(s)){i=this._expire[s];for(n in i)i.hasOwnProperty(n)&&this.expireLineLinkFormat(i[n],+n)}this._expire2=[],this._expire={},this.emit("expire-links",e)}else if(this._expire[e]){i=this._expire[e];for(n in i)i.hasOwnProperty(n)&&this.expireLineLinkFormat(i[n],+n);delete this._expire[e],this.emit("expire-links",e)}}),this._parser.on("parse-done",()=>{this.emit("parse-done")}),this._parser.on("set-title",(e,i)=>{this.emit("set-title",e,i)}),this._parser.on("music",e=>{this.emit("music",e)}),this._parser.on("sound",e=>{this.emit("sound",e)}),this._parser.on("MXP-tag-reply",(e,i)=>{this.emit("MXP-tag-reply",e,i)})}get enableDebug(){return this._parser.enableDebug}set enableDebug(t){this._parser.enableDebug=t}get tabWidth(){return this._parser.tabWidth}set tabWidth(t){this._parser.tabWidth=t}get textLength(){return this._parser.textLength}get EndOfLine(){return this._parser.EndOfLine}get parseQueueLength(){return this._parser.parseQueueLength}get parseQueueEndOfLine(){return this._parser.parseQueueEndOfLine}set enableFlashing(t){this._parser.enableFlashing=t}get enableFlashing(){return this._parser.enableFlashing}set enableMXP(t){this._parser.enableMXP=t}get enableMXP(){return this._parser.enableMXP}set showInvalidMXPTags(t){this._parser.showInvalidMXPTags=t}get showInvalidMXPTags(){return this._parser.showInvalidMXPTags}set enableBell(t){this._parser.enableBell=t}get enableBell(){return this._parser.enableBell}set enableURLDetection(t){this._parser.enableURLDetection=t}get enableURLDetection(){return this._parser.enableURLDetection}set enableMSP(t){this._parser.enableMSP=t}get enableMSP(){return this._parser.enableMSP}set displayControlCodes(t){this._parser.displayControlCodes=t}get displayControlCodes(){return this._parser.displayControlCodes}set emulateTerminal(t){this._parser.emulateTerminal=t}get emulateTerminal(){return this._parser.emulateTerminal}set emulateControlCodes(t){this._parser.emulateControlCodes=t}get emulateControlCodes(){return this._parser.emulateControlCodes}set MXPStyleVersion(t){this._parser.StyleVersion=t}get MXPStyleVersion(){return this._parser.StyleVersion}addParserLine(t,e){if(t.timestamp=Date.now(),this.emit("add-line",t),t==null||typeof t>"u"||t.line==null||typeof t.line>"u"||(this.emit("add-line-done",t),t.gagged))return;let i={text:t.line===`
`||t.line.length===0?"":t.line,raw:t.raw,formats:t.formats,id:this._lineID,timestamp:t.timestamp};this.lines.push(i),this.lineIDs.push(this._lineID),this._lineID++,this.buildLineExpires(this.lines.length-1),this.emit("line-added",t,e)}expireLineLinkFormat(t,e){let i,n,s,o,r,a,l,f=0;for(n=0,o=t.length;n<o;n++)for(s=this.lines[e].formats.length,i=t[n],l=this.lines[e].formats[i],r=l.formatType,l.formatType===3?a=4:a=8,l.formatType=9,i++;i<s;i++)if(this.lines[e].formats[i]===a)if(f===0){this.lines[e].formats[i].formatType=10;break}else f--;else this.lines[e].formats[i]===r&&f++;this.emit("expire-link-line",e)}clear(){this._parser.Clear(),this.lines=[],this._expire={},this._expire2=[],this.lineIDs=[],this._lineID=0}IncreaseColor(t,e){return this._parser.IncreaseColor(t,e)}GetColor(t){return this._parser.GetColor(t)}append(t,e,i,n){this._parser.parse(t,e||!1,i||!1,n||!1)}CurrentAnsiCode(){return this._parser.CurrentAnsiCode()}updateWindow(t,e){this._parser.updateWindow(t,e)}SetColor(t,e){this._parser.SetColor(t,e)}ClearMXP(){this._parser.ClearMXP()}ResetMXPLine(){this._parser.ResetMXPLine()}get busy(){return this._parser.busy}removeLine(t){this.lines.splice(t,1),this.lineIDs.splice(t,1),this._expire2.splice(t,1)}removeLines(t,e){this.lines.splice(t,e),this.lineIDs.splice(t,e),this._expire2.splice(t,e);for(let i in this._expire)!this._expire.hasOwnProperty(i)||this._expire[i].length===0||t>=this._expire[i].length||this._expire[i].splice(t,e)}getLineID(t){return t<0||t>=this.lineIDs.length?-1:this.lineIDs[t]}get getNextLineID(){return this._lineID}getLineFromID(t){return this.lineIDs.indexOf(t)}buildLineExpires(t){t===void 0&&(t=this.lines.length-1);let e=this.lines[t].formats;for(let s in this._expire)this._expire.hasOwnProperty(s)&&this._expire[s][t]&&delete this._expire[s][t];delete this._expire2[t];let i=e.length,n;for(;i--;)n=e[i],(n.formatType===7||n.formatType===3)&&(n.expire&&n.expire.length>0?(this._expire[n.expire]||(this._expire[n.expire]=[]),this._expire[n.expire][t]||(this._expire[n.expire][t]=[]),this._expire[n.expire][t].push(i)):(this._expire2[t]||(this._expire2[t]=[]),this._expire2[t].push(i)))}colorSubStrByLine(t,e,i,n,s,o){return this.colorSubStringByLine(t,e,i,n,n+s,o)}colorSubStringByLine(t,e,i,n,s,o){if(t<0||t>=this.lines.length)return!1;let r=this.lines[t].text.length;if(n>=r||((!n||n<0)&&(n=0),(!s||s>r)&&(s=r),n===s))return!1;let a=this.lines[t].formats,l=a.length,f=!1;if(n===0&&s>=r){for(let u=0;u<l;u++){let b=a[u];b.formatType===0&&(f=!0,b.bStyle&&(b.bStyle=0,b.fStyle=0,b.fCls=0),b.color=e||b.color,b.background=i||b.background,b.style|=o||0)}f||a.unshift({formatType:0,offset:0,color:e||0,background:i||0,size:0,font:0,style:o||0,unicode:!1})}else{let u,b;for(let h=0;h<l;h++){let E=a[h];if(E.formatType===0){if(h<l-1){let S=h+1;if(u=a[S],E.offset===u.offset&&u.formatType===E.formatType)continue;for(;E.offset===u.offset&&u.formatType===E.formatType&&S<l-1;)u=a[++S];S===l&&E.offset===u.offset?b=r:b=u.offset}else b=r;n<E.offset||n>=b||(f=!0,E.bStyle&&(E.bStyle=0,E.fStyle=0,E.fCls=0),s<b&&(E.width=0,a.splice(h+1,0,{formatType:E.formatType,offset:s,color:E.color,background:E.background,size:E.size,font:E.font,style:E.style,unicode:E.unicode}),l++),n!=E.offset?(E.width=0,a.splice(h+1,0,{formatType:E.formatType,offset:n,color:e||E.color,background:i||E.background,size:E.size,font:E.font,style:E.style|(o||0),unicode:E.unicode}),l++):(E.color=e||E.color,E.background=i||E.background,E.style|=o||0),s>b&&(n=b))}}this.lines[t].formats=this.pruneFormats(a,this.textLength)}return!0}removeStyleSubStrByLine(t,e,i,n){return this.removeStyleSubStringByLine(t,e,i,i+n)}removeStyleSubStringByLine(t,e,i,n){if(t<0||t>=this.lines.length)return!1;let s=this.lines[t].text.length;if(i>=s)return!1;(!i||i<0)&&(i=0),(!n||n>s)&&(n=s);let o=this.lines[t].formats,r=o.length,a=!1;if(i===0&&n>=s){for(let l=0;l<r;l++){let f=o[l];f.formatType===0&&(a=!0,f.bStyle&&(f.bStyle=0,f.fStyle=0,f.fCls=0),f.style&=~(e||0))}a||o.unshift({formatType:0,offset:0,color:0,background:0,size:0,font:0,style:0,unicode:!1})}else{let l,f;for(let u=0;u<r;u++){let b=o[u];if(b.formatType===0){if(u<r-1){let h=u+1;if(l=o[h],b.offset===l.offset&&l.formatType===b.formatType)continue;for(;b.offset===l.offset&&l.formatType===b.formatType&&h<r-1;)l=o[++h];h===r&&b.offset===l.offset?f=s:f=l.offset}else f=s;i<b.offset||i>=f||(a=!0,b.bStyle&&(b.bStyle=0,b.fStyle=0,b.fCls=0),n<f&&(b.width=0,o.splice(u+1,0,{formatType:b.formatType,offset:n,color:b.color,background:b.background,size:b.size,font:b.font,style:b.style,unicode:b.unicode}),r++),i!=b.offset?(b.width=0,o.splice(u+1,0,{formatType:b.formatType,offset:i,color:b.color,background:b.background,size:b.size,font:b.font,style:b.style&~(e||0),unicode:b.unicode}),r++):b.style&=~(e||0),n>f&&(i=f))}}this.lines[t].formats=this.pruneFormats(o,this.textLength)}return!0}highlightSubStrByLine(t,e,i){return this.highlightStyleSubStringByLine(t,e,e+i)}highlightStyleSubStringByLine(t,e,i,n){if(t<0||t>=this.lines.length)return!1;let s=this.lines[t].text.length;if(e>=s)return!1;(!e||e<0)&&(e=0),(!i||i>s)&&(i=s);let o=this.lines[t].formats,r=o.length,a=!1;if(e===0&&i>=s){for(let l=0;l<r;l++){let f=o[l];f.formatType===0&&(a=!0,f.bStyle&&(f.bStyle=0,f.fStyle=0,f.fCls=0),n||(f.style&1)===1?typeof f.color=="number"?f.color=this._parser.IncreaseColor(this._parser.GetColor(f.color),.25):f.color=this._parser.IncreaseColor(f.color,.25):f.style|=1)}a||o.unshift({formatType:0,offset:0,color:n?370:0,background:0,size:0,font:0,style:n?0:1,unicode:!1})}else{let l,f;for(let u=0;u<r;u++){let b=o[u];if(b.formatType===0){if(u<r-1){let h=u+1;if(l=o[h],b.offset===l.offset&&l.formatType===b.formatType)continue;for(;b.offset===l.offset&&l.formatType===b.formatType&&h<r-1;)l=o[++h];h===r&&b.offset===l.offset?f=s:f=l.offset}else f=s;e<b.offset||e>=f||(a=!0,b.bStyle&&(b.bStyle=0,b.fStyle=0,b.fCls=0),i<f&&(b.width=0,o.splice(u+1,0,{formatType:b.formatType,offset:i,color:b.color,background:b.background,size:b.size,font:b.font,style:b.style,unicode:b.unicode}),r++),e!=b.offset?(b.width=0,l={formatType:b.formatType,offset:e,color:b.color,background:b.background,size:b.size,font:b.font,style:b.style,unicode:b.unicode},n||(b.style&1)===1?typeof b.color=="number"?l.color=this._parser.IncreaseColor(this._parser.GetColor(b.color),.25):l.color=this._parser.IncreaseColor(b.color,.25):l.style|=1,o.splice(u+1,0,l),r++):n||(b.style&1)===1?typeof b.color=="number"?b.color=this._parser.IncreaseColor(this._parser.GetColor(b.color),.25):b.color=this._parser.IncreaseColor(b.color,.25):b.style|=1,i>f&&(e=f))}}this.lines[t].formats=this.pruneFormats(o,this.textLength)}return!0}pruneFormats(t,e){if(!t||t.length<2)return t;let i=t.length,n=[];for(let s=0;s<i;s++){let o=t[s],r;if(s<i-1){let a=t[s+1];if(o.offset===a.offset&&a.formatType===o.formatType||(r=a.offset,o.formatType===1&&r-o.offset===0&&a.formatType===2)||o.formatType===7&&r-o.offset===0&&a.formatType===8||o.formatType===3&&r-o.offset===0&&a.formatType===4)continue;if(o.formatType===a.formatType&&o.color===a.color&&o.background===a.background&&o.size===a.size&&o.font===a.font&&o.style===a.style&&o.unicode===a.unicode){a.offset=o.offset,a.width=0;continue}}else if(o.offset===e&&e!==0&&(o.formatType===0&&!o.hr||o.formatType===1||o.formatType===7||o.formatType===3))continue;n.push(o)}return n}get text(){return this.lines.map(t=>t.text).join(`
`)}get raw(){return this.lines.map(t=>t.raw).join("")}getText(t,e,i){return t<0||t>=this.lines.length?"":(e<0&&(e=0),typeof i>"u"||i>this.lines[t].text.length?this.lines[t].text.substring(e):this.lines[t].text.substring(e,i))}};var Wt="0.0.1-alpha";var Te=Ot(Ht());var Be=class extends ie{#e;get client(){return this.#e}set client(c){c!==this.#e&&(this.remove(),this.#e=c,this.initialize())}constructor(c){super(),this.#e=c}};var ct=class extends ie{constructor(){super(...arguments);this._file="";this._repeats=1;this._volume=100;this._priority=50;this._retries=0;this.current=0;this.sound=null;this.playing=!1;this.url="";this.continue=!0;this.maxErrorRetries=0}set file(t){this.continue||this.close(),this._file=t}get file(){return this._file}set repeats(t){t>=-1?this._repeats=t:this._repeats=1,this.current=0}get repeats(){return this._repeats}set volume(t){t>=0&&t<=100?this._volume=t:this._volume=1}get volume(){return this._volume}set priority(t){t>=0&&t<=100?this._priority=t:this._priority=50}get priority(){return this._priority}play(){this.playing=!0,this._repeats>0&&this.current<this._repeats?(this.current++,this.close(),this.open().then(()=>{this._retries=0,this.sound.setVolume(this._volume).play(),this.current<this._repeats?this.sound.bind("ended abort",t=>{this.play()}):this.sound.bind("ended abort",t=>{this.playing=!1,this.emit("ended")}),this.sound.isEnded()&&(this.playing=!1)}).catch(t=>{this._retries<this.maxErrorRetries?(this.current--,this.play(),this._retries++):this._retries=0})):this._repeats===-1?(this.close(),this.open().then(()=>{this._retries=0,this.sound.setVolume(this._volume).loop().play(),this.sound.isEnded()&&(this.playing=!1)}).catch(t=>{this._retries<this.maxErrorRetries?(this.play(),this._retries++):this._retries=0})):this.playing=!1}async open(){return this.close(),new Promise((t,e)=>{this.sound=new Te.sound()(this.url+this._file),this.sound.bind("loadeddata",i=>{this.emit("playing",{file:this._file,sound:this.sound,state:this,duration:Te.toTimer(this.sound.getDuration())}),t(1)}),this.sound.bind("error",i=>{if(i&&i.currentTarget&&i.currentTarget.error)switch(i.currentTarget.error.code){case 1:this.emit("error",new Error(`MSP - Aborted: ${this.url}${this._file}`));break;case 2:this.emit("error",new Error(`MSP - Network error: ${this.url}${this._file}`));break;case 3:this.emit("error",new Error(`MSP - Could not decode: ${this.url}${this._file}`));break;case 4:this.emit("error",new Error(`MSP - Source not supported: ${this.url}${this._file}`));break}else i&&i.currentTarget&&i.currentTarget.networkState===3?this.emit("error",new Error(`MSP - Source not found or unable to play: ${this.url}${this._file}`)):this.emit("error",new Error("MSP - Unknown error"));e()}),this.emit("opened")})}close(){this.sound?(this.stop(),delete this.sound,this.sound=null):this.playing&&(this.playing=!1),this.emit("closed")}stop(){this.sound&&this.sound.stop(),this.playing=!1,this.emit("stopped")}},ft=class extends Be{constructor(t){super(t instanceof Fe?t:t?.client);this._enabled=!0;this._enableSound=!0;this._maxErrorRetries=1;this.server=!1;this.enableDebug=!1;this.defaultSoundURL="";this.defaultMusicURL="";this.forcedDefaultMusicURL="http://"+window.location.hostname+"/sounds/";this.forcedDefaultSoundURL="http://"+window.location.hostname+"/sounds/";this.defaultSoundExt=".m4a";this.defaultMusicExt=".m4a";this.MusicState=new ct;this.SoundState=new ct;this.parseMode=0;t&&!(t instanceof Fe)&&("forcedDefaultMusicURL"in t&&(this.forcedDefaultMusicURL=t.forcedDefaultMusicURL),"forcedDefaultSoundURL"in t&&(this.forcedDefaultSoundURL=t.forcedDefaultSoundURL)),this.MusicState.on("playing",e=>{e.type=1,this.emit("playing",e)}),this.SoundState.on("playing",e=>{e.type=0,this.emit("playing",e)}),this.MusicState.on("error",e=>{this.emit("error",e)}),this.SoundState.on("error",e=>{this.emit("error",e)}),this.MusicState.maxErrorRetries=this._maxErrorRetries,this.SoundState.maxErrorRetries=this._maxErrorRetries}remove(){this.client&&this.client.removeListenersFromCaller(this)}initialize(){this.client&&(this.client.on("connecting",()=>this.reset(),this),this.client.on("close",()=>this.reset(),this),this.client.on("received-option",this.processOption,this),this.client.on("received-GMCP",this.processGMCP,this),this.client.on("music",this.music,this),this.client.on("sound",this.sound,this),this.client.on("options-loaded",this.loadOptions,this),this.client.on("option-loaded",this.setOption,this),this.client.on("function",this.processFunction,this),this.on("playing",t=>{this.client&&(this.debug("MSP "+(t.type?"Music":"Sound")+" Playing "+t.file+" for "+t.duration),this.debug(t),this.client.getOption("notifyMSPPlay")&&this.client.echo((t.type?"Music":"Sound")+" Playing "+t.file+" for "+t.duration,-7,-8,!0,!0))}),this.on("debug",t=>this.client.debug(t),this),this.on("error",t=>this.client.error(t),this),this.loadOptions())}get menu(){return[]}get settings(){return[]}loadOptions(){this.enableDebug=this.client.getOption("enableDebug"),this.enabled=this.client.getOption("enableMSP"),this.enableSound=this.client.getOption("enableSound"),this.maxErrorRetries=this.client.getOption("mspMaxRetriesOnError")}setOption(t,e){switch(t){case"enableMSP":this.enabled=this.client.getOption("enableMSP");break;case"mspMaxRetriesOnError":this.maxErrorRetries=this.client.getOption("mspMaxRetriesOnError");break;case"enableSound":case"enableDebug":this[t]=e;break}}get enabled(){return this._enabled}set enabled(t){t!==this._enabled&&(this._enabled=t,this.MusicState?.close(),this.SoundState?.close())}get maxErrorRetries(){return this._maxErrorRetries}set maxErrorRetries(t){t!==this._maxErrorRetries&&(this._maxErrorRetries=t,this.MusicState&&(this.MusicState.maxErrorRetries=t),this.SoundState&&(this.SoundState.maxErrorRetries=t))}get enableSound(){return this._enableSound}set enableSound(t){t!==this._enableSound&&(this._enableSound=t,this.MusicState?.close(),this.SoundState?.close())}getArguments(t,e){let i={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},n=[],s=0,o=[],r=0,a=t.length,l,f,u;for(;r<a;r++)switch(l=t.charAt(r),s){case 1:l==="'"&&(s=0),o.push(l);break;case 2:l==="'"&&(s=0),o.push(l);break;default:l===" "?(n.push(o.join("")),o=[]):l==="'"?(s=1,o.push(l)):(l==="'"&&(s=2),o.push(l));break}for(o.length>0&&(n.push(o.join("")),o=[]),r=0,a=n.length,this.debug("MSP arguments found: "+n),r=0;r<a;r++)if(f=n[r].split("="),f.length>1)switch(f[0].toUpperCase()){case"FNAME":i.file=F(f[1]),i.file.toLowerCase()==="off"&&(i.off=!0,i.file="");break;case"V":u=parseInt(f[1],10),isNaN(u)&&(u=100),i.volume=u;break;case"L":u=parseInt(f[1],10),isNaN(u)&&(u=1),i.repeat=u;break;case"P":u=parseInt(f[1],10),isNaN(u)&&(u=1),i.priority=u;break;case"C":i.continue=f[1]!=="0";break;case"T":f[1].length>0&&(i.type=f[1]);break;case"U":i.url=F(f[1]),!i.url.endsWith("/")&&i.url.length>0&&(i.url+="/");break}else r===0?(i.file=F(n[r]),i.file.toLowerCase()==="off"&&(i.off=!0,i.file="")):r===1?(u=parseInt(n[r],10),isNaN(u)&&(u=100),i.volume=u):r===2?(u=parseInt(n[r],10),isNaN(u)&&(u=1),i.repeat=u):r===3&&e===1?i.continue=n[r]!=="0":r===3?(u=parseInt(n[r],10),isNaN(u)&&(u=1),i.priority=u):r===4?n[r].length>0&&(i.type=n[r]):r===5&&(i.url=F(n[r]),!i.url.endsWith("/")&&i.url.length>0&&(i.url+="/"));return this.debug(i),i}reset(){this.server=!1}music(t){if(!this.enabled&&!this.enableSound)return!1;if(!t.file||t.file.length===0){t.off&&t.url&&t.url.length>0?this.defaultMusicURL=t.url:t.off&&this.MusicState.stop();return}else if(t.off){this.MusicState.stop();return}this.MusicState.volume=t.volume,this.MusicState.repeats=t.repeat,this.MusicState.continue=t.continue;let e=this.MusicState.file;t.file.lastIndexOf(".")===-1?this.MusicState.file=t.file+this.defaultMusicExt:this.MusicState.file=t.file,t.url&&t.url.length>0?this.MusicState.url=t.url:this.forcedDefaultMusicURL&&this.forcedDefaultMusicURL.length>0?this.MusicState.url=this.forcedDefaultMusicURL:this.defaultMusicURL&&this.defaultMusicURL.length>0?this.MusicState.url=this.defaultMusicURL:this.MusicState.url="",this.MusicState.url.length>0&&!this.MusicState.url.endsWith("/")&&(this.MusicState.url+="/"),t.type&&t.type.length>0&&(this.MusicState.url+=t.type,this.MusicState.url.length>0&&!this.MusicState.url.endsWith("/")&&(this.MusicState.url+="/")),(e!==this.MusicState.file||!t.continue||!this.MusicState.playing)&&(this.enableSound?this.MusicState.play():this.emit("playing",{type:1,file:this.MusicState.file,sound:this.MusicState.sound,state:this.MusicState,duration:"--:--"}))}sound(t){if(!this.enabled&&!this.enableSound)return!1;if(!t.file||t.file.length===0){t.off&&t.url&&t.url.length>0?this.defaultSoundURL=t.url:t.off&&this.SoundState.stop();return}else if(t.off){this.SoundState.stop();return}if(this.SoundState.playing&&t.priority<this.SoundState.priority)return!1;this.SoundState.volume=t.volume,this.SoundState.repeats=t.repeat,this.SoundState.priority=t.priority,t.file.lastIndexOf(".")===-1?this.SoundState.file=t.file+this.defaultSoundExt:this.SoundState.file=t.file,t.url&&t.url.length>0?this.SoundState.url=t.url:this.forcedDefaultSoundURL&&this.forcedDefaultSoundURL.length>0?this.SoundState.url=this.forcedDefaultSoundURL:this.defaultSoundURL&&this.defaultSoundURL.length>0?this.SoundState.url=this.defaultSoundURL:this.SoundState.url="",this.SoundState.url.length>0&&!this.SoundState.url.endsWith("/")&&(this.SoundState.url+="/"),t.type&&t.type.length>0&&(this.SoundState.url+=t.type,this.SoundState.url.length>0&&!this.SoundState.url.endsWith("/")&&(this.SoundState.url+="/")),this.enableSound?this.SoundState.play():this.emit("playing",{type:0,file:this.SoundState.file,sound:this.SoundState.sound,state:this.SoundState,duration:"--:--"})}processOption(t){t.option===90&&(this.debug("<MSP>"),t.verb===253?(this.server=!0,this.enabled?(this.debug("REPLY: <IAC><WILL><MSP>"),t.telnet.sendData([255,251,90],!0)):(this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0))):t.verb===254?(this.server=!1,this.debug("REPLY: <IAC><WONT><MSP>"),t.telnet.sendData([255,252,90],!0)):t.verb===251?(this.server=!0,this.enabled?(this.debug("REPLY: <IAC><DO><MSP>"),t.telnet.sendData([255,253,90],!0)):(this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0))):t.verb===252&&(this.server=!1,this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0)),t.handled=!0)}async processGMCP(t,e){switch(t){case"Client.Media.Default":e.type==="sound"||!e.type?this.sound({off:!0,url:e.url}):e.type==="music"&&this.music({off:!0,url:e.url});break;case"Client.Media.Load":break;case"Client.Media.Play":let i={off:!1,file:e.name,url:"",volume:50,repeat:1,priority:50,type:"",continue:!0};e.hasOwnProperty("url")&&(i.url=e.url),e.hasOwnProperty("tag")&&(i.type=e.tag),e.hasOwnProperty("volume")&&(i.volume=e.volume),e.hasOwnProperty("loops")&&(i.repeat=e.loops),e.hasOwnProperty("priority")&&(i.priority=e.priority),e.type==="sound"||!e.type?this.sound(i):e.type==="music"&&(e.hasOwnProperty("continue")&&(e.continue==="false"||!e.continue)&&(i.continue=!1),this.music(i));break;case"Client.Media.Stop":e.type==="sound"||!e.type?this.sound({off:!0}):e.type==="music"&&this.music({off:!0});break}}debug(t){this.enableDebug&&this.emit("debug",t)}processFunction(t){let e,i,n;if(t)switch(t.name.toLowerCase()){case"soundinfo":this.SoundState.playing?this.client.echo("Playing Sound - "+this.SoundState.file+" - "+Te.toTimer(this.SoundState.sound.getTime())+"/"+Te.toTimer(this.SoundState.sound.getDuration()),-7,-8,!0,!0):this.client.echo("No sound currently playing.",-7,-8,!0,!0),t.handled=!0;break;case"musicinfo":this.MusicState.playing?this.client.echo("Playing Music - "+this.MusicState.file+" -  "+Te.toTimer(this.MusicState.sound.getTime())+"/"+Te.toTimer(this.MusicState.sound.getDuration()),-7,-8,!0,!0):this.client.echo("No music currently playing.",-7,-8,!0,!0),t.handled=!0;break;case"playmusic":case"playm":e=this.client.input.parseOutgoing(t.args.join(" "),!1),i={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},n=e.lastIndexOf("/"),n===-1?i.file=e:(i.file=e.substring(n+1),i.url=e.substring(0,n+1)),this.music(i),t.handled=!0;break;case"playsound":case"plays":e=this.client.input.parseOutgoing(t.args.join(" "),!1),i={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},n=e.lastIndexOf("/"),n===-1?i.file=e:(i.file=e.substring(n+1),i.url=e.substring(0,n+1)),this.sound(i),t.handled=!0;break;case"stopmusic":case"stopm":this.MusicState.close(),t.handled=!0;break;case"stopsound":case"stops":this.SoundState.close(),t.handled=!0;break;case"stopallsound":case"stopa":this.MusicState.close(),this.SoundState.close(),t.handled=!0;break}}};var pt=class extends Be{constructor(t){super(t);this.functions={};this._event=e=>this.processFunction(e),this.functions.testfile=e=>{if(e&&e.args&&e.args.length)throw new Error("Invalid syntax use "+this.client.getOption("commandChar")+"testfile");Ee().then(i=>{console.time("testfile readFile"),xe(i[0]).then(n=>{console.timeEnd("testfile readFile"),e&&e.raw&&(this.client.getOption("echo")&4)===4&&this.client.echo(e.raw,-3,-4,!0,!0);let s=this.client.getOption("enableCommands");this.client.setOption("enableCommands",!0);let o=new Date().getTime();console.time("testfile parse"),this.client.sendCommand(n,null,this.client.getOption("allowCommentsFromCommand")),console.timeEnd("testfile parse");let r=new Date().getTime();this.client.setOption("enableCommands",s),this.client.print(`Time: ${r-o}
`,!0)}).catch(this.client.error)}).catch(()=>{})},this.functions.testfiler=e=>{if(e&&e.args&&e.args.length)throw new Error("Invalid syntax use "+this.client.getOption("commandChar")+"testfile");Ee().then(i=>{console.time("testfile readFile"),xe(i[0]).then(n=>{console.timeEnd("testfile readFile"),e&&e.raw&&(this.client.getOption("echo")&4)===4&&this.client.echo(e.raw,-3,-4,!0,!0);let s=this.client.getOption("enableCommands");this.client.setOption("enableCommands",!0);let o=new Date().getTime();console.time("testfiler parse"),this.client.telnet.receivedData(be(n),!0,!0),console.timeEnd("testfiler parse");let r=new Date().getTime();this.client.setOption("enableCommands",s),this.client.print(`Time: ${r-o}
`,!0)}).catch(this.client.error)}).catch(()=>{})},this.functions.testspeedfile=e=>{if(e&&e.args&&e.args.length)throw new Error("Invalid syntax use "+this.client.getOption("commandChar")+"testspeedfile");Ee().then(i=>{console.time("testspeedfile readFile"),xe(i[0]).then(n=>{console.timeEnd("testspeedfile readFile"),e&&e.raw&&(this.client.getOption("echo")&4)===4&&this.client.echo(e.raw,-3,-4,!0,!0);let s=0,o=0,r=0,a=[],l;console.time("testspeedfile");for(let f=0;f<10;f++){let u=new Date().getTime();console.time(`testspeedfile parse ${f}`),this.client.sendCommand(n,null,this.client.getOption("allowCommentsFromCommand")),console.timeEnd(`testspeedfile parse ${f}`),l=new Date().getTime()-u,s+=l,l>o&&(o=l),(!r||l<r)&&(r=l),a.push(`${f} - ${l}`)}console.timeEnd("testspeedfile"),a.push(`Total - ${s}`),a.push(`Average - ${s/10}`),a.push(`Min - ${r}`),a.push(`Max - ${o}`),this.client.print(a.join(`
`)+`
`,!0)}).catch(this.client.error)}).catch(()=>{})},this.functions.testspeedfiler=e=>{if(e&&e.args&&e.args.length)throw new Error("Invalid syntax use "+this.client.getOption("commandChar")+"testspeedfiler");Ee().then(i=>{console.time("testspeedfile readFile"),xe(i[0]).then(n=>{console.timeEnd("testspeedfile readFile"),e&&e.raw&&(this.client.getOption("echo")&4)===4&&this.client.echo(e.raw,-3,-4,!0,!0);let s=0,o=0,r=0,a=[],l;console.time("testspeedfile");for(let f=0;f<10;f++){let u=new Date().getTime();console.time(`testspeedfile parse ${f}`),this.client.telnet.receivedData(be(n),!0,!0),console.timeEnd(`testspeedfile parse ${f}`),l=new Date().getTime()-u,s+=l,l>o&&(o=l),(!r||l<r)&&(r=l),a.push(`${f} - ${l}`)}console.timeEnd("testspeedfile"),a.push(`Total - ${s}`),a.push(`Average - ${s/10}`),a.push(`Min - ${r}`),a.push(`Max - ${o}`),this.client.print(a.join(`
`)+`
`,!0)}).catch(this.client.error)}).catch(()=>{})},this.functions.testlist=()=>{let e=`Test commands:
`,i;for(i in this.functions)this.functions.hasOwnProperty(i)&&(e+=`	${this.client.getOption("commandChar")+i}
`);this.client.print(e,!0)},this.functions.testcolors=()=>{let e,i=`Colors and Styles
-------------------------------------------------------------------------------------------
`;for(e=30;e<38;e++)i+="\x1B["+e+";0m"+e+"\x1B[0m ",i+="\x1B["+e+";1mBold\x1B[0m ",i+="\x1B["+e+";2mFaint\x1B[0m ",i+="\x1B["+e+";3mItalic\x1B[0m ",i+="\x1B["+e+";4mUnderline\x1B[0m ",i+="\x1B["+e+";5mFlash\x1B[0m ",i+="\x1B["+e+";7mInverse\x1B[0m ",i+="\x1B["+e+";8mConceal\x1B[0m ",i+="\x1B["+e+";9mStrikeout\x1B[0m ",i+="\x1B["+e+";21mDoubleUnderline\x1B[0m ",i+="\x1B["+e+";53mOverline\x1B[0m ",i+="\x1B["+e+";1;2;3;4;5;9;21;53mAll\x1B[0m",i+=`\x1B[0m
`;for(e=40;e<48;e++)i+="\x1B["+e+";0m"+e+"\x1B[0m ",i+="\x1B["+e+";1mBold\x1B[0m ",i+="\x1B["+e+";2mFaint\x1B[0m ",i+="\x1B["+e+";3mItalic\x1B[0m ",i+="\x1B["+e+";4mUnderline\x1B[0m ",i+="\x1B["+e+";5mFlash\x1B[0m ",i+="\x1B["+e+";7mInverse\x1B[0m ",i+="\x1B["+e+";8mConceal\x1B[0m ",i+="\x1B["+e+";9mStrikeout\x1B[0m ",i+="\x1B["+e+";21mDoubleUnderline\x1B[0m ",i+="\x1B["+e+";53mOverline\x1B[0m ",i+="\x1B["+e+";1;2;3;4;5;9;21;53mAll\x1B[0m",i+=`\x1B[0m
`;i+=`-------------------------------------------------------------------------------------------
`,this.client.print(i,!0)},this.functions.testcolorsdetails=()=>{let e="";this.client.telnet.prompt&&(e=`
`),e+=`Table for 16-color terminal escape sequences.
`,e+=`
`,e+=`Background        | Foreground colors
`,e+=`------------------------------------------------------------------------------------
`;for(let i=40;i<=47;i++){let n;for(n in Oe)if(typeof Oe[n]=="number"&&n!=="Rapid"){n==="None"?e+="\x1B[0m "+$e[i-10].toString().padEnd(16)+" | ":e+="\x1B[0m "+n.padEnd(16)+" | ";for(let s=30;s<=37;s++)n==="None"?e+="\x1B["+i+"m\x1B["+s+"m "+("["+s+"m").padEnd(7):e+="\x1B["+i+"m\x1B["+Oe[n]+";"+s+"m "+("["+Oe[n]+";"+s+"m").padEnd(7);e+=`\x1B[0m
`}e+=`------------------------------------------------------------------------------------
`}this.client.print(e,!0)},this.functions.testxterm=e=>{let i,n,s,o,r="";for(typeof e<"u"&&e.length>0&&(r+="Set Title: ",r+=e,r+="\x1B]0;",r+=e,r+=`\x07
`),r+=`System colors:
`,o=0;o<8;o++)r+="\x1B[48;5;"+o+"m  ";for(r+=`\x1B[0m
`,o=8;o<16;o++)r+="\x1B[48;5;"+o+"m  ";for(r+=`\x1B[0m

`,r+=`Color cube, 6x6x6:
`,n=0;n<6;n++){for(i=0;i<6;i++){for(s=0;s<6;s++)o=16+i*36+n*6+s,r+="\x1B[48;5;"+o+"m  ";r+="\x1B[0m "}r+=`
`}for(r+=`Grayscale ramp:
`,o=232;o<256;o++)r+="\x1B[48;5;"+o+"m  ";r+=`\x1B[0m
`,this.client.print(r,!0)},this.functions.testmxp=()=>{let e=`Text Formatting
`;e+="	\x1B[6z",e+=`<!--Test-->&lt;!--Test--&gt;
`,e+=`	<!--Test>-->&lt;!--Test&gt;--&gt;
`,e+=`	<STRONG>STRONG</STRONG>
`,e+=`	<BOLD>BOLD</BOLD>
`,e+=`	<B>B</B>
`,e+=`	<I>I</I>
`,e+=`	<ITALIC>ITALIC</ITALIC>
`,e+=`	<EM>EM</EM>
`,e+=`	<U>U</U>
`,e+=`	<UNDERLINE>UNDERLINE</UNDERLINE>
`,e+=`	<S>S</S>
`,e+=`	<STRIKEOUT>STRIKEOUT</STRIKEOUT>
`,e+=`	<H>H</H>
`,e+=`	<HIGH>HIGH</HIGH>
`,e+=`	<C RED>C RED</C>
`,e+=`	<COLOR #F00>COLOR #F00</COLOR>
`,e+=`	<C Maroon>C Maroon</C>
`,e+=`	<COLOR #800000>COLOR #800000</COLOR>
`,e+=`	<H><C Maroon>H C Maroon</C></H>
`,e+=`	<H><COLOR #800000>H COLOR #800000</COLOR></H>
`,e+=`	Run <send PROMPT>#testmxpcolors</send> for a detailed list.
`,e+=`	<FONT "Times New Roman">FONT "Times New Roman"</FONT>
`,e+=`	<FONT "Webdings">FONT "Webdings"</FONT>
`,e+=`	<FONT COLOR=Red,Blink>FONT COLOR=Red,Blink</FONT>
`,e+=`	<FONT "Times New Roman" 24 RED GREEN>FONT "Times New Roman" 24 RED GREEN</FONT>
`,e+=`Line Spacing
`,e+=`	NOBR<NOBR>
`,e+=` Continued<NOBR>
`,e+=` More
`,e+=`	<P>P
`,e+=`	1
`,e+=`	2
`,e+=`	3
`,e+=`	4</P>
`,e+=`	BR Line<BR>Break
`,e+=`	SBR Soft<SBR>Break
`,e+=`Links
`,e+=`	<A "http://shadowmud.com">Click here for ShadowMUD</A> 
`,e+=`	<send>test command</send>
`,e+=`	<send href="command2">test command2</send>
`,e+=`	<send "command1|command2|command3" hint="click to see menu|Item 1|Item 2|Item 3">this is a menu link</SEND>
`,e+=`	<SEND "sample" PROMPT EXPIRE=prompt>Prompt sample</SEND>
`,e+=`	<send PROMPT href="#testmxpexpire">&lt;EXPIRE&gt; - #testmxpexpire</send> 
`,e+=`Horizontal Rule
`,e+=`<hr>
`,e+=`<hr>Text After
`,e+=`Text Before<hr>
`,e+=`<c red blue><hr></c>
`,e+=`Text Before<hr>Text After
`,e+=`Custom Element
`,e+=`	<!ELEMENT help '<send href="help &text;">'>&lt;!ELEMENT help '&lt;send href="help &amp;text;"&gt;'&gt;
`,e+=`	&lt;help&gt;test&lt;/help&gt; = <help>test</help>
`,e+=`	<!ELEMENT redbu '<c red><b><u>'>&lt;!ELEMENT redbu '&lt;c red&gt;&lt;b&gt;&lt;u&gt;'&gt;
`,e+=`	&lt;redbu&gt;test&lt;/redbu&gt; = <redbu>test</redbu>
`,e+=`Entities
`,e+=`	&#243;&brvbar;&copy;&plusmn;&sup3;&para;&frac34;&infin;&Dagger;&dagger;&spades;&clubs;&hearts;&diams;
`,e+=`Custom Entity
`,e+='	<!ENTITY version "'+this.client.version+'">&lt;!ENTITY version "'+this.client.version+`"&gt;
`,e+=`	&amp;version; = &version;
`,e+=`	&lt;V Hp&gt;<V Hp>100</V>&lt;/V&gt; &amp;Hp; = &Hp; &amp;hp; = &hp;
`,e+=`	&lt;VAR Sp&gt;<VAR Sp>200</VAR>&lt;/VAR&gt; &amp;Sp; = &Sp; &amp;sp; = &sp;
`,e+=`Image
`,e+=`default      <image 48x48.png URL="./../assets/icons/png/" w=48 h=48>
`,e+=`align left <image 48x48.png URL="./../assets/icons/png/" align=left w=48 h=48> align left
`,e+=`align right  <image 48x48.png URL="./../assets/icons/png/" align=right w=48 h=48> align right
`,e+=`align top    <image 48x48.png URL="./../assets/icons/png/" align=top w=48 h=48> align top 
`,e+=`align middle <image 48x48.png URL="./../assets/icons/png/" align=middle w=48 h=48> align middle
`,e+=`align bottom <image 48x48.png URL="./../assets/icons/png/" align=bottom w=48 h=48> align bottom
`,e+=`map          <send showmap><image 48x48.png URL="./../assets/icons/png/" ismap w=48 h=48></send>
`,e+="<STAT Hp version Test>",e+="<GAUGE Hp version Test>",e+="\x1B[0z",this.client.print(e,!0)},this.functions.testmxp2=()=>{let e="\x1B[6z";e+="<!-- Elements to support the Auto mapper -->",e+=`<!ELEMENT RName '<FONT COLOR=Red><B>' FLAG="RoomName">`,e+="<!ELEMENT RDesc FLAG='RoomDesc'>",e+="<!ELEMENT RExits '<FONT COLOR=Blue>' FLAG='RoomExit'>",e+="<!-- The next element is used to define a room exit link that sends ",e+="the exit direction to the MUD if the user clicks on it -->",e+="<!ELEMENT Ex '<SEND>'>",e+="<!ELEMENT Chat '<FONT COLOR=Gray>' OPEN>",e+="<!ELEMENT Gossip '<FONT COLOR=Cyan>' OPEN>",e+="<!-- in addition to standard HTML Color specifications, you can use ",e+="color attribute names such as blink -->",e+="<!ELEMENT ImmChan '<FONT COLOR=Red,Blink>'>",e+="<!ELEMENT Auction '<FONT COLOR=Purple>' OPEN>",e+="<!ELEMENT Group '<FONT COLOR=Blue>' OPEN>",e+="<!-- the next elements deal with the MUD prompt -->",e+='<!ELEMENT Prompt FLAG="Prompt">',e+='<!ELEMENT Hp FLAG="Set hp">',e+='<!ELEMENT MaxHp FLAG="Set maxhp">',e+='<!ELEMENT Mana FLAG="Set mana">',e+='<!ELEMENT MaxMana FLAG="Set maxmana">',e+="<!-- now the MUD text -->",e+=`<RName>The Main Temple</RName>
`,e+=`<RDesc>This is the main hall of the MUD where everyone starts.
`,e+=`Marble arches lead south into the town, and there is a <i>lovely</i>
`,e+=`<send "drink &text;">fountain</send> in the center of the temple,</RDesc>
`,e+=`<RExits>Exits: <Ex>N</Ex>, <Ex>S</Ex>, <Ex>E</Ex>, <Ex>W</Ex></RExits>

`,e+=`<Prompt>[<Hp>100</Hp>/<MaxHp>120</MaxHp>hp <Mana>50</Mana>/<MaxMana>55</MaxMana>mana]</Prompt>
<hr>`,e+="<!ELEMENT boldtext '<COLOR &col;><B>' ATT='col=red'>",e+=`<boldtext>This is bold red</boldtext>
`,e+=`<boldtext col=blue>This is bold blue text</boldtext>
`,e+=`<boldtext blue>This is also bold blue text</boldtext>
`,e+="\x1B[0z",this.client.print(e,!0)},this.functions.testmxpexpire=()=>{this.client.print(`	\x1B[6z<SEND "sample" PROMPT EXPIRE=prompt>Expire sample</SEND> <SEND "sample" PROMPT EXPIRE=prompt2>Expire sample2</SEND><EXPIRE prompt> <SEND "sample" PROMPT EXPIRE=prompt>Expire sample3</SEND>\x1B[0z
`,!0),this.client.print(`	\x1B[6z\x1B[36m<SEND "sample" PROMPT EXPIRE=prompt>Expire sample</SEND> <SEND "sample" PROMPT EXPIRE=prompt2>Expire sample2</SEND><EXPIRE prompt> <SEND "sample" PROMPT EXPIRE=prompt>Expire sample3</SEND>\x1B[0z\x1B[0m
`,!0),this.client.print(`	\x1B[6z\x1B[46;30m<SEND "sample" PROMPT EXPIRE=prompt>Expire sample</SEND> <SEND "sample" PROMPT EXPIRE=prompt2>Expire sample2</SEND><EXPIRE prompt> <SEND "sample" PROMPT EXPIRE=prompt>Expire sample3</SEND>\x1B[0z\x1B[0m
`,!0),this.client.print(`	\x1B[6z<SEND "sample" PROMPT EXPIRE=prompt>Expire \x1B[36msample\x1B[0m</SEND> <SEND "sample" PROMPT EXPIRE=prompt2>Expire \x1B[36msample2\x1B[0m</SEND><EXPIRE prompt> <SEND "sample" PROMPT EXPIRE=prompt>Expire \x1B[36msample3\x1B[0m</SEND>\x1B[0z
`,!0)},this.functions.testmxpcolors=()=>{let e=["IndianRed","LightCoral","Salmon","DarkSalmon","LightSalmon","Crimson","Red","FireBrick","DarkRed","Pink","LightPink","HotPink","DeepPink","MediumVioletRed","PaleVioletRed","LightSalmon","Coral","Tomato","OrangeRed","DarkOrange","Orange","Gold","Yellow","LightYellow","LemonChiffon","LightGoldenrodYellow","PapayaWhip","Moccasin","PeachPuff","PaleGoldenrod","Khaki","DarkKhaki","Lavender","Thistle","Plum","Violet","Orchid","Fuchsia","Magenta","MediumOrchid","MediumPurple","BlueViolet","DarkViolet","DarkOrchid","DarkMagenta","Purple","Indigo","SlateBlue","DarkSlateBlue","MediumSlateBlue","GreenYellow","Chartreuse","LawnGreen","Lime","LimeGreen","PaleGreen","LightGreen","MediumSpringGreen","SpringGreen","MediumSeaGreen","SeaGreen","ForestGreen","Green","DarkGreen","YellowGreen","OliveDrab","Olive","DarkOliveGreen","MediumAquamarine","DarkSeaGreen","LightSeaGreen","DarkCyan","Teal","Aqua","Cyan","LightCyan","PaleTurquoise","Aquamarine","Turquoise","MediumTurquoise","DarkTurquoise","CadetBlue","SteelBlue","LightSteelBlue","PowderBlue","LightBlue","SkyBlue","LightSkyBlue","DeepSkyBlue","DodgerBlue","CornflowerBlue","MediumSlateBlue","RoyalBlue","Blue","MediumBlue","DarkBlue","Navy","MidnightBlue","Cornsilk","BlanchedAlmond","Bisque","NavajoWhite","Wheat","BurlyWood","Tan","RosyBrown","SandyBrown","Goldenrod","DarkGoldenrod","Peru","Chocolate","SaddleBrown","Sienna","Brown","Maroon","White","Snow","Honeydew","MintCream","Azure","AliceBlue","GhostWhite","WhiteSmoke","Seashell","Beige","OldLace","FloralWhite","Ivory","AntiqueWhite","Linen","LavenderBlush","MistyRose","Gainsboro","LightGrey","Silver","DarkGray","Gray","DimGray","LightSlateGray","SlateGray","DarkSlateGray","Black"],i="\x1B[6z",n=e.length-1;for(let s=0;s<n;s++)i+=""+e[s]+": ",i+=Array(22-e[s].length).join(" "),i+="<C "+e[s]+">Fore</C> ",i+="<C black "+e[s]+">Back</C> ",i+="<h><C "+e[s]+">High</C></h> ",i+="<b><C "+e[s]+">Bold</C></b> ",i+="<C "+e[s]+">\x1B[1mAnsiBold\x1B[0m ",i+="\x1B[2mFaint\x1B[0m ",i+="\x1B[3mItalic\x1B[0m ",i+="\x1B[4mUnderline\x1B[0m ",i+="\x1B[5mFlash\x1B[0m ",i+="\x1B[7mInverse\x1B[0m ",i+="\x1B[8mConceal\x1B[0m ",i+="\x1B[9mStrikeout\x1B[0m ",i+="\x1B[21mDoubleUnderline\x1B[0m ",i+="\x1B[53mOverline\x1B[0m",i+=`</C>
`;i+="Black: ",i+=Array(17).join(" "),i+="<C Black silver>Fore</C> ",i+="<C silver Black>Back</C> ",i+="<h><C Black silver>High</C></h> ",i+="<b><C Black silver>Bold</C></b> ",i+="<C Black silver>\x1B[1mAnsiBold\x1B[0m ",i+="\x1B[2mFaint\x1B[0m ",i+="\x1B[3mItalic\x1B[0m ",i+="\x1B[4mUnderline\x1B[0m ",i+="\x1B[5mFlash\x1B[0m ",i+="\x1B[7mInverse\x1B[0m ",i+="\x1B[8mConceal\x1B[0m ",i+="\x1B[9mStrikeout\x1B[0m ",i+="\x1B[21mDoubleUnderline\x1B[0m ",i+="\x1B[53mOverline\x1B[0m",i+=`</C>
`,i+="\x1B[0z",this.client.print(i,!0)},this.functions.testmxpelements=()=>{let e="\x1B[6z";e+=`Custom Element
`,e+=`	<!ELEMENT help '<send href="help &text;">'>&lt;!ELEMENT help '&lt;send href="help &amp;text;"&gt;'&gt;
`,e+=`	&lt;help&gt;test&lt;/help&gt; = <help>test</help>
`,e+=`	<!ELEMENT redbu '<c red><b><u>'>&lt;!ELEMENT redbu '&lt;c red&gt;&lt;b&gt;&lt;u&gt;'&gt;
`,e+=`	&lt;redbu&gt;test&lt;/redbu&gt; = <redbu>test</redbu>
`,e+="\x1B[0z",this.client.print(e,!0)},this.functions.testmxpLines=()=>{let e="\x1B[6z";e+="<!ELEMENT Auction '<FONT COLOR=red>' TAG=20 OPEN>",e+=`\x1B[20zA nice shiny sword is being auctioned.
`,e+="\x1B[6z<Auction>Also, a gold ring is being auctioned.</Auction>",e+=`<!ELEMENT Auction TAG=20>
`,e+=`<!TAG 20 Fore=red>
`,e+=`\x1B[20zA nice shiny sword is being auctioned.
`,e+=`\x1B[6z<Auction>Also, a gold ring is being auctioned.</Auction>
`,e+=`\x1B[6z<!TAG 20 Fore=blue>
`,e+=`\x1B[20zA nice shiny sword is being auctioned.
`,e+=`\x1B[6z<Auction>Also, a gold ring is being auctioned.</Auction>
`,e+="\x1B[0z",this.client.print(e,!0)},this.functions.testmapper=()=>{this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:0,dir:"",area:""},area:"Doc Build Samples Area",exits:{south:{num:87723359,dir:"south",area:"Doc Build Samples Area",isdoor:0},east:{num:-329701270,dir:"east",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 1",num:1968208336,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:1968208336,dir:"east",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"wood",exits:{south:{num:1916648905,dir:"south",area:"Doc Build Samples Area",isdoor:0},east:{num:-1688332036,dir:"east",area:"Doc Build Samples Area",isdoor:0},west:{num:1968208336,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 2",num:-329701270,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:-329701270,dir:"east",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"jungle",exits:{south:{num:-348853133,dir:"south",area:"Doc Build Samples Area",isdoor:0},west:{num:-329701270,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 3",num:-1688332036,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:-1688332036,dir:"south",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"grass",exits:{north:{num:-1688332036,dir:"north",area:"Doc Build Samples Area",isdoor:0},south:{num:2072768994,dir:"south",area:"Doc Build Samples Area",isdoor:0},west:{num:1916648905,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 6",num:-348853133,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:-348853133,dir:"west",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"desert",exits:{north:{num:-329701270,dir:"north",area:"Doc Build Samples Area",isdoor:0},south:{num:210551156,dir:"south",area:"Doc Build Samples Area",isdoor:0},east:{num:-348853133,dir:"east",area:"Doc Build Samples Area",isdoor:0},west:{num:87723359,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 5",num:1916648905,indoors:1}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:1916648905,dir:"west",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"tundra",exits:{north:{num:1968208336,dir:"north",area:"Doc Build Samples Area",isdoor:0},south:{num:-1674322715,dir:"south",area:"Doc Build Samples Area",isdoor:0},east:{num:87723359,dir:"east",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 4",num:87723359,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:87723359,dir:"south",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"water",exits:{north:{num:87723359,dir:"north",area:"Doc Build Samples Area",isdoor:0},east:{num:210551156,dir:"east",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 7",num:-1674322715,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:-1674322715,dir:"east",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"jungle",exits:{north:{num:1916648905,dir:"north",area:"Doc Build Samples Area",isdoor:0},east:{num:2072768994,dir:"east",area:"Doc Build Samples Area",isdoor:0},west:{num:-1674322715,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 8",num:210551156,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:210551156,dir:"east",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",exits:{north:{num:-348853133,dir:"north",area:"Doc Build Samples Area",isdoor:0},west:{num:210551156,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 9",num:2072768994,indoors:0})},this.functions.testfansi=()=>{let e="",i;for(e="",i=3;i<=6;i++)e+=String.fromCharCode(i);for(i=14;i<=26;i++)e+=String.fromCharCode(i);for(i=28;i<=31;i++)e+=String.fromCharCode(i);for(i=127;i<=254;i++)e+=String.fromCharCode(i);e+=`
`;let n=this.client.display.displayControlCodes;this.client.display.displayControlCodes=!0,this.client.display.emulateTerminal?(this.client.display.emulateTerminal=!1,this.client.print(e,!0),this.client.display.emulateTerminal=!0,this.client.print(e,!0)):(this.client.print(e,!0),this.client.display.emulateTerminal=!0,this.client.print(e,!0),this.client.display.emulateTerminal=!1),this.client.display.displayControlCodes=n},this.functions.testcontrolchars=()=>{let e,i="1:  ,";for(e=3;e<=9;e++)i+=`${e}: ${String.fromCharCode(e)},`;for(e=11;e<=27;e++)i+=`${e}: ${String.fromCharCode(e)},`;for(e=28;e<=31;e++)i+=`${e}: ${String.fromCharCode(e)},`;for(e=127;e<=254;e++)i+=`${e}: ${String.fromCharCode(e)},`;i+=`
`;let n=this.client.display.displayControlCodes;this.client.display.displayControlCodes=!0,this.client.print(i,!0),this.client.display.displayControlCodes=n},this.functions.testurldetect=()=>{let e=`\x1B[0mhttp://www.google.com
`;e+=`	http://www.google.com\x1B[44m
`,e+=`http://www.google.com
`,e+=`	try this http://www.google.com
`,e+=`http://www.google.com try this
`,e+=`	try this http://www.google.com try this
`,e+=`\x1B[36mhttp://www.google.com
`,e+=`	\x1B[0mhttp://www.google.com
`,e+=`http://www.google.com\x1B[44m
`,e+=`	http://www.google.com
`,e+=`try this http://www.google.com
`,e+=`	http://www.google.com try this
`,e+=`try this http://www.google.com try this
`,e+=`	\x1B[36mhttp://www.google.com
`,e+=`	https://localhost telnet://localhost
`,e+=`	news://test.edu/default.asp?t=1#1111 torrent://localhost/
`,e+=`	ftp://localhost gopher://localhost im://talk
`,e+=`	mailto:address@localhost irc://<host>[:<port>]/[<channel>[?<password>]]
`,e+=`awww... www.google.com awww.com
`,e+="www.google.com www.google.com\x1B[0m",this.client.print(e,!0)},this.functions.testxtermrgb=()=>{let e="",i,n,s,o=0;for(i=0;i<256;i+=16)for(n=0;n<256;n+=16)for(s=0;s<256;s+=16)e+="\x1B[48;2;"+i+";"+n+";"+s+"m  ",o%63===0&&(e+=`
`),o++;e+="\x1B[0m",this.client.print(e,!0)},this.functions.testsize=()=>{let e=this.client.display.WindowSize,i=e.width+"x"+e.height+" ";e.width-=i.length;for(let n=0;n<e.width;n++)i+="w";for(let n=1;n<e.height;n++)i+=`
`+n;this.client.print(i,!0)},this.functions.testspeed=()=>{let e=[],i=this.client.getOption("commandChar")+["testmxpcolors","testmxp","testcolors","testcolorsdetails","testxterm","testxtermrgb"].join(`
`+this.client.getOption("commandChar")),n=this.client.getOption("enableCommands");this.client.setOption("enableCommands",!0);let s=0,o=0,r=0,a;for(let l=0;l<10;l++){let f=new Date().getTime();this.client.sendCommand(i),a=new Date().getTime()-f,s+=a,a>o&&(o=a),(!r||a<r)&&(r=a),e.push(`${l} - ${a}`)}e.push(`Total - ${s}`),e.push(`Average - ${s/10}`),e.push(`Min - ${r}`),e.push(`Max - ${o}`),this.client.print(e.join(`
`)+`
`,!0),this.client.setOption("enableCommands",n)},this.functions.testperiod=()=>{if(window.periodID){clearInterval(window.periodID),delete window.period,delete window.periodID;return}window.period=0,window.periodID=setInterval(()=>{window.period%3===1?this.client.sendCommand("#testcolors"):window.period%3===2?this.client.sendCommand("#testxterm"):this.client.sendCommand("#testlist"),window.period++},2e3)},this.functions.testutf8=()=>{this.client.print(`Armenian
\u0531 \u0532 \u0533 \u0534 \u0535 \u0536 \u0537 \u0538 \u0539 \u053A \u053B \u053C \u053D \u053E \u053F \u0540 \u0541 \u0542 \u0543 \u0544 \u0545 \u0546 \u0547 \u0548 \u0549 \u054A \u054B \u054C \u054D \u054E \u054F \u0550 \u0551 \u0552 \u0553 \u0554 \u0555 \u0556 \u0559 \u055A \u055B \u055C \u055D \u055E \u055F \u0561 \u0562 \u0563 \u0564 \u0565 \u0566 \u0567 \u0568 \u0569 \u056A \u056B \u056C \u056D \u056E \u056F \u0570 \u0571 \u0572 \u0573 \u0574 \u0575 \u0576 \u0577 \u0578 \u0579 \u057A \u057B \u057C \u057D \u057E \u057F \u0580 \u0581 \u0582 \u0583 \u0584 \u0585 \u0586 \u0587 \u0589
Hebrew
\u0591 \u0592 \u0593 \u0594 \u0595 \u0596 \u0597 \u0598 \u0599 \u059A \u059B \u059C \u059D \u059E \u059F \u05A0 \u05A1 \u05A3 \u05A4 \u05A5 \u05A6 \u05A7 \u05A8 \u05A9 \u05AA \u05AB \u05AC \u05AD \u05AE \u05AF \u05B0 \u05B1 \u05B2 \u05B3 \u05B4 \u05B5 \u05B6 \u05B7 \u05B8 \u05B9 \u05BB \u05BC \u05BD \u05BE \u05BF \u05C0 \u05C1 \u05C2 \u05C3 \u05C4 \u05D0 \u05D1 \u05D2 \u05D3 \u05D4 \u05D5 \u05D6 \u05D7 \u05D8 \u05D9 \u05DA \u05DB \u05DC \u05DD \u05DE \u05DF \u05E0 \u05E1 \u05E2 \u05E3 \u05E4 \u05E5 \u05E6 \u05E7 \u05E8 \u05E9 \u05EA \u05F0 \u05F1 \u05F2 \u05F3 \u05F4
Arabic
\u060C \u061B \u061F \u0621 \u0622 \u0623 \u0624 \u0625 \u0626 \u0627 \u0628 \u0629 \u062A \u062B \u062C \u062D \u062E \u062F \u0630 \u0631 \u0632 \u0633 \u0634 \u0635 \u0636 \u0637 \u0638 \u0639 \u063A \u0640 \u0641 \u0642 \u0643 \u0644 \u0645 \u0646 \u0647 \u0648 \u0649 \u064A \u064B \u064C \u064D \u064E \u064F \u0650 \u0651 \u0652 \u0660 \u0661 \u0662 \u0663 \u0664 \u0665 \u0666 \u0667 \u0668 \u0669 \u066A \u066B \u066C \u066D \u0670 \u0671 \u0672 \u0673 \u0674 \u0675 \u0676 \u0677 \u0678 \u0679 \u067A \u067B \u067C \u067D \u067E \u067F \u0680 \u0681 \u0682 \u0683 \u0684 \u0685 \u0686 \u0687 \u0688 \u0689 \u068A \u068B \u068C \u068D \u068E \u068F \u0690 \u0691 \u0692 \u0693 \u0694 \u0695 \u0696 \u0697 \u0698 \u0699 \u069A \u069B \u069C \u069D \u069E \u069F \u06A0 \u06A1 \u06A2 \u06A3 \u06A4 \u06A5 \u06A6 \u06A7 \u06A8 \u06A9 \u06AA \u06AB \u06AC \u06AD \u06AE \u06AF \u06B0 \u06B1 ...
Devanagari
\u0901 \u0902 \u0903 \u0905 \u0906 \u0907 \u0908 \u0909 \u090A \u090B \u090C \u090D \u090E \u090F \u0910 \u0911 \u0912 \u0913 \u0914 \u0915 \u0916 \u0917 \u0918 \u0919 \u091A \u091B \u091C \u091D \u091E \u091F \u0920 \u0921 \u0922 \u0923 \u0924 \u0925 \u0926 \u0927 \u0928 \u0929 \u092A \u092B \u092C \u092D \u092E \u092F \u0930 \u0931 \u0932 \u0933 \u0934 \u0935 \u0936 \u0937 \u0938 \u0939 \u093C \u093D \u093E \u093F \u0940 \u0941 \u0942 \u0943 \u0944 \u0945 \u0946 \u0947 \u0948 \u0949 \u094A \u094B \u094C \u094D \u0950 \u0951 \u0952 \u0953 \u0954 \u0958 \u0959 \u095A \u095B \u095C \u095D \u095E \u095F \u0960 \u0961 \u0962 \u0963 \u0964 \u0965 \u0966 \u0967 \u0968 \u0969 \u096A \u096B \u096C \u096D \u096E \u096F \u0970
Armenian
\u0531 \u0532 \u0533 \u0534 \u0535 \u0536 \u0537 \u0538 \u0539 \u053A \u053B \u053C \u053D \u053E \u053F \x1B[33m\u0540 \u0541 \u0542 \u0543 \u0544 \u0545 \u0546 \u0547 \u0548 \u0549 \u054A \u054B \u054C \u054D \u054E \u054F \u0550 \u0551 \u0552 \x1B[34m\u0553 \u0554 \u0555 \u0556 \u0559 \u055A \u055B \u055C \u055D \u055E \u055F \u0561 \u0562 \u0563 \u0564 \u0565 \u0566 \u0567 \u0568 \u0569 \u056A \u056B \u056C \u056D \u056E \u056F \u0570\x1B[35m \u0571 \u0572 \u0573 \u0574 \u0575 \u0576 \u0577 \u0578 \u0579 \u057A \u057B \u057C \u057D \u057E \u057F \u0580 \u0581 \u0582 \u0583 \u0584 \u0585 \u0586 \u0587 \u0589\x1B[0m
Hebrew
\u0591 \u0592 \u0593 \u0594 \u0595 \u0596 \u0597 \u0598 \u0599 \u059A \u059B \u059C \u059D \u059E\x1B[33m \u059F \u05A0 \u05A1 \u05A3 \u05A4 \u05A5 \u05A6 \u05A7 \u05A8 \u05A9 \u05AA \u05AB \u05AC \u05AD \u05AE \u05AF \u05B0 \u05B1 \u05B2 \u05B3 \u05B4 \u05B5 \u05B6 \u05B7 \u05B8 \u05B9 \u05BB \u05BC \u05BD \u05BE \u05BF \u05C0 \u05C1 \u05C2 \u05C3 \u05C4 \u05D0 \u05D1 \u05D2 \u05D3 \u05D4 \u05D5 \u05D6 \u05D7 \u05D8 \u05D9 \u05DA \u05DB \u05DC\x1B[34m \u05DD \u05DE \u05DF \u05E0 \u05E1 \u05E2 \u05E3 \u05E4 \u05E5 \u05E6 \u05E7 \u05E8 \u05E9 \u05EA \u05F0 \u05F1 \u05F2 \u05F3 \u05F4\x1B[0m
\u0591 \u0592 \u0593 \u0594 \u0595 \u0596 \u0597 \u0598 \u0599 \u059A \u059B \u059C \u059D \u059E\x1B[33m \u059F \u05A0 \u05A1 \u05A3 \u05A4 \u05A5 \u05A6 \u05A7 \u05A8 \u05A9 \u05AA \u05AB \u05AC \u05AD \u05AE \u05AF \u05B0 \u05B1 \u05B2 \u05B3 \u05B4 \u05B5 \u05B6 \u05B7 \u05B8 \u05B9 \u05BB \u05BC \u05BD \u05BE \u05BF \u05C0 \u05C1 \u05C2 \u05C3 \u05C4 \u05D0 \u05D1 \u05D2 \u05D3 \u05D4 \u05D5 \u05D6 \u05D7 \u05D8 \u05D9 \u05DA \u05DB \u05DCa\x1B[34m \u05DD \u05DE \u05DF \u05E0 \u05E1 \u05E2 \u05E3 \u05E4 \u05E5 \u05E6 \u05E7 \u05E8 \u05E9 \u05EA \u05F0 \u05F1 \u05F2 \u05F3 \u05F4\x1B[0m
Arabic
\u060C \u061B \u061F \u0621 \u0622 \u0623 \u0624 \u0625 \u0626 \u0627 \u0628 \u0629 \u062A \u062B \u062C \u062D \u062E \u062F \u0630 \u0631 \u0632 \u0633 \u0634 \u0635 \u0636 \u0637 \u0638 \u0639\x1B[34m \u063A \u0640 \u0641 \u0642 \u0643 \u0644 \u0645 \u0646 \u0647 \u0648 \u0649 \u064A \u064B \u064C \u064D \u064E \u064F \u0650 \u0651 \u0652 \u0660 \u0661 \u0662 \u0663 \u0664 \u0665 \u0666 \u0667 \u0668 \u0669 \u066A \u066B \u066C \u066D \u0670 \u0671 \u0672 \u0673 \u0674 \u0675 \u0676 \u0677 \u0678 \u0679 \u067A \u067B \u067C \u067D \u067E \u067F \u0680 \u0681 \u0682 \u0683 \u0684 \u0685 \u0686 \u0687 \u0688 \u0689 \u068A \u068B \u068C \u068D \u068E \u068F \u0690 \u0691 \u0692 \u0693 \u0694 \u0695 \u0696 \u0697 \u0698 \u0699 \u069A \u069B \u069C \u069D \u069E \u069F \u06A0 \u06A1 \u06A2 \u06A3 \u06A4 \u06A5 \u06A6 \x1B[33m\u06A7 \u06A8 \u06A9 \u06AA \u06AB \u06AC \u06AD \u06AE \u06AF \u06B0 \u06B1 ...\x1B[0m
Devanagari
\u0901 \u0902 \u0903 \u0905 \u0906 \u0907 \u0908 \u0909 \u090A \u090B \u090C \u090D \u090E \u090F \u0910 \u0911 \u0912 \u0913 \u0914 \u0915 \u0916 \u0917 \u0918 \u0919 \u091A \u091B \u091C \u091D \u091E \u091F \u0920 \u0921 \u0922 \u0923 \u0924 \u0925 \u0926 \u0927 \u0928 \u0929 \u092A \x1B[33m\u092B \u092C \u092D \u092E \u092F \u0930 \u0931 \u0932 \u0933 \u0934 \u0935 \u0936 \u0937 \u0938 \u0939 \u093C \u093D \u093E \u093F \u0940 \u0941 \u0942 \u0943 \u0944 \u0945 \u0946 \u0947 \u0948 \u0949 \u094A \u094B \u094C \u094D \u0950 \u0951 \u0952 \u0953 \u0954 \u0958 \u0959 \u095A \u095B\x1B[34m \u095C \u095D \u095E \u095F \u0960 \u0961 \u0962 \u0963 \u0964 \u0965 \u0966 \u0967 \u0968 \u0969 \u096A \u096B \u096C \u096D \u096E \u096F \u0970\x1B[0m`,!0)},this.functions.testunicodeemoji=()=>{let e="";for(var i=[[128513,128591],[9986,10160],[128640,128704],[128512,128566],[128641,128709],[127757,128359]],n=0,s=0;s<i.length;s++){for(var o=i[s],r=o[0];r<o[1];r++)e+=String.fromCodePoint(r),n++,n==36&&(e+=`
`,n=0);e+="\x1B[4z<hr>",n=0}let a=`\x1B[4z<hr>\xA9\xAE\u203C\u2049#\u20E38\u20E39\u20E37\u20E30\u20E36\u20E35\u20E34\u20E33\u20E32\u20E31\u20E3\u2122\u2139\u2194\u2195\u2196\u2197\u2198\u2199\u21A9\u21AA\u231A\u231B\u23E9\u23EA\u23EB\u23EC\u23F0\u23F3\u25AA\u25AB\u25B6\u25C0\u25FB\u25FC\u25FD\u25FE\u2600\u2601\u260E\u2611\u2614\u2615
\u261D\u263A\u2648\u2649\u264A\u264B\u264C\u264D\u264E\u264F\u2650\u2651\u2652\u2653\u2660\u2663\u2665\u2666\u2668\u267B\u267F\u2693\u26A0\u26A1\u26AA\u26AB\u26BD\u26BE\u26C4\u26C5\u26CE\u26D4\u26EA\u26F2\u26F3\u26F5
\u26FA\u26FD\u2934\u2935\u2B05\u2B06\u2B07\u2B1B\u2B1C\u2B50\u2B55\u3030\u303D\u3297\u3299\u{1F004}\u{1F0CF}\u{1F300}\u{1F301}\u{1F302}\u{1F303}\u{1F304}\u{1F305}\u{1F306}\u{1F307}\u{1F308}\u{1F309}\u{1F30A}\u{1F30B}\u{1F30C}\u{1F30F}\u{1F311}\u{1F313}\u{1F314}\u{1F315}
\u{1F319}\u{1F31B}\u{1F31F}\u{1F320}\u{1F330}\u{1F331}\u{1F334}\u{1F335}\u{1F337}\u{1F338}\u{1F339}\u{1F33A}\u{1F33B}\u{1F33C}\u{1F33D}\u{1F33E}\u{1F33F}\u{1F340}\u{1F341}\u{1F342}\u{1F343}\u{1F344}\u{1F345}\u{1F346}\u{1F347}\u{1F348}\u{1F349}\u{1F34A}\u{1F34C}\u{1F34D}\u{1F34E}\u{1F34F}\u{1F351}
\u{1F352}\u{1F353}\u{1F354}\u{1F355}\u{1F356}\u{1F357}\u{1F358}\u{1F359}\u{1F35A}\u{1F35B}\u{1F35C}\u{1F35D}\u{1F35E}\u{1F35F}\u{1F360}\u{1F361}\u{1F362}\u{1F363}\u{1F364}\u{1F365}\u{1F366}\u{1F367}\u{1F368}\u{1F369}\u{1F36A}\u{1F36B}\u{1F36C}\u{1F36D}\u{1F36E}\u{1F36F}\u{1F370}\u{1F371}\u{1F372}
\u{1F373}\u{1F374}\u{1F375}\u{1F376}\u{1F377}\u{1F378}\u{1F379}\u{1F37A}\u{1F37B}\u{1F380}\u{1F381}\u{1F382}\u{1F383}\u{1F384}\u{1F385}\u{1F386}\u{1F387}\u{1F388}\u{1F389}\u{1F38A}\u{1F38B}\u{1F38C}\u{1F38D}\u{1F38E}\u{1F38F}\u{1F390}\u{1F391}\u{1F392}\u{1F393}\u{1F3A0}\u{1F3A1}\u{1F3A2}\u{1F3A3}\u{1F3A4}
\u{1F3A5}\u{1F3A6}\u{1F3A7}\u{1F3A8}\u{1F3A9}\u{1F3AA}\u{1F3AB}\u{1F3AC}\u{1F3AD}\u{1F3AE}\u{1F3AF}\u{1F3B0}\u{1F3B1}\u{1F3B2}\u{1F3B3}\u{1F3B4}\u{1F3B5}\u{1F3B6}\u{1F3B7}\u{1F3B8}\u{1F3B9}\u{1F3BA}\u{1F3BB}\u{1F3BC}\u{1F3BD}\u{1F3BE}\u{1F3BF}\u{1F3C0}\u{1F3C1}\u{1F3C2}\u{1F3C3}\u{1F3C4}
\u{1F3C6}\u{1F3C8}\u{1F3CA}\u{1F3E0}\u{1F3E1}\u{1F3E2}\u{1F3E3}\u{1F3E5}\u{1F3E6}\u{1F3E7}\u{1F3E8}\u{1F3E9}\u{1F3EA}\u{1F3EB}\u{1F3EC}\u{1F3ED}\u{1F3EE}\u{1F3EF}\u{1F3F0}\u{1F40C}\u{1F40D}\u{1F40E}\u{1F411}\u{1F412}\u{1F414}\u{1F417}\u{1F418}\u{1F419}\u{1F41A}\u{1F41B}\u{1F41C}\u{1F41D}
\u{1F41E}\u{1F41F}\u{1F420}\u{1F421}\u{1F422}\u{1F423}\u{1F424}\u{1F425}\u{1F426}\u{1F427}\u{1F428}\u{1F429}\u{1F42B}\u{1F42C}\u{1F42D}\u{1F42E}\u{1F42F}\u{1F430}\u{1F431}\u{1F432}\u{1F433}\u{1F434}\u{1F435}\u{1F436}\u{1F437}\u{1F438}\u{1F439}\u{1F43A}\u{1F43B}\u{1F43C}\u{1F43D}\u{1F43E}
\u{1F440}\u{1F442}\u{1F443}\u{1F444}\u{1F445}\u{1F446}\u{1F447}\u{1F448}\u{1F449}\u{1F44A}\u{1F44B}\u{1F44C}\u{1F44D}\u{1F44E}\u{1F44F}\u{1F450}\u{1F451}\u{1F452}\u{1F453}\u{1F454}\u{1F455}\u{1F456}\u{1F457}\u{1F458}\u{1F459}\u{1F45A}\u{1F45B}\u{1F45C}\u{1F45D}\u{1F45E}\u{1F45F}\u{1F460}\u{1F461}\u{1F462}
\u{1F463}\u{1F464}\u{1F466}\u{1F467}\u{1F468}\u{1F469}\u{1F46A}\u{1F46B}\u{1F46E}\u{1F46F}\u{1F470}\u{1F471}\u{1F472}\u{1F473}\u{1F474}\u{1F475}\u{1F476}\u{1F477}\u{1F478}\u{1F479}\u{1F47A}\u{1F47B}\u{1F47C}\u{1F47D}\u{1F47E}\u{1F47F}\u{1F480}\u{1F481}\u{1F482}\u{1F483}\u{1F484}\u{1F485}\u{1F486}
\u{1F487}\u{1F488}\u{1F489}\u{1F48A}\u{1F48B}\u{1F48C}\u{1F48D}\u{1F48E}\u{1F48F}\u{1F490}\u{1F491}\u{1F492}\u{1F493}\u{1F494}\u{1F495}\u{1F496}\u{1F497}\u{1F498}\u{1F499}\u{1F49A}\u{1F49B}\u{1F49C}\u{1F49D}\u{1F49E}\u{1F49F}\u{1F4A0}\u{1F4A1}\u{1F4A2}\u{1F4A3}\u{1F4A4}\u{1F4A5}\u{1F4A6}\u{1F4A7}
\u{1F4A8}\u{1F4A9}\u{1F4AA}\u{1F4AB}\u{1F4AC}\u{1F4AE}\u{1F4AF}\u{1F4B0}\u{1F4B1}\u{1F4B2}\u{1F4B3}\u{1F4B4}\u{1F4B5}\u{1F4B8}\u{1F4B9}\u{1F4BA}\u{1F4BB}\u{1F4BC}\u{1F4BD}\u{1F4BE}\u{1F4BF}\u{1F4C0}\u{1F4C1}\u{1F4C2}\u{1F4C3}\u{1F4C4}\u{1F4C5}\u{1F4C6}\u{1F4C7}\u{1F4C8}\u{1F4C9}\u{1F4CA}\u{1F4CB}
\u{1F4CC}\u{1F4CD}\u{1F4CE}\u{1F4CF}\u{1F4D0}\u{1F4D1}\u{1F4D2}\u{1F4D3}\u{1F4D4}\u{1F4D5}\u{1F4D6}\u{1F4D7}\u{1F4D8}\u{1F4D9}\u{1F4DA}\u{1F4DB}\u{1F4DC}\u{1F4DD}\u{1F4DE}\u{1F4DF}\u{1F4E0}\u{1F4E1}\u{1F4E2}\u{1F4E3}\u{1F4E4}\u{1F4E5}\u{1F4E6}\u{1F4E7}\u{1F4E8}\u{1F4E9}\u{1F4EA}\u{1F4EB}\u{1F4EE}\u{1F4F0}
\u{1F4F1}\u{1F4F2}\u{1F4F3}\u{1F4F4}\u{1F4F6}\u{1F4F7}\u{1F4F9}\u{1F4FA}\u{1F4FB}\u{1F4FC}\u{1F503}\u{1F50A}\u{1F50B}\u{1F50C}\u{1F50D}\u{1F50E}\u{1F50F}\u{1F510}\u{1F511}\u{1F512}\u{1F513}\u{1F514}\u{1F516}\u{1F517}\u{1F518}\u{1F519}\u{1F51A}\u{1F51B}\u{1F51C}\u{1F51D}\u{1F51E}\u{1F51F}\u{1F520}
\u{1F521}\u{1F522}\u{1F523}\u{1F524}\u{1F525}\u{1F526}\u{1F527}\u{1F528}\u{1F529}\u{1F52A}\u{1F52B}\u{1F52E}\u{1F52F}\u{1F530}\u{1F531}\u{1F532}\u{1F533}\u{1F534}\u{1F535}\u{1F536}\u{1F537}\u{1F538}\u{1F539}\u{1F53A}\u{1F53B}\u{1F53C}\u{1F53D}\u{1F550}\u{1F551}\u{1F552}\u{1F553}\u{1F554}\u{1F555}
\u{1F556}\u{1F557}\u{1F558}\u{1F559}\u{1F55A}\u{1F55B}\u{1F5FB}\u{1F5FC}\u{1F5FD}\u{1F5FE}\u{1F5FF}`;this.client.print(e,!0),this.client.print(a,!0)},this.functions.testlines=()=>{let e=this.client.display.maxLines,i="",n=this.client.display.model.getNextLineID;for(let s=0;s<e;s++)i+=`Line: ${s}, LineID: ${n+s}
`;this.client.print(i,!0)},this.functions.testscreen=()=>{let e="Window innerWidth: "+window.innerWidth;e+=`
Window innerHeight: `+window.innerHeight,e+=`
Document clientWidth: `+document.body.clientWidth,e+=`
Document clientHeight: `+document.body.clientHeight,e+=`
Display clientWidth: `+this.client.display.container.clientWidth,e+=`
Display clientHeight: `+this.client.display.container.clientHeight,e+=`
Screen orientation: `+screen?.orientation?.type,this.client.print(e,!0)}}remove(){this.client&&this.client.off("function",this._event)}initialize(){this.client&&this.client.on("function",this._event)}get menu(){return[]}get settings(){return[]}processFunction(t){let e;t&&(e=t.name.toLowerCase(),e.endsWith("()")&&(e=e.substring(0,e.length-2)),this.functions[e]&&(console.time(e),this.functions[e].apply(this,t||{}),console.timeEnd(e),t.handled=!0))}};var Fe=class extends ie{constructor(t){super();this._enableDebug=!1;this._itemCache={triggers:null,aliases:null,macros:null,buttons:null,contexts:null,defaultContext:null,alarms:null,alarmPatterns:[]};this._variables={};this._options={};this.active=!0;this.connecting=!1;this.version=Wt;this.connectTime=0;this.disconnectTime=0;this.lastSendTime=0;this.defaultTitle="oiMUD";this.errored=!1;if(window.client=this,window.oiMUD=this,this._plugins=[],t=Object.assign({display:"#display",commandInput:"#commandInput"},t||{}),(!("display"in t)||typeof t.display===void 0)&&(t.display="#display"),(!("commandInput"in t)||typeof t.commandInput===void 0)&&(t.commandInput="#commandInput"),this._display=new Qe(t.display),this.display.on("click",i=>{this.getOption("CommandonClick")&&this._commandInput.focus()}),this.display.on("scroll-lock",i=>{this.scrollLock=i}),this.display.on("update-window",(i,n)=>{this.telnet.updateWindow(i,n)}),this.display.on("update-window",(i,n)=>{this.telnet.updateWindow(i,n)}),this.display.on("debug",i=>{this.debug(i)}),this.display.on("add-line",i=>{this.emit("add-line",i)}),this.display.on("add-line-done",i=>{this.emit("add-line-done",i)}),this.display.on("MXP-tag-reply",(i,n)=>{let s={tag:i,args:n,preventDefault:!1};if(this.emit("MXP-tag-reply",s),!s.preventDefault)switch(i){case"VERSION":this.display.MXPStyleVersion&&this.display.MXPStyleVersion.length?(this.debug(`MXP Tag REPLY: <VERSION MXP=1.0 STYLE=${this.display.MXPStyleVersion} CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>`),this.send(`\x1B[1z<VERSION MXP=1.0 STYLE=${this.display.MXPStyleVersion} CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>\r
`)):(this.debug(`MXP Tag REPLY: <VERSION MXP=1.0 CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>`),this.send(`\x1B[1z<VERSION MXP=1.0 CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>\r
`));break;case"SUPPORT":this.debug(`MXP Tag REPLY: <SUPPORTS ${n.join(" ")}>`),this.send(`\x1B[1z<SUPPORTS ${n.join(" ")}>\r
`);break;case"USER":this.emit("sendUsername",s);break;case"PASSWORD":this.emit("sendPassword",s);break}}),this.display.on("expire-links",i=>{this.emit("expire-links",i)}),this.display.on("parse-done",()=>{this.emit("parse-done")}),this.display.on("set-title",(i,n)=>{typeof i>"u"||i==null||i.length===0?this.emit("set-title",this.getOption("title").replace("$t",this.defaultTitle)||this.defaultTitle):n!==1&&this.emit("set-title",this.getOption("title").replace("$t",i)||"")}),this.display.on("music",i=>{this.emit("music",i)}),this.display.on("sound",i=>{this.emit("sound",i)}),this.display.on("bell",()=>{this.emit("bell")}),typeof t.commandInput=="string"){if(this._commandInput=document.querySelector(t.commandInput),!this._commandInput)throw new Error("Invalid selector for command input.")}else if(t.commandInput instanceof $)this._commandInput=t.commandInput[0];else if(t.commandInput instanceof HTMLElement)this._commandInput=t.commandInput;else throw new Error("Command input must be a selector, element or jquery object");this._telnet=new We({protocol:t.protocol,scheme:t.scheme}),this._telnet.terminal="oiMUD",this._telnet.version=this.version,this._telnet.GMCPSupports.push("oMUD 1"),this._telnet.GMCPSupports.push("Client.Media 1"),this._telnet.on("error",i=>{if(this.enableDebug&&this.debug(i),i){if(i.type==="close"&&i.code===1006)return;let n=[];i.type&&n.push(i.type),i.text&&n.push(i.text),i.message&&n.push(i.message),i.reason&&n.push(i.reason),i.code?this.error(i.code+" : "+n.join(", ")):this.error(n.join(", "))}else this.error("Unknown telnet error.");this.getOption("autoConnect")&&!this._telnet.connected&&setTimeout(()=>{this.connect()},client.getOption("autoConnectDelay")),this.emit("reconnect")}),this.telnet.on("connecting",()=>{this.connecting=!0,this.echo("Trying to connect to "+this.host+":"+this.port,-7,-8,!0,!0)}),this.telnet.on("connect",()=>{this.connecting=!1,this.echo("Connected...",-7,-8,!0,!0),this.connectTime=Date.now(),this.disconnectTime=0,this.lastSendTime=Date.now(),this.emit("connected"),this.raise("connected")}),this.telnet.on("debug",i=>{this.debug(i)}),this.telnet.on("receive-option",i=>{this.emit("received-option",i)}),this.telnet.on("close",()=>{this.connecting=!1,this.echo("Connection closed to "+this.host+":"+this.port,-7,-8,!0,!0),this.disconnectTime=Date.now(),this.emit("closed"),this.raise("disconnected"),this.connectTime=0,this.lastSendTime=0}),this.telnet.on("received-data",i=>{i={value:i},this.emit("received-data",i),!(i==null||typeof i>"u"||i.value==null||typeof i.value>"u")&&(this.printInternal(i.value,!1,!0),this.debug("Latency: "+this.telnet.latency+"ms"),this.debug("Latency: "+this.telnet.latency/1e3+"s"))}),this.telnet.on("received-MSDP",i=>{this.emit("received-MSDP",i)}),this.telnet.on("received-GMCP",i=>{let n=i.value,s,o=0,r=n.length,a;if(r===0)return;for(o=0;o<r&&(a=n.charAt(o),!(a===" "||a==="{"||a==="["));o++);s=n.substr(0,o).trim(),n=n.substr(o).trim(),this.debug("GMCP Module: "+s),this.debug("GMCP Data: "+n);let l;if(s.toLowerCase()==="client.gui"){l=n.split("/n"),n.length>=2?l={version:parseInt(l[0],10),url:l[1]}:n.length>0?l={version:parseInt(l[0],10),url:l[1]}:l={version:l,url:""},this.emit("received-GMCP",s,l);return}try{n.length>0&&(l=JSON.parse(n))}catch{this.error("Invalid GMCP");return}this.emit("received-GMCP",s,l)}),this.telnet.on("windowSize",()=>{this.UpdateWindow()});let e=vt("host");e!==null&&e.length?this.host=e:t&&"host"in t?this.host=t.host:this.host="127.0.0.1",e=+vt("port"),!isNaN(e)&&e>0?this.port=e:t&&"port"in t?this.port=t.port:this.port=23,this._input=new rt(this),this._input.on("scroll-lock",i=>{this.display.scrollLock=i,this.emit("scroll-lock",i)}),this._input.on("command-history-changed",i=>this.emit("command-history-changed",i)),this._input.on("item-added",(i,n,s)=>{this.emit("item-added",i,n,s)}),this._input.on("item-updated",(i,n,s,o)=>{this.emit("item-updated",i,n,s,o)}),this._input.on("item-removed",(i,n,s)=>{this.emit("item-removed",i,n,s)}),this.loadOptions(),this._commandInput.value="",this._commandInput.focus(),window.addEventListener("blur",()=>{this.active=!1,this.emit("blur"),this.raise("blur")}),window.addEventListener("focus",()=>{this.active=!0,this.emit("focus"),this.raise("focus")}),window.addEventListener("beforeunload",i=>{if(this.connected)return i&&(i.returnValue="Closing or reloading will disconnect you from the mud."),"Closing or reloading will disconnect you from the mud.";this.raise("closed")}),window.addEventListener("unload",()=>{this.connected&&this.close()}),this.addPlugin(new ft(this)),this.addPlugin(new pt(this)),this.getOption("autoConnect")&&setTimeout(()=>{this.connect()},client.getOption("autoConnectDelay")),this.emit("initialized")}get telnet(){return this._telnet}get variables(){return this._variables}get commandInput(){return this._commandInput}get display(){return this._display}get profiles(){return this._profiles}get plugins(){return this._plugins}get options(){return this._options}get input(){return this._input}set simpleAlarms(t){this.setOption("simpleAlarms",t)}get simpleAlarms(){return this.getOption("simpleAlarms")}set enableParsing(t){this.setOption("enableParsing",t),this._input.enableParsing=t}get enableParsing(){return this.getOption("enableParsing")}set enableTriggers(t){this.setOption("enableTriggers",t),this._input.enableTriggers=t,this.startAlarms()}get enableTriggers(){return this.getOption("enableTriggers")}get enableDebug(){return this._enableDebug}set enableDebug(t){this._enableDebug=t,this._telnet.enableDebug=t,this._display.enableDebug=t}get host(){return this._telnet.host}set host(t){this._telnet.host=t}get port(){return this._telnet.port}set port(t){this._telnet.port=t}get connected(){return this._telnet.connected}get activeProfile(){return this._profiles.active}get commandHistory(){return this._input.commandHistory}get indices(){return this._input.indices}get repeatnum(){return this._input.repeatnum}get aliases(){if(this._itemCache.aliases)return this._itemCache.aliases;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableAliases?this._itemCache.aliases=[]:this._itemCache.aliases=H(this.profiles.items[t[i]].aliases),this._itemCache.aliases;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableAliases||this.profiles.items[t[i]].aliases.length===0||e.push.apply(e,H(this.profiles.items[t[i]].aliases));return this._itemCache.aliases=e,this._itemCache.aliases}get macros(){if(this._itemCache.macros)return this._itemCache.macros;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableMacros?this._itemCache.macros=[]:this._itemCache.macros=H(this.profiles.items[t[i]].macros),this._itemCache.macros;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableMacros||this.profiles.items[t[i]].macros.length===0||e.push.apply(e,H(this.profiles.items[t[i]].macros));return this._itemCache.macros=e,this._itemCache.macros}get triggers(){if(this._itemCache.triggers)return this._itemCache.triggers;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableTriggers?this._itemCache.triggers=[]:this._itemCache.triggers=H(this.profiles.items[t[0]].triggers),this._itemCache.triggers;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableTriggers||this.profiles.items[t[i]].triggers.length===0||e.push.apply(e,H(this.profiles.items[t[i]].triggers));return this._itemCache.triggers=e,this._itemCache.triggers}removeTrigger(t){let e=this.profiles.keys,i=0,n=e.length,s=-1;if(n!==0){if(n===1){if(!this.profiles.items[e[0]].enabled||!this.profiles.items[e[0]].enableTriggers)return;s=this.profiles.items[e[i]].triggers.indexOf(t)}else for(;i<n&&s!==-1&&!(!(!this.profiles.items[e[i]].enabled||!this.profiles.items[e[i]].enableTriggers||this.profiles.items[e[i]].triggers.length===0)&&(s=this.profiles.items[e[i]].triggers.indexOf(t),s!==-1));i++);s!==-1&&(this.profiles.items[e[i]].triggers.splice(s,1),this._itemCache.triggers=null,(t.triggers.length||t.type===3)&&this._itemCache.alarms&&(s=this._itemCache.alarms.indexOf(t),s!==-1&&(this._itemCache.alarms.splice(s,1),this._itemCache.alarmPatterns.splice(s,1))),this.saveProfiles(),this.emit("item-removed","trigger",e[i],s))}}get alarms(){if(this._itemCache.alarms)return this._itemCache.alarms;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableTriggers?this._itemCache.alarms=[]:this._itemCache.alarms=$.grep(H(this.profiles.items[t[i]].triggers),s=>{if(s&&s.enabled&&s.triggers.length){if(s.type===3)return!0;for(let o=0,r=s.triggers.length;o<r;o++)if(s.triggers[o].enabled&&s.triggers[o].type===3)return!0;return!1}return s&&s.enabled&&s.type===3}),this._itemCache.alarms.reverse(),this._itemCache.alarms;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableTriggers||this.profiles.items[t[i]].triggers.length===0||e.push.apply(e,H(this.profiles.items[t[i]].triggers));return this._itemCache.alarms=$.grep(e,s=>{if(s&&s.enabled&&s.triggers.length){if(s.type===3)return!0;for(let o=0,r=s.triggers.length;o<r;o++)if(s.triggers[o].enabled&&s.triggers[o].type===3)return!0;return!1}return s&&s.enabled&&s.type===3}),this._itemCache.alarms.reverse(),this._itemCache.alarms}get buttons(){if(this._itemCache.buttons)return this._itemCache.buttons;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableButtons?this._itemCache.buttons=[]:this._itemCache.buttons=H(this.profiles.items[t[i]].buttons),this._itemCache.buttons;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableButtons||this.profiles.items[t[i]].buttons.length===0||e.push.apply(e,H(this.profiles.items[t[i]].buttons));return this._itemCache.buttons=e,this._itemCache.buttons}get contexts(){if(this._itemCache.contexts)return this._itemCache.contexts;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableContexts?this._itemCache.contexts=[]:this._itemCache.contexts=H(this.profiles.items[t[i]].contexts),this._itemCache.contexts;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableContexts||this.profiles.items[t[i]].contexts.length===0||e.push.apply(e,H(this.profiles.items[t[i]].contexts));return this._itemCache.contexts=e,this._itemCache.contexts}get defaultContext(){return this._itemCache.defaultContext!==null?this._itemCache.defaultContext:(this._itemCache.defaultContext=this.profiles.defaultContext,this._itemCache.defaultContext)}addPlugin(t){t&&(this.plugins.push(t),t.initialize())}removePlugin(t){if(!this.plugins.length)return;let e=this.plugins.indexOf(t);e!==-1&&(t.remove(),this.plugins.splice(e,1))}getVariable(t){return this.variables[t]}setVariable(t,e){this.variables[t]=e}setVariables(t){let e=Object.keys(t);if(e.length===0)return;let i=e.length,n;for(let s=0;s<i;s++)n=e[s],this.variables[n]=t[n]}hasVariable(t){return this.variables.hasOwnProperty(t)}removeVariable(t){this.variables.hasOwnProperty(t)&&delete this.variables[t]}setHistoryIndex(t){this._input.setHistoryIndex(t)}clearCommandHistory(){this._input.clearCommandHistory()}AddCommandToHistory(t){this._input.AddCommandToHistory(t)}loadProfiles(){return new Promise((t,e)=>{it.load().then(i=>{this._profiles=i,this.profiles.contains("default")||(this.profiles.add(pe.Default),this.saveProfiles()),this.clearCache(),this.startAlarms(),this.emit("profiles-loaded"),t(this._profiles)})})}removeProfile(t){t&&(this.profiles.remove(t),this.clearCache(),this.startAlarms(),this.emit("profile-removed",t))}saveProfiles(){this._profiles.save(),this.clearCache(),this.emit("profiles-updated")}toggleProfile(t){this.profiles.toggle(t),this.saveProfiles(),this.clearCache(),this.startAlarms(),this.emit("profile-toggled",t,this.profiles[t].enabled)}startAlarms(){let t=this.alarms.length;(t===0||!this.getOption("enableTriggers"))&&this._alarm?(clearInterval(this._alarm),this._alarm=null):t&&!this._alarm&&(this._alarm=setInterval(e=>{e.process_alarms()},1e3,this))}setAlarmState(t,e){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length)return;let i=this._itemCache.alarmPatterns[t];if(!i){i={},this.alarms[t].type===3&&(i[0]=oe.parse(this.alarms[t]));for(let n=0,s=this.alarms[t].triggers.length;n<s;n++)this.alarms[t].triggers[n].enabled&&this.alarms[t].triggers[n].type===3&&(i[n]=oe.parse(this.alarms[t].triggers[n]));this._itemCache.alarmPatterns[t]=i}for(let n in i)i.hasOwnProperty(n)&&(e?(i[n].startTime+=Date.now()-i[n].suspended,i[n].prevTime+=Date.now()-i[n].suspended,i[n].tempTime&&(i[n].tempTime+=Date.now()-i[n].suspended),i[n].suspended=0):i[n].suspended=Date.now())}setAlarmTempTime(t,e){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length)return;let i=this._itemCache.alarmPatterns[t];if(!i){i={},this.alarms[t].type===3&&(i[0]=oe.parse(this.alarms[t]));for(let n=0,s=this.alarms[t].triggers.length;n<s;n++)this.alarms[t].triggers[n].enabled&&this.alarms[t].triggers[n].type===3&&(i[n]=oe.parse(this.alarms[t].triggers[n]));this._itemCache.alarmPatterns[t]=i}i[0]&&i[0].setTempTime(e)}restartAlarmState(t,e,i){if(e===i||(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length))return;let n=this._itemCache.alarmPatterns[t];if(!n){n={},this.alarms[t].type===3&&(n[0]=oe.parse(this.alarms[t]));for(let s=0,o=this.alarms[t].triggers.length;s<o;s++)this.alarms[t].triggers[s].enabled&&this.alarms[t].triggers[s].type===3&&(n[s]=oe.parse(this.alarms[t].triggers[s]));this._itemCache.alarmPatterns[t]=n}n[e]&&(n[e].restart=Date.now()),n[i]&&(n[i].restart=Date.now())}getRemainingAlarmTime(t){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length||!this.alarms[t].enabled)return 0;let e=this._itemCache.alarmPatterns[t];if(!e){e={},this.alarms[t].type===3&&(e[0]=oe.parse(this.alarms[t]));for(let i=0,n=this.alarms[t].triggers.length;i<n;i++)this.alarms[t].triggers[i].enabled&&this.alarms[t].triggers[i].type===3&&(e[i]=oe.parse(this.alarms[t].triggers[i]));this._itemCache.alarmPatterns[t]=e}if(e[0]){let i=e[0],n=Date.now(),s=new Date,o=n,r=o+9e7,a=1e3;if(i.seconds!==-1?a=1e3:i.minutes!==-1?a=6e4:i.hours!==-1&&(a=36e5),i.tempTime)return i.tempTime-n>0?i.tempTime-n:0;for(;o<r;){if(this.alarm_match(i,o,s))return o-n;o+=a,s.setTime(s.getTime()+a)}return-1}return 0}updateAlarms(){if(this._itemCache.alarmPatterns){let t=this._itemCache.alarmPatterns,e=this.alarms;this._itemCache.alarmPatterns=[],this._itemCache.alarms=null;let i=this.alarms.length,n=-1;for(let s=0;s<i;s++)n=e.indexOf(this.alarms[s]),n!==-1&&(this._itemCache.alarmPatterns[s]=t[n])}this.startAlarms()}process_alarms(){if(!this.getOption("enableTriggers"))return;let t=0,e=!1,i=this.alarms.length;if(i===0&&this._alarm){clearInterval(this._alarm),this._alarm=null;return}let n=this._itemCache.alarmPatterns,s=Date.now(),o=this.alarms,r=new Date;for(t=i-1;t>=0;t--){let a=o[t],l=a;if(!a.enabled)continue;if(a.state>a.triggers.length&&(a.state=0),a.state!==0&&a.triggers&&a.triggers.length){for(a=a.triggers[a.state-1];!a.enabled&&l.state!==0;){if(l.state++,l.state>l.triggers.length){l.state=0,a=a.triggers[l.state-1];break}l.state?a=a.triggers[l.state-1]:a=l,e=!0}if(e&&(this.getOption("saveTriggerStateChanges")&&this.saveProfiles(),this.emit("item-updated","trigger",l.profile.name,l.profile.triggers.indexOf(l))),!a.enabled)continue}if(a.type===131072||a.type===262144){let b=this._input.adjustLastLine(this.display.lines.length,!0),h=this.display.lines[b];t=this._input.TestTrigger(a,l,t,h,this.display.lines[b].raw||h,b===this.display.lines.length-1);continue}if(a.type!==3)continue;let f=n[t];if(!f){try{n[t]={},a.type===3&&(n[t][0]=oe.parse(a));for(let b=0,h=a.triggers.length;b<h;b++)a.triggers[b].type===3&&(n[t][b]=oe.parse(a.triggers[b]))}catch(b){throw n[t]=null,this.getOption("disableTriggerOnError")&&(a.enabled=!1,setTimeout(()=>{this.saveProfiles(),this.emit("item-updated","trigger",l.profile,l.profile.triggers.indexOf(l),l)})),b}if(f=n[t],!f)continue}f=f[a.state],f.restart&&(f.startTime=Date.now(),f.prevTime=f.startTime,f.tempTime&&(f.tempTime+=Date.now()-f.restart),f.restart=0);let u=!0;if(f.tempTime?(u=s>=f.tempTime,u&&(f.tempTime=0)):u=this.alarm_match(f,s,r),u&&!f.suspended){f.prevTime=s;let b=l.state;if(this._input.lastTriggered=f.pattern,this._input.ExecuteTrigger(a,[f.pattern],!1,-t,null,null,l),b!==l.state&&(f.restart=Date.now()),f.temp)if(l.triggers.length)if(b===0){let h=l.triggers.shift();h.state=b,h.priority=l.priority,h.name=l.name,h.profile=l.profile,h.state>h.triggers.length&&(h.state=0),h.triggers=l.triggers,o[t]=h,n[t]=null,this.saveProfiles();let E=l.profile.triggers.indexOf(l);l.profile.triggers[E]=h,this.emit("item-updated","trigger",l.profile.name,E,h)}else{l.triggers.splice(b-1,1),n[t].splice(b-1,1),l.state=b,l.state>l.triggers.length&&(l.state=0),this.saveProfiles();let h=l.profile.triggers.indexOf(l);this.emit("item-updated","trigger",l.profile.name,h,l)}else this._input.clearTriggerState(t),this.removeTrigger(l);t=-this._input.cleanUpTriggerState(-t)}}}alarm_match(t,e,i){if(!t||t.suspended)return!1;let n=!0,s,o,r,a,l,f,u;if(!moment||this.simpleAlarms){if(s=e-this.connectTime,s<1e3)return!1;o=Math.round(s/1e3),r=Math.floor(o/60),a=Math.floor(r/60),l=a,f=Math.floor(r%60),u=Math.floor(o%60)}else{if(t.start?s=moment.duration(e-this.connectTime):s=moment.duration(e-t.startTime),s.asMilliseconds()<1e3)return!1;o=Math.round(s.asMilliseconds()/1e3),r=Math.floor(o/60),a=Math.floor(r/60),l=s.hours(),f=s.minutes(),u=s.seconds()}return t.hoursWildCard?t.hours===0?n=n&&l===0:t.hours!==-1&&(n=n&&a!==0&&a%t.hours===0):t.hours!==-1&&(n=n&&t.hours===(t.start?l:i.getHours())),t.minutesWildcard?t.minutes===0?n=n&&f===0:t.minutes!==-1&&(n=n&&r!==0&&r%t.minutes===0):t.minutes!==-1&&(n=n&&t.minutes===(t.start?f:i.getMinutes())),t.secondsWildcard?t.seconds===0?n=n&&u===0:t.seconds!==-1&&(n=n&&o%t.seconds===0):t.seconds!==-1&&(n=n&&t.seconds===(t.start?u:i.getSeconds())),n}loadOptions(){this._options=new Ae,this.enableDebug=this._options.enableDebug,this.display.maxLines=this._options.bufferSize,this.display.enableFlashing=this._options.flashing,this.display.enableMXP=this._options.enableMXP,this.display.showInvalidMXPTags=this._options["display.showInvalidMXPTags"],this.display.enableURLDetection=this._options.enableURLDetection,this.display.enableMSP=this._options.enableMSP,this.display.enableColors=this._options["display.enableColors"],this.display.enableBackgroundColors=this._options["display.enableBackgroundColors"],this.display.wordWrap=this._options["display.wordWrap"],this.display.wrapAt=this._options["display.wrapAt"],this.display.indent=this._options["display.indent"],this.display.showTimestamp=this._options["display.showTimestamp"],this.display.tabWidth=this._options["display.tabWidth"],this.display.timestampFormat=this._options["display.timestampFormat"];let t=this.getOption("colors");if(t&&t.length>0){let e,i=t.length;for(e=0;e<i;e++)!t[e]||t[e].length===0||this.display.SetColor(e,t[e])}this._telnet&&(this._telnet.options.MCCP=this._options.enableMCCP,this._telnet.options.MXP=this._options.enableMXP,this._telnet.UTF8=this._options.enableUTF8,this._telnet.options.ECHO=this._options.enableEcho,this._telnet.enableLatency=this._options.lagMeter,this._telnet.enablePing=this._options.enablePing),this._input.scrollLock=this._options.scrollLocked,this._input.enableParsing=this._options.enableParsing,this._input.enableTriggers=this._options.enableTriggers,this.display.scrollLock=this._options.scrollLocked,this.display.hideTrailingEmptyLine=this._options["display.hideTrailingEmptyLine"],this.display.displayControlCodes=this.getOption("display.displayControlCodes"),this.display.emulateTerminal=this.getOption("display.emulateTerminal"),this.display.emulateControlCodes=this.getOption("display.emulateControlCodes"),this._commandInput.wrap=this.getOption("commandWordWrap")?"on":"off",this.UpdateFonts&&this.UpdateFonts(),this.display.scrollDisplay(),this.loadProfiles(),this.emit("options-loaded")}setOption(t,e){t===-1||t==="-1"||(this._options[t]=e,Ae.setValue(t,e),this.emit("option=changed",t,e))}getOption(t){return this._options&&t in this._options?this._options[t]:this._options[t]=Ae.getValue(t)}UpdateFonts(){this.display&&(this.display.updateFont(this._options.font+", monospace",this._options.fontSize),this._commandInput.style.fontSize=this._options.cmdfontSize,this._commandInput.style.fontFamily=this._options.cmdfont+", monospace")}parse(t){this.parseInternal(t,!1,!1,!0)}parseInternal(t,e,i,n){this.display.append(t,e,i,n)}error(t){this.enableDebug&&this.debug(t);let e="";t==null||typeof t>"u"?t=new Error("Unknown"):typeof t=="string"&&t.length===0&&(t=new Error("Unknown")),t.stack&&this.getOption("showErrorsExtended")?e=t.stack:t instanceof Error||t instanceof TypeError?e=t.name+": "+t.message:t.message?e=t.message:e=""+t,e.match(/^.*Error: /g)||e.match(/^.*Error - /g)?this.echo(e,-11,-12,!0,!0):this.echo("Error: "+e,-11,-12,!0,!0),this.getOption("logErrors")&&(this.getOption("showErrorsExtended")?t.stack||(t=new Error(t||e),e=t.stack):(t.stack||(t=new Error(t||e)),e=t.stack),window.console.log(new Date().toLocaleString()),window.console.log(e),localforage.getItem("oiMUDErrorLog",function(i,n){localforage.setItem("oiMUDErrorLog",n=(n||"")+new Date().toLocaleString()+`
`+e+`
`)})),t==="Error: ECONNRESET - read ECONNRESET."&&this.telnet.connected&&this.close(),this.raise("error",e)}echo(t,e,i,n,s){t==null&&(t=""),n==null&&(n=!1),s==null&&(s=!1),e==null&&(e=-3),i==null&&(i=-4);let o="\x1B[0m"+this.display.CurrentAnsiCode()+`
`;t=""+t,t.endsWith(`
`)&&(t=t.substr(0,t.length-1)),this.telnet.prompt&&s?(this.print(`
\x1B[`+e+";"+i+"m"+t+o,n),this.telnet.prompt=!1):this.print("\x1B["+e+";"+i+"m"+t+o,n)}print(t,e){this.printInternal(t,e,!1,!0)}printInternal(t,e,i,n){t==null||typeof t>"u"||(e==null&&(e=!1),i==null&&(i=!1),e&&this.display.textLength>0&&!this.display.EndOfLine&&this.display.EndOfLineLength!==0&&!this.telnet.prompt&&!this.display.parseQueueEndOfLine&&(t=`
`+t),this.emit("print"),this.parseInternal(t,i,!1,n))}send(t,e){this.telnet.sendData(t),this.lastSendTime=Date.now(),e&&this.telnet.echo&&this.getOption("commandEcho")?this.echo(t):e&&this.echo(`
`)}sendRaw(t){this.telnet.sendData(t,!0),this.lastSendTime=Date.now()}sendGMCP(t){this.telnet.sendGMCP(t),this.lastSendTime=Date.now()}debug(t,e){let i={value:t};this.emit("debug",i),!(!this._enableDebug||i==null||typeof i>"u"||i.value==null||typeof i.value>"u"||i.value.length===0)&&window.console&&(e?window.console.log("%c"+t,e):window.console.log(i.value))}sendCommand(t,e,i){t==null&&(t=this._commandInput.value,this.telnet.echo?this._input.AddCommandToHistory(t):this._commandInput.value=""),t=""+t,t.endsWith(`
`)||(t=t+`
`);let n={value:t,handled:!1,comments:i};this.emit("parse-command",n),!(n==null||typeof n>"u")&&(n.handled||n.value==null||typeof n.value>"u"||(n.value.length>0&&this.send(n.value,!e),this.getOption("keepLastCommand")?this.getOption("selectLastCommand")&&Dt(this._commandInput):this._commandInput.value=""))}sendBackground(t,e,i){t==null&&(t=this._commandInput.value,this.telnet.echo?this._input.AddCommandToHistory(t):this._commandInput.value=""),t=""+t,t.endsWith(`
`)||(t=t+`
`);let n={value:t,handled:!1,comments:i};this.emit("parse-command",n),!(n==null||typeof n>"u")&&(n.value==null||typeof n.value>"u"||!n.handled&&n.value.length>0&&this.send(n.value,!e))}get scrollLock(){return this._input.scrollLock}set scrollLock(t){this._input.scrollLock=t}toggleScrollLock(){this._input.toggleScrollLock()}UpdateWindow(){this.display.updateWindow()}close(){this.telnet.close()}connect(){this.errored=!1,this.emit("connecting"),this.display.ClearMXP(),this.display.ResetMXPLine(),this.telnet.connect(),this.emit("connect"),this._commandInput.focus()}receivedData(t){this.telnet.receivedData(t)}notify(t,e,i){this.enableDebug&&(this.emit("debug","notify title: "+t),this.emit("debug","notify msg: "+e)),this.emit("notify",t,e,i)}clear(){this.display.clear(),this.emit("cleared")}parseInline(t){return this._input.parseInline(t)}parseOutgoing(t,e,i,n){return this._input.parseOutgoing(t,e,i,n)}clearCache(){this._input.clearCaches(),this._itemCache={triggers:null,aliases:null,macros:null,buttons:null,contexts:null,defaultContext:null,alarms:null,alarmPatterns:[]}}beep(){this.emit("bell")}raise(t,e,i){if(!this.profiles){setTimeout(()=>{this.raise(t,e,i)},100);return}!i||i<1?this._input.triggerEvent(t,e):setTimeout(()=>{this._input.triggerEvent(t,e)},i)}show(){this.emit("show")}hide(){this.emit("hide")}toggle(){this.emit("toggle")}};window.Client=Fe;window.Display=Qe;})();
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
/**
 * A class to parse color values
 * @author Stoyan Stefanov <sstoo@gmail.com>
 * @link   http://www.phpied.com/rgb-color-parser-in-javascript/
 * @license Use it if you like it
 */
//# sourceMappingURL=oiMUD.core.min.js.map
