(()=>{var ns=Object.create;var Ei=Object.defineProperty;var rs=Object.getOwnPropertyDescriptor;var ls=Object.getOwnPropertyNames;var as=Object.getPrototypeOf,os=Object.prototype.hasOwnProperty;var kt=(m=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(m,{get:(u,t)=>(typeof require<"u"?require:u)[t]}):m)(function(m){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+m+'" is not supported')});var ri=(m,u)=>()=>(u||m((u={exports:{}}).exports,u),u.exports);var hs=(m,u,t,e)=>{if(u&&typeof u=="object"||typeof u=="function")for(let s of ls(u))!os.call(m,s)&&s!==t&&Ei(m,s,{get:()=>u[s],enumerable:!(e=rs(u,s))||e.enumerable});return m};var li=(m,u,t)=>(t=m!=null?ns(as(m)):{},hs(u||!m||!m.__esModule?Ei(t,"default",{value:m,enumerable:!0}):t,m));var Di=ri(Oi=>{(function(){"use strict";var m=void 0,u=!0,t=this;function e(D,N){var Y=D.split("."),U=t;!(Y[0]in U)&&U.execScript&&U.execScript("var "+Y[0]);for(var O;Y.length&&(O=Y.shift());)!Y.length&&N!==m?U[O]=N:U=U[O]?U[O]:U[O]={}}var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u"&&typeof DataView<"u";function n(D){var N=D.length,Y=0,U=Number.POSITIVE_INFINITY,O,H,F,re,T,he,q,W,K,se;for(W=0;W<N;++W)D[W]>Y&&(Y=D[W]),D[W]<U&&(U=D[W]);for(O=1<<Y,H=new(s?Uint32Array:Array)(O),F=1,re=0,T=2;F<=Y;){for(W=0;W<N;++W)if(D[W]===F){for(he=0,q=re,K=0;K<F;++K)he=he<<1|q&1,q>>=1;for(se=F<<16|W,K=he;K<O;K+=T)H[K]=se;++re}++F,re<<=1,T<<=1}return[H,Y,U]}function r(D,N,Y){this.u=[],this.i=Y||32768,this.v=0,this.a=N===m?0:N,this.d=this.e=0,this.input=s?new Uint8Array(D):D,this.b=new(s?Uint8Array:Array)(this.i),this.c=0,this.t=this.l=!1,this.f=0,this.status=a}var a=0;r.prototype.j=function(D,N){var Y=!1;for(D!==m&&(this.input=D),N!==m&&(this.a=N);!Y;)switch(this.status){case a:case 1:var U,O=m;if(this.status=1,X(this),0>(O=S(this,3)))J(this),U=-1;else{switch(O&1&&(this.l=u),O>>>=1,O){case 0:this.h=0;break;case 1:this.h=1;break;case 2:this.h=2;break;default:throw Error("unknown BTYPE: "+O)}this.status=2,U=m}0>U&&(Y=u);break;case 2:case 3:switch(this.h){case 0:var H,F=m,re=m,T=this.input,he=this.a;if(this.status=3,he+4>=T.length)H=-1;else{if(F=T[he++]|T[he++]<<8,re=T[he++]|T[he++]<<8,F===~re)throw Error("invalid uncompressed block header: length verify");this.d=this.e=0,this.a=he,this.m=F,this.status=4,H=m}0>H&&(Y=u);break;case 1:this.status=3,this.k=I,this.n=R,this.status=4;break;case 2:var q;e:{var W=m,K=m,se=m,_e=new(s?Uint8Array:Array)(h.length),Re=m;if(this.status=3,X(this),W=S(this,5)+257,K=S(this,5)+1,se=S(this,4)+4,0>W||0>K||0>se)J(this),q=-1;else{try{for(var Pe=m,Te=m,Ve=0,Ae=m,ae=m,Ne=m,Si=m,Ne=0;Ne<se;++Ne){if(0>(Pe=S(this,3)))throw Error("not enough input");_e[h[Ne]]=Pe}for(Re=n(_e),ae=new(s?Uint8Array:Array)(W+K),Ne=0,Si=W+K;Ne<Si;){if(Te=P(this,Re),0>Te)throw Error("not enough input");switch(Te){case 16:if(0>(Pe=S(this,2)))throw Error("not enough input");for(Ae=3+Pe;Ae--;)ae[Ne++]=Ve;break;case 17:if(0>(Pe=S(this,3)))throw Error("not enough input");for(Ae=3+Pe;Ae--;)ae[Ne++]=0;Ve=0;break;case 18:if(0>(Pe=S(this,7)))throw Error("not enough input");for(Ae=11+Pe;Ae--;)ae[Ne++]=0;Ve=0;break;default:Ve=ae[Ne++]=Te}}new(s?Uint8Array:Array)(W),new(s?Uint8Array:Array)(K),this.k=n(s?ae.subarray(0,W):ae.slice(0,W)),this.n=n(s?ae.subarray(W):ae.slice(W))}catch{J(this),q=-1;break e}this.status=4,q=0}}0>q&&(Y=u)}break;case 4:case 5:switch(this.h){case 0:var ii;e:{var ki=this.input,Mt=this.a,si=this.b,Bt=this.c,ni=this.m;for(this.status=5;ni--;){if(Bt===si.length&&(si=ie(this,{o:2})),Mt>=ki.length){this.a=Mt,this.c=Bt,this.m=ni+1,ii=-1;break e}si[Bt++]=ki[Mt++]}0>ni&&(this.status=6),this.a=Mt,this.c=Bt,ii=0}0>ii&&(Y=u);break;case 1:case 2:0>G(this)&&(Y=u)}break;case 6:this.l?Y=u:this.status=a}var A,Ge=this.c,xi;return A=this.t?s?new Uint8Array(this.b.subarray(this.f,Ge)):this.b.slice(this.f,Ge):s?this.b.subarray(this.f,Ge):this.b.slice(this.f,Ge),this.f=Ge,Ge>32768+this.i&&(this.c=this.f=32768,s?(xi=this.b,this.b=new Uint8Array(this.i+32768),this.b.set(xi.subarray(Ge-32768,Ge))):this.b=this.b.slice(Ge-32768)),A};var o=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],h=s?new Uint16Array(o):o,c=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],g=s?new Uint16Array(c):c,f=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],w=s?new Uint8Array(f):f,p=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],k=s?new Uint16Array(p):p,E=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],b=s?new Uint8Array(E):E,v=new(s?Uint8Array:Array)(288),M,B;for(M=0,B=v.length;M<B;++M)v[M]=143>=M?8:255>=M?9:279>=M?7:8;var I=n(v),_=new(s?Uint8Array:Array)(30),C,L;for(C=0,L=_.length;C<L;++C)_[C]=5;var R=n(_);function S(D,N){for(var Y=D.e,U=D.d,O=D.input,H=D.a,F;U<N;){if(O.length<=H)return-1;F=O[H++],Y|=F<<U,U+=8}return F=Y&(1<<N)-1,D.e=Y>>>N,D.d=U-N,D.a=H,F}function P(D,N){for(var Y=D.e,U=D.d,O=D.input,H=D.a,F=N[0],re=N[1],T,he,q;U<re;){if(O.length<=H)return-1;T=O[H++],Y|=T<<U,U+=8}if(he=F[Y&(1<<re)-1],q=he>>>16,q>U)throw Error("invalid code length: "+q);return D.e=Y>>q,D.d=U-q,D.a=H,he&65535}function X(D){D.s=D.a,D.r=D.d,D.q=D.e}function J(D){D.a=D.s,D.d=D.r,D.e=D.q}function G(D){var N=D.b,Y=D.c,U,O,H,F,re=D.k,T=D.n,he=N.length,q;for(D.status=5;;){if(X(D),U=P(D,re),0>U)return D.c=Y,J(D),-1;if(U===256)break;if(256>U)Y===he&&(N=ie(D),he=N.length),N[Y++]=U;else{if(O=U-257,F=g[O],0<w[O]){if(q=S(D,w[O]),0>q)return D.c=Y,J(D),-1;F+=q}if(U=P(D,T),0>U)return D.c=Y,J(D),-1;if(H=k[U],0<b[U]){if(q=S(D,b[U]),0>q)return D.c=Y,J(D),-1;H+=q}for(Y+F>=he&&(N=ie(D),he=N.length);F--;)N[Y]=N[Y++-H];if(D.a===D.input.length)return D.c=Y,-1}}for(;8<=D.d;)D.d-=8,D.a--;D.c=Y,D.status=6}function ie(D,N){var Y,U=D.input.length/D.a+1|0,O,H,F,re=D.input,T=D.b;return N&&(typeof N.o=="number"&&(U=N.o),typeof N.p=="number"&&(U+=N.p)),2>U?(O=(re.length-D.a)/D.k[2],F=258*(O/2)|0,H=F<T.length?T.length+F:T.length<<1):H=T.length*U,s?(Y=new Uint8Array(H),Y.set(T)):Y=T,D.b=Y,D.b}function Q(D){this.input=D===m?new(s?Uint8Array:Array):D,this.a=0,this.g=new r(this.input,this.a),this.b=this.g.b}Q.prototype.j=function(D){var N;if(D!==m)if(s){var Y=new Uint8Array(this.input.length+D.length);Y.set(this.input,0),Y.set(D,this.input.length),this.input=Y}else this.input=this.input.concat(D);var U;if(U=this.method===m){var O,H=this.a,F=this.input,re=F[H++],T=F[H++];if(re===m||T===m)O=-1;else{switch(re&15){case 8:this.method=8;break;default:throw Error("unsupported compression method")}if(((re<<8)+T)%31!==0)throw Error("invalid fcheck flag:"+((re<<8)+T)%31);if(T&32)throw Error("fdict flag is not supported");this.a=H,O=m}U=0>O}return U?new(s?Uint8Array:Array):(N=this.g.j(this.input,this.a),this.g.a!==0&&(this.input=s?this.input.subarray(this.g.a):this.input.slice(this.g.a),this.a=0),N)},e("Zlib.InflateStream",Q),e("Zlib.InflateStream.prototype.decompress",Q.prototype.j)}).call(Oi)});var zi=ri((Fi,jt)=>{(function(m,u){"use strict";typeof jt<"u"&&jt.exports?jt.exports=u():typeof define=="function"&&define.amd?define([],u):m.buzz=u()})(Fi,function(){"use strict";var m=window.AudioContext||window.webkitAudioContext,u={defaults:{autoplay:!1,duration:5e3,formats:[],loop:!1,placeholder:"--",preload:"metadata",volume:80,webAudioApi:!1,document:window.document},types:{mp3:"audio/mpeg",ogg:"audio/ogg",wav:"audio/wav",aac:"audio/aac",m4a:"audio/x-m4a"},sounds:[],el:document.createElement("audio"),getAudioContext:function(){if(this.audioCtx===void 0)try{this.audioCtx=m?new m:null}catch{this.audioCtx=null}return this.audioCtx},sound:function(t,e){e=e||{};var s=e.document||u.defaults.document,n=0,r=[],a={},o=u.isSupported();this.load=function(){return o?(this.sound.load(),this):this},this.play=function(){return o?(this.sound.play(),this):this},this.togglePlay=function(){return o?(this.sound.paused?this.sound.play():this.sound.pause(),this):this},this.pause=function(){return o?(this.sound.pause(),this):this},this.isPaused=function(){return o?this.sound.paused:null},this.stop=function(){return o?(this.setTime(0),this.sound.pause(),this):this},this.isEnded=function(){return o?this.sound.ended:null},this.loop=function(){return o?(this.sound.loop="loop",this.bind("ended.buzzloop",function(){this.currentTime=0,this.play()}),this):this},this.unloop=function(){return o?(this.sound.removeAttribute("loop"),this.unbind("ended.buzzloop"),this):this},this.mute=function(){return o?(this.sound.muted=!0,this):this},this.unmute=function(){return o?(this.sound.muted=!1,this):this},this.toggleMute=function(){return o?(this.sound.muted=!this.sound.muted,this):this},this.isMuted=function(){return o?this.sound.muted:null},this.setVolume=function(k){return o?(k<0&&(k=0),k>100&&(k=100),this.volume=k,this.sound.volume=k/100,this):this},this.getVolume=function(){return o?this.volume:this},this.increaseVolume=function(k){return this.setVolume(this.volume+(k||1))},this.decreaseVolume=function(k){return this.setVolume(this.volume-(k||1))},this.setTime=function(k){if(!o)return this;var E=!0;return this.whenReady(function(){E===!0&&(E=!1,this.sound.currentTime=k)}),this},this.getTime=function(){if(!o)return null;var k=Math.round(this.sound.currentTime*100)/100;return isNaN(k)?u.defaults.placeholder:k},this.setPercent=function(k){return o?this.setTime(u.fromPercent(k,this.sound.duration)):this},this.getPercent=function(){if(!o)return null;var k=Math.round(u.toPercent(this.sound.currentTime,this.sound.duration));return isNaN(k)?u.defaults.placeholder:k},this.setSpeed=function(k){return o?(this.sound.playbackRate=k,this):this},this.getSpeed=function(){return o?this.sound.playbackRate:null},this.getDuration=function(){if(!o)return null;var k=Math.round(this.sound.duration*100)/100;return isNaN(k)?u.defaults.placeholder:k},this.getPlayed=function(){return o?h(this.sound.played):null},this.getBuffered=function(){return o?h(this.sound.buffered):null},this.getSeekable=function(){return o?h(this.sound.seekable):null},this.getErrorCode=function(){return o&&this.sound.error?this.sound.error.code:0},this.getErrorMessage=function(){if(!o)return null;switch(this.getErrorCode()){case 1:return"MEDIA_ERR_ABORTED";case 2:return"MEDIA_ERR_NETWORK";case 3:return"MEDIA_ERR_DECODE";case 4:return"MEDIA_ERR_SRC_NOT_SUPPORTED";default:return null}},this.getStateCode=function(){return o?this.sound.readyState:null},this.getStateMessage=function(){if(!o)return null;switch(this.getStateCode()){case 0:return"HAVE_NOTHING";case 1:return"HAVE_METADATA";case 2:return"HAVE_CURRENT_DATA";case 3:return"HAVE_FUTURE_DATA";case 4:return"HAVE_ENOUGH_DATA";default:return null}},this.getNetworkStateCode=function(){return o?this.sound.networkState:null},this.getNetworkStateMessage=function(){if(!o)return null;switch(this.getNetworkStateCode()){case 0:return"NETWORK_EMPTY";case 1:return"NETWORK_IDLE";case 2:return"NETWORK_LOADING";case 3:return"NETWORK_NO_SOURCE";default:return null}},this.set=function(k,E){return o?(this.sound[k]=E,this):this},this.get=function(k){return o?k?this.sound[k]:this.sound:null},this.bind=function(k,E){if(!o)return this;k=k.split(" ");for(var b=this,v=function(_){E.call(b,_)},M=0;M<k.length;M++){var B=k[M],I=B;B=I.split(".")[0],r.push({idx:I,func:v}),this.sound.addEventListener(B,v,!0)}return this},this.unbind=function(k){if(!o)return this;k=k.split(" ");for(var E=0;E<k.length;E++)for(var b=k[E],v=b.split(".")[0],M=0;M<r.length;M++){var B=r[M].idx.split(".");(r[M].idx===b||B[1]&&B[1]===b.replace(".",""))&&(this.sound.removeEventListener(v,r[M].func,!0),r.splice(M,1))}return this},this.bindOnce=function(k,E){if(!o)return this;var b=this;return a[n++]=!1,this.bind(k+"."+n,function(){a[n]||(a[n]=!0,E.call(b)),b.unbind(k+"."+n)}),this},this.trigger=function(k,E){if(!o)return this;k=k.split(" ");for(var b=0;b<k.length;b++)for(var v=k[b],M=0;M<r.length;M++){var B=r[M].idx.split(".");if(r[M].idx===v||B[0]&&B[0]===v.replace(".","")){var I=s.createEvent("HTMLEvents");I.initEvent(B[0],!1,!0),I.originalEvent=E,this.sound.dispatchEvent(I)}}return this},this.fadeTo=function(k,E,b){if(!o)return this;E instanceof Function?(b=E,E=u.defaults.duration):E=E||u.defaults.duration;var v=this.volume,M=E/Math.abs(v-k),B=this;this.play();function I(){setTimeout(function(){v<k&&B.volume<k?(B.setVolume(B.volume+=1),I()):v>k&&B.volume>k?(B.setVolume(B.volume-=1),I()):b instanceof Function&&b.apply(B)},M)}return this.whenReady(function(){I()}),this},this.fadeIn=function(k,E){return o?this.setVolume(0).fadeTo(100,k,E):this},this.fadeOut=function(k,E){return o?this.fadeTo(0,k,E):this},this.fadeWith=function(k,E){return o?(this.fadeOut(E,function(){this.stop()}),k.play().fadeIn(E),this):this},this.whenReady=function(k){if(!o)return null;var E=this;this.sound.readyState===0?this.bind("canplay.buzzwhenready",function(){k.call(E)}):k.call(E)},this.addSource=function(k){var E=this,b=s.createElement("source");return b.src=k,u.types[c(k)]&&(b.type=u.types[c(k)]),this.sound.appendChild(b),b.addEventListener("error",function(v){E.trigger("sourceerror",v)}),b};function h(k){for(var E=[],b=k.length-1,v=0;v<=b;v++)E.push({start:k.start(v),end:k.end(v)});return E}function c(k){return k.split(".").pop()}if(o&&t){for(var g in u.defaults)u.defaults.hasOwnProperty(g)&&e[g]===void 0&&(e[g]=u.defaults[g]);if(this.sound=s.createElement("audio"),e.webAudioApi){var f=u.getAudioContext();f&&(this.source=f.createMediaElementSource(this.sound),this.source.connect(f.destination))}if(t instanceof Array)for(var w in t)t.hasOwnProperty(w)&&this.addSource(t[w]);else if(e.formats.length)for(var p in e.formats)e.formats.hasOwnProperty(p)&&this.addSource(t+"."+e.formats[p]);else this.addSource(t);e.loop&&this.loop(),e.autoplay&&(this.sound.autoplay="autoplay"),e.preload===!0?this.sound.preload="auto":e.preload===!1?this.sound.preload="none":this.sound.preload=e.preload,this.setVolume(e.volume),u.sounds.push(this)}},group:function(t){t=s(t,arguments),this.getSounds=function(){return t},this.add=function(n){n=s(n,arguments);for(var r=0;r<n.length;r++)t.push(n[r])},this.remove=function(n){n=s(n,arguments);for(var r=0;r<n.length;r++)for(var a=0;a<t.length;a++)if(t[a]===n[r]){t.splice(a,1);break}},this.load=function(){return e("load"),this},this.play=function(){return e("play"),this},this.togglePlay=function(){return e("togglePlay"),this},this.pause=function(n){return e("pause",n),this},this.stop=function(){return e("stop"),this},this.mute=function(){return e("mute"),this},this.unmute=function(){return e("unmute"),this},this.toggleMute=function(){return e("toggleMute"),this},this.setVolume=function(n){return e("setVolume",n),this},this.increaseVolume=function(n){return e("increaseVolume",n),this},this.decreaseVolume=function(n){return e("decreaseVolume",n),this},this.loop=function(){return e("loop"),this},this.unloop=function(){return e("unloop"),this},this.setSpeed=function(n){return e("setSpeed",n),this},this.setTime=function(n){return e("setTime",n),this},this.set=function(n,r){return e("set",n,r),this},this.bind=function(n,r){return e("bind",n,r),this},this.unbind=function(n){return e("unbind",n),this},this.bindOnce=function(n,r){return e("bindOnce",n,r),this},this.trigger=function(n){return e("trigger",n),this},this.fade=function(n,r,a,o){return e("fade",n,r,a,o),this},this.fadeIn=function(n,r){return e("fadeIn",n,r),this},this.fadeOut=function(n,r){return e("fadeOut",n,r),this};function e(){for(var n=s(null,arguments),r=n.shift(),a=0;a<t.length;a++)t[a][r].apply(t[a],n)}function s(n,r){return n instanceof Array?n:Array.prototype.slice.call(r)}},all:function(){return new u.group(u.sounds)},isSupported:function(){return!!u.el.canPlayType},isOGGSupported:function(){return!!u.el.canPlayType&&u.el.canPlayType('audio/ogg; codecs="vorbis"')},isWAVSupported:function(){return!!u.el.canPlayType&&u.el.canPlayType('audio/wav; codecs="1"')},isMP3Supported:function(){return!!u.el.canPlayType&&u.el.canPlayType("audio/mpeg;")},isAACSupported:function(){return!!u.el.canPlayType&&(u.el.canPlayType("audio/x-m4a;")||u.el.canPlayType("audio/aac;"))},toTimer:function(t,e){var s,n,r;return s=Math.floor(t/3600),s=isNaN(s)?"--":s>=10?s:"0"+s,n=Math.floor(e?t/60%60:t/60),n=isNaN(n)?"--":n>=10?n:"0"+n,r=Math.floor(t%60),r=isNaN(r)?"--":r>=10?r:"0"+r,e?s+":"+n+":"+r:n+":"+r},fromTimer:function(t){var e=t.toString().split(":");return e&&e.length===3&&(t=parseInt(e[0],10)*3600+parseInt(e[1],10)*60+parseInt(e[2],10)),e&&e.length===2&&(t=parseInt(e[0],10)*60+parseInt(e[1],10)),t},toPercent:function(t,e,s){var n=Math.pow(10,s||0);return Math.round(t*100/e*n)/n},fromPercent:function(t,e,s){var n=Math.pow(10,s||0);return Math.round(e/100*t*n)/n}};return u})});var Hi=ri((Gi,Wi)=>{(function(m){if(typeof bootstrap=="function")bootstrap("pf",m);else if(typeof Gi=="object")Wi.exports=m();else if(typeof define=="function"&&define.amd)define(m);else if(typeof ses<"u"){if(!ses.ok())return;ses.makePF=m}else typeof window<"u"?window.PF=m():global.PF=m()})(function(){var m,u,t,e,s;return function(n,r,a){function o(g,f){if(!r[g]){if(!n[g]){var w=typeof kt=="function"&&kt;if(!f&&w)return w(g,!0);if(h)return h(g,!0);throw new Error("Cannot find module '"+g+"'")}var p=r[g]={exports:{}};n[g][0].call(p.exports,function(k){var E=n[g][1][k];return o(E||k)},p,p.exports)}return r[g].exports}for(var h=typeof kt=="function"&&kt,c=0;c<a.length;c++)o(a[c]);return o}({1:[function(n,r,a){r.exports=n("./lib/heap")},{"./lib/heap":2}],2:[function(n,r,a){(function(){var o,h,c,g,f,w,p,k,E,b,v,M,B,I,_;c=Math.floor,b=Math.min,h=function(C,L){return C<L?-1:C>L?1:0},E=function(C,L,R,S,P){var X;if(R==null&&(R=0),P==null&&(P=h),R<0)throw new Error("lo must be non-negative");for(S==null&&(S=C.length);R<S;)X=c((R+S)/2),P(L,C[X])<0?S=X:R=X+1;return[].splice.apply(C,[R,R-R].concat(L)),L},w=function(C,L,R){return R==null&&(R=h),C.push(L),I(C,0,C.length-1,R)},f=function(C,L){var R,S;return L==null&&(L=h),R=C.pop(),C.length?(S=C[0],C[0]=R,_(C,0,L)):S=R,S},k=function(C,L,R){var S;return R==null&&(R=h),S=C[0],C[0]=L,_(C,0,R),S},p=function(C,L,R){var S;return R==null&&(R=h),C.length&&R(C[0],L)<0&&(S=[C[0],L],L=S[0],C[0]=S[1],_(C,0,R)),L},g=function(C,L){var R,S,P,X,J,G,ie,Q;for(L==null&&(L=h),G=function(){Q=[];for(var D=0,N=c(C.length/2);0<=N?D<N:D>N;0<=N?D++:D--)Q.push(D);return Q}.apply(this).reverse(),ie=[],S=0,X=G.length;S<X;S++)R=G[S],ie.push(_(C,R,L));return ie},B=function(C,L,R){var S;if(R==null&&(R=h),S=C.indexOf(L),S!==-1)return I(C,0,S,R),_(C,S,R)},v=function(C,L,R){var S,P,X,J,G;if(R==null&&(R=h),P=C.slice(0,L),!P.length)return P;for(g(P,R),G=C.slice(L),X=0,J=G.length;X<J;X++)S=G[X],p(P,S,R);return P.sort(R).reverse()},M=function(C,L,R){var S,P,X,J,G,ie,Q,D,N,Y;if(R==null&&(R=h),L*10<=C.length){if(J=C.slice(0,L).sort(R),!J.length)return J;for(X=J[J.length-1],D=C.slice(L),G=0,Q=D.length;G<Q;G++)S=D[G],R(S,X)<0&&(E(J,S,0,null,R),J.pop(),X=J[J.length-1]);return J}for(g(C,R),Y=[],P=ie=0,N=b(L,C.length);0<=N?ie<N:ie>N;P=0<=N?++ie:--ie)Y.push(f(C,R));return Y},I=function(C,L,R,S){var P,X,J;for(S==null&&(S=h),P=C[R];R>L;){if(J=R-1>>1,X=C[J],S(P,X)<0){C[R]=X,R=J;continue}break}return C[R]=P},_=function(C,L,R){var S,P,X,J,G;for(R==null&&(R=h),P=C.length,G=L,X=C[L],S=2*L+1;S<P;)J=S+1,J<P&&!(R(C[S],C[J])<0)&&(S=J),C[L]=C[S],L=S,S=2*L+1;return C[L]=X,I(C,G,L,R)},o=function(){C.push=w,C.pop=f,C.replace=k,C.pushpop=p,C.heapify=g,C.nlargest=v,C.nsmallest=M;function C(L){this.cmp=L??h,this.nodes=[]}return C.prototype.push=function(L){return w(this.nodes,L,this.cmp)},C.prototype.pop=function(){return f(this.nodes,this.cmp)},C.prototype.peek=function(){return this.nodes[0]},C.prototype.contains=function(L){return this.nodes.indexOf(L)!==-1},C.prototype.replace=function(L){return k(this.nodes,L,this.cmp)},C.prototype.pushpop=function(L){return p(this.nodes,L,this.cmp)},C.prototype.heapify=function(){return g(this.nodes,this.cmp)},C.prototype.updateItem=function(L){return B(this.nodes,L,this.cmp)},C.prototype.clear=function(){return this.nodes=[]},C.prototype.empty=function(){return this.nodes.length===0},C.prototype.size=function(){return this.nodes.length},C.prototype.clone=function(){var L;return L=new C,L.nodes=this.nodes.slice(0),L},C.prototype.toArray=function(){return this.nodes.slice(0)},C.prototype.insert=C.prototype.push,C.prototype.remove=C.prototype.pop,C.prototype.top=C.prototype.peek,C.prototype.front=C.prototype.peek,C.prototype.has=C.prototype.contains,C.prototype.copy=C.prototype.clone,C}(),typeof r<"u"&&r!==null&&r.exports?r.exports=o:window.Heap=o}).call(this)},{}],3:[function(n,r,a){r.exports={Heap:n("heap"),Node:n("./core/Node"),Grid:n("./core/Grid"),Util:n("./core/Util"),Heuristic:n("./core/Heuristic"),AStarFinder:n("./finders/AStarFinder"),BestFirstFinder:n("./finders/BestFirstFinder"),BreadthFirstFinder:n("./finders/BreadthFirstFinder"),DijkstraFinder:n("./finders/DijkstraFinder"),BiAStarFinder:n("./finders/BiAStarFinder"),BiBestFirstFinder:n("./finders/BiBestFirstFinder"),BiBreadthFirstFinder:n("./finders/BiBreadthFirstFinder"),BiDijkstraFinder:n("./finders/BiDijkstraFinder"),JumpPointFinder:n("./finders/JumpPointFinder"),IDAStarFinder:n("./finders/IDAStarFinder")}},{"./core/Grid":4,"./core/Heuristic":5,"./core/Node":6,"./core/Util":7,"./finders/AStarFinder":8,"./finders/BestFirstFinder":9,"./finders/BiAStarFinder":10,"./finders/BiBestFirstFinder":11,"./finders/BiBreadthFirstFinder":12,"./finders/BiDijkstraFinder":13,"./finders/BreadthFirstFinder":14,"./finders/DijkstraFinder":15,"./finders/IDAStarFinder":16,"./finders/JumpPointFinder":17,heap:1}],4:[function(n,r,a){var o=n("./Node");function h(c,g,f,w){this.width=c,this.height=g,this.depth=f,this.nodes=this._buildNodes(c,g,f,w)}h.prototype._buildNodes=function(c,g,f,w){var p,k,E,b=new Array(g),v;for(p=0;p<g;++p)for(b[p]=new Array(c),k=0;k<c;++k)for(b[p][k]=new Array(f),E=0;E<f;++E)b[p][k][E]=new o(k,p,E);if(w===void 0)return b;if(w.length!==g||w[0].length!==c)throw new Error("Matrix size does not fit");for(p=0;p<g;++p)for(k=0;k<c;++k)for(E=0;E<f;++E)b[p][k][E].walkable=w[p][k][E];return b},h.prototype.getNodeAt=function(c,g,f){return this.nodes[g][c][f]},h.prototype.isWalkableAt=function(c,g,f,w){return this.isInside(c,g,f)&&(this.nodes[g][c][f].walkable&w)==w},h.prototype.isInside=function(c,g,f){return c>=0&&c<this.width&&g>=0&&g<this.height&&f>=0&&f<this.depth},h.prototype.setWalkableAt=function(c,g,f,w){this.nodes[g][c][f].walkable=w},h.prototype.getNeighbors=function(c,g,f){var w=c.x,p=c.y,k=c.z,E=[],b=!1,v=!1,M=!1,B=!1,I=!1,_=!1,C=!1,L=!1,R=!1,S=!1,P=this.nodes;return this.isWalkableAt(w,p,k,128)&&this.isInside(w,p-1,k,8)&&(E.push(P[p-1][w][k]),b=!0),this.isWalkableAt(w,p,k,32)&&this.isInside(w+1,p,k,2)&&(E.push(P[p][w+1][k]),M=!0),this.isWalkableAt(w,p,k,8)&&this.isInside(w,p+1,k,128)&&(E.push(P[p+1][w][k]),I=!0),this.isWalkableAt(w,p,k,2)&&this.isInside(w-1,p,k,32)&&(E.push(P[p][w-1][k]),C=!0),this.isWalkableAt(w,p,k,512)&&this.isInside(w,p,k+1,256)&&(E.push(P[p][w][k+1]),R=!0),this.isWalkableAt(w,p,k,256)&&this.isInside(w,p,k-1,512)&&(E.push(P[p][w][k-1]),S=!0),g&&(f?(v=C&&b,B=b&&M,_=M&&I,L=I&&C):(v=C||b||!0,B=b||M||!0,_=M||I||!0,L=I||C||!0),v&&this.isWalkableAt(w,p,k,1)&&this.isInside(w-1,p-1,k,16)&&E.push(P[p-1][w-1][k]),B&&this.isWalkableAt(w,p,k,64)&&this.isInside(w+1,p-1,k,4)&&E.push(P[p-1][w+1][k]),_&&this.isWalkableAt(w,p,k,16)&&this.isInside(w+1,p+1,k,1)&&E.push(P[p+1][w+1][k]),L&&this.isWalkableAt(w,p,k,4)&&this.isInside(w-1,p+1,k,64)&&E.push(P[p+1][w-1][k])),E},h.prototype.clone=function(){var c,g,f=this.width,w=this.height,p=this.depth,k=this.nodes,E=new h(f,w,p),b=new Array(w),v;for(c=0;c<w;++c)for(b[c]=new Array(f),g=0;g<f;++g)for(b[c][g]=new Array(p),z=0;z<p;++z)b[c][g][z]=new o(g,c,z,k[c][g][z].walkable);return E.nodes=b,E},r.exports=h},{"./Node":6}],5:[function(n,r,a){r.exports={manhattan:function(o,h,c){return o+h+c},euclidean:function(o,h,c){return Math.sqrt(o*o+h*h+c*c)},chebyshev:function(o,h,c){return Math.max(o,h,c)}}},{}],6:[function(n,r,a){function o(h,c,g,f){this.x=h,this.y=c,this.walkable=f===void 0?!0:f,this.z=g}r.exports=o},{}],7:[function(n,r,a){function o(w){for(var p=[[w.x,w.y,w.z]];w.parent;)w=w.parent,p.push([w.x,w.y,w.z]);return p.reverse()}a.backtrace=o;function h(w,p){var k=o(w),E=o(p);return k.concat(E.reverse())}a.biBacktrace=h;function c(w){var p,k=0,E,b,v,M,B;for(p=1;p<w.length;++p)E=w[p-1],b=w[p],v=E[0]-b[0],M=E[1]-b[1],B=E[2]-b[2],k+=Math.sqrt(v*v+M*M+B*B);return k}a.pathLength=c;function g(w,p,k,E,b,v){let M=[];M.push([w,p,k]);let B=Math.abs(E-w),I=Math.abs(b-p),_=Math.abs(v-k),C,L,R;if(E>w?C=1:C=-1,b>p?L=1:L=-1,v>k?R=1:R=-1,B>=I&&B>=_){let S=2*I-B,P=2*_-B;for(;w!=E;)w+=C,S>=0&&(p+=L,S-=2*B),P>=0&&(k+=R,P-=2*B),S+=2*I,P+=2*_,M.push([w,p,k])}else if(I>=B&&I>=_){let S=2*B-I,P=2*_-I;for(;p!=b;)p+=L,S>=0&&(w+=C,S-=2*I),P>=0&&(k+=R,P-=2*I),S+=2*B,P+=2*_,M.push([w,p,k])}else{let S=2*I-_,P=2*B-_;for(;k!=v;)k+=R,S>=0&&(p+=L,S-=2*_),P>=0&&(w+=C,P-=2*_),S+=2*I,P+=2*B,M.push([w,p,k])}return M}a.getLine=g;function f(w,p){var k=p.length,E=p[0][0],b=p[0][1],v=p[0][2],M=p[k-1][0],B=p[k-1][1],I=p[k-1][2],_,C,L;for(ex,ey,ez,lx,ly,lz,newPath,i,j,coord,line,testCoord,blocked,_=E,C=b,L=v,lx=p[1][0],ly=p[1][1],lz=p[1][2],newPath=[[_,C,L]],i=2;i<k;++i){for(coord=p[i],ex=coord[0],ey=coord[1],ez=coord[2],line=g(_,C,L,ex,ey,ez),blocked=!1,j=1;j<line.length;++j)if(testCoord=line[j],!w.isWalkableAt(testCoord[0],testCoord[1])){blocked=!0,newPath.push([lx,ly]),_=lx,C=ly;break}blocked||(lx=ex,ly=ey)}return newPath.push([M,B]),newPath}a.smoothenPath=f},{}],8:[function(n,r,a){var o=n("heap"),h=n("../core/Util"),c=n("../core/Heuristic");function g(f){f=f||{},this.allowDiagonal=f.allowDiagonal,this.dontCrossCorners=f.dontCrossCorners,this.heuristic=f.heuristic||c.manhattan,this.weight=f.weight||1}g.prototype.findPath=function(f,w,p,k,E,b,v){if(!v.isInside(f,w,p)||!v.isInside(k,E,b))return[];var M=new o(function(O,H){return O.f-H.f}),B=v.getNodeAt(f,w,p),I=v.getNodeAt(k,E,b),_=this.heuristic,C=this.allowDiagonal,L=this.dontCrossCorners,R=this.weight,S=Math.abs,P=Math.SQRT2,X,J,G,ie,Q,D,N,Y,U;for(B.g=0,B.f=0,M.push(B),B.opened=!0;!M.empty();){if(X=M.pop(),X.closed=!0,X===I)return h.backtrace(I);for(J=v.getNeighbors(X,C,L),ie=0,Q=J.length;ie<Q;++ie)G=J[ie],!G.closed&&(D=G.x,N=G.y,U=G.z,Y=X.g+(D-X.x===0||N-X.y===0||U-X.z===0?1:P),(!G.opened||Y<G.g)&&(G.g=Y,G.h=G.h||R*_(S(D-k),S(N-E),S(U-b)),G.f=G.g+G.h,G.parent=X,G.opened?M.updateItem(G):(M.push(G),G.opened=!0)))}return[]},r.exports=g},{"../core/Heuristic":5,"../core/Util":7,heap:1}],9:[function(n,r,a){var o=n("./AStarFinder");function h(c){o.call(this,c);var g=this.heuristic;this.heuristic=function(f,w,p){return g(f,w,p)*1e6}}h.prototype=new o,h.prototype.constructor=h,r.exports=h},{"./AStarFinder":8}],10:[function(n,r,a){var o=n("heap"),h=n("../core/Util"),c=n("../core/Heuristic");function g(f){f=f||{},this.allowDiagonal=f.allowDiagonal,this.dontCrossCorners=f.dontCrossCorners,this.heuristic=f.heuristic||c.manhattan,this.weight=f.weight||1}g.prototype.findPath=function(f,w,p,k,E,b,v){var M=function(T,he){return T.f-he.f},B=new o(M),I=new o(M),_=v.getNodeAt(f,w),C=v.getNodeAt(k,E),L=this.heuristic,R=this.allowDiagonal,S=this.dontCrossCorners,P=this.weight,X=Math.abs,J=Math.SQRT2,G,ie,Q,D,N,Y,U,O,H,F=1,re=2;for(_.g=0,_.f=0,B.push(_),_.opened=F,C.g=0,C.f=0,I.push(C),C.opened=re;!B.empty()&&!I.empty();){for(G=B.pop(),G.closed=!0,ie=v.getNeighbors(G,R,S),D=0,N=ie.length;D<N;++D)if(Q=ie[D],!Q.closed){if(Q.opened===re)return h.biBacktrace(G,Q);Y=Q.x,U=Q.y,H=Q.z,O=G.g+(Y-G.x===0||U-G.y===0||H-G.z===0?1:J),(!Q.opened||O<Q.g)&&(Q.g=O,Q.h=Q.h||P*L(X(Y-k),X(U-E),X(H-b)),Q.f=Q.g+Q.h,Q.parent=G,Q.opened?B.updateItem(Q):(B.push(Q),Q.opened=F))}for(G=I.pop(),G.closed=!0,ie=v.getNeighbors(G,R,S),D=0,N=ie.length;D<N;++D)if(Q=ie[D],!Q.closed){if(Q.opened===F)return h.biBacktrace(Q,G);Y=Q.x,U=Q.y,H=Q.z,O=G.g+(Y-G.x===0||U-G.y===0||H-G.z===0?1:J),(!Q.opened||O<Q.g)&&(Q.g=O,Q.h=Q.h||P*L(X(Y-f),X(U-w),X(H-p)),Q.f=Q.g+Q.h,Q.parent=G,Q.opened?I.updateItem(Q):(I.push(Q),Q.opened=re))}}return[]},r.exports=g},{"../core/Heuristic":5,"../core/Util":7,heap:1}],11:[function(n,r,a){var o=n("./BiAStarFinder");function h(c){o.call(this,c);var g=this.heuristic;this.heuristic=function(f,w,p){return g(f,w,p)*1e6}}h.prototype=new o,h.prototype.constructor=h,r.exports=h},{"./BiAStarFinder":10}],12:[function(n,r,a){var o=n("../core/Util");function h(c){c=c||{},this.allowDiagonal=c.allowDiagonal,this.dontCrossCorners=c.dontCrossCorners}h.prototype.findPath=function(c,g,f,w,p,k,E){var b=E.getNodeAt(c,g,f),v=E.getNodeAt(w,p,k),M=[],B=[],I,_,C,L=this.allowDiagonal,R=this.dontCrossCorners,S=0,P=1,X,J;for(M.push(b),b.opened=!0,b.by=S,B.push(v),v.opened=!0,v.by=P;M.length&&B.length;){for(C=M.shift(),C.closed=!0,I=E.getNeighbors(C,L,R),X=0,J=I.length;X<J;++X)if(_=I[X],!_.closed){if(_.opened){if(_.by===P)return o.biBacktrace(C,_);continue}M.push(_),_.parent=C,_.opened=!0,_.by=S}for(C=B.shift(),C.closed=!0,I=E.getNeighbors(C,L,R),X=0,J=I.length;X<J;++X)if(_=I[X],!_.closed){if(_.opened){if(_.by===S)return o.biBacktrace(_,C);continue}B.push(_),_.parent=C,_.opened=!0,_.by=P}}return[]},r.exports=h},{"../core/Util":7}],13:[function(n,r,a){var o=n("./BiAStarFinder");function h(c){o.call(this,c),this.heuristic=function(g,f,w){return 0}}h.prototype=new o,h.prototype.constructor=h,r.exports=h},{"./BiAStarFinder":10}],14:[function(n,r,a){var o=n("../core/Util");function h(c){c=c||{},this.allowDiagonal=c.allowDiagonal,this.dontCrossCorners=c.dontCrossCorners}h.prototype.findPath=function(c,g,f,w,p,k,E){var b=[],v=this.allowDiagonal,M=this.dontCrossCorners,B=E.getNodeAt(c,g,f),I=E.getNodeAt(w,p,k),_,C,L,R,S;for(b.push(B),B.opened=!0;b.length;){if(L=b.shift(),L.closed=!0,L===I)return o.backtrace(I);for(_=E.getNeighbors(L,v,M),R=0,S=_.length;R<S;++R)C=_[R],!(C.closed||C.opened)&&(b.push(C),C.opened=!0,C.parent=L)}return[]},r.exports=h},{"../core/Util":7}],15:[function(n,r,a){var o=n("./AStarFinder");function h(c){o.call(this,c),this.heuristic=function(g,f,w){return 0}}h.prototype=new o,h.prototype.constructor=h,r.exports=h},{"./AStarFinder":8}],16:[function(n,r,a){var o=n("../core/Util"),h=n("../core/Heuristic"),c=n("../core/Node");function g(f){f=f||{},this.allowDiagonal=f.allowDiagonal,this.dontCrossCorners=f.dontCrossCorners,this.heuristic=f.heuristic||h.manhattan,this.weight=f.weight||1,this.trackRecursion=f.trackRecursion||!1,this.timeLimit=f.timeLimit||1/0}g.prototype.findPath=function(f,w,p,k,E,b,v){var M=0,B=new Date().getTime(),I=function(G,ie){return this.heuristic(Math.abs(ie.x-G.x),Math.abs(ie.y-G.y),Math.abs(ie.z-G.z))}.bind(this),_=function(G,ie){return G.x===ie.x||G.y===ie.y||G.z===ie.z?1:Math.SQRT2},C=function(G,ie,Q,D,N){if(M++,this.timeLimit>0&&new Date().getTime()-B>this.timeLimit*1e3)return 1/0;var Y=ie+I(G,R)*this.weight;if(Y>Q)return Y;if(G==R)return D[N]=[G.x,G.y,G.z],G;var U,O,H,F,re=v.getNeighbors(G,this.allowDiagonal,this.dontCrossCorners);for(H=0,U=1/0;F=re[H];++H){if(this.trackRecursion&&(F.retainCount=F.retainCount+1||1,F.tested!==!0&&(F.tested=!0)),O=C(F,ie+_(G,F),Q,D,N+1),O instanceof c)return D[N]=[G.x,G.y,G.z],O;this.trackRecursion&&--F.retainCount===0&&(F.tested=!1),O<U&&(U=O)}return U}.bind(this),L=v.getNodeAt(f,w,p),R=v.getNodeAt(k,E,b),S=I(L,R),P,X,J;for(P=0;;++P){if(X=[],J=C(L,0,S,X,0),J===1/0)return[];if(J instanceof c)return X;S=J}return[]},r.exports=g},{"../core/Heuristic":5,"../core/Node":6,"../core/Util":7}],17:[function(n,r,a){var o=n("heap"),h=n("../core/Util"),c=n("../core/Heuristic");function g(f){f=f||{},this.heuristic=f.heuristic||c.manhattan,this.trackJumpRecursion=f.trackJumpRecursion||!1}g.prototype.findPath=function(f,w,p,k,E,b,v){var M=this.openList=new o(function(C,L){return C.f-L.f}),B=this.startNode=v.getNodeAt(f,w,p),I=this.endNode=v.getNodeAt(k,E,b),_;for(this.grid=v,B.g=0,B.f=0,M.push(B),B.opened=!0;!M.empty();){if(_=M.pop(),_.closed=!0,_===I)return h.backtrace(I);this._identifySuccessors(_)}return[]},g.prototype._identifySuccessors=function(f){var w=this.grid,p=this.heuristic,k=this.openList,E=this.endNode.x,b=this.endNode.y,v=this.endNode.z;for(neighbors,neighbor,jumpPoint,i,l,x=f.x,y=f.y,z=f.z,jx,jy,dx,dy,d,ng,jumpNode,dz,jz,abs=Math.abs,max=Math.max,neighbors=this._findNeighbors(f),i=0,l=neighbors.length;i<l;++i)if(neighbor=neighbors[i],jumpPoint=this._jump(neighbor[0],neighbor[1],x,y,z),jumpPoint){if(jx=jumpPoint[0],jy=jumpPoint[1],jz=jumpPoint[2],jumpNode=w.getNodeAt(jx,jy,jz),jumpNode.closed)continue;d=c.euclidean(abs(jx-x),abs(jy-y),abs(jz-z)),ng=f.g+d,(!jumpNode.opened||ng<jumpNode.g)&&(jumpNode.g=ng,jumpNode.h=jumpNode.h||p(abs(jx-E),abs(jy-b),abs(jz-v)),jumpNode.f=jumpNode.g+jumpNode.h,jumpNode.parent=f,jumpNode.opened?k.updateItem(jumpNode):(k.push(jumpNode),jumpNode.opened=!0))}},g.prototype._jump=function(f,w,p,k,E,b){var v=this.grid,M=f-k,B=w-E,I,_;if(dz=p-b,jz,!v.isWalkableAt(f,w,p))return null;if(this.trackJumpRecursion===!0&&(v.getNodeAt(f,w,p).tested=!0),v.getNodeAt(f,w,p)===this.endNode)return[f,w,p];if(M!==0&&B!==0){if(v.isWalkableAt(f-M,w+B,p)&&!v.isWalkableAt(f-M,w,p)||v.isWalkableAt(f+M,w-B,p)&&!v.isWalkableAt(f,w-B,p))return[f,w,p]}else if(M!==0){if(v.isWalkableAt(f+M,w+1,p)&&!v.isWalkableAt(f,w+1,p)||v.isWalkableAt(f+M,w-1,p)&&!v.isWalkableAt(f,w-1,p))return[f,w,p]}else if(v.isWalkableAt(f+1,w+B,p)&&!v.isWalkableAt(f+1,w,p)||v.isWalkableAt(f-1,w+B,p)&&!v.isWalkableAt(f-1,w,p))return[f,w,p];return dz!==0&&(jz=his._jump(f,w,p+dz,f,w,p),jz)?[f,w,p]:M!==0&&B!==0&&(I=this._jump(f+M,w,p,f,w,p),_=this._jump(f,w+B,p,f,w,p),I||_)?[f,w,p]:v.isWalkableAt(f+M,w,p)||v.isWalkableAt(f,w+B,p)?this._jump(f+M,w+B,p,f,w,p):null},g.prototype._findNeighbors=function(f){var w=f.parent,p=f.x,k=f.y,E=f.z,b=this.grid,v,M,B,I,_,C,L,R,S;if(neighbors=[],neighborNodes,neighborNode,i,l,w)v=w.x,M=w.y,L=w.z,_=(p-v)/Math.max(Math.abs(p-v),1),C=(k-M)/Math.max(Math.abs(k-M),1),S=(E-L)/Math.max(Math.abs(E-L),1),S!==0?b.isWalkableAt(p,k,E+S)&&(b.isWalkableAt(p,k,E+S)&&neighbors.push([p+_,k+C,E+S]),b.isWalkableAt(p,k,E+1)||neighbors.push([p+_,k+C,E+1]),b.isWalkableAt(p,k,E-1)||neighbors.push([p+_,k+C,E-1])):_!==0&&C!==0?(b.isWalkableAt(p,k+C,E)&&neighbors.push([p,k+C,E]),b.isWalkableAt(p+_,k,E)&&neighbors.push([p+_,k,E]),(b.isWalkableAt(p,k+C,E)||b.isWalkableAt(p+_,k,E))&&neighbors.push([p+_,k+C,E]),!b.isWalkableAt(p-_,k,E)&&b.isWalkableAt(p,k+C,E)&&neighbors.push([p-_,k+C,E]),!b.isWalkableAt(p,k-C,E)&&b.isWalkableAt(p+_,k,E)&&neighbors.push([p+_,k-C,E])):_===0?b.isWalkableAt(p,k+C,E)&&(b.isWalkableAt(p,k+C,E)&&neighbors.push([p,k+C,E]),b.isWalkableAt(p+1,k,E)||neighbors.push([p+1,k+C,E]),b.isWalkableAt(p-1,k,E)||neighbors.push([p-1,k+C,E])):b.isWalkableAt(p+_,k,E)&&(b.isWalkableAt(p+_,k,E)&&neighbors.push([p+_,k,E]),b.isWalkableAt(p,k+1,E)||neighbors.push([p+_,k+1,E]),b.isWalkableAt(p,k-1,E)||neighbors.push([p+_,k-1,E]));else for(neighborNodes=b.getNeighbors(f,!0),i=0,l=neighborNodes.length;i<l;++i)neighborNode=neighborNodes[i],neighbors.push([neighborNode.x,neighborNode.y,neighborNode.z]);return neighbors},r.exports=g},{"../core/Heuristic":5,"../core/Util":7,heap:1}]},{},[3])(3)})});var pe=class{#e={};bind(u,t,e){(!Array.isArray(this.#e[u])||typeof this.#e[u]>"u")&&(this.#e[u]=[]),this.#e[u].push({listener:t,caller:e})}on(u,t,e){this.bind(u,t,e)}addEventListener(u,t,e){this.bind(u,t,e)}fire(u,t,e){if(!u||typeof u!="string")throw new Error("Event missing.");if(Array.isArray(this.#e[u])){!t||t===null||typeof t>"u"?t=[]:Array.isArray(t)||(t=[t]),e=e||this;for(var s=this.#e[u],n=0,r=s.length;n<r;n++)s[n].listener.apply(s[n].caller||e,t)}}emit(u,...t){this.fire(u,t)}dispatchEvent(u,t,e){this.fire(u,t,e)}unbind(u,t){if(!u||!t||!Array.isArray(this.#e[u]))return;let e=this.#e[u];for(let s=e.length-1;s>=0;s--)if(e[s].listener===t){e.splice(s,1);break}}remove(u,t){this.unbind(u,t)}off(u,t){this.unbind(u,t)}removeListener(u,t){this.unbind(u,t)}removeAllListeners(u){if(!u){this.#e=[];return}Array.isArray(this.#e[u])&&delete this.#e[u]}removeListenersFromCaller(u,t){if(!t){Object.keys(this.#e).forEach(s=>{let n=this.#e[s];for(let r=n.length-1;r>=0;r--)if(n[r].caller===u){n.splice(r,1);break}});return}if(!Array.isArray(this.#e[t]))return;let e=this.#e[t];for(let s=0,n=e.length;s<n;s++)if(e[s].caller===u){e.splice(s,1);break}}listeners(u){return u?this.#e[u]||[]:this.#e}};Array.prototype.filter||(Array.prototype.filter=function(m){var u=this.length>>>0;if(typeof m!="function")throw new TypeError;for(var t=[],e=arguments[1],s=0;s<u;s++)if(s in this){var n=this[s];m.call(e,n,s,this)&&t.push(n)}return t});function cs(m,u){return m.priority>u.priority?-1:m.priority<u.priority?1:0}function us(m,u){return m.priority>u.priority?-1:m.priority<u.priority?1:m.index<u.index?-1:m.index>u.index?1:0}function te(m){let u=m.map((t,e)=>({index:e,priority:t.priority}));return u.sort(us),u.map(t=>m[t.index])}function Qe(m,u,t){let e=[];if(!m||m.length===0)return e;let s=m.length;for(let n=0;n<s;n++)m[n].enabled&&m[n][u]===t&&e.push(m[n]);return e.length<=1?e:e.sort(cs)}var Rt=document.createElement("div");function Se(m){return Rt.textContent=m,Rt.innerHTML}function oi(m){return Rt.innerHTML=m,Rt.textContent}function Z(m){return m=m.replace(/^"(.+(?="$))?"$/,"$1"),m=m.replace(/^'(.+(?='$))?'$/,"$1"),m}function Li(m){let u=m.getBoundingClientRect(),t=document.documentElement;return{top:u.top+window.pageYOffset-t.clientTop,left:u.left+window.pageXOffset-t.clientLeft}}var We=class{constructor(u){this.length=0;typeof u=="string"&&u.length>0?this.buffer=[u]:this.buffer=[],this.length=0}prepend(u){return this.buffer.unshift(u),this.length+=u.length,this}append(u){return this.buffer.push(u),this.length+=u.length,this}push(u){typeof u=="number"?this.appendCode(u):this.append(u)}appendCode(u){return this.buffer.push(String.fromCharCode(u)),this.length++,this}toString(){return this.buffer.join("")}clear(u){return this.buffer=[],this.length=0,u&&typeof u<"u"&&u.length&&(this.buffer.push(u),this.length=u.length),this}concat(u){this.buffer=this.buffer.concat(u)}};function Ot(m,u){if(m.length>1)return!1;if(m==="-"||m==="_"||m==="."||m==="~"||m==="!"||m==="*"||m==="'"||m===";"||m===":"||m==="@"||m==="&"||m==="="||m==="+"||m==="$"||m===","||m==="/"||m==="\\"||m==="?"||m==="%"||m==="#"||m==="["||m==="]"||m==="("||m===")")return!u;let t=m.charCodeAt(0);return t>64&&t<91||t>96&&t<123||t>47&&t<58||t>=160&&t<=55295||t>=57344&&t<=64975||t>=65008&&t<=65533||t>=65536&&t<=131069||t>=131072&&t<=196605||t>=196608&&t<=262141||t>=262144&&t<=327677||t>=327680&&t<=393213||t>=393216&&t<=458749||t>=458752&&t<=524285||t>=524288&&t<=589821||t>=589824&&t<=655357||t>=655360&&t<=720893||t>=720896&&t<=786429||t>=786432&&t<=851965||t>=851968&&t<=917501||t>=921600&&t<=983037||t>=983040&&t<=1048573||t>=1048576&&t<=1114109}var ut={3:"Cancel",6:"Help",8:"Backspace",9:"Tab",19:"Pause/Break",20:"Caps Lock",21:"Kana",22:"Eisu",23:"Junja",24:"Final",25:"Hanja",27:"Esc",28:"Convert",29:"Nonconvert",30:"Accept",31:"Modechange",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",41:"Select",42:"Print",43:"Execute",44:"Printscreen",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",58:"Colon",59:"Semicolon",60:"Less Than",61:"Equals2",62:"Greater Than",63:"Question Mark",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",93:"Context Menu",95:"Sleep",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",124:"F13",125:"F14",126:"F15",127:"F16",128:"F17",129:"F18",130:"F19",131:"F20",132:"F21",133:"F22",134:"F23",135:"F24",144:"Num Lock",145:"Scroll Lock",146:"Win Oem Fj Jisho",147:"Win Oem Fj Masshou",148:"Win Oem Fj Touroku",149:"Win Oem Fj Loya",150:"Win Oem Fj Roya",160:"Circumflex",161:"Exclamation",162:"Double Quote",163:"Hash",164:"Dollar",165:"Percent",166:"Ampersand",167:"Underscore",168:"Open Paren",169:"Close Paren",170:"Asterisk",171:"Plus",172:"Pipe",173:"Hyphen Minus",174:"Open Curly Bracket",175:"Close Curly Bracket",176:"Tilde",181:"Volume Mute",182:"Volume Down",183:"Volume Up",186:";",187:"Equals",188:",",189:"Minus",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",227:"Win Ico Help",228:"Win Ico 00",230:"Win Ico Clear",233:"Win Oem Reset",234:"Win Oem Jump",235:"Win Oem Pa1",236:"Win Oem Pa2",237:"Win Oem Pa3",238:"Win Oem Wsctrl",239:"Win Oem Cusel",240:"Win Oem Attn",241:"Win Oem Finish",242:"Win Oem Copy",243:"Win Oem Auto",244:"Win Oem Enlw",245:"Win Oem Backtab",246:"Attn",247:"Crsel",248:"Exsel",249:"Ereof",250:"Play",251:"Zoom",253:"Pa1",254:"Win Oem Clear"},Ii={Cancel:3,Help:6,Backspace:8,Tab:9,"Pause/Break":19,"Caps Lock":20,Esc:27,Space:32,"Page Up":33,"Page Down":34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"Numpad 0":96,"Numpad 1":97,"Numpad 2":98,"Numpad 3":99,"Numpad 4":100,"Numpad 5":101,"Numpad 6":102,"Numpad 7":103,"Numpad 8":104,"Numpad 9":105,"Numpad *":106,"Numpad +":107,"Numpad -":109,"Numpad .":110,"Numpad /":111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,"Num Lock":144,"Scroll Lock":145,";":186,",":188,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222,Kana:21,Eisu:22,Junja:23,Final:24,Hanja:25,Convert:28,Nonconvert:29,Accept:30,Modechange:31,Select:41,Print:42,Execute:43,Printscreen:44,Colon:58,Semicolon:59,"Less Than":60,Equals2:61,"Greater Than":62,"Question Mark":63,"Context Menu":93,Sleep:95,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,"Win Oem Fj Jisho":146,"Win Oem Fj Masshou":147,"Win Oem Fj Touroku":148,"Win Oem Fj Loya":149,"Win Oem Fj Roya":150,Circumflex:160,Exclamation:161,"Double Quote":162,Hash:163,Dollar:164,Percent:165,Ampersand:166,Underscore:167,"Open Paren":168,"Close Paren":169,Asterisk:170,Plus:171,Pipe:172,"Hyphen Minus":173,"Open Curly Bracket":174,"Close Curly Bracket":175,Tilde:176,"Volume Mute":181,"Volume Down":182,"Volume Up":183,Equals:187,Minus:189,"Win Ico Help":227,"Win Ico 00":228,"Win Ico Clear":230,"Win Oem Reset":233,"Win Oem Jump":234,"Win Oem Pa1":235,"Win Oem Pa2":236,"Win Oem Pa3":237,"Win Oem Wsctrl":238,"Win Oem Cusel":239,"Win Oem Attn":240,"Win Oem Finish":241,"Win Oem Copy":242,"Win Oem Auto":243,"Win Oem Enlw":244,"Win Oem Backtab":245,Attn:246,Crsel:247,Exsel:248,Ereof:249,Play:250,Zoom:251,Pa1:253,"Win Oem Clear":254};(function(m){m.fn.hasHorizontalScrollBar=function(){return m(this)[0].scrollWidth>m(this).innerWidth()}})(jQuery);function $e(m,u){return JSON.parse(JSON.stringify(m,u))}function hi(m){let u,t,e;if(!m||typeof m!="object"&&!Array.isArray(m))return m;u=Array.isArray(m)?[]:{};for(e in m)m.hasOwnProperty(e)&&(t=m[e],u[e]=t&&(typeof t=="object"||Array.isArray(t))?hi(t):t);return u}function ci(m,u,t){if(m.setSelectionRange)m.focus(),m.setSelectionRange(u,t);else if(m.createTextRange){let e=m.createTextRange();e.collapse(!0),e.moveEnd("character",t),e.moveStart("character",u),e.select()}}function Pi(m){!m||m.value.length===0||(m.setSelectionRange?(m.focus(),m.setSelectionRange(0,m.value.length)):m.select())}CanvasRenderingContext2D.prototype.fillRoundedRect=function(m,u,t,e,s){this.beginPath(),this.moveTo(m+s,u),this.lineTo(m+t-s,u),this.quadraticCurveTo(m+t,u,m+t,u+s),this.lineTo(m+t,u+e-s),this.quadraticCurveTo(m+t,u+e,m+t-s,u+e),this.lineTo(m+s,u+e),this.quadraticCurveTo(m,u+e,m,u+e-s),this.lineTo(m,u+s),this.quadraticCurveTo(m,u,m+s,u),this.closePath(),this.fill()};CanvasRenderingContext2D.prototype.strokeRoundedRect=function(m,u,t,e,s){this.beginPath(),this.moveTo(m+s,u),this.lineTo(m+t-s,u),this.quadraticCurveTo(m+t,u,m+t,u+s),this.lineTo(m+t,u+e-s),this.quadraticCurveTo(m+t,u+e,m+t-s,u+e),this.lineTo(m+s,u+e),this.quadraticCurveTo(m,u+e,m,u+e-s),this.lineTo(m,u+s),this.quadraticCurveTo(m,u,m+s,u),this.closePath(),this.stroke()};Object.keys||(Object.keys=function(m){if(m!==Object(m))throw new TypeError("Object.keys called on a non-object");var u=[],t;for(t in m)Object.prototype.hasOwnProperty.call(m,t)&&u.push(t);return u});Object.toType||(Object.toType=function(m){return{}.toString.call(m).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()});typeof String.prototype.startsWith!="function"&&(String.prototype.startsWith=function(m){return this.slice(0,m.length)==m});typeof String.prototype.endsWith!="function"&&(String.prototype.endsWith=function(m){return this.slice(-m.length)==m});typeof String.prototype.splice!="function"&&(String.prototype.splice=function(m,u,t){return typeof t>"u"&&(t=0),this.slice(0,m)+u+this.slice(m+Math.abs(t))});typeof String.prototype.padStart!="function"&&(String.prototype.padStart=function(m){return typeof m=="number"&&(m=" ".repeat(m)),String(m+this).slice(-m.length)});typeof String.prototype.padEnd!="function"&&(String.prototype.padEnd=function(m){return typeof m=="number"?m<=this.length?this:(m=" ".repeat(m-this.length),this+m):m.length<=this.length?this:this+m.slice(-this.length)});String.prototype.replaceAll||(String.prototype.replaceAll=function(m,u){return Object.prototype.toString.call(m).toLowerCase()==="[object regexp]"?this.replace(m,u):this.replace(new RegExp(m,"g"),u)});typeof Uint8Array.prototype.charAt!="function"&&(Uint8Array.prototype.charAt=function(m){return String.fromCharCode(this[m])});typeof Uint8Array.prototype.charCodeAt!="function"&&(Uint8Array.prototype.charCodeAt=function(m){return this[m]});function ps(m,u){return!m||!m.length?m:u?m.replace(/\\/g,"\\\\").replace(/\u0008/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\u0000/g,"\\0"):m.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"')}String.prototype.addSlashes=function(){return ps(this)};String.prototype.splitQuote=function(m,u,t,e){if(this.length===0)return[];if(!m||!m.length)return[this];u||(u=3),t||(t=3),e||(e="\\");let s=!1,n=!1,r=[],a=0,o=0,h,c="",g,f=m.length,w,p=this.length;for(;o<p;o++){if(h=this.charAt(o),h==='"'&&(u&2)===2)(t&2)===2?(o===0||c!==e)&&(s=!s):s=!s;else if(h==="'"&&(u&1)===1)(t&1)===1?(o===0||c!==e)&&(n=!n):n=!n;else if(!s&&!n){for(g=0;g<f;g++)if(w=m.charAt(g),h===w)if(o>a||o===0){r.push(this.substr(a,o-a)),a=o+1;break}else if(o===a){r.push(""),a=o+1;break}else o===p-1&&r.push("")}c=h}return o===p&&o===a&&m.indexOf(c)!==-1&&(r.push(""),a=o+1),o>a&&r.push(this.substr(a,o-a)),r};function ui(m){let u,t=[];return u=Math.floor(m/(1e3*60*60*24)),m-=u*(1e3*60*60*24),u===1?t.push(u+" day"):u>0&&t.push(u+" days"),u=Math.floor(m/(1e3*60*60)),m-=u*(1e3*60*60),u===1?t.push(u+" hour"):u>0&&t.push(u+" hours"),u=Math.floor(m/(1e3*60)),m-=u*(1e3*60),u===1?t.push(u+" minute"):u>0&&t.push(u+" minutes"),u=Math.floor(m/1e3),m-=u*1e3,u===1?t.push(u+" second"):u>0&&t.push(u+" seconds"),t.length===0&&t.push("0 seconds"),t.join(", ")}function ke(m,u){if(!m)return"";m=m.split(" ");let t,e,s,n=u?1:m.length;for(e=0;e<n;e++){let r=m[e].length;for(s=0;s<r;s++)if(t=m[e].charAt(s),t>="a"&&t<="z"||t>="A"&&t<="Z"){m[e]=m[e].substr(0,s)+t.toUpperCase()+m[e].substr(s+1).toLowerCase();break}}return m.join(" ")}function Dt(m,u,t,e,s){if(typeof t>"u"&&(t=3),typeof e>"u"&&(e=0),typeof s>"u"&&(s="\\"),!m||m.length===0)return[];if(!u||u.length===0)return[m];u=u.split("");let n=!1,r=!1,a=[],o=0,h=0,c=m.length,g;for(;h<c;h++)if(g=m.charAt(h),g==='"'&&(t&2)===2)(e&2)===2&&h>0?h-1>0&&m.charAt(h-1)!==s&&(n=!n):n=!n;else if(g==="'"&&(t&1)===1)(e&1)===1&&h>0?h-1>0&&m.charAt(h-1)!==s&&(r=!r):r=!r;else if(!r&&!n){let f=u.length;for(let w=0;w<f;w++)if(g===u[w])if(h>o||h===0){a.push(m.substring(o,h)),o=h+1;break}else if(h===o){a.push(""),o=h+1;break}else h===c-1&&a.push("")}return h===c&&h===o&&u.indexOf(m.charAt(h-1))>-1&&(a.push(""),o=h+1),h>o&&a.push(m.substring(o,h)),a}function Mi(m){if(!m)return 0;if(typeof m.selectionStart=="number")return m.selectionDirection=="backward"?m.selectionStart:m.selectionEnd;if(document.selection){m.focus();var u=document.selection.createRange();return u.moveStart("character",-m.value.length),u.text.length}return 0}var ce;function pi(m){m=m||"",m=m.split("%^"),ce||ds();let u=[],t=[],e=0,s=m.length,n=!1,r=!1,a=[];for(;e<s;e++)switch(m[e]){case"ITALIC":u.push("<em>"),t.push("</em>");break;case"UNDERLINE":a.push("underline");break;case"STRIKEOUT":a.push("strikeout");break;case"DBLUNDERLINE":a.push("dblunderline");break;case"OVERLINE":a.push("overline");break;case"FLASH":a.push("noflash");break;case"REVERSE":a.push("reverse");break;case"RESET":case"DEFAULT":let o=t.length;for(let h=0;h<o;h++)u.push(t[h]);t=[],a=[];break;case"BOLD":n=!0;break;case"":break;default:if(m[e].startsWith("B_")){m[e]=m[e].substr(2),n&&!r&&(u.push('<span style="border: inherit;text-decoration:inherit;color: #'+ce["BOLD%^%^WHITE"]+'">'),t.push("</span>")),u.push('<span style="border: inherit;text-decoration:inherit;background-color: #'+ce[m[e]]+'">'),t.push("</span>"),n=!1;continue}else if(ce[m[e]]){if(n&&!ce["BOLD%^%^"+m[e]])u.push('<span style="border: inherit;text-decoration:inherit;color: #'+ce["BOLD%^%^WHITE"]+'">'),t.push("</span>"),r=!0;else if(n){u.push('<span style="border: inherit;text-decoration:inherit;color: #'+ce["BOLD%^%^"+m[e]]+'">'),t.push("</span>"),r=!0;continue}u.push('<span style="border: inherit;text-decoration:inherit;color: #'+ce[m[e]]+'">'),t.push("</span>");continue}else n&&!r&&(u.push('<span style="border: inherit;text-decoration:inherit;color: #'+ce["BOLD%^%^WHITE"]+'">'),t.push("</span>"));a.length&&(u.push('<span class="'+a.join(" ")+'">'),t.push("</span>"),a=[]),u.push(m[e]),n=!1,r=!1;break}for(a.length&&(u.push('<span class="'+a.join(" ")+'">'),t.push("</span>")),e=0,s=t.length;e<s;e++)u.push(t[e]);return u.join("")}function ds(){let m,u,t,e,s,n;for(ce={},ce.BLACK="000000",ce.RED="800000",ce.GREEN="008000",ce.ORANGE="808000",ce.BLUE="0000EE",ce.MAGENTA="800080",ce.CYAN="008080",ce.WHITE="BBBBBB",ce.mono11="808080",ce["BOLD%^%^RED"]="FF0000",ce["BOLD%^%^GREEN"]="00FF00",ce.YELLOW="FFFF00",ce["BOLD%^%^YELLOW"]="FFFF00",ce["BOLD%^%^BLUE"]="5C5CFF",ce["BOLD%^%^MAGENTA"]="FF00FF",ce["BOLD%^%^CYAN"]="00FFFF",ce["BOLD%^%^WHITE"]="FFFFFF",ce["BOLD%^%^BLACK"]="808080",t=0;t<6;t++)for(e=0;e<6;e++)for(s=0;s<6;s++)n=`RGB${t}${e}${s}`,u="",m=0,m=t*40+55,m<16&&(u+="0"),u+=m.toString(16),m=0,m=e*40+55,m<16&&(u+="0"),u+=m.toString(16),m=0,m=s*40+55,m<16&&(u+="0"),u+=m.toString(16),ce[n]||(ce[n]=u.toUpperCase());for(t=232;t<=255;t++)e=(t-232)*10+8,e<16?e="0"+e.toString(16).toUpperCase():e=e.toString(16).toUpperCase(),e=e+e+e,t<242?ce["mono0"+(t-232)]=e:ce["mono"+(t-232)]=e}function Bi(){let m=[],u,t,e,s;for(u=0;u<6;u++)for(t=0;t<6;t++)for(e=0;e<6;e++)s=16+u*36+t*6+e,m[s]="rgb(",u>0?m[s]+=u*40+55:m[s]+="0",m[s]+=",",t>0?m[s]+=t*40+55:m[s]+="0",m[s]+=",",e>0?m[s]+=e*40+55:m[s]+="0",m[s]+=")";for(u=232;u<=255;u++)t=(u-232)*10+8,m[u]=["rgb(",t,",",t,",",t,")"].join("");return m[0]="rgb(0,0,0)",m[1]="rgb(128, 0, 0)",m[2]="rgb(0, 128, 0)",m[3]="rgb(128, 128, 0)",m[4]="rgb(0, 0, 238)",m[5]="rgb(128, 0, 128)",m[6]="rgb(0, 128, 128)",m[7]="rgb(187, 187, 187)",m[8]="rgb(128, 128, 128)",m[9]="rgb(255, 0, 0)",m[10]="rgb(0, 255, 0)",m[11]="rgb(255, 255, 0)",m[12]="rgb(92, 92, 255)",m[13]="rgb(255, 0, 255)",m[14]="rgb(0, 255, 255)",m[15]="rgb(255, 255, 255)",m[256]="rgb(0, 0, 0)",m[257]="rgb(118, 0, 0)",m[258]="rgb(0, 108, 0)",m[259]="rgb(145, 136, 0)",m[260]="rgb(0, 0, 167)",m[261]="rgb(108, 0, 108)",m[262]="rgb(0, 108, 108)",m[263]="rgb(161, 161, 161)",m[264]="rgb(0, 0, 0)",m[265]="rgb(128, 0, 0)",m[266]="rgb(0, 128, 0)",m[267]="rgb(128, 128, 0)",m[268]="rgb(0, 0, 238)",m[269]="rgb(128, 0, 128)",m[270]="rgb(0, 128, 128)",m[271]="rgb(187, 187, 187)",m[272]="rgb(0,0,0)",m[273]="rgb(0, 255, 255)",m[274]="rgb(0,0,0)",m[275]="rgb(255, 255, 0)",m[276]="rgb(0, 0, 0)",m[277]="rgb(229, 229, 229)",m[278]="rgb(205, 0, 0)",m[279]="rgb(229, 229, 229)",m[280]="rgb(255,255,255)",m}function rt(m,u){return m&&(/^\d+c$/.test(m)?u?parseInt(m,10)*u+"px":m+"h":/^\d+$/.test(m)?parseInt(m,10)+"px":m)}function He(m){return!m||m.length===0||!m.match(/^[a-zA-Z_$][a-zA-Z_$0-9]*$/g)?!1:["break","case","catch","continue","debugger","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with","class","const","enum","export","extends","import","super","implements","interface","let","package","private","protected","public","static","yield","null","true","false","NaN","Infinity","undefined","eval","arguments"].indexOf(m)===-1}function Ke(m,u){if(!m)return;let t=document.activeElement;(!t||t!=m)&&m.focus(),document.execCommand("insertText",!1,u),t&&t!=m&&t.focus()}Array.isArray||(Array.isArray=function(m){return Object.prototype.toString.call(m)==="[object Array]"});var Ci;function lt(m){return window.TextDecoder!==void 0?(Ci||(Ci=new TextDecoder)).decode(new Uint8Array(m)):fs(String.fromCharCode.apply(null,Array.prototype.slice.apply(new Uint8Array(m))))}function fs(m){var u;try{return decodeURIComponent(escape(m))}catch(t){if(u=t,u instanceof URIError)return m;throw u}}function ms(m){var u,t,e,s,n,r;for(n=m.length,u=[],s=!1,e=r=0;0<=n?r<n:r>n;e=0<=n?++r:--r)if(t=String.prototype.charCodeAt.call(m,e),t>255){s=!0,u=null;break}else u.push(t);return s===!0?unescape(encodeURIComponent(m)):String.fromCharCode.apply(null,Array.prototype.slice.apply(u))}var Ti;function Ue(m){var u,t,e,s,n,r;if(window.TextEncoder!==void 0)return(Ti||(Ti=new TextEncoder)).encode(m);for(u=ms(m),t=u.length,e=new ArrayBuffer(t),s=new Uint8Array(e),n=r=0;0<=t?r<t:r>t;n=0<=t?++r:--r)s[n]=String.prototype.charCodeAt.call(u,n);return s}function Oe(m){return new Promise(function(u,t){try{if(typeof navigator<"u"&&typeof navigator.clipboard<"u"&&typeof navigator.permissions<"u"){var e=new Blob([m],{type:"text/plain"}),s=[new ClipboardItem({"text/plain":e})];navigator.permissions.query({name:"clipboardWrite"}).then(function(r){r.state==="granted"||r.state==="prompt"?navigator.clipboard.write(s).then(u,t).catch(t):t(new Error("Permission not granted!"))})}else if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var n=document.createElement("textarea");n.value=m,n.textContent=m,n.style.position="fixed",n.style.width="2em",n.style.height="2em",n.style.padding="0",n.style.border="none",n.style.outline="none",n.style.boxShadow="none",n.style.background="transparent",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),document.body.removeChild(n),u(null)}catch(r){document.body.removeChild(n),t(r)}}else t(new Error("None of copying methods are supported by this browser!"))}catch(r){t(r)}})}function pt(){return new Promise(function(m,u){try{if(typeof navigator<"u"&&typeof navigator.clipboard<"u"&&typeof navigator.permissions<"u")navigator.permissions.query({name:"clipboardRead"}).then(function(e){e.state==="granted"||e.state==="prompt"?navigator.clipboard.readText().then(m,u).catch(u):u(new Error("Permission not granted!"))});else if(document.queryCommandSupported&&document.queryCommandSupported("paste")){var t=document.createElement("textarea");t.style.position="fixed",t.style.width="2em",t.style.height="2em",t.style.padding="0",t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("paste",!1,null),m(t.value),document.body.removeChild(t)}catch(e){document.body.removeChild(t),u(e)}}else u(new Error("None of pasting methods are supported by this browser!"))}catch(e){u(e)}})}function di(m,u){if(!m)return null;u||(u=window.location.href),m=m.replace(/[[\]]/g,"\\$&");var t=new RegExp("[?&]"+m+"(=([^&#]*)|&|#|$)"),e=t.exec(u);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function gs(){var m="download"in document.createElement("a"),u=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,t=window.URL||window.webkitURL||window.mozURL||window.msURL;navigator.saveBlob=navigator.saveBlob||navigator.msSaveBlob||navigator.mozSaveBlob||navigator.webkitSaveBlob,window.saveAs=window.saveAs||window.webkitSaveAs||window.mozSaveAs||window.msSaveAs;var e={"image/jpeg":!0,"image/png":!0,"image/gif":!0,"image/svg+xml":!0,"image/bmp":!0,"image/x-windows-bmp":!0,"image/webp":!0,"audio/wav":!0,"audio/mpeg":!0,"audio/webm":!0,"audio/ogg":!0,"video/mpeg":!0,"video/webm":!0,"video/ogg":!0,"text/plain":!0,"text/html":!0,"text/xml":!0,"application/xhtml+xml":!0,"application/json":!0};u&&(window.saveAs||navigator.saveBlob)?this.show=function(s,n,r){var a=new u;a.append(s);var o=a.getBlob(r||"application/octet-stream");n||(n="Download.bin"),window.saveAs?window.saveAs(o,n):navigator.saveBlob(o,n)}:u&&t?this.show=function(s,n,r){var a,o,h=new u;if(h.append(s),r||(r="application/octet-stream"),m){a=h.getBlob(r),o=t.createObjectURL(a);var c=document.createElement("a");c.setAttribute("href",o),c.setAttribute("download",n||"Download.bin");var g=document.createEvent("MouseEvents");g.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(g)}else e[r.split(";")[0]]===!0&&(r="application/octet-stream"),a=h.getBlob(r),o=t.createObjectURL(a),window.open(o,"_blank","");setTimeout(function(){t.revokeObjectURL(o)},250)}:Blob&&t?this.show=function(s,n,r){var a,o;if(r||(r="application/octet-stream"),a=new Blob([s],{type:r}),m){o=t.createObjectURL(a);var h=document.createElement("a");h.setAttribute("href",o),h.setAttribute("download",n||"Download.bin");var c=document.createEvent("MouseEvents");c.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),h.dispatchEvent(c)}else e[r.split(";")[0]]===!0&&(r="application/octet-stream"),o=t.createObjectURL(a),window.open(o,"_blank","");setTimeout(function(){t.revokeObjectURL(o)},250)}:/\bMSIE\b/.test(navigator.userAgent)||(this.show=function(s,n,r){r||(r="application/octet-stream"),e[r.split(";")[0]]===!0&&(r="application/octet-stream"),window.open("data:"+r+","+encodeURIComponent(s),"_blank","")})}window.fileSaveAs=new gs;function bs(){var m,u;function t(e,s){var n=e.charCodeAt(u);if(!(n&128))m=n;else if((n&224)==192)m=(n&31)<<6|e.charCodeAt(u+1)&63,u+=1;else if((n&240)==224)m=(n&15)<<12|(e.charCodeAt(u+1)&63)<<6|e.charCodeAt(u+2)&63,u+=2;else if((n&248)==240)m=(n&7)<<18|(e.charCodeAt(u+1)&63)<<12|(e.charCodeAt(u+2)&63)<<6|e.charCodeAt(u+3)&63,u+=1;else return!1;return!0}this.decode=function(e){var s=new We,n=e.length;for(u=0;u<n;u++)t(e,n)&&s.appendCode(m);return s.toString()},this.decode2=function(e){var s=new We,n=e.length,r,a;for(r=0;r<n;r++){if(a=e.charCodeAt(r),a&128)if((a&224)==192)a=(a&31)<<6|e.charCodeAt(r+1)&63,r+=1;else if((a&240)==224)a=(a&15)<<12|(e.charCodeAt(r+1)&63)<<6|e.charCodeAt(r+2)&63,r+=2;else if((a&248)==240)a=(a&7)<<18|(e.charCodeAt(r+1)&63)<<12|(e.charCodeAt(r+2)&63)<<6|e.charCodeAt(r+3)&63,r+=1;else continue;s.appendCode(a)}return s.toString()}}window.UTF8=new bs;function je(m){if(m===null||typeof m>"u")return m;var u,t,e=0;for(u=m.byteLength,t=new We;e<u;e++)m[e]<32||m[e]>=127?t.append("<"+m[e]+">"):t.append(String.fromCharCode(m[e]));return t.toString()}function fi(){let m=document.createElement("div");m.style.visibility="hidden",m.style.overflow="scroll",m.style.msOverflowStyle="scrollbar",document.body.appendChild(m);let u=document.createElement("div");m.appendChild(u);let t=m.offsetWidth-u.offsetWidth;return m.parentNode.removeChild(m),t}function ge(m,u,t){return new Promise((e,s)=>{let n=document.createElement("dialog");if(typeof n.showModal!="function"){s("Browser does not support dialogs.");return}n.id="openFileDialog",n.style.zIndex="2000",n.style.height="158px",n.style.width="350px",n.innerHTML=`<div class="dialog-header" style="font-weight: bold"><button type="button" class="btn btn-close float-end btn-danger" data-dismiss="modal" onclick="document.getElementById('openFileDialog').close();"></button><div>${m||"Open file..."}</div></div><div class="dialog-body"><div class="m-3"><input class="form-control" type="file" id="openFileDialog-files"${u?" multiple":""} required${t&&t.length?' accept="'+t+'"':""}></div></div><div class="dialog-footer"><button id="openFileDialog-cancel" style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('openFileDialog').close();">Cancel</button><button id="openFileDialog-ok" style="float: right" type="button" class="btn btn-primary">Ok</button></div>`,document.body.appendChild(n),n.addEventListener("close",r=>{r.target===n&&(document.body.removeChild(n),n.returnValue!=="file-ok"&&s("closed"))}),n.addEventListener("cancel",r=>{r.target===n&&(document.body.removeChild(n),n.returnValue!=="file-ok"&&s("canceled"))}),document.getElementById("openFileDialog-ok").addEventListener("click",()=>{let r=document.getElementById("openFileDialog-files");if(!r.files||r.files.length===0){r.classList.add("is-invalid");return}r.classList.remove("is-invalid"),n.close(),n.returnValue="files-ok",e(r.files)}),n.showModal()})}function be(m,u){return new Promise((t,e)=>{m||e(new Error("Invalid file"));var s=new FileReader;s.onerror=e,s.onload=n=>{t(n.target.result)},s.readAsText(m),u&&(s.onprogress=u)})}var ai={};function fe(m,u,t){t=t||"default",clearTimeout(ai[t]),ai[t]=setTimeout(()=>{m(),delete ai[t]},u)}function Ri(m,u){let t=u.getBoundingClientRect(),e=m.getBoundingClientRect();(t.top<e.top||t.bottom>e.bottom||t.left<e.left||t.right>e.right)&&u.scrollIntoView({behavior:"smooth",block:"nearest"})}var Ai=li(Di()),xt=class extends pe{constructor(t){super();this._splitBuffer=[];this._connected=!1;this._MTTS=0;this.zStream=0;this._latencyTime=null;this._doPing=!1;this._closed=!0;this._zlib=!1;this.options={MCCP:!0,MXP:!0,NAWS:!0,MSDP:!0,GMCP:!0,MSSP:!1,ECHO:!0,TTYPE:!0,EOR:!0,NEWENVIRON:!1,ZMP:!1,ATCP:!1,CHARSET:!0};this.host="";this.port=23;this.prompt=!1;this.echo=!0;this.firstSent=!0;this.firstReceived=!0;this.server={NAWS:!1,MSDP:!1,GMCP:!1,MXP:!1,MCCP1:!1,MCCP2:!1,MSSP:!1,NEWENVIRON:!1,ZMP:!1,EOR:!1,ATCP:!1,CHARSET:!1};this.version="2.0";this.terminal="ansi";this.UTF8=!0;this.MSSP={};this.socket=null;this.latency=0;this.latencyAvg=null;this.enableLatency=!1;this.enablePing=!1;this.GMCPSupports=["Core 1","Char 1","Char.Vitals 1","Char.Experience 1"];this.enableDebug=!1;this.scheme="ws://";this.protocol="binary";t&&("host"in t&&(t.host&&t.host.length&&(this.host=t.host),delete t.host),"port"in t&&(this.port=t.port,delete t.port),"scheme"in t&&(t.scheme&&t.scheme.length&&(this.scheme=t.scheme),delete t.scheme),"protocol"in t&&(t.protocol&&t.protocol.length&&(this.protocol=t.protocol),delete t.protocol)),this.options=Object.assign(this.options,t||{})}get connected(){return!this.socket||typeof this.socket>"u"?!1:this._connected}reset(){this._MTTS=0,this.firstSent=!0,this.firstReceived=!0,this.prompt=!1,this.echo=!0,this.server={NAWS:!1,MSDP:!1,GMCP:!1,MXP:!1,MCCP1:!1,MCCP2:!1,MSSP:!1,EOR:!1,NEWENVIRON:!1,ATCP:!1,CHARSET:!1,ZMP:!1},this._splitBuffer=[],this._endMCCP(),this._connected=!1,this._closed=!1,this.enableDebug&&this.emit("debug","Reset")}connect(){this._destroySocket(),this.reset(),this.emit("connecting"),this.socket=this._createSocket(this.host,this.port),this.enableDebug&&this.emit("debug","Connecting to "+this.host+":"+this.port)}close(){this._closed||(this._destroySocket(),this.reset(),this.emit("close"),this._closed=!0,this.enableDebug&&this.emit("debug","Closed"))}receivedData(t,e,s){this.enableLatency&&(this._latencyTime!==null?(this.latency=new Date().getTime()-this._latencyTime.getTime(),this.latencyAvg==null?this.latencyAvg=this.latency:this.latencyAvg=(this.latency+this.latencyAvg)/2,this._latencyTime=null,this._doPing=!1,this.emit("latency-changed",this.latency,this.latencyAvg)):!this._doPing&&this.enablePing?this._doPing=!0:(this._latencyTime=null,this._doPing=!1)),this.enableDebug&&this.emit("debug","PreProcess:"+t,1),t=this.processData(t,e,!1,s),this.enableDebug&&this.emit("debug","PostProcess:"+t,1),this.emit("received-data",t),this.enableLatency&&(this._splitBuffer.length>0?(this.enablePing&&(this._doPing=!0),this._latencyTime=null):this._doPing&&this.enablePing?setTimeout(()=>{this._latencyTime=new Date,this.sendGMCP("Core.Ping "+this.latencyAvg)}):this._doPing=!1)}sendTerminal(){if(this.enableDebug&&(this._MTTS===0?this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>"+this.terminal+"<IAC><SE>"):this._MTTS===1?this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>ANSI-256COLOR<IAC><SE>"):this._MTTS>=2&&this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>MTTS 9<IAC><SE>")),this._MTTS===0){var t=new Uint8Array(6+this.terminal.length);t.set([255,250,24,0],0),t.set(Ue(this.terminal),4),t.set([255,240],4+this.terminal.length),this.sendData(t,!0)}else this._MTTS===1?this.sendData([255,250,24,0,65,78,83,73,45,50,53,54,67,79,76,79,82,255,240],!0):this._MTTS>=2&&this.sendData([255,250,24,0,77,84,84,83,32,57,255,240],!0)}sendData(t,e){if(!(t==null||typeof t>"u"||t.length===0)){if(this.connected)try{e||(this.prompt=!1,t=this._escapeData(t),this.enableLatency&&(this._latencyTime=new Date)),this.socket!==null&&(t instanceof Uint8Array?(this.enableDebug&&this.emit("debug","sendDataU8:"+je(t)),this.socket.send(t)):Array.isArray(t)?(this.enableDebug&&this.emit("debug","sendDataBA"+je(new Uint8Array(t))),this.socket.send(new Uint8Array(t))):(this.enableDebug&&this.emit("debug","sendDataR:"+je(Ue(t))),this.socket.send(t)),e||(this.firstSent=!1))}catch(s){this.emit("error",s)}else this.enableLatency&&(this._latencyTime=null);this.emit("data-sent",t,e)}}processData(t,e,s,n){let r,a="",o;if(t==null||(e||(t=this._decompressData(t)),r=t.byteLength,r===0))return t;o=this._splitBuffer,o.length>0&&(this.enableDebug&&this.emit("debug","Split buffer length: "+o.length,1),a=new Uint8Array(r+o.length),n?(a.set(t,0),a.set(o,t.byteLength)):(a.set(o,0),a.set(t,o.length)),t=a,o=[],r=t.byteLength);let h=0,c=0,g=new We,f=this.prompt,w=0,p=0,k="",E="",b,v=0,M,B=0;a="",this.prompt=!1;let I="";try{for(;B<r;B++)switch(v=t[B],h){case 0:if(v===255)this.enableDebug&&(I="TELOP: <IAC>"),o.push(v),h=1;else if(this.UTF8||this.options.CHARSET&&this.server.CHARSET){if((v&128)===128&&B>=r-4){let _=0;if((v&192)===192?_=1:(v&224)===224?_=2:(v&240)===240&&(_=3),B+_>=r){o.push(...t.slice(B)),this.enableDebug&&(this.emit("debug","Unicode split length: "+_,1),this.emit("debug","Split buffer length: "+o.length,1));break}}g.appendCode(v)}else g.appendCode(v);break;case 1:if(v===255)this.enableDebug&&(this.emit("debug",I+"<IAC>"),I=""),g.appendCode(v),o=[],h=0;else if((!this.options.EOR||!this.server.EOR)&&v===239)this.enableDebug&&(this.emit("debug",I+"<NOP>"),I=""),o=[],h=0;else if(v===241||v===130)this.enableDebug&&(this.emit("debug",I+"<NOP>"),I=""),o=[],h=0;else if(v===249||v===239)this.enableDebug&&(v===239?this.emit("debug",I+"<EOR>"):this.emit("debug",I+"<GA>"),I=""),B+1<r&&r-B>2?(g.push(`
`),this.prompt=!1):this.prompt=!0,o=[],h=0;else if(v===253||v===254||v===251||v===252){if(this.enableDebug)switch(v){case 253:I+="<DO>";break;case 254:I+="<DONT>";break;case 251:I+="<WILL>";break;case 252:I+="<WONT>";break}o.push(v),w=v,h=2}else v===250?(this.enableDebug&&(I+="<SB>"),o.push(v),h=3):(this.enableDebug&&(I+=this._formatByte(v)),o=[],h=0);break;case 2:v===1?(this.enableDebug&&(this.emit("debug",I+"<ECHO>"),I=""),w===253?this.options.ECHO?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><ECHO>"),this.replyToOption(v,251,w),this.echo=!1):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(v,254,w)):w===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><ECHO>"),this.replyToOption(v,252,w),this.echo=!0):w===251?this.options.ECHO?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><ECHO>"),this.replyToOption(v,253,w),this.echo=!1):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(v,254,w)):w===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(v,254,w)),h=0,o=[]):v===24?(this.enableDebug&&(this.emit("debug",I+"<TERMINALTYPE>"),I=""),w===253?this.options.TTYPE?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><TERMINALTYPE>"),this.replyToOption(v,251,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(v,254,w)):w===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><TERMINALTYPE>"),this.replyToOption(v,252,w)):w===251?this.options.TTYPE?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><TERMINALTYPE>"),this.replyToOption(v,253,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(v,254,w)):w===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(v,254,w)),h=0,o=[]):v===25?(this.enableDebug&&(this.emit("debug",I+"<ENDOFRECORD>"),I=""),w===253?(this.server.EOR=!0,this.options.EOR?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><ENDOFRECORD>"),this.replyToOption(v,251,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(v,254,w))):w===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><ENDOFRECORD>"),this.replyToOption(v,252,w)):w===251?(this.server.EOR=!0,this.options.EOR?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><ENDOFRECORD>"),this.replyToOption(v,253,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(v,254,w))):w===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(v,254,w)),h=0,o=[]):v===31?(this.enableDebug&&(this.emit("debug",I+"<NAWS>"),I=""),w===253?(this.server.NAWS=!0,this.options.NAWS?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><NAWS>"),this.replyToOption(v,251,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(v,254,w))):w===254?(this.server.NAWS=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><NAWS>"),this.replyToOption(v,252,w)):w===251?(this.server.NAWS=!0,this.options.NAWS?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><NAWS>"),this.replyToOption(v,253,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(v,254,w))):w===252&&(this.server.NAWS=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(v,254,w)),this.emit("windowSize"),h=0,o=[]):v===36||v===39?(this.enableDebug&&(this.emit("debug",I+"<NEWENVIRON>"),I=""),w===253?(this.server.NEWENVIRON=!0,this.options.NEWENVIRON?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><NEWENVIRON>"),this.replyToOption(v,251,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(v,254,w))):w===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><NEWENVIRON>"),this.replyToOption(v,252,w)):w===251?(this.server.NEWENVIRON=!0,this.options.NEWENVIRON?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><NEWENVIRON>"),this.replyToOption(v,253,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(v,254,w))):w===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(v,254,w)),h=0,o=[]):v===69?(this.enableDebug&&(this.emit("debug",I+"<MSDP>"),I=""),w===253?(this.server.MSDP=!0,this.options.MSDP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSDP>"),this.replyToOption(v,251,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(v,254,w))):w===254?(this.server.MSDP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSDP>"),this.replyToOption(v,252,w)):w===251?(this.server.MSDP=!0,this.options.MSDP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSDP>"),this.replyToOption(v,253,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(v,254,w))):w===252&&(this.server.MSDP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(v,254,w)),h=0,o=[]):v===70?(this.enableDebug&&(this.emit("debug",I+"<MSSP>"),I=""),w===253?(this.server.MSSP=!0,this.options.MSSP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSSP>"),this.replyToOption(v,251,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(v,254,w))):w===254?(this.server.MSSP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSSP>"),this.replyToOption(v,252,w)):w===251?(this.server.MSSP=!0,this.options.MSSP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSSP>"),this.replyToOption(v,253,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(v,254,w))):w===252&&(this.server.MSSP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(v,254,w)),h=0,o=[]):v===85?(this.enableDebug&&(this.emit("debug",I+"<MCCP1>"),I=""),w===253?(this.server.MCCP1=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MCCP1>"),this.replyToOption(v,251,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(v,254,w))):w===254?(this.server.MCCP1=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MCCP1>"),this.replyToOption(v,252,w)):w===251?(this.server.MCCP1=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MCCP1>"),this.replyToOption(v,253,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(v,254,w))):w===252&&(this.server.MCCP1=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(v,254,w)),h=0,o=[]):v===86?(this.enableDebug&&(this.emit("debug",I+"<MCCP2>"),I=""),w===253?(this.server.MCCP2=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MCCP2>"),this.replyToOption(v,251,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(v,254,w))):w===254?(this.server.MCCP2=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MCCP2>"),this.replyToOption(v,252,w)):w===251?(this.server.MCCP2=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MCCP2>"),this.replyToOption(v,253,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(v,254,w))):w===252&&(this.server.MCCP2=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(v,254,w)),h=0,o=[]):v===91?(this.enableDebug&&(this.emit("debug",I+"<MXP>"),I=""),w===253?(this.server.MXP=!0,this.options.MXP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MXP>"),this.replyToOption(v,251,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(v,254,w))):w===254?(this.server.MXP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MXP>"),this.replyToOption(v,252,w)):w===251?(this.server.MXP=!0,this.options.MXP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MXP>"),this.replyToOption(v,253,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(v,254,w))):w===252&&(this.server.MXP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(v,254,w)),h=0,o=[]):v===130||v===241?(this.enableDebug&&(this.emit("debug",I+"<NOP>"),I=""),this._fireReceiveOption(v,w,""),o=[],h=0):v===201?(this.enableDebug&&(this.emit("debug",I+"<GMCP>"),I=""),w===253?(this.server.GMCP=!0,this.options.GMCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><GMCP>"),this.replyToOption(v,251,w),this._startGMCP()):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(v,254,w))):w===254?(this.server.GMCP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><GMCP>"),this.replyToOption(v,252,w)):w===251?(this.server.GMCP=!0,this.options.GMCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><GMCP>"),this.replyToOption(v,253,w),this._startGMCP()):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(v,254,w))):w===252&&(this.server.GMCP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(v,254,w)),h=0,o=[]):v===42?(this.enableDebug&&(this.emit("debug",I+"<CHARSET>"),I=""),w===253?(this.server.CHARSET=!0,this.options.CHARSET?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><CHARSET>"),this.replyToOption(v,251,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(v,254,w))):w===254?(this.server.CHARSET=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><CHARSET>"),this.replyToOption(v,252,w)):w===251?(this.server.CHARSET=!0,this.options.CHARSET?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><CHARSET>"),this.replyToOption(v,253,w)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(v,254,w))):w===252&&(this.server.CHARSET=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(v,254,w)),h=0,o=[]):(this.enableDebug&&(this.emit("debug",I+this._formatByte(v)),I=""),w===251||w===252?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><"+v+">"),this.replyToOption(v,254,w)):(w===254||w===253)&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><"+v+">"),this.replyToOption(v,252,w)),h=0,o=[]);break;case 3:p=v,v===24?(this.enableDebug&&(I+="<TERMINALTYPE>"),o.push(v),p=v,h=4):v===36||v===39?(this.enableDebug&&(I+="<NEWENVIRON>"),o.push(v),p=v,h=12,M=-1):v===69?(this.enableDebug&&(I+="<MSDP>"),o.push(v),p=v,h=4):v===70?(this.enableDebug&&(I+="<MSSP>"),o.push(v),p=v,h=8,b={}):v===85||v===86?(this.enableDebug&&(I+=v===85?"<MCCP1>":"<MCCP2>"),o.push(v),p=v,h=11):v===201?(this.enableDebug&&(I+="<GMCP>"),o.push(v),p=v,h=7):v===240?(this.enableDebug&&(this.emit("debug",I+"<SE>"),I=""),a=lt(o.slice(1,o.length-4)),this._fireReceiveOption(p,250,a),a=null,h=0,o=[]):v===42?(this.enableDebug&&(I+="<CHARSET>"),o.push(v),p=v,h=17,k=""):(this.enableDebug&&(I+=this._formatByte(v)),o.push(v));break;case 4:p===24&&v===1?(this.enableDebug&&(I+="<SEND>"),o.push(v),w=1):v===240?(this.enableDebug&&(this.emit("debug",I+"<SE>"),I=""),p===24&&w===1&&(a=!1,this._fireReceiveOption(p,250,""),a||(this.sendTerminal(),this.sendTerminal(),this._MTTS++)),h=0,o=[]):p===69&&v===1?(this.enableDebug&&(I+="<MSDP_VAR>"),o.push(v),E="",h=5):(this.enableDebug&&(I+=this._formatByte(v)),o.push(v));break;case 5:v===2?(this.enableDebug&&(I+="<MSDP_VAL>"),o.push(v),k="",h=6):(this.enableDebug&&(I+=this._formatByte(v)),E+=String.fromCharCode(v),o.push(v));break;case 6:v===255?(this.enableDebug&&(I+="<IAC>"),o.push(v)):v===1?(this.enableDebug&&(I+="<MSDP_VAR>"),this._fireReceiveMSDP(E,k),k="",E="",o.push(v),h=5):v===240?(this.enableDebug&&(this.emit("debug",I+"<SE>"),I=""),a=lt(o.slice(1,o.length-4)),this._fireReceiveOption(p,250,a),a=null,this._fireReceiveMSDP(E,k),k="",E="",h=0,o=[]):(this.enableDebug&&(I+=this._formatByte(v)),k+=String.fromCharCode(v),o.push(v));break;case 7:v===255?(this.enableDebug&&(I+="<IAC>"),o.push(v)):v===240?(this.enableDebug&&(this.emit("debug",I+"<SE>"),I=""),a=lt(o.slice(1,o.length-4)),this._fireReceiveOption(p,250,a),a=null,this._fireReceiveGMCP(k),h=0,k="",o=[]):(this.enableDebug&&(I+=this._formatByte(v)),k+=String.fromCharCode(v),o.push(v));break;case 8:v===255?(this.enableDebug&&(I+="<IAC>"),o.push(v)):v===240?(this.enableDebug&&(this.emit("debug",I+"<SE>"),this.emit("debug",this.MSSP),I=""),a=lt(o.slice(1,o.length-4)),this._fireReceiveOption(p,250,a),a=null,this.emit("receive-MSSP",b),k="",E="",b=0,h=0,o=[]):v===1?(this.enableDebug&&(I+="<MSSP_VAR>"),o.push(v),E="",h=9):(this.enableDebug&&(I+=this._formatByte(v)),o.push(v));break;case 9:v===255?(this.enableDebug&&(I+="<IAC>"),o.push(v),h=8):v===1?(this.enableDebug&&(I+="<MSSP_VAR>"),o.push(v),E=""):v===2?(this.enableDebug&&(I+="<MSSP_VAL>"),o.push(v),this.MSSP[E]="",b[E]="",h=10):(this.enableDebug&&(I+=this._formatByte(v)),E+=String.fromCharCode(v),o.push(v));break;case 10:v===255?(this.enableDebug&&(I+="<IAC>"),o.push(v),h=8):v===1?(this.enableDebug&&(I+="<MSSP_VAR>"),o.push(v),E="",h=9):v===2?(this.enableDebug&&(I+="<MSSP_VAL>"),o.push(v),this.MSSP[E]="",b[E]=""):(this.enableDebug&&(I+=this._formatByte(v)),this.MSSP[E]+=String.fromCharCode(v),b[E]+=String.fromCharCode(v),o.push(v));break;case 11:v===255?(this.enableDebug&&(I+="<IAC>"),o.push(v)):v===240&&(this.enableDebug&&(this.emit("debug",I+"<SE>"),I=""),this._fireReceiveOption(p,86,""),this._startMCCP(),h=0,o=[],B<r-1&&g.append(this.processData(t.subarray(B+1),e,!0)),B=r);break;case 12:v===255?(this.enableDebug&&(I+="<IAC>"),o.push(v)):v===240?(this.enableDebug&&(this.emit("debug",I+"<SE>"),I=""),a=lt(o.slice(1,o.length-4)),this._fireReceiveOption(p,250,a),a=null,this._fireReceiveGMCP(k),h=0,k="",o=[]):v===0?(this.enableDebug&&(I+="<IS>"),o.push(v),h=13,w=v):v===1?(this.enableDebug&&(I+="<SEND>"),o.push(v),h=13,w=v):v===2?(this.enableDebug&&(I+="<SEND>"),o.push(v),h=13,w=v):(this.enableDebug&&(I+=this._formatByte(v)),k+=String.fromCharCode(v),o.push(v));break;case 13:v===0?(this.enableDebug&&(I+="<VAR>"),o.push(v),h=14,w=v,E="",M===-1&&(M=0)):v===1?(this.enableDebug&&(I+="<VALUE>"),o.push(v),h=13,w=v,M===-1&&(M=1)):v===3?(this.enableDebug&&(I+="<USERVAR>"),o.push(v),h=13,w=v):v===255?(this.enableDebug&&(I+="<IAC>"),o.push(v)):v===240?(this.enableDebug&&(this.emit("debug",I+"<SE>"),I=""),a=lt(o.slice(1,o.length-4)),a=this._fireReceiveOption(p,250,a),this.emit("receive-NEWENVIRON",k),a||(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><NEWENVIRON><IS><IAC><SE>"),this.sendData(new Uint8Array([255,250]),!0),this.sendData(p,!0),this.sendData(new Uint8Array([0,255,240]),!0)),h=0,k="",o=[]):(this.enableDebug&&(I+=this._formatByte(v)),k+=String.fromCharCode(v),o.push(v));break;case 14:v===2?(this.enableDebug&&(I+=this._formatByte(v)),o.push(v),h=15,c=14):v===255||v<=3?(B--,h=13):(this.enableDebug&&(I+=this._formatByte(v)),E+=String.fromCharCode(v),o.push(v));break;case 15:this.enableDebug&&(I+=this._formatByte(v)),c===16?k+=String.fromCharCode(v):E+=String.fromCharCode(v),h=c,o.push(v);break;case 16:break;case 17:v===1?(this.enableDebug&&(I+="<REQUEST>"),o.push(v),h=18,k=""):v===255?(this.enableDebug&&(I+="<IAC>"),o.push(v)):v===240?(this.enableDebug&&(this.emit("debug",I+"<SE>"),I=""),a=this._fireReceiveOption(p,250,k),this.emit("receive-CHARSET",k),a||(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><CHARSET><REJECTED><IAC><SE>"),this.sendData(new Uint8Array([255,250,42,3,255,240]),!0)),h=0,k="",o=[]):(this.enableDebug&&(I+=this._formatByte(v)),k+=String.fromCharCode(v),o.push(v));break;case 18:v===255?(this.enableDebug&&(I+="<IAC>"),o.push(v)):v===240?(this.enableDebug&&(this.emit("debug",I+"<SE>"),I=""),a=this._fireReceiveOption(p,250,k),this.emit("receive-CHARSET",k.slice(1)),a||(this.options.CHARSET&&k.slice(1).toLowerCase()==="utf-8"?(this.server.CHARSET=!0,this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><ACCEPTED>UTF-8<IAC><SE>"),this.sendData(new Uint8Array([255,250,42,2]),!0),this.sendData("UTF-8",!0),this.sendData(new Uint8Array([255,240]),!0)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><CHARSET><REJECTED><IAC><SE>"),this.sendData(new Uint8Array([255,250,42,3,255,240]),!0))),h=0,k="",o=[]):(this.enableDebug&&(I+=this._formatByte(v)),k+=String.fromCharCode(v),o.push(v));break}}catch(_){this.emit("error",_)}return this.enableDebug&&(I.length>0&&this.emit("debug",I),this.emit("debug","Post Split buffer length: "+o.length,1),this.emit("debug","PostSplit buffer  "+je(new Uint8Array(o)),1)),f&&g.length>0?g.prepend(`
`):f&&(this.prompt=!0),g.length>0&&(this.firstReceived=!1),this._splitBuffer=o,s?g:this.UTF8||this.options.CHARSET&&this.server.CHARSET?UTF8.decode2(g.toString()):g.toString()}replyToOption(t,e,s,n){return typeof n>"u"&&(n=""),this._fireReceiveOption(t,s,n)?!1:(this.sendData(new Uint8Array([255,e,t]),!0),!0)}updateWindow(t,e){if(!(e<1||t<1||!this.connected||!this.server.NAWS))try{let s,n,r,a,o=Math.floor;s=o(t/256),s>256&&(s=255),n=t%256,r=o(e/256),r>256&&(r=255),a=e%256,this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><NAWS><"+s+"><"+n+"><"+r+"><"+a+"><IAC><SE>"),this.sendData(new Uint8Array([255,250,31,s,n,r,a,255,240]),!0)}catch(s){this.emit("error",{message:"UpdateWindow Error: "+s,err:s})}}sendGMCP(t){this.connected&&this.server.GMCP&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>"+this._escapeData(t).toString("binary")+"<IAC><SE>"),this.sendData(new Uint8Array([255,250,201]),!0),this.sendData(this._escapeData(t),!0),this.sendData(new Uint8Array([255,240]),!0))}_startGMCP(){this.server.GMCP&&(this.enableDebug&&this.emit("debug",'REPLY: <IAC><SB><GMCP>Core.Hello { "client": "'+this.terminal+'", "version": "'+this.version+'" }<IAC><SE>'),this.sendData(new Uint8Array([255,250,201]),!0),this.sendData('Core.Hello { "client": "'+this.terminal+'", "version": "'+this.version+'" }',!0),this.sendData(new Uint8Array([255,240]),!0),this.sendData(new Uint8Array([255,250,201]),!0),this.GMCPSupports.length>0?(this.GMCPSupports.indexOf("Core 1")===-1&&this.GMCPSupports.unshift("Core 1"),this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>"+JSON.stringify(this.GMCPSupports)+"<IAC><SE>"),this.sendData("Core.Supports.Set "+JSON.stringify(this.GMCPSupports))):(this.enableDebug&&this.emit("debug",'REPLY: <IAC><SB><GMCP>Core.Supports.Set [ "Core 1" ]<IAC><SE>'),this.sendData('Core.Supports.Set [ "Core 1" ]',!0)),this.sendData(new Uint8Array([255,240]),!0))}_startMCCP(){this._zlib=!0}_endMCCP(){this._zlib=!1,this.zStream=0}_decompressData(t){return this._zlib?(this.zStream||(this.zStream=new Ai.Zlib.InflateStream),this.enableDebug&&this.emit("debug","Pre decompress:"+je(t),1),t=this.zStream.decompress(t),this.enableDebug&&this.emit("debug","Post decompress:"+je(t),1),new Uint8Array(t)):t}_escapeData(t){if(t==null||typeof t>"u")return t;let e,s,n=0,r,a;if(t instanceof Uint8Array){for(e=t.byteLength,s=new We;n<e;n++)s.appendCode(t[n]),t[n]===255?s.appendCode(255):t[n]===13&&e===1?s.append(`\r
`):t[n]===10&&e===1&&s.append("\r\0");return s.toString()}for(e=t.length,s=new We;n<e;n++)a=t.charAt(n),r=t.charCodeAt(n),s.append(a),r===255?s.append(a):r===13&&e===1?s.append(`\r
`):r===10&&e===1&&s.append("\r\0");return s.toString()}_createSocket(t,e){let s;try{let n=/^[a-z0-9]+:\/\//.test(t);return n&&e>0?s=new WebSocket(t+":"+e,this.protocol||"binary"):n?s=new WebSocket(t,this.protocol||"binary"):t&&e>0?s=new WebSocket((this.scheme||"ws://")+t+":"+e,this.protocol||"binary"):t&&(s=new WebSocket((this.scheme||"ws://")+t,this.protocol||"binary")),s.binaryType="arraybuffer",s.onclose=r=>{r.code===1006&&r.type==="close"&&!this._closed?this.close():r.code!==1e3&&!this._closed&&(this.emit("error",{message:"Closed due to transmission error",err:r}),this.close())},s.onopen=()=>{this._connected=!0,this.emit("connect")},s.onmessage=r=>{if(r.data instanceof ArrayBuffer){var a=new Uint8Array(r.data);this.enableDebug&&this.emit("debug","Data ArrayBuffer received:"+je(a)),this.receivedData(a)}else if(r.data instanceof Blob){var o=new FileReader;o.onloadend=()=>{var h=new Uint8Array(o.result);this.receivedData(h),this.enableDebug&&this.emit("debug","Data Blob received:"+je(o.result))},o.readAsArrayBuffer(r.data)}else this.enableDebug&&this.emit("debug","Data received:"+r.data),this.receivedData(r.data)},s.onerror=r=>{this._closed||this.emit("error",r)},s}catch(n){this.emit("error",n)}return null}_destroySocket(){if(!(!this.socket||this.socket==null)){try{this.socket.onopen=function(){},this.socket.onclose=function(){},this.socket.onmessage=function(){},this.socket.onerror=function(){},this.connected&&this.socket.close(),delete this.socket}catch(t){this.emit("error",t)}this.socket=null}}_fireReceiveOption(t,e,s){let n={telnet:this,option:t,verb:250,value:s,handled:!1};return this.emit("received-option",n),n.handled}_fireReceiveMSDP(t,e){let s={telnet:this,variable:t,value:e,handled:!1};return this.emit("received-MSDP",s),s.handled}_fireReceiveGMCP(t){let e={telnet:this,value:t,handled:!1};return this.emit("received-GMCP",e),e.handled}_formatByte(t){return t<32||t>=127?"<"+t+">":String.fromCharCode(t)}};window.telnet=new xt;var dt=(f=>(f[f.None=0]="None",f[f.Bold=1]="Bold",f[f.Faint=2]="Faint",f[f.Underline=4]="Underline",f[f.Italic=3]="Italic",f[f.Slow=5]="Slow",f[f.Rapid=6]="Rapid",f[f.Inverse=7]="Inverse",f[f.Hidden=8]="Hidden",f[f.Strikeout=9]="Strikeout",f[f.DoubleUnderline=21]="DoubleUnderline",f[f.Overline=53]="Overline",f))(dt||{}),Et=(A=>(A[A.ErrorBackground=-12]="ErrorBackground",A[A.ErrorText=-11]="ErrorText",A[A.InfoBackground=-8]="InfoBackground",A[A.InfoText=-7]="InfoText",A[A.LocalEcho=-3]="LocalEcho",A[A.LocalEchoBack=-4]="LocalEchoBack",A[A.Reset=0]="Reset",A[A.Bold=1]="Bold",A[A.Faint=2]="Faint",A[A.Italic=3]="Italic",A[A.Underline=4]="Underline",A[A.Blink=5]="Blink",A[A.BlinkRapid=6]="BlinkRapid",A[A.Reverse=7]="Reverse",A[A.Hidden=8]="Hidden",A[A.StrikeThrough=9]="StrikeThrough",A[A.DoubleUnderline=21]="DoubleUnderline",A[A.BoldOff=22]="BoldOff",A[A.ItalicOff=23]="ItalicOff",A[A.UnderlineOff=24]="UnderlineOff",A[A.BlinkOff=25]="BlinkOff",A[A.BlinkRapidOff=26]="BlinkRapidOff",A[A.ReverseOff=27]="ReverseOff",A[A.Visible=28]="Visible",A[A.StrikeThroughOff=29]="StrikeThroughOff",A[A.Black=30]="Black",A[A.Red=31]="Red",A[A.Green=32]="Green",A[A.Yellow=33]="Yellow",A[A.Blue=34]="Blue",A[A.Magenta=35]="Magenta",A[A.Cyan=36]="Cyan",A[A.White=37]="White",A[A.DefaultFore=39]="DefaultFore",A[A.BlackBackground=40]="BlackBackground",A[A.RedBackground=41]="RedBackground",A[A.GreenBackground=42]="GreenBackground",A[A.YellowBackground=43]="YellowBackground",A[A.BlueBackground=44]="BlueBackground",A[A.MagentaBackground=45]="MagentaBackground",A[A.CyanBackground=46]="CyanBackground",A[A.WhiteBackground=47]="WhiteBackground",A[A.DefaultBack=49]="DefaultBack",A[A.Subscript=74]="Subscript",A[A.Superscript=73]="Superscript",A[A.SubSuperOff=75]="SubSuperOff",A[A.XBlack=90]="XBlack",A[A.XRed=91]="XRed",A[A.XGreen=92]="XGreen",A[A.XYellow=93]="XYellow",A[A.XBlue=94]="XBlue",A[A.XMagenta=95]="XMagenta",A[A.XCyan=96]="XCyan",A[A.XWhite=97]="XWhite",A[A.XBlackBackground=100]="XBlackBackground",A[A.XRedBackground=101]="XRedBackground",A[A.XGreenBackground=102]="XGreenBackground",A[A.XYellowBackground=103]="XYellowBackground",A[A.XBlueBackground=104]="XBlueBackground",A[A.XMagentaBackground=105]="XMagentaBackground",A[A.XCyanBackground=106]="XCyanBackground",A[A.XWhiteBackground=107]="XWhiteBackground",A))(Et||{});function de(m,u){switch(m.toLowerCase()){case"black":return u?40:30;case"red":return u?41:31;case"green":return u?42:32;case"yellow":return u?43:33;case"blue":return u?44:34;case"magenta":return u?45:35;case"cyan":return u?46:36;case"white":return u?47:37;case"default":return u?49:39}return-1}function mi(m){let u=-1,t=-1,e=!1;switch(m-1024>=0&&(m-=1024),m-512>=0&&(m-=512),m-256>=0&&(m-=256),m-128>=0&&(m-=128,e=!0),m-112>=0&&(m-=112,t=47),m-96>=0&&(m-=96,t=43),m-80>=0&&(m-=80,t=45),m-64>=0&&(m-=64,t=41),m-48>=0&&(m-=48,t=46),m-32>=0&&(m-=32,t=42),m-16>=0&&(m-=16,t=44),m>=8&&(m-=8,e=!0),m){case 0:u=30;break;case 1:u=34;break;case 2:u=32;break;case 3:u=36;break;case 4:u=31;break;case 5:u=35;break;case 6:u=33;break;case 7:u=37;break}return e&&u===-1?u=370:e&&(u*=10),u===-1?`,${t}`:t===-1?u.toString():`${u},${t}`}function Ce(m){return!m||m.length===0?!1:["indianred","lightcoral","salmon","darksalmon","lightsalmon","crimson","red","firebrick","darkred","pink","lightpink","hotpink","deeppink","mediumvioletred","palevioletred","lightsalmon","coral","tomato","orangered","darkorange","orange","gold","yellow","lightyellow","lemonchiffon","lightgoldenrodyellow","papayawhip","moccasin","peachpuff","palegoldenrod","khaki","darkkhaki","lavender","thistle","plum","violet","orchid","fuchsia","magenta","mediumorchid","mediumpurple","blueviolet","darkviolet","darkorchid","darkmagenta","purple","indigo","slateblue","darkslateblue","mediumslateblue","greenyellow","chartreuse","lawngreen","lime","limegreen","palegreen","lightgreen","mediumspringgreen","springgreen","mediumseagreen","seagreen","forestgreen","green","darkgreen","yellowgreen","olivedrab","olive","darkolivegreen","mediumaquamarine","darkseagreen","lightseagreen","darkcyan","teal","aqua","cyan","lightcyan","paleturquoise","aquamarine","turquoise","mediumturquoise","darkturquoise","cadetblue","steelblue","lightsteelblue","powderblue","lightblue","skyblue","lightskyblue","deepskyblue","dodgerblue","cornflowerblue","mediumslateblue","royalblue","blue","mediumblue","darkblue","navy","midnightblue","cornsilk","blanchedalmond","bisque","navajowhite","wheat","burlywood","tan","rosybrown","sandybrown","goldenrod","darkgoldenrod","peru","chocolate","saddlebrown","sienna","brown","maroon","white","snow","honeydew","mintcream","azure","aliceblue","ghostwhite","whitesmoke","seashell","beige","oldlace","floralwhite","ivory","antiquewhite","linen","lavenderblush","mistyrose","gainsboro","lightgrey","silver","darkgray","gray","dimgray","lightslategray","slategray","darkslategray","black"].indexOf(m.toLowerCase())!=-1}function qe(m,u){switch(m){case"errortextbackground":case"errorbackground":return-12;case"errortext":return u?-12:-11;case"infobackground":return-8;case"infotext":return u?-8:-7;case"localecho":return u?-4:-3;case"localechoback":return-4;case"reset":return 0;case"bold":return 1;case"faint":return 2;case"italic":return 3;case"underline":return 4;case"blink":return 5;case"blinkrapid":return 6;case"reverse":return 7;case"hidden":return 8;case"strikethrough":return 9;case"doubleunderline":return 21;case"boldoff":return 22;case"italicoff":return 23;case"underlineoff":return 24;case"blinkoff":return 25;case"blinkrapidoff":return 26;case"reverseoff":return 27;case"visible":return 28;case"strikethroughoff":return 29;case"black":return u?40:30;case"red":return u?41:31;case"green":return u?42:32;case"yellow":return u?43:33;case"blue":return u?44:34;case"magenta":return u?45:35;case"cyan":return u?46:36;case"white":return u?47:37;case"default":case"defaultfore":return u?49:39;case"blackbackground":return 40;case"redbackground":return 41;case"greenbackground":return 42;case"yellowbackground":return 43;case"bluebackground":return 44;case"magentabackground":return 45;case"cyanbackground":return 46;case"whitebackground":return 47;case"defaultbackground":case"defaultback":return 49;case"overline":return 53;case"subscript":return 74;case"superscript":return 73;case"subsuperoff":return 75;case"xblack":return u?100:90;case"xred":return u?101:91;case"xgreen":return u?102:92;case"xyellow":return u?103:93;case"xblue":return u?104:94;case"xmagenta":return u?105:95;case"xcyan":return u?106:96;case"xwhite":return u?107:97;case"xblackbackground":return 100;case"xredbackground":return 101;case"xgreenbackground":return 102;case"xyellowbackground":return 103;case"xbluebackground":return 104;case"xmagentabackground":return 105;case"xcyanbackground":return 106;case"xwhitebackground":return 107}return-1}var ft=class{constructor(u,t){this.width=0;this.height=0;this.width=u,this.height=t}};var ee=[["bufferSize",0,2,500],["commandDelay",0,2,500],["commandDelayCount",0,2,5],["commandHistorySize",0,2,20],["fontSize",0,0,"1em",0],["cmdfontSize",0,0,"1em",0],["commandEcho",0,1,!0],["flashing",0,1,!1],["autoConnect",0,1,!0],["enableAliases",-1,1,!0],["enableTriggers",-1,1,!0],["enableMacros",-1,1,!0],["showScriptErrors",0,1,!1],["commandStacking",0,1,!0],["commandStackingChar",0,0,";",1],["htmlLog",0,1,!0],["keepLastCommand",0,1,!0],["enableMCCP",0,1,!0],["enableUTF8",0,1,!0],["font",0,5,"'Courier New', Courier, monospace",0],["cmdfont",0,5,"'Courier New', Courier, monospace",0],["aliases",-1,4],["macros",-1,4],["triggers",-1,4],["mapFollow","mapper.follow",1,!0],["mapEnabled","mapper.enabled",1,!0],["MapperSplitArea","mapper.split",1,!1],["MapperFillWalls","mapper.fill",1,!1],["MapperOpen","showMapper",1,!1],["fullScreen",-1,3,!1],["enableMXP",0,1,!0],["enableMSP",0,1,!0],["parseCommands",0,3,!0],["lagMeter",0,1,!1],["enablePing",0,1,!1],["enableEcho",0,1,!0],["enableSpeedpaths",0,1,!0],["speedpathsChar",0,0,"!",1],["parseSpeedpaths",0,1,!0],["profile",-1,0,"Default",1],["parseSingleQuotes",0,1,!1],["parseDoubleQuotes",0,1,!0],["logEnabled",0,1,!1],["logPrepend",0,1,!1],["logOffline",0,1,!1],["logUniqueOnConnect",0,1,!0],["enableURLDetection",0,1,!0],["colors",0,4],["notifyMSPPlay",0,1,!1],["CommandonClick",0,1,!0],["allowEval",0,1,!0],["allowEscape",0,1,!0],["AutoCopySelectedToClipboard",0,1,!1],["enableDebug",0,1,!1],["editorPersistent",0,1,!1],["askonclose",0,1,!0],["dev",0,1,!1],["chat.captureLines",0,1,!1],["chat.captureAllLines",0,1,!1],["chat.captureReviews",0,1,!1],["chat.captureTells",0,1,!1],["chat.captureTalk",0,1,!1],["chat.gag",0,1,!1],["chat.CaptureOnlyOpen",0,1,!1],["checkForUpdates",0,1,!1],["autoCreateCharacter",0,1,!1],["askonchildren",0,1,!0],["mapper.legend",0,1,!1],["mapper.room",0,1,!1],["mapper.importType",0,2,1],["mapper.vscroll",0,2,0],["mapper.hscroll",0,2,0],["mapper.scale",0,2,100],["mapper.alwaysOnTop",0,1,!1],["mapper.alwaysOnTopClient",0,1,!0],["mapper.memory",0,1,!1],["mapper.memorySavePeriod",0,2,9e5],["mapper.active.ID",0,0,null],["mapper.active.x",0,2,0],["mapper.active.y",0,2,0],["mapper.active.z",0,2,0],["mapper.active.area",0,0,null],["mapper.active.zone",0,2,0],["mapper.persistent",0,1,!0],["profiles.split",0,2,200],["profiles.askoncancel",0,1,!0],["profiles.triggersAdvanced",0,1,!1],["profiles.aliasesAdvanced",0,1,!1],["profiles.buttonsAdvanced",0,1,!1],["profiles.macrosAdvanced",0,1,!1],["profiles.contextsAdvanced",0,1,!1],["profiles.codeEditor",0,1,!0],["profiles.watchFiles",0,1,!0],["chat.alwaysOnTop",0,1,!1],["chat.alwaysOnTopClient",0,1,!0],["chat.log",0,1,!1],["chat.persistent",0,1,!1],["chat.zoom",0,2,1],["chat.font",0,5,"'Courier New', Courier, monospace"],["chat.fontSize",0,0,"1em"],["title",0,0,"$t"],["logGagged",0,1,!1],["logTimeFormat",0,0,"YYYYMMDD-HHmmss"],["autoConnectDelay",0,2,600],["autoLogin",0,1,!0],["onDisconnect",0,2,2],["enableKeepAlive",0,1,!1],["keepAliveDelay",0,2,0],["newlineShortcut",0,2,1],["logWhat",0,2,1],["logErrors",0,1,!0],["showErrorsExtended",0,1,!1],["reportCrashes",0,1,!1],["enableCommands",0,1,!0],["commandChar",0,0,"#",1],["escapeChar",0,0,"\\",1],["enableVerbatim",0,1,!0],["verbatimChar",0,0,"`"],["soundPath",0,0,""],["logPath",0,0,""],["theme",0,0,""],["gamepads",0,1,!1],["buttons.connect",0,1,!0],["buttons.characters",0,1,!0],["buttons.preferences",0,1,!0],["buttons.log",0,1,!0],["buttons.clear",0,1,!0],["buttons.lock",0,1,!0],["buttons.map",0,1,!0],["buttons.user",0,1,!0],["buttons.mail",0,1,!1],["buttons.compose",0,1,!1],["buttons.immortal",0,1,!0],["buttons.codeEditor",0,1,!1],["find.case",0,1,!1],["find.word",0,1,!1],["find.reverse",0,1,!1],["find.regex",0,1,!1],["find.selection",0,1,!1],["find.show",0,1,!1],["display.split",0,1,!1],["display.splitHeight",0,2,-1],["display.splitLive",0,1,!0],["display.roundedOverlays",0,1,!0],["backupLoad",0,2,30],["backupSave",0,2,30],["backupAllProfiles",0,1,!0],["scrollLocked",0,1,!1],["showStatus",0,1,!0],["showCharacterManager",0,1,!1],["showChat",0,1,!1],["showEditor",0,1,!1],["showArmor",0,1,!1],["showStatusWeather",0,1,!0],["showStatusLimbs",0,1,!0],["showStatusHealth",0,1,!0],["showStatusExperience",0,1,!0],["showStatusPartyHealth",0,1,!0],["showStatusCombatHealth",0,1,!0],["showButtonBar",0,1,!0],["allowNegativeNumberNeeded",0,1,!1],["spellchecking",0,1,!0],["hideOnMinimize",0,1,!1],["showTrayIcon",0,1,!1],["statusExperienceNeededProgressbar",0,1,!1],["trayClick",0,2,0],["trayDblClick",0,2,0],["pasteSpecialPrefix",0,0,""],["pasteSpecialPostfix",0,0,""],["pasteSpecialReplace",0,0,""],["pasteSpecialPrefixEnabled",0,1,!0],["pasteSpecialPostfixEnabled",0,1,!0],["pasteSpecialReplaceEnabled",0,1,!0],["display.showSplitButton",0,1,!0],["chat.split",0,1,!1],["chat.splitHeight",0,2,-1],["chat.splitLive",0,1,!0],["chat.roundedOverlays",0,1,!0],["chat.showSplitButton",0,1,!0],["chat.bufferSize",0,2,500],["chat.flashing",0,1,!1],["display.hideTrailingEmptyLine",0,1,!0],["display.enableColors",0,1,!0],["display.enableBackgroundColors",0,1,!0],["enableSound",0,1,!0],["allowHalfOpen",0,1,!0],["editorClearOnSend",0,1,!0],["editorCloseOnSend",0,1,!0],["askOnCloseAll",0,1,!0],["askonloadCharacter",0,1,!0],["mapper.roomWidth",0,2,200],["mapper.roomGroups",0,2,7],["mapper.showInTaskBar",0,1,!1],["profiles.enabled",0,4,[]],["profiles.sortOrder",0,2,12],["profiles.sortDirection",0,2,1],["profiles.showInTaskBar",0,1,!1],["profiles.profileSelected",0,0,"default"],["profiles.profileExpandSelected",0,1,!0],["chat.lines",0,4,[]],["chat.showInTaskBar",0,1,!1],["chat.showTimestamp",0,1,!1],["chat.timestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["chat.tabWidth",0,2,8],["chat.displayControlCodes",0,1,!1],["chat.emulateTerminal",0,1,!1],["chat.emulateControlCodes",0,1,!0],["chat.wordWrap",0,1,!1],["chat.wrapAt",0,2,0],["chat.indent",0,2,4],["chat.scrollLocked",0,1,!1],["chat.find.case",0,1,!1],["chat.find.word",0,1,!1],["chat.find.reverse",0,1,!1],["chat.find.regex",0,1,!1],["chat.find.selection",0,1,!1],["chat.find.show",0,1,!1],["chat.find.highlight",0,1,!1],["chat.find.location",0,4,[5,20]],["codeEditor.showInTaskBar",0,1,!1],["codeEditor.persistent",0,1,!1],["codeEditor.alwaysOnTop",0,1,!1],["codeEditor.alwaysOnTopClient",0,1,!0],["autoTakeoverLogin",0,1,!1],["fixHiddenWindows",0,1,!0],["maxReconnectDelay",0,2,3600],["enableBackgroundThrottling",0,1,!0],["enableBackgroundThrottlingClients",0,1,!1],["showInTaskBar",0,1,!0],["showLagInTitle",0,1,!1],["mspMaxRetriesOnError",0,2,0],["logTimestamp",0,1,!1],["logTimestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["disableTriggerOnError",0,1,!0],["prependTriggeredLine",0,1,!0],["enableParameters",0,1,!0],["parametersChar",0,0,"%",1],["enableNParameters",0,1,!0],["nParametersChar",0,0,"$",1],["enableParsing",0,1,!0],["externalWho",0,1,!0],["externalHelp",0,1,!0],["watchForProfilesChanges",0,1,!1],["onProfileChange",0,2,0],["onProfileDeleted",0,2,0],["enableDoubleParameterEscaping",0,1,!1],["ignoreEvalUndefined",0,1,!0],["enableInlineComments",0,1,!0],["enableBlockComments",0,1,!0],["inlineCommentString",0,0,"//"],["blockCommentString",0,0,"/*"],["allowCommentsFromCommand",0,1,!1],["saveTriggerStateChanges",0,1,!0],["groupProfileSaves",0,1,!1],["groupProfileSaveDelay",0,2,2e4],["returnNewlineOnEmptyValue",0,1,!1],["pathDelay",0,2,0],["pathDelayCount",0,2,1],["echoSpeedpaths",0,1,!1],["alwaysShowTabs",0,1,!1],["scriptEngineType",0,2,4],["initializeScriptEngineOnLoad",0,1,!1],["find.highlight",0,1,!1],["find.location",0,4,[5,20]],["display.showInvalidMXPTags",0,1,!1],["display.showTimestamp",0,1,!1],["display.timestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["display.displayControlCodes",0,1,!1],["display.emulateTerminal",0,1,!1],["display.emulateControlCodes",0,1,!0],["display.wordWrap",0,1,!1],["display.tabWidth",0,2,8],["display.wrapAt",0,2,0],["display.indent",0,2,4],["statusWidth",0,2,-1],["showEditorInTaskBar",0,1,!0],["trayMenu",0,2,0],["lockLayout",0,1,!1],["loadLayout",0,0,""],["useSingleInstance",0,1,!0],["onSecondInstance",0,2,0],["characterManagerDblClick",0,2,0],["enableTabCompletion",1,!0],["ignoreCaseTabCompletion",0,1,!1],["tabCompletionBufferLimit",0,2,100],["enableNotifications",0,1,!0],["echo",0,2,0],["commandAutoSize",0,1,!1],["commandWordWrap",0,1,!1],["commandScrollbars",0,1,!1],["tabCompletionList",0,0,""],["tabCompletionLookupType",0,2,1],["tabCompletionReplaceCasing",0,2,0],["characterManagerAddButtonAction",0,2,0],["enableCrashReporting",0,1,!1],["characterManagerPanelWidth",0,2,0],["ignoreInputLeadingWhitespace",0,1,!1],["profiles.find.case",0,1,!1],["profiles.find.word",0,1,!1],["profiles.find.reverse",0,1,!1],["profiles.find.regex",0,1,!1],["profiles.find.selection",0,1,!1],["profiles.find.show",0,1,!1],["profiles.find.value",0,1,!1],["skipMore",0,1,!1],["skipMoreDelay",0,2,5e3],["commandMinLines",0,2,1],["backupReplaceCharacters",0,1,!0],["simpleAlarms",0,1,!1],["simpleEditor",0,1,!1],["selectLastCommand",0,1,!0]];var Fe=class m{constructor(){for(var u=0,t=ee.length;u<t;u++)ee[u][2]!==4&&(this[ee[u][0]]=m.getValue(ee[u][0]));this.colors=m.getValue("colors")}static{this.settingError=!1}static getValue(u,t){var e;if(m.settingError)return t===null||typeof t>"u"?m.defaultValue(u):t;try{if(e=$.jStorage.get(u),typeof e>"u"||e===null)return t===null||typeof t>"u"?m.defaultValue(u):t;switch(u){case"showChat":case"showStatus":case"showButtons":case"enableCommands":case"enableVerbatim":case"allowEscape":case"autoConnect":case"mapFollow":case"mapEnabled":case"flashing":case"commandEcho":case"enableAliases":case"enableTriggers":case"enableButtons":case"enableMacros":case"commandStacking":case"htmlLog":case"keepLastCommand":case"fullScreen":case"enableMXP":case"enableURLDetection":case"enableMCCP":case"enableUTF8":case"parseCommands":case"lagMeter":case"showScriptErrors":case"enablePing":case"enableEcho":case"enableSpeedpaths":case"parseSpeedpaths":case"mapper.enabled":case"MapperSplitArea":case"mapper.split":case"MapperFillWalls":case"mapper.fill":case"mapper.follow":case"MapperOpen":case"showMapper":case"parseSingleQuotes":case"parseDoubleQuotes":case"logEnabled":case"logOffline":case"logPrepend":case"logUniqueOnConnect":case"toolsPinned":case"notifyMSPPlay":case"CommandonClick":case"allowEval":case"disableTriggerOnError":case"prependTriggeredLine":case"chat.captureLines":case"chat.captureAllLines":case"chat.captureReviews":case"chat.captureTells":case"chat.captureTalk":case"chat.gag":case"chat.CaptureOnlyOpen":case"simpleAlarms":case"simpleEditor":case"selectLastCommand":return e==1;case"colors":case"chat.lines":return e===null||typeof e>"u"||e.length===0?[]:JSON.parse(e)}return e}catch(s){return m.settingError||(alert(`Unable to save to localStorage so reverting to default,

Error description: `+s.message),m.settingError=!0),t===null||typeof t>"u"?m.defaultValue(t):t}}static setValue(u,t){switch(u){case"colors":case"chat.lines":t===null||typeof t>"u"||t.length===0?$.jStorage.deleteKey(u):$.jStorage.set(u,JSON.stringify(t));break;default:typeof t=="boolean"?t?$.jStorage.set(u,1):$.jStorage.set(u,0):$.jStorage.set(u,t);break}}static clearValue(u){$.jStorage.deleteKey(u)}static defaultValue(u){switch(u){case"bufferSize":return 500;case"commandDelay":return 500;case"commandDelayCount":return 5;case"commandHistorySize":return 20;case"fontSize":return"1em";case"cmdfontSize":return"1em";case"commandEcho":return!0;case"flashing":return!1;case"autoConnect":return!0;case"enableAliases":return!0;case"enableTriggers":return!0;case"enableMacros":return!0;case"showScriptErrors":return!1;case"commandStacking":return!0;case"commandStackingChar":return";";case"htmlLog":return!0;case"keepLastCommand":return!0;case"enableMCCP":return!0;case"enableUTF8":return!0;case"font":return"'Courier New', Courier, monospace";case"cmdfont":return"'Courier New', Courier, monospace";case"mapFollow":case"mapper.follow":return!0;case"mapEnabled":case"mapper.enabled":return!0;case"MapperSplitArea":case"mapper.split":return!1;case"MapperFillWalls":case"mapper.fill":return!1;case"MapperOpen":case"showMapper":return!1;case"fullScreen":return!1;case"enableMXP":return!0;case"enableMSP":return!0;case"parseCommands":return!0;case"lagMeter":return!1;case"enablePing":return!1;case"enableEcho":return!0;case"enableSpeedpaths":return!0;case"speedpathsChar":return"!";case"parseSpeedpaths":return!0;case"profile":return"Default";case"parseSingleQuotes":return!1;case"parseDoubleQuotes":return!0;case"logEnabled":return!1;case"logPrepend":return!1;case"logOffline":return!1;case"logUniqueOnConnect":return!0;case"enableURLDetection":return!0;case"notifyMSPPlay":return!1;case"CommandonClick":return!0;case"allowEval":return!0;case"allowEscape":return!0;case"AutoCopySelectedToClipboard":return!1;case"enableDebug":return!1;case"editorPersistent":return!1;case"askonclose":return!0;case"dev":return!1;case"chat.captureLines":return!1;case"chat.captureAllLines":return!1;case"chat.captureReviews":return!1;case"chat.captureTells":return!1;case"chat.captureTalk":return!1;case"chat.gag":return!1;case"chat.CaptureOnlyOpen":return!1;case"checkForUpdates":return!1;case"autoCreateCharacter":return!1;case"askonchildren":return!0;case"mapper.legend":return!1;case"mapper.room":return!1;case"mapper.importType":return 1;case"mapper.vscroll":return 0;case"mapper.hscroll":return 0;case"mapper.scale":return 100;case"mapper.active":return{ID:null,x:0,y:0,z:0,area:null,zone:0};case"mapper.active.ID":return null;case"mapper.active.x":return 0;case"mapper.active.y":return 0;case"mapper.active.z":return 0;case"mapper.active.area":return null;case"mapper.active.zone":return 0;case"profiles.split":return 200;case"profiles.askoncancel":return!0;case"profiles.triggersAdvanced":return!1;case"profiles.aliasesAdvanced":return!1;case"profiles.buttonsAdvanced":return!1;case"profiles.macrosAdvanced":return!1;case"profiles.contextsAdvanced":return!1;case"profiles.codeEditor":return!0;case"chat.log":return!1;case"chat.zoom":return 1;case"chat.font":return"'Courier New', Courier, monospace";case"chat.fontSize":return"1em";case"title":return"$t";case"logGagged":return!1;case"logTimeFormat":return"YYYYMMDD-HHmmss";case"autoConnectDelay":return 600;case"autoLogin":return!0;case"onDisconnect":return 2;case"enableKeepAlive":return!1;case"keepAliveDelay":return 0;case"newlineShortcut":return 1;case"logWhat":return 1;case"logErrors":return!0;case"showErrorsExtended":return!1;case"reportCrashes":return!1;case"enableCommands":return!0;case"commandChar":return"#";case"escapeChar":return"\\";case"enableVerbatim":return!0;case"verbatimChar":return"`";case"soundPath":return"";case"logPath":return"";case"theme":return"";case"gamepads":return!1;case"backupLoad":return 30;case"backupSave":return 30;case"backupAllProfiles":return!0;case"backupReplaceCharacters":return!0;case"scrollLocked":return!1;case"showStatus":return!0;case"showChat":return!1;case"showEditor":return!1;case"showArmor":return!1;case"showStatusWeather":return!0;case"showStatusLimbs":return!0;case"showStatusHealth":return!0;case"showStatusExperience":return!0;case"showStatusPartyHealth":return!0;case"showStatusCombatHealth":return!0;case"allowNegativeNumberNeeded":return!1;case"spellchecking":return!0;case"statusExperienceNeededProgressbar":return!1;case"pasteSpecialPrefix":return"";case"pasteSpecialPostfix":return"";case"pasteSpecialReplace":return"";case"pasteSpecialPrefixEnabled":return!0;case"pasteSpecialPostfixEnabled":return!0;case"pasteSpecialReplaceEnabled":return!0;case"display.showSplitButton":return!0;case"chat.bufferSize":return 500;case"chat.flashing":return!1;case"display.hideTrailingEmptyLine":return!0;case"display.enableColors":return!0;case"display.enableBackgroundColors":return!0;case"enableSound":return!0;case"editorClearOnSend":return!0;case"editorCloseOnSend":return!0;case"askOnCloseAll":return!0;case"askonloadCharacter":return!0;case"mapper.roomWidth":return 200;case"mapper.roomGroups":return 7;case"mapper.showInTaskBar":return!1;case"profiles.enabled":return[];case"profiles.sortOrder":return 12;case"profiles.sortDirection":return 1;case"profiles.profileSelected":return"default";case"profiles.profileExpandSelected":return!0;case"chat.lines":return[];case"chat.showTimestamp":return!1;case"chat.timestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"chat.tabWidth":return 8;case"chat.displayControlCodes":return!1;case"chat.emulateTerminal":return!1;case"chat.emulateControlCodes":return!0;case"chat.wordWrap":return!1;case"chat.wrapAt":return 0;case"chat.indent":return 4;case"autoTakeoverLogin":return!1;case"maxReconnectDelay":return 3600;case"showLagInTitle":return!1;case"mspMaxRetriesOnError":return 0;case"logTimestamp":return!1;case"logTimestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"disableTriggerOnError":return!0;case"prependTriggeredLine":return!0;case"enableParameters":return!0;case"parametersChar":return"%";case"enableNParameters":return!0;case"nParametersChar":return"$";case"enableParsing":return!0;case"onProfileChange":return 0;case"onProfileDeleted":return 0;case"enableDoubleParameterEscaping":return!1;case"ignoreEvalUndefined":return!0;case"enableInlineComments":return!0;case"enableBlockComments":return!0;case"inlineCommentString":return"//";case"blockCommentString":return"/*";case"allowCommentsFromCommand":return!1;case"saveTriggerStateChanges":return!0;case"groupProfileSaves":return!1;case"groupProfileSaveDelay":return 2e4;case"returnNewlineOnEmptyValue":return!1;case"pathDelay":return 0;case"pathDelayCount":return 1;case"echoSpeedpaths":return!1;case"scriptEngineType":return 4;case"initializeScriptEngineOnLoad":return!1;case"display.showInvalidMXPTags":return!1;case"display.showTimestamp":return!1;case"display.timestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"display.displayControlCodes":return!1;case"display.emulateTerminal":return!1;case"display.emulateControlCodes":return!0;case"display.wordWrap":return!1;case"display.tabWidth":return 8;case"display.wrapAt":return 0;case"display.indent":return 4;case"statusWidth":return-1;case"extensions":return{};case"warnAdvancedSettings":return!0;case"showAdvancedSettings":return!1;case"enableTabCompletion":return!0;case"ignoreCaseTabCompletion":return!1;case"tabCompletionBufferLimit":return 100;case"enableNotifications":return!0;case"echo":return 0;case"commandAutoSize":return!1;case"commandWordWrap":return!1;case"commandMinLines":return 1;case"tabCompletionLookupType":return 1;case"tabCompletionList":return"";case"tabCompletionReplaceCasing":return 0;case"ignoreInputLeadingWhitespace":return!1;case"skipMore":return!1;case"skipMoreDelay":return 5e3;case"simpleAlarms":return!1;case"simpleEditor":return!1;case"selectLastCommand":return!0}return null}save(){for(var u in this)this.hasOwnProperty(u)&&m.setValue(u,this[u])}reset(){for(var u=0,t=ee.length;u<t;u++)ee[u][2]!==4&&(this[ee[u][0]]=m.defaultValue(ee[u][0]));this.colors=[]}};var Ct=(o=>(o[o.Regular=0]="Regular",o[o.CommandInputRegular=1]="CommandInputRegular",o[o.Event=2]="Event",o[o.Alarm=3]="Alarm",o[o.Pattern=8]="Pattern",o[o.CommandInputPattern=16]="CommandInputPattern",o[o.Expression=64]="Expression",o[o.LoopExpression=128]="LoopExpression",o))(Ct||{});var Tt=(h=>(h[h.Skip=512]="Skip",h[h.Wait=1024]="Wait",h[h.LoopPattern=4096]="LoopPattern",h[h.LoopLines=8192]="LoopLines",h[h.Duration=16384]="Duration",h[h.WithinLines=32768]="WithinLines",h[h.Manual=65536]="Manual",h[h.ReParse=131072]="ReParse",h[h.ReParsePattern=262144]="ReParsePattern",h))(Tt||{});function ot(m){let u=[];if(m.gamepad>0)return u.push("Gamepad "+m.gamepad),m.key>0?u.push("Button "+m.key):m.gamepadAxes<0?u.push("Axis "+-m.gamepadAxes):m.gamepadAxes>0&&u.push("Axis "+m.gamepadAxes),u.length===1?"None":u.join("+");if(m.key===0)return m.name&&m.name.length>0?"None - "+m.name:"None";if((m.modifiers&4)===4&&u.push("Ctrl"),(m.modifiers&2)===2&&u.push("Alt"),(m.modifiers&8)===8&&u.push("Shift"),(m.modifiers&16)===16&&u.push("Meta"),ut[m.key])u.push(ut[m.key]);else return m.name&&m.name.length>0?"None - "+m.name:"None";return m.name&&m.name.length>0?u.join("+")+" - "+m.name:u.join("+")}var Be=class m{constructor(u,t){this.temp=!1;this.start=!1;this.seconds=-1;this.secondsWildcard=!0;this.hours=-1;this.hoursWildcard=!0;this.minutes=-1;this.minutesWildcard=!0;this.suspended=0;this.restart=0;typeof u=="string"&&(t=u,u=0),this.parent=u,this.pattern=t,this.startTime=Date.now(),this.prevTime=this.startTime}static parse(u,t,e){if(typeof u=="string"&&(t=u,u=0),!t||t.length===0)if(typeof u=="object")t=u.pattern;else throw new Error("Blank pattern");let s=new m(u,t);for(;t[0]==="-"||t[0]==="+";)t[0]==="-"?s.start=!0:t[0]==="+"&&(s.temp=!0),t=t.substr(1);if(t!=="*"){let n=t.split(":"),r;if(n.length===0)throw new Error("Invalid format: "+t);if(n.length===1)if(n[0]==="*")s.secondsWildcard=!0,s.seconds=-1;else{if(n[0][0]==="*"?(s.secondsWildcard=!0,n[0]=n[0].substr(1)):s.secondsWildcard=!1,r=parseInt(n[0],10),isNaN(r))throw new Error("Invalid Format: "+n[0]);if(r<0)throw new Error("Seconds must be greater than or equal to 0.");r>59&&(s.secondsWildcard=!0),s.seconds=r}else if(n.length===2){if(n[0]==="*")s.minutesWildcard=!0,s.minutes=-1;else{if(n[0][0]==="*"?(s.minutesWildcard=!0,n[0]=n[0].substr(1)):s.minutesWildcard=!1,r=parseInt(n[0],10),isNaN(r))throw new Error("Invalid Format: "+n[0]);if(r<0||r>59)throw new Error("Minutes can only be 0 to 59");s.minutes=r}if(n[1]==="*")s.secondsWildcard=!0,s.seconds=-1;else{if(n[1][0]==="*"?(s.secondsWildcard=!0,n[1]=n[1].substr(1)):s.secondsWildcard=!1,r=parseInt(n[1],10),isNaN(r))throw new Error("Invalid Format: "+n[1]);if(r<0||r>59)throw new Error("Seconds can only be 0 to 59");s.seconds=r}}else{if(n[0]==="*")s.hoursWildcard=!0,s.hours=-1;else{if(n[0][0]==="*"?(s.hoursWildcard=!0,n[0]=n[0].substr(1)):s.hoursWildcard=!1,r=parseInt(n[0],10),isNaN(r))throw new Error("Invalid Format: "+n[0]);if(r<0||r>23)throw new Error("Hours can only be 0 to 23");s.hours=r}if(n[1]==="*")s.minutesWildcard=!0,s.seconds=-1;else{if(n[1][0]==="*"?(s.minutesWildcard=!0,n[1]=n[1].substr(1)):s.minutesWildcard=!1,r=parseInt(n[1],10),isNaN(r))throw new Error("Invalid Format: "+n[1]);if(r<0||r>59)throw new Error("Minutes can only be 0 to 59");s.minutes=r}if(n[2]==="*")s.secondsWildcard=!0,s.seconds=-1;else{if(n[2][0]==="*"?(s.secondsWildcard=!0,n[2]=n[2].substr(2)):s.secondsWildcard=!1,r=parseInt(n[2],10),isNaN(r))throw new Error("Invalid Format: "+n[2]);if(r<0||r>59)throw new Error("Seconds can only be 0 to 59");s.seconds=r}}}return e&&(s.temp=!1),s}setTempTime(u){u?this.tempTime=Date.now()+u:this.tempTime=0}},Ze=class m{constructor(u,t){this.name="";this.priority=0;this.display="name";this.displaytype=0;this.value="";this.style=1;this.group="";this.enabled=!0;this.notes="";if(typeof u=="object"){let e;for(e in u)u.hasOwnProperty(e)&&(this[e]=u[e])}this.profile=t}clone(){return new m(this)}},me=class m extends Ze{constructor(t,e){super(t);this.caption="";this.icon="";this.append=!1;this.send=!0;this.chain=!1;this.stretch=!1;this.parse=!1;this.top=-1;this.left=-1;this.right=-1;this.bottom=-1;this.width=64;this.height=64;this.iconOnly=!1;if(this.caption="NewButton",this.display="caption",typeof t=="object"){let s;for(s in t)t.hasOwnProperty(s)&&(this[s]=t[s])}this.profile=e}clone(){return new m(this)}},at=class m extends Ze{constructor(t,e){super();this.key=0;this.append=!1;this.send=!0;this.modifiers=0;this.chain=!1;this.gamepad=0;this.gamepadAxes=0;if(this.display="return MacroDisplay(item)",this.displaytype=1,typeof t=="object"){let s;for(s in t)t.hasOwnProperty(s)&&(this[s]=t[s])}this.profile=e}clone(){return new m(this)}},Je=class m extends Ze{constructor(t,e,s){super();this.pattern="NewAlias";this.regexp=!1;this.multi=!1;this.append=!0;this.params="";if(typeof t=="string"&&(this.pattern=t),e!=null&&(this.value=e),this.display="pattern",typeof t=="object"){let n;for(n in t)t.hasOwnProperty(n)&&(this[n]=t[n])}this.profile=s}clone(){return new m(this)}},Ie=class m extends Ze{constructor(t,e){super(t);this.pattern="NewTrigger";this.verbatim=!1;this.triggerNewline=!0;this.triggerPrompt=!1;this.type=0;this.temp=!1;this.caseSensitive=!1;this.raw=!1;this.state=0;this.params="";this.triggers=[];this.fired=!1;if(this.display="pattern",typeof t=="object"){let s;for(s in t)if(t.hasOwnProperty(s))if(s==="triggers"){this.triggers=[];let n=t.triggers.length;for(let r=0;r<n;r++)this.triggers.push(new m(t.triggers[r]))}else this[s]=t[s]}this.profile=e}clone(){return new m(this)}getState(t){return t===0?this:(t--,t>=this.triggers.length||t<0?null:this.triggers[t])}},gt=class m extends Ze{constructor(t,e){super(t);this.caption="";this.icon="";this.append=!1;this.send=!0;this.chain=!1;this.parent="";this.items=[];this.parse=!1;if(this.caption="NewContext",this.display="caption",typeof t=="object"){let s;for(s in t)if(t.hasOwnProperty(s))if(s==="items"){let n=0,r=t[s].length;for(;n<r;n++)this.items.push(new m(t[s][n]))}else this[s]=t[s]}this.profile=e}clone(){return new m(this)}},At=class m extends Ze{constructor(t,e){super(t);this._type="string";this.type=1;this.defaultValue="";this.useDefault=!1;this.params="";this.profile=e,this.useDefault&&this.setValue(this.defaultValue)}set setValue(t){switch(this.type){case 2:typeof t=="string"?(t=parseInt(t,10),isNaN(t)&&(t=0)):typeof t=="boolean"&&(t=t?1:0);break;case 7:typeof t=="string"?(t=parseFloat(t),isNaN(t)&&(t=0)):typeof t=="boolean"&&(t=t?1:0);break}this.value=t,this._type=typeof t}get getValue(){switch(this.type){case 1:if(typeof this.value!==this._type)switch(this._type){case"number":return Number(this.value);case"string":return this.value.toString();case"boolean":return!!this.value}return this.value;case 7:return parseFloat(this.value);case 2:return parseInt(this.value,10);case 6:if(typeof this.value=="string")try{return JSON.parse(this.value)}catch{return this.value}return this.value;case 5:return typeof this.value=="string"?Dt(this.value,"|"):this.value}return this.value}clone(){return new m(this)}toString(){switch(this.type){case 6:return typeof this.value=="string"?this.value:JSON.stringify(this.value);case 5:return typeof this.value=="string"?this.value:'"'+this.value.join('"|"')+'"'}return this.value?.toString()}},Le=class m{constructor(u,t){this.name="";this.file="";this.priority=0;this.enabled=!0;this.aliases=[];this.triggers=[];this.macros=[];this.buttons=[];this.contexts=[];this.enableMacros=!0;this.enableTriggers=!0;this.enableAliases=!0;this.enableButtons=!0;this.enableContexts=!0;this.enableDefaultContext=!0;typeof u=="string"?(this.name=u,this.file=u.toLowerCase(),(t==null||t)&&(this.macros=m.DefaultMacros)):typeof u=="boolean"?u&&(this.macros=m.DefaultMacros):(t==null||t)&&(this.macros=m.DefaultMacros)}static get Default(){return new m("Default")}static get DefaultMacros(){let u=[{key:97,display:"return MacroDisplay(item)",displaytype:1,value:"sw",style:1,append:!1,send:!0,name:"SouthWest",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:98,display:"return MacroDisplay(item)",displaytype:1,value:"s",style:1,append:!1,send:!0,name:"South",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:99,display:"return MacroDisplay(item)",displaytype:1,value:"se",style:1,append:!1,send:!0,name:"SouthEast",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:100,display:"return MacroDisplay(item)",displaytype:1,value:"w",style:1,append:!1,send:!0,name:"West",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:101,display:"return MacroDisplay(item)",displaytype:1,value:"l",style:1,append:!1,send:!0,name:"Look",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:102,display:"return MacroDisplay(item)",displaytype:1,value:"e",style:1,append:!1,send:!0,name:"East",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:103,display:"return MacroDisplay(item)",displaytype:1,value:"nw",style:1,append:!1,send:!0,name:"NorthWest",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:104,display:"return MacroDisplay(item)",displaytype:1,value:"n",style:1,append:!1,send:!0,name:"North",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:105,display:"return MacroDisplay(item)",displaytype:1,value:"ne",style:1,append:!1,send:!0,name:"NorthEast",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""}],t=[],e=u.length;for(let s=0;s<e;s++)t.push(new at(u[s]));return t}static get DefaultButtons(){let u=[],t;return t=new me,t.right=176,t.top=14,t.caption="fa-solid fa-angle-double-up",t.value="up",t.width=48,t.height=48,u.push(t),t=new me,t.right=124,t.top=14,t.caption="fa-solid fa-caret-up,rotate--45",t.value="northwest",t.width=48,t.height=48,u.push(t),t=new me,t.right=72,t.top=14,t.caption="fa-solid fa-caret-up",t.value="north",t.width=48,t.height=48,u.push(t),t=new me,t.right=20,t.top=14,t.caption="fa-solid fa-caret-up,rotate-45",t.value="northeast",t.width=48,t.height=48,u.push(t),t=new me,t.right=176,t.top=66,t.caption="fa-solid fa-crosshairs",t.value="kill ${selected}",t.width=48,t.height=48,u.push(t),t=new me,t.right=124,t.top=66,t.caption="fa-solid fa-caret-left",t.value="west",t.width=48,t.height=48,u.push(t),t=new me,t.right=72,t.top=66,t.caption="fa-solid fa-magnifying-glass",t.value="look ${selected}",t.width=48,t.height=48,u.push(t),t=new me,t.right=20,t.top=66,t.caption="fa-solid fa-caret-right",t.value="east",t.width=48,t.height=48,u.push(t),t=new me,t.right=176,t.top=118,t.caption="fa-solid fa-angle-double-down",t.value="down",t.width=48,t.height=48,u.push(t),t=new me,t.right=124,t.top=118,t.caption="fa-solid fa-caret-down,rotate-45",t.value="southwest",t.width=48,t.height=48,u.push(t),t=new me,t.right=72,t.top=118,t.caption="fa-solid fa-caret-down",t.value="south",t.width=48,t.height=48,u.push(t),t=new me,t.right=20,t.top=118,t.caption="fa-solid fa-caret-down,rotate--45",t.value="southeast",t.width=48,t.height=48,u.push(t),u}static load(u){let t,e;if(typeof u=="object")e=u;else return new m;t=new m(!1);let s;for(s in e)e.hasOwnProperty(s)&&(s==="aliases"||s==="triggers"||s==="macros"||s==="buttons"||s==="contexts"||s==="variables"||(t[s]=e[s]));let n,r;if(e.aliases&&e.aliases.length>0)for(r=e.aliases.length,n=0;n<r;n++)t.aliases.push(new Je(e.aliases[n],null,t));if(e.triggers&&e.triggers.length>0)for(r=e.triggers.length,n=0;n<r;n++)t.triggers.push(new Ie(e.triggers[n],t));if(e.macros&&e.macros.length>0)for(r=e.macros.length,t.macros=[],n=0;n<r;n++)t.macros.push(new at(e.macros[n],t));if(e.buttons&&e.buttons.length>0)for(r=e.buttons.length,n=0;n<r;n++)t.buttons.push(new me(e.buttons[n],t));if(e.contexts&&e.contexts.length>0)for(r=e.contexts.length,n=0;n<r;n++)t.contexts.push(new gt(e.contexts[n],t));return t.file=t.name,t}clone(u){let t,e,s;if(u===2){if(t={name:this.name,priority:this.priority,enabled:this.enabled,aliases:[],triggers:[],macros:[],buttons:[],contexts:[],enableMacros:this.enableMacros,enableTriggers:this.enableTriggers,enableAliases:this.enableAliases,enableButtons:this.enableButtons,enableContexts:this.enableContexts,enableDefaultContext:this.enableDefaultContext},this.aliases.length>0)for(s=this.aliases.length,e=0;e<s;e++)t.aliases.push({pattern:this.aliases[e].pattern,value:this.aliases[e].value,priority:this.aliases[e].priority,regexp:this.aliases[e].regexp,style:this.aliases[e].style,multi:this.aliases[e].multi,append:this.aliases[e].append,name:this.aliases[e].name,group:this.aliases[e].group,enabled:this.aliases[e].enabled,params:this.aliases[e].params,display:this.aliases[e].display,notes:this.aliases[e].notes||""});if(this.triggers.length>0)for(s=this.triggers.length,e=0;e<s;e++){let a={pattern:this.triggers[e].pattern,value:this.triggers[e].value,priority:this.triggers[e].priority,verbatim:this.triggers[e].verbatim,style:this.triggers[e].style,name:this.triggers[e].name,group:this.triggers[e].group,enabled:this.triggers[e].enabled,display:this.triggers[e].display,triggernewline:this.triggers[e].triggerNewline,caseSensitive:this.triggers[e].caseSensitive,triggerprompt:this.triggers[e].triggerPrompt,raw:this.triggers[e].raw,type:this.triggers[e].type,notes:this.triggers[e].notes||"",state:this.triggers[e].state||0,params:this.triggers[e].params||"",triggers:[]};if(this.triggers[e].triggers&&this.triggers[e].triggers.length){let o=this.triggers[e].triggers.length;for(let h=0;h<o;h++)a.triggers.push({pattern:this.triggers[e].triggers[h].pattern,value:this.triggers[e].triggers[h].value,priority:this.triggers[e].triggers[h].priority,verbatim:this.triggers[e].triggers[h].verbatim,style:this.triggers[e].triggers[h].style,name:this.triggers[e].triggers[h].name,group:this.triggers[e].triggers[h].group,enabled:this.triggers[e].triggers[h].enabled,display:this.triggers[e].triggers[h].display,triggernewline:this.triggers[e].triggers[h].triggerNewline,caseSensitive:this.triggers[e].triggers[h].caseSensitive,triggerprompt:this.triggers[e].triggers[h].triggerPrompt,raw:this.triggers[e].triggers[h].raw,type:this.triggers[e].triggers[h].type,notes:this.triggers[e].triggers[h].notes||"",state:this.triggers[e].triggers[h].state||0,params:this.triggers[e].triggers[h].params||"",triggers:[]})}t.triggers.push(a)}if(this.macros.length>0)for(s=this.macros.length,e=0;e<s;e++)t.macros.push({key:this.macros[e].key,value:this.macros[e].value,style:this.macros[e].style,append:this.macros[e].append,send:this.macros[e].send,name:this.macros[e].name,group:this.macros[e].group,enabled:this.macros[e].enabled,display:'if(item.key === 0) return "None"; return keyCodeToChar[item.key]',displaytype:1,modifiers:this.macros[e].modifiers,chain:this.macros[e].chain,notes:this.macros[e].notes||""});if(this.buttons.length>0)for(s=this.buttons.length,e=0;e<s;e++)t.buttons.push($e(this.buttons[e],(a,o)=>{if(a!=="profile")return o}));if(this.contexts.length>0)for(s=this.contexts.length,e=0;e<s;e++)t.contexts.push($e(this.contexts[e],(a,o)=>{if(a!=="profile")return o}));return t}t=$e(this,(a,o)=>{if(a!=="profile")return o});let n=new m(!1),r;for(r in t)t.hasOwnProperty(r)&&(r==="aliases"||r==="triggers"||r==="macros"||r==="buttons"||r==="contexts"||r==="variables"||(n[r]=t[r]));if(t.aliases&&t.aliases.length>0)for(s=t.aliases.length,e=0;e<s;e++)n.aliases.push(new Je(t.aliases[e],null,n));if(t.triggers&&t.triggers.length>0)for(s=t.triggers.length,e=0;e<s;e++)n.triggers.push(new Ie(t.triggers[e],n));if(t.macros&&t.macros.length>0)for(s=t.macros.length,n.macros=[],e=0;e<s;e++)n.macros.push(new at(t.macros[e],n));if(t.buttons&&t.buttons.length>0)for(s=t.buttons.length,e=0;e<s;e++)n.buttons.push(new me(t.buttons[e],n));if(t.contexts&&t.contexts.length>0)for(s=t.contexts.length,e=0;e<s;e++)n.contexts.push(new gt(t.contexts[e],n));return n}find(u,t,e){let s;if(!u||u.length===0||!this[u]||this[u].length===0)return null;s=te(this[u]);let n=s.length;for(let r=0;r<n;r++)if(s[r][t]===e)return s[r];return null}findAny(u,t,e){let s;if(!u||u.length===0||!this[u]||this[u].length===0)return null;s=te(this[u]);let n=s.length;if(typeof t=="object"){for(let r=0;r<n;r++)for(let a in t)if(t.hasOwnProperty(a)&&s[r][a]===t[a])return s[r];return-1}for(let r=0;r<n;r++)if(s[r][t]===e)return s[r];return null}indexOfAny(u,t,e){let s;if(!u||u.length===0||!this[u]||this[u].length===0)return null;s=te(this[u]);let n=s.length;if(typeof t=="object"){for(let r=0;r<n;r++)for(let a in t)if(t.hasOwnProperty(a)&&s[r][a]===t[a])return this[u].indexOf(s[r]);return-1}for(let r=0;r<n;r++)if(s[r][t]===e)return this[u].indexOf(s[r]);return-1}indexOf(u,t,e){let s;if(!u||u.length===0||!this[u]||this[u].length===0)return null;s=te(this[u]);let n=s.length;if(typeof t=="object"){for(let r=0;r<n;r++){for(let a in t)t.hasOwnProperty(a)&&(s[r][a],t[a]);return this[u].indexOf(s[r])}return-1}for(let r=0;r<n;r++)if(s[r][t]===e)return this[u].indexOf(s[r]);return-1}},Nt=class m{constructor(u){this.items={};this.keys=[];this.add(u??Le.Default)}SortByPriority(){this.keys.sort((u,t)=>{let e=this.items[u].priority,s=this.items[t].priority;return e>s?-1:e<s?1:u==="default"?-1:t==="default"||(e=this.items[u].name,s=this.items[t].name,e>s)?1:e<s?-1:0})}enabled(u){return!u||this.keys.length===0?!1:typeof u=="string"?this.items[u.toLowerCase()]?this.items[u.toLowerCase()].enabled:!1:this.items[u.name.toLowerCase()]?this.items[u.name.toLowerCase()].enabled:!1}contains(u){return!u||this.keys.length===0?!1:typeof u=="string"?!!this.items[u.toLowerCase()]:!!this.items[u.name.toLowerCase()]}canDisable(u){if(!u||this.keys.length===0)return!1;let t;if(typeof u=="number"){if(u<0||u>=this.keys.length)return!1;t=this.keys[u]}else if(typeof u=="object")t=u.name.toLowerCase();else if(typeof u=="string")t=u.toLowerCase();else return!1;if(!this.items[t])return!1;if(!!this.items[t].enabled){let s=!1;for(let n in this.items)if(n!==t){this.items[n].enabled&&(s=!0);break}if(!s)return!1}return!0}toggle(u){if(!u||this.keys.length===0)return!1;let t;if(typeof u=="number"){if(u<0||u>=this.keys.length)return!1;t=this.keys[u]}else if(typeof u=="object")t=u.name.toLowerCase();else if(typeof u=="string")t=u.toLowerCase();else return!1;if(!this.items[t])return!1;let e=!this.items[t].enabled;if(!e){let s=!1;for(let n in this.items)if(n!==t){this.items[n].enabled&&(s=!0);break}if(!s)return!1}return this.items[t].enabled=e,!0}update(){this.keys=Object.keys(this.items),this.SortByPriority()}add(u){u&&(this.items[u.name.toLowerCase()]=u,this.update())}remove(u){if(!(!u||this.keys.length===0)){if(typeof u=="string")delete this.items[u.toLowerCase()];else if(typeof u=="number"){if(u<0||u>=this.keys.length)return;delete this.items[this.keys[u]]}else delete this.items[u.name.toLowerCase()];this.update()}}copy(u){return u?this.keys.length===0?null:typeof u=="string"?this.items[u.toLowerCase()]?this.items[u.toLowerCase()].clone():null:typeof u=="number"?u<0||u>=this.keys.length?null:this.items[this.keys[u]].clone():u.clone():$e(this.items)}clone(u){if(u===2){let e={};for(let s in this.items)e[this.items[s].name.toLowerCase()]=this.items[s].clone(2);return e}let t=new m;for(let e in this.items)t.items[this.items[e].name.toLowerCase()]=this.items[e].clone();return t.update(),t}static load(u){return new Promise((t,e)=>{let s=new m;localforage.getItem(u||"OoMUDProfiles").then(n=>{if(typeof n=="string"&&(n=JSON.parse(n)),!n)s.add(Le.Default);else{let r=Object.keys(n),a=0,o=r.length;for(;a<o;a++)s.add(Le.load(n[r[a]]))}t(s)}).catch(e)})}save(u){return localforage.setItem(u||"OoMUDProfiles",JSON.parse(JSON.stringify(this.items,(t,e)=>{if(t!=="profile")return e})))}get length(){return this.keys.length}count(){return this.keys.length}get active(){let u=this.keys;if(u.length===0)return this.add(Le.Default),this.items.default;if(u.length===1)return this.items[u[0]].enabled?this.items[u[0]]:this.items[u[0]].name==="Default"?(this.items[u[0]].enable=!0,this.items.default):(this.add(Le.Default),this.items.default);for(let t in u)if(this.items[t].enabled)return this.items[t];return this.items.default?(this.items.default.enabled=!0,this.items.default):(this.add(Le.Default),this.items.default)}get aliases(){let u=this.keys,t=[],e=0,s=u.length;if(s===0)return[];if(s===1)return!this.items[u[0]].enabled||!this.items[u[0]].enableAliases?[]:this.items[u[0]].aliases;for(;e<s;e++)!this.items[u[e]].enabled||!this.items[u[e]].enableAliases||this.items[u[e]].aliases.length===0||(t=t.concat(this.items[u[e]].aliases));return t}get triggers(){let u=this.keys,t=[],e=0,s=u.length;if(s===0)return[];if(s===1)return!this.items[u[0]].enabled||!this.items[u[0]].enableTriggers?[]:this.items[u[0]].triggers;for(;e<s;e++)!this.items[u[e]].enabled||!this.items[u[e]].enableTriggers||this.items[u[e]].triggers.length===0||(t=t.concat(this.items[u[e]].triggers));return t}get macros(){let u=this.keys,t=[],e=0,s=u.length;if(s===0)return[];if(s===1)return!this.items[u[0]].enabled||!this.items[u[0]].enableMacros?[]:this.items[u[0]].macros;for(;e<s;e++)!this.items[u[e]].enabled||!this.items[u[e]].enableMacros||this.items[u[e]].macros.length===0||(t=t.concat(this.items[u[e]].macros));return t}get buttons(){let u=this.keys,t=[],e=0,s=u.length;if(s===0)return[];if(s===1)return!this.items[u[0]].enabled||!this.items[u[0]].enableButtons?[]:this.items[u[0]].buttons;for(;e<s;e++)!this.items[u[e]].enabled||!this.items[u[e]].enableButtons||this.items[u[e]].buttons.length===0||(t=t.concat(this.items[u[e]].buttons));return t}get contexts(){let u=this.keys,t=[],e=0,s=u.length;if(s===0)return[];if(s===1)return!this.items[u[0]].enabled||!this.items[u[0]].enableContexts?[]:this.items[u[0]].contexts;for(;e<s;e++)!this.items[u[e]].enabled||!this.items[u[e]].enableContexts||this.items[u[e]].contexts.length===0||(t=t.concat(this.items[u[e]].contexts));return t}get defaultContext(){let u=this.keys,t=0,e=u.length;if(e===0)return!0;if(e===1)return this.items[u[0]].enabled?this.items[u[0]].enableDefaultContext:!0;for(;t<e;t++)if(this.items[u[t]].enabled&&!this.items[u[t]].enableDefaultContext)return!1;return!0}};function mt(m,u){if(!m||!m.length)return"";let t;(C=>(C[C.None=0]="None",C[C.Ampersand=1]="Ampersand",C[C.Percent=2]="Percent",C[C.StringMatch=3]="StringMatch",C[C.SubPattern=4]="SubPattern",C[C.AmpersandPercent=5]="AmpersandPercent",C[C.AmpersandPattern=6]="AmpersandPattern",C[C.AmpersandRange=7]="AmpersandRange",C[C.PercentRegex=8]="PercentRegex",C[C.Escape=9]="Escape",C[C.Variable=10]="Variable"))(t||={});let e=0,s=[],n=0,r=m.length,a,o,h,c,g=0;for(n=0;n<r;n++)switch(a=m.charAt(n),o=m.charCodeAt(n),e){case 1:if(h.length===0&&(a==="*"||a==="?"||a==="^"||a==="$"))c=a;else if(h.length===0&&a==="%")e=5;else if(c.length===0&&a==="(")c=a,e=6;else if(c.length===0&&a==="[")c=a,e=7;else{if(a==="{")continue;if(a==="}"||!(o>=48&&o<=57||o>=65&&o<=90||o>=97&&o<=122||o===95||o===36)){if(!He(h))throw new Error("Invalid variable name");!c.length&&/^\d+$/.exec(h)?s.push("{",h,"}"):c.length?s.push("(?<",h,">",mt(c),")"):s.push("(?<",h,">.*)"),a!=="}"&&n--,e=0}else h+=a}break;case 5:c+="%"+a,e=1;break;case 6:c+=a,a===")"&&(e=1);break;case 7:c+=a,a==="]"&&(e=1);break;case 2:switch(a){case"d":s.push("\\d+"),e=0;break;case"n":s.push("[+-]?\\d+"),e=0;break;case"w":s.push("\\w"),e=0;break;case"a":s.push("[a-zA-Z0-9]*"),e=0;break;case"s":s.push("\\s*"),e=0;break;case"x":s.push("\\S*"),e=0;break;case"y":s.push("\\S*"),e=0;break;case"p":s.push(`[\\.\\?\\!\\:\\;\\-\\\u2014\\(\\)\\[\\]\\'\\"\\\\/\\,]{1}`),e=0;break;case"q":s.push(`[\\.\\?\\!\\:\\;\\-\\\u2014\\(\\)\\[\\]\\'\\"\\\\/\\,]{1}`),e=0;break;case"t":e=0;break;case"e":s.push("\x1B"),e=0;break;case"/":e=8,h="";break}break;case 8:if(a==="%"){if(!h.endsWith("/"))throw new Error("Invalid %/regex/% pattern");s.push(h.substr(0,h.length-1))}else h+=a;break;case 3:a==="^"&&h.length===0?c=!0:a==="}"?(c?s.push("[^",h,"]"):s.push(h),e=0):h+=a;break;case 4:a===":"?(s.push("(?<",h,">"),e=0):a===")"?(s.push("(",mt(h),")"),e=0,g--):h+=a;break;case 9:s.push("\\",a),e=0;break;case 10:if(a==="{"&&h.length===0)continue;if(a==="}"||!(o>=48&&o<=57||o>=65&&o<=90||o>=97&&o<=122||o===95||o===36)){if(!He(h))throw new Error("Invalid variable name");u&&(u.variables[h]instanceof At?s.push(u.variables[h].value||""):s.push(u.variables[h]||"")),a!=="}"&&n--,e=0}else h+=a;break;default:a==="*"?s.push(".*"):a==="?"?s.push("."):a==="~"?e=9:a==="@"?(e=10,h=""):a==="&"?(h="",c="",e=1):a==="%"?e=2:a==="{"?(e=3,h=""):a==="("?(e=4,h="",g++):(a===")"&&g--,s.push(a));break}switch(e){case 1:if(!He(h))throw new Error("Invalid variable name");!c.length&&/^\d+$/.exec(h)?s.push("{",h,"}"):c.length?s.push("(?<",h,">",mt(c),")"):s.push("(?<",h,">.*)");break;case 5:case 6:case 7:throw new Error("Invalid &VarName pattern");case 2:throw new Error("Invalid % pattern");case 8:throw new Error("Invalid %/regex/% pattern");case 3:throw new Error("Invalid string match pattern");case 4:throw new Error("Invalid (sub:pattern) pattern");case 9:throw new Error("Invalid escape pattern");case 10:if(!He(h))throw new Error("Invalid variable name");u&&(u.variables[h]instanceof At?s.push(u.variables[h].getValue()||""):s.push(u.variables[h]||""));break}if(g)throw new Error("Invalid save matched pattern");return s.join("")}var Lt,et,$t=["$selectedword","$selword","$selectedurl","$selurl","$selectedline","$selline","$selected","$character","$copied","$action","$trigger","$caption","$characterid"];function Ft(m){return m.replace(/\w*\S*/g,u=>u.charAt(0).toUpperCase()+u.substr(1).toLowerCase())}function Ni(){switch(~~(Math.random()*6)+1){case 1:case 4:return-1;case 3:case 2:return 1}return 0}var zt=class extends pe{constructor(t){super();this._historyIdx=-1;this._tabIdx=-1;this._tabWords=null;this._locked=0;this._TriggerCache=null;this._TriggerStates={};this._TriggerFunctionCache={};this._TriggerRegExCache={};this._LastTriggered="";this._LastTrigger=null;this._scrollLock=!1;this._gag=0;this._gagID=[];this._gags=[];this._stack=[];this._vStack=[];this._controllers={};this._controllersCount=0;this._gamepadCaches=null;this._lastSuspend=-1;this._MacroCache={};this._loops=[];this._pathQueue=[];this._pathTimeout=null;this._pathPaused=!1;this.client=null;this.enableParsing=!0;this.enableTriggers=!0;if(!t)throw new Error("Invalid client!");this.client=t,Lt=()=>et||(this.initMathJS(),et),this._commandHistory=[],document.addEventListener("keydown",e=>{!this.isLocked&&this.ProcessMacros(e.which,e.altKey,e.ctrlKey,e.shiftKey,e.metaKey)?(e.preventDefault(),e.stopPropagation()):e.key==="ScrollLock"&&this.toggleScrollLock()}),this.client.on("parse-command",e=>{this.client.getOption("parseCommands")&&(e.value=this.parseOutgoing(e.value,null,null,null,null,!e.comments))}),this.client.on("add-line",e=>{if(this.ExecuteTriggers(140,e.line,e.raw,e.fragment,!1,!0),this._gag>0&&!e.fragment&&(e.gagged=!0,this._gag--),!e.fragment)for(let s in this._TriggerStates)this._TriggerStates[s].lineCount&&this._TriggerStates[s].lineCount--}),this.client.on("options-loaded",()=>{!et&&this.client.getOption("initializeScriptEngineOnLoad")&&this.initMathJS(),this.initPads()}),this.client.commandInput.addEventListener("keyup",e=>{e.key!=="Escape"&&e.key!=="ArrowUp"&&e.key!=="ArrowDown"&&(this._historyIdx=this._commandHistory.length)}),this.client.commandInput.addEventListener("keydown",e=>{switch(e.key){case"Escape":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this.client.commandInput.blur(),this.client.commandInput.value="",this.client.commandInput.select(),this._historyIdx=this._commandHistory.length,this._tabIdx=-1,this._tabWords=null,this._tabSearch=null,this.emit("history-navigate",e);break;case"ArrowUp":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this._historyIdx===this._commandHistory.length&&this.client.commandInput.value.length>0&&(this.AddCommandToHistory(this.client.commandInput.value),this.client.commandInput.value===this._commandHistory[this._historyIdx-1]&&this._historyIdx--),this._historyIdx--,this._historyIdx<0&&(this._historyIdx=0),this._commandHistory.length<0?(this._historyIdx=-1,this.client.commandInput.value=""):this._commandHistory.length>0&&this._historyIdx<this._commandHistory.length&&this._historyIdx>=0&&(this.client.commandInput.value=this._commandHistory[this._historyIdx]),setTimeout(()=>this.client.commandInput.select(),0),this.emit("history-navigate",e);break;case"ArrowDown":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this._historyIdx===this._commandHistory.length&&this.client.commandInput.value.length>0&&this.AddCommandToHistory(this.client.commandInput.value),this._historyIdx++,this._historyIdx>=this._commandHistory.length||this._commandHistory.length<1?(this._historyIdx=this._commandHistory.length,this.client.commandInput.value=""):this._commandHistory.length>0&&this._historyIdx<this._commandHistory.length&&this._historyIdx>=0&&(this.client.commandInput.value=this._commandHistory[this._historyIdx]),setTimeout(()=>this.client.commandInput.select(),0),this.emit("history-navigate",e);break;case"Enter":switch(this.client.getOption("newlineShortcut")){case 1:if(e.ctrlKey&&!e.shiftKey&&!e.metaKey&&!e.altKey)return Ke(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 8:if(e.ctrlKey&&e.shiftKey&&!e.metaKey&&!e.altKey)return Ke(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 4:if((e.ctrlKey||e.shiftKey)&&!e.metaKey&&!e.altKey)return Ke(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 2:if(e.ctrlKey&&e.shiftKey&&!e.metaKey&&!e.altKey)return Ke(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break}!e.ctrlKey&&!e.shiftKey&&!e.metaKey&&!e.altKey&&(this._tabIdx=-1,this._tabWords=null,this._tabSearch=null,this.client.sendCommand(null,null,this.client.getOption("allowCommentsFromCommand")),this.emit("history-navigate",e)),e.preventDefault();break;case"Tab":if(!this.client.getOption("enableTabCompletion")||this.client.commandInput.value.length===0||e.altKey||e.ctrlKey||e.metaKey)return;e.shiftKey?this._tabIdx--:this._tabIdx++;let s=this.client.commandInput.selectionStart,n=this.client.commandInput.selectionEnd;if(this._tabWords===null){let a=Mi(this.client.commandInput),o=this.client.commandInput.value.indexOf(" ",a);o===-1&&(o=this.client.commandInput.value.indexOf(`
`,a));let h=this.client.commandInput.value.lastIndexOf(" ",a-1);h===-1&&(h=this.client.commandInput.value.indexOf(`
`,a-1)),o===-1&&(o=this.client.commandInput.value.length),h===-1?h=0:h++,s=h,n=o,s===n&&n++;let c=this.client.commandInput.value.substring(h,o);if(c.length===0)return;this._tabSearch={start:h,end:o,find:c.length};let g=new RegExp(`^${c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}`,this.client.getOption("ignoreCaseTabCompletion")?"i":"");this.client.getOption("tabCompletionLookupType")===8?this._tabWords=[...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(f=>f.match(g)))]:(this._tabWords=[].concat(...this.client.display.lines.slice(this.client.display.lines.length-this.client.getOption("tabCompletionBufferLimit")).map(f=>f.text.split(/\s+/))).filter(f=>f.match(g)).reverse(),this.client.getOption("tabCompletionLookupType")===1?this._tabWords=[...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(f=>f.match(g)).reverse())].concat(this._tabWords):this.client.getOption("tabCompletionLookupType")===2&&(this._tabWords=this._tabWords.concat([...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(f=>f.match(g)).reverse())])),this._tabWords=[...new Set(this._tabWords)])}else s-=this._tabSearch.find;if(this._tabWords.length===0)return;this._tabIdx<0&&(this._tabIdx=this._tabWords.length-1),this._tabIdx>=this._tabWords.length&&(this._tabIdx=0);let r=this.client.getOption("tabCompletionReplaceCasing");this.client.commandInput.value=this.client.commandInput.value.substring(0,s)+(r===1?this._tabWords[this._tabIdx].toLowerCase():r===2?this._tabWords[this._tabIdx].toUpperCase():this._tabWords[this._tabIdx])+this.client.commandInput.value.substring(n,this.client.commandInput.value.length),this.client.commandInput.selectionStart=this._tabSearch.start+this._tabSearch.find,this.client.commandInput.selectionEnd=this._tabSearch.start+this._tabWords[this._tabIdx].length,e.preventDefault(),this.emit("history-navigate",e);break;case"Shift":case"Control":case"Meta":case"Alt":case"CapsLock":case"Fn":case"NumLock":case"ScrollLock":case"Super":case"PageDown":case"PageUp":case"End":case"Home":case"ArrowLeft":case"ArrowRight":case"ContextMenu":break;default:this._tabIdx=-1,this._tabWords=null,this._tabSearch=null;break}}),this.client.commandInput.addEventListener("mouseup",e=>{this._tabIdx=-1,this._tabWords=null,this._tabSearch=null}),window.addEventListener("gamepadconnected",e=>{this.client.getOption("gamepads")&&(this._gamepadCaches||(this._gamepadCaches=[]),this._controllers[e.gamepad.index]={pad:e.gamepad,axes:$e(e.gamepad.axes),state:{axes:[],buttons:[]},pState:{axes:[],buttons:[]}},this._controllersCount++,this.updatePads())}),window.addEventListener("gamepaddisconnected",e=>{this.client.getOption("gamepads")&&(delete this._controllers[e.gamepad.index],this._controllersCount--)}),this.initPads()}getScope(){let t={};if(Object.assign(t,this.client.variables),$t.forEach(e=>{t[e]=window[e],t[e.substr(1)]=window[e]}),this._stack.length===0||!this.stack.named&&!this.loops.length)return t;if(this.stack.named&&Object.assign(t,this.stack.named),this.loops.length){t.repeatnum=this.repeatnum;let e=this.loops.length;for(let s=0;s<e&&s<18;s++)t[String.fromCharCode(105+s)]=this.loops[s]}return t}setScope(t){if(t===this.client.variables)return;let e=this.loops.length;for(let s in t)if(!(!Object.prototype.hasOwnProperty.call(t,s)||s==="i"||s==="repeatnum")&&!($t.indexOf(s)!==-1||$t.indexOf("$"+s)!==-1)){switch(s){case"clientid":continue}s.length===1&&e&&s.charCodeAt(0)>=105&&s.charCodeAt(0)<105+e||this.stack.named&&Object.prototype.hasOwnProperty.call(this.stack.named,s)||(this.client.variables[s]=t[s])}}evaluate(t){let e=this.getScope(),s=Lt().evaluate(t,e);return this.setScope(e),s}get stack(){return this._stack.length===0&&this._stack.push({args:0,named:0,used:0,append:!1}),this._stack[this._stack.length-1]}get repeatnum(){return this.loops.length===0?0:this.loops[this.loops.length-1]}get loops(){return this._stack.length===0||!this.stack.hasOwnProperty("loops")?this._loops:this.stack.loops}get regex(){let t=this._stack.length;if(t===0)return null;for(;t>=0;)if(t--,this._stack[t].hasOwnProperty("regex"))return this._stack[t].regex;return null}get indices(){let t=this._stack.length;if(t===0)return[];for(;t>=0;)if(t--,this._stack[t].hasOwnProperty("indices"))return this._stack[t].indices;return[]}get vStack(){return this._vStack.length===0?{}:this._vStack[this._vStack.length-1]}vStackPush(t){this._vStack.push(t)}vStackPop(){this._vStack.pop()}get scrollLock(){return this._scrollLock}set scrollLock(t){t!==this._scrollLock&&(this._scrollLock=t,this.emit("scroll-lock",this.scrollLock))}get lastTriggerExecuted(){return this._LastTrigger}get lastTriggered(){return this._LastTriggered}set lastTriggered(t){this._LastTriggered=t}getDiceArguments(t,e,s){let n=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString());if(!n||n.length<3)if(n=/(\d+)\s*?d\s*?\/\s*?(100)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!n||n.length<3){if(t=t.compile().evaluate(e),n=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!n||n.length<3){if(n=/(\d+)\s*?d\s*?\/\s*?(100)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!n||n.length<3)throw new Error("Invalid dice for "+(s||"dice"));n[2]="%"}}else n[2]="%";return n}initMathJS(){et=math;let t={esc:"\x1B",cr:`
`,lf:"\r",crlf:`\r
`,diceavg:(e,s,n)=>{let r,a,o,h,c,g;if(e.length===0)throw new Error("Invalid arguments for diceavg");if(e.length===1)r=this.getDiceArguments(e[0],n,"diceavg"),a=parseInt(r[1]),o=r[2],r.length>3&&(h=r[3]);else if(e.length<4)a=e[0].compile().evaluate(n),o=e[1].toString().trim(),o!=="F"&&o!=="%"&&(o=e[1].compile().evaluate(n)),e.length>2&&(h=e[2].compile().evaluate(n));else throw new Error("Too many arguments for diceavg");return c=1,o==="F"||o==="f"?(c=-1,g=1):o==="%"?(g=1,c=0):g=parseInt(o),h?s.evaluate((c+g)/2*a+h,n):(c+g)/2*a},dicemin:(e,s,n)=>{let r,a,o,h,c;if(e.length===0)throw new Error("Invalid arguments for dicemin");if(e.length===1)r=r=this.getDiceArguments(e[0],n,"dicemin"),a=parseInt(r[1]),o=r[2],r.length>3&&(h=r[3]);else if(e.length<4)a=e[0].compile().evaluate(n),o=e[1].toString().trim(),o!=="F"&&o!=="%"&&(o=e[1].compile().evaluate(n)),e.length>2&&(h=e[2].compile().evaluate(n));else throw new Error("Too many arguments for dicemin");return c=1,o==="F"||o==="f"?c=-1:o==="%"&&(c=0),h?s.evaluate(c*a+h,n):c*a},dicemax:(e,s,n)=>{let r,a,o,h,c;if(e.length===0)throw new Error("Invalid arguments for dicemax");if(e.length===1)r=this.getDiceArguments(e[0],n,"dicemax"),a=parseInt(r[1]),o=r[2],r.length>3&&(h=r[3]);else if(e.length<4)a=e[0].compile().evaluate(n),o=e[1].toString().trim(),o!=="F"&&o!=="%"&&(o=e[1].compile().evaluate(n)),e.length>2&&(h=e[2].compile().evaluate(n));else throw new Error("Too many arguments for dicemax");return o==="F"||o==="f"||o==="%"?c=1:c=parseInt(o),h?s.evaluate(c*a+h,n):c*a},dicedev:(e,s,n)=>{let r,a,o,h,c;if(e.length===0)throw new Error("Invalid arguments for dicedev");if(e.length===1)r=this.getDiceArguments(e[0],n,"dicedev"),a=parseInt(r[1]),o=r[2],r.length>3&&(h=r[3]);else if(e.length<4)a=e[0].compile().evaluate(n),o=e[1].toString().trim(),o!=="F"&&o!=="%"&&(o=e[1].compile().evaluate(n)),e.length>2&&(h=e[2].compile().evaluate(n));else throw new Error("Too many arguments for dicedev");return o==="F"||o==="f"?c=6:o==="%"?c=1:c=parseInt(o),h?s.evaluate(Math.sqrt((c*c-1)/12*a)+h,n):Math.sqrt((c*c-1)/12*a)},zdicedev:(e,s,n)=>{let r,a,o,h,c;if(e.length===0)throw new Error("Invalid arguments for zdicedev");if(e.length===1)r=this.getDiceArguments(e[0],n,"zdicedev"),a=parseInt(r[1]),o=r[2],r.length>3&&(h=r[3]);else if(e.length<4)a=e[0].compile().evaluate(n),o=e[1].toString().trim(),o!=="F"&&o!=="%"&&(o=e[1].compile().evaluate(n)),e.length>2&&(h=e[2].compile().evaluate(n));else throw new Error("Too many arguments for zdicedev");return o==="F"||o==="f"?c=6:o==="%"?c=1:c=parseInt(o),c--,h?s.evaluate(Math.sqrt((c*c-1)/12*a)+h,n):Math.sqrt((c*c-1)/12*a)},dice:(e,s,n)=>{let r,a,o,h;if(e.length===1)r=this.getDiceArguments(e[0],n,"dice"),a=parseInt(r[1]),o=r[2],r.length>3&&(h=r[3]);else if(e.length>1)a=e[0].compile().evaluate(n),o=e[1].toString().trim(),o!=="F"&&o!=="%"&&(o=e[1].compile().evaluate(n)),e.length>2&&(h=e[2].compile().evaluate(n));else throw new Error("Invalid arguments for dice");let c=0;for(let g=0;g<a;g++)o==="F"||o==="f"?c+=Ni():o==="%"?c+=~~(Math.random()*100)+1:c+=~~(Math.random()*o)+1;return o==="%"&&(c/=100),h?s.evaluate(c+h,n):c},isdefined:(e,s,n)=>{if(e.length===1)return e[0]=this.stripQuotes(e[0].toString()),this.client.variables.hasOwnProperty(e[0])||n.has(e[0])?1:0;throw new Error("Invalid arguments for isdefined")},defined:(e,s,n)=>{let r;if(e.length===0)throw new Error("Missing arguments for defined");if(e.length===1){e[0]=this.stripQuotes(e[0],!0);let a=this.client.profiles.keys,o=0,h=a.length;if(h===0)return 0;for(;o<h;o++)if(r=te(this.client.profiles.items[a[o]].aliases),r=r.find(c=>c.pattern===e[0]),r||(r=te(this.client.profiles.items[a[o]].triggers),r=r.find(c=>c.pattern===e[0]||c.name===e[0]),r)||(r=te(this.client.profiles.items[a[o]].macros),r=r.find(c=>ot(c).toLowerCase()===e[0].toLowerCase()||c.name===e[0]),r)||(r=te(this.client.profiles.items[a[o]].aliases),r=r.find(c=>c.caption===e[0]||c.name===e[0]),r))return 1;return this.client.variables.hasOwnProperty(e[0])}else if(e.length===2){e[0]=this.stripQuotes(e[0].toString()),e[0]=this.stripQuotes(e[1].toString());let a=this.client.profiles.keys,o=0,h=a.length;if(h===0)return 0;for(;o<h;o++)switch(e[1]){case"alias":return r=te(this.client.profiles.items[a[o]].aliases),r=r.find(c=>c.pattern===e[0]),r?1:0;case"event":return r=te(this.client.profiles.items[a[o]].triggers),r=r.find(c=>c.type===2&&(c.pattern===e[0]||c.name===e[0])),r?1:0;case"trigger":return r=te(this.client.profiles.items[a[o]].triggers),r=r.find(c=>c.pattern===e[0]||c.name===e[0]),r?1:0;case"macro":return r=te(this.client.profiles.items[a[o]].macros),r=r.find(c=>ot(c).toLowerCase()===e[0].toLowerCase()||c.name===e[0]),r?1:0;case"button":return r=te(this.client.profiles.items[a[o]].aliases),r=r.find(c=>c.caption===e[0]||c.name===e[0]),r?1:0}if(e[1]==="variable")return this.client.variables.hasOwnProperty(e[0])||n.has(e[0])}else throw new Error("Too many arguments for defined");return 0},time:(e,s,n)=>{if(e.length>1)throw new Error("Too many arguments for time");return moment?e.length?moment().format(e[0].compile().evaluate(n)):moment().format():new Date().toISOString()},clip:(e,s,n)=>{if(e.length>1)throw new Error("Too many arguments for clip");if(e.length){this.client.writeClipboard(e[0].compile().evaluate(n));return}return this.client.readClipboard()},if:(e,s,n)=>{if(e.length<3)throw new Error("Missing arguments for if");if(e.length!==3)throw new Error("Too many arguments for if");return e[0].compile().evaluate(n)?e[1].compile().evaluate(n):e[2].compile().evaluate(n)},len:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for len");if(e.length!==1)throw new Error("Too many arguments for len");return e[0].compile().evaluate(n).toString().length},stripansi:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for len");if(e.length!==1)throw new Error("Too many arguments for len");let r=new RegExp("[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))","g");return e[0].compile().evaluate(n).toString().replace(r,"")},ansi:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for ansi");e=e.map(g=>qe(g.toString())===-1&&g.toString()!=="current"?g.compile().evaluate(n).toString():g.toString());let r=e.length,a=[],o={},h,c;for(h=0;h<r;h++)if(e[h].trim()==="current")a.push(e[h].trim());else{if(c=qe(e[h].trim()),c===-1)throw new Error("Invalid color or style for ansi");c>=0&&c<30?o[c]=1:a.push(e[h])}if(a.length>2)throw new Error("Too many colors for ansi");if(a.length>1&&(a[1]==="current"?a[1]="":a[1]=qe(a[1],!0)),a.length>0&&(o[1]&&a[0]==="white"||a[0]==="current"?a[0]="":a[0]=qe(a[0])),o=[...Object.keys(o),...a],!o.length)throw new Error("Invalid colors or styles for ansi");return o=o.filter(g=>g!==""),`\x1B[${o.join(";")}m`},color:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for color");e=e.map(o=>qe(o.toString())===-1&&o.toString()!=="current"?o.compile().evaluate(n).toString():o.toString());let r,a;if(e.length===1){if(e[0]==="bold")return"370";if(r=de(e[0]),r===-1)throw new Error("Invalid fore color");return r.toString()}else if(e.length===2){if(e[0]==="bold")r=370;else{if(r=de(e[0]),r===-1)throw new Error("Invalid fore color");if(e[1]==="bold")return(r*10).toString()}if(a=r.toString(),r=de(e[1],!0),r===-1)throw new Error("Invalid back color");return a+","+r.toString()}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[2]!=="bold")throw new Error("Only bold is supported as third argument for color");if(r=de(e[0]),r===-1)throw new Error("Invalid fore color");if(a=(r*10).toString(),r=de(e[1],!0),r===-1)throw new Error("Invalid back color");return a+","+r.toString()}throw new Error("Too many arguments")},zcolor:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for zcolor");if(e.length>1)throw new Error("Too many arguments for zcolor");return mi(parseInt(e[0].compile().evaluate(n),10))},case:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for case");let r=e[0].compile().evaluate(n);return r>0&&r<e.length?e[r].compile().evaluate(n):null},switch:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for switch");if(e.length%2===1)throw new Error("All expressions must have a value for switch");let r=e.length;for(let a=0;a<r;a+=2)if(e[a].compile().evaluate(n))return e[a+1].compile().evaluate(n);return null},ascii:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for ascii");if(e.length>1)throw new Error("Too many arguments for ascii");if(e[0].toString().trim().length===0)throw new Error("Invalid argument, empty string for ascii");return e[0].toString().trim().charCodeAt(0)},char:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for char");if(e.length>1)throw new Error("Too many arguments for char");let r=e[0].compile().evaluate(n);if(isNaN(r))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for char");return String.fromCharCode(r)},bitand:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for bitand");if(e.length!==2)throw new Error("Too many arguments for bitand");let r=e[0].compile().evaluate(n);if(isNaN(r))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitand");let a=e[1].compile().evaluate(n);if(isNaN(a))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitand");return r&a},bitnot:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for bitnot");if(e.length!==1)throw new Error("Too many arguments for bitnot");let r=e[0].compile().evaluate(n);if(isNaN(r))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitnot");return~r},bitor:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for bitor");if(e.length!==2)throw new Error("Too many arguments for bitor");let r=e[0].compile().evaluate(n);if(isNaN(r))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitor");let a=e[1].compile().evaluate(n);if(isNaN(a))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitor");return r|a},bitset:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for bitset");if(e.length>3)throw new Error("Too many arguments for bitset");let r=e[0].compile().evaluate(n);if(isNaN(r))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitset");let a=e[1].compile().evaluate(n);if(isNaN(a))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitset");a--;let o=1;if(e.length===3&&(o=e[2].compile().evaluate(n),isNaN(o)))throw new Error("Invalid argument '"+e[2].toString()+"' must be a number for bitset");return r&~(1<<a)|(o?1:0)<<a},bitshift:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for bitshift");if(e.length!==2)throw new Error("Too many arguments for bitshift");let r=e[0].compile().evaluate(n);if(isNaN(r))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitshift");let a=e[1].compile().evaluate(n);if(isNaN(a))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitshift");return a<0?r>>-a:r<<a},bittest:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for bittest");if(e.length!==2)throw new Error("Too many arguments for bittest");let r=e[0].compile().evaluate(n);if(isNaN(r))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bittest");let a=e[1].compile().evaluate(n);if(isNaN(a))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bittest");return a--,(r>>a)%2!=0?1:0},bitxor:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for bitxor");if(e.length!==2)throw new Error("Too many arguments for bitxor");let r=e[0].compile().evaluate(n);if(isNaN(r))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitxor");let a=e[1].compile().evaluate(n);if(isNaN(a))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitxor");return r^a},tonumber:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for number");if(e.length>1)throw new Error("Too many arguments for number");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)?parseInt(e[0],10):e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(e[0]):e[0]==="true"?1:(e[0]==="false",0)},isfloat:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for isfloat");if(e.length>1)throw new Error("Too many arguments for isfloat");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0},isnumber:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for isnumber");if(e.length>1)throw new Error("Too many arguments for isnumber");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)||e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0},tostring:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for string");if(e.length>1)throw new Error("Too many arguments for string");return e[0].compile().evaluate(n).toString()},float:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for float");if(e.length>1)throw new Error("Too many arguments for float");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)||e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(e[0]):e[0]==="true"?1:(e[0]==="false",0)},trim:(e,s,n)=>{if(e.length!==1)throw new Error("Missing arguments for trim");return e[0].compile().evaluate(n).toString().trim()},trimleft:(e,s,n)=>{if(e.length!==1)throw new Error("Missing arguments for trimleft");return e[0].compile().evaluate(n).toString().trimLeft()},trimright:(e,s,n)=>{if(e.length!==1)throw new Error("Missing arguments for trimright");return e[0].compile().evaluate(n).toString().trimRight()},pos:(e,s,n)=>{if(e.length<2)throw new Error("Missing arguments for pos");if(e.length>2)throw new Error("Too many arguments for pos");return e[0]=e[0].compile().evaluate(n).toString(),e[1]=e[1].compile().evaluate(n).toString(),e[1].indexOf(e[0])+1},ipos:(e,s,n)=>{if(e.length<2)throw new Error("Missing arguments for pos");if(e.length>2)throw new Error("Too many arguments for pos");return e[0]=e[0].compile().evaluate(n).toString().toLowerCase(),e[1]=e[1].compile().evaluate(n).toString().toLowerCase(),e[1].indexOf(e[0])+1},ends:(e,s,n)=>{if(e.length<2)throw new Error("Missing arguments for ends");if(e.length>2)throw new Error("Too many arguments for ends");return e[0]=e[0].compile().evaluate(n).toString().toLowerCase(),e[1]=e[1].compile().evaluate(n).toString().toLowerCase(),e[0].endsWith(e[1])},begins:(e,s,n)=>{if(e.length<2)throw new Error("Missing arguments for begins");if(e.length>2)throw new Error("Too many arguments for begins");return e[0]=e[0].compile().evaluate(n).toString().toLowerCase(),e[1]=e[1].compile().evaluate(n).toString().toLowerCase(),e[0].startsWith(e[1])},alarm:(e,s,n)=>{let r,a,o,h,c;switch(e.length){case 0:throw new Error("Missing arguments for alarm");case 1:if(e[0]=e[0].compile().evaluate(n).toString(),r=this.client.alarms,o=r.length,o===0)throw new Error("No alarms set.");for(a=0;a<o;a++)if(r[a].type===3&&(r[a].name===e[0]||r[a].pattern===e[0]))return r[a].suspended?0:this.client.getRemainingAlarmTime(a);return;case 2:if(h=e[1].compile().evaluate(n),e[0]=e[0].compile().evaluate(n).toString(),r=this.client.alarms,o=r.length,o===0)throw new Error("No alarms set.");if(a=0,typeof h=="string"){for(;a<o;a++)if(r[a].type===3&&(r[a].name===e[0]||r[a].pattern===e[0])){if(r[a].profile.name.toUpperCase()!==h.toUpperCase())continue;return r[a].suspended?0:this.client.getRemainingAlarmTime(a)}throw new Error("Alarm not found in profile: "+h+".")}else{for(;a<o;a++)if(r[a].type===3&&(r[a].name===e[0]||r[a].pattern===e[0]))return r[a].suspended||this.client.setAlarmTempTime(a,h),h;throw new Error("Alarm not found.")}case 3:if(h=e[1].compile().evaluate(n),e[0]=e[0].compile().evaluate(n).toString(),c=e[2].compile().evaluate(n).toString(),r=this.client.alarms,o=r.length,o===0)throw new Error("No alarms set.");for(a=0;a<o;a++)if(r[a].type===3&&(r[a].name===e[0]||r[a].pattern===e[0])){if(r[a].profile.name.toUpperCase()!==c.toUpperCase())continue;return r[a].suspended||this.client.setAlarmTempTime(a,h),h}throw Error("Could not set time, alarm not found in profile: "+e[2]+".")}throw new Error("Too many arguments for alarm")},state:(e,s,n)=>{let r;if(e.length===0)throw new Error("Missing arguments for state");if(e.length>2)throw new Error("Too many arguments for state");if(e[0]=e[0].compile().evaluate(n).toString(),e.length===1){let a=this.client.profiles.keys,o=0,h=a.length;if(h===0)return null;if(h===1){if(!this.client.profiles.items[a[0]].enabled||!this.client.profiles.items[a[0]].enableTriggers)throw Error("No enabled profiles found!");r=te(this.client.profiles.items[a[o]].triggers),r=r.find(c=>c.name===e[0]||c.pattern===e[0])}else for(;o<h&&!(!(!this.client.profiles.items[a[o]].enabled||!this.client.profiles.items[a[o]].enableTriggers||this.client.profiles.items[a[o]].triggers.length===0)&&(r=te(this.client.profiles.items[a[o]].triggers),r=r.find(c=>c.name===e[0]||c.pattern===e[0]),r));o++);}else if(e.length===2){e[1]=e[1].compile().evaluate(n);let a;if(this.client.profiles.contains(e[1]))a=this.client.profiles.items[e[1].toLowerCase()];else throw new Error("Profile not found: "+e[1]);r=te(a.triggers),r=r.find(o=>o.name===e[0]||o.pattern===e[0])}if(r)return r.triggers&&r.triggers.length?r.state:0;throw new Error("Trigger not found")},isnull:(e,s,n)=>{if(e.length===0)return null;if(e.length!==1)throw new Error("Too many arguments for null");return e[0].compile().evaluate(n)?1:0},escape:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for unescape");if(e.length!==1)throw new Error("Too many arguments for unescape");let r;if(e[0]=e[0].compile().evaluate(n).toString(),this.client.getOption("allowEscape")){let a=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";return r=a,a==="\\"&&(r+=a),this.client.getOption("parseDoubleQuotes")&&(r+='"'),this.client.getOption("parseSingleQuotes")&&(r+="'"),this.client.getOption("commandStacking")&&(r+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(r+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(r+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(r+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(r+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(r+=this.client.getOption("nParametersChar")),e.replace(new RegExp(`[${r}]`,"g"),a+"$&")}return e.replace(/[\\"']/g,"$&")},unescape:(e,s,n)=>{if(e.length===0)throw new Error("Missing arguments for unescape");if(e.length!==1)throw new Error("Too many arguments for unescape");let r;if(e[0]=e[0].compile().evaluate(n).toString(),this.client.getOption("allowEscape")){let a=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";return r=a,a==="\\"&&(r+=a),this.client.getOption("parseDoubleQuotes")&&(r+='"'),this.client.getOption("parseSingleQuotes")&&(r+="'"),this.client.getOption("commandStacking")&&(r+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(r+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(r+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(r+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(r+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(r+=this.client.getOption("nParametersChar")),a==="\\"?e[0].replace(new RegExp(`\\\\[${r}]`,"g"),o=>o.substr(1)):e[0].replace(new RegExp(`${a}[${r}]`,"g"),o=>o.substr(1))}return e[0].replace(/\\[\\"']/g,a=>a.substr(1))},prompt:(e,s,n)=>{if(e.length>3)throw new Error("Too many arguments");return e.length===0?window.prompt():(e=e.map(r=>r.compile().evaluate(n).toString()),window.prompt(...e))}};for(let e in t)!t.hasOwnProperty(e)||typeof t[e]!="function"||(t[e].rawArgs=!0);et.import(t,{})}resetExpressionEngine(){et&&(et=void 0)}async initPads(){if(!this.client||!this.client.options){setTimeout(this.initPads,5);return}if(this._controllers=[],this._controllersCount=0,this._gamepadCaches=null,!this.client.getOption("gamepads"))return;let t=navigator.getGamepads(),e=0,s=t.length;for(;e<s;e++)t[e]&&(this._controllers[t[e].index]={pad:t[e],axes:$e(t[e].axes),state:{axes:[],buttons:[]},pState:{axes:[],buttons:[]}},this._controllersCount++);this.updatePads()}updatePads(){if(this._controllersCount===0||!this.client.getOption("gamepads"))return;let t=navigator.getGamepads(),e=0,s=t.length;for(!this._gamepadCaches&&s>0&&(this._gamepadCaches=[]);e<s;e++){let n=t[e];if(!n||!this._controllers[n.index])continue;let r=this._controllers[n.index].state,a=this._controllers[n.index].axes,o=n.buttons.length,h,c;this._gamepadCaches[e]||(this._gamepadCaches[e]=Qe(this.client.macros,"gamepad",e+1)),c=this._gamepadCaches[e];let g=0,f=c.length;if(f===0)continue;for(h=0;h<o;h++){let k=n.buttons[h],E;if(typeof k=="object"?(E=k.pressed,k=k.value):E=k>=.5,r.buttons[h]){if(r.buttons[h].pressed!==E&&(r.buttons[h].pressed=E,!E)){for(;g<f;g++)if(c[g].enabled&&c[g].key===h+1&&this.ExecuteMacro(c[g])){(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()});return}}}else r.buttons[h]={pct:Math.round(k*100),pressed:E}}let w=n.axes.length,p=0;for(h=0;h<w;h++)if(r.axes[h]!==n.axes[h]&&n.axes[h]!==a[h]&&(r.axes[h]=n.axes[h]),r.axes[h]<-.75?p=-(h+1):r.axes[h]>.75&&(p=h+1),p!==0){for(;g<f;g++)if(c[g].enabled&&c[g].gamepadAxes===h+1&&this.ExecuteMacro(c[g])){(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()});return}}}(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()})}adjustLastLine(t,e){return!this.client.display.lines||this.client.display.lines.length===0?0:(e?t===this.client.display.lines.length?(t--,this.client.display.lines[t].text.length===0&&this.client.display.lines[t].raw.length&&t--):t===this.client.display.lines.length-1&&this.client.display.lines[t].text.length===0&&this.client.display.lines[t].raw.length&&t--:t===this.client.display.lines.length?(t--,this.client.display.lines[t].text.length===0&&t--):t===this.client.display.lines.length-1&&this.client.display.lines[t].text.length===0&&t--,t)}get isLocked(){return this._locked!==0}addLock(){this._locked++}removeLock(){this._locked--}AddCommandToHistory(t){(this._commandHistory.length<1||this._commandHistory[this._commandHistory.length-1]!==t)&&t.length>0&&(this._commandHistory.length>=this.client.getOption("commandHistorySize")&&this._commandHistory.shift(),this._commandHistory.push(t),this.emit("command-history-changed",this._commandHistory))}clearCommandHistory(){this._commandHistory=[],this._historyIdx=-1,this.emit("command-history-changed",this._commandHistory)}setHistoryIndex(t){t<0||this._commandHistory.length===0?this._historyIdx=-1:t>=this._commandHistory.length?this._historyIdx=this._commandHistory.length-1:this._historyIdx=t}get commandHistory(){return this._commandHistory}executeScript(t){if(t==null)return t;let e=0,s=0,n,r=t.length,a="",o=[],h="",c,g=0,f=this.client.getOption("parseDoubleQuotes"),w=this.client.getOption("parseSingleQuotes"),p=this.client.getOption("commandChar");for(;s<r;s++)switch(n=t.charAt(s),e){case 1:n===" "?(e=2,c+=n):(a+=n,c+=n);break;case 2:n==="{"?(e=7,h+=n):n==="("?(e=8,h+=n):n===" "?(o.push(h),h=""):(n==='"'&&f?e=3:n==="'"&&w&&(e=4),h+=n),c+=n;break;case 3:n==='"'&&(e=2),h+=n,c+=n;break;case 4:n==="'"&&(e=2),h+=n,c+=n;break;case 7:h+=n,n==="}"?g===0?e=2:g--:n==="{"&&g++,c+=n;break;case 8:h+=n,n===")"?g===0?e=2:g--:n==="("&&g++,c+=n;break;default:if(s===0&&n===p)e=1,a="",o=[],h="",c=n;else return t;break}return a.length>0?(h.endsWith(`
`)&&(h=h.substring(0,h.length-1)),h.length>0&&o.push(h),this.executeFunction(a,o,c,p)):t}executeFunction(t,e,s,n){let r,a=!1,o,h,c,g,f=null,w=null,p,k,E,b;switch(t.toLowerCase()){case"unaction":case"untrigger":case"unt":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),f=null,w=null,E=!0,e.length<1||e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"unt\x1B[0;-11;-12mrigger {pattern|name} \x1B[3mprofile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid name or pattern");if(e[0].match(/^\{.*\}$/g)?e[0]=this.parseInline(e[0].substr(1,e[0].length-2)):e[0]=this.parseInline(this.stripQuotes(e[0])),e.length===2&&(f=this.stripQuotes(e[2]),f=this.parseInline(f)),!f||f.length===0){let _=this.client.profiles.keys,C=0,L=_.length;if(L===0)return null;if(L===1){if(!this.client.profiles.items[_[0]].enabled||!this.client.profiles.items[_[0]].enableTriggers)throw Error("No enabled profiles found!");p=this.client.profiles.items[_[C]].findAny("triggers",{name:e[0],pattern:e[0]})}else for(;C<L;C++)if(!(!this.client.profiles.items[_[C]].enabled||!this.client.profiles.items[_[C]].enableTriggers||this.client.profiles.items[_[C]].triggers.length===0)&&(p=this.client.profiles.items[_[C]].findAny("triggers",{name:e[0],pattern:e[0]}),p)){f=this.client.profiles.items[_[C]];break}if(!p)throw new Error("Trigger '"+e[0]+"' not found in '"+f.name+"'!");this.client.removeTrigger(p),this.client.echo("Trigger '"+e[0]+"' removed from '"+f.name+"'.",-7,-8,!0,!0)}else if(f=this.parseInline(f),this.client.profiles.contains(f)){if(f=this.client.profiles.items[f.toLowerCase()],p=f.findAny("triggers",{name:e[0],pattern:e[0]}),!p)throw new Error("Trigger '"+e[0]+"' not found in '"+f.name+"'!");this.client.removeTrigger(p),this.client.echo("Trigger '"+e[0]+"' removed from '"+f.name+"'.",-7,-8,!0,!0)}else throw new Error("Profile not found: "+f);return null;case"suspend":case"sus":switch((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length){case 0:return g=this.client.alarms,g.length===0?this.client.echo("No alarms defined.",-7,-8,!0,!0):(this.client.setAlarmState(0,!1),this._lastSuspend=0,this.client.echo("Last alarm suspended.",-7,-8,!0,!0)),null;case 1:o=this.parseInline(this.stripQuotes(e[0])),g=this.client.alarms,h=g.length;for(let _=g.length-1;_>=0;_--)if(g[_].name===o||g[_].pattern===o){this.client.setAlarmState(_,!1),this.client.echo("Alarm '"+o+"' suspended.",-7,-8,!0,!0),this._lastSuspend=_;break}return null;default:throw new Error("Invalid syntax use \x1B[4m"+n+"sus\x1B[0;-11;-12mpend id \x1B[3mprofile\x1B[0;-11;-12m or \x1B[4m"+n+"sus\x1B[0;-11;-12mpend")}case"resume":case"resu":switch((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length){case 0:return this._lastSuspend===-1||(this.client.setAlarmState(this._lastSuspend,!0),this.client.echo("Last alarm suspended resumed.",-7,-8,!0,!0),this._lastSuspend=-1),null;case 1:o=this.parseInline(this.stripQuotes(e[0])),g=this.client.alarms,h=g.length;for(let _=h-1;_>=0;_--)if(g[_].name===o||g[_].pattern===o){this.client.setAlarmState(_,!0),this.client.echo("Alarm '"+o+"' resumed.",-7,-8,!0,!0);break}return null;default:throw new Error("Invalid syntax use \x1B[4m"+n+"resu\x1B[0;-11;-12mme id \x1B[3mprofile\x1B[0;-11;-12m or \x1B[4m"+n+"resu\x1B[0;-11;-12mme")}case"action":case"ac":case"trigger":case"tr":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),p={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+n+"tr\x1B[0;-11;-12migger name {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or \x1B[4m"+n+"tr\x1B[0;-11;-12migger {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid trigger name or pattern");if(e[0].match(/^\{.*\}$/g))p.pattern=e.shift(),p.pattern=this.parseInline(p.pattern.substr(1,p.pattern.length-2));else{if(p.name=this.parseInline(this.stripQuotes(e.shift())),!p.name||p.name.length===0)throw new Error("Invalid trigger name");e[0].match(/^\{.*\}$/g)&&(p.pattern=e.shift(),p.pattern=this.parseInline(p.pattern.substr(1,p.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(p.commands=e.shift(),p.commands=p.commands.substr(1,p.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(_=>{switch(_.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":p.options[_.trim()]=!0;break;default:if(_.trim().startsWith("param=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger param option '${_.trim()}'`);p.options.params=g[1]}else if(_.trim().startsWith("type=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger type option '${_.trim()}'`);if(!this.isTriggerType(g[1],1))throw new Error("Invalid trigger type");p.options.type=g[1]}else if(_.trim().startsWith("pri=")||_.trim().startsWith("priority=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger priority option '${_.trim()}'`);if(c=parseInt(g[1],10),isNaN(c))throw new Error("Invalid trigger priority value '"+g[1]+"' must be a number");p.options.priority=c}else throw new Error(`Invalid trigger option '${_.trim()}'`)}});else throw new Error("Invalid trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(_=>{switch(_.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":p.options[_.trim()]=!0;break;default:if(_.trim().startsWith("param=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger param option '${_.trim()}'`);p.options.params=g[1]}else if(_.trim().startsWith("type=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger type option '${_.trim()}'`);if(!this.isTriggerType(g[1],1))throw new Error("Invalid trigger type");p.options.type=g[1]}else if(_.trim().startsWith("pri=")||_.trim().startsWith("priority=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger priority option '${_.trim()}'`);if(c=parseInt(g[1],10),isNaN(c))throw new Error("Invalid trigger priority value '"+g[1]+"' must be a number");p.options.priority=c}else throw new Error(`Invalid trigger option '${_.trim()}'`)}});else throw new Error("Invalid trigger options");p.profile=this.stripQuotes(e[1]),p.profile.length!==0&&(p.profile=this.parseInline(p.profile))}}return this.createTrigger(p.pattern,p.commands,p.profile,p.options,p.name),null;case"event":case"ev":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),f=null,E=!0,p={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+n+"ev\x1B[0;-11;-12ment name {commands} \x1B[3moptions profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid event name");if(p.name=this.parseInline(this.stripQuotes(e.shift())),!p.name||p.name.length===0)throw new Error("Invalid event name");if(e.length===0)throw new Error("Missing commands or options");if(e[0].match(/^\{[\s\S]*\}$/g))p.commands=e.shift(),p.commands=p.commands.substr(1,p.commands.length-2);else throw new Error("Missing commands");if(e.length===1)if(e[0]=e[0].substr(1,e[0].length-2),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(_=>{switch(_.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"temporary":case"temp":p.options[_.trim()]=!0;break;default:if(_.trim().startsWith("pri=")||_.trim().startsWith("priority=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid event priority option '${_.trim()}'`);if(c=parseInt(g[1],10),isNaN(c))throw new Error("Invalid event priority value '"+g[1]+"' must be a number");p.options.priority=c}else throw new Error(`Invalid event option '${_.trim()}'`)}});else throw new Error("Invalid event options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(_=>{switch(_.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"temporary":case"temp":p.options[_.trim()]=!0;break;default:if(_.trim().startsWith("pri=")||_.trim().startsWith("priority=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid event priority option '${_.trim()}'`);if(c=parseInt(g[1],10),isNaN(c))throw new Error("Invalid event priority value '"+g[1]+"' must be a number");p.options.priority=c}else throw new Error(`Invalid event option '${_.trim()}'`)}});else throw new Error("Invalid event options");p.profile=this.stripQuotes(e[1]),p.profile.length!==0&&(p.profile=this.parseInline(p.profile))}if(!p.profile||p.profile.length===0){let _=this.client.profiles.keys,C=0,L=_.length;if(L===0)return null;if(L===1){if(!this.client.profiles.items[_[0]].enabled||!this.client.profiles.items[_[0]].enableTriggers)throw Error("No enabled profiles found!");f=this.client.profiles.items[_[0]],g=te(this.client.profiles.items[_[C]].triggers.filter(R=>R.type===2)),b=g.find(R=>R.name===p.name||R.pattern===p.name)}else{for(;C<L;C++)if(!(!this.client.profiles.items[_[C]].enabled||!this.client.profiles.items[_[C]].enableTriggers||this.client.profiles.items[_[C]].triggers.length===0)&&(g=te(this.client.profiles.items[_[C]].triggers.filter(R=>R.type===2)),b=g.find(R=>R.name===p.name||R.pattern===p.name),b)){f=this.client.profiles.items[_[C]];break}f||(f=this.client.activeProfile)}}else{if(this.client.profiles.contains(p.profile))f=this.client.profiles.items[p.profile.toLowerCase()];else throw new Error("Profile not found: "+p.profile);b=g.find(_=>_.name===p.name||_.pattern===p.name)}return b?this.client.echo("Event '"+b.name+"' updated.",-7,-8,!0,!0):(b=new Ie,b.name=p.name,f.triggers.push(b),this.client.echo("Event '"+b.name+"' added.",-7,-8,!0,!0),p.new=!0),b.pattern=p.name,p.commands!==null&&(b.value=p.commands),b.type=2,p.options.prompt&&(b.triggerPrompt=!0),p.options.nocr&&(b.triggerNewline=!1),p.options.case&&(b.caseSensitive=!0),p.options.raw&&(b.raw=!0),p.options.verbatim&&(b.verbatim=!0),p.options.disable?b.enabled=!1:p.options.enable&&(b.enabled=!0),(p.options.temporary||p.options.temp)&&(b.temp=!0),b.priority=p.options.priority,this.client.saveProfiles(),E&&this.client.clearCache(),p.new?this.emit("item-added","trigger",f.name,b):this.emit("item-updated","trigger",f.name,f.triggers.indexOf(b),b),f=null,null;case"unevent":case"une":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"une\x1B[0;-11;-12mvent name or \x1B[4m"+n+"une\x1B[0;-11;-12mvent {name} \x1B[3mprofile\x1B[0;-11;-12m");if(E=!0,f=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"une\x1B[0;-11;-12mvent name or \x1B[4m"+n+"une\x1B[0;-11;-12mvent {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(f=this.parseInline(this.stripQuotes(e[1])).toLowerCase(),this.client.profiles.contains(f))f=this.client.profiles.items[f];else throw new Error("Profile not found: "+f);else f=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?r=this.parseInline(this.stripQuotes(e[0])):r=this.parseInline(e[0].substr(1,e[0].length-2))}else r=this.parseInline(e.join(" ")),f=this.client.activeProfile;return o=te(f.triggers.filter(_=>_.type===2)),r=this.stripQuotes(r),g=r,r=o.findIndex(_=>_.pattern===r||_.name===r),a=r!==-1,a?(this.client.echo("Event '"+(o[r].name||o[r].pattern)+"' removed.",-7,-8,!0,!0),E?this.client.removeTrigger(o[r]):(r=f.triggers.indexOf(o[r]),f.triggers.splice(r,1),this.client.saveProfiles(),this.emit("item-removed","trigger",f.name,r)),f=null):this.client.echo("Event '"+g+"' not found.",-7,-8,!0,!0),null;case"button":case"bu":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===1){if(r=this.parseInline(this.stripQuotes(e[0])),o=document.getElementById("user-buttons").children,/^\s*?\d+\s*?$/.exec(r)){if(r=parseInt(r,10),r<0||r>=o.length)throw new Error("Button index must be >= 0 and < "+o.length);o[r].click()}else if(o[r])o[r].click();else throw new Error(`Button '${r}' not found`);return null}if(f=null,E=!0,p={profile:null,name:null,caption:null,commands:null,icon:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+n+"bu\x1B[0;-11;-12mtton name|index or \x1B[4m"+n+"bu\x1B[0;-11;-12mtton name \x1B[3mcaption\x1B[0;-11;-12m {commands} \x1B[3m{icon} options profile\x1B[0;-11;-12m or \x1B[4m"+n+"by\x1B[0;-11;-12mutton \x1B[3mcaption\x1B[0;-11;-12m {commands} \x1B[3m{icon} {options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid button name, caption or commands");if(e[0].match(/^\{[\s\S]*\}$/g))p.commands=e.shift(),p.commands=p.commands.substr(1,p.commands.length-2);else{if(p.name=this.parseInline(this.stripQuotes(e.shift())),!p.name||p.name.length===0)throw new Error("Invalid button name or caption");if(e[0].match(/^\{[\s\S]*\}$/g))p.commands=e.shift(),p.commands=p.commands.substr(1,p.commands.length-2);else if(p.caption=this.stripQuotes(e.shift()),!e[0].match(/^\{[\s\S]*\}$/g))throw new Error("Missing commands")}if(e.length!==0){if(e[0].match(/^\{.*\}$/g)&&(p.icon=e.shift(),p.icon=p.icon.substr(1,p.icon.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(_=>{switch(_.trim()){case"nosend":case"chain":case"append":case"stretch":case"disable":case"enable":p.options[_.trim()]=!0;break;default:if(_.trim().startsWith("pri=")||_.trim().startsWith("priority=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid button priority option '${_.trim()}'`);if(c=parseInt(g[1],10),isNaN(c))throw new Error("Invalid button priority value '"+g[1]+"' must be a number");p.options.priority=c}else throw new Error(`Invalid button option '${_.trim()}'`)}});else throw new Error("Invalid button options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(_=>{switch(_.trim()){case"nosend":case"chain":case"append":case"stretch":case"disable":case"enable":p.options[_.trim()]=!0;break;default:if(_.trim().startsWith("pri=")||_.trim().startsWith("priority=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid button priority option '${_.trim()}'`);if(c=parseInt(g[1],10),isNaN(c))throw new Error("Invalid button priority value '"+g[1]+"' must be a number");p.options.priority=c}else throw new Error(`Invalid button option '${_.trim()}'`)}});else throw new Error("Invalid button options");p.profile=this.stripQuotes(e[1]),p.profile.length!==0&&(p.profile=this.parseInline(p.profile))}}if(!p.profile||p.profile.length===0){let _=this.client.profiles.keys,C=0,L=_.length;if(L===0)return null;if(L===1){if(!this.client.profiles.items[_[0]].enabled||!this.client.profiles.items[_[0]].enableTriggers)throw Error("No enabled profiles found!");f=this.client.profiles.items[_[0]],p.name!==null?b=this.client.profiles.items[_[C]].find("buttons","name",p.name):b=this.client.profiles.items[_[C]].find("buttons","caption",p.caption)}else{for(;C<L;C++)if(!(!this.client.profiles.items[_[C]].enabled||!this.client.profiles.items[_[C]].enableTriggers||this.client.profiles.items[_[C]].triggers.length===0)&&(p.name!==null?b=this.client.profiles.items[_[C]].find("buttons","name",p.name):b=this.client.profiles.items[_[C]].find("buttons","caption",p.caption),b)){f=this.client.profiles.items[_[C]];break}f||(f=this.client.activeProfile)}}else{if(this.client.profiles.contains(p.profile))f=this.client.profiles.items[p.profile.toLowerCase()];else throw new Error("Profile not found: "+p.profile);p.name!==null?b=f.find("buttons","name",p.name):b=f.find("buttons","caption",p.caption)}return b?this.client.echo("Button '"+(b.name||b.caption||"")+"' updated.",-7,-8,!0,!0):(b=new me,b.name=p.name||"",b.caption=p.caption||"",f.buttons.push(b),!p.name&&!p.caption?this.client.echo("Button added.",-7,-8,!0,!0):this.client.echo("Button '"+(b.name||b.caption||"")+"' added.",-7,-8,!0,!0),p.new=!0),p.caption!==null&&(b.caption=p.caption),p.commands!==null&&(b.value=p.commands),p.options.icon&&(b.icon=p.options.icon),p.options.nosend&&(b.send=!1),p.options.chain&&(b.chain=!0),p.options.append&&(b.append=!0),p.options.stretch&&(b.stretch=!0),p.options.disable?b.enabled=!1:p.options.enable&&(b.enabled=!0),b.priority=p.options.priority,this.client.saveProfiles(),E&&this.client.clearCache(),p.new?this.emit("item-added","button",f.name,b):this.emit("item-updated","button",f.name,f.buttons.indexOf(b),b),f=null,null;case"unbutton":case"unb":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"unb\x1B[0;-11;-12mtton name or \x1B[4m"+n+"unb\x1B[0;-11;-12mtton {name} \x1B[3mprofile\x1B[0;-11;-12m");if(E=!0,f=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"unb\x1B[0;-11;-12mtton name or \x1B[4m"+n+"unb\x1B[0;-11;-12mtton {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(f=this.parseInline(this.stripQuotes(e[1])),this.client.profiles.contains(f))f=this.client.profiles.items[f.toLowerCase()];else throw new Error("Profile not found: "+f);else f=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?r=this.parseInline(this.stripQuotes(e[0])):r=this.parseInline(e[0].substr(1,e[0].length-2))}else r=this.parseInline(e.join(" ")),f=this.client.activeProfile;if(o=te(f.buttons),g=r,/^\s*?\d+\s*?$/.exec(r)){if(r=parseInt(r,10),r<0||r>=o.length)throw new Error("Button index must be >= 0 and < "+o.length);a=!0}else r=this.stripQuotes(r),r=o.findIndex(_=>_.name===r||_.caption===r),a=r!==-1;return a?(o[r].name.length===0&&o[r].caption.length===0?this.client.echo("Button '"+g+"' removed.",-7,-8,!0,!0):this.client.echo("Button '"+(o[r].name||o[r].caption)+"' removed.",-7,-8,!0,!0),r=f.buttons.indexOf(o[r]),f.buttons.splice(r,1),this.client.saveProfiles(),E&&this.client.clearCache(),this.emit("item-removed","button",f.name,r),f=null):this.client.echo("Button '"+g+"' not found.",-7,-8,!0,!0),null;case"alarm":case"ala":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),f=null,w=null,E=!0,r=!1,e.length<2||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+n+"ala\x1B[0;-11;-12mrm name {timepattern} {commands} \x1B[3mprofile\x1B[0;-11;-12m, \x1B[4m"+n+"ala\x1B[0;-11;-12mrm name {timepattern} \x1B[3mprofile\x1B[0;-11;-12m, or \x1B[4m"+n+"ala\x1B[0;-11;-12mrm {timepattern} {commands} \x1B[3mprofile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid name or timepattern");if(e[0].match(/^\{.*\}$/g)){if(e.length>3)throw new Error("Invalid syntax use \x1B[4m"+n+"ala\x1B[0;-11;-12mrm {timepattern} {commands} profile");if(e[0]=e[0].substr(1,e[0].length-2),e[0]=this.parseInline(e[0]),e[1].match(/^\{[\s\S]*\}$/g)&&(e[1]=e[1].substr(1,e[1].length-2)),e.length===3&&(f=this.stripQuotes(e[2]),f=this.parseInline(f)),!f||f.length===0)f=this.client.activeProfile;else if(this.client.profiles.contains(f))f=this.client.profiles.items[f.toLowerCase()];else throw new Error("Profile not found: "+f);return b=new Ie,b.pattern=e[0],b.value=e[1],b.type=3,f.triggers.push(b),this.client.saveProfiles(),E&&(this._lastSuspend=-1,this.client.updateAlarms()),this.client.echo("Alarm '"+b.pattern+"' added.",-7,-8,!0,!0),this.emit("item-added","trigger",f.name,b),f=null,null}if(w=this.stripQuotes(e[0]),!w||w.length===0)throw new Error("Invalid alarm name");w=this.parseInline(w);let M=e[1],B=null;if(M.match(/^\{.*\}$/g)&&(M=M.substr(1,M.length-2)),M=this.parseInline(M),e.length===3?e[2].match(/^\{[\s\S]*\}$/g)?B=e[2].substr(1,e[2].length-2):f=this.stripQuotes(e[2]):e.length===4&&(B=e[2],f=this.stripQuotes(e[3]),B.match(/^\{[\s\S]*\}$/g)&&(B=B.substr(1,B.length-2))),!f||f.length===0){let _=this.client.profiles.keys,C=0,L=_.length;if(L===0)return null;if(L===1){if(!this.client.profiles.items[_[0]].enabled||!this.client.profiles.items[_[0]].enableTriggers)throw Error("No enabled profiles found!");if(f=this.client.profiles.items[_[0]],b=f.find("triggers","name",w),!b&&!B)throw new Error("Alarm not found!");b?this.client.echo("Alarm '"+b.name+"' updated.",-7,-8,!0,!0):(b=new Ie,b.name=w,f.triggers.push(b),this.client.echo("Alarm '"+b.name+"' added.",-7,-8,!0,!0),r=!0)}else{for(;C<L;C++)if(!(!this.client.profiles.items[_[C]].enabled||!this.client.profiles.items[_[C]].enableTriggers||this.client.profiles.items[_[C]].triggers.length===0)&&(b=this.client.profiles.items[_[C]].find("triggers","name",w),b)){f=this.client.profiles.items[_[C]];break}if(!f&&!B)throw new Error("Alarm not found!");f||(f=this.client.activeProfile),b?this.client.echo("Alarm '"+b.name+"' updated.",-7,-8,!0,!0):(b=new Ie,r=!0,b.name=w,f.triggers.push(b),this.client.echo("Alarm '"+b.name+"' added.",-7,-8,!0,!0))}}else{if(f=this.parseInline(f),this.client.profiles.contains(f))f=this.client.profiles.items[f.toLowerCase()];else throw new Error("Profile not found: "+f);if(b=f.find("triggers","name",w),!b&&!B)throw new Error("Alarm not found!");b?this.client.echo("Alarm '"+b.name+"' updated.",-7,-8,!0,!0):(b=new Ie,b.name=w,f.triggers.push(b),r=!0,this.client.echo("Alarm '"+b.name+"' added.",-7,-8,!0,!0))}return b.pattern=M,b.type=3,B&&(b.value=B),this.client.saveProfiles(),r?this.emit("item-added","trigger",f.name,b):this.emit("item-updated","trigger",f.name,f.triggers.indexOf(b),b),f=null,E&&(this._lastSuspend=-1,this.client.updateAlarms()),null;case"ungag":case"ung":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length>0)throw new Error("Invalid syntax use \x1B[4m"+n+"ung\x1B[0;-11;-12mag number or \x1B[4m"+n+"ung\x1B[0;-11;-12mag");return this._gagID.length&&(clearTimeout(this._gagID.pop()),this._gags.pop()),this._gag=0,null;case"gag":case"ga":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)return this._gags.length&&this._gags[this._gags.length-1]==this.client.display.lines.length&&(this._gag=0,this._gags.pop()),this._gags.push(this.client.display.lines.length),this._gagID.push(setTimeout(()=>{if(r=this.adjustLastLine(this._gags.pop()),this._gags.length){let _=this._gags.length;for(;_>=0;)_--,this._gags[_]>r&&this._gags[_]--}this.client.display.removeLine(r)},0)),this._gag=0,null;if(e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"ga\x1B[0;-11;-12mg number or \x1B[4m"+n+"ga\x1B[0;-11;-12mg");if(c=parseInt(e[0],10),isNaN(c))throw new Error("Invalid number '"+e[0]+"'");return this._gags.length&&this._gags[this._gags.length-1]==this.client.display.lines.length&&(this._gag=0,this._gags.pop()),this._gags.push(this.client.display.lines.length),c>=0?(this._gagID.push(setTimeout(()=>{if(r=this.adjustLastLine(this._gags.pop()),this._gags.length){let _=this._gags.length;for(;_>=0;)_--,this._gags[_]>r&&this._gags[_]--}this.client.display.removeLine(r),this._gag=c},0)),this._gag=0):(this._gagID.push(setTimeout(()=>{r=this.adjustLastLine(this._gags.pop()),c*=-1,c>this.client.display.lines.length&&(c=this.client.display.lines.length),this.client.display.removeLines(r-c,c),this._gag=0},0)),this._gag=0),null;case"wait":case"wa":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e=e.filter(_=>_),e.length===0||e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"wa\x1B[0;-11;-12mit number");if(c=parseInt(this.parseInline(e[0]),10),isNaN(c))throw new Error("Invalid number '"+c+"' for wait");if(c<1)throw new Error("Must be greater then zero for wait");return c;case"showclient":case"showcl":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.show(),null;case"hideclient":case"hidecl":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.hide(),null;case"toggleclient":case"togglecl":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.toggle(),null;case"raiseevent":case"raise":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.getOption("parseDoubleQuotes")&&e.forEach(_=>_.replace(/^\"(.*)\"$/g,(C,L,R)=>L.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(_=>_.replace(/^\'(.*)\'$/g,(C,L,R)=>L.replace(/\\\'/g,"'"))),e.length===0)throw new Error("Invalid syntax use "+n+"\x1B[4mraise\x1B[0;-11;-12mevent name or "+n+"\x1B[4mraise\x1B[0;-11;-12mevent name arguments");return e.length===1?this.client.raise(e[0]):this.client.raise(e[0],e.slice(1)),null;case"window":case"win":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.getOption("parseDoubleQuotes")&&e.forEach(_=>_.replace(/^\"(.*)\"$/g,(C,L,R)=>L.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(_=>_.replace(/^\'(.*)\'$/g,(C,L,R)=>L.replace(/\\\'/g,"'"))),e.length===0||e.length>3)throw new Error("Invalid syntax use "+n+"\x1B[4mwin\x1B[0;-11;-12mdow name \x1B[3mclose\x1B[0;-11;-12m or "+n+"\x1B[4mwin\x1B[0;-11;-12mdow new \x1B[3mcharacter\x1B[0;-11;-12m");return e.length===3?this.client.emit("window",this.stripQuotes(this.parseInline(e[0])),this.stripQuotes(this.parseInline(e[1])),this.stripQuotes(this.parseInline(e.slice(2).join(" ")))):e.length===1?this.client.emit("window",this.stripQuotes(this.parseInline(e[0]))):this.client.emit("window",this.stripQuotes(this.parseInline(e[0])),this.stripQuotes(this.parseInline(e.slice(1).join(" ")))),null;case"raisedelayed":case"raisede":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"raisede\x1B[0;-11;-12mlayed milliseconds name or \x1B[4m"+n+"raisede\x1B[0;-11;-12mlayed milliseconds name arguments");if(c=parseInt(this.stripQuotes(this.parseInline(e[0])),10),isNaN(c))throw new Error("Invalid number '"+e[0]+"' for raisedelayed");if(c<1)throw new Error("Must be greater then zero for raisedelayed");return e.shift(),this.client.getOption("parseDoubleQuotes")&&e.forEach(_=>_.replace(/^\"(.*)\"$/g,(C,L,R)=>L.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(_=>_.replace(/^\'(.*)\'$/g,(C,L,R)=>L.replace(/\\\'/g,"'"))),e.length===1?this.client.raise(e[0],0,c):this.client.raise(e[0],e.slice(1),c),null;case"notify":case"not":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"not\x1B[0;-11;-12mify title \x1B[3mmessage icon\x1B[0;-11;-12m");if(e[0]=this.stripQuotes(e[0]),e[e.length-1].match(/^\{.*\}$/g)&&(p=e.pop(),r={icon:this.parseInline(p.substr(1,p.length-2))}),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"not\x1B[0;-11;-12mify title \x1B[3mmessage icon\x1B[0;-11;-12m");return e.length===1?this.client.notify(this.parseInline(this.stripQuotes(e[0])),null,r):this.client.notify(this.parseInline(this.stripQuotes(e[0])),this.parseInline(e.slice(1).join(" ")),r),null;case"idle":case"idletime":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.lastSendTime?this.client.echo("You have been idle: "+ui(Date.now()-this.client.lastSendTime),-7,-8,!0,!0):this.client.echo("Not connected",-7,-8,!0,!0),null;case"connect":case"connecttime":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.connectTime?this.client.echo("You have been connected: "+ui(Date.now()-this.client.connectTime),-7,-8,!0,!0):!moment&&this.client.disconnectTime?this.client.echo("Disconnected since: "+new Date(this.client.disconnectTime).toLocaleString(),-7,-8,!0,!0):this.client.disconnectTime?this.client.echo("Disconnected since: "+new moment(this.client.disconnectTime).format("MM/DD/YYYY hh:mm:ss A"),-7,-8,!0,!0):this.client.echo("Not connected",-7,-8,!0,!0),null;case"beep":case"be":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.beep(),null;case"version":case"ve":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.echo(this.client.telnet.terminal+" v"+this.client.version,-7,-8,!0,!0),null;case"showprompt":case"showp":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.telnet.receivedData(Ue(e),!0,!0),this.client.telnet.prompt=!0,null;case"show":case"sh":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e=this.parseInline(e.join(" ")+`
`),this.client.telnet.receivedData(Ue(e),!0,!0),null;case"sayprompt":case"sayp":case"echoprompt":case"echop":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.print("\x1B[-7;-8m"+e+"\x1B[0m",!1),null;case"say":case"sa":case"echo":case"ec":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"print":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),c=this.client.enableTriggers,this.client.enableTriggers=!1,e=this.parseInline(e.join(" ")),this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,this.client.enableTriggers=c,null;case"printprompt":case"printp":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),c=this.client.enableTriggers,this.client.enableTriggers=!1,e=this.parseInline(e.join(" ")),this.client.print("\x1B[-7;-8m"+e+"\x1B[0m",!1),this.client.enableTriggers=c,null;case"alias":case"al":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"al\x1B[0;-11;-12mias name value or \x1B[4m"+n+"al\x1B[0;-11;-12mias name {value} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===1)throw new Error("Must supply an alias value");if(r=this.parseInline(this.stripQuotes(e.shift())),E=!0,f=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"al\x1B[0;-11;-12mias name value or \x1B[4m"+n+"al\x1B[0;-11;-12mias name {value} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(f=this.parseInline(this.stripQuotes(e[1])),this.client.profiles.contains(f))f=this.client.profiles.items[f.toLowerCase()];else throw new Error("Profile not found: "+f);else f=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?e=this.parseInline(this.stripQuotes(e[0])):e=this.parseInline(e[0].substr(1,e[0].length-2))}else e=e.join(" "),f=this.client.activeProfile;if(o=f.aliases,e=this.stripQuotes(e),/^\s*?\d+\s*?$/.exec(r)){if(r=parseInt(r,10),r<0||r>=o.length)throw new Error("Alias index must be >= 0 and < "+o.length);o[r].value=e,this.client.echo("Alias '"+o[r].pattern+"' updated.",-7,-8,!0,!0)}else{for(c=0,h=o.length;c<h;c++)if(o[c].pattern===r){o[c].value=e,this.client.echo("Alias '"+r+"' updated.",-7,-8,!0,!0),this.emit("item-updated","alias",f.name,c,g),a=!0;break}a||(g=new Je(r,e),o.push(g),this.emit("item-added","alias",f.name,g),this.client.echo("Alias '"+r+"' added.",-7,-8,!0,!0))}return f.aliases=o,this.client.saveProfiles(),f=null,E&&this.client.clearCache(),null;case"unalias":case"una":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"una\x1B[0;-11;-12mlias name or \x1B[4m"+n+"una\x1B[0;-11;-12mlias {name} \x1B[3mprofile\x1B[0;-11;-12m");if(E=!0,f=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"una\x1B[0;-11;-12mlias name or \x1B[4m"+n+"una\x1B[0;-11;-12mlias {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(f=this.stripQuotes(e[1]),f=this.parseInline(f),this.client.profiles.contains(f))f=this.client.profiles.items[f.toLowerCase()];else throw new Error("Profile not found: "+f);else f=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?r=this.parseInline(this.stripQuotes(e[0])):r=this.parseInline(e[0].substr(1,e[0].length-2))}else r=this.parseInline(e.join(" ")),f=this.client.activeProfile;if(o=f.aliases,r=this.stripQuotes(r),/^\s*?\d+\s*?$/.exec(r)){if(g=r,r=parseInt(r,10),r<0||r>=o.length)throw new Error("Alias index must be >= 0 and < "+o.length);a=!0}else g=r,r=o.findIndex(_=>_.pattern===r),a=r!==-1;return a?(this.client.echo("Alias '"+o[r].pattern+"' removed.",-7,-8,!0,!0),o.splice(r,1),f.aliases=o,this.client.saveProfiles(),E&&this.client.clearCache(),f=null,this.emit("item-removed","alias",f.name,r)):this.client.echo("Alias '"+g+"' not found.",-7,-8,!0,!0),null;case"setsetting":case"sets":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"sets\x1B[0;-11;-12metting name value");if(e.length===1)throw new Error("Must supply a setsetting value");if(r=this.stripQuotes(this.parseInline(e[0])),e=this.stripQuotes(this.parseInline(e.slice(1).join(" "))),/^\s*?\d+\s*?$/.exec(r)){if(g=r,r=parseInt(r,10),r<0||r>=ee.length)throw new Error("Setting index must be >= 0 and < "+ee.length);a=!0}else for(r=r.toLowerCase(),c=0,h=ee.length;c<h;c++)if(ee[c][0].toLowerCase()===r){r=c,a=!0;break}if(a)switch(ee[r][2]){case 0:if(ee[r][4]>0&&e.length>ee[r][4])throw new Error("String can not be longer then "+ee[r][4]+" characters");this.client.setOption(ee[r][1]||ee[r][0],e),this.client.echo("Setting '"+ee[r][0]+"' set to '"+e+"'.",-7,-8,!0,!0),this.client.loadOptions();break;case 1:case 3:switch(e.toLowerCase()){case"true":case"1":case"yes":this.client.setOption(ee[r][1]||ee[r][0],!0),this.client.echo("Setting '"+ee[r][0]+"' set to true.",-7,-8,!0,!0),this.client.loadOptions();break;case"no":case"false":case"0":this.client.setOption(ee[r][1]||ee[r][0],!1),this.client.echo("Setting '"+ee[r][0]+"' set to false.",-7,-8,!0,!0),this.client.loadOptions();break;case"toggle":e=!this.client.getOption(ee[r][1]||ee[r][0]),this.client.setOption(ee[r][1]||ee[r][0],e),this.client.echo("Setting '"+ee[r][0]+"' set to "+e+".",-7,-8,!0,!0),this.client.loadOptions();break;default:throw new Error("Invalid value, must be true or false")}break;case 2:if(c=parseInt(e,10),isNaN(c))throw new Error("Invalid number '"+e+"'");this.client.setOption(ee[r][1]||ee[r][0],c),this.client.echo("Setting '"+ee[r][0]+"' set to '"+c+"'.",-7,-8,!0,!0),this.client.loadOptions();break;case 4:case 5:throw new Error("Unsupported setting '"+r+"'")}else throw new Error("Unknown setting '"+g+"'");return null;case"getsetting":case"gets":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"gets\x1B[0;-11;-12metting name");if(r=this.stripQuotes(this.parseInline(e.join(" "))),/^\s*?\d+\s*?$/.exec(r)){if(r=parseInt(r,10),r<0||r>=ee.length)throw new Error("Setting index must be >= 0 and < "+ee.length);a=!0}else{if(g=r,r=r.toLowerCase(),r!=="all"){for(c=0,h=ee.length;c<h;c++)if(ee[c][0].toLowerCase()===r){r=c,a=!0;break}}if(r==="all"){for(g=`Current settings:
`,c=0,h=ee.length;c<h;c++)switch(ee[c][2]){case 0:case 2:g+="    "+ee[c][0]+": "+this.client.getOption(ee[r][1]||ee[r][0])+`
`;break;case 1:case 3:this.client.getOption(ee[r][1]||ee[r][0])?g+="    "+ee[c][0]+`: true
`:g+="    "+ee[c][0]+`: false
`;break}this.client.echo(g,-7,-8,!0,!0)}else if(a)switch(ee[r][2]){case 0:case 2:this.client.echo("Setting '"+ee[r][0]+"' is '"+this.client.getOption(ee[r][1]||ee[r][0])+"'",-7,-8,!0,!0);break;case 1:case 3:this.client.getOption(ee[r][1]||ee[r][0])?this.client.echo("Setting '"+ee[r][0]+"' is true",-7,-8,!0,!0):this.client.echo("Setting '"+ee[r][0]+"' is false",-7,-8,!0,!0);break}else throw new Error("Unknown setting '"+r+"'")}return null;case"profilelist":(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.echo("\x1B[4mProfiles:\x1B[0m",-7,-8,!0,!0);let I=this.client.profiles.keys;for(h=I.length,c=0;c<h;c++)this.client.profiles.items[I[c]]&&this.client.profiles.items[I[c]].enabled?this.client.echo("   "+this.client.profiles.keys[c]+" is enabled",-7,-8,!0,!0):this.client.echo("   "+I[c]+" is disabled",-7,-8,!0,!0);return null;case"profile":case"pro":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name enable/disable");if(e.length===1){if(e[0]=this.parseInline(e[0]),this.client.toggleProfile(e[0]),this.client.profiles.contains(e[0])){if(this.client.profiles.length===1)throw new Error(e[0]+" can not be disabled as it is the only one enabled")}else throw new Error("Profile not found");this.client.profiles.contains(e[0].toLowerCase())?this.client.profiles.items[e[0].toLowerCase()].enabled?e=e[0]+" is enabled":e=e[0]+" is disabled":e="Profile not found"}else{if(e[0]=this.parseInline(e[0]).toLowerCase(),!this.client.profiles.contains(e[0]))throw new Error("Profile not found");if(!e[1])throw new Error("Invalid syntax use \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name enable/disable");switch(e[1]=this.parseInline(e[1]),e[1].toLowerCase()){case"enable":case"on":case"yes":this.client.profiles.items[e[0].toLowerCase()].enabled?e=e[0]+" is already enabled":(this.client.toggleProfile(e[0]),this.client.profiles.items[e[0].toLowerCase()].enabled!==-1?e=e[0]+" is enabled":e=e[0]+" remains disabled");break;case"disable":case"off":case"no":if(!this.client.profiles.items[e[0].toLowerCase()].enabled)e=e[0]+" is already disabled";else{if(this.client.profiles.length===1)throw new Error(e[0]+" can not be disabled as it is the only one enabled");this.client.toggleProfile(e[0]),e=e[0]+" is disabled"}break;default:throw new Error("Invalid syntax use \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name enable/disable")}}return this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"color":case"co":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length>1&&e.length<4)return p={profile:null,pattern:null,commands:null},p.pattern=e.shift(),p.pattern.match(/^\{.*\}$/g)?p.pattern=this.parseInline(p.pattern.substr(1,p.pattern.length-2)):p.pattern=this.parseInline(this.stripQuotes(p.pattern)),e.length===2?(p.commands=n+"COLOR "+this.parseInline(e[0]),p.profile=this.stripQuotes(e[1]),p.profile.length!==0&&(p.profile=this.parseInline(p.profile))):p.commands=n+"COLOR "+this.parseInline(e[0]),this.createTrigger(p.pattern,p.commands,p.profile),null;if(e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+n+"co\x1B[0;-11;-12mlor color or \x1B[4m"+n+"co\x1B[0;-11;-12mlor {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+n+"co\x1B[0;-11;-12mlor color or \x1B[4m"+n+"co\x1B[0;-11;-12mlor {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(e[0]=this.parseInline(this.stripQuotes(e[0])),r=this.client.display.lines.length,e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{r=this.adjustLastLine(r),this.client.display.colorSubStrByLine(r,parseInt(e[0],10))},0);else if(e[0].trim().match(/^[-|+]?\d+\s*?,\s*?[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{r=this.adjustLastLine(r),this.client.display.colorSubStrByLine(r,parseInt(e[0][0],10),parseInt(e[0][1],10))},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(c=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[0].trim(),10);else if(c=de(e[0]),c===-1)if(Ce(e[0]))c=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{r=this.adjustLastLine(r),this.client.display.colorSubStrByLine(r,c)},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")c=370;else if(e[0]==="current")c=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[0].trim(),10);else if(c=de(e[0]),c===-1)if(Ce(e[0]))c=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{r=this.adjustLastLine(r),c===370?this.client.display.colorSubStrByLine(r,c):this.client.display.colorSubStrByLine(r,c*10)},0);else{if(k=c,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[1].trim(),10);else if(c=de(e[1],!0),c===-1)if(Ce(e[1]))c=e[1];else throw new Error("Invalid back color");setTimeout(()=>{r=this.adjustLastLine(r),this.client.display.colorSubStrByLine(r,k,c)},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")c=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[0].trim(),10);else if(c=de(e[0]),c===-1)if(Ce(e[0]))c=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(c?k=c*10:c=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[1].trim(),10);else if(c=de(e[1],!0),c===-1)if(Ce(e[1]))c=e[0];else throw new Error("Invalid back color");setTimeout(()=>{r=this.adjustLastLine(r),this.client.display.colorSubStrByLine(r,k,c)},0)}return null;case"cw":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),b=this.stack.regex,e.length>1&&e.length<4)return p={profile:null,pattern:null,commands:null},p.pattern=e.shift(),p.pattern.match(/^\{.*\}$/g)?p.pattern=this.parseInline(p.pattern.substr(1,p.pattern.length-2)):p.pattern=this.parseInline(this.stripQuotes(p.pattern)),e.length===2?(p.commands=n+"CW "+this.parseInline(e[0]),p.profile=this.stripQuotes(e[1]),p.profile.length!==0&&(p.profile=this.parseInline(p.profile))):p.commands=n+"CW "+this.parseInline(e[0]),this.createTrigger(p.pattern,p.commands,p.profile),null;if(e.length!==1)throw new Error("Invalid syntax use "+n+"cw color or "+n+"cw {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(!b)return null;if(e[0]=this.parseInline(this.stripQuotes(e[0])),r=this.client.display.lines.length,e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{if(r=this.adjustLastLine(r),b.length===1)this.client.display.colorSubStrByLine(r,parseInt(e[0],10));else{b[1].lastIndex=0,g=b[0].matchAll(b[1]);for(let _ of g)this.client.display.colorSubStrByLine(r,parseInt(e[0],10),null,_.index,_[0].length)}},0);else if(e[0].trim().match(/^[-|+]?\d+,[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{if(r=this.adjustLastLine(r),b.length===1)this.client.display.colorSubStrByLine(r,parseInt(e[0][0],10),parseInt(e[0][1],10));else{b[1].lastIndex=0,g=b[0].matchAll(b[1]);for(let _ of g)this.client.display.colorSubStrByLine(r,parseInt(e[0],10),parseInt(e[0][1],10),_.index,_[0].length)}},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(c=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[0].trim(),10);else if(c=de(e[0]),c===-1)if(Ce(e[0]))c=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{if(r=this.adjustLastLine(r),b.length===1)this.client.display.colorSubStrByLine(r,c);else{b[1].lastIndex=0,g=b[0].matchAll(b[1]);for(let _ of g)this.client.display.colorSubStrByLine(r,c,null,_.index,_[0].length)}},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")c=370;else if(e[0]==="current")c=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[0].trim(),10);else if(c=de(e[0]),c===-1)if(Ce(e[0]))c=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{if(r=this.adjustLastLine(r),c!==370&&(c*=10),b.length===1)this.client.display.colorSubStrByLine(r,c);else{b[1].lastIndex=0,g=b[0].matchAll(b[1]);for(let _ of g)this.client.display.colorSubStrByLine(r,c,null,_.index,_[0].length)}},0);else{if(k=c,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[1].trim(),10);else if(c=de(e[1],!0),c===-1)if(Ce(e[1]))c=e[1];else throw new Error("Invalid back color");setTimeout(()=>{if(r=this.adjustLastLine(r),b.length===1)this.client.display.colorSubStrByLine(r,k,c);else{b[1].lastIndex=0,g=b[0].matchAll(b[1]);for(let _ of g)this.client.display.colorSubStrByLine(r,k,c,_.index,_[0].length)}},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")c=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[0].trim(),10);else if(c=de(e[0]),c===-1)if(Ce(e[0]))c=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(c?k=c*10:c=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[1].trim(),10);else if(c=de(e[1],!0),c===-1)if(Ce(e[1]))c=e[0];else throw new Error("Invalid back color");setTimeout(()=>{if(r=this.adjustLastLine(r),b.length===1)this.client.display.colorSubStrByLine(r,k,c);else{b[1].lastIndex=0,g=b[0].matchAll(b[1]);for(let _ of g)this.client.display.colorSubStrByLine(r,k,c,_.index,_[0].length)}},0)}return null;case"pcol":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length<1||e.length>5)throw new Error("Invalid syntax use "+n+"pcol color \x1B[3mXStart, XEnd, YStart, YEnd\x1B[0;-11;-12m");if(e.length>1){if(g=[].concat(...e.slice(1).map(_=>this.parseInline(this.stripQuotes(_)).split(" "))),g.length>4)throw new Error("Too many arguments use "+n+"pcol color \x1B[3mXStart, XEnd, YStart, YEnd\x1B[0;-11;-12m");if(p={xStart:0},g.length>0&&(p.xStart=parseInt(g[0],10)),g.length>1&&(p.xEnd=parseInt(g[1],10)),g.length>2&&(p.yStart=parseInt(g[2],10)),g.length>3&&(p.yEnd=parseInt(g[3],10)),p.hasOwnProperty("yEnd")&&p.yEnd>p.yStart)throw new Error("yEnd must be smaller or equal to yStart");if(p.hasOwnProperty("xEnd")&&p.xEnd<p.xStart)throw new Error("xEnd must be larger or equal to xStart")}else p={xStart:0};if(e[0]=this.parseInline(this.stripQuotes(e[0])),r=this.adjustLastLine(this.client.display.lines.length),e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{this.colorPosition(r,parseInt(e[0],10),null,p)},0);else if(e[0].trim().match(/^[-|+]?\d+\s*?,\s*?[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{this.colorPosition(r,parseInt(e[0][0],10),parseInt(e[0][1],10),p)},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(c=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[0].trim(),10);else if(c=de(e[0]),c===-1)if(Ce(e[0]))c=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{this.colorPosition(r,c,null,p)},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")c=370;else if(e[0]==="current")c=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[0].trim(),10);else if(c=de(e[0]),c===-1)if(Ce(e[0]))c=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{this.colorPosition(r,c===370?c:c*10,null,p)},0);else{if(k=c,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[1].trim(),10);else if(c=de(e[1],!0),c===-1)if(Ce(e[1]))c=e[1];else throw new Error("Invalid back color");setTimeout(()=>{this.colorPosition(r,k,c,p)},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")c=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[0].trim(),10);else if(c=de(e[0]),c===-1)if(Ce(e[0]))c=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(c?k=c*10:c=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))c=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))c=parseInt(e[1].trim(),10);else if(c=de(e[1],!0),c===-1)if(Ce(e[1]))c=e[0];else throw new Error("Invalid back color");setTimeout(()=>{this.colorPosition(r,k,c,p)},0)}return null;case"highlight":case"hi":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length>0&&e.length<2)return p={profile:null,pattern:null,commands:n+"HIGHLIGHT"},p.pattern=e.shift(),p.pattern.match(/^\{.*\}$/g)?p.pattern=this.parseInline(p.pattern.substr(1,p.pattern.length-2)):p.pattern=this.parseInline(this.stripQuotes(p.pattern)),e.length===1&&(p.profile=this.parseInline(this.stripQuotes(e[0]))),this.createTrigger(p.pattern,p.commands,p.profile),null;if(e.length)throw new Error("Too many arguments use \x1B[4m"+n+"hi\x1B[0;-11;-12mghlight \x1B[3mpattern profile\x1B[0;-11;-12m");return r=this.client.display.lines.length,setTimeout(()=>{r=this.adjustLastLine(r),this.client.display.highlightSubStrByLine(r)},0),null;case"break":case"br":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use \x1B[4m"+n+"br\x1B[0;-11;-12meak\x1B[0;-11;-12m");if(!this.loops.length)throw new Error("\x1B[4m"+n+"br\x1B[0;-11;-12meak\x1B[0;-11;-12m must be used in a loop.");return this.stack.break?this.stack.break++:this.stack.break=1,-1;case"continue":case"cont":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use \x1B[4m"+n+"cont\x1B[0;-11;-12minue\x1B[0;-11;-12m");if(!this.loops.length)throw new Error("\x1B[4m"+n+"cont\x1B[0;-11;-12minue\x1B[0;-11;-12m must be used in a loop.");return this.stack.continue=!0,-2;case"if":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),!e.length||e.length>3)throw new Error("Invalid syntax use "+n+"if {expression} {true-command} \x1B[3m{false-command}\x1B[0;-11;-12m");return e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),g=null,this.evaluate(this.parseInline(e[0]))?(e[1].match(/^\{[\s\S]*\}$/g)&&(e[1]=e[1].substr(1,e[1].length-2)),g=this.parseOutgoing(e[1])):e.length>2&&(e[2].match(/^\{[\s\S]*\}$/g)&&(e[2]=e[2].substr(1,e[2].length-2)),g=this.parseOutgoing(e[2])),g!=null&&g.length>0?g:null;case"case":case"ca":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),!e.length||e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"ca\x1B[0;-11;-12mse\x1B[0;-11;-12m index {command 1} \x1B[3m{command n}\x1B[0;-11;-12m");return e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),r=this.evaluate(this.parseInline(e[0])),typeof r!="number"?null:r>0&&r<e.length&&(e[r].match(/^\{[\s\S]*\}$/g)&&(e[r]=e[r].substr(1,e[r].length-2)),g=this.parseOutgoing(e[r]),g!=null&&g.length>0)?g:null;case"switch":case"sw":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),!e.length||e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"sw\x1B[0;-11;-12mitch\x1B[0;-11;-12m (expression) {command} \x1B[3m(expression) {command} ... {else_command}\x1B[0;-11;-12m");for(e.length%2===1?r=e.pop():r=null,h=e.length,c=0;c<h;c+=2)if(e[c].match(/^\{[\s\S]*\}$/g)&&(e[c]=e[c].substr(1,e[c].length-2)),this.evaluate(this.parseInline(e[c])))return e[c+1].match(/^\{[\s\S]*\}$/g)&&(e[c+1]=e[c+1].substr(1,e[c+1].length-2)),g=this.parseOutgoing(e[c+1]),g!=null&&g.length>0?g:null;return r&&(r.match(/^\{[\s\S]*\}$/g)&&(r=r.substr(1,r.length-2)),g=this.parseOutgoing(r),g!=null&&g.length>0)?g:null;case"loop":case"loo":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"loo\x1B[0;-11;-12mp\x1B[0;-11;-12m range {commands}");if(r=this.parseInline(e.shift()).split(","),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),r.length===1){if(g=parseInt(r[0],10),isNaN(g))throw new Error("Invalid loop range '"+r[0]+"' must be a number");return this.executeForLoop(0,g,e)}if(g=parseInt(r[0],10),isNaN(g))throw new Error("Invalid loop min '"+r[0]+"' must be a number");if(c=parseInt(r[1],10),isNaN(c))throw new Error("Invalid loop max '"+r[1]+"' must be a number");return g>c?g++:g--,this.executeForLoop(g,c,e);case"repeat":case"rep":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"rep\x1B[0;-11;-12meat\x1B[0;-11;-12m expression {commands}");if(c=e.shift(),c.match(/^\{[\s\S]*\}$/g)&&(c=c.substr(1,c.length-2)),c=this.evaluate(this.parseInline(c)),typeof c!="number")throw new Error("Arguments must be a number");return e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),c<1?this.executeForLoop(-c+1,1,e):this.executeForLoop(0,c,e);case"until":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use "+n+"until expression {commands}");for(c=e.shift(),c.match(/^\{[\s\S]*\}$/g)&&(c=c.substr(1,c.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),g=[],this.loops.push(0);!this.evaluate(this.parseInline(c));){let _=this.parseOutgoing(e);if(_!=null&&_.length>0&&g.push(_),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}return this.loops.pop(),g.length>0?g.map(_=>_.trim()).join(`
`):null;case"while":case"wh":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"wh\x1B[0;-11;-12mile expression {commands}");for(c=e.shift(),c.match(/^\{[\s\S]*\}$/g)&&(c=c.substr(1,c.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),g=[],this.loops.push(0);this.evaluate(this.parseInline(c));){let _=this.parseOutgoing(e);if(_!=null&&_.length>0&&g.push(_),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}return this.loops.pop(),g.length>0?g.map(_=>_.trim()).join(`
`):null;case"forall":case"fo":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"fo\x1B[0;-11;-12mrall stringlist {commands}");for(c=e.shift(),c.match(/^\{[\s\S]*\}$/g)&&(c=c.substr(1,c.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),g=[],c=this.splitByQuotes(this.stripQuotes(this.parseInline(c)),"|"),h=c.length,r=0;r<h;r++){this.loops.push(c[r]);let _=this.parseOutgoing(e);if(_!=null&&_.length>0&&g.push(_),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}this.loops.pop()}return g.length>0?g.map(_=>_.trim()).join(`
`):null;case"variable":case"var":case"va":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0){for(c=Object.keys(this.client.variables),h=c.length,g=[],r=0;r<h;r++)g.push(c[r]+" = "+this.client.variables[c[r]]);return g.join(`
`)}if(c=e.shift(),c.match(/^\{.*\}$/g)&&(c=c.substr(1,c.length-2)),c=this.parseInline(c),!He(c))throw new Error("Invalid variable name");return e.length===0?this.client.variables[c]?.toString():(e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.parseInline(e),e.match(/^\s*?[-|+]?\d+\s*?$/)?this.client.variables[c]=parseInt(e,10):e.match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?this.client.variables[c]=parseFloat(e):e==="true"?this.client.variables[c]=!0:e==="false"?this.client.variables[c]=!1:this.client.variables[c]=this.stripQuotes(e),null);case"unvar":case"unv":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+n+"unv\x1B[0;-11;-12mar name ");return c=e.shift(),c.match(/^\{[\s\S]*\}$/g)&&(c=c.substr(1,c.length-2)),c=this.parseInline(c),delete this.client.variables[c],null;case"add":case"ad":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"ad\x1B[0;-11;-12md name value");if(c=e.shift(),c.match(/^\{[\s\S]*\}$/g)&&(c=c.substr(1,c.length-2)),c=this.parseInline(c),this.client.variables.hasOwnProperty(c)&&typeof this.client.variables[c]!="number")throw new Error(c+" is not a number for add");if(e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.evaluate(this.parseInline(e)),typeof e!="number")throw new Error("Value is not a number for add");return this.client.variables.hasOwnProperty(c)?this.client.variables[c]+=e:this.client.variables[c]=e,null;case"math":case"mat":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"mat\x1B[0;-11;-12mh name value");if(c=e.shift(),c.match(/^\{[\s\S]*\}$/g)&&(c=c.substr(1,c.length-2)),c=this.parseInline(c),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.evaluate(this.parseInline(e)),typeof e!="number")throw new Error("Value is not a number for add");return this.client.variables[c]=e,null;case"evaluate":case"eva":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"eva\x1B[0;-11;-12mluate expression");return e=this.evaluate(this.parseInline(e.join(" "))),this.client.getOption("ignoreEvalUndefined")&&typeof e>"u"?e="":e=""+e,this.client.telnet.prompt?this.client.print(`
`+e+`\x1B[0m
`,!1):this.client.print(e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"freeze":case"fr":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)this.scrollLock=!this.scrollLock,this.scrollLock?this.client.display.scrollAtBottom&&this.client.display.scrollUp():this.client.display.scrollDisplay();else if(e.length===1)e[0]==="0"||e[0]==="false"?this.scrollLock&&(this.scrollLock=!1,this.client.display.scrollDisplay()):this.scrollLock||(this.scrollLock=!0,this.client.display.scrollAtBottom&&this.client.display.scrollUp());else if(e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"fr\x1B[0;-11;-12meeze \x1B[3mnumber\x1B[0;-11;-12m");return null;case"clr":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use "+n+"CLR");if(this.client.display.lines.length===0)return null;for(c=this.client.display.WindowSize.height+2,r=this.client.display.lines.length;r--&&c&&!this.client.display.lines[r].text.length;)c--;for(g=[];c--;)g.push(`
`);return this.client.print(g.join(""),!0),null;case"fire":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e=this.parseInline(e.join(" ")+`
`),this.ExecuteTriggers(140,e,e,!1,!1),null;case"state":case"sta":switch((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e=e.map(_=>!_||!_.length?_:_.match(/^\{.*\}$/g)?this.parseInline(_.substr(1,_.length-2)):this.parseInline(this.stripQuotes(_))),e.length){case 0:throw new Error("Invalid syntax use \x1B[4m"+n+"sta\x1B[0;-11;-12mte \x1B[3m name|pattern state profile\x1B[0;-11;-12m");case 1:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");b=this._LastTrigger,r=b.state,b.state=parseInt(e[0],10)}else{let _=this.client.profiles.keys,C=0,L=_.length;if(L===0)return null;if(L===1){if(!this.client.profiles.items[_[0]].enabled||!this.client.profiles.items[_[0]].enableTriggers)throw Error("No enabled profiles found!");b=te(this.client.profiles.items[_[C]].triggers),b=b.find(R=>R.name===e[0]||R.pattern===e[0])}else for(;C<L&&!(!(!this.client.profiles.items[_[C]].enabled||!this.client.profiles.items[_[C]].enableTriggers||this.client.profiles.items[_[C]].triggers.length===0)&&(b=te(this.client.profiles.items[_[C]].triggers),b=b.find(R=>R.name===e[0]||R.pattern===e[0]),b));C++);if(!b)throw new Error("Trigger not found: "+e[0]);r=b.state,b.state=0}break;case 2:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/))throw new Error("Invalid argument to "+n+"state, first argument must be name|pattern");if(e[1].match(/^\s*?[-|+]?\d+\s*?$/)){let _=this.client.profiles.keys,C=0,L=_.length;if(L===0)return null;if(L===1){if(!this.client.profiles.items[_[0]].enabled||!this.client.profiles.items[_[0]].enableTriggers)throw Error("No enabled profiles found!");b=te(this.client.profiles.items[_[C]].triggers),b=b.find(R=>R.name===e[0]||R.pattern===e[0])}else for(;C<L&&!(!(!this.client.profiles.items[_[C]].enabled||!this.client.profiles.items[_[C]].enableTriggers||this.client.profiles.items[_[C]].triggers.length===0)&&(b=te(this.client.profiles.items[_[C]].triggers),b=b.find(R=>R.name===e[0]||R.pattern===e[0]),b));C++);if(!b)throw new Error("Trigger not found: "+e[0]);r=b.state,b.state=parseInt(e[1],10)}else{if(f=e[1],this.client.profiles.contains(f))f=this.client.profiles.items[f.toLowerCase()];else throw new Error("Profile not found: "+e[1]);if(b=te(f.triggers),b=b.find(_=>_.name===e[0]||_.pattern===e[0]),!b)throw new Error("Trigger not found: "+e[0]+" in profile: "+f.name);r=b.state,b.state=0}break;case 3:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/))throw new Error("Invalid argument to "+n+"state, first argument must be name|pattern");if(f=e[2],this.client.profiles.contains(f))f=this.client.profiles.items[f.toLowerCase()];else throw new Error("Profile not found: "+e[2]);if(b=te(f.triggers),b=b.find(_=>_.name===e[0]||_.pattern===e[0]),!b)throw new Error("Trigger not found: "+e[0]);r=b.state,b.state=parseInt(e[1],10);break;default:throw new Error("Invalid syntax use \x1B[4m"+n+"sta\x1B[0;-11;-12mte \x1B[3m name|pattern state profile\x1B[0;-11;-12m")}if(b.state<0||b.state>b.triggers.length)throw b.state=r,new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+b.triggers.length);return c=b.fired,b.fired=!1,this.resetTriggerState(this._TriggerCache.indexOf(b),r,c),this.client.restartAlarmState(b,r,b.state),this.client.saveProfiles(),this.client.emit("item-updated","trigger",b.profile.name,b.profile.triggers.indexOf(b),b),this.client.echo("Trigger state set to "+b.state+".",-7,-8,!0,!0),null;case"set":switch((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e=e.map(_=>!_||!_.length?_:_.match(/^\{.*\}$/g)?this.parseInline(_.substr(1,_.length-2)):this.parseInline(this.stripQuotes(_))),r=0,c=!1,e.length){case 0:throw new Error("Invalid syntax use "+n+"set \x1B[3mname|pattern\x1B[0;-11;-12m state \x1B[3mvalue profile\x1B[0;-11;-12m");case 1:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");if(b=this._LastTrigger,r=parseInt(e[0],10),r<0||r>b.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+b.triggers.length);r===0?(c=b.fired,b.fired=!0):(c=b.triggers[r-1].fired,b.triggers[r-1].fired=!0)}else throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+b.triggers.length);break;case 2:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");if(b=this._LastTrigger,r=parseInt(e[0],10),r<0||r>b.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+b.triggers.length);if(e[1]!=="0"&&e[1]!=="1"&&e[1]!=="true"&&e[1]!=="false")throw new Error("Value must be 0, 1, true, or false");r===0?(c=b.fired,b.fired=e[1]==="1"||e[1]==="true"):(c=b.triggers[r-1].fired,b.triggers[r-1].fired=e[1]==="1"||e[1]==="true")}else{let _=this.client.profiles.keys,C=0,L=_.length;if(L===0)return null;if(L===1){if(!this.client.profiles.items[_[0]].enabled||!this.client.profiles.items[_[0]].enableTriggers)throw Error("No enabled profiles found!");b=te(this.client.profiles.items[_[C]].triggers),b=b.find(R=>R.name===e[0]||R.pattern===e[0])}else for(;C<L&&!(!(!this.client.profiles.items[_[C]].enabled||!this.client.profiles.items[_[C]].enableTriggers||this.client.profiles.items[_[C]].triggers.length===0)&&(b=te(this.client.profiles.items[_[C]].triggers),b=b.find(R=>R.name===e[0]||R.pattern===e[0]),b));C++);if(!b)throw new Error("Trigger not found: "+e[0]);if(r=parseInt(e[1],10),r<0||r>b.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+b.triggers.length);r===0?(c=b.fired,b.fired=!0):(c=b.triggers[r-1].fired,b.triggers[r-1].fired=!0)}break;case 3:if(e[2]==="0"&&e[2]!=="1"&&e[2]!=="true"&&e[21]!=="false"){if(f=e[2],this.client.profiles.contains(f))f=this.client.profiles.items[f.toLowerCase()];else throw new Error("Profile not found: "+f);if(b=te(f.triggers),b=b.find(_=>_.name===e[0]||_.pattern===e[0]),!b)throw new Error("Trigger not found: "+e[0]+" in profile: "+f.name);if(r=parseInt(e[1],10),r<0||r>b.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+b.triggers.length);r===0?(c=b.fired,b.fired=!0):(c=b.triggers[r-1].fired,b.triggers[r-1].fired=!0)}else{let _=this.client.profiles.keys,C=0,L=_.length;if(L===0)return null;if(L===1){if(!this.client.profiles.items[_[0]].enabled||!this.client.profiles.items[_[0]].enableTriggers)throw Error("No enabled profiles found!");b=te(this.client.profiles.items[_[C]].triggers),b=b.find(R=>R.name===e[0]||R.pattern===e[0])}else for(;C<L&&!(!(!this.client.profiles.items[_[C]].enabled||!this.client.profiles.items[_[C]].enableTriggers||this.client.profiles.items[_[C]].triggers.length===0)&&(b=te(this.client.profiles.items[_[C]].triggers),b=b.find(R=>R.name===e[0]||R.pattern===e[0]),b));C++);if(!b)throw new Error("Trigger not found: "+e[0]);if(r=parseInt(e[1],10),r<0||r>b.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+b.triggers.length);r===0?(c=b.fired,b.fired=e[2]==="1"||e[2]==="true"):(c=b.triggers[r-1].fired,b.triggers[r-1].fired=e[2]==="1"||e[2]==="true")}break;case 4:if(f=e[2],this.client.profiles.contains(f))f=this.client.profiles.items[f.toLowerCase()];else throw new Error("Profile not found: "+f);if(b=te(f.triggers),b=b.find(_=>_.name===e[0]||_.pattern===e[0]),!b)throw new Error("Trigger not found: "+e[0]+" in profile: "+f.name);if(e[2]!=="0"&&e[2]!=="1"&&e[2]!=="true"&&e[2]!=="false")throw new Error("Value must be 0, 1, true, or false");r===0?(c=b.fired,b.fired=e[2]==="1"||e[2]==="true"):(c=b.triggers[r-1].fired,b.triggers[r-1].fired=e[2]==="1"||e[2]==="true");break;default:throw new Error("Invalid syntax use "+n+"set \x1B[3mname|pattern\x1B[0;-11;-12m state \x1B[3mvalue profile\x1B[0;-11;-12m")}return this.client.saveProfiles(),this.client.emit("item-updated","trigger",b.profile.name,b.profile.triggers.indexOf(b),b),this.resetTriggerState(this._TriggerCache.indexOf(b),r,c),r===0?this.client.echo("Trigger state 0 fired state set to "+b.fired+".",-7,-8,!0,!0):(this.client.echo("Trigger state "+r+" fired state set to "+b.triggers[r-1].fired+".",-7,-8,!0,!0),b.enabled&&b.triggers[r-1].enabled&&b.triggers[r-1].type===65536&&(this._LastTriggered="",this.ExecuteTrigger(b,[],!1,this._TriggerCache.indexOf(b),0,0,b))),null;case"condition":case"cond":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),p={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+n+"cond\x1B[0;-11;-12mition name|pattern {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or \x1B[4m"+n+"cond\x1B[0;-11;-12mition {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid trigger name or pattern");if(e[0].match(/^\{.*\}$/g))p.pattern=e.shift(),p.pattern=this.parseInline(p.pattern.substr(1,p.pattern.length-2));else{if(p.name=this.parseInline(this.stripQuotes(e.shift())),!p.name||p.name.length===0)throw new Error("Invalid trigger name");e[0].match(/^\{.*\}$/g)&&(p.pattern=e.shift(),p.pattern=this.parseInline(p.pattern.substr(1,p.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(p.commands=e.shift(),p.commands=p.commands.substr(1,p.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(_=>{switch(_.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":case"reparse":case"reparsepattern":case"manual":case"skip":case"looplines":case"looppattern":case"wait":case"duration":case"withinlines":p.options[_.trim()]=!0;break;default:if(_.trim().startsWith("param=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger param option '${_.trim()}'`);p.options.params=g[1]}else if(_.trim().startsWith("type=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger type option '${_.trim()}'`);if(!this.isTriggerType(g[1]))throw new Error("Invalid trigger type");p.options.type=g[1]}else if(_.trim().startsWith("pri=")||_.trim().startsWith("priority=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger priority option '${_.trim()}'`);if(c=parseInt(g[1],10),isNaN(c))throw new Error("Invalid trigger priority value '"+g[1]+"' must be a number");p.options.priority=c}else throw new Error(`Invalid trigger option '${_.trim()}'`)}});else throw new Error("Invalid trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(_=>{switch(_.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":case"reparse":case"reparsepattern":case"manual":case"skip":case"looplines":case"looppattern":case"wait":case"duration":case"withinlines":p.options[_.trim()]=!0;break;default:if(_.trim().startsWith("param=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger param option '${_.trim()}'`);p.options.params=g[1]}else if(_.trim().startsWith("type=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger type option '${_.trim()}'`);if(!this.isTriggerType(g[1]))throw new Error("Invalid trigger type");p.options.type=g[1]}else if(_.trim().startsWith("pri=")||_.trim().startsWith("priority=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid trigger priority option '${_.trim()}'`);if(c=parseInt(g[1],10),isNaN(c))throw new Error("Invalid trigger priority value '"+g[1]+"' must be a number");p.options.priority=c}else throw new Error(`Invalid trigger option '${_.trim()}'`)}});else throw new Error("Invalid trigger options");p.profile=this.stripQuotes(e[1]),p.profile.length!==0&&(p.profile=this.parseInline(p.profile))}}return this.createTrigger(p.pattern,p.commands,p.profile,p.options,p.name,!0),null;case"cr":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.sendBackground(`
`),null;case"send":case"se":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"se\x1B[0;-11;-12mnd file \x1B[3mprefix suffix\x1B[0;-11;-12m or \x1B[4m"+n+"se\x1B[0;-11;-12mnd text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"se\x1B[0;-11;-12mnd file \x1B[3mprefix suffix\x1B[0;-11;-12m or \x1B[4m"+n+"se\x1B[0;-11;-12mnd text");return this.client.sendBackground(this.stripQuotes(e),this.client.getOption("allowCommentsFromCommand")),null;case"sendfile":case"sendf":return((_,C)=>{ge().then(L=>{be(L[0]).then(R=>{(this.client.getOption("echo")&4)===4&&this.client.echo(C,-3,-4,!0,!0),k="",c="",_.length>1&&(k=this.stripQuotes(this.parseInline(_[0]))),_.length>2&&(c=this.stripQuotes(this.parseInline(_[1]))),o=R.split(/\r?\n/),o.forEach(S=>{this.client.sendBackground(k+S+c,null,this.client.getOption("allowCommentsFromCommand"))})}).catch(this.client.error)}).catch(()=>{})})(e,s),null;case"sendfileraw":case"sendfiler":return((_,C)=>{ge().then(L=>{be(L[0]).then(R=>{(this.client.getOption("echo")&4)===4&&this.client.echo(C,-3,-4,!0,!0),k="",c="",_.length>1&&(k=this.stripQuotes(this.parseInline(_[0]))),_.length>2&&(c=this.stripQuotes(this.parseInline(_[1]))),o=R.split(/\r?\n/),o.forEach(S=>{this.client.sendRaw(k+S+c)})}).catch(this.client.error)}).catch(()=>{})})(e,s),null;case"sendraw":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+n+"sendraw text or "+n+"sendraw file \x1B[3mprefix suffix\x1B[0;-11;-12m");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use "+n+"sendraw text or "+n+"sendraw file \x1B[3mprefix suffix\x1B[0;-11;-12m");return e.endsWith(`
`)||(e=e+`
`),this.client.sendRaw(e),null;case"sendprompt":case"sendp":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"sendp\x1B[0;-11;-12mrompt text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"sendp\x1B[0;-11;-12mrompt text");return this.client.sendRaw(e),null;case"character":case"char":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),this.client.sendRaw(window.$character||""),null;case"speak":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+n+"speak text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use "+n+"speak text");return e=this.stripQuotes(this.parseInline(e)),e.length!==0&&window.speechSynthesis.speak(new SpeechSynthesisUtterance(e)),null;case"speakstop":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+n+"speakstop");return window.speechSynthesis.cancel(),null;case"speakpause":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+n+"speakpause");return window.speechSynthesis.pause(),null;case"speakresume":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+n+"speakresume");return window.speechSynthesis.resume(),null;case"comment":case"comm":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),null;case"noop":case"no":return(this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length&&this.parseInline(e.join(" ")),null;case"temp":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),p={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use "+n+"temp name {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or "+n+"temp {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid temporary trigger or pattern");if(e[0].match(/^\{.*\}$/g))p.pattern=e.shift(),p.pattern=this.parseInline(p.pattern.substr(1,p.pattern.length-2));else{if(p.name=this.parseInline(this.stripQuotes(e.shift())),!p.name||p.name.length===0)throw new Error("Invalid temporary trigger name");e[0].match(/^\{.*\}$/g)&&(p.pattern=e.shift(),p.pattern=this.parseInline(p.pattern.substr(1,p.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(p.commands=e.shift(),p.commands=p.commands.substr(1,p.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(_=>{switch(_.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":p.options[_.trim()]=!0;break;default:if(_.trim().startsWith("param=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid temporary trigger param option '${_.trim()}'`);p.options.params=g[1]}else if(_.trim().startsWith("type=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid temporary trigger type option '${_.trim()}'`);if(!this.isTriggerType(g[1],1))throw new Error("Invalid temporary trigger type");p.options.type=g[1]}else if(_.trim().startsWith("pri=")||_.trim().startsWith("priority=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid temporary trigger priority option '${_.trim()}'`);if(c=parseInt(g[1],10),isNaN(c))throw new Error("Invalid temporary trigger priority value '"+g[1]+"' must be a number");p.options.priority=c}else throw new Error(`Invalid temporary trigger option '${_.trim()}'`)}});else throw new Error("Invalid temporary trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(_=>{switch(_.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":p.options[_.trim()]=!0;break;default:if(_.trim().startsWith("param=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid temporary trigger param option '${_.trim()}'`);p.options.params=g[1]}else if(_.trim().startsWith("type=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid temporary trigger type option '${_.trim()}'`);if(!this.isTriggerType(g[1],1))throw new Error("Invalid temporary trigger type");p.options.type=g[1]}else if(_.trim().startsWith("pri=")||_.trim().startsWith("priority=")){if(g=_.trim().split("="),g.length!==2)throw new Error(`Invalid temporary trigger priority option '${_.trim()}'`);if(c=parseInt(g[1],10),isNaN(c))throw new Error("Invalid temporary trigger priority value '"+g[1]+"' must be a number");p.options.priority=c}else throw new Error(`Invalid temporary trigger option '${_.trim()}'`)}});else throw new Error("Invalid temporary trigger options");p.profile=this.stripQuotes(e[1]),p.profile.length!==0&&(p.profile=this.parseInline(p.profile))}}return p.options.temporary=!0,this.createTrigger(p.pattern,p.commands,p.profile,p.options,p.name),null;case"wrap":case"wr":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e=e.filter(_=>_),e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"wr\x1B[0;-11;-12map or \x1B[4m"+n+"wr\x1B[0;-11;-12map number");if(e.length===0)this.client.setOption("display.wordWrap",!this.client.getOption("display.wordWrap")),this.client.display.wordWrap=this.client.getOption("display.wordWrap");else{if(c=parseInt(this.parseInline(e[0]),10),isNaN(c))throw new Error("Invalid number '"+c+"' for wrap");if(c<0)throw new Error("Must be greater then or equal to zero for wrap");this.client.setOption("display.wordWrap",!0),this.client.setOption("display.wordWrap",c),this.client.display.wordWrap=!0,this.client.display.wrapAt=c}return null;case"prompt":case"pr":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+n+"pr\x1B[0;-11;-12mompt variable \x1B[3mmessage defaultValue mask\x1B[0;-11;-12m");if(c=e.shift(),c.match(/^\{.*\}$/g)&&(c=c.substr(1,c.length-2)),c=this.parseInline(c),!He(c))throw new Error("Invalid variable name");return e=e.map(_=>this.parseInline(this.stripQuotes(_))),e.length===3&&e[2]&&e[2].toLowerCase()==="true"&&(e[2]=!0),e=window.prompt(...e),e?.match(/^\s*?[-|+]?\d+\s*?$/)?this.client.variables[c]=parseInt(e,10):e?.match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?this.client.variables[c]=parseFloat(e):e==="true"?this.client.variables[c]=!0:e==="false"?this.client.variables[c]=!1:this.client.variables[c]=e,null;case"setmap":if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+n+"setmap file \x1B[3msetCharacter\x1B[0;-11;-12m");if(g=this.stripQuotes(this.parseInline(e.shift()))||"",!g||!g.length)throw new Error("Empty file\x1B[0;-11;-12m");return e.length>1?k=this.stripQuotes(this.parseInline(e.join(" "))).toLocaleLowerCase().trim():k="",this.emit("setmap",g,k==="true"||k==="yes",!0),null}if(t.match(/^[-|+]?\d+$/)){if((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),c=parseInt(t,10),e.length===0)throw new Error("Invalid syntax use "+n+"nnn commands");return e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),c<1?this.executeForLoop(-c+1,1,e):this.executeForLoop(0,c,e)}let v={name:t,args:e,raw:s,handled:!1,return:null};return this.client.emit("function",v),v.handled?((this.client.getOption("echo")&4)===4&&this.client.echo(s,-3,-4,!0,!0),v.return):v.raw.startsWith(n)?n+this.parseOutgoing(v.raw.substr(1),null,null,null,!0):this.parseOutgoing(v.raw+`
`,null,null,null,!0)}executeForLoop(t,e,s){let n=[],r;if(t>e)for(r=t-1;r>=e;r--){this.loops.push(r);try{let a=this.parseOutgoing(s);if(a!=null&&a.length>0&&n.push(a),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}catch(a){throw a}finally{this.loops.pop()}}else for(r=t;r<e;r++){this.loops.push(r+1);try{let a=this.parseOutgoing(s);if(a!=null&&a.length>0&&n.push(a),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}catch(a){throw a}finally{this.loops.pop()}}return n.length>0?n.map(a=>a.trim()).join(`
`):null}parseInline(t){return this.parseOutgoing(t,!1,null,!1,!0)}parseOutgoing(t,e,s,n,r,a){let o=t.length;if(!this.enableParsing||t==null||o===0)return t;let h="",c="",g,f=0,w=this.client.aliases,p=this.client.getOption("commandStackingChar"),k=this.client.getOption("speedpathsChar"),E=this.client.getOption("enableSpeedpaths"),b=this.client.getOption("enableCommands"),v=this.client.getOption("commandChar"),M=this.client.getOption("allowEscape"),B=this.client.getOption("escapeChar"),I=this.client.getOption("verbatimChar"),_=this.client.getOption("enableVerbatim"),C=this.client.getOption("enableDoubleParameterEscaping"),L=this.client.getOption("parametersChar"),R=this.client.getOption("enableParameters"),S=this.client.getOption("nParametersChar"),P=this.client.getOption("enableNParameters"),X=this.client.getOption("allowEval"),J=this.client.getOption("ignoreEvalUndefined"),G=this.client.getOption("enableInlineComments")&&!a,ie=this.client.getOption("enableBlockComments")&&!a,Q=this.client.getOption("inlineCommentString").split(""),D=this.client.getOption("blockCommentString").split(""),N=this.client.getOption("ignoreInputLeadingWhitespace"),Y="",U=[],O="",H=!0,F="",re,T,he,q=0,W,K,se=!0,_e=!1,Re=!1,Pe=!1,Te=0,Ve=this.client.getOption("parseDoubleQuotes"),Ae=this.client.getOption("parseSingleQuotes");for(e==null?e=w.length>0:e=e&&w.length>0,p.length===0?s=!1:s==null?s=this.client.getOption("commandStacking"):s=s&&this.client.getOption("commandStacking"),q=0;q<o;q++)switch(T=t.charAt(q),f){case 1:M&&T===B?f=27:(T==='"'&&Ve&&(f=0),e&&H?c+=T:h+=T),se=!1;break;case 27:f=1,T!=='"'&&T!==B?(q--,e&&H?c+=B:h+=B):e&&H?c+=T:h+=T;break;case 2:M&&T===B?f=27:(T==="'"&&Ae&&(f=0),e&&H?c+=T:h+=T),se=!1;break;case 28:f=2,T!=="'"&&T!==B?(q--,e&&H?c+=B:h+=B):e&&H?c+=T:h+=T;break;case 3:if(T==='"'&&Ve)O+=T,f=4,se=!1;else if(T==="'"&&Ae)O+=T,f=5,se=!1;else if(M&&T===B)f=17,se=!1;else if(q===o-1||T===`
`||s&&T===p){for(T===`
`||s&&T===p||(O+=T),O.length>0&&U.push(this.parseInline(O)),he=g.length,re=0;re<he;re++){if(h=this.ExecuteAlias(g[re],U),typeof h=="number")return h>=0&&this.executeWait(t.substr(q+1),h,e,s,n,r,a),F.length===0?null:F;if(h!==null&&(F+=h),h="",!re.multi)break;if(this.stack.continue||this.stack.break)return F.length===0?null:F}c="",f=0,g=null,se=!0}else T===" "?(U.push(this.parseInline(O)),O="",se=!1):(O+=T,se=!1);break;case 4:T==='"'&&(f=3),O+=T,se=!1;break;case 5:T==="'"&&(f=3),O+=T,se=!1;break;case 17:f=3,T===B||s&&T===p||_&&T===I||E&&T===k||b&&T===v||C&&T===L||P&&T===S?O+=T:G&&T==Q[0]||ie&&T==D[0]?K=T:`"'{`.indexOf(T)!==-1?O+=T:O+=B+T;break;case 6:if(M&&T===B)f=18,se=!1;else if(T===`
`||s&&T===p){if(f=0,h=this.ProcessPath(h),h!==null&&(F+=h),h="",se=!0,this.stack.continue||this.stack.break)return F.length===0?null:F}else q===1&&T===k?(f=0,q--,se=!1):(h+=T,se=!1);break;case 18:f=6,T===B||s&&T===p||_&&T===I||E&&T===k||b&&T===v||C&&T===L||P&&T===S?h+=T:G&&T==Q[0]||ie&&T==D[0]?K=T:`"'{`.indexOf(T)!==-1?h+=T:h+=B+T;break;case 7:if(T==="{")se=!1,h+=T,Te++;else if(T==="}")se=!1,h+=T,Te--;else if(Te===0&&M&&T===B)f=19,se=!1;else if(Te===0&&(T===`
`||s&&T===p)){if(f=0,h=this.executeScript(v+h),typeof h=="number")return h>=0&&this.executeWait(t.substr(q+1),h,e,s,n,r,a),F.length===0?null:F;if(h!==null&&(F+=Y+h+`
`),this.stack.continue||this.stack.break)return F.length===0?null:F;h="",se=!0}else h+=T,se=!1;break;case 19:f=7,h+=B+T;break;case 8:if(T==="{"&&O.length===0){f=9;continue}switch(T){case L:O.length===0&&(e&&H?c+=L:h+=L,f=0,C||q--);break;case"*":if(O.length===0){this.stack.args?(e&&H?c+=this.stack.args.slice(1).join(" "):h+=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):e&&H?c+=L+"*":h+=L+"*",f=0;break}case"-":if(O.length===0){_e=!0;break}else if(Re&&O.length==1){_e=!0;break}else Pe=!0;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":if(!Pe){O+=T;break}case"x":if(!Pe&&O.length===0){Re=!0;break}default:if(this.stack.args&&O.length>0)W=parseInt(O,10),Re?_e&&this.stack.args.indices&&W<this.stack.args.length?W=this.stack.indices.slice(W).map(ae=>ae?ae[0]+" "+ae[1]:"0 0").join(" "):this.stack.args.indices&&W<this.stack.args.length?W=this.stack.args.indices[W]?this.stack.args.indices[W][0]+" "+this.stack.args.indices[W][1]:"0 0":_e?W=L+"x-"+W:W=L+"x"+W:(_e&&W<this.stack.args.length?W=this.stack.args.slice(O).join(" "):W<this.stack.args.length?W=this.stack.args[W]:_e?W=L+"-"+W:W=L+W,_e?this.stack.used=this.stack.args.length:O>this.stack.used&&(this.stack.used=parseInt(O,10))),e&&H?c+=W:h+=W,q--;else{if(O.length===0&&this.loops.length>0&&(W=T.charCodeAt(0)-105,W>=0&&W<18&&W<this.loops.length)){e&&H?c+=this.loops[W]:h+=this.loops[W],f=0;break}e&&H?(c+=L,_e&&(c+="-"),Re&&(c+="x")):(h+=L,_e&&(h+="-"),Re&&(h+="x")),q=q-O.length-1}f=0,O="";break}break;case 26:T.match(/[^a-zA-Z0-9_]/g)?(this.stack.named.hasOwnProperty(O)?e&&H?c+=this.stack.named[O]:h+=this.stack.named[O]:e&&H?c+=L+O:h+=L+O,q--,f=0,O=""):O+=T;break;case 9:T==="}"&&Te===0?(O==="i"?K=this.loops[0]:O==="repeatnum"?K=this.repeatnum:this.stack.args&&O==="*"?(K=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):this.stack.named&&this.stack.named.hasOwnProperty(O)?K=this.stack.named[O]:this.stack.args&&!isNaN(O)?(W=parseInt(O,10),W<0?-W>=this.stack.args.length?X?K=W:(K=L,q=q-W.length-2):(K=this.stack.args.slice(W).join(" "),this.stack.used=this.stack.args.length):W<this.stack.args.length?(K=this.stack.args[W],O>this.stack.used&&(this.stack.used=W)):X?K=W:(K=L,q=q-O.length-2)):this.stack.args&&this.stack.args.indices&&O.match(/^x[-|+]?\d+$/)?(W=parseInt(O.substring(1),10),W<0?-W>=this.stack.args.length?(K=L,q=q-W.length-2):K=this.stack.indices.slice(W).map(ae=>ae?ae[0]+" "+ae[1]:"0 0").join(" "):W<this.stack.args.length?K=this.stack.args.indices[W]?this.stack.args.indices[W][0]+" "+this.stack.args.indices[W][1]:"0 0":(K=L,q=q-O.length-2)):(W=this.parseVariable(O),W!=null?K=W:X?(K=this.evaluate(this.parseInline(O)),J&&typeof K>"u"?K=null:K=""+K):(K=L,q=q-O.length-2)),K!=null&&e&&H?c+=K:K!=null&&(h+=K),f=0,O=""):T==="{"?(Te++,O+=T):(T==="}"&&Te--,O+=T);break;case 11:T==="{"?f=12:T.match(/[^a-zA-Z_$]/g)?(f=0,q--,e&&H?c+=S:h+=S):(O=T,f=14);break;case 14:T.match(/[^a-zA-Z0-9_]/g)?(this.stack.named&&this.stack.named.hasOwnProperty(O)?e&&H?c+=this.stack.named[O]:h+=this.stack.named[O]:this.client.variables.hasOwnProperty(O)?e&&H?c+=this.client.variables[O]:h+=this.client.variables[O]:e&&H?c+=S+O:h+=S+O,q--,f=0,O=""):O+=T;break;case 12:T==="}"&&Te===0?(K=null,O==="i"?K=this.loops[0]:O==="repeatnum"?K=this.repeatnum:this.stack.args&&O==="*"?(K=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):this.stack.named&&this.stack.named.hasOwnProperty(O)?K=this.stack.named[O]:this.stack.args&&!isNaN(O)?(W=parseInt(O,10),W<0?-W>=this.stack.args.length?X?K=W:(K=S,q=q-O.length-2):(K=this.stack.args.slice(W).join(" "),this.stack.used=this.stack.args.length):W<this.stack.args.length?(K=this.stack.args[W],W>this.stack.used&&(this.stack.used=W)):X?K=W:(K=S,q=q-O.length-2)):this.stack.args&&this.stack.args.indices&&O.match(/^x[-|+]?\d+$/)?(W=parseInt(O.substring(1),10),W<0?-W>=this.stack.args.length?(K=S,q=q-O.length-2):K=this.stack.indices.slice(W).map(ae=>ae?ae[0]+" "+ae[1]:"0 0").join(" "):W<this.stack.args.length?K=this.stack.args.indices[W]?this.stack.args.indices[W][0]+" "+this.stack.args.indices[W][1]:"0 0":(K=S,q=q-O.length-2)):(T=this.parseVariable(O),T!=null?K=T:X?(K=this.evaluate(this.parseInline(O)),J&&typeof K>"u"?K=null:K=""+K):(K=S,q=q-O.length-2)),K!=null&&e&&H?c+=K:K!=null&&(h+=K),f=0,O=""):T==="{"?(Te++,O+=T):(T==="}"&&Te--,O+=T);break;case 15:T===B||s&&T===p||_&&T===I||E&&T===k||b&&T===v||C&&T===L||P&&T===S||G&&T==Q[0]||ie&&T==D[0]||`"'{`.indexOf(T)!==-1?K=T:K=B+T,e&&H?c+=K:h+=K,f=0;break;case 16:T===`
`?(f=0,F+=h+T,h="",se=!0):(h+=T,se=!1);break;case 20:G&&T===Q[1]?f=22:ie&&T===D[1]?f=24:(f=0,e&&H?c+=Q[0]:h+=Q[0],q--);break;case 21:T===Q[1]?f=22:(f=0,e&&H?c+=Q[0]:h+=Q[0],q--);break;case 23:ie&&T===D[1]?f=25:(f=0,e&&H?c+=D[0]:h+=D[0],q--);break;case 22:T===`
`&&(f=0,se?(c="",H=!0,se=!0):q--);break;case 24:D.length===1?T===D[0]&&(f=0):T===D[1]&&(f=25);break;case 25:T===D[0]?f=0:f=24;break;default:if((G||ie)&&T===Q[0]&&T===D[0]){G&&Q.length===1?f=22:ie&&D.length===1?f=24:f=20;continue}else if(G&&T===Q[0]){Q.length===1?f=22:f=21;continue}else if(ie&&T===D[0]){D.length===1?f=24:f=23;continue}else if(M&&T===B){f=15,se=!1;continue}else if(R&&T===L)f=8,_e=!1,Re=!1,Pe=!1,O="",se=!1;else if(P&&T===S)f=11,_e=!1,Re=!1,Pe=!1,O="",se=!1;else if(!r&&b&&se&&T===v)f=7,se=!1,c.length?(Y=c,c=""):(Y=h||"",h="");else if(_&&se&&T===I)f=16,se=!1;else if(E&&se&&T===k)f=6,se=!1;else if(T==='"'&&Ve)e&&H?c+=T:h+=T,f=1,se=!1;else if(T==="'"&&Ae)e&&H?c+=T:h+=T,f=2,se=!1;else if(se&&N&&(T===" "||T==="	"||T==="\f"||T==="\r"||T==="\v"||T===" "||T==="\xA0"||T==="\u1680"||T==="\u2000-"||T==="\u200A"||T==="\u2028"||T==="\u2029"||T==="\u202F"||T==="\u205F"||T==="\u3000"||T==="\uFEFF"))e&&H?c+=T:h+=T;else if(e&&H&&T===" ")g=Qe(w,"pattern",N?c.trimStart():c),g.length>0?(f=3,U.length=0,O="",U.push(N?c.trimStart():c)):(h+=c+" ",c="",g=null),H=!1,se=!1;else if(T===`
`||s&&T===p){if(e&&H&&c.length>0)if(g=Qe(w,"pattern",N?c.trimStart():c),g.length>0){for(U.push(N?c.trimStart():c),he=g.length,re=0;re<he;re++){if(h=this.ExecuteAlias(g[re],U),typeof h=="number")return h>=0&&this.executeWait(t.substr(q+1),h,e,s,n,r,a),F.length===0?null:F;if(h!==null&&(F+=h),!re.multi)break;if(this.stack.continue||this.stack.break)return F.length===0?null:F}h="",U.length=0,O=""}else{if(h=this.ExecuteTriggers(17,c,c,!1,!0),typeof h=="number")return h>=0&&this.executeWait(t.substr(q+1),h,e,s,n,r,a),F.length===0?null:F;h!==null&&(F+=h+`
`),h="",g=null}else{if(h=this.ExecuteTriggers(17,h,h,!1,!0),typeof h=="number")return h>=0&&this.executeWait(t.substr(q+1),h,e,s,n,r,a),F.length===0?null:F;h!==null&&(F+=h+`
`),h=""}if(this.stack.continue||this.stack.break)return F.length===0?null:F;c="",H=!0,se=!0}else e&&H?(c+=T,se=!1):(h+=T,se=!1);break}if(f===15?h+=B:f===14&&O.length>0?this.stack.named&&this.stack.named[O]?h+=this.stack.named[O]:this.client.variables.hasOwnProperty(O)?h+=this.client.variables[O]:(O=this.parseInline(O),h+=S,O!=null&&(h+=O)):f===8&&O.length>0?this.stack.args?(O=parseInt(O,10),Re&&this.stack.args.indices&&O<this.stack.args.length?h+=this.stack.args.indices[O]?this.stack.args.indices[O][0]+" "+this.stack.args.indices[O][1]:"0 0":(_e&&O<this.stack.args.length?h+=this.stack.args.slice(O).join(" "):O<this.stack.args.length&&(h+=this.stack.args[O]),_e?this.stack.used=this.stack.args.length:O>this.stack.used&&(this.stack.used=O))):(O=this.parseInline(O),h+=L,_e&&(h+="-"),Re&&(h+="x"),O!=null&&(h+=O)):f===9?(O=this.parseInline(O),h+=L+"{",O!=null&&(h+=O)):f===11&&O.length>0?this.stack.named?this.stack.named.hasOwnProperty(O)?h+=this.stack.named[O]:(O=this.parseInline(O),h+=S,O!=null&&(h+=O)):(O=this.parseInline(O),h+=S,O!=null&&(h+=O)):f===12?(O=this.parseInline(O),h+=`${S}{`,O!=null&&(h+=O)):f===6?(h=this.ProcessPath(h),h!==null&&(F+=h),h=""):f===20||f===21?(h+=Q[0],q--):f===23&&(h+=D[0],q--),!r&&f===7){if(h=this.executeScript(v+h),typeof h=="number")return h>=0&&this.executeWait(t.substr(q+1),h,e,s,n,r,a),F.length===0?null:F;if(h!==null){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let ae=!1;h.endsWith(`
`)&&(h=h.substring(0,h.length-1),ae=!0),h.endsWith(" ")||(h+=" "),this.stack.used<1?h+=this.stack.args.slice(1).join(" "):h+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,ae&&(h+=`
`)}F+=Y+h}else if(F.length===0)return null;if(this.stack.continue||this.stack.break)return F.length===0?null:F}else if(f===16){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let ae=!1;h.endsWith(`
`)&&(h=h.substring(0,h.length-1),ae=!0),h.endsWith(" ")||(h+=" "),this.stack.used<1?h+=this.stack.args.slice(1).join(" "):h+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,ae&&(h+=`
`)}F+=h}else if(c.length>0&&e&&H){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let ae=!1;h.endsWith(`
`)&&(h=h.substring(0,h.length-1),ae=!0),h.endsWith(" ")||(h+=" "),this.stack.used<1?h+=this.stack.args.slice(1).join(" "):h+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,ae&&(h+=`
`)}if(h.length>0&&(c+=h),g=Qe(w,"pattern",N?c.trimStart():c),g.length>0)for(U.push(N?c.trimStart():c),he=g.length,re=0;re<he;re++){if(h=this.ExecuteAlias(g[re],U),typeof h=="number")return h>=0&&this.executeWait(t.substr(q+1),h,e,s,n,r,a),F.length===0?null:F;if(h!==null)F+=h;else if(F.length===0)return null;if(this.stack.continue||this.stack.break)return F;if(!re.multi)break}else{if(h=this.ExecuteTriggers(17,c,c,!1,!0),typeof h=="number")return h>=0&&this.executeWait(t.substr(q+1),h,e,s,n,r,a),F.length===0?null:F;if(h!==null)F+=h;else if(F.length===0)return null;if(this.stack.continue||this.stack.break)return F}g=null}else if(c.length>0){if(h.length>0&&(c+=h),h=this.ExecuteTriggers(17,c,c,!1,!0),typeof h=="number")return h>=0&&this.executeWait(t.substr(q+1),h,e,s,n,r,a),F.length===0?null:F;if(h!==null){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let ae=!1;h.endsWith(`
`)&&(h=h.substring(0,h.length-1),ae=!0),h.endsWith(" ")||(h+=" "),this.stack.used<1?h+=this.stack.args.slice(1).join(" "):h+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,ae&&(h+=`
`)}F+=h}else if(F.length===0)return null;if(this.stack.continue||this.stack.break)return F.length===0?null:F}else if(h.length>0){if(h=this.ExecuteTriggers(17,h,h,!1,!0),typeof h=="number")return h>=0&&this.executeWait(t.substr(q+1),h,e,s,n,r,a),F.length===0?null:F;if(h!==null){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let ae=!1;h.endsWith(`
`)&&(h=h.substring(0,h.length-1),ae=!0),h.endsWith(" ")||(h+=" "),this.stack.used<1?h+=this.stack.args.slice(1).join(" "):h+=this.stack.args.slice(this.stack.used+1).join(" "),ae&&(h+=`
`)}F+=h}else if(F.length===0)return null;if(this.stack.continue||this.stack.break)return F.length===0?null:F}return U.length=0,U=null,O=null,c=null,F}parseVariable(t){let e;switch(t){case"esc":return"\x1B";case"cr":return`
`;case"lf":return"\r";case"crlf":return`\r
`;case"copied":return window.$copied;case"copied.lower":return window.$copied.toLowerCase();case"copied.upper":return window.$copied.toUpperCase();case"copied.proper":return Ft(window.$copied);case"i":return this.loops[0];case"repeatnum":return this.vStack.$repeatnum||this.repeatnum;case"character":return window.$character;case"character.lower":return window.$character.toLowerCase();case"character.upper":return window.$character.toUpperCase();case"character.proper":return Ft(window.$character);case"selected":case"selectedurl":case"selectedline":case"selectedword":case"selurl":case"selline":case"selword":case"action":case"trigger":return this.vStack["$"+t]||window["$"+t]||"";case"selected.lower":case"selectedurl.lower":case"selectedline.lower":case"selectedword.lower":case"selurl.lower":case"selline.lower":case"selword.lower":return(this.vStack["$"+t.substr(0,t.length-6)]||window["$"+t.substr(0,t.length-6)]||"").toLowerCase();case"selected.upper":case"selectedurl.upper":case"selectedline.upper":case"selectedword.upper":case"selurl.upper":case"selline.upper":case"selword.upper":return(this.vStack["$"+t.substr(0,t.length-6)]||window["$"+t.substr(0,t.length-6)]||"").toUpperCase();case"selected.proper":case"selectedurl.proper":case"selectedline.proper":case"selectedword.proper":case"selurl.proper":case"selline.proper":case"selword.proper":return Ft(this.vStack["$"+t.substr(0,t.length-7)]||window["$"+t.substr(0,t.length-7)]);case"random":return Lt().randomInt(0,100)}if($t.indexOf(t)!==-1)return this.vStack["$"+t]||window["$"+t]||"";if(this.loops.length&&t.length===1){let w=t.charCodeAt(0)-105;if(w>=0&&w<18&&w<this.loops.length)return this.loops[w]}let n=new RegExp("^([a-zA-Z]+)\\((.*)\\)$","g").exec(t);if(!n||!n.length){let w={raw:t,name:t,args:[],handled:!1,return:null};return this.client.emit("variable",w),w.handled?w.return:null}let r,a,o,h,c,g=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";switch(n[1]){case"time":return moment?n[2]&&n[2].length>0?moment().format(this.stripQuotes(this.parseInline(n[2]))):moment().format():new Date().toISOString();case"clip":return n[2]&&n[2].length>0?(this.client.writeClipboard(this.stripQuotes(this.parseInline(n[2]))),null):this.client.readClipboard();case"lower":return this.stripQuotes(this.parseInline(n[2]).toLowerCase());case"upper":return this.stripQuotes(this.parseInline(n[2]).toUpperCase());case"proper":return Ft(this.stripQuotes(this.parseInline(n[2])));case"eval":return o=this.evaluate(this.parseInline(n[2])),this.client.getOption("ignoreEvalUndefined")&&typeof o>"u"?null:""+o;case"dice":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Invalid dice");if(o.length===1){if(n=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(o[0]),!n||n.length<3)return null;e=parseInt(n[1]),r=n[2],n.length>3&&(a=n[3])}else if(o.length<4)e=parseInt(o[0]),r=o[1].trim(),o.length>2&&(a=o[2].trim());else throw new Error("Too many arguments for dice");r==="F"||r==="f"?r="F":r!=="%"&&(r=parseInt(r));let w=0;for(let E=0;E<e;E++)r==="F"||r==="f"?w+=Ni():r==="%"?w+=~~(Math.random()*100)+1:w+=~~(Math.random()*r)+1;return r==="%"&&(w/=100),a?this.evaluate(w+a):""+w;case"diceavg":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Invalid dice for diceavg");if(o.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(o[0]),!n||n.length<3)return null;e=parseInt(n[1]),r=n[2],n.length>3&&(a=n[3])}else if(o.length<4)e=parseInt(o[0]),r=o[1].trim(),o.length>2&&(a=o[2].trim());else throw new Error("Too many arguments for diceavg");return h=1,r==="F"||r==="f"?(h=-1,c=1):r==="%"?(h=0,c=1):c=parseInt(r),a?this.evaluate((h+c)/2*e+a):""+(h+c)/2*e;case"dicemin":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Invalid dice for dicemin");if(o.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(o[0]),!n||n.length<3)return null;e=parseInt(n[1]),r=n[2],n.length>3&&(a=n[3])}else if(o.length<4)e=parseInt(o[0]),r=o[1].trim(),o.length>2&&(a=o[2]);else throw new Error("Too many arguments for dicemin");return h=1,r==="F"||r==="f"?h=-1:r==="%"&&(h=0),a?this.evaluate(h*e+a):""+h*e;case"dicemax":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Invalid dice for dicemax");if(o.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(o[0]),!n||n.length<3)return null;e=parseInt(n[1]),r=n[2],n.length>3&&(a=n[3])}else if(o.length<4)e=parseInt(o[0]),r=o[1].trim(),o.length>2&&(a=o[2].trim());else throw new Error("Too many arguments for dicemax");return r==="F"||r==="f"||r==="%"?c=1:c=parseInt(r),a?this.evaluate(c*e+a):""+c*e;case"zdicedev":case"dicedev":let p=n[1];if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Invalid dice for "+p);if(o.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(o[0]),!n||n.length<3)return null;e=parseInt(n[1]),r=n[2],n.length>3&&(a=n[3])}else if(o.length<4)e=parseInt(o[0]),r=o[1].trim(),o.length>2&&(a=o[2].trim());else throw new Error("Too many arguments for "+p);return r==="F"||r==="f"?c=6:r==="%"?c=1:c=parseInt(r),p==="zdicedev"&&c--,a?this.evaluate(Math.sqrt((c*c-1)/12*e)+a):""+Math.sqrt((c*c-1)/12*e);case"color":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for color");if(o.length===1){if(o[0]==="bold")return"370";if(e=de(o[0]),e===-1)throw new Error("Invalid fore color");return e.toString()}else if(o.length===2){if(o[0]==="bold")e=370;else{if(e=de(o[0]),e===-1)throw new Error("Invalid fore color");if(o[1]==="bold")return(e*10).toString()}if(r=e.toString(),e=de(o[1],!0),e===-1)throw new Error("Invalid back color");return r+","+e.toString()}else if(o.length===3){if(o[0]==="bold"&&(o.shift(),o.push("bold")),o[2]!=="bold")throw new Error("Only bold is supported as third argument for color");if(e=de(o[0]),e===-1)throw new Error("Invalid fore color");if(r=(e*10).toString(),e=de(o[1],!0),e===-1)throw new Error("Invalid back color");return r+","+e.toString()}throw new Error("Too many arguments");case"zcolor":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for zcolor");if(o.length>1)throw new Error("Too many arguments for zcolor");return mi(parseInt(o[0],10));case"ansi":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for ansi");for(e=o.length,a=[],h={},r=0;r<e;r++)if(o[r].trim()==="current")a.push(o[r].trim());else{if(c=qe(o[r].trim()),c===-1)throw new Error("Invalid color or style for ansi");c>=0&&c<30?h[c]=1:a.push(o[r])}if(a.length>2)throw new Error("Too many colors for ansi");if(a.length>1&&(a[1]==="current"?a[1]="":a[1]=qe(a[1],!0)),a.length>0&&(h[1]&&a[0]==="white"||a[0]==="current"?a[0]="":a[0]=qe(a[0])),h=[...Object.keys(h),...a],!h.length)throw new Error("Invalid colors or styles for ansi");return h=h.filter(E=>E!==""),`\x1B[${h.join(";")}m`;case"random":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Invalid random");if(o.length===1)return Lt().randomInt(0,parseInt(o[0],10)+1);if(o.length===2)return Lt().randomInt(parseInt(o[0],10),parseInt(o[1],10)+1);throw new Error("Too many arguments for random");case"case":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for case");return e=this.evaluate(this.parseInline(o[0])),typeof e!="number"?"":e>0&&e<o.length?this.stripQuotes(o[e]):"";case"switch":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for switch");if(o.length%2===1)throw new Error("All expressions must have a value for switch");for(r=o.length,e=0;e<r;e+=2)if(this.evaluate(o[e]))return this.stripQuotes(o[e+1]);return"";case"if":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length<3)throw new Error("Missing arguments for if");if(o.length!==3)throw new Error("Too many arguments for if");return this.evaluate(o[0])?this.stripQuotes(o[1].trim()):this.stripQuotes(o[2].trim());case"ascii":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for ascii");if(o.length>1)throw new Error("Too many arguments for ascii");if(o[0].trim().length===0)throw new Error("Invalid argument, empty string for ascii");return o[0].trim().charCodeAt(0);case"char":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for char");if(o.length>1)throw new Error("Too many arguments for char");if(e=parseInt(o[0],10),isNaN(e))throw new Error("Invalid argument '"+o[0]+"' must be a number for char");return String.fromCharCode(e);case"begins":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length<2)throw new Error("Missing arguments for begins");if(o.length>2)throw new Error("Too many arguments for begins");return this.stripQuotes(o[0]).startsWith(this.stripQuotes(o[1]));case"ends":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length<2)throw new Error("Missing arguments for ends");if(o.length>2)throw new Error("Too many arguments for ends");return this.stripQuotes(o[0]).endsWith(this.stripQuotes(o[1]));case"len":return this.stripQuotes(this.parseInline(n[2])).length;case"stripansi":let k=new RegExp("[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))","g");return this.stripQuotes(this.parseInline(n[2])).replace(k,"");case"pos":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length<2)throw new Error("Missing arguments for pos");if(o.length>2)throw new Error("Too many arguments for pos");return this.stripQuotes(o[1]).indexOf(this.stripQuotes(o[0]))+1;case"ipos":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length<2)throw new Error("Missing arguments for ipos");if(o.length>2)throw new Error("Too many arguments for ipos");return this.stripQuotes(o[1]).toLowerCase().indexOf(this.stripQuotes(o[0]).toLowerCase())+1;case"regex":if(o=this.splitByQuotes(n[2],","),o.length<2)throw new Error("Missing arguments for regex");if(e=new RegExp(this.stripQuotes(o[1]),"gd"),e=e.exec(this.stripQuotes(this.parseInline(o[0]))),o.shift(),o.shift(),e==null||e.length===0)return 0;if(o.length){for(r=1;r<e.length&&o.length;r++)this.client.variables[this.stripQuotes(this.parseInline(o[0]))]=e[r],o.shift();o.length&&(this.client.variables[this.stripQuotes(this.parseInline(o[0]))]=e[0].length)}return e.indices[0]?e.indices[0][0]+1:1;case"trim":return this.stripQuotes(this.parseInline(n[2])).trim();case"trimleft":return this.stripQuotes(this.parseInline(n[2])).trimLeft();case"trimright":return this.stripQuotes(this.parseInline(n[2])).trimRight();case"bitand":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for bitand");if(o.length!==2)throw new Error("Too many arguments for bitand");if(e=parseInt(o[0],10),isNaN(e))throw new Error("Invalid argument '"+o[0]+"' must be a number for bitand");if(r=parseInt(o[1],10),isNaN(r))throw new Error("Invalid argument '"+o[1]+"' must be a number for bitand");return e&r;case"bitnot":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for bitnot");if(o.length!==1)throw new Error("Too many arguments for bitnot");if(e=parseInt(o[0],10),isNaN(e))throw new Error("Invalid argument '"+o[0]+"' must be a number for bitnot");return~e;case"bitor":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for bitor");if(o.length!==2)throw new Error("Too many arguments for bitor");if(e=parseInt(o[0],10),isNaN(e))throw new Error("Invalid argument '"+o[0]+"' must be a number for bitor");if(r=parseInt(o[1],10),isNaN(r))throw new Error("Invalid argument '"+o[1]+"' must be a number for bitor");return e|r;case"bitset":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for bitset");if(o.length>3)throw new Error("Too many arguments for bitset");if(e=parseInt(o[0],10),isNaN(e))throw new Error("Invalid argument '"+o[0]+"' must be a number for bitset");if(r=parseInt(o[1],10),isNaN(r))throw new Error("Invalid argument '"+o[1]+"' must be a number for bitset");if(r--,a=1,o.length===3&&(a=parseInt(o[2],10),isNaN(a)))throw new Error("Invalid argument '"+o[2]+"' must be a number for bitset");return e&~(1<<r)|(a?1:0)<<r;case"bitshift":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for bitshift");if(o.length!==2)throw new Error("Too many arguments for bitshift");if(e=parseInt(o[0],10),isNaN(e))throw new Error("Invalid argument '"+o[0]+"' must be a number for bitshift");if(r=parseInt(o[1],10),isNaN(r))throw new Error("Invalid argument '"+o[1]+"' must be a number for bitshift");return r<0?e>>-r:e<<r;case"bittest":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for bittest");if(o.length!==2)throw new Error("Too many arguments for bittest");if(e=parseInt(o[0],10),isNaN(e))throw new Error("Invalid argument '"+o[0]+"' must be a number for bittest");if(r=parseInt(o[1],10),isNaN(r))throw new Error("Invalid argument '"+o[1]+"' must be a number for bittest");return r--,(e>>r)%2!=0?1:0;case"bitxor":if(o=this.parseInline(n[2]).split(","),o.length===0)throw new Error("Missing arguments for bitxor");if(o.length!==2)throw new Error("Too many arguments for bitxor");if(e=parseInt(o[0],10),isNaN(e))throw new Error("Invalid argument '"+o[0]+"' must be a number for bitxor");if(r=parseInt(o[1],10),isNaN(r))throw new Error("Invalid argument '"+o[1]+"' must be a number for bitxor");return e^r;case"number":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for number");if(o.length>1)throw new Error("Too many arguments for number");return o[0]=this.stripQuotes(o[0],!0),o[0].match(/^\s*?[-|+]?\d+\s*?$/)?parseInt(o[0],10):o[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(o[0]):o[0]==="true"?1:(o[0]==="false",0);case"isfloat":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for isfloat");if(o.length>1)throw new Error("Too many arguments for isfloat");return o[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0;case"isnumber":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for isnumber");if(o.length>1)throw new Error("Too many arguments for isnumber");return o[0].match(/^\s*?[-|+]?\d+\s*?$/)||o[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0;case"string":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for string");if(o.length>1)throw new Error("Too many arguments for string");return`"${this.stripQuotes(o[0]),!0}"`;case"float":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for float");if(o.length>1)throw new Error("Too many arguments for float");return o[0]=this.stripQuotes(o[0],!0),o[0].match(/^\s*?[-|+]?\d+\s*?$/)||o[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(o[0]):o[0]==="true"?1:(o[0]==="false",0);case"isdefined":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for isdefined");if(o.length>1)throw new Error("Too many arguments for isdefined");return o[0]=this.stripQuotes(o[0],!0),this.client.variables.hasOwnProperty(o[0])?1:0;case"defined":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for defined");if(o.length===1){o[0]=this.stripQuotes(o[0],!0);let E=this.client.profiles.keys,b=0,v=E.length;if(v===0)return 0;for(;b<v;b++)if(r=te(this.client.profiles.items[E[b]].aliases),r=r.find(M=>M.pattern===o[0]),r||(r=te(this.client.profiles.items[E[b]].triggers),r=r.find(M=>M.pattern===o[0]||M.name===o[0]),r)||(r=te(this.client.profiles.items[E[b]].macros),r=r.find(M=>ot(M).toLowerCase()===o[0].toLowerCase()||M.name===o[0]),r)||(r=te(this.client.profiles.items[E[b]].aliases),r=r.find(M=>M.caption===o[0]||M.name===o[0]),r))return 1;return this.client.variables.hasOwnProperty(o[0])}else if(o.length===2){o[0]=this.stripQuotes(o[0],!0),o[1]=this.stripQuotes(o[1],!0).toLowerCase();let E=this.client.profiles.keys,b=0,v=E.length;if(v===0)return 0;for(;b<v;b++)switch(o[1]){case"alias":return r=te(this.client.profiles.items[E[b]].aliases),r=r.find(M=>M.pattern===o[0]),r?1:0;case"event":return r=te(this.client.profiles.items[E[b]].triggers),r=r.find(M=>M.type===2&&(M.pattern===o[0]||M.name===o[0])),r?1:0;case"trigger":return r=te(this.client.profiles.items[E[b]].triggers),r=r.find(M=>M.pattern===o[0]||M.name===o[0]),r?1:0;case"macro":return r=te(this.client.profiles.items[E[b]].macros),r=r.find(M=>ot(M).toLowerCase()===o[0].toLowerCase()||M.name===o[0]),r?1:0;case"button":return r=te(this.client.profiles.items[E[b]].aliases),r=r.find(M=>M.caption===o[0]||M.name===o[0]),r?1:0}if(o[1]==="variable")return this.client.variables.hasOwnProperty(o[0])}else throw new Error("Too many arguments for defined");return 0;case"escape":return o=this.stripQuotes(this.parseInline(n[2])),this.client.getOption("allowEscape")?(e=g,g==="\\"&&(e+=g),this.client.getOption("parseDoubleQuotes")&&(e+='"'),this.client.getOption("parseSingleQuotes")&&(e+="'"),this.client.getOption("commandStacking")&&(e+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(e+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(e+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(e+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(e+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(e+=this.client.getOption("nParametersChar")),o.replace(new RegExp(`[${e}]`,"g"),g+"$&")):o.replace(/[\\"']/g,"$&");case"unescape":return o=this.stripQuotes(this.parseInline(n[2])),this.client.getOption("allowEscape")?(e=g,g==="\\"&&(e+=g),this.client.getOption("parseDoubleQuotes")&&(e+='"'),this.client.getOption("parseSingleQuotes")&&(e+="'"),this.client.getOption("commandStacking")&&(e+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(e+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(e+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(e+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(e+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(e+=this.client.getOption("nParametersChar")),g==="\\"?o.replace(new RegExp(`\\\\[${e}]`,"g"),E=>E.substr(1)):o.replace(new RegExp(`${g}[${e}]`,"g"),E=>E.substr(1))):o.replace(/\\[\\"']/g,E=>E.substr(1));case"alarm":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for alarm");if(o.length>3)throw new Error("Too many arguments for alarm");if(o[0]=this.stripQuotes(o[0]),r=this.client.alarms,c=r.length,c===0)throw new Error("No alarms set.");if(e=0,o.length===1){for(;e<c;e++)if(r[e].type===3&&(r[e].name===o[0]||r[e].pattern===o[0]))return r[e].suspended?0:this.client.getRemainingAlarmTime(e)}else if(o.length===2)if(a=parseInt(o[1],10),isNaN(a)){for(o[1]=this.stripQuotes(o[1].trim());e<c;e++)if(r[e].type===3&&(r[e].name===o[0]||r[e].pattern===o[0])){if(r[e].profile.name.toUpperCase()!==o[1].toUpperCase())continue;return r[e].suspended?0:this.client.getRemainingAlarmTime(e)}throw Error("Alarm not found in profile: "+o[1]+".")}else{for(;e<c;e++)if(r[e].type===3&&(r[e].name===o[0]||r[e].pattern===o[0]))return r[e].suspended||this.client.setAlarmTempTime(e,a),a;throw Error("Alarm not found.")}else if(o.length===3){if(a=parseInt(o[1],10),isNaN(a))throw new Error("Invalid time for alarm");for(o[2]=this.stripQuotes(o[2].trim());e<c;e++)if(r[e].type===3&&(r[e].name===o[0]||r[e].pattern===o[0])){if(r[e].profile.name.toUpperCase()!==o[2].toUpperCase())continue;return r[e].suspended||this.client.setAlarmTempTime(e,a),a}throw Error("Could not set time, alarm not found in profile: "+o[2]+".")}return 0;case"state":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)throw new Error("Missing arguments for state");if(o.length>2)throw new Error("Too many arguments for state");if(o[0]=this.stripQuotes(o[0]),a=null,o.length===1){let E=this.client.profiles.keys,b=0,v=E.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[E[0]].enabled||!this.client.profiles.items[E[0]].enableTriggers)throw Error("No enabled profiles found!");r=te(this.client.profiles.items[E[b]].triggers),r=r.find(M=>M.name===o[0]||M.pattern===o[0])}else for(;b<v&&!(!(!this.client.profiles.items[E[b]].enabled||!this.client.profiles.items[E[b]].enableTriggers||this.client.profiles.items[E[b]].triggers.length===0)&&(r=te(this.client.profiles.items[E[b]].triggers),r=r.find(M=>M.name===o[0]||M.pattern===o[0]),r));b++);}else if(o.length===2){if(o[1]=this.stripQuotes(o[1].trim()),this.client.profiles.contains(o[1]))a=this.client.profiles.items[o[1].toLowerCase()];else throw new Error("Profile not found: "+o[1]);r=te(a.triggers),r=r.find(E=>E.name===o[0]||E.pattern===o[0])}if(r)return r.triggers&&r.triggers.length?r.state:0;throw new Error("Trigger not found");case"isnull":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)return null;if(o.length!==1)throw new Error("Too many arguments for null");return this.evaluate(o[0])===null?1:0;case"prompt":if(o=this.splitByQuotes(this.parseInline(n[2]),","),o.length===0)return window.prompt()||"";if(o.length>3)throw new Error("Too many arguments");return o=o.map(E=>this.stripQuotes(E)),window.prompt(...o)||""}let f={raw:t,name:n[1],args:n[2]&&n[2].length?this.parseOutgoing(n[2]).split(","):[],handled:!1,return:null};return this.client.emit("variable",f),f.handled?f.return:null}GetNamedArguments(t,e,s){if(t==="*")return e;if(s==null&&(s=!1),t==null||t.length===0)return s?e:[];let n=t.split(","),r=n.length,a=e.length;if(r===0)return s?e:[];let o;s?o=e.slice():o=[];for(let h=0;h<r;h++)n[h]=$.trim(n[h]),!(n[h].length<1)&&(n[h].startsWith("$")&&(n[h]=n[h].substring(1)),n[h].match(/^[a-zA-Z0-9_][a-zA-Z0-9_]+$/g)&&He(n[h])&&(o[n[h]]||(o[n[h]]=h+1<a?e[h+1]:"")));return o}ExecuteAlias(t,e){if(!t.enabled)return;let s;if(t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:e,named:this.GetNamedArguments(t.params,e),append:t.append,used:0}),s=this.parseOutgoing(t.value,null,null,!0),this._stack.pop();break;case 2:(this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0);let n=this.GetNamedArguments(t.params,e);n?s=Object.keys(n).map(a=>`let ${a} = this.input.stack.named["${a}"];`).join("")+`
`:s="";let r=new Function("try { "+s+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`);this._stack.push({loops:[],args:e,named:n,append:t.append,used:0});try{s=r.apply(this.client,e)}catch(a){throw a}finally{this._stack.pop()}typeof s=="string"&&(s=this.parseOutgoing(s,null,null,!0));break;default:s=t.value;break}return s==null||s===void 0||(s=this.ExecuteTriggers(17,s,s,!1,!0),s==null||s===void 0)||(typeof s!="string"&&(s=s.toString()),s.length===0&&!this.client.getOption("returnNewlineOnEmptyValue"))?null:s.endsWith(`
`)?s:s+`
`}ProcessMacros(t,e,s,n,r){if(!t||t>9&&t<19||!this.client.profiles)return!1;let a=this._MacroCache[t]||(this._MacroCache[t]=Qe(this.client.macros,"key",t)),o=0,h=a.length,c=0;for(e&&(c|=2),s&&(c|=4),n&&(c|=8),r&&(c|=16);o<h;o++)if(!(!a[o].enabled||c!==a[o].modifiers)&&this.ExecuteMacro(a[o]))return!0;return!1}ExecuteMacro(t){if(!t.enabled)return!1;let e;if(t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:0,named:0,used:0});try{e=this.parseOutgoing(t.value)}catch(n){throw n}finally{this._stack.pop()}break;case 2:(this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0);let s=new Function("try { "+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`);this._stack.push({loops:[],args:0,named:0,used:0});try{e=s.apply(this.client)}catch(n){throw n}finally{this._stack.pop()}break;default:e=t.value;break}return e==null||e===void 0?!0:(typeof e!="string"&&(e=e.toString()),e.length===0&&!this.client.getOption("returnNewlineOnEmptyValue")?null:(t.send?(e.endsWith(`
`)||(e+=`
`),t.chain&&this.client.commandInput.value.endsWith(" ")?(this.client.commandInput.value=this.client.commandInput.value+e,this.client.sendCommand(null,null,this.client.getOption("allowCommentsFromCommand"))):this.client.send(e,!0)):t.append&&(this.client.commandInput.value=this.client.commandInput.value+e),!0))}ProcessPath(t,e){if(t.length===0)return"";let s=[],n=0,r="",a="",o=0,h,c,g,f,w=0,p=t.length;for(;o<p;o++)switch(h=t.charAt(o),c=t.charCodeAt(o),n){case 1:c>47&&c<58?a+=h:h==="\\"?n=2:(n=0,r=h);break;case 2:c>47&&c<58?r+=h:(r+="\\",o--),n=0;break;case 3:w===0&&h===")"?n=0:(h==="("?w++:h===")"&&w--,r+=h);break;case 4:w===0&&h==="}"?n=0:(h==="{"?w++:h==="}"&&w--,r+=h);break;default:if(c>47&&c<58){if(r.length>0){for(a.length===0?g=1:g=parseInt(a,10),f=0;f<g;f++)s.push(r);r=""}n=1,a=h}else h==="("?(n=3,w=0):h==="{"?(n=4,w=0):h==="\\"?n=2:r+=h;break}if(r.length>0)for(a.length===0?g=1:g=parseInt(a,10),f=0;f<g;f++)s.push(r);return e&&this._pathQueue.length?this._pathQueue[0]={id:t,current:s,previous:[]}:this._pathQueue.push({id:t,current:s,previous:[]}),this.ExecutePath(),null}ExecutePath(){if(this._pathTimeout||!this._pathQueue.length||this._pathPaused)return;let t=this.client.getOption("pathDelay");t<0&&(t=0),this._pathTimeout=setTimeout(()=>{let e=this.client.getOption("parseSpeedpaths"),s=this.client.getOption("echoSpeedpaths"),n=this.client.getOption("pathDelayCount");n<1&&(n=1);let r=this._pathQueue[0];for(;n--;){let a=r.current.shift();if(r.previous.push(a),e?this.client.sendBackground(a+`
`,!s):this.client.send(a+`
`,!s),!r.current.length)break}r.current.length||this._pathQueue.shift(),this._pathTimeout=null,!(this._pathQueue.length&&this._pathQueue[0].manual)&&this.ExecutePath()},t)}toggleScrollLock(){this.scrollLock=!this.scrollLock}isSubTriggerType(t){return(t&512)==512||(t&1024)==1024||(t&4096)==4096||(t&8192)==8192||(t&16384)==16384||(t&32768)==32768||(t&65536)==65536||(t&131072)==131072||(t&262144)==262144}getTriggerType(t){return t===0?4:t===3?32:t}ExecuteTriggers(t,e,s,n,r,a){if(!this.enableTriggers||e==null)return e;r==null&&(r=!1),n==null&&(n=!1),s=s||e,this.buildTriggerCache();let o=0,h,c=!1,g,f=this._TriggerCache,w=f.length,p=this._TriggerStates,k=this._TriggerRegExCache,E;for(;o<w;o++){let b=f[o],v=b;if(b.enabled){if((!v.triggers||!v.triggers.length||b.state>v.triggers.length)&&(v.state=0),b.state!==0&&v.triggers&&v.triggers.length){for(b=v.triggers[b.state-1];!b.enabled&&v.state!==0;){if(v.state++,v.state>v.triggers.length){v.state=0,b=v;break}v.state?b=v.triggers[v.state-1]:b=v,c=!0}if(c&&(this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",v.profile.name,v.profile.triggers.indexOf(v),v)),!b.enabled)continue}if(E=this.getTriggerType(b.type),!(b.type!==void 0&&(t&E)!==E&&(!a||a&&!this.isSubTriggerType(b.type)))&&b.type!==65536&&!(n&&!b.triggerPrompt)&&!(!n&&!b.triggerNewline&&b.triggerNewline!==void 0)){if(p[o]){if(p[o].type===1024){if(p[o].time>Date.now())continue;delete p[o]}else if(p[o].type===16384){if(p[o].time<Date.now()){delete p[o],this.advanceTrigger(b,v,o),p[o]?p[o].reParse=!0:p[o]={reParse:!0},o=this.cleanUpTriggerState(o);continue}}else if(p[o].type===512){if(p[o].lineCount>0)continue;delete p[o]}else if(p[o].type===8192){if(p[o].lineCount<1){this.advanceTrigger(b,v,o),p[o]?p[o].reParse=!0:p[o]={reParse:!0},o=this.cleanUpTriggerState(o);continue}}else if(p[o].type===32768&&p[o].lineCount<1){this.advanceTrigger(b,v,o),p[o]?p[o].reParse=!0:p[o]={reParse:!0},o=this.cleanUpTriggerState(o);continue}}try{if(b.type===128)if(this.evaluate(this.parseInline(b.pattern))){if(p[o]){if(p[o].loop!==-1&&p[o].lineCount<1)continue}else{let M=this.createTriggerState(b,!1,v);M&&(p[o]=M)}this._LastTriggered=b.raw?s:e,g=this.ExecuteTrigger(b,[this._LastTriggered],r,o,[this._LastTriggered],0,v)}else{this.advanceTrigger(b,v,o);continue}else if(b.verbatim){if(!b.caseSensitive&&(b.raw?s:e).toLowerCase()!==b.pattern.toLowerCase()){!p[o]&&(b.type===131072||b.type===262144)&&(this.advanceTrigger(b,v,o),o=this.cleanUpTriggerState(o));continue}else if(b.caseSensitive&&(b.raw?s:e)!==b.pattern){!p[o]&&(b.type===131072||b.type===262144)&&(this.advanceTrigger(b,v,o),o=this.cleanUpTriggerState(o));continue}this._LastTriggered=b.raw?s:e,g=this.ExecuteTrigger(b,[this._LastTriggered],r,o,[this._LastTriggered],0,v)}else{let M;b.type===8||b.type===16||b.type===262144?h=mt(b.pattern,this.client):h=b.pattern,b.caseSensitive?M=k["g"+h]||(k["g"+h]=new RegExp(h,"gd")):M=k["gi"+h]||(k["gi"+h]=new RegExp(h,"gid")),M.lastIndex=0;let B=M.exec(b.raw?s:e);if(!B||!B.length){!p[o]&&(b.type===131072||b.type===262144)&&(this.advanceTrigger(b,v,o),o=this.cleanUpTriggerState(o));continue}let I;this._LastTriggered=b.raw?s:e,(b.raw?s:e)===B[0]||!this.client.getOption("prependTriggeredLine")?I=B:(I=[this._LastTriggered,...B],I.indices=[[0,I[0].length],...B.indices]),B.groups&&Object.keys(B.groups).map(_=>this.client.variables[_]=B.groups[_]),g=this.ExecuteTrigger(b,I,r,o,[this._LastTriggered,M],B.groups,v)}if(p[o]&&p[o].reParse)!p[o].type||p[o].type===131072||p[o].type===262144?delete p[o]:delete p[o].reParse,o--;else if(r)return g}catch(M){this.client.getOption("disableTriggerOnError")&&(b.enabled=!1,setTimeout(()=>{this.client.saveProfiles(),this.emit("item-updated","trigger",v.profile,v.profile.triggers.indexOf(v),v)})),this.client.getOption("showScriptErrors")?this.client.error(M):this.client.debug(M)}}}}return e}TestTrigger(t,e,s,n,r,a){let o,h;try{if(t.verbatim){if(!t.caseSensitive&&(t.raw?r:n).toLowerCase()!==t.pattern.toLowerCase())return this._TriggerStates[s]||(this.advanceTrigger(t,e,s),s=this.cleanUpTriggerState(s)),s;if(t.caseSensitive&&(t.raw?r:n)!==t.pattern)return this._TriggerStates[s]||(this.advanceTrigger(t,e,s),s=this.cleanUpTriggerState(s)),s;this._LastTriggered=t.raw?r:n,o=this.ExecuteTrigger(t,[this._LastTriggered],!1,s,[this._LastTriggered],0,e)}else{let c;t.type===8||t.type===16||t.type===262144?h=mt(t.pattern,this.client):h=t.pattern,t.caseSensitive?c=this._TriggerRegExCache["g"+h]||(this._TriggerRegExCache["g"+h]=new RegExp(h,"gd")):c=this._TriggerRegExCache["gi"+h]||(this._TriggerRegExCache["gi"+h]=new RegExp(h,"gid")),c.lastIndex=0;let g=c.exec(t.raw?r:n);if(!g||!g.length)return!this._TriggerStates[s]&&(t.type===131072||t.type===262144)&&(this.advanceTrigger(t,e,s),s=this.cleanUpTriggerState(s)),s;let f;this._LastTriggered=t.raw?r:n,(t.raw?r:n)===g[0]||!this.client.getOption("prependTriggeredLine")?f=g:(f=[this._LastTriggered,...g],f.indices=[[0,f[0].length],...g.indices]),g.groups&&Object.keys(g.groups).map(w=>this.client.variables[w]=g.groups[w]),o=this.ExecuteTrigger(t,f,!1,s,[this._LastTriggered,c],g.groups,e)}s=this.cleanUpTriggerState(s)}catch(c){this.client.getOption("disableTriggerOnError")&&(t.enabled=!1,setTimeout(()=>{this.client.saveProfiles(),this.emit("item-updated","trigger",e.profile,e.profile.triggers.indexOf(e),e)})),this.client.getOption("showScriptErrors")?this.client.error(c):this.client.debug(c)}return s}ExecuteTrigger(t,e,s,n,r,a,o){if(s==null&&(s=!1),!t.enabled)return"";if(this._TriggerStates[n]&&this._TriggerStates[n].type===16384&&delete this._TriggerStates[n],t.fired)return t.fired=!1,this.advanceTrigger(t,o,n),this._TriggerStates[n]?this._TriggerStates[n].reParse=!0:this._TriggerStates[n]={reParse:!0},"";this._LastTrigger=t;let h;if(t.temp)if(o.triggers.length)if(o.state===0){let c=o.triggers.shift();c.triggers=o.triggers,c.state=o.state,c.name=o.name,c.profile=o.profile,c.state>c.triggers.length&&(c.state=0),n>=0&&(this._TriggerCache[n]=c),this.client.saveProfiles();let g=o.profile.triggers.indexOf(o);o.profile.triggers[g]=c,this.client.emit("item-updated","trigger",o.profile.name,g,c)}else o.triggers.splice(o.state-1,1),o.state>o.triggers.length&&(o.state=0),this.client.saveProfiles(),this.client.emit("item-updated","trigger",o.profile.name,o.profile.triggers.indexOf(o),o);else n>=0&&this._TriggerCache.splice(n,1),this._TriggerStates[n]&&this.clearTriggerState(n),this.client.removeTrigger(o);else o.triggers.length&&this.advanceTrigger(t,o,n);if((this.client.getOption("echo")&8)===8&&this.client.echo("Trigger fired: "+t.pattern,-7,-8,!0,!0),t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:e,named:0,used:0,regex:r});try{h=this.parseOutgoing(t.value)}catch(c){throw c}finally{this._stack.pop()}break;case 2:if((this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0),t.temp)h=new Function("try { "+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`),h=h.apply(this.client,e);else{this._TriggerFunctionCache[n]||(a?h=Object.keys(a).map(c=>`let ${c} = this.variables["${c}"];`).join("")+`
`:h="",this._TriggerFunctionCache[n]=new Function("try { "+h+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`)),this._stack.push({loops:[],args:e,named:0,used:0,regex:r,indices:e.indices});try{h=this._TriggerFunctionCache[n].apply(this.client,e)}catch(c){throw c}finally{this._stack.pop()}}typeof h=="string"&&(h=this.parseOutgoing(h));break;default:h=t.value;break}if(h==null||h===void 0)return null;if(s)return h;if(typeof h!="string"&&(h=h.toString()),h.length===0&&!this.client.getOption("returnNewlineOnEmptyValue"))return null;h.endsWith(`
`)||(h+=`
`),this.client.connected&&this.client.telnet.sendData(h),this.client.telnet.echo&&this.client.getOption("commandEcho")&&setTimeout(()=>{this.client.echo(h)},1)}advanceTrigger(t,e,s){if(this._TriggerStates[s]){if(this._TriggerStates[s].type===4096){if(this._TriggerStates[s].loop--,this._TriggerStates[s].loop>0)return;this.clearTriggerState(s)}else if(this._TriggerStates[s].type===8192){if(this._TriggerStates[s].lineCount>0)return;this.clearTriggerState(s)}else if(this._TriggerStates[s].type===32768)this.clearTriggerState(s);else if(this._TriggerStates[s].type===128&&(this._TriggerStates[s].loop===-1||this._TriggerStates[s].lineCount>0))return}if(e.state++,e.state>e.triggers.length&&(e.state=0),this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",e.profile.name,e.profile.triggers.indexOf(e),e),e.state!==0){let n=this.createTriggerState(e.triggers[e.state-1]);n&&(this._TriggerStates[s]=n)}}createTriggerState(t,e,s){let n,r;switch(t.type){case 131072:case 262144:r={reParse:!0};break;case 16384:case 1024:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=0)):n=0,r={time:Date.now()+n};break;case 32768:case 8192:case 512:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=1)):n=1,r={lineCount:n+1};break;case 4096:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=0)):n=0,r={loop:n};break;case 128:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=1),s===t?r={lineCount:n-1}:r={lineCount:n}):r={loop:-1};break}return r&&(r.type=t.type),!r&&e?{reParse:!0}:(e&&(r.reparse=!0),r)}updateTriggerState(t,e){if(!this._TriggerStates[e])return;let s;switch(this._TriggerStates[e].type){case 1024:case 16384:s=t.params,s&&s.length?(s=parseInt(s,10),isNaN(s)&&(s=0)):s=0,this._TriggerStates[e].time=Date.now()+s;break;case 32768:case 512:case 8192:s=t.params,s&&s.length?(s=parseInt(s,10),isNaN(s)&&(s=0)):s=0,this._TriggerStates[e].lineCount=s;break;case 4096:s=t.params,s&&s.length?(s=parseInt(s,10),isNaN(s)&&(s=0)):s=0,this._TriggerStates[e].loop=s;break;case 128:s=t.params,s&&s.length?(s=parseInt(s,10),isNaN(s)&&(s=1),this._TriggerStates[e].lineCount=s+1):this._TriggerStates[e].loop=-1;break}}getTriggerState(t){return this._TriggerStates[t]}cleanUpTriggerState(t){return this._TriggerStates[t]&&this._TriggerStates[t].reParse&&(!this._TriggerStates[t].type||this._TriggerStates[t].type===131072||this._TriggerStates[t].type===262144?delete this._TriggerStates[t]:delete this._TriggerStates[t].reParse,t<0?t++:t--),t}clearTriggerState(t){delete this._TriggerStates[t]}setTriggerState(t,e){this._TriggerStates[t]=e}clearTriggerCache(){this._TriggerCache=null,this._TriggerStates={},this._TriggerFunctionCache={},this._TriggerRegExCache={}}resetTriggerState(t,e,s){if(t===-1||t<0||t>=this._TriggerCache.length)return;let n=this._TriggerCache[t],r,a=n,o=!1;if(a.state!==0&&(n=a.triggers[a.state-1]),e===0?r=a:r=a.triggers[e-1],e===a.state)this._TriggerStates[t]?n.fired?this.clearTriggerState(t):this.updateTriggerState(n,t):n.fired||this.updateTriggerState(n,t);else if(this._TriggerStates[t]&&(!this._TriggerStates[t].type||this._TriggerStates[t].type!==262144&&this._TriggerStates[t].type!==131072)&&(o=this._TriggerStates[t].reParse),this.clearTriggerState(t),n.fired)this._TriggerStates[t]={reParse:!0};else{let h=this.createTriggerState(n,o);h&&(this._TriggerStates[t]=h)}}buildTriggerCache(){this._TriggerCache==null&&(this._TriggerCache=this.client.triggers.filter(t=>{if(t&&t.enabled&&t.triggers.length){if(t.type!==3)return!0;for(let e=0,s=t.triggers.length;e<s;e++)if(t.triggers[e].enabled&&t.triggers[e].type!==3)return!0;return!1}return t.enabled&&t.type!==3}))}clearCaches(){this._TriggerCache=null,this._TriggerStates={},this._TriggerFunctionCache={},this._TriggerRegExCache={},this._gamepadCaches=null,this._lastSuspend=-1,this._MacroCache={}}triggerEvent(t,e){if(!this.enableTriggers)return;this.buildTriggerCache();let s=0;e?Array.isArray(e)?e.unshift(t):e=[t,e]:e=[t];let n=this._TriggerCache.length;for(;s<n;s++){let r=this._TriggerCache[s],a=r,o=!1;if(r.enabled){if(r.state>a.triggers.length&&(r.state=0),r.state!==0&&a.triggers&&a.triggers.length){for(r=a.triggers[r.state-1];!r.enabled&&a.state!==0;){if(a.state++,a.state>a.triggers.length){a.state=0,r=a;break}a.state?r=a.triggers[a.state-1]:r=a,o=!0}if(o&&(this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",a.profile.name,a.profile.triggers.indexOf(a),a)),!r.enabled)continue}if(r.type===131072||r.type===262144){let h=this.adjustLastLine(this.client.display.lines.length,!0),c=this.client.display.lines[h];s=this.TestTrigger(r,a,s,c,this.client.display.lines[h].raw||c,h===this.client.display.lines.length-1);continue}r.type===2&&(r.caseSensitive&&t!==r.pattern||!r.caseSensitive&&t.toLowerCase()!==r.pattern.toLowerCase()||(this._LastTriggered=t,this.ExecuteTrigger(r,e,!1,s,0,0,a),s=this.cleanUpTriggerState(s)))}}}executeWait(t,e,s,n,r,a,o){if(!t||t.length===0)return;let h={loops:this.loops.splice(0),args:0,named:0,used:this.stack.used,append:this.stack.append};this.stack.args&&(h.args=this.stack.args.slice()),this.stack.named&&(h.named=this.stack.named.slice()),e<0&&(e=0),setTimeout(()=>{this._stack.push(h);let c=this.parseOutgoing(t,s,n,r,a,o);this._stack.pop(),!(c==null||typeof c>"u"||c.length===0)&&(c.endsWith(`
`)||(c=c+`
`),this.client.send(c,!0))},e)}buildScript(t){if(!t)return"";let e;this.client.getOption("commandStacking")&&this.client.getOption("commandStackingChar")&&this.client.getOption("commandStackingChar").length>0?e=t.splitQuote(`
`+this.client.getOption("commandStackingChar")):e=t.splitQuote(`
`);let s=0,n=e.length,r=[],a=[],o=this.client.getOption("commandChar");for(;s<n;s++)e[s].trim().startsWith(o+"wait ")?(r.push("setTimeout(()=> {"),a.unshift(parseInt(e[s].trim().substr(5),10)||0)):(r.push("client.sendCommand('"),r.push(e[s]),r.push("\\n');"));let h=a.length;for(s=0;s<h;s++)r.push("}, "),r.push(a[s]),r.push(");");return r.join("")}stripQuotes(t,e,s){return!t||t.length===0||((e||this.client.getOption("parseDoubleQuotes"))&&(t=t.replace(/^\"(.*)\"$/g,(n,r,a)=>r.replace(/\\\"/g,'"'))),(s||this.client.getOption("parseSingleQuotes"))&&(t=t.replace(/^\'(.*)\'$/g,(n,r,a)=>r.replace(/\\\'/g,"'")))),t}splitByQuotes(t,e,s,n){let r=0,a=0;return!t||t.length===0?[]:((s||this.client.getOption("parseDoubleQuotes"))&&(r|=2,a|=this.client.getOption("allowEscape")?2:0),(n||this.client.getOption("parseSingleQuotes"))&&(r|=1,a|=this.client.getOption("allowEscape")?1:0),Dt(t,e,r,a,this.client.getOption("escapeChar")))}createTrigger(t,e,s,n,r,a){let o,h,c=!0,g=!1;if(!t&&!r)throw new Error(`Trigger '${r||""}' not found`);if(s){if(typeof s=="string"){if(this.client.profiles.contains(s.toLowerCase()))s=this.client.profiles.items[s.toLowerCase()];else throw new Error("Profile not found: "+s);if(a)if(r)o=s.findAny("triggers",{name:r,pattern:r});else{if(!s.triggers.length)throw new Error("No triggers exist");o=s.triggers[s.triggers.length-1]}else r!==null?o=s.find("triggers","name",r):o=s.find("triggers","pattern",t)}}else{let f=this.client.profiles.keys,w=0,p=f.length;if(p===0)return;if(p===1){if(!this.client.profiles.items[f[0]].enabled||!this.client.profiles.items[f[0]].enableTriggers)throw Error("No enabled profiles found!");if(s=this.client.profiles.items[f[0]],a)if(r)o=this.client.profiles.items[f[w]].findAny("triggers",{name:r,pattern:r});else{if(!this.client.profiles.items[f[w]].triggers.length)throw new Error("No triggers exist");o=this.client.profiles.items[f[w]].triggers[this.client.profiles.items[f[w]].triggers.length-1]}else r!==null?o=this.client.profiles.items[f[w]].find("triggers","name",r):o=this.client.profiles.items[f[w]].find("triggers","pattern",t)}else{for(;w<p;w++)if(!(!this.client.profiles.items[f[w]].enabled||!this.client.profiles.items[f[w]].enableTriggers||this.client.profiles.items[f[w]].triggers.length===0)){if(a)if(r)o=this.client.profiles.items[f[w]].findAny("triggers",{name:r,pattern:r});else{if(!this.client.profiles.items[f[w]].triggers.length)throw new Error("No triggers exist");o=this.client.profiles.items[f[w]].triggers[this.client.profiles.items[f[w]].triggers.length-1]}else r!==null?o=this.client.profiles.items[f[w]].find("triggers","name",r):o=this.client.profiles.items[f[w]].find("triggers","pattern",t);if(o){s=this.client.profiles.items[f[w]];break}}s||(s=this.client.activeProfile)}}if(a){if(!o)throw new Error(`Trigger '${r||""}' not found`);if(h=new Ie,h.pattern=t,c=!1,t!==null&&(h.pattern=t),e!==null&&(h.value=e),n&&(n.cmd&&(h.type=1),n.pattern&&(h.type=8),n.regular&&(h.type=0),n.alarm&&(h.type=3),n.event&&(h.type=2),n.cmdpattern&&(h.type=16),n.loopexpression&&(h.type=128),n.reparse&&(h.type=131072),n.reparsepattern&&(h.type=262144),n.manual&&(h.type=65536),n.skip&&(h.type=512),n.looplines&&(h.type=8192),n.looppattern&&(h.type=4096),n.wait&&(h.type=1024),n.duration&&(h.type=16384),n.withinlines&&(h.type=32768),n.prompt&&(h.triggerPrompt=!0),n.nocr&&(h.triggerNewline=!1),n.case&&(h.caseSensitive=!0),n.raw&&(h.raw=!0),n.verbatim&&(h.verbatim=!0),n.disable?h.enabled=!1:n.enable&&(h.enabled=!0),(n.temporary||n.temp)&&(h.temp=!0),n.params&&(h.params=n.params),n.type))if(this.isTriggerType(n.type))h.type=this.convertTriggerType(n.type);else throw new Error("Invalid trigger type");o.triggers.push(h),this.client.echo("Trigger sub state added.",-7,-8,!0,!0)}else{if(o)this.client.echo("Trigger updated.",-7,-8,!0,!0);else{if(!t)throw new Error(`Trigger '${r||""}' not found`);o=new Ie,o.name=r||"",o.pattern=t,s.triggers.push(o),this.client.echo("Trigger added.",-7,-8,!0,!0),g=!0}if(t!==null&&(o.pattern=t),e!==null&&(o.value=e),n){if(n.cmd&&(o.type=1),n.pattern&&(o.type=8),n.regular&&(o.type=0),n.alarm&&(o.type=3),n.event&&(o.type=2),n.cmdpattern&&(o.type=16),n.loopexpression&&(o.type=128),n.prompt&&(o.triggerPrompt=!0),n.nocr&&(o.triggerNewline=!1),n.case&&(o.caseSensitive=!0),n.raw&&(o.raw=!0),n.verbatim&&(o.verbatim=!0),n.disable?o.enabled=!1:n.enable&&(o.enabled=!0),(n.temporary||n.temp)&&(o.temp=!0),n.params&&(o.params=n.params),n.type)if(this.isTriggerType(n.type,1))o.type=this.convertTriggerType(n.type);else throw new Error("Invalid trigger type");o.priority=n.priority}else o.priority=0}this.client.saveProfiles(),c&&this.client.clearCache(),g?this.emit("item-added","trigger",s.name,o):this.emit("item-updated","trigger",s.name,s.triggers.indexOf(o),o),s=null}isTriggerType(t,e){switch(e||(e=3),t.replace(/ /g,"").toUpperCase()){case"REGULAREXPRESSION":case"COMMANDINPUTREGULAREXPRESSION":return(e&1)===1;case"0":case"1":case"2":case"3":case"8":case"16":case"128":case"REGULAR":case"COMMANDINPUTREGULAR":case"EVENT":case"ALARM":case"COMMAND":case"COMMANDINPUTPATTERN":case"LOOPEXPRSSION":return(e&1)===1;case"SKIP":case"512":case"WAIT":case"1024":case"LOOPPATTERN":case"4096":case"LOOPLINES":case"8192":case"DURATION":case"16384":case"WITHINLINES":case"32768":case"MANUAL":case"65536":case"REPARSE":case"131072":case"REPARSEPATTERN":case"262144":return(e&2)===2}return!1}convertTriggerType(t){switch(t.replace(/ /g,"").toUpperCase()){case"REGULAREXPRESSION":return 0;case"COMMANDINPUTREGULAREXPRESSION":return 1;case"0":case"1":case"2":case"3":case"8":case"16":case"128":return Ct[parseInt(t,10)];case"REGULAR":case"COMMANDINPUTREGULAR":case"EVENT":case"ALARM":case"COMMAND":case"COMMANDINPUTPATTERN":case"LOOPEXPRSSION":return Ct[t];case"512":case"1024":case"4096":case"8192":case"16384":case"32768":case"65536":case"131072":case"262144":return Tt[parseInt(t,10)];case"SKIP":case"WAIT":case"LOOPPATTERN":case"LOOPLINES":case"DURATION":case"WITHINLINES":case"MANUAL":case"REPARSE":case"REPARSEPATTERN":return Tt[t]}throw new Error("Invalid trigger type")}colorPosition(t,e,s,n){if(t=this.adjustLastLine(t),!n.hasOwnProperty("yStart"))this.client.display.colorSubStringByLine(t,e,s,n.xStart,n.hasOwnProperty("xEnd")&&n.xEnd>=0?n.xEnd:null);else{let r=n.hasOwnProperty("xEnd")&&n.xEnd>=0?n.xEnd:null,a=n.xStart,o=t-n.yStart,h=t;for(n.hasOwnProperty("yEnd")&&(h=t-n.yEnd);o<=h;)this.client.display.colorSubStringByLine(o,e,s,a,r),o++}}};function ne(m){this.ok=!1,m.charAt(0)=="#"&&(m=m.substr(1,6)),m=m.replace(/ /g,""),m=m.toLowerCase();var u={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(var t in u)m==t&&(m=u[t]);for(var e=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(c){return[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(c){return[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(c){return[parseInt(c[1]+c[1],16),parseInt(c[2]+c[2],16),parseInt(c[3]+c[3],16)]}}],s=0,n=e.length;s<n;s++){var r=e[s].re,a=e[s].process,o=r.exec(m);if(o){var h=a(o);this.r=h[0],this.g=h[1],this.b=h[2],this.ok=!0}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r,this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g,this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var c=this.r.toString(16),g=this.g.toString(16),f=this.b.toString(16);return c.length==1&&(c="0"+c),g.length==1&&(g="0"+g),f.length==1&&(f="0"+f),"#"+c+g+f}}var ye=(T=>(T[T.None=0]="None",T[T.B=1]="B",T[T.BOLD=2]="BOLD",T[T.STRONG=3]="STRONG",T[T.I=4]="I",T[T.ITALIC=5]="ITALIC",T[T.EM=6]="EM",T[T.U=7]="U",T[T.UNDERLINE=8]="UNDERLINE",T[T.S=9]="S",T[T.STRIKEOUT=10]="STRIKEOUT",T[T.STRIKE=11]="STRIKE",T[T.C=12]="C",T[T.COLOR=13]="COLOR",T[T.H=14]="H",T[T.HIGH=15]="HIGH",T[T.FONT=16]="FONT",T[T.HR=17]="HR",T[T.NOBR=18]="NOBR",T[T.P=19]="P",T[T.BR=20]="BR",T[T.SBR=21]="SBR",T[T.A=22]="A",T[T.SEND=23]="SEND",T[T.EXPIRE=24]="EXPIRE",T[T.VERSION=25]="VERSION",T[T.SUPPORT=26]="SUPPORT",T[T.RESET=27]="RESET",T[T.H1=28]="H1",T[T.H2=29]="H2",T[T.H3=30]="H3",T[T.H4=31]="H4",T[T.H5=32]="H5",T[T.H6=33]="H6",T[T.V=34]="V",T[T.VAR=35]="VAR",T[T.USER=36]="USER",T[T.PASSWORD=37]="PASSWORD",T[T.Custom=38]="Custom",T[T.GAUGE=39]="GAUGE",T[T.STAT=40]="STAT",T))(ye||{});var Gt=class{constructor(){this.on=!1;this.lineType=0;this.locked=!1;this.paragraph=!1;this.noBreak=!1;this.expanded=!1;this.lineExpanded=!1;this.capture=0;this.captured=[];this.gagged=!1}},Wt=class{constructor(u){this.name="";this.value="";this.description="";this.publish=!1;this.remote=!1;this.remote=u??!1}},gi=class{constructor(u){this.name="";this.definition="";this.closeDefinition="";this.attributes={};this.attributeIndexes=[];this.tag=-1;this.flag="";this.open=!1;this.empty=!1;this.remote=!1;this.gagged=!1;this.remote=u??!1}},Ht=class{constructor(u,t,e,s){this.index=-1;this.window="";this.gag=!1;this.fore="";this.back="";this.enabled=!0;this.remote=!1;this.element="";this.definition="";this.closeDefinition="";u!=null&&(this.index=u),t!=null&&(this.fore=t),e!=null&&(this.back=e),s!=null&&(this.remote=s)}},bt=class{constructor(u,t,e,s,n){this.tag=0;this.custom="";this.font=null;this.fontSize=null;this.style=0;this.fore="";this.back="";this.high=!1;this.obj=null;this.gagged=!1;this.open=!1;this.properties=null;u!=null&&(this.style=u),t!=null&&(this.fore=t),e!=null&&(this.back=e),this.high=s||!1,this.open=n||!1}},Ut=class extends pe{constructor(t){super();this.parsing=[];this.protocols=[["m","a","i","l","t","o"],["s","k","y","p","e"],["a","i","m"],["c","a","l","l","t","o"],["g","t","a","l","k"],["i","m"],["i","t","m","s"],["m","s","n","i","m"],["t","e","l"],["y","m","s","g","r"]];this._ColorTable=null;this._CurrentForeColor=37;this._CurrentBackColor=40;this._CurrentAttributes=0;this._SplitBuffer="";this.mxpState=new Gt;this.mxpStyles=[];this.mxpEntities={};this.mxpElements={};this.mxpLines=[];this.iMXPDefaultMode=0;this.displayControlCodes=!1;this.emulateControlCodes=!0;this.StyleVersion="";this.EndOfLine=!1;this.textLength=0;this.rawLength=0;this.enableMXP=!0;this.DefaultImgUrl="";this.enableDebug=!1;this.showInvalidMXPTags=!1;this.enableLinks=!0;this.enableMSP=!0;this.enableURLDetection=!0;this.window=new ft(0,0);this.enableFlashing=!1;this.emulateTerminal=!1;this.enableBell=!0;this.display=null;this.tabWidth=8;this.busy=!1;t!=null&&(t.DefaultImageURL&&(this.DefaultImgUrl=t.DefaultImageURL),t.enableMXP!=null&&(this.enableMXP=t.enableMXP),t.enableDebug!=null&&(this.enableDebug=t.enableDebug),t.showInvalidMXPTags!=null&&(this.showInvalidMXPTags=t.showInvalidMXPTags),t.enableMSP!=null&&(this.enableMSP=t.enableMSP),t.enableURLDetection!=null&&(this.enableURLDetection=t.enableURLDetection),t.window!=null&&(this.window=t.window),t.enableFlashing!=null&&(this.enableFlashing=t.enableFlashing),t.emulateTerminal!=null&&(this.emulateTerminal=t.emulateTerminal),t.enableBell!=null&&(this.enableBell=t.enableBell),t.display!=null&&(this.display=t.display),t.enableLinks&&(this.enableLinks=t.enableLinks))}getColors(t){typeof t>"u"&&(t=this.GetCurrentStyle());let e,s,n=-1,r=-1;return t.fore.length>0?(this._CurrentAttributes&1)===1?e=this.IncreaseColor(t.fore,.5):(this._CurrentAttributes&2)===2?e=this.DecreaseColor(t.fore,.5):e=t.fore:typeof this._CurrentForeColor=="string"?e="rgb("+this._CurrentForeColor.replace(/;/g,",")+")":(e=this._CurrentForeColor,(this._CurrentAttributes&1)===1?(e>999&&(e/=1e3),e>=0&&e<99&&(e*=10),n=e,e<=-16&&(e=this.IncreaseColor(this.GetColor(e),.5))):(this._CurrentAttributes&2)===2?(e>99&&e<999&&(e/=10),e>=0&&e<999&&(e*=100),n=e,e<=-16&&(e=this.DecreaseColor(this.GetColor(e),.15))):n=e),t.high&&(typeof e=="number"?e=this.IncreaseColor(this.GetColor(e),.25):e=this.IncreaseColor(e,.25)),t.back.length>0?s=t.back:typeof this._CurrentBackColor=="string"?s="rgb("+this._CurrentBackColor.replace(/;/g,",")+")":s=r=this._CurrentBackColor,(this._CurrentAttributes&64)===64||(t.style&64)===64?{fore:s,back:e,foreCode:r,backCode:n}:{fore:e,back:s,foreCode:n,backCode:r}}getFormatBlock(t){let e=this.GetCurrentStyle(),s=this.getColors(e);return{formatType:0,offset:t,color:s.fore||0,background:s.back||0,size:e.fontSize||0,font:e.font||0,style:e.style|this._CurrentAttributes&-2,unicode:!1}}ResetColors(){this._CurrentForeColor=37,this._CurrentBackColor=40,this._CurrentAttributes=0}ProcessAnsiColorParams(t){let e=0,s=t.length,n,r;for(;e<s;e++)switch(n=+t[e]||0,n){case 0:this.ResetColors();break;case 1:this._CurrentAttributes|=1,this._CurrentAttributes&=-3;break;case 2:this._CurrentAttributes|=2,this._CurrentAttributes&=-2;break;case 3:this._CurrentAttributes|=4;break;case 4:this._CurrentAttributes|=8;break;case 5:this._CurrentAttributes|=16;break;case 6:this._CurrentAttributes|=32;break;case 7:this._CurrentAttributes|=64;break;case 8:this._CurrentAttributes|=128;break;case 9:this._CurrentAttributes|=256;break;case 21:this._CurrentAttributes|=512;break;case 22:this._CurrentAttributes&=-2,this._CurrentAttributes&=-3;break;case 23:this._CurrentAttributes&=-5;break;case 24:this._CurrentAttributes&=-9,this._CurrentAttributes&=-513;break;case 25:this._CurrentAttributes&=-17;break;case 26:this._CurrentAttributes&=-33;break;case 27:this._CurrentAttributes&=-65;break;case 28:this._CurrentAttributes&=-129;break;case 29:this._CurrentAttributes&=-257;break;case-11:case-7:case-3:case 30:case 31:case 32:case 33:case 34:case 35:case 36:case 37:this._CurrentForeColor=n;break;case 38:if(e+2<s&&t[e+1]==="5")this._CurrentForeColor=+t[e+2],isNaN(this._CurrentForeColor)?this._CurrentForeColor=37:(this._CurrentForeColor+=16,this._CurrentForeColor*=-1),e+=2;else if(e+4<s&&t[e+1]==="2"){if(n=+t[e+2]||0,n<0||n>255||(r=n+";",n=+t[e+3]||0,n<0||n>255)||(r+=n+";",n=+t[e+4]||0,n<0||n>255))continue;r+=n,this._CurrentForeColor=r,e+=4}break;case 39:this._CurrentForeColor=-1;break;case-12:case-8:case-4:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:this._CurrentBackColor=n;break;case 48:if(e+2<s&&t[e+1]==="5")this._CurrentBackColor=+t[e+2],isNaN(this._CurrentBackColor)?this._CurrentBackColor=40:(this._CurrentBackColor+=16,this._CurrentBackColor*=-1),e+=2;else if(e+4<s&&t[e+1]==="2"){if(n=+t[e+2]||0,n<0||n>255||(r=n+";",n=+t[e+3]||0,n<0||n>255)||(r+=n+";",n=+t[e+4]||0,n<0||n>255))continue;r+=n,this._CurrentBackColor=r,e+=4}break;case 49:this._CurrentBackColor=-2;break;case 53:this._CurrentAttributes|=1024;break;case 55:this._CurrentAttributes&=-1025;break;case 50:case 51:case 52:case 54:case 56:case 57:case 58:case 59:this._CurrentForeColor=n-20,this._CurrentAttributes|=1;break;case 90:case 91:case 92:case 93:case 94:case 95:case 96:case 97:this._CurrentForeColor=n;break;case 100:case 101:case 102:case 103:case 104:case 105:case 106:case 107:this._CurrentBackColor=n;break}}buildColorTable(){let t=[],e,s,n,r;for(e=0;e<6;e++)for(s=0;s<6;s++)for(n=0;n<6;n++)r=16+e*36+s*6+n,t[r]="rgb(",e>0?t[r]+=e*40+55:t[r]+="0",t[r]+=",",s>0?t[r]+=s*40+55:t[r]+="0",t[r]+=",",n>0?t[r]+=n*40+55:t[r]+="0",t[r]+=")";for(e=232;e<=255;e++)s=(e-232)*10+8,t[e]=["rgb(",s,",",s,",",s,")"].join("");t[0]="rgb(0,0,0)",t[1]="rgb(128, 0, 0)",t[2]="rgb(0, 128, 0)",t[3]="rgb(128, 128, 0)",t[4]="rgb(0, 0, 238)",t[5]="rgb(128, 0, 128)",t[6]="rgb(0, 128, 128)",t[7]="rgb(187, 187, 187)",t[8]="rgb(128, 128, 128)",t[9]="rgb(255, 0, 0)",t[10]="rgb(0, 255, 0)",t[11]="rgb(255, 255, 0)",t[12]="rgb(92, 92, 255)",t[13]="rgb(255, 0, 255)",t[14]="rgb(0, 255, 255)",t[15]="rgb(255, 255, 255)",t[256]="rgb(0, 0, 0)",t[257]="rgb(118, 0, 0)",t[258]="rgb(0, 108, 0)",t[259]="rgb(145, 136, 0)",t[260]="rgb(0, 0, 167)",t[261]="rgb(108, 0, 108)",t[262]="rgb(0, 108, 108)",t[263]="rgb(161, 161, 161)",t[264]="rgb(0, 0, 0)",t[265]="rgb(128, 0, 0)",t[266]="rgb(0, 128, 0)",t[267]="rgb(128, 128, 0)",t[268]="rgb(0, 0, 238)",t[269]="rgb(128, 0, 128)",t[270]="rgb(0, 128, 128)",t[271]="rgb(187, 187, 187)",t[272]="rgb(0,0,0)",t[273]="rgb(0, 255, 255)",t[274]="rgb(0,0,0)",t[275]="rgb(255, 255, 0)",t[276]="rgb(0, 0, 0)",t[277]="rgb(229, 229, 229)",t[278]="rgb(205, 0, 0)",t[279]="rgb(229, 229, 229)",t[280]="rgb(255,255,255)",this._ColorTable=t}GetColor(t){switch(this._ColorTable==null&&this.buildColorTable(),t){case-12:return this._ColorTable[279];case-11:return this._ColorTable[278];case-10:return this._ColorTable[280];case-8:return this._ColorTable[272];case-7:return this._ColorTable[273];case-4:return this._ColorTable[274];case-3:return this._ColorTable[275];case 49:case-2:return this._ColorTable[276];case 39:case-1:return this._ColorTable[277];case 0:case 30:return this._ColorTable[0];case 1:case 31:return this._ColorTable[1];case 2:case 32:return this._ColorTable[2];case 3:case 33:return this._ColorTable[3];case 4:case 34:return this._ColorTable[4];case 5:case 35:return this._ColorTable[5];case 6:case 36:return this._ColorTable[6];case 7:case 37:return this._ColorTable[7];case 40:return this._ColorTable[264];case 41:return this._ColorTable[265];case 42:return this._ColorTable[266];case 43:return this._ColorTable[267];case 44:return this._ColorTable[268];case 45:return this._ColorTable[269];case 46:return this._ColorTable[270];case 47:return this._ColorTable[271];case 8:case 90:case 100:case 300:case 400:return this._ColorTable[8];case 9:case 91:case 101:case 310:case 410:return this._ColorTable[9];case 10:case 92:case 102:case 320:case 420:return this._ColorTable[10];case 11:case 93:case 103:case 330:case 430:return this._ColorTable[11];case 12:case 94:case 104:case 340:case 440:return this._ColorTable[12];case 13:case 95:case 105:case 350:case 450:return this._ColorTable[13];case 14:case 96:case 106:case 360:case 460:return this._ColorTable[14];case 15:case 97:case 107:case 370:case 470:return this._ColorTable[15];case 4e3:case 3e3:return this._ColorTable[256];case 4100:case 3100:return this._ColorTable[257];case 4200:case 3200:return this._ColorTable[258];case 4300:case 3300:return this._ColorTable[259];case 4400:case 3400:return this._ColorTable[260];case 4500:case 3500:return this._ColorTable[261];case 4600:case 3600:return this._ColorTable[262];case 4700:case 3700:return this._ColorTable[263];default:return t<=-16&&(t+=16,t*=-1),t>=0&&t<281?this._ColorTable[t]:this._ColorTable[277]}}SetColor(t,e){this._ColorTable==null&&this.buildColorTable(),!(t<0||t>=this._ColorTable.length)&&(e=new ne(e),e.ok&&(this._ColorTable[t]=e.toRGB()))}AddLine(t,e,s,n,r,a){let o={raw:e,line:t,fragment:s,gagged:n,formats:this.pruneFormats(r,t.length,s),remote:a};this.emit("add-line",o),this.EndOfLine=!s}pruneFormats(t,e,s){if(!t||t.length<2)return t;let n=t.length,r=[];for(let a=0;a<n;a++){let o=t[a],h;if(a<n-1){let c=t[a+1];if(o.offset===c.offset&&c.formatType===o.formatType||(h=c.offset,o.formatType===1&&h-o.offset===0&&c.formatType===2)||o.formatType===7&&h-o.offset===0&&c.formatType===8||o.formatType===3&&h-o.offset===0&&c.formatType===4)continue}else if(!s&&o.offset===e&&e!==0&&(o.formatType===0&&!o.hr||o.formatType===1||o.formatType===7||o.formatType===3))continue;r.push(o)}return r}GetEntity(t){return t==="text"?t:this.mxpEntities[t]?(this.mxpState.expanded=!0,this.mxpEntities[t].value):t}ClearMXPToTag(t,e,s){e==null&&(e="");let n=new bt;n.tag=0;let r=this.mxpStyles.length-1;for(;r>=0&&(this.mxpStyles[r].tag!==t&&this.mxpStyles[r].custom!==e);r--){if(!this.mxpStyles[r].open&&!s)continue;n=this.mxpStyles.splice(r,1)[0]}return r>=0&&this.mxpStyles.length>0?n=this.mxpStyles.splice(r,1)[0]:this.mxpStyles.length===0&&this.ResetMXP(),n}ClearMXPOpen(){let t=this.mxpStyles.length;for(;t--;)this.mxpStyles[t].open&&this.mxpStyles.splice(t,1);this.mxpStyles.length===0&&this.ResetMXP()}getMXPOpenFormatBlocks(){if(!this.mxpState.on)return[];let t=0,e=this.mxpStyles.length,s=[];for(;t<e;t++)(this.mxpStyles[t].tag===22||this.mxpStyles[t].tag===23)&&s.push(Object.assign({},this.mxpStyles[t].properties));return s}getMXPCloseFormatBlocks(){if(!this.mxpState.on)return[];let t=this.mxpStyles.length,e=[];for(;t--;)this.mxpStyles[t].tag===22?e.push({formatType:4}):this.mxpStyles[t].tag===23&&e.push({formatType:8});return e}getMXPBlock(t,e,s,n,r){let a,o,h,c,g,f,w=e.length,p,k,E,b="",v="",M="",B=!1;switch(t=t.toUpperCase(),this.enableDebug&&(this.emit("debug","MXP Tag: "+t),this.emit("debug","MXP Tag Args: "+e)),t){case"C":case"COLOR":if(a=this.CloneCurrentStyle(),a.tag=ye[t],a.open=!0,w>0)if(o=e[0].split("="),o.length>1){if(g=new ne(Z(o[1])),!g.ok)return null;o[0].toUpperCase()==="BACK"?a.back=g.toRGB():a.fore=g.toRGB()}else g=new ne(Z(o[0])),g.ok&&(a.fore=g.toRGB());if(w>1)if(o=e[1].split("="),o.length>1){if(g=new ne(Z(o[1])),!g.ok)return null;o[0].toUpperCase()==="FORE"?a.fore=g.toRGB():a.back=g.toRGB()}else g=new ne(Z(o[0])),g.ok&&(a.back=g.toRGB());return a.custom="",this.mxpStyles.push(a),null;case"B":case"BOLD":case"STRONG":return a=this.CloneCurrentStyle(),a.open=!0,a.tag=ye[t],a.style|=1,a.custom="",this.mxpStyles.push(a),null;case"FONT":for(a=this.CloneCurrentStyle(),a.open=!0,a.tag=ye[t],f=0;f<w;f++)if(o=e[f].split("="),o.length>1)switch(o[0].toUpperCase()){case"SIZE":this.isNumber(o[1])?a.fontSize=o[1]+"pt":a.fontSize=o[1]||0;break;case"COLOR":for(c=o[1].split(","),g=new ne(Z(c[0])),g.ok&&(a.fore=g.toRGB()),E=1,k=c.length;E<k;E++)switch(c[E].toLowerCase()){case"bold":a.style|=1;break;case"italic":a.style|=4;break;case"underline":a.style|=8;break;case"blink":a.style|=16;break;case"inverse":a.style|=64;break;case"hidden":a.style|=128;break;case"strikeout":a.style|=256;break;case"overline":a.style|=1024;break;case"doubleunderline":a.style|=512;break}break;case"BACK":g=new ne(Z(o[1])),g.ok&&(a.back=g.toRGB());break;case"FACE":a.font=Z(o[1])||0;break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+o[0]);break}else f===0?a.font=Z(e[f])||0:f===1?this.isNumber(e[f])?a.fontSize=e[f]+"pt":a.fontSize=e[f]||0:f===2?(g=new ne(Z(e[f])),g.ok&&(a.fore=g.toRGB())):f===3&&(g=new ne(Z(e[f])),g.ok&&(a.back=g.toRGB()));return a.custom="",this.mxpStyles.push(a),null;case"H":case"HIGH":return a=this.CloneCurrentStyle(),a.open=!0,a.tag=ye[t],a.high=!0,a.custom="",this.mxpStyles.push(a),null;case"I":case"ITALIC":case"EM":return a=this.CloneCurrentStyle(),a.open=!0,a.tag=ye[t],a.style|=4,a.custom="",this.mxpStyles.push(a),null;case"U":case"UNDERLINE":return a=this.CloneCurrentStyle(),a.open=!0,a.tag=ye[t],a.style|=8,a.custom="",this.mxpStyles.push(a),null;case"S":case"STRIKEOUT":return a=this.CloneCurrentStyle(),a.open=!0,a.tag=ye[t],a.style|=256,a.custom="",this.mxpStyles.push(a),null;case"/B":case"/BOLD":case"/STRONG":case"/H":case"/HIGH":case"/I":case"/ITALIC":case"/EM":case"/U":case"/UNDERLINE":case"/S":case"/STRIKEOUT":case"/C":case"/COLOR":case"/FONT":return this.ClearMXPToTag(ye[t.substring(1)]),null}if(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4)switch(t){case"IMAGE":for(p={formatType:5,name:"",url:this.DefaultImgUrl,t:"",h:"",w:"",hspace:"",vspace:"",align:"bottom",ismap:!1},f=0;f<w;f++)switch(o=e[f].split("="),o[0].toUpperCase()){case"FNAME":p.name=Z(o[1]);break;case"URL":p.url=Z(o[1]);break;case"TYPE":case"T":o[1].length>0&&(p.type=o[1]);break;case"HEIGHT":case"H":p.h=Z(o[1]);break;case"WIDTH":case"W":p.w=Z(o[1]);break;case"HSPACE":p.hspace=o[1];break;case"VSPACE":p.vspace=o[1];break;case"ALIGN":p.align=o[1].toLowerCase();break;case"ISMAP":p.ismap=!0;break;default:f===0?p.name=Z(e[f]):f===1?p.url=Z(e[f]):f===2&&e[f].length>0?p.type=e[f]:f===3?p.h=Z(e[f]):f===4?p.w=Z(e[f]):f===5?p.hspace=e[f]:f===6?p.vspace=e[f]:f===7&&(p.align=e[f].toLowerCase());break}return{format:p,text:null};case"!AT":case"!ATTLIST":if(e.length===0||(p=e[0],!this.mxpElements[p]||this.mxpEntities[p].remote!==p.remote&&!this.mxpEntities[p].open))return null;for(this.mxpElements[p].attributes={},this.mxpElements[p].attributeIndexes=[],f=1;f<w;f++)c=e[f].split("="),c.length>1?this.mxpElements[p].attributes[c[0].toLowerCase()]=c[1]:this.mxpElements[p].attributes[c[0].toLowerCase()]="",this.mxpElements[p].attributeIndexes.push(c[0].toLowerCase());break;case"!TAG":for(p=new Ht,p.remote=s,f=0;f<w;f++)switch(o=e[f].split("="),o[0].toUpperCase()){case"WINDOWNAME":p.window=Z(o[1]);break;case"FORE":g=new ne(Z(o[1])),g.ok&&(p.fore=g.toRGB());break;case"BACK":g=new ne(Z(o[1])),g.ok&&(p.back=g.toRGB());break;case"GAG":p.gag=!0;break;case"ENABLE":p.enabled=!0;break;case"DISABLE":p.enabled=!1;break;default:f===0?(a=+e[f],isNaN(a)||(p.index=a)):f===1?p.window=Z(e[f]):f===2?(g=new ne(Z(e[f])),g.ok&&(p.fore=g.toRGB())):f===3&&(g=new ne(Z(e[f])),g.ok&&(p.back=g.toRGB()));break}p.fore.length>0&&p.back.length>0?p.definition=`<C "${p.fore}" "${p.back}">`:p.fore.length>0?p.definition=`<C "${p.fore}">`:p.back.length>0&&(p.definition=`<C BACK="${p.fore}">`),p.definition.length>0&&(p.closeDefinition="</C>"),this.mxpLines[p.index]?(p.remote||this.mxpLines[p.index].remote===p.remote)&&(this.mxpLines[p.index]=p):this.mxpLines[p.index]=p;break;case"!EL":case"!ELEMENT":for(p=new gi(s),f=0;f<w;f++){if(e[f].toUpperCase().startsWith("ATT=")){for(o=Z(e[f]).substring(4).split(" "),E=0,k=o.length;E<k;E++)c=Z(o[E]).split("="),c.length>1?p.attributes[c[0].toLowerCase()]=Z(c[1]):p.attributes[c[0].toLowerCase()]="",p.attributeIndexes.push(c[0].toLowerCase());continue}switch(o=e[f].split("="),o[0].toUpperCase()){case"TAG":a=+o[1],isNaN(a)||(p.tag=a);break;case"FLAG":p.flag=Z(o[1]);break;case"OPEN":p.open=!0;break;case"DELETE":return this.mxpElements[p.name]&&(this.mxpEntities[p.name].remote===p.remote||this.mxpEntities[p.name].open)&&delete this.mxpEntities[p.name],null;case"EMPTY":p.empty=!0;break;case"SECURE":p.open=!1;break;default:if(f===0)p.name=Z(e[f]).toUpperCase();else if(f===1)p.definition=Z(e[f]),p.closeDefinition=this.GetCloseTags(p.definition),this.enableDebug&&this.emit("debug","MXP close definition: "+p.closeDefinition);else if(f===2)for(o=e[f].substring(4).split(" "),E=0,k=o.length;E<k;E++)c=o[E].split("="),c.length>1?p.attributes[c[0]]=c[1]:p.attributes[c[0]]="",p.attributeIndexes.push(c[0]);else f===3?(a=+e[f],isNaN(a)||(p.tag=a)):f===4&&(p.flag=Z(e[f]));break}}p.tag>19&&p.tag<100&&(a=new Ht(p.tag),a.element=p.name,this.mxpLines[a.index]?(p.remote||this.mxpLines[a.index].remote===p.remote)&&(this.mxpLines[a.index]=a):this.mxpLines[a.index]=a),this.mxpElements[p.name]?(this.mxpElements[p.name].remote===p.remote||this.mxpEntities[p.name].open)&&(this.mxpElements[p.name]=p):this.mxpElements[p.name]=p;break;case"!EN":case"!ENTITY":for(p=new Wt(s),f=0;f<w;f++)switch(o=e[f].split("="),o[0].toUpperCase()){case"DESC":p.description=Z(o[1]);break;case"PRIVATE":p.publish=!1;break;case"PUBLISH":p.publish=!0;break;case"DELETE":return this.mxpEntities[p.name]&&this.mxpEntities[p.name].remote===p.remote&&delete this.mxpEntities[p.name],null;case"ADD":if(this.mxpEntities[p.name]&&this.mxpEntities[p.name].remote===p.remote)return this.mxpEntities[p.name].value?this.mxpEntities[p.name].value+="|"+p.value:this.mxpEntities[p.name].value=p.value,null;break;case"REMOVE":if(this.mxpEntities[p.name]&&this.mxpEntities[p.name].remote===p.remote&&this.mxpEntities[p.name].value){for(c=this.mxpEntities[p.name].value.split("|"),h=[],E=0,k=c.length;E<k;E++)c[E]!==p.value&&h.push(c[E]);this.mxpEntities[p.name].value=h.join("|")}return null;default:f===0?p.name=Z(e[f]):f===1?p.value=Z(e[f]):f===2&&(p.description=Z(e[f]));break}this.mxpEntities[p.name]?this.mxpEntities[p.name].remote===p.remote&&(this.mxpEntities[p.name]=p):this.mxpEntities[p.name]=p;break;case"/V":case"/VAR":for(a=this.ClearMXPToTag(ye[t.substring(1)]),p=new Wt(s),this.mxpState.captured.length>0?p.value=this.mxpState.captured.pop().join(""):p.value="",this.mxpState.capture--,this.enableDebug&&this.emit("debug","MXP captured: "+p.value),e=a.obj,w=e.length,f=0;f<w;f++)switch(o=e[f].split("="),o[0].toUpperCase()){case"DESC":p.description=Z(o[1]);break;case"PRIVATE":p.publish=!1;break;case"PUBLISH":p.publish=!0;break;case"DELETE":return this.mxpEntities[p.name]&&this.mxpEntities[p.name].remote===p.remote&&delete this.mxpEntities[p.name],null;case"ADD":if(this.mxpEntities[p.name]&&this.mxpEntities[p.name].remote===p.remote)return this.mxpEntities[p.name].value?this.mxpEntities[p.name].value+="|"+p.value:this.mxpEntities[p.name].value=p.value,null;break;case"REMOVE":if(this.mxpEntities[p.name]&&this.mxpEntities[p.name].remote===p.remote&&this.mxpEntities[p.name].value){for(c=this.mxpEntities[p.name].value.split("|"),h=[],E=0,k=c.length;E<k;E++)c[E]!==p.value&&h.push(c[E]);this.mxpEntities[p.name].value=h.join("|")}return null;default:f===0?p.name=Z(e[f]):f===1&&(p.description=Z(e[f]));break}this.mxpEntities[p.name]?this.mxpEntities[p.name].remote===p.remote&&(this.mxpEntities[p.name]=p):this.mxpEntities[p.name]=p;break;case"V":case"VAR":return this.mxpState.captured.push([]),this.mxpState.capture++,a=this.CloneCurrentStyle(),a.open=!1,a.tag=ye[t],a.obj=e,a.custom="",this.mxpStyles.push(a),null;case"GAUGE":for(p={value:0,max:1,caption:"",color:0},f=0;f<w;f++)if(o=e[f].split("="),o.length>1)switch(o[0].toUpperCase()){case"VALUE":a=parseFloat(this.GetEntity(o[1])),isNaN(a)&&(a=this.GetEntity(o[1])),p.value=a;break;case"MAX":a=parseFloat(this.GetEntity(o[1])),isNaN(a)&&(a=this.GetEntity(o[1])),p.max=a;break;case"CAPTION":o[1].length>0&&(p.caption=Z(o[1]));break;case"COLOR":g=new ne(Z(o[1])),g.ok&&(p.color=g.toRGB());break}else f===0?(a=parseFloat(this.GetEntity(e[f])),isNaN(a)&&(a=this.GetEntity(e[f])),p.value=a):f===1?(a=parseFloat(this.GetEntity(e[f])),isNaN(a)&&(a=this.GetEntity(e[f])),p.max=a):f===2&&e[f].length>0?p.caption=Z(e[f]):f===3&&e[f].length>0&&(g=new ne(Z(o[1])),g.ok&&(p.color=g.toRGB()));this.mxpState.expanded=!1,this.emit("gauge",p);break;case"STAT":for(p={value:0,max:1,caption:""},f=0;f<w;f++)if(o=e[f].split("="),o.length>1)switch(o[0].toUpperCase()){case"VALUE":a=parseFloat(this.GetEntity(o[1])),isNaN(a)&&(a=this.GetEntity(o[1])),p.value=a;break;case"MAX":a=parseFloat(this.GetEntity(o[1])),isNaN(a)&&(a=this.GetEntity(o[1])),p.max=a;break;case"CAPTION":o[1].length>0&&(p.caption=Z(o[1]));break}else f===0?(a=parseFloat(this.GetEntity(e[f])),isNaN(a)&&(a=this.GetEntity(e[f])),p.value=a):f===1?(a=parseFloat(this.GetEntity(e[f])),isNaN(a)&&(a=this.GetEntity(e[f])),p.max=a):f===2&&e[f].length>0&&(p.caption=Z(e[f]));this.mxpState.expanded=!1,this.emit("stat",p);break;case"MUSIC":for(p={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},f=0;f<w;f++)if(o=e[f].split("="),o.length>1)switch(o[0].toUpperCase()){case"FNAME":p.file=Z(o[1]),p.file.toLowerCase()==="off"&&(p.off=!0,p.file="");break;case"V":a=+o[1],isNaN(a)&&(a=100),p.volume=a;break;case"L":a=+o[1],isNaN(a)&&(a=1),p.repeat=a;break;case"C":p.continue=o[1]!=="0";break;case"T":o[1].length>0&&(p.type=o[1]);break;case"U":p.url=Z(o[1]),!p.url.endsWith("/")&&p.url.length>0&&(p.url+="/");break}else f===0?(p.file=Z(e[f]),p.file.toLowerCase()==="off"&&(p.off=!0,p.file="")):f===1?(a=+e[f],isNaN(a)&&(a=100),p.volume=a):f===2?(a=+e[f],isNaN(a)&&(a=1),p.repeat=a):f===3?p.continue=e[f]!=="0":f===4?e[f].length>0&&(p.type=e[f]):f===5&&(p.url=Z(e[f]),!p.url.endsWith("/")&&p.url.length>0&&(p.url+="/"));this.emit("music",p);break;case"SOUND":for(p={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},f=0;f<w;f++)if(o=e[f].split("="),o.length>1)switch(o[0].toUpperCase()){case"FNAME":p.file=Z(o[1]),p.file.toLowerCase()==="off"&&(p.off=!0,p.file="");break;case"V":a=+o[1],isNaN(a)&&(a=100),p.volume=a;break;case"L":a=+o[1],isNaN(a)&&(a=1),p.repeat=a;break;case"P":a=+o[1],isNaN(a)&&(a=1),p.priority=a;break;case"T":o[1].length>0&&(p.type=o[1]);break;case"U":p.url=Z(o[1]),!p.url.endsWith("/")&&p.url.length>0&&(p.url+="/");break}else f===0?(p.file=Z(e[f]),p.file.toLowerCase()==="off"&&(p.off=!0,p.file="")):f===1?(a=+e[f],isNaN(a)&&(a=100),p.volume=a):f===2?(a=+e[f],isNaN(a)&&(a=1),p.repeat=a):f===3?(a=+e[f],isNaN(a)&&(a=1),p.priority=a):f===4?e[f].length>0&&(p.type=e[f]):f===5&&(p.url=Z(e[f]),!p.url.endsWith("/")&&p.url.length>0&&(p.url+="/"));this.emit("sound",p);break;case"EXPIRE":this.emit("expire-links",e),this.cleanMXPExpired(r,e?.[0]||"");break;case"VERSION":w>0?this.StyleVersion=e[0]:this.emit("MXP-tag-reply",t,[]);break;case"USER":case"PASSWORD":this.emit("MXP-tag-reply",t,e);break;case"SUPPORT":if(c=[],w>0)for(f=0;f<w;f++)if(o=Z(e[f]),o.indexOf(".")===-1)switch(o=o.toUpperCase(),o){case"IMAGE":case"HR":case"A":case"SEND":case"B":case"I":case"COLOR":case"C":case"EM":case"ITALIC":case"STRONG":case"BOLD":case"UNDERLINE":case"U":case"S":case"STRIKEOUT":case"STRIKE":case"H":case"HIGH":case"EXPIRE":case"VERSION":case"SUPPORT":case"NOBR":case"P":case"BR":case"SBR":case"SOUND":case"MUSIC":case"VAR":case"USER":case"PASSWORD":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"RESET":case"GAUGE":case"STAT":c.push("+"+name);break;default:c.push("-"+name);break}else switch(o=e[f].split("."),o[0]=o[0].toUpperCase(),o[0]){case"IMAGE":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):(c.push("+image.fname"),c.push("+image.url"),c.push("+image.t"),c.push("+image.h"),c.push("+image.w"),c.push("+image.hspace"),c.push("+image.vspace"),c.push("+image.align"),c.push("+image.ismap"));break;case"SOUND":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):(c.push("+sound.v"),c.push("+sound.l"),c.push("+sound.p"),c.push("+sound.t"),c.push("+sound.u"));break;case"MUSIC":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):(c.push("+music.v"),c.push("+music.l"),c.push("+music.c"),c.push("+music.t"),c.push("+music.u"));break;case"A":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):(c.push("+a.href"),c.push("+a.hint"),c.push("+a.expire"));break;case"SEND":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):(c.push("+send.href"),c.push("+send.hint"),c.push("+send.prompt"),c.push("+send.expire"));break;case"COLOR":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):(c.push("+color.fore"),c.push("+color.back"));break;case"C":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):(c.push("+c.fore"),c.push("+c.back"));break;case"FONT":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):(c.push("-font.face"),c.push("-font.size"),c.push("+font.color"),c.push("+font.back"));break;case"EXPIRE":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):c.push("+expire.Name");break;case"GAUGE":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):(c.push("+gauge.max"),c.push("+gauge.caption"),c.push("+gauge.color"));break;case"STAT":o[1]!=="*"?c.push("+"+o[0]+"."+o[1]):(c.push("+stat.max"),c.push("+stat.caption"));break;default:o[1]!=="*"?c.push("-"+o[0]+"."+o[1]):c.push("-"+o[0]);break}else c=["+A","+SEND","+B","+I","+COLOR","+C","+EM","+ITALIC","+STRONG","+BOLD","+UNDERLINE","+U","+S","+STRIKEOUT","+H","+HIGH","-FONT","+EXPIRE","+VERSION","+SUPPORT","+NOBR","+P","+BR","+SBR","+VAR","+SOUND","+MUSIC","+USER","+PASSWORD","+RESET","+STRIKE","+H1","+H2","+H3","+H4","+H5","+H6","+IMAGE","+STAT","+GAUGE"];this.emit("MXP-tag-reply",t,c);break;case"A":for(a=this.CloneCurrentStyle(),a.open=!1,a.tag=ye[t],f=0;f<w;f++)if(o=e[f].split("="),o.length>1)switch(o[0].toUpperCase()){case"HREF":b=Z(o[1]);break;case"HINT":v=Z(o[1]);break;case"EXPIRE":M=Z(o[1]);break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+o[0]);break}else f===0?b=Z(e[f]):f===1?v=Z(e[f]):f===2&&(M=Z(e[f]));return a.custom="",a.properties={formatType:3,href:b,hint:v,expire:M},this.mxpStyles.push(a),v.length===0&&(v=b),{format:{formatType:3,href:b,hint:v,expire:M},text:null};case"SEND":for(a=this.CloneCurrentStyle(),a.open=!1,a.tag=ye[t],f=0;f<w;f++)if(o=e[f].split("="),o[0]==="PROMPT")B=!0;else if(o.length>1)switch(o[0].toUpperCase()){case"HREF":b=Z(o[1]);break;case"HINT":v=Z(o[1]);break;case"EXPIRE":M=Z(o[1]);break;case"PROMPT":B=!0;break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+o[0]);break}else f===0?b=Z(e[f]):f===1?v=Z(e[f]):f===2?B=!0:f===3&&(M=Z(e[f]));a.custom="",this.mxpStyles.push(a),b.length===0&&(b="&text;"),v.length===0&&(v=b);let I=b.split("|"),_;if(I.length>1){let R=v.split("|");R.length===I.length+1&&(v=R[0],R.shift(),_="['"+R.join("','")+"']"),b="['"+I.join("','")+"']"}else b="'"+b+"'";return a.properties={formatType:7,href:b,hint:v,expire:M,prompt:B,tt:_||""},{format:{formatType:7,href:b,hint:v,expire:M,prompt:B,tt:_||""},text:null};case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return a=this.CloneCurrentStyle(),a.open=!0,a.tag=ye[t],a.style|=1,a.custom="",this.mxpStyles.push(a),null;case"/A":return this.ClearMXPToTag(ye[t.substring(1)]),{format:{formatType:4},text:null};case"/SEND":return this.ClearMXPToTag(ye[t.substring(1)]),{format:{formatType:8},text:null};case"/H1":case"/H2":case"/H3":case"/H4":case"/H5":case"/H6":return this.ClearMXPToTag(ye[t.substring(1)]),null;case"NOBR":return this.mxpState.noBreak=!0,null;case"/P":return this.ClearMXPToTag(ye[t.substring(1)]),this.mxpState.paragraph=!1,null;case"P":return a=this.CloneCurrentStyle(),a.open=!1,a.tag=ye[t],a.custom="",this.mxpStyles.push(a),this.mxpState.paragraph=!0,null;case"SBR":return{format:null,text:" \u200B"};case"RESET":return this.ResetMXP(),null;case"HR":let C=this.GetCurrentStyle(),L=this.getColors(C);return{format:{formatType:0,offset:0,color:L.fore,background:L.back,size:C.fontSize,font:C.font,style:C.style|this._CurrentAttributes&-2,hr:!0},text:null}}if(this.mxpElements[t]){if(p=this.mxpElements[t],!p.open&&this.mxpState.lineType!==1&&this.mxpState.lineType!==6&&this.mxpState.lineType!==4)return null;for(a=this.CloneCurrentStyle(),a.open=p.open,a.tag=38,a.custom=p.name,o=p.definition,c={},E=0,k=p.attributeIndexes.length;E<k;E++)c[p.attributeIndexes[E]]=p.attributes[p.attributeIndexes[E]];for(f=0;f<w;f++)h=e[f].split("="),h[0]=h[0].toLowerCase(),p.attributes[h[0]]?c[h[0]]=h[1]:f<p.attributeIndexes.length&&(c[p.attributeIndexes[f]]=h[0]);for(h in c)c.hasOwnProperty(h)&&(o=o.replace("&"+h+";",c[h]));return p.empty||(this.mxpState.captured.push([]),this.mxpState.capture++),p.tag>19&&p.tag<100&&this.mxpLines[p.tag].enabled&&this.mxpLines[p.tag].definition.length>0&&(o=this.mxpLines[p.tag].definition+o,a.gagged=this.mxpLines[p.tag].gag),this.mxpState.gagged=a.gagged,this.mxpState.expanded=!0,{format:null,text:o}}else if(t.startsWith("/")&&this.mxpElements[t.substring(1)]&&!this.mxpElements[t.substring(1)].empty)return t=t.substring(1),p=this.mxpElements[t],!p.open&&this.mxpState.lineType!==1&&this.mxpState.lineType!==6&&this.mxpState.lineType!==4||(!p.empty&&this.mxpState.capture>0&&(this.mxpState.captured.length>0&&(h=this.mxpState.captured.pop().join("")),this.mxpState.capture--),o=p.closeDefinition,p.flag.length>0&&(p.flag.length>4&&p.flag.toLowerCase().startsWith("set ")&&this.emit("set-variable",p.flag.substring(4),h),this.emit("MXP-flag",p.flag,h)),p.tag>19&&p.tag<100&&this.mxpLines[p.tag].enabled&&this.mxpLines[p.tag].closeDefinition.length>0&&(o+=this.mxpLines[p.tag].closeDefinition),this.mxpState.gagged=!p.gagged,p.empty)?null:(this.mxpState.expanded=!0,{format:null,text:o});if(this.showInvalidMXPTags){switch(t){case"IMAGE":case"!AT":case"!ATTLIST":case"!TAG":case"!EL":case"!ELEMENT":case"!EN":case"!ENTITY":case"/V":case"/VAR":case"V":case"VAR":case"GAUGE":case"STAT":case"MUSIC":case"SOUND":case"EXPIRE":case"VERSION":case"USER":case"PASSWORD":case"SUPPORT":case"A":case"SEND":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"/A":case"/SEND":case"/H1":case"/H2":case"/H3":case"/H4":case"/H5":case"/H6":case"NOBR":case"/P":case"P":case"SBR":case"RESET":case"HR":return null}return{format:null,text:"<"+n+">"}}return null}cleanMXPExpired(t,e){if(!t||t.length===0||e===null)return;let s=t.length;for(let n=0;n<s;n++){let r=t[n];if(!(r.formatType!==7&&r.formatType!==3)&&(e.length===0||r.expire===e)){let a,o=0,h=0,c=r.formatType;for(r.formatType===3?a=4:a=8,r.formatType=9;h<s;h++)if(t[h].formatType===a)if(o===0){t[h].formatType=10;break}else o--;else t[h]===c&&o++}}}GetCloseTags(t){if(typeof t>"u"||t.length===0)return"";let e=0,s=t.length,n=[],r=[],a,o=0;for(;e<s;e++)switch(a=t.charAt(e),o){case 1:a===" "?(n.push(r.join("")),r=[],o=2):a===">"?(n.push(r.join("")),r=[],o=0):r.push(a);break;case 2:a===">"&&(o=0);break;default:a==="<"&&(o=1);break}return o===1&&n.push(r.join("")),n.length===0?"":"</"+n.reverse().join("></")+">"}CloneCurrentStyle(){let t;return this.mxpStyles.length===0&&this.mxpStyles.push(new bt(0,"","",!1)),t=this.mxpStyles[this.mxpStyles.length-1],this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(t.gagged=this.mxpLines[this.mxpState.lineType].gag),Object.assign({},t)}GetCurrentStyle(){let t;return this.mxpStyles.length===0&&this.mxpStyles.push(new bt(0,"","",!1)),t=this.mxpStyles[this.mxpStyles.length-1],this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(t.gagged=this.mxpLines[this.mxpState.lineType].gag),t}DecreaseColor(t,e){let s=new ne(t);return s.ok?(s.b-=Math.ceil(s.b*e),s.b<0&&(s.b=0),s.g-=Math.ceil(s.g*e),s.g<0&&(s.g=0),s.r-=Math.ceil(s.r*e),s.r<0&&(s.r=0),s.toRGB()):t}IncreaseColor(t,e){let s=new ne(t);return s.ok?(s.b+=Math.ceil(s.b*e),s.b>255&&(s.b=255),s.g+=Math.ceil(s.g*e),s.g>255&&(s.g=255),s.r+=Math.ceil(s.r*e),s.r>255&&(s.r=255),s.toRGB()):t}MXPCapture(t){if(this.mxpState.capture<1)return;let e=this.mxpState.captured.length;for(let s=0;s<e;s++)this.mxpState.captured[s].push(t)}MXPDeCapture(t){if(this.mxpState.capture<1)return;let e=this.mxpState.captured.length;for(let s=0;s<e;s++)for(let n=0;n<t;n++)this.mxpState.captured[s].pop()}isNumber(t){return/^\d+$/.test(t)}CurrentAnsiCode(){let t="\x1B[";return typeof this._CurrentForeColor=="string"?t+="38;2;"+this._CurrentForeColor:this._CurrentForeColor<=-16?t+="38;5;"+(this._CurrentForeColor*-1-16)+";":t+=this._CurrentForeColor+";",typeof this._CurrentBackColor=="string"?t+="48;2;"+this._CurrentBackColor:this._CurrentBackColor<=-16?t+="38;5;"+(this._CurrentBackColor*-1-16)+";":t+=this._CurrentBackColor+";",this._CurrentAttributes>0&&((this._CurrentAttributes&64)===64&&(t+="7;"),(this._CurrentAttributes&1)===1&&(t+="1;"),(this._CurrentAttributes&4)===4&&(t+="3;"),(this._CurrentAttributes&8)===8&&(t+="4;"),(this._CurrentAttributes&16)===16&&(t+="5;"),(this._CurrentAttributes&32)===32&&(t+="6;"),(this._CurrentAttributes&256)===256&&(t+="9;"),(this._CurrentAttributes&2)===2&&(t+="2;"),(this._CurrentAttributes&512)===512&&(t+="21;"),(this._CurrentAttributes&1024)===1024&&(t+="53;")),t+"m"}get parseQueueLength(){return this.parsing.length}get parseQueueEndOfLine(){return this.parsing.length?this.parsing[this.parsing.length-1][0].endsWith(`
`):!1}parse(t,e,s,n){if(t==null||t.length===0)return t;if(e==null&&(e=!1),this.parsing.length>0&&!s){this.parsing.push([t,e,n]);return}let r="",a=null,o=null,h=[],c=[],g=[],f=0,w=0,p=0,k,E=0,b,v,M,B,I,_=!1;this.busy=!0,this.parsing.unshift([t,e,n]);let C;if(this._SplitBuffer.length>0&&(n?t=t+this._SplitBuffer:t=this._SplitBuffer+t,this._SplitBuffer=""),!this.EndOfLine&&(this.textLength>0||this.rawLength>0)){let T=this.display.lines;T.length>0?(k=this.display.lines[T.length-1].text,B=this.display.lines[T.length-1].raw,c.push.apply(c,this.display.lines[T.length-1].formats),this.display.removeLine(T.length-1,!0),C=c[c.length-1],C.formatType===1&&(c.pop(),C=c[c.length-1]),C.width=0,C.height=0,C.marginWidth=0,C.marginHeight=0,p=C.offset,C.offset!==0?(h.push(k.substring(0,C.offset)),k=k.substring(C.offset),(this.mxpState.locked||this.mxpState.on)&&(E=k.length),t=k+t):((this.mxpState.locked||this.mxpState.on)&&(E=k.length),t=k+t),B.endsWith(k)?g.push(B.substr(0,B.length-k.length)):g.push(B)):c.push(C=this.getFormatBlock(p)),T=null}else c.push(C=this.getFormatBlock(p));let L=0,R=t.length,S,P,X=this.emulateControlCodes,J=this.displayControlCodes,G=this.emulateTerminal,ie=this.enableURLDetection,Q=this.enableMSP,D=this.tabWidth,N=0,Y=0,U=0,O=0,H=null,F,re=this.protocols.length;try{for(L=0;L<R;L++)switch(S=t.charAt(L),P=t.charCodeAt(L),L>=E&&g.push(S),this.rawLength++,f){case 2:if(S==="C"||S==="K"||S==="s"||S==="u"||S==="l"||S==="h"||S==="A"||S==="B"||S==="D"||S==="E"||S==="F"||S==="f"||S==="G"||S==="H"||S==="n"||S==="S"||S==="T"||S==="r")this.ClearMXPOpen(),this._SplitBuffer="",o=null,f=0;else if(S==="z"){b=o.split(";"),o=0;for(let T=b.length-1;T>=0;T--)if(b[T].length>0){o=b[0];break}switch(k=+o,isNaN(k)&&(k=0),this.mxpState.on=!0,this.mxpState.noBreak=!1,this.mxpState.paragraph=!1,this.mxpState.lineType===0&&this.ClearMXPOpen(),k){case 2:this.mxpState.on=!1,this.mxpState.locked=!1,this.mxpState.lineType=2,this.ClearMXPOpen();break;case 3:this.ResetMXP();break;case 4:if(this.mxpState.lineType=4,L+1>=R){this._SplitBuffer+=S;break}t.charAt(L+1)!=="<"&&(this.mxpState.lineType=0,this.mxpState.on=!1),this.mxpState.locked=!1,this.ClearMXPOpen();break;case 5:this.iMXPDefaultMode=0,this.mxpState.locked=!0,this.mxpState.lineType=5,this.ClearMXPOpen();break;case 6:this.iMXPDefaultMode=1,this.mxpState.lineType=6,this.mxpState.locked=!0,this.ClearMXPOpen();break;case 7:this.iMXPDefaultMode=2,this.mxpState.lineType=7,this.mxpState.locked=!0,this.ClearMXPOpen();break;default:k<0||k>99?this.ClearMXPOpen():(this.mxpState.lineType=k,this.mxpState.locked=!1,this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(k="",this.mxpLines[this.mxpState.lineType].element.length>0&&(k+="<"+this.mxpLines[this.mxpState.lineType].element+">"),this.mxpLines[this.mxpState.lineType].definition.length>0&&(k+=this.mxpLines[this.mxpState.lineType].definition),k.length>0&&(t=t.splice(L+1,k),R=t.length)));break}this._SplitBuffer="",o=null,f=0}else if(S==="J"){if(this.ClearMXPOpen(),o.length>0&&+o==2){p=0,k=this.window.height,c.push(...this.getMXPCloseFormatBlocks()),this.AddLine(h.join(""),g.join(""),!1,!1,c,e),h=[],g=[],c=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(p),...this.getMXPCloseFormatBlocks()];for(let T=0;T<k;T++)this.AddLine("",`
`,!1,!1,c,e),this.MXPCapture(`
`);this.textLength+=k,this.mxpState.noBreak=!1}c=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(p)],this._SplitBuffer="",o=null,f=0}else S==="m"?(this.ProcessAnsiColorParams(o.split(";")),c.push(C=this.getFormatBlock(p)),this._SplitBuffer="",o=null,f=0):S===`
`||S==="\x1B"?(L--,g.pop(),this.rawLength--,f=0,this._SplitBuffer="",this.mxpState.on&&S===`
`&&this.ClearMXPOpen()):(this._SplitBuffer+=S,o+=S);break;case 3:P===7?(this._SplitBuffer="",this.emit("set-title",r,a??0),r="",a=null,f=0):S===";"&&a==null?(a=+r,isNaN(a)&&(a=0),r="",this._SplitBuffer+=S):S==="\x1B"?this._SplitBuffer.charAt(this._SplitBuffer.length-1)===`
`&&(this._SplitBuffer=""):(this._SplitBuffer+=S,r+=S);break;case 1:S==="["?(this._SplitBuffer+=S,o="",f=2):S==="]"?(this._SplitBuffer+=S,r="",f=3):(S==="D"||S==="E"||S==="M"||S==="1"||S==="2"||S==="7"||S==="8"||S===">"||S==="="||S==="#")&&(J&&(h.push("\u241B"),P<16?(h.push(String.fromCharCode(parseInt("240"+P.toString(16),16))),this.MXPCapture("&#x241B&#x240"+P.toString(16)+";")):(h.push(String.fromCharCode(parseInt("24"+P.toString(16),16))),this.MXPCapture("&#x241B&#x24"+P.toString(16)+";")),p+=2,this.textLength+=2,this.mxpState.noBreak=!1),f=0,this._SplitBuffer="");break;case 4:if(b==="!--")L--,g.pop(),this.rawLength--,w=0,f=8,B="<!--",b="",I=[];else if(b.endsWith("<!--"))L--,g.pop(),this.rawLength--,w=f,f=8,B="<!--",b=b.substring(0,b.length-4),I=[];else if(S==='"')f=6,I[I.length-1]+=S,this._SplitBuffer+=S;else if(S==="'")f=5,I[I.length-1]+=S,this._SplitBuffer+=S;else if(S==="&")M="",w=f,f=7,this._SplitBuffer="";else if(S===`
`||S==="\x1B")L--,g.pop(),this.rawLength--,f=0,this._SplitBuffer="",this.mxpState.on&&S===`
`&&this.ClearMXPOpen();else if(S===" ")f=9,I.push(""),this._SplitBuffer+=S;else if(S===">"){if(v=b,b=b.toUpperCase(),b==="HR"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))p>0&&(p=0,this.MXPCapture(`
`),c.push(...this.getMXPCloseFormatBlocks()),this.AddLine(h.join(""),g.join(""),!1,!1,c,e),h=[],g=[],c=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(p)]),b=this.getMXPBlock(b,[],e),b&&b.format&&(b.format.offset=p,c.push(b.format),c[0].hr=b.format.hr),c.push(...this.getMXPCloseFormatBlocks()),this.AddLine(h.join(""),g.join(""),!1,!1,c,e),this.textLength++,h=[],g=[],c=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(p)];else if(b==="BR"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))this.MXPCapture(`
`),c.push(...this.getMXPCloseFormatBlocks()),this.AddLine(h.join(""),g.join(""),!1,!1,c,e),_=!1,p=0,h=[],g=[],c=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(p)],this.textLength++;else if(b==="IMAGE"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))b=this.getMXPBlock(b,I,e),b&&b.format!==null&&(c.push(b.format),p+=b.length,this.textLength+=b.length),c.push(C=this.getFormatBlock(p));else{if(b=this.getMXPBlock(b,[],e,v,c),this.mxpState.expanded){b&&b.text!==null&&(t=t.splice(L+1,b.text)),R=t.length,this.mxpState.expanded=!1,f=0,b="",this._SplitBuffer="";continue}b?(b.format&&(b.format.offset=p,c.push(b.format)),c.push(C=this.getFormatBlock(p)),b.text!==null&&b.text.length>0&&(h.push(b.text),p+=b.text.length,this.textLength+=b.text.length)):c.push(C=this.getFormatBlock(p))}f=0,this._SplitBuffer=""}else S==="<"?(this.enableDebug&&this.emit("debug","Malformed MXP Tag: "+b),L--,g.pop(),this.rawLength--,h.push("<"+b),p+=b.length+1,this.textLength+=b.length+1,f=0,this._SplitBuffer=""):(this._SplitBuffer+=S,b+=S);break;case 5:S==="'"?(f=9,this._SplitBuffer+=S,I[I.length-1]+=S):(this._SplitBuffer+=S,I[I.length-1]+=S);break;case 6:S==='"'?(f=9,this._SplitBuffer+=S,I[I.length-1]+=S):(this._SplitBuffer+=S,I[I.length-1]+=S);break;case 9:if(S==="'")f=5,I[I.length-1]+=S,this._SplitBuffer+=S;else if(S==='"')f=6,I[I.length-1]+=S,this._SplitBuffer+=S;else if(S===`
`||S==="\x1B")L--,g.pop(),this.rawLength--,f=0,this._SplitBuffer="",this.mxpState.on&&S===`
`&&this.ClearMXPOpen();else if(S===" ")f=9,I.push(""),this._SplitBuffer+=S;else if(S===">"){if(b.toUpperCase()==="IMAGE"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))b=this.getMXPBlock(b,I,e,b),b!==null&&b.format!==null&&(b.format.offset=p,c.push(b.format)),c.push(C=this.getFormatBlock(p));else{if(b=this.getMXPBlock(b,I,e,b,c),this.mxpState.expanded){b!==null&&(t=t.splice(L+1,b.text)),R=t.length,this.mxpState.expanded=!1,f=0,this._SplitBuffer="";continue}b!==null?(b!==null&&b.format&&(b.format.offset=p,c.push(b.format)),c.push(C=this.getFormatBlock(p)),b.text!==null&&(h.push(b.text),p+=b.text.length,this.textLength+=b.text.length)):c.push(C=this.getFormatBlock(p))}f=0,this._SplitBuffer=""}else this._SplitBuffer+=S,I[I.length-1]+=S;break;case 7:if(S===`
`||S==="\x1B"){if(L--,g.pop(),this.rawLength--,this.enableDebug&&this.emit("debug","MXP Entity: "+M),w===4)b+="&"+M,f=w;else{if(M=this.GetEntity(M),this.mxpState.expanded){b!==null&&(t=t.splice(L+1,M)),R=t.length,this.mxpState.expanded=!1,f=0,this._SplitBuffer="";continue}v=oi("&"+M),h.push(v),this.MXPCapture("&"+M),p+=v.length,this.textLength+=v.length,this.mxpState.noBreak=!1,f=0,this._SplitBuffer="",C.unicode=!0}this.mxpState.on&&S===`
`&&this.ClearMXPOpen()}else if(S===";"){if(this.enableDebug&&this.emit("debug","MXP Entity: "+M),w!==4){if(M=this.GetEntity(M),this.mxpState.expanded){t=t.splice(L+1,M),R=t.length,this.mxpState.expanded=!1,f=w,this._SplitBuffer="";continue}v=oi("&"+M+";"),h.push(v),this.MXPCapture("&"),this.MXPCapture(M),this.MXPCapture(";"),p+=v.length,this.textLength+=v.length,this.mxpState.noBreak=!1,this._SplitBuffer=""}else b+="&"+M+";";C.unicode=!0,f=w}else S==="&"?(this.enableDebug&&this.emit("debug","Malformed MXP Entity: "+M),w!==4?(h.push("&"+M),this.MXPCapture("&"),this.MXPCapture(M),p+=M.length+1,this.textLength+=M.length+1,this.mxpState.noBreak=!1,this._SplitBuffer="",L--,g.pop(),this.rawLength--):b+="&"+M,C.unicode=!0,f=w):(this._SplitBuffer+=S,M+=S);break;case 8:B.endsWith("-->")?(this.enableDebug&&this.emit("debug","MXP Comment: "+B),L--,g.pop(),this.rawLength--,f=w,f===0&&(this._SplitBuffer=""),B=""):S===`
`||S==="\x1B"?(this.enableDebug&&this.emit("debug","MXP Comment: "+B),L--,g.pop(),this.rawLength--,f=w,B="",this.mxpState.on&&S===`
`&&this.ClearMXPOpen()):B+=S;break;case 10:if(L>N+2)h.pop(),h.pop(),g.pop(),g.pop(),this.rawLength-=2,p-=2,this.textLength-=2,this.MXPDeCapture(2),L=N,f=0;else if(S==="/"){if(h.push(S),this.MXPCapture(S),p++,this.textLength++,L===N+2){for(f=11,N=h.length-4,O=h.length-1,Y=c.length,U-=2;N>0&&Ot(h[N],!0);)N--,U--;Ot(h[N],!0)||(N++,U++),H=[],N>0&&h[N-1]==="("&&H.push(")"),N>0&&h[N-1]==="["&&H.push("]")}}else L>N+1?(h.pop(),g.pop(),this.rawLength--,p--,this.textLength--,this.MXPDeCapture(1),L=N,f=0):(L=N,f=0,g.pop(),this.rawLength--);break;case 11:Ot(S,!1)?H.length>1&&H[H.length-1]===S?(H.pop(),h.push(S),this.MXPCapture(S),p++,this.textLength++,P>255&&(C.unicode=!0)):H.length>0&&S==="("?(H.push(")"),h.push(S),this.MXPCapture(S),p++,this.textLength++,P>255&&(C.unicode=!0)):H.length>0&&S==="["?(H.push("]"),h.push(S),this.MXPCapture(S),p++,this.textLength++,P>255&&(C.unicode=!0)):H.length===1&&H[H.length-1]===S?(O!==h.length-1&&(B+=h.slice(N).join(""),this.enableDebug&&this.emit("debug","URL Found: "+B),c.splice(Y,0,{formatType:1,href:B,offset:U}),c.push({formatType:2,href:B,offset:p}),c.push(C=this.getFormatBlock(p))),f=0,L--,g.pop(),this.rawLength--):(P>255&&(C.unicode=!0),h.push(S),this.MXPCapture(S),p++,this.textLength++):(O!==h.length-1&&(B+=h.slice(N).join(""),this.enableDebug&&this.emit("debug","URL Found: "+B),c.splice(Y,0,{formatType:1,offset:U,href:B}),c.push({formatType:2,offset:p,href:B}),c.push(C=this.getFormatBlock(p))),f=0,L--,g.pop(),this.rawLength--);break;case 12:S===")"?(N=this.mxpState.lineType,this.mxpState.lineType=4,this.getMXPBlock("SOUND",I,e),this.mxpState.lineType=N,f=0,L+1<R&&t.charAt(L+1)===`
`?(L++,_=!1,h=[],c=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(p)],this.mxpState.noBreak=!1,p=0):L+2<R&&t[L+1]==="\r"&&t[L+2]===`
`&&(L+=2,_=!1,h=[],c=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(p)],this.mxpState.noBreak=!1,p=0)):S===" "?I.push(""):I[I.length-1]+=S;break;case 13:S===")"?(N=this.mxpState.lineType,this.mxpState.lineType=4,this.getMXPBlock("MUSIC",I,e),this.mxpState.lineType=N,f=0,L+1<R&&t.charAt(L+1)===`
`?(L++,_=!1,h=[],c=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(p)],this.mxpState.noBreak=!1,p=0):L+2<R&&t[L+1]==="\r"&&t[L+2]===`
`&&(L+=2,_=!1,h=[],c=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(p)],this.mxpState.noBreak=!1,p=0)):S===" "?I.push(""):I[I.length-1]+=S;break;default:if(X&&P===7)G?(S="\u2407",h.push(S),this.MXPCapture(S),p++,this.textLength++,this.mxpState.noBreak=!1):J&&(h.push(S),this.MXPCapture("&#x2407;"),p++,this.textLength++,this.mxpState.noBreak=!1),this.emit("bell");else if(X&&S==="\b"){if(_=!1,p>0){if(h.length){for(;h[h.length-1].length===0;)h.pop();h[h.length-1].length===1?h.pop():h[h.length-1]=h[h.length-1].substring(0,h[h.length-1].length-1)}C.offset===p&&C.offset--,p--,this.textLength--}J&&(S="\u25D8",h.push(S),this.MXPCapture(S),p++,this.textLength++),this.mxpState.noBreak=!1}else if(X&&S==="	"){let T=D-p%D;T>0&&(h.push(Array(T+1).join(" ")),this.MXPCapture(Array(T+1).join(" ")),p+=T,this.textLength+=T,this.mxpState.noBreak=!1)}else if(S===`
`){if(this.mxpState.noBreak||this.mxpState.paragraph)continue;if(this.mxpState.locked)c.push(...this.getMXPCloseFormatBlocks()),this.mxpState.on&&this.ClearMXPOpen();else{if(this.mxpState.lineType!==0&&this.emit("MXP-tag-end",this.mxpState.lineType,h.join(""),c),!this.mxpState.lineExpanded&&this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(k="",this.mxpLines[this.mxpState.lineType].element.length>0&&(k+="</"+this.mxpLines[this.mxpState.lineType].element+">"),this.mxpLines[this.mxpState.lineType].closeDefinition.length>0&&(k+=this.mxpLines[this.mxpState.lineType].closeDefinition),k.length>0)){t=t.splice(L,k),R=t.length,L--,g.pop(),this.rawLength--,this.mxpState.lineExpanded=!0;continue}this.mxpState.lineExpanded=!1,c.push(...this.getMXPCloseFormatBlocks()),this.mxpState.on&&this.ClearMXPOpen(),this.mxpState.on=!1,this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&this.mxpLines[this.mxpState.lineType].gag&&(_=!0),this.mxpState.lineType=this.iMXPDefaultMode,this.mxpState.lineType!==2&&!this.enableMXP&&this.ResetMXP()}p=0,_||this.MXPCapture(`
`),this.AddLine(h.join(""),g.join(""),!1,_,c,e),_=!1,h=[],g=[],c=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(p)],this.textLength++,this.mxpState.noBreak=!1}else{if(X&&S==="\r")continue;if(X&&S==="\x1B")this._SplitBuffer+=S,f=1;else if(P<32||P===127)if(G)P===1?S="\u263A":P===2?S="\u263B":P===3?S="\u2665":P===4?S="\u2666":P===5?S="\u2663":P===6?S="\u2660":P===7?S="\u2407":P===8?S="\u25D8":P===9?S="\u25CB":P===10?S="\u25D9":P===11?S="\u2642":P===12?S="\u2640":P===13?S="\u266A":P===14?S="\u266B":P===15?S="\u263C":P===16?S="\u25BA":P===17?S="\u25C4":P===18?S="\u2195":P===19?S="\u203C":P===20?S="\xB6":P===21?S="\xA7":P===22?S="\u25AC":P===23?S="\u21A8":P===24?S="\u2191":P===25?S="\u2193":P===26?S="\u2192":P===27?S="\u2190":P===28?S="\u221F":P===29?S="\u2194":P===30?S="\u25B2":P===31?S="\u25BC":P===127&&(S="\u2302"),h.push(S),this.MXPCapture(S),p++,this.textLength++,this.mxpState.noBreak=!1;else if(J)P=9216+P,h.push(String.fromCharCode(P)),this.MXPCapture("&#"),this.MXPCapture(P.toString()),this.MXPCapture(";"),p++,this.textLength++,this.mxpState.noBreak=!1;else continue;else if(S===" "||this._CurrentAttributes>0&&(this._CurrentAttributes&128)===128)h.push(" "),this.MXPCapture(" "),p++,this.textLength++,this.mxpState.noBreak=!1;else if(S==="<"&&L>=E)this.enableMXP&&this.mxpState.on?(b="",I=[],this._SplitBuffer+=S,f=4):(h.push("<"),this.MXPCapture("&lt;"),p++,this.textLength++);else if(S===">")h.push(">"),this.MXPCapture("&gt;"),p++,this.textLength++,this.mxpState.noBreak=!1;else if(S==="&"&&L>=E)this.enableMXP&&this.mxpState.on?(M="",this._SplitBuffer+=S,w=f,f=7):(h.push(S),p++,this.textLength++,this.mxpState.noBreak=!1);else if(S==='"')h.push(S),this.MXPCapture("&quot;"),p++,this.textLength++,this.mxpState.noBreak=!1;else if(S==="'")h.push(S),this.MXPCapture("&apos;"),p++,this.textLength++,this.mxpState.noBreak=!1;else if(S===":"){if(h.push(S),this.MXPCapture(S),p++,this.textLength++,this.mxpState.noBreak=!1,ie){B="";let T,he=!1;for(F=0;F<re;F++){if(L-this.protocols[F].length<0)continue;T=!1;let q=this.protocols[F].length;for(let W=0;W<q;W++)if(t[L-(q-W)]!==this.protocols[F][W]){T=!0;break}if(!T&&(N=h.length,U=p,Y=c.length,!(N>1+q&&h[N-(2+q)].length===1&&/\S/.test(h[N-(2+q)])&&h[N-(2+q)]!=="("&&h[N-(2+q)]!=="[")&&(H=[],N=h.length-(1+q),U-=1+q,O=h.length-1,N>0&&h[N-1]==="("&&H.push(")"),N>0&&h[N-1]==="["&&H.push("]"),f=11,he=!0,he)))break}he||(f=10,N=L,U=p)}}else if(S==="."){if(h.push(S),this.MXPCapture(S),p++,this.textLength++,this.mxpState.noBreak=!1,ie&&L-3>=0&&(B="http://",(t[L-1]==="w"||L[N-1]==="W")&&(t[L-2]==="w"||L[N-2]==="W")&&(t[L-3]==="w"||L[N-3]==="W"))){if(N=h.length,U=p,Y=c.length,N>4&&h[N-5].length===1&&/\S/.test(h[N-5])&&h[N-5]!=="("&&h[N-5]!=="[")continue;H=[],N=h.length-4,U-=4,O=h.length-1,N>0&&h[N-1]==="("&&H.push(")"),N>0&&h[N-1]==="["&&H.push("]"),f=11}}else Q&&p===0&&t.substring(L,L+8)==="!!MUSIC("?(I=[""],f=13,L+=7,this.mxpState.noBreak=!1):Q&&p===0&&t.substring(L,L+8)==="!!SOUND("?(I=[""],f=12,L+=7,this.mxpState.noBreak=!1):(G&&P>127&&P<255?P===128?S="\xC7":P===129?S="\xFC":P===130?S="\xE9":P===131?S="\xE2":P===132?S="\xE4":P===133?S="\xE0":P===134?S="\xE5":P===135?S="\xE7":P===136?S="\xEA":P===137?S="\xEB":P===138?S="\xE8":P===139?S="\xEF":P===140?S="\xEE":P===141?S="\xEC":P===142?S="\xC4":P===143?S="\xC5":P===144?S="\xC9":P===145?S="\xE6":P===146?S="\xC6":P===147?S="\xF4":P===148?S="\xF6":P===149?S="\xF2":P===150?S="\xFB":P===151?S="\xF9":P===152?S="\xFF":P===153?S="\xD6":P===154?S="\xDC":P===155?S="\xA2":P===156?S="\xA3":P===157?S="\xA5":P===158?S="\u20A7":P===159?S="\u0192":P===160?S="\xE1":P===161?S="\xED":P===162?S="\xF3":P===163?S="\xFA":P===164?S="\xF1":P===165?S="\xD1":P===166?S="\xAA":P===167?S="\xBA":P===168?S="\xBF":P===169?S="\u2310":P===170?S="\xAC":P===171?S="\xBD":P===172?S="\xBC":P===173?S="\xA1":P===174?S="\xAB":P===175?S="\xBB":P===176?S="\u2591":P===177?S="\u2592":P===178?S="\u2593":P===179?S="\u2502":P===180?S="\u2524":P===181?S="\u2561":P===182?S="\u2562":P===183?S="\u2556":P===184?S="\u2555":P===185?S="\u2563":P===186?S="\u2551":P===187?S="\u2557":P===188?S="\u255D":P===189?S="\u255C":P===190?S="\u255B":P===191?S="\u2510":P===192?S="\u2514":P===193?S="\u2534":P===194?S="\u252C":P===195?S="\u251C":P===196?S="\u2500":P===197?S="\u253C":P===198?S="\u255E":P===199?S="\u255F":P===200?S="\u255A":P===201?S="\u2554":P===202?S="\u2569":P===203?S="\u2566":P===204?S="\u2560":P===205?S="\u2550":P===206?S="\u256C":P===207?S="\u2567":P===208?S="\u2568":P===209?S="\u2564":P===210?S="\u2565":P===211?S="\u2559":P===212?S="\u2558":P===213?S="\u2552":P===214?S="\u2553":P===215?S="\u256B":P===216?S="\u256A":P===217?S="\u2518":P===218?S="\u250C":P===219?S="\u2588":P===220?S="\u2584":P===221?S="\u258C":P===222?S="\u2590":P===223?S="\u2580":P===224?S="\u03B1":P===225?S="\u03B2":P===226?S="\u0393":P===227?S="\u03C0":P===228?S="\u03A3":P===229?S="\u03C3":P===230?S="\xB5":P===231?S="\u03C4":P===232?S="\u03A6":P===233?S="\u0398":P===234?S="\u03A9":P===235?S="\u03B4":P===236?S="\u221E":P===237?S="\u2205":P===238?S="\u2208":P===239?S="\u2229":P===240?S="\u2261":P===241?S="\xB1":P===242?S="\u2265":P===243?S="\u2264":P===244?S="\u2320":P===245?S="\u2321":P===246?S="\xF7":P===247?S="\u2248":P===248?S="\xB0":P===249?S="\u2219":P===250?S="\xB7":P===251?S="\u221A":P===252?S="\u207F":P===253?S="\xB2":P===254&&(S="\u25A0"):P>255&&(C.unicode=!0),h.push(S),this.MXPCapture(S),p++,this.textLength++,this.mxpState.noBreak=!1)}break}this._SplitBuffer.length&&(this.rawLength-=this._SplitBuffer.length,g.splice(g.length-this._SplitBuffer.length,this._SplitBuffer.length)),c.push(...this.getMXPCloseFormatBlocks()),f===11&&c.splice(Y,0,{formatType:1,offset:U,href:B+=h.slice(N).join("")}),this.AddLine(h.join(""),g.join(""),!0,!1,c,e)}catch(T){this.enableDebug&&this.emit("debug",T)}this.busy=!1,this.emit("parse-done"),this.parsing.shift(),this.parsing.length>0&&setTimeout(this.parseNext(),0)}parseNext(){let t=this.parsing.shift();return()=>{this.parse(t[0],t[1],!0,t[2])}}updateWindow(t,e){this.window={width:t,height:e}}Clear(){this.ResetColors(),this.textLength=0,this._SplitBuffer=""}ClearMXP(){this.mxpEntities={},this.ResetMXP(),this.mxpElements={},this.mxpState=new Gt}ResetMXP(){this.mxpStyles=[],this.mxpStyles.push(new bt(0,"","",!1))}ResetMXPLine(){this.iMXPDefaultMode=0,this.mxpState.lineType=0}GetPublicEntity(t){return this.mxpEntities[t]&&this.mxpEntities[t].publish?this.mxpEntities[t].value:t}};var It=class extends pe{constructor(t,e){super();this._updating=0;this._enableDebug=!1;this._maxView=0;this._padding=[0,0,0,0];this._enableColors=!0;this._enableBackgroundColors=!0;this._hideTrailingEmptyLine=!0;this._maxLines=500;this._wordWrap=!1;this._indent=4;this._indentPadding=0;this._wrapAt=0;this._scrollAtEnd=!1;this._lineCache=[];this._expireCache=[];this._timestamp=0;this._timestampFormat="[[]MM-DD HH:mm:ss.SSS[]] ";this._timestampWidth=new Date().toISOString().length+1;this._mouseDown=!1;this.scrollLock=!1;if(!t)throw new Error("Container must be a selector, element, jquery object or display options");if(typeof t=="object"&&"container"in t&&(e=Object.assign(e||{},t),t=e.container,delete e.container),typeof t=="string"){if(this._container=document.querySelector(t),!this._container)throw new Error("Invalid selector for display.")}else if(t instanceof $)this._container=t[0];else if(t instanceof HTMLElement)this._container=t;else throw new Error("Container must be a selector, element or jquery object");this._styles=document.createElement("style"),this._container.appendChild(this._styles),this._character=document.createElement("span"),this._character.id=this.id+"-Character",this._character.className="line",this._character.innerHTML='<span style="border-bottom: 1px solid rgb(0, 0, 0);">W</span>',this._character.style.visibility="hidden",this._container.appendChild(this._character),this._view=document.createElement("div"),this._view.className="view",this._view.addEventListener("scroll",()=>{this._scrollAtEnd=this._view.clientHeight+this._view.scrollTop>=this._view.scrollHeight}),this._view.addEventListener("click",s=>{this.emit("click",s)}),this._view.addEventListener("contextmenu",s=>{this.emit("contextmenu",s)}),this._view.addEventListener("mousedown",s=>{this.emit("mousedown",s),this._mouseDown=!0}),this._view.addEventListener("mouseup",s=>{this.emit("mouseup",s),this._mouseDown&&this.emit("selection-done"),this._mouseDown=!1}),this._container.appendChild(this._view),this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width),e?e.display=this:e={display:this},this.model=new bi(e),this._wResize=s=>{this._scrollAtEnd&&this.scrollDisplay(),fe(()=>{this.doUpdate(17)},250,"resize")},this._selection=s=>{this._mouseDown&&fe(()=>{this.emit("selection-changed")},250,"selection-changed")},window.addEventListener("resize",this._wResize.bind(this)),document.addEventListener("selectionchange",this._selection.bind(this)),this._resizeObserver=new ResizeObserver((s,n)=>{s.length!==0&&(!s[0].contentRect||s[0].contentRect.width===0||s[0].contentRect.height===0||fe(()=>{(!this._resizeObserverCache||this._resizeObserverCache.width!==s[0].contentRect.width||this._resizeObserverCache.height!==s[0].contentRect.height)&&(this._scrollAtEnd&&this.scrollDisplay(),this._resizeObserverCache={width:s[0].contentRect.width,height:s[0].contentRect.height},this.doUpdate(17),this.emit("resize"))},250,"resize"))}),this._resizeObserver.observe(this._container),this._observer=new MutationObserver(s=>{let n;for(n of s)n.type==="attributes"&&n.attributeName==="style"&&(this._scrollAtEnd&&this.scrollDisplay(),this.doUpdate(17),this.emit("resize"))}),this._observer.observe(this._container,{attributes:!0,attributeOldValue:!0,attributeFilter:["style"]}),!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.updateFont()}get showTimestamp(){return this._timestamp}set showTimestamp(t){t!==this._timestamp&&(this._timestamp=t,!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.buildStyleSheet(),this.doUpdate(35))}get timestampFormat(){return this._timestampFormat}set timestampFormat(t){this._timestampFormat!==t&&(this._timestampFormat=t,!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.doUpdate(51))}get wordWrap(){return this._wordWrap}set wordWrap(t){t!==this._wordWrap&&(this._wordWrap=t,this.buildStyleSheet(),this.doUpdate(1))}get wrapAt(){return this._wrapAt}set wrapAt(t){t!==this._wrapAt&&(this._wrapAt=t,this.buildStyleSheet(),this.doUpdate(3))}get indent(){return this._indent}set indent(t){t!==this._indent&&(this._indent=t,this.buildStyleSheet(),this.doUpdate(3))}get linkFunction(){return this._linkFunction||"doLink"}set linkFunction(t){this._linkFunction=t}get mxpLinkFunction(){return this._mxpLinkFunction||"doMXPLink"}set mxpLinkFunction(t){this._mxpLinkFunction=t}get mxpSendFunction(){return this._mxpSendFunction||"doMXPSend"}set mxpSendFunction(t){this._mxpSendFunction=t}get mxpTooltipFunction(){return this._mxpTooltipFunction||"doMXPTooltip"}set mxpTooltipFunction(t){this._mxpTooltipFunction=t}get id(){return this._container?this._container.id:""}get container(){return this._container}get lines(){return this._model.lines}get model(){return this._model}set model(t){this._model!==t&&(this._model&&this._model.removeAllListeners(),this._model=t,this._model.on("debug",this.debug,this),this._model.on("bell",()=>{this.emit("bell")}),this._model.on("add-line",e=>{this.emit("add-line",e)}),this._model.on("add-line-done",e=>{this.emit("add-line-done",e)}),this._model.on("line-added",(e,s)=>{this._lineCache.push(this.getLineHTML(e.idx))}),this._model.on("expire-links",e=>{if(this._expireCache.length)for(let s=0,n=this._expireCache.length;s<n;s++)this.rebuildLine(this._expireCache[s]);this._expireCache=[],this.emit("expire-links")}),this._model.on("parse-done",()=>{this._view.insertAdjacentHTML("beforeend",this._lineCache.join("")),this._lineCache=[],this.doUpdate(2),this.emit("parse-done")}),this._model.on("set-title",(e,s)=>{this.emit("set-title",e,s)}),this._model.on("music",e=>{this.emit("music",e)}),this._model.on("sound",e=>{this.emit("sound",e)}),this._model.on("MXP-tag-reply",(e,s)=>{this.emit("MXP-tag-reply",e,s)}),this._model.on("expire-link-line",e=>{this._expireCache.push(e),this.doUpdate(2)}))}get maxLines(){return this._maxLines}set maxLines(t){t!==this._maxLines&&(this._maxLines=t,this.doUpdate(4))}get enableDebug(){return this._enableDebug}get enableColors(){return this._enableColors}set enableColors(t){t!==this._enableColors&&(this._enableColors=t,this.buildStyleSheet())}get enableBackgroundColors(){return this._enableBackgroundColors}set enableBackgroundColors(t){t!==this._enableBackgroundColors&&(this._enableBackgroundColors=t,this.buildStyleSheet())}get hideTrailingEmptyLine(){return this._hideTrailingEmptyLine}set hideTrailingEmptyLine(t){t!==this._hideTrailingEmptyLine&&(this._hideTrailingEmptyLine=t,this.doUpdate(2))}set enableDebug(t){this._enableDebug=t,this._model.enableDebug=t}get tabWidth(){return this._model.tabWidth}set tabWidth(t){this._model.tabWidth=t}get textLength(){return this._model.textLength}get EndOfLine(){return this._model.EndOfLine}get parseQueueLength(){return this._model.parseQueueLength}get parseQueueEndOfLine(){return this._model.parseQueueEndOfLine}get EndOfLineLength(){return this.lines.length===0?0:this.lines[this.lines.length-1].text.length}set enableFlashing(t){this._model.enableFlashing=t}get enableFlashing(){return this._model.enableFlashing}set enableMXP(t){this._model.enableMXP=t}get enableMXP(){return this._model.enableMXP}set showInvalidMXPTags(t){this._model.showInvalidMXPTags=t}get showInvalidMXPTags(){return this._model.showInvalidMXPTags}set enableBell(t){this._model.enableBell=t}get enableBell(){return this._model.enableBell}set enableURLDetection(t){this._model.enableURLDetection=t}get enableURLDetection(){return this._model.enableURLDetection}set enableMSP(t){this._model.enableMSP=t}get enableMSP(){return this._model.enableMSP}set displayControlCodes(t){this._model.displayControlCodes=t}get displayControlCodes(){return this._model.displayControlCodes}set emulateTerminal(t){this._model.emulateTerminal=t}get emulateTerminal(){return this._model.emulateTerminal}set emulateControlCodes(t){this._model.emulateControlCodes=t}get emulateControlCodes(){return this._model.emulateControlCodes}set MXPStyleVersion(t){this._model.MXPStyleVersion=t}get MXPStyleVersion(){return this._model.MXPStyleVersion}get WindowSize(){return new ft(this.WindowWidth,this.WindowHeight)}get WindowWidth(){return Math.trunc(this._maxView/this._charWidth)}get WindowHeight(){return this._view.scrollWidth>this._view.clientWidth?Math.trunc((this._innerHeight-fi()-this._padding[0]-this._padding[2])/this._charHeight):Math.trunc((this._innerHeight-this._padding[0]-this._padding[2])/this._charHeight)}get html(){let t=this.lines.length,e=[];for(let s=0;s<t;s++)e.push(this.getLineHTML(s));return e.join("")}get text(){return this._model.text}get raw(){return this._model.raw}get scrollAtBottom(){return this._scrollAtEnd}debug(t){this.emit("debug",t)}scrollDisplay(){this.scrollLock||(this._view.scrollTop=this._view.scrollHeight)}scrollTo(t,e){this._view.scrollTo(t,e)}scrollToCharacter(t,e){this._view.scrollTo(t*this._charHeight,e*this._charWidth)}scrollBy(t,e){this._view.scrollBy(t,e)}scrollUp(){this._view.scrollBy(0,-this._charHeight)}scrollDown(){this._view.scrollBy(0,this._charHeight)}pageUp(){this._view.scrollBy(0,-this._view.clientHeight)}pageDown(){this._view.scrollBy(0,this._view.clientHeight)}trimLines(){if(this._maxLines!==-1&&this.lines.length>this._maxLines){let t=this.lines.length-this._maxLines,e=t;for(;e-- >0;)this._view.removeChild(this._view.firstChild);this._model.removeLines(0,t)}}append(t,e,s,n){this._model.append(t,e||!1,s||!1,n||!1)}CurrentAnsiCode(){return this._model.CurrentAnsiCode()}removeLine(t,e){if(t<0||t>=this.lines.length)return;this.emit("line-removed",t,this.lines[t].text);let s=this._model.getLineID(t),n=document.querySelector(`[data-id="${s}"]`);this._view.removeChild(n),this._model.removeLine(t)}removeLines(t,e){t<0||t>=this.lines.length||(e<1&&(e=1),this.emit("lines-removed",t,this.lines.slice(t,t+e-1)),this._view.replaceChildren(...[].slice.call(this._view.children,0,t),...[].slice.call(this._view.children,t+e)),this._model.removeLines(t,e))}updateDisplay(){this._view.classList.remove("animate"),this.doUpdate(4),this._hideTrailingEmptyLine&&this.lines.length&&this.lines[this.lines.length-1].text.length===0&&(this._view.lastChild.style.display="none"),this.doUpdate(24),this._view.classList.add("animate")}updateWindow(t,e){t===void 0&&(t=this.WindowWidth,e=this.WindowHeight),this._model.updateWindow(t,e),this.emit("update-window",t,e)}clear(){this._model.clear(),this._view.innerHTML=""}dispose(){for(document.body.removeChild(this._character),document.body.removeChild(this._styles);this._container.firstChild;)this._view.removeChild(this._view.firstChild);window.removeEventListener("resize",this._wResize),document.removeEventListener("selectionchange",this._selection)}update(){let t=fi();this._maxView=this._view.clientWidth-this._padding[1]-this._padding[3]-t-this._indentPadding,this._timestamp!==0&&(this._maxView-=this._timestampWidth*this._charWidth),this._innerHeight=this._view.clientHeight}updateFont(t,e){!t||t.length===0?t='"Courier New", Courier, monospace':t+=", monospace",(!e||e.length===0)&&(e="1em"),(t!==this._container.style.fontFamily||e!==this._container.style.fontSize)&&(this._container.style.fontSize=e,this._container.style.fontFamily=t,this._character.style.fontSize=e,this._character.style.fontFamily=t,this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width),setTimeout(()=>{this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width)},250),this.buildStyleSheet(),this.doUpdate(25));let s=window.getComputedStyle(this._view),n=[parseInt(s.getPropertyValue("padding-top"))||0,parseInt(s.getPropertyValue("padding-right"))||0,parseInt(s.getPropertyValue("padding-bottom"))||0,parseInt(s.getPropertyValue("padding-left"))||0];(n[0]!==this._padding[0]||n[1]!==this._padding[1]||n[2]!==this._padding[2]||n[3]!==this._padding[3])&&(this._padding=n,this.doUpdate(1))}buildStyleSheet(){let t="";this._enableColors||(t+=".view > span span {color: inherit !important;}"),(!this._enableColors||!this._enableBackgroundColors)&&(t+=".background > span span {background-color: inherit !important;}"),this._wordWrap?t+=".view {white-space: break-spaces; }":this._wrapAt>0&&(t+=`.view {white-space: break-spaces; } .line {width: ${this._wrapAt*this._charWidth}px !important;max-width:  ${this._wrapAt*this._charWidth}px;min-width:  ${this._wrapAt*this._charWidth}px;display: block;}`),(this._wordWrap||this._wrapAt>0)&&this._indent>0&&(t+=`.view {  padding-left: 0px !important; text-indent: ${this._indent*this._charWidth}px hanging; }`),t+=`.line > span { min-height: ${this._charHeight}}`,this._timestamp!==0&&(t+=".timestamp { display: inline-block; }"),this._styles.innerHTML=t,(this._wordWrap||this._wrapAt>0)&&this._indent>0?this._indentPadding=parseFloat(window.getComputedStyle(this._view).paddingLeft)/2:this._indentPadding=0}getLineHTML(t,e,s,n){t===void 0||t>=this.lines.length?t=this.lines.length-1:t<0&&(t=0),(e===void 0||e<0)&&(e=0),(s===void 0||s===-1)&&(s=this.lines[t].text.length);let r=[],a=0,o="",h="",c=this.lines[t].text,g=this.lines[t].formats,f=g.length,w=!1,p=this._model.getLineID(t);this._timestamp===2&&moment?r.push('<span class="timestamp" style="color:',this._model.GetColor(-7),";background:",this._model.GetColor(-8),';"',h,">",moment(this.lines[t].timestamp).format(this._timestampFormat),"</span>"):this._timestamp===1&&r.push('<span class="timestamp" style="color:',this._model.GetColor(-7),";background:",this._model.GetColor(-8),';"',h,">",new Date(this.lines[t].timestamp).toISOString()," </span>");for(let k=0;k<f;k++){let E=g[k],b,v,M=[];if(k<f-1){if(b=g[k+1],E.offset===b.offset&&b.formatType===E.formatType)continue;v=b.offset}else v=c.length;if(a=E.offset,v>s&&(v=s),a<e&&(a=e),E.formatType===0){if(o=[],h=[],typeof E.background=="number"?o.push("background:",this._model.GetColor(E.background),";"):E.background&&o.push("background:",E.background,";"),typeof E.color=="number"?o.push("color:",this._model.GetColor(E.color),";"):E.color&&o.push("color:",E.color,";"),E.font&&o.push("font-family: ",E.font,";"),E.size&&o.push("font-size: ",E.size,";"),E.style!==0?((E.style&1)===1&&o.push("font-weight: bold;"),(E.style&4)===4&&o.push("font-style: italic;"),(E.style&1024)===1024&&M.push("overline "),((E.style&512)===512||(E.style&8)===8)&&M.push("underline "),(E.style&512)===512?o.push("border-bottom: 1px solid ",typeof E.color=="number"?this._model.GetColor(E.color):E.color,";"):o.push("border-bottom: 1px solid ",typeof E.background=="number"?this._model.GetColor(E.background):E.background,";"),((E.style&32)===32||(E.style&16)===16)&&(this.enableFlashing?h.push(" ansi-blink"):(E.style&512)!==512&&(E.style&8)!==8&&M.push("underline ")),(E.style&256)===256&&M.push("line-through "),M.length>0&&o.push("text-decoration:",M.join("").trim(),";")):o.push("border-bottom: 1px solid ",typeof E.background=="number"?this._model.GetColor(E.background):E.background,";"),a<e||v<e)continue;o=o.join("").trim(),h.length!==0?h=' class="'+h.join("").trim()+'"':h="",E.hr?r.push('<span style="',o,'min-width:100%;width:100%;"',h,'><div style="position:relative;top: 50%;transform: translateY(-50%);height:4px;width:100%; background-color:',typeof E.color=="number"?this._model.GetColor(E.color):E.color,'"></div></span>'):v-a!==0&&r.push('<span style="',o,'"',h,">",Se(c.substring(a,v)),"</span>")}else if(E.formatType===1){if(a<e||v<e||(r.push('<a draggable="false" class="URLLink" href="javascript:void(0);" title="'),r.push(E.href.replace(/"/g,"&quot;")),r.push('" onclick="',this.linkFunction,"('",E.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),`');return false;">`),v-a===0))continue;r.push('<span style="',o,'"',h,">"),r.push(Se(c.substring(a,v))),r.push("</span>")}else if(E.formatType===2||E.formatType===4||E.formatType===8){if(a<e||v<e)continue;r.push("</a>")}else if(E.formatType===3){if(a<e||v<e||(r.push('<a draggable="false" class="MXPLink" href="javascript:void(0);" title="'),r.push(E.href.replace(/"/g,"&quot;")),r.push('"'),E.expire&&E.expire.length&&r.push(` data-expire="${E.expire}"`),r.push(' onclick="',this.mxpLinkFunction,"(this, '",E.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),`');return false;">`),v-a===0))continue;r.push('<span style="',o,'"',h,">"),r.push(Se(c.substring(a,v))),r.push("</span>")}else if(E.formatType===7){if(a<e||v<e||(r.push('<a draggable="false" class="MXPLink" href="javascript:void(0);" title="'),r.push(E.hint.replace(/"/g,"&quot;")),r.push('"'),E.expire&&E.expire.length&&r.push(` data-expire="${E.expire}"`),r.push(' onmouseover="',this.mxpTooltipFunction,'(this);"'),r.push(' onclick="',this.mxpSendFunction,"(event||window.event, this, ",E.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),", ",E.prompt?"1":"0",", ",E.tt.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),');return false;">'),v-a===0))continue;r.push('<span style="',o,'"',h,">"),r.push(Se(c.substring(a,v))),r.push("</span>")}else if(E.formatType===9&&v-a!==0){if(a<e||v<e)continue;r.push('<span style="',o,'"',h,">"),r.push(Se(c.substring(a,v))),r.push("</span>")}else if(E.formatType===5){if(a<e||v<e)continue;let B="";switch(r.push('<img src="'),E.url.length>0&&(r.push(E.url),B+=E.url,E.url.endsWith("/")||(r.push("/"),B+="/")),E.t.length>0&&(r.push(E.t),B+=E.t,E.t.endsWith("/")||(r.push("/"),B+="/")),B+=E.name,r.push(E.name,'"  style="'),E.w.length>0&&r.push("width:",rt(E.w,this._charWidth),";"),E.h.length>0&&r.push("height:",rt(E.h,this._charHeight),";"),E.align.toLowerCase()){case"left":r.push("float:left;");break;case"right":r.push("float:right;"),w=!0;break;case"top":case"middle":case"bottom":r.push("vertical-align:",E.align,";");break}E.hspace.length>0&&E.vspace.length>0?(r.push("margin:"),r.push(rt(E.vspace,this._charWidth)," "),r.push(rt(E.hspace,this._charHeight),";")):E.hspace.length>0?(r.push("margin:"),r.push("0px ",rt(E.hspace,this._charHeight),";")):E.vspace.length>0&&(r.push("margin:"),r.push(rt(E.vspace,this._charWidth)," 0px;")),r.push('"'),E.ismap&&r.push(' ismap onclick="return false;"'),r.push(`src="${B}"/>`)}}return n?w&&s<this.lines[t].text.length?r.join(""):w?r.join("")+"<br>":s<this.lines[t].text.length?r.join(""):r.join("")+"<br>":w&&s<this.lines[t].text.length?`<span data-id="${p}" class="line" style="min-width:100%">${r.join("")}</span>`:w?`<span data-id="${p}" class="line" style="min-width:100%">${r.join("")}<br></span>`:s<this.lines[t].text.length?`<span data-id="${p}" class="line">${r.join("")}</span>`:`<span  data-id="${p}" class="line">${r.join("")}<br></span>`}getLineText(t,e){return t<0||t>=this.lines.length||!this.lines[t]?"":this.lines[t].text}rebuildLine(t){this.rebuildLines(t,t)}rebuildLines(t,e){if(!this.lines.length)return;(t===void 0||t<0)&&(t=0),(e===void 0||e===-1||e>=this.lines.length)&&(e=this.lines.length-1);let s=[],n=t;for(;n<=e;n++)s.push(this.getLineHTML(n));t===0&&e===this.lines.length-1?this._view.innerHTML=s.join(""):(this._view.replaceChildren(...[].slice.call(this._view.children,0,t),...[].slice.call(this._view.children,e+1)),t===0?this._view.firstElementChild.insertAdjacentHTML("beforebegin",s.join("")):this._view.children[t-1].insertAdjacentHTML("afterend",s.join("")))}doUpdate(t){t&&(this._updating|=t,this._updating!==0&&window.requestAnimationFrame(()=>{this._updating!==0&&((this._updating&32)===32&&(this.rebuildLines(),this._updating&=-33),(this._updating&1)===1&&(this.update(),this._updating&=-2),(this._updating&2)===2&&(this.updateDisplay(),this._updating&=-3),(this._updating&4)===4&&(this.trimLines(),this._updating&=-5),(this._updating&8)===8&&(this.scrollDisplay(),this._updating&=-9),(this._updating&16)===16&&(this.updateWindow(),this._updating&=-17),this.doUpdate(this._updating))}))}colorSubStrByLine(t,e,s,n,r,a){this.colorSubStringByLine(t,e,s,n,(n||0)+(r||0),a)}colorSubStringByLine(t,e,s,n,r,a){this._model.colorSubStringByLine(t,e,s,n,r,a)&&this.rebuildLine(t)}removeStyleSubStrByLine(t,e,s,n){this.removeStyleSubStringByLine(t,e,s,(s||0)+(n||0))}removeStyleSubStringByLine(t,e,s,n){this._model.removeStyleSubStringByLine(t,e,s,n)&&this.rebuildLine(t)}highlightSubStrByLine(t,e,s){this.highlightStyleSubStringByLine(t,e,(e||0)+(s||0))}highlightStyleSubStringByLine(t,e,s,n){this._model.highlightStyleSubStringByLine(t,e,s,n)&&this.rebuildLine(t)}SetColor(t,e){this._model.SetColor(t,e)}ClearMXP(){this._model.ClearMXP()}ResetMXPLine(){this._model.ResetMXPLine()}get hasSelection(){let t=window.getSelection();if(t.rangeCount>0){let e=t.getRangeAt(0);return this._view.contains(e.commonAncestorContainer)&&t.toString().length!==0}return!1}get selection(){if(window.getSelection){let t=window.getSelection();if(t.rangeCount>0){let e=t.getRangeAt(0);if(this._view.contains(e.startContainer)||this._view.contains(e.endContainer))return t.toString()}}return""}get selectionAsHTML(){var t;if(window.getSelection){var e=window.getSelection();if(e.rangeCount>0){if(t=e.getRangeAt(0),!this._view.contains(t.startContainer)&&!this._view.contains(t.endContainer))return"";var s=t.cloneContents(),n=document.createElement("div");return n.appendChild(s),n.innerHTML}else return""}else return document.selection&&document.selection.createRange?(t=document.selection.createRange(),t.htmlText):""}selectAll(){let t;window.getSelection?window.getSelection().selectAllChildren?window.getSelection().selectAllChildren(this._view):(t=document.createRange(),t.selectNode(this._view),window.getSelection().addRange(t)):document.selection&&(t=document.body.createTextRange(),t.moveToElementText(this._view),t.select())}clearSelection(){let t=window.getSelection();if(t.rangeCount>0){let e=t.getRangeAt(0);(this._view.contains(e.startContainer)||this._view.contains(e.endContainer))&&t.removeAllRanges()}}getLineOffset(t,e){let s=document.elementsFromPoint(t,e),n;for(let a=0,o=s.length;a<o&&this._view!==s[a];a++)if(this._view.contains(s[a])){n=s[a];break}if(!n||!this._view.contains(n)&&this._view!=n)return{x:-1,y:-1,lineID:-1};if(n.classList.contains("line"))return{x:0,y:this.model.getLineFromID(+n.dataset.id),lineID:+n.dataset.id};let r=n.closest(".line");return r?{x:0,y:this.model.getLineFromID(+r.dataset.id),lineID:+r.dataset.id}:{x:-1,y:-1,lineID:-1}}getWordFromPosition(t,e){let s=document.elementsFromPoint(t,e),n;for(let r=0,a=s.length;r<a;r++){if(this._view===s[r])return"";if(this._view.contains(s[r])){n=s[r];break}}if(n&&n.textContent){let r=n.textContent,a=r.lastIndexOf(" ",t)+1,o=r.indexOf(" ",t);return o===-1&&(o=r.length),r.substring(a,o)}return""}},bi=class extends pe{constructor(t){super();this._lineID=0;this.lines=[];this.lineIDs=[];this._expire={};this._expire2=[];this._parser=new Ut(t),this._parser.on("debug",e=>{this.emit(e)}),this._parser.on("bell",()=>{this.emit("bell")}),this._parser.on("add-line",e=>{this.addParserLine(e,!0)}),this._parser.on("expire-links",e=>{let s,n,r;if(!e||e.length===0){for(n in this._expire2)this._expire2.hasOwnProperty(n)&&this.expireLineLinkFormat(this._expire2[n],+n);for(r in this._expire)if(this._expire.hasOwnProperty(r)){s=this._expire[r];for(n in s)s.hasOwnProperty(n)&&this.expireLineLinkFormat(s[n],+n)}this._expire2=[],this._expire={},this.emit("expire-links",e)}else if(this._expire[e]){s=this._expire[e];for(n in s)s.hasOwnProperty(n)&&this.expireLineLinkFormat(s[n],+n);delete this._expire[e],this.emit("expire-links",e)}}),this._parser.on("parse-done",()=>{this.emit("parse-done")}),this._parser.on("set-title",(e,s)=>{this.emit("set-title",e,s)}),this._parser.on("music",e=>{this.emit("music",e)}),this._parser.on("sound",e=>{this.emit("sound",e)}),this._parser.on("MXP-tag-reply",(e,s)=>{this.emit("MXP-tag-reply",e,s)})}get enableDebug(){return this._parser.enableDebug}set enableDebug(t){this._parser.enableDebug=t}get tabWidth(){return this._parser.tabWidth}set tabWidth(t){this._parser.tabWidth=t}get textLength(){return this._parser.textLength}get EndOfLine(){return this._parser.EndOfLine}get parseQueueLength(){return this._parser.parseQueueLength}get parseQueueEndOfLine(){return this._parser.parseQueueEndOfLine}set enableFlashing(t){this._parser.enableFlashing=t}get enableFlashing(){return this._parser.enableFlashing}set enableMXP(t){this._parser.enableMXP=t}get enableMXP(){return this._parser.enableMXP}set showInvalidMXPTags(t){this._parser.showInvalidMXPTags=t}get showInvalidMXPTags(){return this._parser.showInvalidMXPTags}set enableBell(t){this._parser.enableBell=t}get enableBell(){return this._parser.enableBell}set enableURLDetection(t){this._parser.enableURLDetection=t}get enableURLDetection(){return this._parser.enableURLDetection}set enableMSP(t){this._parser.enableMSP=t}get enableMSP(){return this._parser.enableMSP}set displayControlCodes(t){this._parser.displayControlCodes=t}get displayControlCodes(){return this._parser.displayControlCodes}set emulateTerminal(t){this._parser.emulateTerminal=t}get emulateTerminal(){return this._parser.emulateTerminal}set emulateControlCodes(t){this._parser.emulateControlCodes=t}get emulateControlCodes(){return this._parser.emulateControlCodes}set MXPStyleVersion(t){this._parser.StyleVersion=t}get MXPStyleVersion(){return this._parser.StyleVersion}addParserLine(t,e){if(t.timestamp=Date.now(),this.emit("add-line",t),t==null||typeof t>"u"||t.line==null||typeof t.line>"u"||(this.emit("add-line-done",t),t.gagged))return;let s={text:t.line===`
`||t.line.length===0?"":t.line,raw:t.raw,formats:t.formats,id:this._lineID,timestamp:t.timestamp};this.lines.push(s),this.lineIDs.push(this._lineID),this._lineID++,this.buildLineExpires(this.lines.length-1),this.emit("line-added",t,e)}expireLineLinkFormat(t,e){let s,n,r,a,o,h,c,g=0;for(n=0,a=t.length;n<a;n++)for(r=this.lines[e].formats.length,s=t[n],c=this.lines[e].formats[s],o=c.formatType,c.formatType===3?h=4:h=8,c.formatType=9,s++;s<r;s++)if(this.lines[e].formats[s]===h)if(g===0){this.lines[e].formats[s].formatType=10;break}else g--;else this.lines[e].formats[s]===o&&g++;this.emit("expire-link-line",e)}clear(){this._parser.Clear(),this.lines=[],this._expire={},this._expire2=[],this.lineIDs=[],this._lineID=0}IncreaseColor(t,e){return this._parser.IncreaseColor(t,e)}GetColor(t){return this._parser.GetColor(t)}append(t,e,s,n){this._parser.parse(t,e||!1,s||!1,n||!1)}CurrentAnsiCode(){return this._parser.CurrentAnsiCode()}updateWindow(t,e){this._parser.updateWindow(t,e)}SetColor(t,e){this._parser.SetColor(t,e)}ClearMXP(){this._parser.ClearMXP()}ResetMXPLine(){this._parser.ResetMXPLine()}get busy(){return this._parser.busy}removeLine(t){this.lines.splice(t,1),this.lineIDs.splice(t,1),this._expire2.splice(t,1)}removeLines(t,e){this.lines.splice(t,e),this.lineIDs.splice(t,e),this._expire2.splice(t,e);for(let s in this._expire)!this._expire.hasOwnProperty(s)||this._expire[s].length===0||t>=this._expire[s].length||this._expire[s].splice(t,e)}getLineID(t){return t<0||t>=this.lineIDs.length?-1:this.lineIDs[t]}get getNextLineID(){return this._lineID}getLineFromID(t){return this.lineIDs.indexOf(t)}buildLineExpires(t){t===void 0&&(t=this.lines.length-1);let e=this.lines[t].formats;for(let r in this._expire)this._expire.hasOwnProperty(r)&&this._expire[r][t]&&delete this._expire[r][t];delete this._expire2[t];let s=e.length,n;for(;s--;)n=e[s],(n.formatType===7||n.formatType===3)&&(n.expire&&n.expire.length>0?(this._expire[n.expire]||(this._expire[n.expire]=[]),this._expire[n.expire][t]||(this._expire[n.expire][t]=[]),this._expire[n.expire][t].push(s)):(this._expire2[t]||(this._expire2[t]=[]),this._expire2[t].push(s)))}colorSubStrByLine(t,e,s,n,r,a){return this.colorSubStringByLine(t,e,s,n,n+r,a)}colorSubStringByLine(t,e,s,n,r,a){if(t<0||t>=this.lines.length)return!1;let o=this.lines[t].text.length;if(n>=o||((!n||n<0)&&(n=0),(!r||r>o)&&(r=o),n===r))return!1;let h=this.lines[t].formats,c=h.length,g=!1;if(n===0&&r>=o){for(let f=0;f<c;f++){let w=h[f];w.formatType===0&&(g=!0,w.bStyle&&(w.bStyle=0,w.fStyle=0,w.fCls=0),w.color=e||w.color,w.background=s||w.background,w.style|=a||0)}g||h.unshift({formatType:0,offset:0,color:e||0,background:s||0,size:0,font:0,style:a||0,unicode:!1})}else{let f,w;for(let p=0;p<c;p++){let k=h[p];if(k.formatType===0){if(p<c-1){let E=p+1;if(f=h[E],k.offset===f.offset&&f.formatType===k.formatType)continue;for(;k.offset===f.offset&&f.formatType===k.formatType&&E<c-1;)f=h[++E];E===c&&k.offset===f.offset?w=o:w=f.offset}else w=o;n<k.offset||n>=w||(g=!0,k.bStyle&&(k.bStyle=0,k.fStyle=0,k.fCls=0),r<w&&(k.width=0,h.splice(p+1,0,{formatType:k.formatType,offset:r,color:k.color,background:k.background,size:k.size,font:k.font,style:k.style,unicode:k.unicode}),c++),n!=k.offset?(k.width=0,h.splice(p+1,0,{formatType:k.formatType,offset:n,color:e||k.color,background:s||k.background,size:k.size,font:k.font,style:k.style|(a||0),unicode:k.unicode}),c++):(k.color=e||k.color,k.background=s||k.background,k.style|=a||0),r>w&&(n=w))}}this.lines[t].formats=this.pruneFormats(h,this.textLength)}return!0}removeStyleSubStrByLine(t,e,s,n){return this.removeStyleSubStringByLine(t,e,s,s+n)}removeStyleSubStringByLine(t,e,s,n){if(t<0||t>=this.lines.length)return!1;let r=this.lines[t].text.length;if(s>=r)return!1;(!s||s<0)&&(s=0),(!n||n>r)&&(n=r);let a=this.lines[t].formats,o=a.length,h=!1;if(s===0&&n>=r){for(let c=0;c<o;c++){let g=a[c];g.formatType===0&&(h=!0,g.bStyle&&(g.bStyle=0,g.fStyle=0,g.fCls=0),g.style&=~(e||0))}h||a.unshift({formatType:0,offset:0,color:0,background:0,size:0,font:0,style:0,unicode:!1})}else{let c,g;for(let f=0;f<o;f++){let w=a[f];if(w.formatType===0){if(f<o-1){let p=f+1;if(c=a[p],w.offset===c.offset&&c.formatType===w.formatType)continue;for(;w.offset===c.offset&&c.formatType===w.formatType&&p<o-1;)c=a[++p];p===o&&w.offset===c.offset?g=r:g=c.offset}else g=r;s<w.offset||s>=g||(h=!0,w.bStyle&&(w.bStyle=0,w.fStyle=0,w.fCls=0),n<g&&(w.width=0,a.splice(f+1,0,{formatType:w.formatType,offset:n,color:w.color,background:w.background,size:w.size,font:w.font,style:w.style,unicode:w.unicode}),o++),s!=w.offset?(w.width=0,a.splice(f+1,0,{formatType:w.formatType,offset:s,color:w.color,background:w.background,size:w.size,font:w.font,style:w.style&~(e||0),unicode:w.unicode}),o++):w.style&=~(e||0),n>g&&(s=g))}}this.lines[t].formats=this.pruneFormats(a,this.textLength)}return!0}highlightSubStrByLine(t,e,s){return this.highlightStyleSubStringByLine(t,e,e+s)}highlightStyleSubStringByLine(t,e,s,n){if(t<0||t>=this.lines.length)return!1;let r=this.lines[t].text.length;if(e>=r)return!1;(!e||e<0)&&(e=0),(!s||s>r)&&(s=r);let a=this.lines[t].formats,o=a.length,h=!1;if(e===0&&s>=r){for(let c=0;c<o;c++){let g=a[c];g.formatType===0&&(h=!0,g.bStyle&&(g.bStyle=0,g.fStyle=0,g.fCls=0),n||(g.style&1)===1?typeof g.color=="number"?g.color=this._parser.IncreaseColor(this._parser.GetColor(g.color),.25):g.color=this._parser.IncreaseColor(g.color,.25):g.style|=1)}h||a.unshift({formatType:0,offset:0,color:n?370:0,background:0,size:0,font:0,style:n?0:1,unicode:!1})}else{let c,g;for(let f=0;f<o;f++){let w=a[f];if(w.formatType===0){if(f<o-1){let p=f+1;if(c=a[p],w.offset===c.offset&&c.formatType===w.formatType)continue;for(;w.offset===c.offset&&c.formatType===w.formatType&&p<o-1;)c=a[++p];p===o&&w.offset===c.offset?g=r:g=c.offset}else g=r;e<w.offset||e>=g||(h=!0,w.bStyle&&(w.bStyle=0,w.fStyle=0,w.fCls=0),s<g&&(w.width=0,a.splice(f+1,0,{formatType:w.formatType,offset:s,color:w.color,background:w.background,size:w.size,font:w.font,style:w.style,unicode:w.unicode}),o++),e!=w.offset?(w.width=0,c={formatType:w.formatType,offset:e,color:w.color,background:w.background,size:w.size,font:w.font,style:w.style,unicode:w.unicode},n||(w.style&1)===1?typeof w.color=="number"?c.color=this._parser.IncreaseColor(this._parser.GetColor(w.color),.25):c.color=this._parser.IncreaseColor(w.color,.25):c.style|=1,a.splice(f+1,0,c),o++):n||(w.style&1)===1?typeof w.color=="number"?w.color=this._parser.IncreaseColor(this._parser.GetColor(w.color),.25):w.color=this._parser.IncreaseColor(w.color,.25):w.style|=1,s>g&&(e=g))}}this.lines[t].formats=this.pruneFormats(a,this.textLength)}return!0}pruneFormats(t,e){if(!t||t.length<2)return t;let s=t.length,n=[];for(let r=0;r<s;r++){let a=t[r],o;if(r<s-1){let h=t[r+1];if(a.offset===h.offset&&h.formatType===a.formatType||(o=h.offset,a.formatType===1&&o-a.offset===0&&h.formatType===2)||a.formatType===7&&o-a.offset===0&&h.formatType===8||a.formatType===3&&o-a.offset===0&&h.formatType===4)continue;if(a.formatType===h.formatType&&a.color===h.color&&a.background===h.background&&a.size===h.size&&a.font===h.font&&a.style===h.style&&a.unicode===h.unicode){h.offset=a.offset,h.width=0;continue}}else if(a.offset===e&&e!==0&&(a.formatType===0&&!a.hr||a.formatType===1||a.formatType===7||a.formatType===3))continue;n.push(a)}return n}get text(){return this.lines.map(t=>t.text).join(`
`)}get raw(){return this.lines.map(t=>t.raw).join("")}getText(t,e,s){return t<0||t>=this.lines.length?"":(e<0&&(e=0),typeof s>"u"||s>this.lines[t].text.length?this.lines[t].text.substring(e):this.lines[t].text.substring(e,s))}};var $i="0.0.1-alpha";var it=li(zi());var tt=class extends pe{#e;get client(){return this.#e}set client(u){u!==this.#e&&(this.remove(),this.#e=u,this.initialize())}constructor(u){super(),this.#e=u}};var qt=class extends pe{constructor(){super(...arguments);this._file="";this._repeats=1;this._volume=100;this._priority=50;this._retries=0;this.current=0;this.sound=null;this.playing=!1;this.url="";this.continue=!0;this.maxErrorRetries=0}set file(t){this.continue||this.close(),this._file=t}get file(){return this._file}set repeats(t){t>=-1?this._repeats=t:this._repeats=1,this.current=0}get repeats(){return this._repeats}set volume(t){t>=0&&t<=100?this._volume=t:this._volume=1}get volume(){return this._volume}set priority(t){t>=0&&t<=100?this._priority=t:this._priority=50}get priority(){return this._priority}play(){this.playing=!0,this._repeats>0&&this.current<this._repeats?(this.current++,this.close(),this.open().then(()=>{this._retries=0,this.sound.setVolume(this._volume).play(),this.current<this._repeats?this.sound.bind("ended abort",t=>{this.play()}):this.sound.bind("ended abort",t=>{this.playing=!1,this.emit("ended")}),this.sound.isEnded()&&(this.playing=!1)}).catch(t=>{this._retries<this.maxErrorRetries?(this.current--,this.play(),this._retries++):this._retries=0})):this._repeats===-1?(this.close(),this.open().then(()=>{this._retries=0,this.sound.setVolume(this._volume).loop().play(),this.sound.isEnded()&&(this.playing=!1)}).catch(t=>{this._retries<this.maxErrorRetries?(this.play(),this._retries++):this._retries=0})):this.playing=!1}async open(){return this.close(),new Promise((t,e)=>{this.sound=new it.sound()(this.url+this._file),this.sound.bind("loadeddata",s=>{this.emit("playing",{file:this._file,sound:this.sound,state:this,duration:it.toTimer(this.sound.getDuration())}),t(1)}),this.sound.bind("error",s=>{if(s&&s.currentTarget&&s.currentTarget.error)switch(s.currentTarget.error.code){case 1:this.emit("error",new Error(`MSP - Aborted: ${this.url}${this._file}`));break;case 2:this.emit("error",new Error(`MSP - Network error: ${this.url}${this._file}`));break;case 3:this.emit("error",new Error(`MSP - Could not decode: ${this.url}${this._file}`));break;case 4:this.emit("error",new Error(`MSP - Source not supported: ${this.url}${this._file}`));break}else s&&s.currentTarget&&s.currentTarget.networkState===3?this.emit("error",new Error(`MSP - Source not found or unable to play: ${this.url}${this._file}`)):this.emit("error",new Error("MSP - Unknown error"));e()}),this.emit("opened")})}close(){this.sound?(this.stop(),delete this.sound,this.sound=null):this.playing&&(this.playing=!1),this.emit("closed")}stop(){this.sound&&this.sound.stop(),this.playing=!1,this.emit("stopped")}},Xt=class extends tt{constructor(t){super(t instanceof Xe?t:t?.client);this._enabled=!0;this._enableSound=!0;this._maxErrorRetries=1;this.server=!1;this.enableDebug=!1;this.defaultSoundURL="";this.defaultMusicURL="";this.forcedDefaultMusicURL="http://"+window.location.hostname+"/sounds/";this.forcedDefaultSoundURL="http://"+window.location.hostname+"/sounds/";this.defaultSoundExt=".m4a";this.defaultMusicExt=".m4a";this.MusicState=new qt;this.SoundState=new qt;this.parseMode=0;t&&!(t instanceof Xe)&&("forcedDefaultMusicURL"in t&&(this.forcedDefaultMusicURL=t.forcedDefaultMusicURL),"forcedDefaultSoundURL"in t&&(this.forcedDefaultSoundURL=t.forcedDefaultSoundURL)),this.MusicState.on("playing",e=>{e.type=1,this.emit("playing",e)}),this.SoundState.on("playing",e=>{e.type=0,this.emit("playing",e)}),this.MusicState.on("error",e=>{this.emit("error",e)}),this.SoundState.on("error",e=>{this.emit("error",e)}),this.MusicState.maxErrorRetries=this._maxErrorRetries,this.SoundState.maxErrorRetries=this._maxErrorRetries}remove(){if(!this.client)return;this.client.removeListenersFromCaller(this);let t=this.client.telnet.GMCPSupports.indexOf("Client.Media 1");this.client.telnet.GMCPSupports.splice(t,1)}initialize(){this.client&&(this.client.telnet.GMCPSupports.push("Client.Media 1"),this.client.on("connecting",()=>this.reset(),this),this.client.on("close",()=>this.reset(),this),this.client.on("received-option",this.processOption,this),this.client.on("received-GMCP",this.processGMCP,this),this.client.on("music",this.music,this),this.client.on("sound",this.sound,this),this.client.on("options-loaded",this.loadOptions,this),this.client.on("option-loaded",this.setOption,this),this.client.on("function",this.processFunction,this),this.on("playing",t=>{this.client&&(this.debug("MSP "+(t.type?"Music":"Sound")+" Playing "+t.file+" for "+t.duration),this.debug(t),this.client.getOption("notifyMSPPlay")&&this.client.echo((t.type?"Music":"Sound")+" Playing "+t.file+" for "+t.duration,-7,-8,!0,!0))}),this.on("debug",t=>this.client.debug(t),this),this.on("error",t=>this.client.error(t),this),this.loadOptions())}get menu(){return[]}get settings(){return[]}loadOptions(){this.enableDebug=this.client.getOption("enableDebug"),this.enabled=this.client.getOption("enableMSP"),this.enableSound=this.client.getOption("enableSound"),this.maxErrorRetries=this.client.getOption("mspMaxRetriesOnError")}setOption(t,e){switch(t){case"enableMSP":this.enabled=this.client.getOption("enableMSP");break;case"mspMaxRetriesOnError":this.maxErrorRetries=this.client.getOption("mspMaxRetriesOnError");break;case"enableSound":case"enableDebug":this[t]=e;break}}get enabled(){return this._enabled}set enabled(t){t!==this._enabled&&(this._enabled=t,this.MusicState?.close(),this.SoundState?.close())}get maxErrorRetries(){return this._maxErrorRetries}set maxErrorRetries(t){t!==this._maxErrorRetries&&(this._maxErrorRetries=t,this.MusicState&&(this.MusicState.maxErrorRetries=t),this.SoundState&&(this.SoundState.maxErrorRetries=t))}get enableSound(){return this._enableSound}set enableSound(t){t!==this._enableSound&&(this._enableSound=t,this.MusicState?.close(),this.SoundState?.close())}getArguments(t,e){let s={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},n=[],r=0,a=[],o=0,h=t.length,c,g,f;for(;o<h;o++)switch(c=t.charAt(o),r){case 1:c==="'"&&(r=0),a.push(c);break;case 2:c==="'"&&(r=0),a.push(c);break;default:c===" "?(n.push(a.join("")),a=[]):c==="'"?(r=1,a.push(c)):(c==="'"&&(r=2),a.push(c));break}for(a.length>0&&(n.push(a.join("")),a=[]),o=0,h=n.length,this.debug("MSP arguments found: "+n),o=0;o<h;o++)if(g=n[o].split("="),g.length>1)switch(g[0].toUpperCase()){case"FNAME":s.file=Z(g[1]),s.file.toLowerCase()==="off"&&(s.off=!0,s.file="");break;case"V":f=parseInt(g[1],10),isNaN(f)&&(f=100),s.volume=f;break;case"L":f=parseInt(g[1],10),isNaN(f)&&(f=1),s.repeat=f;break;case"P":f=parseInt(g[1],10),isNaN(f)&&(f=1),s.priority=f;break;case"C":s.continue=g[1]!=="0";break;case"T":g[1].length>0&&(s.type=g[1]);break;case"U":s.url=Z(g[1]),!s.url.endsWith("/")&&s.url.length>0&&(s.url+="/");break}else o===0?(s.file=Z(n[o]),s.file.toLowerCase()==="off"&&(s.off=!0,s.file="")):o===1?(f=parseInt(n[o],10),isNaN(f)&&(f=100),s.volume=f):o===2?(f=parseInt(n[o],10),isNaN(f)&&(f=1),s.repeat=f):o===3&&e===1?s.continue=n[o]!=="0":o===3?(f=parseInt(n[o],10),isNaN(f)&&(f=1),s.priority=f):o===4?n[o].length>0&&(s.type=n[o]):o===5&&(s.url=Z(n[o]),!s.url.endsWith("/")&&s.url.length>0&&(s.url+="/"));return this.debug(s),s}reset(){this.server=!1}music(t){if(!this.enabled&&!this.enableSound)return!1;if(!t.file||t.file.length===0){t.off&&t.url&&t.url.length>0?this.defaultMusicURL=t.url:t.off&&this.MusicState.stop();return}else if(t.off){this.MusicState.stop();return}this.MusicState.volume=t.volume,this.MusicState.repeats=t.repeat,this.MusicState.continue=t.continue;let e=this.MusicState.file;t.file.lastIndexOf(".")===-1?this.MusicState.file=t.file+this.defaultMusicExt:this.MusicState.file=t.file,t.url&&t.url.length>0?this.MusicState.url=t.url:this.forcedDefaultMusicURL&&this.forcedDefaultMusicURL.length>0?this.MusicState.url=this.forcedDefaultMusicURL:this.defaultMusicURL&&this.defaultMusicURL.length>0?this.MusicState.url=this.defaultMusicURL:this.MusicState.url="",this.MusicState.url.length>0&&!this.MusicState.url.endsWith("/")&&(this.MusicState.url+="/"),t.type&&t.type.length>0&&(this.MusicState.url+=t.type,this.MusicState.url.length>0&&!this.MusicState.url.endsWith("/")&&(this.MusicState.url+="/")),(e!==this.MusicState.file||!t.continue||!this.MusicState.playing)&&(this.enableSound?this.MusicState.play():this.emit("playing",{type:1,file:this.MusicState.file,sound:this.MusicState.sound,state:this.MusicState,duration:"--:--"}))}sound(t){if(!this.enabled&&!this.enableSound)return!1;if(!t.file||t.file.length===0){t.off&&t.url&&t.url.length>0?this.defaultSoundURL=t.url:t.off&&this.SoundState.stop();return}else if(t.off){this.SoundState.stop();return}if(this.SoundState.playing&&t.priority<this.SoundState.priority)return!1;this.SoundState.volume=t.volume,this.SoundState.repeats=t.repeat,this.SoundState.priority=t.priority,t.file.lastIndexOf(".")===-1?this.SoundState.file=t.file+this.defaultSoundExt:this.SoundState.file=t.file,t.url&&t.url.length>0?this.SoundState.url=t.url:this.forcedDefaultSoundURL&&this.forcedDefaultSoundURL.length>0?this.SoundState.url=this.forcedDefaultSoundURL:this.defaultSoundURL&&this.defaultSoundURL.length>0?this.SoundState.url=this.defaultSoundURL:this.SoundState.url="",this.SoundState.url.length>0&&!this.SoundState.url.endsWith("/")&&(this.SoundState.url+="/"),t.type&&t.type.length>0&&(this.SoundState.url+=t.type,this.SoundState.url.length>0&&!this.SoundState.url.endsWith("/")&&(this.SoundState.url+="/")),this.enableSound?this.SoundState.play():this.emit("playing",{type:0,file:this.SoundState.file,sound:this.SoundState.sound,state:this.SoundState,duration:"--:--"})}processOption(t){t.option===90&&(this.debug("<MSP>"),t.verb===253?(this.server=!0,this.enabled?(this.debug("REPLY: <IAC><WILL><MSP>"),t.telnet.sendData([255,251,90],!0)):(this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0))):t.verb===254?(this.server=!1,this.debug("REPLY: <IAC><WONT><MSP>"),t.telnet.sendData([255,252,90],!0)):t.verb===251?(this.server=!0,this.enabled?(this.debug("REPLY: <IAC><DO><MSP>"),t.telnet.sendData([255,253,90],!0)):(this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0))):t.verb===252&&(this.server=!1,this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0)),t.handled=!0)}async processGMCP(t,e){switch(t){case"Client.Media.Default":e.type==="sound"||!e.type?this.sound({off:!0,url:e.url}):e.type==="music"&&this.music({off:!0,url:e.url});break;case"Client.Media.Load":break;case"Client.Media.Play":let s={off:!1,file:e.name,url:"",volume:50,repeat:1,priority:50,type:"",continue:!0};e.hasOwnProperty("url")&&(s.url=e.url),e.hasOwnProperty("tag")&&(s.type=e.tag),e.hasOwnProperty("volume")&&(s.volume=e.volume),e.hasOwnProperty("loops")&&(s.repeat=e.loops),e.hasOwnProperty("priority")&&(s.priority=e.priority),e.type==="sound"||!e.type?this.sound(s):e.type==="music"&&(e.hasOwnProperty("continue")&&(e.continue==="false"||!e.continue)&&(s.continue=!1),this.music(s));break;case"Client.Media.Stop":e.type==="sound"||!e.type?this.sound({off:!0}):e.type==="music"&&this.music({off:!0});break}}debug(t){this.enableDebug&&this.emit("debug",t)}processFunction(t){let e,s,n;if(t)switch(t.name.toLowerCase()){case"soundinfo":this.SoundState.playing?this.client.echo("Playing Sound - "+this.SoundState.file+" - "+it.toTimer(this.SoundState.sound.getTime())+"/"+it.toTimer(this.SoundState.sound.getDuration()),-7,-8,!0,!0):this.client.echo("No sound currently playing.",-7,-8,!0,!0),t.handled=!0;break;case"musicinfo":this.MusicState.playing?this.client.echo("Playing Music - "+this.MusicState.file+" -  "+it.toTimer(this.MusicState.sound.getTime())+"/"+it.toTimer(this.MusicState.sound.getDuration()),-7,-8,!0,!0):this.client.echo("No music currently playing.",-7,-8,!0,!0),t.handled=!0;break;case"playmusic":case"playm":e=this.client.input.parseOutgoing(t.args.join(" "),!1),s={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},n=e.lastIndexOf("/"),n===-1?s.file=e:(s.file=e.substring(n+1),s.url=e.substring(0,n+1)),this.music(s),t.handled=!0;break;case"playsound":case"plays":e=this.client.input.parseOutgoing(t.args.join(" "),!1),s={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},n=e.lastIndexOf("/"),n===-1?s.file=e:(s.file=e.substring(n+1),s.url=e.substring(0,n+1)),this.sound(s),t.handled=!0;break;case"stopmusic":case"stopm":this.MusicState.close(),t.handled=!0;break;case"stopsound":case"stops":this.SoundState.close(),t.handled=!0;break;case"stopallsound":case"stopa":this.MusicState.close(),this.SoundState.close(),t.handled=!0;break}}};var Yt=class extends tt{constructor(t){super(t);this.functions={};this._event=e=>this.processFunction(e),this.functions.testfile=e=>{if(e&&e.args&&e.args.length)throw new Error("Invalid syntax use "+this.client.getOption("commandChar")+"testfile");ge().then(s=>{console.time("testfile readFile"),be(s[0]).then(n=>{console.timeEnd("testfile readFile"),e&&e.raw&&(this.client.getOption("echo")&4)===4&&this.client.echo(e.raw,-3,-4,!0,!0);let r=this.client.getOption("enableCommands");this.client.setOption("enableCommands",!0);let a=new Date().getTime();console.time("testfile parse"),this.client.sendCommand(n,null,this.client.getOption("allowCommentsFromCommand")),console.timeEnd("testfile parse");let o=new Date().getTime();this.client.setOption("enableCommands",r),this.client.print(`Time: ${o-a}
`,!0)}).catch(this.client.error)}).catch(()=>{})},this.functions.testfiler=e=>{if(e&&e.args&&e.args.length)throw new Error("Invalid syntax use "+this.client.getOption("commandChar")+"testfile");ge().then(s=>{console.time("testfile readFile"),be(s[0]).then(n=>{console.timeEnd("testfile readFile"),e&&e.raw&&(this.client.getOption("echo")&4)===4&&this.client.echo(e.raw,-3,-4,!0,!0);let r=this.client.getOption("enableCommands");this.client.setOption("enableCommands",!0);let a=new Date().getTime();console.time("testfiler parse"),this.client.telnet.receivedData(Ue(n),!0,!0),console.timeEnd("testfiler parse");let o=new Date().getTime();this.client.setOption("enableCommands",r),this.client.print(`Time: ${o-a}
`,!0)}).catch(this.client.error)}).catch(()=>{})},this.functions.testspeedfile=e=>{if(e&&e.args&&e.args.length)throw new Error("Invalid syntax use "+this.client.getOption("commandChar")+"testspeedfile");ge().then(s=>{console.time("testspeedfile readFile"),be(s[0]).then(n=>{console.timeEnd("testspeedfile readFile"),e&&e.raw&&(this.client.getOption("echo")&4)===4&&this.client.echo(e.raw,-3,-4,!0,!0);let r=0,a=0,o=0,h=[],c;console.time("testspeedfile");for(let g=0;g<10;g++){let f=new Date().getTime();console.time(`testspeedfile parse ${g}`),this.client.sendCommand(n,null,this.client.getOption("allowCommentsFromCommand")),console.timeEnd(`testspeedfile parse ${g}`),c=new Date().getTime()-f,r+=c,c>a&&(a=c),(!o||c<o)&&(o=c),h.push(`${g} - ${c}`)}console.timeEnd("testspeedfile"),h.push(`Total - ${r}`),h.push(`Average - ${r/10}`),h.push(`Min - ${o}`),h.push(`Max - ${a}`),this.client.print(h.join(`
`)+`
`,!0)}).catch(this.client.error)}).catch(()=>{})},this.functions.testspeedfiler=e=>{if(e&&e.args&&e.args.length)throw new Error("Invalid syntax use "+this.client.getOption("commandChar")+"testspeedfiler");ge().then(s=>{console.time("testspeedfile readFile"),be(s[0]).then(n=>{console.timeEnd("testspeedfile readFile"),e&&e.raw&&(this.client.getOption("echo")&4)===4&&this.client.echo(e.raw,-3,-4,!0,!0);let r=0,a=0,o=0,h=[],c;console.time("testspeedfile");for(let g=0;g<10;g++){let f=new Date().getTime();console.time(`testspeedfile parse ${g}`),this.client.telnet.receivedData(Ue(n),!0,!0),console.timeEnd(`testspeedfile parse ${g}`),c=new Date().getTime()-f,r+=c,c>a&&(a=c),(!o||c<o)&&(o=c),h.push(`${g} - ${c}`)}console.timeEnd("testspeedfile"),h.push(`Total - ${r}`),h.push(`Average - ${r/10}`),h.push(`Min - ${o}`),h.push(`Max - ${a}`),this.client.print(h.join(`
`)+`
`,!0)}).catch(this.client.error)}).catch(()=>{})},this.functions.testlist=()=>{let e=`Test commands:
`,s;for(s in this.functions)this.functions.hasOwnProperty(s)&&(e+=`	${this.client.getOption("commandChar")+s}
`);this.client.print(e,!0)},this.functions.testcolors=()=>{let e,s=`Colors and Styles
-------------------------------------------------------------------------------------------
`;for(e=30;e<38;e++)s+="\x1B["+e+";0m"+e+"\x1B[0m ",s+="\x1B["+e+";1mBold\x1B[0m ",s+="\x1B["+e+";2mFaint\x1B[0m ",s+="\x1B["+e+";3mItalic\x1B[0m ",s+="\x1B["+e+";4mUnderline\x1B[0m ",s+="\x1B["+e+";5mFlash\x1B[0m ",s+="\x1B["+e+";7mInverse\x1B[0m ",s+="\x1B["+e+";8mConceal\x1B[0m ",s+="\x1B["+e+";9mStrikeout\x1B[0m ",s+="\x1B["+e+";21mDoubleUnderline\x1B[0m ",s+="\x1B["+e+";53mOverline\x1B[0m ",s+="\x1B["+e+";1;2;3;4;5;9;21;53mAll\x1B[0m",s+=`\x1B[0m
`;for(e=40;e<48;e++)s+="\x1B["+e+";0m"+e+"\x1B[0m ",s+="\x1B["+e+";1mBold\x1B[0m ",s+="\x1B["+e+";2mFaint\x1B[0m ",s+="\x1B["+e+";3mItalic\x1B[0m ",s+="\x1B["+e+";4mUnderline\x1B[0m ",s+="\x1B["+e+";5mFlash\x1B[0m ",s+="\x1B["+e+";7mInverse\x1B[0m ",s+="\x1B["+e+";8mConceal\x1B[0m ",s+="\x1B["+e+";9mStrikeout\x1B[0m ",s+="\x1B["+e+";21mDoubleUnderline\x1B[0m ",s+="\x1B["+e+";53mOverline\x1B[0m ",s+="\x1B["+e+";1;2;3;4;5;9;21;53mAll\x1B[0m",s+=`\x1B[0m
`;s+=`-------------------------------------------------------------------------------------------
`,this.client.print(s,!0)},this.functions.testcolorsdetails=()=>{let e="";this.client.telnet.prompt&&(e=`
`),e+=`Table for 16-color terminal escape sequences.
`,e+=`
`,e+=`Background        | Foreground colors
`,e+=`------------------------------------------------------------------------------------
`;for(let s=40;s<=47;s++){let n;for(n in dt)if(typeof dt[n]=="number"&&n!=="Rapid"){n==="None"?e+="\x1B[0m "+Et[s-10].toString().padEnd(16)+" | ":e+="\x1B[0m "+n.padEnd(16)+" | ";for(let r=30;r<=37;r++)n==="None"?e+="\x1B["+s+"m\x1B["+r+"m "+("["+r+"m").padEnd(7):e+="\x1B["+s+"m\x1B["+dt[n]+";"+r+"m "+("["+dt[n]+";"+r+"m").padEnd(7);e+=`\x1B[0m
`}e+=`------------------------------------------------------------------------------------
`}this.client.print(e,!0)},this.functions.testxterm=e=>{let s,n,r,a,o="";for(typeof e<"u"&&e.length>0&&(o+="Set Title: ",o+=e,o+="\x1B]0;",o+=e,o+=`\x07
`),o+=`System colors:
`,a=0;a<8;a++)o+="\x1B[48;5;"+a+"m  ";for(o+=`\x1B[0m
`,a=8;a<16;a++)o+="\x1B[48;5;"+a+"m  ";for(o+=`\x1B[0m

`,o+=`Color cube, 6x6x6:
`,n=0;n<6;n++){for(s=0;s<6;s++){for(r=0;r<6;r++)a=16+s*36+n*6+r,o+="\x1B[48;5;"+a+"m  ";o+="\x1B[0m "}o+=`
`}for(o+=`Grayscale ramp:
`,a=232;a<256;a++)o+="\x1B[48;5;"+a+"m  ";o+=`\x1B[0m
`,this.client.print(o,!0)},this.functions.testmxp=()=>{let e=`Text Formatting
`;e+="	\x1B[6z",e+=`<!--Test-->&lt;!--Test--&gt;
`,e+=`	<!--Test>-->&lt;!--Test&gt;--&gt;
`,e+=`	<STRONG>STRONG</STRONG>
`,e+=`	<BOLD>BOLD</BOLD>
`,e+=`	<B>B</B>
`,e+=`	<I>I</I>
`,e+=`	<ITALIC>ITALIC</ITALIC>
`,e+=`	<EM>EM</EM>
`,e+=`	<U>U</U>
`,e+=`	<UNDERLINE>UNDERLINE</UNDERLINE>
`,e+=`	<S>S</S>
`,e+=`	<STRIKEOUT>STRIKEOUT</STRIKEOUT>
`,e+=`	<H>H</H>
`,e+=`	<HIGH>HIGH</HIGH>
`,e+=`	<C RED>C RED</C>
`,e+=`	<COLOR #F00>COLOR #F00</COLOR>
`,e+=`	<C Maroon>C Maroon</C>
`,e+=`	<COLOR #800000>COLOR #800000</COLOR>
`,e+=`	<H><C Maroon>H C Maroon</C></H>
`,e+=`	<H><COLOR #800000>H COLOR #800000</COLOR></H>
`,e+=`	Run <send PROMPT>#testmxpcolors</send> for a detailed list.
`,e+=`	<FONT "Times New Roman">FONT "Times New Roman"</FONT>
`,e+=`	<FONT "Webdings">FONT "Webdings"</FONT>
`,e+=`	<FONT COLOR=Red,Blink>FONT COLOR=Red,Blink</FONT>
`,e+=`	<FONT "Times New Roman" 24 RED GREEN>FONT "Times New Roman" 24 RED GREEN</FONT>
`,e+=`Line Spacing
`,e+=`	NOBR<NOBR>
`,e+=` Continued<NOBR>
`,e+=` More
`,e+=`	<P>P
`,e+=`	1
`,e+=`	2
`,e+=`	3
`,e+=`	4</P>
`,e+=`	BR Line<BR>Break
`,e+=`	SBR Soft<SBR>Break
`,e+=`Links
`,e+=`	<A "http://shadowmud.com">Click here for ShadowMUD</A> 
`,e+=`	<send>test command</send>
`,e+=`	<send href="command2">test command2</send>
`,e+=`	<send "command1|command2|command3" hint="click to see menu|Item 1|Item 2|Item 3">this is a menu link</SEND>
`,e+=`	<SEND "sample" PROMPT EXPIRE=prompt>Prompt sample</SEND>
`,e+=`	<send PROMPT href="#testmxpexpire">&lt;EXPIRE&gt; - #testmxpexpire</send> 
`,e+=`Horizontal Rule
`,e+=`<hr>
`,e+=`<hr>Text After
`,e+=`Text Before<hr>
`,e+=`<c red blue><hr></c>
`,e+=`Text Before<hr>Text After
`,e+=`Custom Element
`,e+=`	<!ELEMENT help '<send href="help &text;">'>&lt;!ELEMENT help '&lt;send href="help &amp;text;"&gt;'&gt;
`,e+=`	&lt;help&gt;test&lt;/help&gt; = <help>test</help>
`,e+=`	<!ELEMENT redbu '<c red><b><u>'>&lt;!ELEMENT redbu '&lt;c red&gt;&lt;b&gt;&lt;u&gt;'&gt;
`,e+=`	&lt;redbu&gt;test&lt;/redbu&gt; = <redbu>test</redbu>
`,e+=`Entities
`,e+=`	&#243;&brvbar;&copy;&plusmn;&sup3;&para;&frac34;&infin;&Dagger;&dagger;&spades;&clubs;&hearts;&diams;
`,e+=`Custom Entity
`,e+='	<!ENTITY version "'+this.client.version+'">&lt;!ENTITY version "'+this.client.version+`"&gt;
`,e+=`	&amp;version; = &version;
`,e+=`	&lt;V Hp&gt;<V Hp>100</V>&lt;/V&gt; &amp;Hp; = &Hp; &amp;hp; = &hp;
`,e+=`	&lt;VAR Sp&gt;<VAR Sp>200</VAR>&lt;/VAR&gt; &amp;Sp; = &Sp; &amp;sp; = &sp;
`,e+=`Image
`,e+=`default      <image connected.png URL="./images/" w=48 h=48>
`,e+=`align left <image connected.png URL="./images/" align=left w=48 h=48> align left
`,e+=`align right  <image connected.png URL="./images/" align=right w=48 h=48> align right
`,e+=`align top    <image connected.png URL="./images/" align=top w=48 h=48> align top 
`,e+=`align middle <image connected.png URL="./images/" align=middle w=48 h=48> align middle
`,e+=`align bottom <image connected.png URL="./images/" align=bottom w=48 h=48> align bottom
`,e+=`map          <send showmap><image connected.png URL="./images/" ismap w=48 h=48></send>
`,e+="<STAT Hp version Test>",e+="<GAUGE Hp version Test>",e+="\x1B[0z",this.client.print(e,!0)},this.functions.testmxp2=()=>{let e="\x1B[6z";e+="<!-- Elements to support the Auto mapper -->",e+=`<!ELEMENT RName '<FONT COLOR=Red><B>' FLAG="RoomName">`,e+="<!ELEMENT RDesc FLAG='RoomDesc'>",e+="<!ELEMENT RExits '<FONT COLOR=Blue>' FLAG='RoomExit'>",e+="<!-- The next element is used to define a room exit link that sends ",e+="the exit direction to the MUD if the user clicks on it -->",e+="<!ELEMENT Ex '<SEND>'>",e+="<!ELEMENT Chat '<FONT COLOR=Gray>' OPEN>",e+="<!ELEMENT Gossip '<FONT COLOR=Cyan>' OPEN>",e+="<!-- in addition to standard HTML Color specifications, you can use ",e+="color attribute names such as blink -->",e+="<!ELEMENT ImmChan '<FONT COLOR=Red,Blink>'>",e+="<!ELEMENT Auction '<FONT COLOR=Purple>' OPEN>",e+="<!ELEMENT Group '<FONT COLOR=Blue>' OPEN>",e+="<!-- the next elements deal with the MUD prompt -->",e+='<!ELEMENT Prompt FLAG="Prompt">',e+='<!ELEMENT Hp FLAG="Set hp">',e+='<!ELEMENT MaxHp FLAG="Set maxhp">',e+='<!ELEMENT Mana FLAG="Set mana">',e+='<!ELEMENT MaxMana FLAG="Set maxmana">',e+="<!-- now the MUD text -->",e+=`<RName>The Main Temple</RName>
`,e+=`<RDesc>This is the main hall of the MUD where everyone starts.
`,e+=`Marble arches lead south into the town, and there is a <i>lovely</i>
`,e+=`<send "drink &text;">fountain</send> in the center of the temple,</RDesc>
`,e+=`<RExits>Exits: <Ex>N</Ex>, <Ex>S</Ex>, <Ex>E</Ex>, <Ex>W</Ex></RExits>

`,e+=`<Prompt>[<Hp>100</Hp>/<MaxHp>120</MaxHp>hp <Mana>50</Mana>/<MaxMana>55</MaxMana>mana]</Prompt>
<hr>`,e+="<!ELEMENT boldtext '<COLOR &col;><B>' ATT='col=red'>",e+=`<boldtext>This is bold red</boldtext>
`,e+=`<boldtext col=blue>This is bold blue text</boldtext>
`,e+=`<boldtext blue>This is also bold blue text</boldtext>
`,e+="\x1B[0z",this.client.print(e,!0)},this.functions.testmxpexpire=()=>{this.client.print(`	\x1B[6z<SEND "sample" PROMPT EXPIRE=prompt>Expire sample</SEND> <SEND "sample" PROMPT EXPIRE=prompt2>Expire sample2</SEND><EXPIRE prompt> <SEND "sample" PROMPT EXPIRE=prompt>Expire sample3</SEND>\x1B[0z
`,!0),this.client.print(`	\x1B[6z\x1B[36m<SEND "sample" PROMPT EXPIRE=prompt>Expire sample</SEND> <SEND "sample" PROMPT EXPIRE=prompt2>Expire sample2</SEND><EXPIRE prompt> <SEND "sample" PROMPT EXPIRE=prompt>Expire sample3</SEND>\x1B[0z\x1B[0m
`,!0),this.client.print(`	\x1B[6z\x1B[46;30m<SEND "sample" PROMPT EXPIRE=prompt>Expire sample</SEND> <SEND "sample" PROMPT EXPIRE=prompt2>Expire sample2</SEND><EXPIRE prompt> <SEND "sample" PROMPT EXPIRE=prompt>Expire sample3</SEND>\x1B[0z\x1B[0m
`,!0),this.client.print(`	\x1B[6z<SEND "sample" PROMPT EXPIRE=prompt>Expire \x1B[36msample\x1B[0m</SEND> <SEND "sample" PROMPT EXPIRE=prompt2>Expire \x1B[36msample2\x1B[0m</SEND><EXPIRE prompt> <SEND "sample" PROMPT EXPIRE=prompt>Expire \x1B[36msample3\x1B[0m</SEND>\x1B[0z
`,!0)},this.functions.testmxpcolors=()=>{let e=["IndianRed","LightCoral","Salmon","DarkSalmon","LightSalmon","Crimson","Red","FireBrick","DarkRed","Pink","LightPink","HotPink","DeepPink","MediumVioletRed","PaleVioletRed","LightSalmon","Coral","Tomato","OrangeRed","DarkOrange","Orange","Gold","Yellow","LightYellow","LemonChiffon","LightGoldenrodYellow","PapayaWhip","Moccasin","PeachPuff","PaleGoldenrod","Khaki","DarkKhaki","Lavender","Thistle","Plum","Violet","Orchid","Fuchsia","Magenta","MediumOrchid","MediumPurple","BlueViolet","DarkViolet","DarkOrchid","DarkMagenta","Purple","Indigo","SlateBlue","DarkSlateBlue","MediumSlateBlue","GreenYellow","Chartreuse","LawnGreen","Lime","LimeGreen","PaleGreen","LightGreen","MediumSpringGreen","SpringGreen","MediumSeaGreen","SeaGreen","ForestGreen","Green","DarkGreen","YellowGreen","OliveDrab","Olive","DarkOliveGreen","MediumAquamarine","DarkSeaGreen","LightSeaGreen","DarkCyan","Teal","Aqua","Cyan","LightCyan","PaleTurquoise","Aquamarine","Turquoise","MediumTurquoise","DarkTurquoise","CadetBlue","SteelBlue","LightSteelBlue","PowderBlue","LightBlue","SkyBlue","LightSkyBlue","DeepSkyBlue","DodgerBlue","CornflowerBlue","MediumSlateBlue","RoyalBlue","Blue","MediumBlue","DarkBlue","Navy","MidnightBlue","Cornsilk","BlanchedAlmond","Bisque","NavajoWhite","Wheat","BurlyWood","Tan","RosyBrown","SandyBrown","Goldenrod","DarkGoldenrod","Peru","Chocolate","SaddleBrown","Sienna","Brown","Maroon","White","Snow","Honeydew","MintCream","Azure","AliceBlue","GhostWhite","WhiteSmoke","Seashell","Beige","OldLace","FloralWhite","Ivory","AntiqueWhite","Linen","LavenderBlush","MistyRose","Gainsboro","LightGrey","Silver","DarkGray","Gray","DimGray","LightSlateGray","SlateGray","DarkSlateGray","Black"],s="\x1B[6z",n=e.length-1;for(let r=0;r<n;r++)s+=""+e[r]+": ",s+=Array(22-e[r].length).join(" "),s+="<C "+e[r]+">Fore</C> ",s+="<C black "+e[r]+">Back</C> ",s+="<h><C "+e[r]+">High</C></h> ",s+="<b><C "+e[r]+">Bold</C></b> ",s+="<C "+e[r]+">\x1B[1mAnsiBold\x1B[0m ",s+="\x1B[2mFaint\x1B[0m ",s+="\x1B[3mItalic\x1B[0m ",s+="\x1B[4mUnderline\x1B[0m ",s+="\x1B[5mFlash\x1B[0m ",s+="\x1B[7mInverse\x1B[0m ",s+="\x1B[8mConceal\x1B[0m ",s+="\x1B[9mStrikeout\x1B[0m ",s+="\x1B[21mDoubleUnderline\x1B[0m ",s+="\x1B[53mOverline\x1B[0m",s+=`</C>
`;s+="Black: ",s+=Array(17).join(" "),s+="<C Black silver>Fore</C> ",s+="<C silver Black>Back</C> ",s+="<h><C Black silver>High</C></h> ",s+="<b><C Black silver>Bold</C></b> ",s+="<C Black silver>\x1B[1mAnsiBold\x1B[0m ",s+="\x1B[2mFaint\x1B[0m ",s+="\x1B[3mItalic\x1B[0m ",s+="\x1B[4mUnderline\x1B[0m ",s+="\x1B[5mFlash\x1B[0m ",s+="\x1B[7mInverse\x1B[0m ",s+="\x1B[8mConceal\x1B[0m ",s+="\x1B[9mStrikeout\x1B[0m ",s+="\x1B[21mDoubleUnderline\x1B[0m ",s+="\x1B[53mOverline\x1B[0m",s+=`</C>
`,s+="\x1B[0z",this.client.print(s,!0)},this.functions.testmxpelements=()=>{let e="\x1B[6z";e+=`Custom Element
`,e+=`	<!ELEMENT help '<send href="help &text;">'>&lt;!ELEMENT help '&lt;send href="help &amp;text;"&gt;'&gt;
`,e+=`	&lt;help&gt;test&lt;/help&gt; = <help>test</help>
`,e+=`	<!ELEMENT redbu '<c red><b><u>'>&lt;!ELEMENT redbu '&lt;c red&gt;&lt;b&gt;&lt;u&gt;'&gt;
`,e+=`	&lt;redbu&gt;test&lt;/redbu&gt; = <redbu>test</redbu>
`,e+="\x1B[0z",this.client.print(e,!0)},this.functions.testmxpLines=()=>{let e="\x1B[6z";e+="<!ELEMENT Auction '<FONT COLOR=red>' TAG=20 OPEN>",e+=`\x1B[20zA nice shiny sword is being auctioned.
`,e+="\x1B[6z<Auction>Also, a gold ring is being auctioned.</Auction>",e+=`<!ELEMENT Auction TAG=20>
`,e+=`<!TAG 20 Fore=red>
`,e+=`\x1B[20zA nice shiny sword is being auctioned.
`,e+=`\x1B[6z<Auction>Also, a gold ring is being auctioned.</Auction>
`,e+=`\x1B[6z<!TAG 20 Fore=blue>
`,e+=`\x1B[20zA nice shiny sword is being auctioned.
`,e+=`\x1B[6z<Auction>Also, a gold ring is being auctioned.</Auction>
`,e+="\x1B[0z",this.client.print(e,!0)},this.functions.testmapper=()=>{this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:0,dir:"",area:""},area:"Doc Build Samples Area",exits:{south:{num:87723359,dir:"south",area:"Doc Build Samples Area",isdoor:0},east:{num:-329701270,dir:"east",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 1",num:1968208336,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:1968208336,dir:"east",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"wood",exits:{south:{num:1916648905,dir:"south",area:"Doc Build Samples Area",isdoor:0},east:{num:-1688332036,dir:"east",area:"Doc Build Samples Area",isdoor:0},west:{num:1968208336,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 2",num:-329701270,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:-329701270,dir:"east",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"jungle",exits:{south:{num:-348853133,dir:"south",area:"Doc Build Samples Area",isdoor:0},west:{num:-329701270,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 3",num:-1688332036,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:-1688332036,dir:"south",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"grass",exits:{north:{num:-1688332036,dir:"north",area:"Doc Build Samples Area",isdoor:0},south:{num:2072768994,dir:"south",area:"Doc Build Samples Area",isdoor:0},west:{num:1916648905,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 6",num:-348853133,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:-348853133,dir:"west",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"desert",exits:{north:{num:-329701270,dir:"north",area:"Doc Build Samples Area",isdoor:0},south:{num:210551156,dir:"south",area:"Doc Build Samples Area",isdoor:0},east:{num:-348853133,dir:"east",area:"Doc Build Samples Area",isdoor:0},west:{num:87723359,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 5",num:1916648905,indoors:1}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:1916648905,dir:"west",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"tundra",exits:{north:{num:1968208336,dir:"north",area:"Doc Build Samples Area",isdoor:0},south:{num:-1674322715,dir:"south",area:"Doc Build Samples Area",isdoor:0},east:{num:87723359,dir:"east",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 4",num:87723359,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:87723359,dir:"south",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"water",exits:{north:{num:87723359,dir:"north",area:"Doc Build Samples Area",isdoor:0},east:{num:210551156,dir:"east",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 7",num:-1674322715,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:-1674322715,dir:"east",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",environment:"jungle",exits:{north:{num:1916648905,dir:"north",area:"Doc Build Samples Area",isdoor:0},east:{num:2072768994,dir:"east",area:"Doc Build Samples Area",isdoor:0},west:{num:-1674322715,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 8",num:210551156,indoors:0}),this.client.emit("received-GMCP","Room.Info",{details:[],doors:{},prevroom:{num:210551156,dir:"east",area:"Doc Build Samples Area"},area:"Doc Build Samples Area",exits:{north:{num:-348853133,dir:"north",area:"Doc Build Samples Area",isdoor:0},west:{num:210551156,dir:"west",area:"Doc Build Samples Area",isdoor:0}},name:"Sample room 9",num:2072768994,indoors:0})},this.functions.testfansi=()=>{let e="",s;for(e="",s=3;s<=6;s++)e+=String.fromCharCode(s);for(s=14;s<=26;s++)e+=String.fromCharCode(s);for(s=28;s<=31;s++)e+=String.fromCharCode(s);for(s=127;s<=254;s++)e+=String.fromCharCode(s);e+=`
`;let n=this.client.display.displayControlCodes;this.client.display.displayControlCodes=!0,this.client.display.emulateTerminal?(this.client.display.emulateTerminal=!1,this.client.print(e,!0),this.client.display.emulateTerminal=!0,this.client.print(e,!0)):(this.client.print(e,!0),this.client.display.emulateTerminal=!0,this.client.print(e,!0),this.client.display.emulateTerminal=!1),this.client.display.displayControlCodes=n},this.functions.testcontrolchars=()=>{let e,s="1:  ,";for(e=3;e<=9;e++)s+=`${e}: ${String.fromCharCode(e)},`;for(e=11;e<=27;e++)s+=`${e}: ${String.fromCharCode(e)},`;for(e=28;e<=31;e++)s+=`${e}: ${String.fromCharCode(e)},`;for(e=127;e<=254;e++)s+=`${e}: ${String.fromCharCode(e)},`;s+=`
`;let n=this.client.display.displayControlCodes;this.client.display.displayControlCodes=!0,this.client.print(s,!0),this.client.display.displayControlCodes=n},this.functions.testurldetect=()=>{let e=`\x1B[0mhttp://www.google.com
`;e+=`	http://www.google.com\x1B[44m
`,e+=`http://www.google.com
`,e+=`	try this http://www.google.com
`,e+=`http://www.google.com try this
`,e+=`	try this http://www.google.com try this
`,e+=`\x1B[36mhttp://www.google.com
`,e+=`	\x1B[0mhttp://www.google.com
`,e+=`http://www.google.com\x1B[44m
`,e+=`	http://www.google.com
`,e+=`try this http://www.google.com
`,e+=`	http://www.google.com try this
`,e+=`try this http://www.google.com try this
`,e+=`	\x1B[36mhttp://www.google.com
`,e+=`	https://localhost telnet://localhost
`,e+=`	news://test.edu/default.asp?t=1#1111 torrent://localhost/
`,e+=`	ftp://localhost gopher://localhost im://talk
`,e+=`	mailto:address@localhost irc://<host>[:<port>]/[<channel>[?<password>]]
`,e+=`awww... www.google.com awww.com
`,e+="www.google.com www.google.com\x1B[0m",this.client.print(e,!0)},this.functions.testxtermrgb=()=>{let e="",s,n,r,a=0;for(s=0;s<256;s+=16)for(n=0;n<256;n+=16)for(r=0;r<256;r+=16)e+="\x1B[48;2;"+s+";"+n+";"+r+"m  ",a%63===0&&(e+=`
`),a++;e+="\x1B[0m",this.client.print(e,!0)},this.functions.testsize=()=>{let e=this.client.display.WindowSize,s=e.width+"x"+e.height+" ";e.width-=s.length;for(let n=0;n<e.width;n++)s+="w";for(let n=1;n<e.height;n++)s+=`
`+n;this.client.print(s,!0)},this.functions.testspeed=()=>{let e=[],s=this.client.getOption("commandChar")+["testmxpcolors","testmxp","testcolors","testcolorsdetails","testxterm","testxtermrgb"].join(`
`+this.client.getOption("commandChar")),n=this.client.getOption("enableCommands");this.client.setOption("enableCommands",!0);let r=0,a=0,o=0,h;for(let c=0;c<10;c++){let g=new Date().getTime();this.client.sendCommand(s),h=new Date().getTime()-g,r+=h,h>a&&(a=h),(!o||h<o)&&(o=h),e.push(`${c} - ${h}`)}e.push(`Total - ${r}`),e.push(`Average - ${r/10}`),e.push(`Min - ${o}`),e.push(`Max - ${a}`),this.client.print(e.join(`
`)+`
`,!0),this.client.setOption("enableCommands",n)},this.functions.testperiod=()=>{if(window.periodID){clearInterval(window.periodID),delete window.period,delete window.periodID;return}window.period=0,window.periodID=setInterval(()=>{window.period%3===1?this.client.sendCommand("#testcolors"):window.period%3===2?this.client.sendCommand("#testxterm"):this.client.sendCommand("#testlist"),window.period++},2e3)},this.functions.testutf8=()=>{this.client.print(`Armenian
\u0531 \u0532 \u0533 \u0534 \u0535 \u0536 \u0537 \u0538 \u0539 \u053A \u053B \u053C \u053D \u053E \u053F \u0540 \u0541 \u0542 \u0543 \u0544 \u0545 \u0546 \u0547 \u0548 \u0549 \u054A \u054B \u054C \u054D \u054E \u054F \u0550 \u0551 \u0552 \u0553 \u0554 \u0555 \u0556 \u0559 \u055A \u055B \u055C \u055D \u055E \u055F \u0561 \u0562 \u0563 \u0564 \u0565 \u0566 \u0567 \u0568 \u0569 \u056A \u056B \u056C \u056D \u056E \u056F \u0570 \u0571 \u0572 \u0573 \u0574 \u0575 \u0576 \u0577 \u0578 \u0579 \u057A \u057B \u057C \u057D \u057E \u057F \u0580 \u0581 \u0582 \u0583 \u0584 \u0585 \u0586 \u0587 \u0589
Hebrew
\u0591 \u0592 \u0593 \u0594 \u0595 \u0596 \u0597 \u0598 \u0599 \u059A \u059B \u059C \u059D \u059E \u059F \u05A0 \u05A1 \u05A3 \u05A4 \u05A5 \u05A6 \u05A7 \u05A8 \u05A9 \u05AA \u05AB \u05AC \u05AD \u05AE \u05AF \u05B0 \u05B1 \u05B2 \u05B3 \u05B4 \u05B5 \u05B6 \u05B7 \u05B8 \u05B9 \u05BB \u05BC \u05BD \u05BE \u05BF \u05C0 \u05C1 \u05C2 \u05C3 \u05C4 \u05D0 \u05D1 \u05D2 \u05D3 \u05D4 \u05D5 \u05D6 \u05D7 \u05D8 \u05D9 \u05DA \u05DB \u05DC \u05DD \u05DE \u05DF \u05E0 \u05E1 \u05E2 \u05E3 \u05E4 \u05E5 \u05E6 \u05E7 \u05E8 \u05E9 \u05EA \u05F0 \u05F1 \u05F2 \u05F3 \u05F4
Arabic
\u060C \u061B \u061F \u0621 \u0622 \u0623 \u0624 \u0625 \u0626 \u0627 \u0628 \u0629 \u062A \u062B \u062C \u062D \u062E \u062F \u0630 \u0631 \u0632 \u0633 \u0634 \u0635 \u0636 \u0637 \u0638 \u0639 \u063A \u0640 \u0641 \u0642 \u0643 \u0644 \u0645 \u0646 \u0647 \u0648 \u0649 \u064A \u064B \u064C \u064D \u064E \u064F \u0650 \u0651 \u0652 \u0660 \u0661 \u0662 \u0663 \u0664 \u0665 \u0666 \u0667 \u0668 \u0669 \u066A \u066B \u066C \u066D \u0670 \u0671 \u0672 \u0673 \u0674 \u0675 \u0676 \u0677 \u0678 \u0679 \u067A \u067B \u067C \u067D \u067E \u067F \u0680 \u0681 \u0682 \u0683 \u0684 \u0685 \u0686 \u0687 \u0688 \u0689 \u068A \u068B \u068C \u068D \u068E \u068F \u0690 \u0691 \u0692 \u0693 \u0694 \u0695 \u0696 \u0697 \u0698 \u0699 \u069A \u069B \u069C \u069D \u069E \u069F \u06A0 \u06A1 \u06A2 \u06A3 \u06A4 \u06A5 \u06A6 \u06A7 \u06A8 \u06A9 \u06AA \u06AB \u06AC \u06AD \u06AE \u06AF \u06B0 \u06B1 ...
Devanagari
\u0901 \u0902 \u0903 \u0905 \u0906 \u0907 \u0908 \u0909 \u090A \u090B \u090C \u090D \u090E \u090F \u0910 \u0911 \u0912 \u0913 \u0914 \u0915 \u0916 \u0917 \u0918 \u0919 \u091A \u091B \u091C \u091D \u091E \u091F \u0920 \u0921 \u0922 \u0923 \u0924 \u0925 \u0926 \u0927 \u0928 \u0929 \u092A \u092B \u092C \u092D \u092E \u092F \u0930 \u0931 \u0932 \u0933 \u0934 \u0935 \u0936 \u0937 \u0938 \u0939 \u093C \u093D \u093E \u093F \u0940 \u0941 \u0942 \u0943 \u0944 \u0945 \u0946 \u0947 \u0948 \u0949 \u094A \u094B \u094C \u094D \u0950 \u0951 \u0952 \u0953 \u0954 \u0958 \u0959 \u095A \u095B \u095C \u095D \u095E \u095F \u0960 \u0961 \u0962 \u0963 \u0964 \u0965 \u0966 \u0967 \u0968 \u0969 \u096A \u096B \u096C \u096D \u096E \u096F \u0970
Armenian
\u0531 \u0532 \u0533 \u0534 \u0535 \u0536 \u0537 \u0538 \u0539 \u053A \u053B \u053C \u053D \u053E \u053F \x1B[33m\u0540 \u0541 \u0542 \u0543 \u0544 \u0545 \u0546 \u0547 \u0548 \u0549 \u054A \u054B \u054C \u054D \u054E \u054F \u0550 \u0551 \u0552 \x1B[34m\u0553 \u0554 \u0555 \u0556 \u0559 \u055A \u055B \u055C \u055D \u055E \u055F \u0561 \u0562 \u0563 \u0564 \u0565 \u0566 \u0567 \u0568 \u0569 \u056A \u056B \u056C \u056D \u056E \u056F \u0570\x1B[35m \u0571 \u0572 \u0573 \u0574 \u0575 \u0576 \u0577 \u0578 \u0579 \u057A \u057B \u057C \u057D \u057E \u057F \u0580 \u0581 \u0582 \u0583 \u0584 \u0585 \u0586 \u0587 \u0589\x1B[0m
Hebrew
\u0591 \u0592 \u0593 \u0594 \u0595 \u0596 \u0597 \u0598 \u0599 \u059A \u059B \u059C \u059D \u059E\x1B[33m \u059F \u05A0 \u05A1 \u05A3 \u05A4 \u05A5 \u05A6 \u05A7 \u05A8 \u05A9 \u05AA \u05AB \u05AC \u05AD \u05AE \u05AF \u05B0 \u05B1 \u05B2 \u05B3 \u05B4 \u05B5 \u05B6 \u05B7 \u05B8 \u05B9 \u05BB \u05BC \u05BD \u05BE \u05BF \u05C0 \u05C1 \u05C2 \u05C3 \u05C4 \u05D0 \u05D1 \u05D2 \u05D3 \u05D4 \u05D5 \u05D6 \u05D7 \u05D8 \u05D9 \u05DA \u05DB \u05DC\x1B[34m \u05DD \u05DE \u05DF \u05E0 \u05E1 \u05E2 \u05E3 \u05E4 \u05E5 \u05E6 \u05E7 \u05E8 \u05E9 \u05EA \u05F0 \u05F1 \u05F2 \u05F3 \u05F4\x1B[0m
\u0591 \u0592 \u0593 \u0594 \u0595 \u0596 \u0597 \u0598 \u0599 \u059A \u059B \u059C \u059D \u059E\x1B[33m \u059F \u05A0 \u05A1 \u05A3 \u05A4 \u05A5 \u05A6 \u05A7 \u05A8 \u05A9 \u05AA \u05AB \u05AC \u05AD \u05AE \u05AF \u05B0 \u05B1 \u05B2 \u05B3 \u05B4 \u05B5 \u05B6 \u05B7 \u05B8 \u05B9 \u05BB \u05BC \u05BD \u05BE \u05BF \u05C0 \u05C1 \u05C2 \u05C3 \u05C4 \u05D0 \u05D1 \u05D2 \u05D3 \u05D4 \u05D5 \u05D6 \u05D7 \u05D8 \u05D9 \u05DA \u05DB \u05DCa\x1B[34m \u05DD \u05DE \u05DF \u05E0 \u05E1 \u05E2 \u05E3 \u05E4 \u05E5 \u05E6 \u05E7 \u05E8 \u05E9 \u05EA \u05F0 \u05F1 \u05F2 \u05F3 \u05F4\x1B[0m
Arabic
\u060C \u061B \u061F \u0621 \u0622 \u0623 \u0624 \u0625 \u0626 \u0627 \u0628 \u0629 \u062A \u062B \u062C \u062D \u062E \u062F \u0630 \u0631 \u0632 \u0633 \u0634 \u0635 \u0636 \u0637 \u0638 \u0639\x1B[34m \u063A \u0640 \u0641 \u0642 \u0643 \u0644 \u0645 \u0646 \u0647 \u0648 \u0649 \u064A \u064B \u064C \u064D \u064E \u064F \u0650 \u0651 \u0652 \u0660 \u0661 \u0662 \u0663 \u0664 \u0665 \u0666 \u0667 \u0668 \u0669 \u066A \u066B \u066C \u066D \u0670 \u0671 \u0672 \u0673 \u0674 \u0675 \u0676 \u0677 \u0678 \u0679 \u067A \u067B \u067C \u067D \u067E \u067F \u0680 \u0681 \u0682 \u0683 \u0684 \u0685 \u0686 \u0687 \u0688 \u0689 \u068A \u068B \u068C \u068D \u068E \u068F \u0690 \u0691 \u0692 \u0693 \u0694 \u0695 \u0696 \u0697 \u0698 \u0699 \u069A \u069B \u069C \u069D \u069E \u069F \u06A0 \u06A1 \u06A2 \u06A3 \u06A4 \u06A5 \u06A6 \x1B[33m\u06A7 \u06A8 \u06A9 \u06AA \u06AB \u06AC \u06AD \u06AE \u06AF \u06B0 \u06B1 ...\x1B[0m
Devanagari
\u0901 \u0902 \u0903 \u0905 \u0906 \u0907 \u0908 \u0909 \u090A \u090B \u090C \u090D \u090E \u090F \u0910 \u0911 \u0912 \u0913 \u0914 \u0915 \u0916 \u0917 \u0918 \u0919 \u091A \u091B \u091C \u091D \u091E \u091F \u0920 \u0921 \u0922 \u0923 \u0924 \u0925 \u0926 \u0927 \u0928 \u0929 \u092A \x1B[33m\u092B \u092C \u092D \u092E \u092F \u0930 \u0931 \u0932 \u0933 \u0934 \u0935 \u0936 \u0937 \u0938 \u0939 \u093C \u093D \u093E \u093F \u0940 \u0941 \u0942 \u0943 \u0944 \u0945 \u0946 \u0947 \u0948 \u0949 \u094A \u094B \u094C \u094D \u0950 \u0951 \u0952 \u0953 \u0954 \u0958 \u0959 \u095A \u095B\x1B[34m \u095C \u095D \u095E \u095F \u0960 \u0961 \u0962 \u0963 \u0964 \u0965 \u0966 \u0967 \u0968 \u0969 \u096A \u096B \u096C \u096D \u096E \u096F \u0970\x1B[0m`,!0)},this.functions.testunicodeemoji=()=>{let e="";for(var s=[[128513,128591],[9986,10160],[128640,128704],[128512,128566],[128641,128709],[127757,128359]],n=0,r=0;r<s.length;r++){for(var a=s[r],o=a[0];o<a[1];o++)e+=String.fromCodePoint(o),n++,n==36&&(e+=`
`,n=0);e+="\x1B[4z<hr>",n=0}let h=`\x1B[4z<hr>\xA9\xAE\u203C\u2049#\u20E38\u20E39\u20E37\u20E30\u20E36\u20E35\u20E34\u20E33\u20E32\u20E31\u20E3\u2122\u2139\u2194\u2195\u2196\u2197\u2198\u2199\u21A9\u21AA\u231A\u231B\u23E9\u23EA\u23EB\u23EC\u23F0\u23F3\u25AA\u25AB\u25B6\u25C0\u25FB\u25FC\u25FD\u25FE\u2600\u2601\u260E\u2611\u2614\u2615
\u261D\u263A\u2648\u2649\u264A\u264B\u264C\u264D\u264E\u264F\u2650\u2651\u2652\u2653\u2660\u2663\u2665\u2666\u2668\u267B\u267F\u2693\u26A0\u26A1\u26AA\u26AB\u26BD\u26BE\u26C4\u26C5\u26CE\u26D4\u26EA\u26F2\u26F3\u26F5
\u26FA\u26FD\u2934\u2935\u2B05\u2B06\u2B07\u2B1B\u2B1C\u2B50\u2B55\u3030\u303D\u3297\u3299\u{1F004}\u{1F0CF}\u{1F300}\u{1F301}\u{1F302}\u{1F303}\u{1F304}\u{1F305}\u{1F306}\u{1F307}\u{1F308}\u{1F309}\u{1F30A}\u{1F30B}\u{1F30C}\u{1F30F}\u{1F311}\u{1F313}\u{1F314}\u{1F315}
\u{1F319}\u{1F31B}\u{1F31F}\u{1F320}\u{1F330}\u{1F331}\u{1F334}\u{1F335}\u{1F337}\u{1F338}\u{1F339}\u{1F33A}\u{1F33B}\u{1F33C}\u{1F33D}\u{1F33E}\u{1F33F}\u{1F340}\u{1F341}\u{1F342}\u{1F343}\u{1F344}\u{1F345}\u{1F346}\u{1F347}\u{1F348}\u{1F349}\u{1F34A}\u{1F34C}\u{1F34D}\u{1F34E}\u{1F34F}\u{1F351}
\u{1F352}\u{1F353}\u{1F354}\u{1F355}\u{1F356}\u{1F357}\u{1F358}\u{1F359}\u{1F35A}\u{1F35B}\u{1F35C}\u{1F35D}\u{1F35E}\u{1F35F}\u{1F360}\u{1F361}\u{1F362}\u{1F363}\u{1F364}\u{1F365}\u{1F366}\u{1F367}\u{1F368}\u{1F369}\u{1F36A}\u{1F36B}\u{1F36C}\u{1F36D}\u{1F36E}\u{1F36F}\u{1F370}\u{1F371}\u{1F372}
\u{1F373}\u{1F374}\u{1F375}\u{1F376}\u{1F377}\u{1F378}\u{1F379}\u{1F37A}\u{1F37B}\u{1F380}\u{1F381}\u{1F382}\u{1F383}\u{1F384}\u{1F385}\u{1F386}\u{1F387}\u{1F388}\u{1F389}\u{1F38A}\u{1F38B}\u{1F38C}\u{1F38D}\u{1F38E}\u{1F38F}\u{1F390}\u{1F391}\u{1F392}\u{1F393}\u{1F3A0}\u{1F3A1}\u{1F3A2}\u{1F3A3}\u{1F3A4}
\u{1F3A5}\u{1F3A6}\u{1F3A7}\u{1F3A8}\u{1F3A9}\u{1F3AA}\u{1F3AB}\u{1F3AC}\u{1F3AD}\u{1F3AE}\u{1F3AF}\u{1F3B0}\u{1F3B1}\u{1F3B2}\u{1F3B3}\u{1F3B4}\u{1F3B5}\u{1F3B6}\u{1F3B7}\u{1F3B8}\u{1F3B9}\u{1F3BA}\u{1F3BB}\u{1F3BC}\u{1F3BD}\u{1F3BE}\u{1F3BF}\u{1F3C0}\u{1F3C1}\u{1F3C2}\u{1F3C3}\u{1F3C4}
\u{1F3C6}\u{1F3C8}\u{1F3CA}\u{1F3E0}\u{1F3E1}\u{1F3E2}\u{1F3E3}\u{1F3E5}\u{1F3E6}\u{1F3E7}\u{1F3E8}\u{1F3E9}\u{1F3EA}\u{1F3EB}\u{1F3EC}\u{1F3ED}\u{1F3EE}\u{1F3EF}\u{1F3F0}\u{1F40C}\u{1F40D}\u{1F40E}\u{1F411}\u{1F412}\u{1F414}\u{1F417}\u{1F418}\u{1F419}\u{1F41A}\u{1F41B}\u{1F41C}\u{1F41D}
\u{1F41E}\u{1F41F}\u{1F420}\u{1F421}\u{1F422}\u{1F423}\u{1F424}\u{1F425}\u{1F426}\u{1F427}\u{1F428}\u{1F429}\u{1F42B}\u{1F42C}\u{1F42D}\u{1F42E}\u{1F42F}\u{1F430}\u{1F431}\u{1F432}\u{1F433}\u{1F434}\u{1F435}\u{1F436}\u{1F437}\u{1F438}\u{1F439}\u{1F43A}\u{1F43B}\u{1F43C}\u{1F43D}\u{1F43E}
\u{1F440}\u{1F442}\u{1F443}\u{1F444}\u{1F445}\u{1F446}\u{1F447}\u{1F448}\u{1F449}\u{1F44A}\u{1F44B}\u{1F44C}\u{1F44D}\u{1F44E}\u{1F44F}\u{1F450}\u{1F451}\u{1F452}\u{1F453}\u{1F454}\u{1F455}\u{1F456}\u{1F457}\u{1F458}\u{1F459}\u{1F45A}\u{1F45B}\u{1F45C}\u{1F45D}\u{1F45E}\u{1F45F}\u{1F460}\u{1F461}\u{1F462}
\u{1F463}\u{1F464}\u{1F466}\u{1F467}\u{1F468}\u{1F469}\u{1F46A}\u{1F46B}\u{1F46E}\u{1F46F}\u{1F470}\u{1F471}\u{1F472}\u{1F473}\u{1F474}\u{1F475}\u{1F476}\u{1F477}\u{1F478}\u{1F479}\u{1F47A}\u{1F47B}\u{1F47C}\u{1F47D}\u{1F47E}\u{1F47F}\u{1F480}\u{1F481}\u{1F482}\u{1F483}\u{1F484}\u{1F485}\u{1F486}
\u{1F487}\u{1F488}\u{1F489}\u{1F48A}\u{1F48B}\u{1F48C}\u{1F48D}\u{1F48E}\u{1F48F}\u{1F490}\u{1F491}\u{1F492}\u{1F493}\u{1F494}\u{1F495}\u{1F496}\u{1F497}\u{1F498}\u{1F499}\u{1F49A}\u{1F49B}\u{1F49C}\u{1F49D}\u{1F49E}\u{1F49F}\u{1F4A0}\u{1F4A1}\u{1F4A2}\u{1F4A3}\u{1F4A4}\u{1F4A5}\u{1F4A6}\u{1F4A7}
\u{1F4A8}\u{1F4A9}\u{1F4AA}\u{1F4AB}\u{1F4AC}\u{1F4AE}\u{1F4AF}\u{1F4B0}\u{1F4B1}\u{1F4B2}\u{1F4B3}\u{1F4B4}\u{1F4B5}\u{1F4B8}\u{1F4B9}\u{1F4BA}\u{1F4BB}\u{1F4BC}\u{1F4BD}\u{1F4BE}\u{1F4BF}\u{1F4C0}\u{1F4C1}\u{1F4C2}\u{1F4C3}\u{1F4C4}\u{1F4C5}\u{1F4C6}\u{1F4C7}\u{1F4C8}\u{1F4C9}\u{1F4CA}\u{1F4CB}
\u{1F4CC}\u{1F4CD}\u{1F4CE}\u{1F4CF}\u{1F4D0}\u{1F4D1}\u{1F4D2}\u{1F4D3}\u{1F4D4}\u{1F4D5}\u{1F4D6}\u{1F4D7}\u{1F4D8}\u{1F4D9}\u{1F4DA}\u{1F4DB}\u{1F4DC}\u{1F4DD}\u{1F4DE}\u{1F4DF}\u{1F4E0}\u{1F4E1}\u{1F4E2}\u{1F4E3}\u{1F4E4}\u{1F4E5}\u{1F4E6}\u{1F4E7}\u{1F4E8}\u{1F4E9}\u{1F4EA}\u{1F4EB}\u{1F4EE}\u{1F4F0}
\u{1F4F1}\u{1F4F2}\u{1F4F3}\u{1F4F4}\u{1F4F6}\u{1F4F7}\u{1F4F9}\u{1F4FA}\u{1F4FB}\u{1F4FC}\u{1F503}\u{1F50A}\u{1F50B}\u{1F50C}\u{1F50D}\u{1F50E}\u{1F50F}\u{1F510}\u{1F511}\u{1F512}\u{1F513}\u{1F514}\u{1F516}\u{1F517}\u{1F518}\u{1F519}\u{1F51A}\u{1F51B}\u{1F51C}\u{1F51D}\u{1F51E}\u{1F51F}\u{1F520}
\u{1F521}\u{1F522}\u{1F523}\u{1F524}\u{1F525}\u{1F526}\u{1F527}\u{1F528}\u{1F529}\u{1F52A}\u{1F52B}\u{1F52E}\u{1F52F}\u{1F530}\u{1F531}\u{1F532}\u{1F533}\u{1F534}\u{1F535}\u{1F536}\u{1F537}\u{1F538}\u{1F539}\u{1F53A}\u{1F53B}\u{1F53C}\u{1F53D}\u{1F550}\u{1F551}\u{1F552}\u{1F553}\u{1F554}\u{1F555}
\u{1F556}\u{1F557}\u{1F558}\u{1F559}\u{1F55A}\u{1F55B}\u{1F5FB}\u{1F5FC}\u{1F5FD}\u{1F5FE}\u{1F5FF}`;this.client.print(e,!0),this.client.print(h,!0)},this.functions.testlines=()=>{let e=this.client.display.maxLines,s="",n=this.client.display.model.getNextLineID;for(let r=0;r<e;r++)s+=`Line: ${r}, LineID: ${n+r}
`;this.client.print(s,!0)},this.functions.testscreen=()=>{let e="Window innerWidth: "+window.innerWidth;e+=`
Window innerHeight: `+window.innerHeight,e+=`
Document clientWidth: `+document.body.clientWidth,e+=`
Document clientHeight: `+document.body.clientHeight,e+=`
Display clientWidth: `+this.client.display.container.clientWidth,e+=`
Display clientHeight: `+this.client.display.container.clientHeight,e+=`
Screen orientation: `+screen?.orientation?.type,this.client.print(e,!0)}}remove(){this.client&&this.client.off("function",this._event)}initialize(){this.client&&this.client.on("function",this._event)}get menu(){return[]}get settings(){return[]}processFunction(t){let e;t&&(e=t.name.toLowerCase(),e.endsWith("()")&&(e=e.substring(0,e.length-2)),this.functions[e]&&(console.time(e),this.functions[e].apply(this,t||{}),console.timeEnd(e),t.handled=!0))}};var yt=li(Hi());var ks={out:4096,enter:2048,unknown:1024,up:512,down:256,north:128,northeast:64,east:32,southeast:16,south:8,southwest:4,west:2,northwest:1,none:0},xe=class m{constructor(u){this.num=null;this.x=0;this.y=0;this.z=0;this.area="";this.zone=0;this.details=0;this.exits={};if(u)for(let t in u)u.hasOwnProperty(t)&&(this[t]=u[t])}get exitsID(){return Object.keys(this.exits).map(u=>ks[u]).reduce((u,t)=>u|t,0)}clone(){return new m(hi(this))}},Vt=class m extends pe{constructor(){super();this.changed=!1;this._rooms={},this._areas=[],this._zone=0,this._keys=[],this._keysZones=[],this._current=new xe}get current(){return this._current}set current(t){this._current=t,this.emit("current-changed",t)}get Rooms(){return this._rooms}set Rooms(t){if(Array.isArray(t)){let n=t,r={};for(var e=0,s=n.length;e<s;e++)r[n[e].num]=n[e];this._rooms=r}else this._rooms=t||{};this.buildKeys(),this._keys.forEach(n=>{this._rooms[n]=this.normalizeRoom(this._rooms[n]),this._rooms[n].zone>this._zone&&(this._zone=this._rooms[n].zone),this._areas.indexOf(this._rooms[n].area)===-1&&this._areas.push(this._rooms[n].area)}),this._areas.sort()}get Areas(){return this._areas||this.buildAreas(),this._areas}get zone(){return this._zone}set zone(t){this._zone=t||0}get count(){return this._keys.length}static load(){return new Promise((t,e)=>{localforage.getItem("nMapperData").then(s=>{let n=new m;s&&s.Rooms&&(n.Rooms=s.Rooms),t(n)}).catch(e)})}save(){return this.changed=!1,localforage.setItem("nMapperData",{Rooms:this._rooms,Areas:this.Areas,Keys:this._keys})}getRoom(t){let e=this._keys,s=Object.keys(t),n=s.length;e:for(let r=0,a=e.length;r<a;r++){let o=this._rooms[e[r]];for(let h=0;h<n;h++)if(o[s[h]]!==t[s[h]])continue e;return o}return null}getRooms(t){let e=this._keys,s=Object.keys(t),n=s.length,r=[];e:for(let a=0,o=e.length;a<o;a++){let h=this._rooms[e[a]];for(let c=0;c<n;c++)if(h[s[c]]!==t[s[c]])continue e;r.push(h)}return r}roomExists(t){let e=this._keysZones,s=Object.keys(t),n=s.length;return e.findIndex(r=>{let a=this._rooms[r];for(let o=0;o<n;o++)if(a[s[o]]!==t[s[o]])return!1;return!0})!==-1}removeRoom(t){if(typeof t=="string"&&(t=this._rooms[t]),!!t&&this.Rooms[t.num]){let e=this._keys.indexOf(t.num);if(e!==-1&&this._keys.splice(e,1),e=this._keysZones.indexOf(t.num),e!==-1&&this._keysZones.splice(e,1),delete this._rooms[t.num],this.changed=!0,this.emit("rooms-removed",[t]),!this.getRoom({area:t.area})){let s=this._areas.indexOf(t.area);this._areas.splice(s,1),this.emit("areas-removed",[t.area])}}}removeRooms(t){let e=this._keys,s=Object.keys(t),n=s.length,r=[],a,o={};e:for(let h=e.length-1;h>=0;h--){let c=this._rooms[e[h]];for(let g=0;g<n;g++)if(c[s[g]]!==t[s[g]])continue e;r.push(c),a=this._keys.indexOf(c.num),a!==-1&&this._keys.splice(a,1),a=this._keysZones.indexOf(c.num),a!==-1&&this._keysZones.splice(a,1),o[c.area]=!0,delete this._rooms[c.num]}if(r.length){this.changed=!0,this.emit("rooms-removed",r);for(let h in o)if(!this.getRoom({area:h})){let c=this._areas.indexOf(h);this._areas.splice(c,1)}this.emit("areas-removed",Object.keys(o))}}removeAllRooms(){let t=this._keys.map(s=>this._rooms[s]),e=this._areas;this._rooms={},this._keys=[],this._keysZones=[],this._areas=[],this._zone=0,this.current=new xe,this.changed=!0,this.emit("rooms-removed",t),this.emit("areas-removed",e)}setRoom(t){if(t)return this.changed=!0,t=this.normalizeRoom(t),this.emit("before-room-changed",this._rooms[t.num]),this._rooms[t.num]=t,t.zone>this._zone&&(this._zone=t.zone),this.buildKeys(),this.addArea(t.area),this.emit("room-changed",this._rooms[t.num]),this._rooms[t.num]}addArea(t){if(!t)return 0;this._areas.indexOf(t)===-1&&(this._areas.push(t),this._areas.sort(),this.emit("areas-added",[t]))}getFreeZone(t){return t||(t=0),t>this.zone?t:++this.zone}normalizeRoom(t){let e=""+(t.num||t.ID),s={area:t.Area||t.area||"",details:t.Details||t.details||0,name:t.Name||t.name||"",env:t.Env||t.env||t.environment||"",x:+t.X||+t.x||0,y:+t.Y||+t.y||0,z:+t.Z||+t.z||0,zone:+t.Zone||+t.zone||0,indoors:+t.Indoors||+t.indoors||0,background:t.Background||t.background||"",notes:t.Notes||t.notes||"",num:e?""+e:null,exits:t.exits||{}};if(s.exits){let n,r;for(n in s.exits)s.exits.hasOwnProperty(n)&&(r=s.exits[n].DestID||s.exits[n].num||null,s.exits[n]={num:r?""+r:null,isdoor:+s.exits[n].IsDoor||+s.exits[n].isdoor||null,isclosed:+s.exits[n].IsClosed||+s.exits[n].isclosed||null})}return new xe(s)}buildKeys(){this._keys=Object.keys(this._rooms).sort((t,e)=>{let s=this._rooms[t],n=this._rooms[e];return s.x>n.x?1:s.x<n.x?-1:s.y>n.y?1:s.y<n.y?-1:s.z>n.z?1:s.z<n.z?-1:s.zone>n.zone?1:s.zone<n.zone?-1:t.localeCompare(e)}),this._keysZones=this._keys.slice().sort((t,e)=>{let s=this._rooms[t],n=this._rooms[e];return s.zone>n.zone?1:s.zone<n.zone?-1:t.localeCompare(e)})}buildAreas(){this._areas=[],this._keys.forEach(t=>{this._areas.indexOf(this._rooms[t].area)===-1&&this._areas.push(this._rooms[t].area)}),this._areas.sort()}cancelImport(){this._cancel=!0}async import(t,e){if(!t||t===null||typeof t>"u")return;this._cancel=!1,Array.isArray(t)||(t=Object.values(t)),e===1&&this.removeAllRooms(),this.emit("import-progress",0);let s=t.length,n,r={};this._areas.forEach(o=>r[o]=!0);let a=[];for(let o=0;o<s&&!this._cancel;o++)this.emit("import-progress",Math.floor(o/s*100)),t[o]!==null&&(n=this.normalizeRoom(t[o]),this._rooms[n.num]=n,n.zone>this._zone&&(this._zone=n.zone),r[n.area]=!0,a.push(n));this.emit("rooms-changed",a),this._areas=Object.keys(r),this._areas.sort(),this.emit("areas-added",Object.keys(r)),this.buildKeys(),this.changed=!0,this._cancel?this.emit("import-canceled"):this.emit("import-complete")}};var Qt=class extends pe{constructor(t,e){super();this.MouseDrag={x:0,y:0,button:0,state:!1};this.drag=!1;this.vscroll=0;this.hscroll=0;this.markers={};this._updating=0;this._rTimeout=0;this.$focused=!1;this._showLegend=!1;this._splitArea=!1;this._fillWalls=!1;this._enabled=!0;this._follow=!0;this.commandDelay=500;this.commandDelayCount=5;this._scale=1;this._mapperNavDown=!1;this._pointerCache=[];this._pointerDistance=-1;this._showNav=!0;if(!t)throw new Error("Container must be a selector, element, jquery object or Map options");if(typeof t=="object"&&"container"in t?(e=Object.assign(e||{},t),t=e.container,delete e.container):e||(e={}),typeof t=="string"){if(this._container=document.querySelector(t),!this._container)throw new Error("Invalid selector for display.")}else if(t instanceof $)this._container=t[0];else if(t instanceof HTMLElement)this._container=t;else throw new Error("Container must be a selector, element or jquery object");this._resizeObserver=new ResizeObserver((n,r)=>{n.length!==0&&(!n[0].contentRect||n[0].contentRect.width===0||n[0].contentRect.height===0||(!this._resizeObserverCache||this._resizeObserverCache.height!==n[0].contentRect.height||this._resizeObserverCache.width!==n[0].contentRect.width)&&(this._resizeObserverCache={width:n[0].contentRect.width,height:n[0].contentRect.height},this._resizeCanvas()))}),this._resizeObserver.observe(this._container),this._observer=new MutationObserver(n=>{let r;for(r of n)r.type==="attributes"&&r.attributeName==="style"&&this._resizeCanvas()}),this._observer.observe(this._container,{attributes:!0,attributeOldValue:!0,attributeFilter:["style"]}),this._canvas=document.createElement("canvas"),this._canvas.id=this._container.id+"-canvas",this._canvas.classList.add("map-canvas"),this._canvas.style.touchAction="none",this._canvas.tabIndex=1,this._resizeCanvas(),this._container.appendChild(this._canvas),this._container.insertAdjacentHTML("afterbegin",`<div class="MapperNavButton" title="Scroll northwest" style="top:4px;left:4px;background-position: 0px 0px;" data-x="-1" data-y="-1"></div>
        <div class="MapperNavButton" title="Scroll north" style="top:4px;left:50%;background-position: -22px 0px;margin-left:-11px;" data-x="0" data-y="-1"></div>
        <div class="MapperNavButton" title="Scroll northeast" style="top:4px;left:100%;background-position: -44px 0px;margin-left:-26px;" data-x="1" data-y="-1"></div>
        <div class="MapperNavButton" title="Scroll west" style="top:50%;left:4px;background-position: 0px -22px;margin-top:-11px;" data-x="-1" data-y="0"></div>
        <div class="MapperNavButton" title="Scroll east" style="top:50%;left:100%;background-position: -44px -22px;margin-top:-11px;margin-left:-26px;" data-x="1" data-y="0"></div>
        <div class="MapperNavButton" title="Scroll southwest" style="bottom:4px;left:4px;background-position: 0px -44px;" data-x="-1" data-y="1"></div>
        <div class="MapperNavButton" title="Scroll south" style="bottom:4px;left:50%;background-position: -22px -44px;margin-left:-11px;" data-x="0" data-y="1"></div>
        <div class="MapperNavButton" title="Scroll southeast" style="bottom:4px;left:100%;background-position: -44px -44px;margin-left:-26px;" data-x="1" data-y="1"></div>`),this._container.querySelectorAll(".MapperNavButton").forEach(n=>{n.addEventListener("wheel",r=>{this._mapperNavDown=!0;let a=r.currentTarget||r.target;r.deltaY>=0?this.mapperNavClick(-parseInt(a.dataset.x,10),-parseInt(a.dataset.y,10)):this.mapperNavClick(parseInt(a.dataset.x,10),parseInt(a.dataset.y,10)),this._mapperNavDown=!1},{passive:!0}),n.addEventListener("mouseleave",()=>this._mapperNavDown=!1),n.addEventListener("mouseup",()=>this._mapperNavDown=!1),n.addEventListener("mousedown",r=>{this._mapperNavDown=!0;let a=r.currentTarget||r.target;this.mapperNavClick(parseInt(a.dataset.x,10),parseInt(a.dataset.y,10))})}),this._context=this._canvas.getContext("2d"),this._context.mozImageSmoothingEnabled=!1,this._context.webkitImageSmoothingEnabled=!1,this._context.imageSmoothingEnabled=!1,this._canvas.addEventListener("pointerdown",n=>{this._pointerCache.push(n)}),this._canvas.addEventListener("pointermove",n=>{let r=this._pointerCache.findIndex(a=>a.pointerId===n.pointerId);if(this._pointerCache[r]=n,this._pointerCache.length===2){let a=Math.abs(this._pointerCache[0].clientX-this._pointerCache[1].clientX);this._pointerDistance>0&&(a>this._pointerDistance&&this.scale<300&&(this.scale+=1),a<this._pointerDistance&&this.scale>25&&(this.scale-=1)),this._pointerDistance=a}});let s=n=>{let r=this._pointerCache.findIndex(a=>a.pointerId===n.pointerId);this._pointerCache.splice(r,1),this._pointerCache.length<2&&(this._pointerDistance=-1)};this._canvas.addEventListener("pointerup",s),this._canvas.addEventListener("pointercancel",s),this._canvas.addEventListener("pointerout",s),this._canvas.addEventListener("pointerleave",s),this._canvas.addEventListener("touchstart",n=>{this.Mouse=this.getMapMousePos(n),this.MouseDown=this.getMapMousePos(n),this.MouseDrag.state=!0,this.drag=n.touches.length===1},{passive:!0}),this._canvas.addEventListener("touchmove",n=>{if(this.MousePrev=this.Mouse,this.Mouse=this.getMapMousePos(event),this.drag){this.MouseDrag.x+=this.MousePrev.x-this.Mouse.x,this.MouseDrag.y+=this.MousePrev.y-this.Mouse.y;let r=Math.floor(this.MouseDrag.x/32/this._scale),a=Math.floor(this.MouseDrag.y/32/this._scale);(r>0||r<0||a<0||a>0)&&(this.MouseDrag.x-=r*32*this._scale,this.MouseDrag.y-=a*32*this._scale,this.scrollBy(r,a)),this._canvas.style.cursor="move"}n.preventDefault()},{passive:!0}),this._canvas.addEventListener("touchend",n=>{if(this.Mouse=this.getMapMousePos(n),this.MouseDown||(this.MouseDown=this.getMapMousePos(n)),this.Mouse.button===0&&Math.floor(this.Mouse.x/32/this._scale)===Math.floor(this.MouseDown.x/32/this._scale)&&Math.floor(this.Mouse.y/32/this._scale)===Math.floor(this.MouseDown.y/32/this._scale)){let r=this.Mouse.x,a=this.Mouse.y,o=this.findActiveRoomByCoords(r,a);(!this.selected||o&&o.num!==this.selected.num)&&(this.selected=o)}this.MouseDrag.state=!1,this.drag=!1,this._canvas.style.cursor="default;"},{passive:!0}),this._canvas.addEventListener("mousemove",n=>{if(this.MousePrev=this.Mouse,this.Mouse=this.getMapMousePos(n),this.drag){this.MouseDrag.x+=this.MousePrev.x-this.Mouse.x,this.MouseDrag.y+=this.MousePrev.y-this.Mouse.y;let r=Math.floor(this.MouseDrag.x/32/this._scale),a=Math.floor(this.MouseDrag.y/32/this._scale);(r>0||r<0||a<0||a>0)&&(this.MouseDrag.x-=r*32*this._scale,this.MouseDrag.y-=a*32*this._scale,this.scrollBy(r,a)),this._canvas.style.cursor="move"}n.preventDefault()}),this._canvas.addEventListener("mousedown",n=>{this.Mouse=this.getMapMousePos(n),this.MouseDown=this.getMapMousePos(n),this.MouseDrag.state=!0,this.drag=this.MouseDown.button===0}),this._canvas.addEventListener("mouseup",n=>{if(this.Mouse=this.getMapMousePos(n),this.MouseDown||(this.MouseDown=this.getMapMousePos(n)),this.Mouse.button===0&&Math.floor(this.Mouse.x/32/this._scale)===Math.floor(this.MouseDown.x/32/this._scale)&&Math.floor(this.Mouse.y/32/this._scale)===Math.floor(this.MouseDown.y/32/this._scale)){let r=this.Mouse.x,a=this.Mouse.y,o=this.findActiveRoomByCoords(r,a);(!this.selected||o&&o.num!==this.selected.num)&&(this.selected=o)}this.MouseDrag.state=!1,this.drag=!1,this._canvas.style.cursor="default;"}),this._canvas.addEventListener("wheel",n=>{n.deltaY>=0?this.scale-=5:this.scale+=5},{passive:!0}),this._canvas.addEventListener("mouseenter",n=>{this.Mouse=this.getMapMousePos(n)}),this._canvas.addEventListener("mouseleave",n=>{this.Mouse=this.getMapMousePos(n),this.drag&&(this.doUpdate(1),this.drag=!1,$(this._canvas).css("cursor","default"))}),this._canvas.addEventListener("contextmenu",n=>{n.preventDefault();let r=this.getMapMousePos(n);return this.emit("context-menu",this.findActiveRoomByCoords(r.x,r.y).clone()),!1}),this._canvas.addEventListener("click",n=>{n.preventDefault(),this.MouseDrag.state=!1,this.drag=!1,$(this._canvas).css("cursor","default")}),this._canvas.addEventListener("dblclick",n=>{n.preventDefault(),this.Mouse=this.getMapMousePos(n),this.MouseDown=this.getMapMousePos(n),this.MouseDrag.state=!0,this.drag=!0,$(this._canvas).css("cursor","move")}),this._canvas.onselectstart=()=>!1,this._canvas.addEventListener("focus",n=>{this.setFocus(!0)}),this._canvas.addEventListener("blur",n=>{this.setFocus(!1)}),this._canvas.addEventListener("keydown",n=>{if(this.$focused)switch(n.which){case 27:n.preventDefault(),this.MouseDrag.state=!1,this.drag=!1,$(this._canvas).css("cursor","default");break;case 38:n.preventDefault(),this.scrollBy(0,-1);break;case 40:n.preventDefault(),this.scrollBy(0,1);break;case 37:n.preventDefault(),this.scrollBy(-1,0);break;case 39:n.preventDefault(),this.scrollBy(1,0);break;case 110:case 46:n.preventDefault(),this.emit("delete-selected");break;case 97:n.preventDefault(),this.scrollBy(-1,1);break;case 98:n.preventDefault(),this.scrollBy(0,1);break;case 99:n.preventDefault(),this.scrollBy(1,1);break;case 100:n.preventDefault(),this.scrollBy(-1,0);break;case 101:n.preventDefault(),this.focusCurrentRoom();break;case 102:n.preventDefault(),this.scrollBy(1,0);break;case 103:n.preventDefault(),this.scrollBy(-1,-1);break;case 104:n.preventDefault(),this.scrollBy(0,-1);break;case 105:n.preventDefault(),this.scrollBy(1,-1);break;case 107:n.preventDefault(),this.setLevel(this.active.z+1);break;case 109:n.preventDefault(),this.setLevel(this.active.z-1);break;case 111:n.preventDefault(),this.setZone(this.active.zone-1);break;case 106:n.preventDefault(),this.setZone(this.active.zone+1);break}}),this._map=e.map,this.reset(),this.refresh()}get showNavigation(){return this._showNav}set showNavigation(t){t!==this._showNav&&(this._showNav=t,this._container.querySelectorAll(".MapperNavButton").forEach(e=>{e.style.display=this._showNav?"":"none"}),this._canvas.style.top=this._showNav?"":"0",this._canvas.style.left=this._showNav?"":"0",this._canvas.style.right=this._showNav?"":"0",this._canvas.style.bottom=this._showNav?"":"0",this._resizeCanvas())}get selected(){return this._selected}set selected(t){this.emit("room-before-selected",this._selected?this._selected.clone():null),this._selected=t.clone(),this.emit("room-selected",t.clone()),this.doUpdate(1)}get container(){return this._container}set scale(t){t<25&&(t=25),t>300&&(t=300),this._scale!==t&&(this._scale=t/100,this.emit("setting-changed","scale",t),this.$drawCache=0,this.doUpdate(1))}get scale(){return Math.round(this._scale*100)}set enabled(t){this._enabled!==t&&(this._enabled=t,this.emit("setting-changed","enabled",t))}get enabled(){return this._enabled}set follow(t){this._follow!==t&&(this._follow=t,this.emit("setting-changed","follow",t))}get follow(){return this._follow}set showLegend(t){this._showLegend!==t&&(this._showLegend=t,this.$drawCache=0,this.doUpdate(1),this.emit("setting-changed","legend",t))}get showLegend(){return this._showLegend}set splitArea(t){this._splitArea!==t&&(this._splitArea=t,this.$drawCache=0,this.doUpdate(1),this.emit("setting-changed","split",t))}get splitArea(){return this._splitArea}set fillWalls(t){this._fillWalls!==t&&(this._fillWalls=t,this.$drawCache=0,this.doUpdate(1),this.emit("setting-changed","fill",t))}get fillWalls(){return this._fillWalls}getMapMousePos(t){let e=this._canvas.getBoundingClientRect();return t.touches&&t.touches.length?{x:t.touches[0].clientX-e.left,y:t.touches[0].clientY-e.top,button:0,state:!1}:{x:t.clientX-e.left,y:t.clientY-e.top,button:t.button,state:!1}}scrollBy(t,e){this.vscroll+=t,this.hscroll+=e,this.doUpdate(1),this.emit("setting-changed","vscroll",this.vscroll),this.emit("setting-changed","hscroll",this.hscroll)}scrollTo(t,e){this.vscroll=t,this.hscroll=e,this.doUpdate(1),this.emit("setting-changed","vscroll",this.vscroll),this.emit("setting-changed","hscroll",this.hscroll)}findActiveRoomByCoords(t,e){let s=this.vscroll-this._canvas.width/32/2/this._scale,n=this.hscroll-this._canvas.height/32/2/this._scale,r=15.5*this._scale,a=15.5*this._scale;return this._canvas.width%2!==0&&(r=15*this._scale),this._canvas.height%2!==0&&(a=15*this._scale),s+=(t-r)/32/this._scale,n+=(e-a)/32/this._scale,s=Math.floor(s),n=Math.floor(n),this._splitArea?this.map.getRoom({x:s,y:n,z:this.active.z,zone:this.active.zone,area:this.active.area})||new xe:this.map.getRoom({x:s,y:n,z:this.active.z,zone:this.active.zone})||new xe}draw(t,e,s){return new Promise((n,r)=>{if(t||(t=this._canvas),e||(e=this._context),s||(s=!1),!t||!e||!this._map){r();return}let a=this.vscroll-t.width/32/2/this._scale,o=this.hscroll-t.height/32/2/this._scale,h=this.active.z||0,c=this.active.area||"",g=this.active.zone||0,f=15.5*this._scale,w=15.5*this._scale;t.width%2!==0&&(f=15*this._scale),t.height%2!==0&&(w=15*this._scale),e.font="8pt Arial";let p=new Date().getTime(),k=t.width/32/this._scale+1,E=t.height/32/this._scale+1,b=a-1,v=o-1,M=Object.values(this._map.Rooms).filter(I=>I.zone!==g||I.z!==h||this._splitArea&&I.area!==c?!1:0<=I.x-b&&I.x-b<=k&&0<=I.y-v&&I.y-v<=E||0<=I.x-b&&I.x-b<=k&&0<=I.y-v+1&&I.y-v+1<=E||0<=I.x-b+1&&I.x-b+1<=k&&0<=I.y-v+1&&I.y-v+1<=E||0<=I.x-b+1&&I.x-b+1<=k&&0<=I.y-v&&I.y-v<=E);this.emit("debug","Mapper: Draw - room query time: "+(new Date().getTime()-p));let B=new Date().getTime();s?(e.fillStyle="#eae4d6",e.fillRect(0,0,t.width,t.height)):e.clearRect(0,0,t.width,t.height),this.emit("debug","Mapper: Draw - room calculations time: "+(new Date().getTime()-p));for(let I=0,_=M.length;I<_;I++){let C=M[I];this.DrawRoom(e,(C.x-a)*32*this._scale+f,(C.y-o)*32*this._scale+w,C,s,this._scale)}this.emit("debug","Mapper: Draw - display time: "+(new Date().getTime()-B)),this.emit("debug","Mapper: Draw - final time: "+(new Date().getTime()-p)),this.DrawLegend(e,1,-4,0),n(!0)})}reset(t){this._map&&(!t||t===1)&&(this._map.current=new xe,this.emit("current-changed",this._map.current)),t||(this.active=new xe,this.selected=new xe)}refresh(){this.$drawCache=0,this.doUpdate(1),this.emit("refresh")}focusCurrentRoom(){this._map.current.num&&(this.active=this._map.current,this.emit("active-room-changed",this.active.clone())),this.focusActiveRoom()}focusActiveRoom(){this.scrollTo(this.active.x+1,this.active.y+1)}set active(t){this._active=t&&t.clone?t.clone():t,this.emit("active-room-changed",this._active)}get active(){return this._active}get current(){return this._map.current}set current(t){this.emit("path-cleared"),(!t||!t.num)&&(t=this.selected),this._map.current=t.clone(),this.markers={},this.markedRooms=0}setArea(t){if(this.active.area=t,this._map.current.num!==null&&this._map.current.area===this.active.area)this.active=this._map.current,this.focusActiveRoom(),this.emit("setting-changed","active",this.active);else{let e=this._map.getRoom({area:t});e&&(this.active=e,this.focusActiveRoom(),this.emit("setting-changed","active",this.active))}}setLevel(t){t!==this.active.z&&(this.active.z=t,this.doUpdate(1),this.emit("setting-changed","active",this.active))}setZone(t){t!==this.active.zone&&(this.active.zone=t,this.doUpdate(1),this.emit("setting-changed","active",this.active))}removeRoom(t){this._map.roomExists({num:t.num})&&(this._map.removeRoom(t),this.emit("remove-done",t),t.num===this._map.current.num?(this._map.current=new xe,this.emit("current-changed",this._map.current),this.clearPath()):this.markers[t.num]&&this.clearPath(),t.num===this.active.num&&(this.active=new xe),t.num===this.selected.num&&(this.selected=new xe),this.refresh())}clearSelectedRoom(){let t={preventDefault:!1};this.emit("clear-selected",t),!t.preventDefault&&this.removeRoom(this.selected)}clearCurrentRoom(){let t={preventDefault:!1};this.emit("clear-current",t),!t.preventDefault&&this.removeRoom(this._map.current)}clearArea(){let t={preventDefault:!1};this.emit("clear-area",t),!t.preventDefault&&(this._map.removeRooms({area:this.active.area}),this.emit("clear-area-done",this.active.area),this.reset(),this.refresh())}clearAll(){let t={preventDefault:!1};this.emit("clear-all",t),!t.preventDefault&&(this._map.removeAllRooms(),this.emit("clear-done"),this.reset(),this.refresh(),this.focusActiveRoom())}set map(t){this._map=t,t.on("current-changed",e=>{this.clearPath(),this.emit("current-changed",this._map.current),this.selected&&this.selected.num===e.num&&this.emit("room-selected",e.clone()),this.follow?this.focusCurrentRoom():this.active=e,this.refresh()}),t.on("before-room-changed",e=>{e&&delete this.$drawCache[(e.background?e.background:e.env)+","+e.indoors+","+e.exitsID+","+e.details]}),t.on("room-changed",e=>{this.selected&&this.selected.num===e.num&&(this.selected=e),this.follow?this.focusCurrentRoom():this.active=this.current,this.refresh()}),t.on("rooms-changed",e=>{if(this.selected&&this.selected.num){let s=e.findIndex(n=>n.num===this.selected.num);s!==-1&&(this.selected=e[s])}this.follow?this.focusCurrentRoom():this.active=this.current,this.refresh()}),this.refresh()}get map(){return this._map}set rooms(t){this._map.Rooms=t}get rooms(){return this._map.Rooms}roomExists(t,e,s,n,r){return r?this._map.roomExists({x:t,y:e,z:s,zone:n||0,area:r}):this._map.roomExists({x:t,y:e,z:s,zone:n||0})}setRoom(t){this._map.setRoom(t)}DrawLegend(t,e,s,n){this._showLegend&&(t.strokeStyle="black",n||(t.fillStyle="#eae4d6",t.fillRect(e+30,s+35,130,175)),t.fillStyle="black",t.strokeRect(e+30,s+35,130,175),t.font="italic bold 8pt Georgia",t.fillText("Dock",e+50,s+50),t.fillStyle="chocolate",t.beginPath(),t.arc(e+40,s+45,2,0,Math.PI*2),t.fill(),t.closePath(),t.fillStyle="black",t.fillText("Pier",e+50,s+65),t.fillStyle="gray",t.beginPath(),t.arc(e+40,s+60,2,0,Math.PI*2),t.fill(),t.closePath(),t.fillStyle="black",t.fillText("Water Source",e+50,s+80),t.fillStyle="aqua",t.beginPath(),t.arc(e+40,s+75,2,0,Math.PI*2),t.fill(),t.closePath(),t.fillStyle="black",t.fillText("Bank",e+50,s+95),t.font="8pt Arial",t.fillStyle="goldenrod",t.beginPath(),t.fillText("$",e+38,s+95),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Shop",e+50,s+110),t.font="8pt Arial",t.fillStyle="purple",t.beginPath(),t.fillText("\u23CF",e+38,s+110),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Hospital",e+50,s+125),t.font="8pt Arial",t.fillStyle="blue",t.beginPath(),t.fillText("\u2665",e+38,s+125),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Bar & Restaurant",e+50,s+140),t.font="8pt Arial",t.fillStyle="green",t.beginPath(),t.fillText("\u2617",e+38,s+140),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Bar",e+50,s+155),t.font="8pt Arial",t.fillStyle="green",t.beginPath(),t.fillText("\u266A",e+38,s+155),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Restaurant",e+50,s+170),t.font="8pt Arial",t.fillStyle="green",t.beginPath(),t.fillText("\u2616",e+38,s+170),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Train",e+50,s+185),t.font="8pt Arial",t.fillStyle="red",t.beginPath(),t.fillText("\u260D",e+38,s+185),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Stable",e+50,s+200),t.font="8pt Arial",t.fillStyle="rgb(153, 102, 0)",t.beginPath(),t.fillText("\u2658",e+38,s+200),t.closePath())}translate(t,e,s){if(s===2)return;let n=e-e*s;t.translate(e*s+n,e*s+n)}DrawRoom(t,e,s,n,r,a){this.$drawCache||(this.$drawCache={}),a||(a=this._scale);let o=(n.background?n.background:n.env)+","+n.indoors+","+n.exitsID+","+n.details;if(!this.$drawCache[o]){this.$drawCache[o]=document.createElement("canvas"),this.$drawCache[o].classList.add("map-canvas"),this.$drawCache[o].height=32*a,this.$drawCache[o].width=32*a;let h=this.$drawCache[o].getContext("2d");this.translate(h,.5,a),h.beginPath();let c=!1;if(n.background)h.fillStyle=n.background,c=!0;else if(n.env)switch(n.env){case"wood":h.fillStyle="#966F33",c=!0;break;case"jungle":h.fillStyle="#347C2C",c=!0;break;case"forest":h.fillStyle="#4E9258",c=!0;break;case"grass":case"grassland":case"plains":case"prairie":case"savannah":h.fillStyle="#4AA02C",c=!0;break;case"desert":case"dirt":case"dirtroad":case"beach":case"sand":case"sanddesert":h.fillStyle="#C2B280",c=!0;break;case"snow":h.fillStyle="#F0F8FF",c=!0;break;case"tundra":case"icesheet":h.fillStyle="#368BC1",c=!0;break;case"underwater":case"water":case"lake":case"river":h.fillStyle="#EBF4FA",c=!0;break;case"ocean":h.fillStyle="#C2DFFF",c=!0;break;case"bog":case"city":case"cliff":case"highmountain":case"hills":case"mountain":case"swamp":c=!1;break;case"farmland":c=!0,h.fillStyle="#A9DFBF";break;case"rockdesert":h.fillStyle="#6E2C00",c=!0;break;case"pavedroad":h.fillStyle="#D0D3D4",c=!0;break;case"cobble":case"rocky":case"stone":h.fillStyle="#D5DBDB",c=!0;break;default:c=!1;break}else c=!1;h.strokeStyle="black",h.lineWidth=.6*a,n.indoors?(c&&h.fillRect(8*a,8*a,16*a,16*a),h.strokeRect(8*a,8*a,16*a,16*a)):(h.arc(16*a,16*a,8*a,0,Math.PI*2,!1),c&&h.fill(),h.stroke()),h.closePath(),h.beginPath(),h.fillStyle="#cccccc",n.exits.north?(h.moveTo(16*a,0*a),h.lineTo(16*a,8*a)):this._fillWalls&&h.fillRect(9*a,0*a,14*a,4*a),n.exits.northwest?n.Indoors?(h.moveTo(0*a,0*a),h.lineTo(8*a,8*a)):(h.moveTo(0*a,0*a),h.lineTo(10*a,10*a)):this._fillWalls&&(h.fillRect(2*a,0*a,2*a,2*a),h.fillRect(0*a,2*a,4*a,2*a),n.exits.north||h.fillRect(4*a,0*a,5*a,4*a),n.exits.west||h.fillRect(0*a,4*a,4*a,5*a)),n.exits.northeast?n.Indoors?(h.moveTo(32*a,0*a),h.lineTo(24*a,8*a)):(h.moveTo(32*a,0*a),h.lineTo(22*a,10*a)):this._fillWalls&&(h.fillRect(28*a,0*a,2*a,2*a),h.fillRect(28*a,2*a,4*a,2*a),h.clearRect(30*a,0*a,2*a,2*a),n.exits.north||h.fillRect(23*a,0*a,5*a,4*a),n.exits.east||h.fillRect(28*a,4*a,4*a,5*a)),n.exits.east?(h.moveTo(24*a,16*a),h.lineTo(32*a,16*a)):this._fillWalls&&h.fillRect(28*a,9*a,4*a,14*a),n.exits.west?(h.moveTo(0*a,16*a),h.lineTo(8*a,16*a)):this._fillWalls&&h.fillRect(0*a,9*a,4*a,14*a),n.exits.south?(h.moveTo(16*a,24*a),h.lineTo(16*a,32*a)):this._fillWalls&&h.fillRect(9*a,28*a,14*a,4*a),n.exits.southeast?n.Indoors?(h.moveTo(32*a,32*a),h.lineTo(24*a,24*a)):(h.moveTo(32*a,32*a),h.lineTo(22*a,22*a)):this._fillWalls&&(h.fillRect(28*a,28*a,4*a,2*a),h.fillRect(28*a,30*a,2*a,2*a),n.exits.south||h.fillRect(23*a,28*a,5*a,4*a),n.exits.east||h.fillRect(28*a,23*a,4*a,5*a)),n.exits.southwest?n.Indoors?(h.moveTo(0*a,32*a),h.lineTo(8*a,24*a)):(h.moveTo(0*a,32*a),h.lineTo(10*a,22*a)):this._fillWalls&&(h.fillRect(0*a,28*a,4*a,2*a),h.fillRect(2*a,30*a,2*a,2*a),n.exits.south||h.fillRect(4*a,28*a,5*a,4*a),n.exits.west||h.fillRect(0*a,23*a,4*a,5*a)),h.closePath(),h.stroke(),h.fillStyle="black",h.strokeStyle="black",n.exits.up&&(h.beginPath(),h.moveTo(1*a,11*a),h.lineTo(7*a,11*a),h.lineTo(4*a,8*a),h.closePath(),h.fill()),n.exits.down&&(h.beginPath(),h.moveTo(1*a,21*a),h.lineTo(7*a,21*a),h.lineTo(4*a,24*a),h.closePath(),h.fill()),n.exits.out&&(h.beginPath(),h.moveTo(26*a,8*a),h.lineTo(29*a,11*a),h.lineTo(26*a,14*a),h.closePath(),h.fill()),n.exits.enter&&(h.beginPath(),h.moveTo(29*a,19*a),h.lineTo(26*a,22*a),h.lineTo(29*a,25*a),h.closePath(),h.fill()),(n.details&1)===1?(h.fillStyle="chocolate",h.beginPath(),h.arc(20*a,5*a,2*a,0,Math.PI*2),h.fill(),h.closePath()):(n.details&2)===2&&(h.fillStyle="gray",h.beginPath(),h.arc(12*a,5*a,2*a,0,Math.PI*2),h.fill(),h.closePath()),(n.details&128)===128&&(h.fillStyle="aqua",h.beginPath(),h.arc(12*a,5*a,2*a,0,Math.PI*2),h.fill(),h.closePath()),h.scale(a,a),(n.details&4)===4&&(h.fillStyle="goldenrod",h.beginPath(),h.fillText("$",9,17),h.closePath()),(n.details&8)===8&&(h.fillStyle="purple",h.beginPath(),h.fillText("\u23CF",15,17),h.closePath()),(n.details&16)===16&&(h.fillStyle="blue",h.beginPath(),h.fillText("\u2665",15,17),h.closePath()),(n.details&256)===256&&(h.fillStyle="red",h.beginPath(),h.fillText("\u260D",15,17),h.closePath()),(n.details&512)===512&&(h.fillStyle="rgb(153, 102, 0)",h.beginPath(),h.fillText("\u2658",7,17),h.closePath()),(n.details&64)===64&&(n.details&32)===32?(h.fillStyle="green",h.beginPath(),h.fillText("\u2617",15,17),h.closePath()):(n.details&32)===32?(h.fillStyle="green",h.beginPath(),h.fillText("\u266A",15,17),h.closePath()):(n.details&64)===64&&(h.fillStyle="green",h.beginPath(),h.fillText("\u2616",15,17),h.closePath()),h.setTransform(1,0,0,1,0,0),this.translate(h,-.5,a)}t.drawImage(this.$drawCache[o],e|0,s|0),this.DrawDoor(t,e+12*a,s-2*a,8*a,3*a,n.exits.north),this.DrawDoor(t,e+31*a,s+12*a,3*a,8*a,n.exits.east),this.DrawDoor(t,e-1*a,s+12*a,3*a,8*a,n.exits.west),this.DrawDoor(t,e+12*a,s+30*a,8*a,3*a,n.exits.south),this.DrawDDoor(t,e,s,5*a,5*a,n.exits.northwest),this.DrawDDoor(t,e+32*a,s,-5*a,5*a,n.exits.northeast),this.DrawDDoor(t,e+32*a,s+32*a,-5*a,-5*a,n.exits.southeast),this.DrawDDoor(t,e,s+32*a,5*a,-5*a,n.exits.southwest),!r&&this.selected.num===n.num&&(this.$focused?(t.fillStyle="rgba(135, 206, 250, 0.5)",t.strokeStyle="LightSkyBlue"):(t.fillStyle="rgba(142, 142, 142, 0.5)",t.strokeStyle="rgba(142, 142, 142, 0.5)"),t.fillRoundedRect(e,s,32*a,32*a,8*a),t.strokeRoundedRect(e,s,32*a,32*a,8*a)),this.markers[n.num]===2?this.drawMarker(t,e,s,"green",a):this.markers[n.num]===3?this.drawMarker(t,e,s,"blue",a):this.markers[n.num]&&this.drawMarker(t,e,s,"yellow",a),!r&&n.num===this._map.current.num&&this.drawMarker(t,e,s,"red",a)}drawMarker(t,e,s,n,r){n||(n="yellow"),t.beginPath(),t.fillStyle=n,t.strokeStyle="black",t.arc(e+16*r,s+16*r,4*r,0,Math.PI*2),t.fill(),t.closePath()}DrawDoor(t,e,s,n,r,a){!a||!a.isdoor||(t.beginPath(),t.clearRect(e,s,n,r),t.fillStyle="black",t.strokeStyle="black",a.isclosed?t.fillRect(e,s,n,r):t.strokeRect(e,s,n,r),t.closePath())}DrawDDoor(t,e,s,n,r,a){!a||!a.isdoor||(t.beginPath(),t.fillStyle="black",t.strokeStyle="black",t.moveTo(e,s),t.lineTo(e+n,s),t.lineTo(e,s+r),t.lineTo(e,s),a.isclosed?t.fill():t.stroke(),t.closePath())}PointInRect(t,e,s,n,r,a){return s<=t&&t<=n&&r<=e&&e<=a}getRoom(t){return this._map.Rooms[t]}getRooms(t){return t?this._map.getRooms(t):Object.values(this._map.Rooms)}showPath(t){if((!t||!t.num)&&(t=this.selected),this._map.current.num==null||t.num==null||this._splitArea&&this._map.current.area!==t.area||this._map.current.zone!==t.zone)return;let e;this._splitArea?e=this.getRooms({area:this._map.current.area,zone:this._map.current.zone}):e=this.getRooms({zone:this._map.current.zone});let s,n,r=[],a=null,o=0,h=0,c=0,g=0,f=0,w,p,k,E,b,v,M,B;for(n in e)if(e.hasOwnProperty(n)){if(s=e[n],a==null){a=s.x,c=s.x+1,o=s.y,g=s.y+1,h=s.z,f=s.z+1;continue}s.x<a?a=s.x:s.x>c&&(c=s.x),s.y<o?o=s.y:s.y>g&&(g=s.y),s.z<h?h=s.z:s.z>f&&(f=s.z)}for(n in e)e.hasOwnProperty(n)&&(s=e[n],s!=null&&(r[s.y-o]||(r[s.y-o]=[]),r[s.y-o][s.x-a]||(r[s.y-o][s.x-a]=[]),r[s.y-o][s.x-a][s.z-h]=s));c=Math.sqrt(Math.pow(c-a,2))+1,g=Math.sqrt(Math.pow(o-g,2))+1,f=Math.sqrt(Math.pow(h-f,2))+1;let I=[];for(E=0;E<g;E++)for(I[E]=[],k=0;k<c;k++)for(I[E][k]=[],b=0;b<f;b++)I[E][k][b]=0;for(n in e)e.hasOwnProperty(n)&&(s=e[n],k=s.x-a,E=s.y-o,b=s.z-h,s.exits.northwest&&(I[E][k][b]|=1),s.exits.north&&(I[E][k][b]|=128),s.exits.northeast&&(I[E][k][b]|=64),s.exits.west&&(I[E][k][b]|=2),s.exits.east&&(I[E][k][b]|=32),s.exits.southwest&&(I[E][k][b]|=4),s.exits.south&&(I[E][k][b]|=8),s.exits.southeast&&(I[E][k][b]|=16),s.exits.up&&(I[E][k][b]|=512),s.exits.down&&(I[E][k][b]|=256));let _=new yt.Grid(c,g,f,I),C=new yt.AStarFinder({allowDiagonal:!0,dontCrossCorners:!1});k=this._map.current.x-a,E=this._map.current.y-o,b=this._map.current.z-h,v=t.x-a,M=t.y-o,B=t.z-h;let L=C.findPath(k,E,b,v,M,B,_);for(p=L.length,this.markers={},this.markedRooms=[this._map.current,t],w=0;w<p;w++)k=Math.floor(L[w][0]),E=Math.floor(L[w][1]),b=Math.floor(L[w][2]),r[E]&&r[E][k]&&r[E][k][b]&&(r[E][k][b].num===this._map.current.num?this.markers[r[E][k][b].num]=2:r[E][k][b].num===t.num?this.markers[r[E][k][b].num]=3:this.markers[r[E][k][b].num]=1);this.emit("path-shown"),this.doUpdate(1)}clearPath(){this.emit("path-cleared"),this.markers={},this.markedRooms=0,this.doUpdate(1)}get hasMarked(){return this.markedRooms&&this.markedRooms.length!==0}get markedStart(){return this.markedRooms?this.markedRooms[0]:0}get markedEnd(){return this.markedRooms?this.markedRooms[1]:0}getMarkedPath(){return new Promise((t,e)=>{this.markedRooms?this.getPath(this.markedRooms[1],this.markedRooms[0]).then(t).catch(e):this.getPath().then(t).catch(e)})}getPath(t,e){return new Promise((s,n)=>{if((!t||!t.num)&&(t=this.selected),(!e||!e.num)&&(e=this._map.current),e.num==null||t.num==null){n("Invalid start or end room.");return}if(this._splitArea&&e.area!==t.area){n("Start and end rooms must be in same the area.");return}if(e.zone!==t.zone){n("Start and end rooms must be in the same zone.");return}let r;this._splitArea?r=this.getRooms({area:e.area,zone:e.zone}):r=this.getRooms({zone:e.zone});let a,o,h=null,c=0,g=0,f=0,w=0,p=0,k,E,b,v,M,B,I,_,C,L,R;for(o in r)if(r.hasOwnProperty(o)){if(a=r[o],h==null){h=a.x,f=a.x+1,c=a.y,w=a.y+1,g=a.z,p=a.z+1;continue}a.x<h?h=a.x:a.x>f&&(f=a.x),a.y<c?c=a.y:a.y>w&&(w=a.y),a.z<g?g=a.z:a.z>p&&(p=a.z)}f=Math.sqrt(Math.pow(f-h,2))+1,w=Math.sqrt(Math.pow(c-w,2))+1,p=Math.sqrt(Math.pow(g-p,2))+1;let S=[];for(v=0;v<w;v++)for(S[v]=[],b=0;b<f;b++)for(S[v][b]=[],M=0;M<p;M++)S[v][b][M]=0;for(o in r)r.hasOwnProperty(o)&&(a=r[o],b=a.x-h,v=a.y-c,M=a.z-g,a.exits.northwest&&(S[v][b][M]|=1),a.exits.north&&(S[v][b][M]|=128),a.exits.northeast&&(S[v][b][M]|=64),a.exits.west&&(S[v][b][M]|=2),a.exits.east&&(S[v][b][M]|=32),a.exits.southwest&&(S[v][b][M]|=4),a.exits.south&&(S[v][b][M]|=8),a.exits.southeast&&(S[v][b][M]|=16),a.exits.up&&(S[v][b][M]|=512),a.exits.down&&(S[v][b][M]|=256));let P=new yt.Grid(f,w,p,S),X=new yt.AStarFinder({allowDiagonal:!0,dontCrossCorners:!1});b=e.x-h,v=e.y-c,M=e.z-g,B=t.x-h,I=t.y-c,_=t.z-g;let J=X.findPath(b,v,M,B,I,_,P);E=J.length;let G=[];for(k=0;k<E-1;k++)b=Math.floor(J[k][0]),v=Math.floor(J[k][1]),M=Math.floor(J[k][2]),C=Math.floor(J[k+1][0]),L=Math.floor(J[k+1][1]),R=Math.floor(J[k+1][2]),M-1===R?G.push("down"):M+1===R?G.push("up"):b-1===C&&v-1===L?G.push("northwest"):b===C&&v-1===L?G.push("north"):b+1===C&&v-1===L?G.push("northeast"):b-1===C&&v+1===L?G.push("southwest"):b===C&&v+1===L?G.push("south"):b+1===C&&v+1===L?G.push("southeast"):b-1===C&&v===L?G.push("west"):G.push("east");s(G)})}walkPath(t,e){this.getPath(t,e).then(s=>{this.SendCommands(s)}).catch(()=>{})}walkMarkedPath(){let t=this.markedRooms?this.markedRooms[1]:0,e=this.markedRooms?this.markedRooms[0]:0;return new Promise((s,n)=>{this.getPath(t,e).then(r=>{this.SendCommands(r)}).catch(()=>{})})}SendCommands(t){let e,s=this.commandDelayCount;s<0&&(s=1),t.length>s&&(e=t.slice(s),t=t.slice(0,s),setTimeout(()=>{this.SendCommands(e)},this.commandDelay)),this.emit("send-commands",t.join(`
`)+`
`)}doUpdate(t){t&&(this._updating|=t,!(this._updating===0||this._rTimeout)&&(this._rTimeout=window.requestAnimationFrame(()=>{(this._updating&1)===1&&(this.draw().catch(()=>{}),this._updating&=-2),this._rTimeout=0,this.doUpdate(this._updating)})))}setFocus(t){this.$focused!==t&&(this.$focused=t,this.doUpdate(1))}updateOptions(t){if(t)for(let e in t)Object.prototype.hasOwnProperty.call(t,e)&&e in this&&(this[e]=t[e])}_resizeCanvas(){if(!this._context||this.container.clientHeight===0||this.container.clientWidth===0)return;let t=document.createElement("canvas");if(t.width=this._canvas.width,t.height=this._canvas.height,t.getContext("2d").drawImage(this._canvas,0,0),this._showNav)this._canvas.width=this.container.clientWidth-60,this._canvas.height=this.container.clientHeight-60;else{let s=window.getComputedStyle(this._canvas),n=parseFloat(s.borderLeftWidth),r=parseFloat(s.borderRightWidth),a=parseFloat(s.borderTopWidth),o=parseFloat(s.borderBottomWidth);this._canvas.width=this.container.clientWidth-n-r,this._canvas.height=this.container.clientHeight-a-o}this._context.drawImage(t,0,0),this.doUpdate(1)}mapperNavClick(t,e){this._mapperNavDown&&(this.scrollBy(t,e),setTimeout(()=>{this.mapperNavClick(t,e)},100))}copyPath(t){t=t||client.getOption("commandStackingChar")||";",this.getPath().then(e=>{Oe(e.join(t||`
`)),this.emit("debug","Directions: "+e)}).catch(e=>this.emit("error",e))}copyMarkedPath(t){t=t||client.getOption("commandStackingChar")||";",this.getMarkedPath().then(e=>{Oe(e.join(t||`
`)),this.emit("debug","Directions: "+e)}).catch(e=>this.emit("error",e))}copySpeedpath(){this.getPath().then(t=>{let e=0,s="",n=[client.getOption("speedpathsChar")||"!"],r=t.length;for(let a=0;a<r;a++)s.length&&s!==t[a]&&(n.push(e),n.push(s),e=0),e++,s=t[a];n.push(e),n.push(s),Oe(n.join("")),this.emit("debug","Speedpath: "+n)}).catch(t=>this.emit("error",t))}copyMarkedSpeedpath(){this.getMarkedPath().then(t=>{let e=0,s="",n=[client.getOption("speedpathsChar")||"!"],r=t.length;for(let a=0;a<r;a++)s.length&&s!==t[a]&&(n.push(e),n.push(s),e=0),e++,s=t[a];n.push(e),n.push(s),Oe(n.join("")),this.emit("debug","Speedpath: "+n)}).catch(t=>this.emit("error",t))}exportImage(t){let e=this.getRooms({area:this.active.area,z:this.active.z,zone:this.active.zone}),s=null,n=0,r=0,a=0,o,h=e.length,c,g,f,w=this.active.area===null||!this._splitArea?"":this.active.area,p=t?this._scale:1;for(o=0;o<h;o++)if(c=e[o],c!==null){if(s===null){s=c.x,r=c.x+1,n=c.y,a=c.y+1;continue}c.x<s?s=c.x:c.x>r&&(r=c.x),c.y<n?n=c.y:c.y>a&&(a=c.y)}this._context.font="italic bold 16pt Georgia";var k=this._context.measureText(w).width,E=Math.ceil(Math.sqrt(Math.pow(r-s,2))*32*p+60+32),b=Math.ceil(Math.sqrt(Math.pow(n-a,2))*32*p+60+32);E<k&&(E=k+60),this._showLegend&&(E+=155,b<200&&(b=200));let v=document.createElement("canvas");v.id="mapper-export",v.style.height=b+"px",v.style.width=E+"px",v.width=E,v.height=b;var M;if(v&&v.getContext)M=v.getContext("2d");else{this.emit("error","Mapper image export: Error generating map!");return}for(M.strokeStyle="black",M.fillStyle="#eae4d6",M.fillRect(0,0,v.width,v.height),M.font="8pt Arial",o=0;o<h;o++)c=e[o],c!==null&&(g=(c.x-s)*32*p+30.5,f=(c.y-n)*32*p+30.5,this.DrawRoom(M,g,f,c,!0,p));M.save(),M.strokeStyle="black",M.fillStyle="black",M.font="italic bold 16pt Georgia",k=E/2-k/2,M.fillText(w,k,20),M.translate(E-25,b-25),M.font="italic bold 12pt Georgia",M.fillText("N",3,-5),M.beginPath(),M.moveTo(10,0),M.lineTo(5,15),M.lineTo(10,20),M.lineTo(15,15),M.lineTo(10,0),M.closePath(),M.fill(),M.stroke(),M.restore(),this.DrawLegend(M,E-185,-10,1),v.toBlob(B=>{var I=new FileReader;I.addEventListener("loadend",_=>{fileSaveAs.show(_.target.result,this._splitArea&&w.length?"OoMUD."+w+".png":"OoMUD.png","image/png")}),I.readAsArrayBuffer(B)})}exportCurrentImage(){var t=document.createElement("canvas"),e=t.getContext("2d");t.width=this._canvas.width,t.height=this._canvas.height,this.draw(t,e,!0).then(()=>{t.toBlob(s=>{var n=new FileReader;n.addEventListener("loadend",r=>{fileSaveAs.show(r.target.result,"OoMUD.current.png","image/png")}),n.readAsArrayBuffer(s)})})}exportArea(){fileSaveAs.show(JSON.stringify(this.getRooms({area:this.active.area})),this._splitArea?"OoMUD."+this.active.area+".map.txt":"OoMUD.map.txt","text/plain")}exportAll(){fileSaveAs.show(JSON.stringify(this.map.Rooms),"OoMUD.map.txt","text/plain")}};var vt=(a=>(a[a.None=0]="None",a[a.Ok=1]="Ok",a[a.Cancel=2]="Cancel",a[a.Yes=4]="Yes",a[a.No=8]="No",a[a.YesNo=12]="YesNo",a[a.Standard=3]="Standard",a))(vt||{});var ve=class extends pe{constructor(t){super();this._state={x:0,y:0,height:0,width:0,zIndex:100,maximized:!1,show:0};this._resize={x:0,y:0,height:0,width:0,type:0,minHeight:150,minWidth:300,borderHeight:1,borderWidth:1};this._dragPosition={x:0,y:0};this._windowResize=()=>{fe(()=>{this.keepCentered||this._state.show===2&&!this.moveable?this.center():this.makeVisible(),this._footer.style.display!=="none"&&(this._body.style.bottom=this._footer.clientHeight+1+"px"),this.emit("resizing")},250,this._id+"dialogResize")};this.resizeDoDrag=t=>{let e;if((this._resize.type&1)===1&&(e=this._resize.width+t.clientX-this._resize.x,e>window.innerWidth&&(e=window.innerWidth),this._dialog.style.width=e+"px"),(this._resize.type&2)===2&&(e=this._resize.height+t.clientY-this._resize.y,e>window.innerWidth-16&&(e=window.innerHeight-16),this._dialog.style.height=e+"px"),(this._resize.type&8)===8){if(e=this._resize.height-t.clientY+this._resize.y-this._resize.borderHeight,e+this._resize.borderHeight>window.innerHeight&&(e=window.innerHeight),e+this._resize.borderHeight<=this._resize.minHeight){this._dialog.style.height=this._resize.minHeight+"px";return}this._dialog.style.height=e+"px",e=t.clientY,e>window.innerHeight&&(e=window.innerHeight),this._dialog.style.top=e+"px"}if((this._resize.type&4)===4){if(e=this._resize.width-t.clientX+this._resize.x-this._resize.borderWidth,e+this._resize.borderWidth>window.innerWidth&&(e=window.innerWidth),e+this._resize.borderWidth<=this._resize.minWidth){this._dialog.style.width=this._resize.minWidth+"px";return}this._dialog.style.width=e+"px",e=t.clientX,e>window.innerWidth&&(e=window.innerWidth),this._dialog.style.left=e+"px"}this._footer.style.display!=="none"&&(this._body.style.bottom=this._footer.clientHeight+1+"px"),this.emit("resizing")};this.resizeTouchDrag=t=>{if(!t.touches.length)return;let e;if((this._resize.type&1)===1&&(e=this._resize.width+t.touches[0].clientX-this._resize.x,e>window.innerWidth&&(e=window.innerWidth),this._dialog.style.width=e+"px"),(this._resize.type&2)===2&&(e=this._resize.height+t.touches[0].clientY-this._resize.y,e>window.innerWidth&&(e=window.innerHeight),this._dialog.style.height=e+"px"),(this._resize.type&8)===8){if(e=this._resize.height-t.touches[0].clientY+this._resize.y-this._resize.borderHeight,e+this._resize.borderHeight>window.innerHeight&&(e=window.innerHeight),e+this._resize.borderHeight<=this._resize.minHeight){this._dialog.style.height=this._resize.minHeight+"px";return}this._dialog.style.height=e+"px",e=t.touches[0].clientY,e>window.innerHeight&&(e=window.innerHeight),this._dialog.style.top=e+"px"}if((this._resize.type&4)===4){if(e=this._resize.width-t.touches[0].clientX+this._resize.x-this._resize.borderWidth,e+this._resize.borderWidth>window.innerWidth&&(e=window.innerWidth),e+this._resize.borderWidth<=this._resize.minWidth){this._dialog.style.width=this._resize.minWidth+"px";return}this._dialog.style.width=e+"px",e=t.touches[0].clientX,e>window.innerWidth&&(e=window.innerWidth),this._dialog.style.left=e+"px"}this._footer.style.display!=="none"&&(this._body.style.bottom=this._footer.clientHeight+1+"px"),this.emit("resizing")};this.resizeStopDrag=t=>{document.documentElement.removeEventListener("mousemove",this.resizeDoDrag),document.documentElement.removeEventListener("mouseup",this.resizeStopDrag),document.documentElement.removeEventListener("touchmove",this.resizeTouchDrag),document.documentElement.removeEventListener("touchend",this.resizeStopDrag);let e=document.defaultView.getComputedStyle(this._dialog);this._state.x=parseInt(e.left,10),this._state.width=parseInt(e.width,10),this._state.y=parseInt(e.top,10),this._state.height=parseInt(e.height,10),this._body.style.pointerEvents="",this.emit("resized",this._state)};this.dragMouseDown=t=>{this.maximized||(this._dragPosition.x=t.clientX,this._dragPosition.y=t.clientY,document.documentElement.addEventListener("mouseup",this.dragMouseUp),document.documentElement.addEventListener("mousemove",this.dragMouseMove),this._header.style.cursor="move")};this.dragTouchStart=t=>{this.maximized||(this._dragPosition.x=t.clientX,this._dragPosition.y=t.clientY,document.documentElement.addEventListener("touchend",this.dragMouseUp),document.documentElement.addEventListener("touchmove",this.dragTouchMove),this._header.style.cursor="move")};this.dragMouseMove=t=>{let e=this._dragPosition.x-t.clientX,s=this._dragPosition.y-t.clientY;this._dragPosition.x=t.clientX,this._dragPosition.y=t.clientY,this._state.x=this._dialog.offsetLeft-e,this._state.y=this._dialog.offsetTop-s,this._state.x>window.innerWidth-16&&(this._state.x=window.innerWidth-16),this._state.y>window.innerHeight-16&&(this._state.y=window.innerHeight-16);let n=this._size;this._state.x<16-n.width&&(this._state.x=16-n.width),this._state.y<16-n.height&&(this._state.y=16-n.height),this._dialog.style.left=this._state.x+"px",this._dialog.style.top=this._state.y+"px"};this.dragTouchMove=t=>{if(!t.touches.length)return;let e=this._dragPosition.x-t.touches[0].clientX,s=this._dragPosition.y-t.touches[0].clientY;this._dragPosition.x=t.touches[0].clientX,this._dragPosition.y=t.touches[0].clientY,this._state.x=this._dialog.offsetLeft-e,this._state.y=this._dialog.offsetTop-s,this._state.x>window.innerWidth-16&&(this._state.x=window.innerWidth-16),this._state.y>window.innerHeight-16&&(this._state.y=window.innerHeight-16);let n=this._size;this._state.x<16-n.width&&(this._state.x=16-n.width),this._state.y<16-n.height&&(this._state.y=16-n.height),this._dialog.style.left=this._state.x+"px",this._dialog.style.top=this._state.y+"px"};this.dragMouseUp=()=>{document.documentElement.removeEventListener("mouseup",this.dragMouseUp),document.documentElement.removeEventListener("mousemove",this.dragMouseMove),document.documentElement.removeEventListener("touchend",this.dragMouseUp),document.documentElement.removeEventListener("touchmove",this.dragTouchMove),this._header.style.cursor="";let t=document.defaultView.getComputedStyle(this._dialog);this._state.x=parseInt(t.left,10),this._state.width=parseInt(t.width,10),this._state.y=parseInt(t.top,10),this._state.height=parseInt(t.height,10),this.emit("moved",this._state)};this.keepCentered=!1;this.moveable=!0;this.resizable=!0;this._maximizable=!0;this._closable=!0;t&&"type"in t&&t.type==1?(this._dialog=document.createElement("div"),this._dialog.open=!1):this._dialog=document.createElement("dialog"),typeof this._dialog.showModal!="function"&&(this._dialog.showModal=()=>{this._dialog.open||(this._dialog.style.display="block",this._dialog.style.visibility="visible",this._dialog.open=!0,this._state.show=2,this._dialog.dataset.show=""+this._state.show,this._dialog._keydown||(this._dialog._keydown=c=>{c.key==="Escape"&&c.srcElement.tagName!=="TEXTAREA"&&c.srcElement.tagName!=="INPUT"&&c.srcElement.tagName!=="SELECT"&&(this._dialog.returnValue="canceled",this.close())}),this._dialog.backdrop_||(this._dialog.backdrop_=document.createElement("div"),this._dialog.backdrop_.className="backdrop",this._dialog.backdrop_MouseEvent=function(c){if(this.hasAttribute("tabindex"))this.focus();else{var g=document.createElement("div");this.insertBefore(g,this.firstChild),g.tabIndex=-1,g.focus(),this.removeChild(g)}var f=document.createEvent("MouseEvents");f.initMouseEvent(c.type,c.bubbles,c.cancelable,window,c.detail,c.screenX,c.screenY,c.clientX,c.clientY,c.ctrlKey,c.altKey,c.shiftKey,c.metaKey,c.button,c.relatedTarget),this.dispatchEvent(f),c.stopPropagation()},this._dialog.backdrop_.addEventListener("mouseup",this._dialog.backdrop_MouseEvent.bind(this._dialog)),this._dialog.backdrop_.addEventListener("mousedown",this._dialog.backdrop_MouseEvent.bind(this._dialog)),this._dialog.backdrop_.addEventListener("click",this._dialog.backdrop_MouseEvent.bind(this._dialog))),this._dialog.parentNode.insertBefore(this._dialog.backdrop_,this._dialog.nextSibling),window.document.addEventListener("keydown",this._dialog._keydown))}),typeof this._dialog.show!="function"&&(this._dialog.show=()=>{this._dialog.open||(this._dialog.style.display="block",this._dialog.style.visibility="visible",this._dialog.open=!0,this._state.show=1,this._dialog.dataset.show=""+this._state.show)}),typeof this._dialog.close!="function"&&(this._dialog.close=()=>{this._dialog.style.display="",this._dialog.style.visibility="",this._dialog.open=!1,this._state.show=0,this._dialog.dataset.show=""+this._state.show,window.removeEventListener("resize",this._windowResize),this.emit("closed")}),this._dialog.dialog=this,t&&"id"in t&&t.id&&t.id.length?this._id=t.id:(!this._id||!this._id.length)&&(this._id="dialog"+new Date().getTime()),this._dialog.id=this._id,this._dialog.style.zIndex="100",this._dialog.style.margin="0",this._dialog.classList.add("dialog"),(!t||!t.noAdaptive)&&this._dialog.classList.add("adaptive"),t&&"moveable"in t&&(this.moveable=t.moveable),t&&"resizable"in t&&(this.resizable=t.resizable),t&&"maximizable"in t&&(this._maximizable=t.maximizable),typeof t?.height=="number"?this._dialog.style.height=t.height+"px":t?.height&&t?.height.length>0?this._dialog.style.height=t.height:this._dialog.style.height="480px",typeof t?.minHeight=="number"?this._dialog.style.minHeight=t.minHeight+"px":t?.minHeight&&t?.minHeight.length>0?this._dialog.style.minHeight=t.minHeight:this._dialog.style.minHeight="150px",typeof t?.minWidth=="number"?this._dialog.style.minWidth=t.minWidth+"px":t?.minWidth&&t?.minWidth.length>0?this._dialog.style.minWidth=t.minWidth:this._dialog.style.minWidth="300px",typeof t?.width=="number"?this._dialog.style.width=t.width+"px":t?.width&&t?.width.length>0?this._dialog.style.width=t.width:this._dialog.style.width="640px",typeof t?.y=="number"?this._dialog.style.top=t.y+"px":t?.y&&t?.y.length>0?this._dialog.style.top=t.y:this._dialog.style.top="0",typeof t?.x=="number"?this._dialog.style.left=t.x+"px":t?.x&&t?.x.length>0?this._dialog.style.left=t.x:this._dialog.style.left="0";let e="";if(t&&(t.buttons&2)===2&&(e+=`<button id="${this._id}-cancel" type="button" class="btn-sm float-end btn btn-light" title="Cancel dialog">Cancel</button>`),t&&(t.buttons&1)===1&&(e+=`<button id="${this._id}-ok" type="button" class="btn-sm float-end btn btn-primary" title="Confirm dialog">Ok</button>`),t&&(t.buttons&8)===8&&(e+=`<button id="${this._id}-no" type="button" class="btn-sm float-end btn btn-light" title="No">No</button>`),t&&(t.buttons&4)===4&&(e+=`<button id="${this._id}-yes" type="button" class="btn-sm float-end btn btn-primary" title="Yes">Yes</button>`),this._dialog.innerHTML=`<div class="dialog-header">
        <button id="${this._id}-header-close" style="padding: 4px;" type="button" class="btn btn-close float-end btn-danger" data-dismiss="modal" title="Close window"></button>
        <button type="button" class="btn btn-light float-end maximize" id="${this._id}-max" title="Maximize window" style="padding: 0 4px;margin-top: -1px;"><i class="bi-arrows-fullscreen"></i></button>
        <div>${t?.title||""}</div>
    </div>
    <div class="dialog-body"></div>
    <div class="dialog-footer">${e}</div>`,this._dialog.querySelector(`#${this._id}-header-close`).addEventListener("click",()=>{this.close()}),this._dialog.querySelector(`#${this._id}-max`).addEventListener("click",()=>{this.maximized?this.restore():this.maximize()}),this._dialog.addEventListener("close",c=>{if(c.target!==this._dialog)return;let g={preventDefault:!1};if(this.emit("closing",g),g.preventDefault){c.preventDefault();return}document.body.removeChild(this._dialog),this._state.show=0,this._dialog.dataset.show=""+this._state.show,this._dialog.backdrop_&&this._dialog.parentNode.removeChild(this._dialog.backdrop_),this._dialog._keydown&&window.document.removeEventListener("keydown",this._dialog._keydown),window.removeEventListener("resize",this._windowResize),this.emit("closed",this._dialog.returnValue)}),this._dialog.addEventListener("cancel",c=>{if(c.target!==this._dialog)return;let g={preventDefault:!1};if(this.emit("canceling",g),g.preventDefault){c.preventDefault();return}if(document.activeElement&&(document.activeElement.tagName==="TEXTAREA"||document.activeElement.tagName==="iNPUT"||document.activeElement.tagName==="SELECT")){c.preventDefault();return}this._dialog.open=!1,document.body.removeChild(this._dialog),this._state.show=0,this._dialog.dataset.show=""+this._state.show,this._dialog.backdrop_&&this._dialog.parentNode.removeChild(this._dialog.backdrop_),this._dialog._keydown&&window.document.removeEventListener("keydown",this._dialog._keydown),window.removeEventListener("resize",this._windowResize),this._dialog.returnValue!=="ok"&&this.emit("canceled")}),document.body.appendChild(this._dialog),this._maximizable?this._dialog.querySelector(`#${this._id}-max`).style.display="":this._dialog.querySelector(`#${this._id}-max`).style.display="none",t&&"closeable"in t&&(this.closeable=t.closeable),t&&(t.buttons&2)===2&&this._dialog.querySelector(`#${this._id}-cancel`).addEventListener("click",()=>{let c={preventDefault:!1,button:2};this.emit("button-click",c),!c.preventDefault&&(this._dialog.returnValue="cancel",this.close())}),t&&(t.buttons&8)===8&&this._dialog.querySelector(`#${this._id}-no`).addEventListener("click",()=>{let c={preventDefault:!1,button:8};this.emit("button-click",c),!c.preventDefault&&(this._dialog.returnValue="no",this.close())}),t&&(t.buttons&1)===1&&this._dialog.querySelector(`#${this._id}-ok`).addEventListener("click",()=>{let c={preventDefault:!1,button:1};this.emit("button-click",c),!c.preventDefault&&(this._dialog.returnValue="ok",this._dialog.close())}),t&&(t.buttons&4)===4&&this._dialog.querySelector(`#${this._id}-yes`).addEventListener("click",()=>{let c={preventDefault:!1,button:4};this.emit("button-click",c),!c.preventDefault&&(this._dialog.returnValue="yes",this._dialog.close())}),this._body=this._dialog.querySelector('[class="dialog-body"]'),this._title=this._dialog.querySelector('[class="dialog-header"] div'),this._footer=this._dialog.querySelector('[class="dialog-footer"]'),this._header=this._dialog.querySelector('[class="dialog-header"]'),this.resizable){this._dialog.classList.add("resizable");var s=document.createElement("div");s.className="resizer-right",this._dialog.appendChild(s),s.addEventListener("mousedown",c=>{this.initResize(c,1)},!1),s.addEventListener("touchstart",c=>{this.initResizeTouch(c,1)},{passive:!0});var n=document.createElement("div");n.className="resizer-bottom",this._dialog.appendChild(n),n.addEventListener("mousedown",c=>{this.initResize(c,2)},!1),n.addEventListener("touchstart",c=>{this.initResizeTouch(c,2)},{passive:!0});var r=document.createElement("div");r.className="resizer-se",this._dialog.appendChild(r),r.addEventListener("mousedown",c=>{this.initResize(c,3)},!1),r.addEventListener("touchstart",c=>{this.initResizeTouch(c,3)},{passive:!0}),r=document.createElement("div"),r.className="resizer-ne",this._dialog.appendChild(r),r.addEventListener("mousedown",c=>{this.initResize(c,9)},!1),r.addEventListener("touchstart",c=>{this.initResizeTouch(c,9)},{passive:!0}),r=document.createElement("div"),r.className="resizer-nw",this._dialog.appendChild(r),r.addEventListener("mousedown",c=>{this.initResize(c,12)},!1),r.addEventListener("touchstart",c=>{this.initResizeTouch(c,12)},{passive:!0}),r=document.createElement("div"),r.className="resizer-sw",this._dialog.appendChild(r),r.addEventListener("mousedown",c=>{this.initResize(c,6)},!1),r.addEventListener("touchstart",c=>{this.initResizeTouch(c,6)},{passive:!0});var a=document.createElement("div");a.className="resizer-left",this._dialog.appendChild(a),a.addEventListener("mousedown",c=>{this.initResize(c,4)},!1),a.addEventListener("touchstart",c=>{this.initResizeTouch(c,4)},{passive:!0});var o=document.createElement("div");o.className="resizer-top",this._dialog.appendChild(o),o.addEventListener("mousedown",c=>{this.initResize(c,8)},!1),o.addEventListener("touchstart",c=>{this.initResizeTouch(c,8)},{passive:!0})}this.moveable&&(this._dialog.addEventListener("mousedown",()=>{this.focus()}),this._header.addEventListener("mousedown",this.dragMouseDown),this._header.addEventListener("touchstart",this.dragTouchStart,{passive:!0}));let h=document.defaultView.getComputedStyle(this._dialog);this._state.x=this._resize.x=parseInt(h.left,10),this._state.width=this._resize.width=parseInt(h.width,10),this._state.y=this._resize.y=parseInt(h.top,10),this._state.height=this._resize.height=parseInt(h.height,10),t&&"noFooter"in t&&t.noFooter&&this.hideFooter(),t&&"maximized"in t&&t.maximized&&this.maximize(),t&&"showModal"in t&&t.showModal?this.showModal():t&&"show"in t&&t.show&&(t.show===2?this.showModal():this.show()),t&&"keepCentered"in t&&t.keepCentered&&(this.keepCentered=t.keepCentered),(this.keepCentered||t&&"center"in t&&t.center)&&this.center(),t&&"position"in t&&t.position>0&&this.position(t.position),this._windowResize(),this._resizeObserver=new ResizeObserver((c,g)=>{c.length!==0&&(!c[0].contentRect||c[0].contentRect.width===0||c[0].contentRect.height===0||(!this._resizeObserverCache||this._resizeObserverCache.height!==c[0].contentRect.height)&&(this._resizeObserverCache={width:c[0].contentRect.width,height:c[0].contentRect.height},this._footer.style.display!=="none"&&(this._body.style.bottom=this._footer.clientHeight+1+"px")))}),this._resizeObserver.observe(this._footer),this._observer=new MutationObserver(c=>{let g;for(g of c)g.type==="attributes"&&g.attributeName==="style"&&this._footer.style.display!=="none"&&(this._body.style.bottom=this._footer.clientHeight+1+"px")}),this._observer.observe(this._footer,{attributes:!0,attributeOldValue:!0,attributeFilter:["style"]})}get maximizable(){return this._maximizable}set maximizable(t){t!==this._maximizable&&(this._maximizable=t,this.maximizable?this._dialog.querySelector(`#${this._id}-max`).style.display="":this._dialog.querySelector(`#${this._id}-max`).style.display="none")}get closeable(){return this._closable}set closeable(t){t!==this._closable&&(this._closable=t,this._closable?this._dialog.querySelector(`#${this._id}-header-close`).style.display="":this._dialog.querySelector(`#${this._id}-header-close`).style.display="none")}set maximized(t){this._state.maximized!==t&&(this._state.maximized=t)}get maximized(){return this._state.maximized}initResize(t,e){if(this.maximized)return;let s=document.defaultView.getComputedStyle(this._dialog);this._resize.x=t.clientX,this._resize.width=parseInt(s.width,10),this._resize.y=t.clientY,this._resize.height=parseInt(s.height,10),this._resize.type=e,this._resize.minHeight=parseInt(s.minHeight,10),this._resize.minWidth=parseInt(s.minWidth,10),this._resize.borderHeight=t.offsetY+parseInt(s.borderTopWidth),this._resize.borderWidth=t.offsetX+parseInt(s.borderLeftWidth),this._body.style.pointerEvents="none",document.documentElement.addEventListener("mousemove",this.resizeDoDrag,!1),document.documentElement.addEventListener("mouseup",this.resizeStopDrag,!1)}initResizeTouch(t,e){if(!t.touches.length||this.maximized)return;let s=document.defaultView.getComputedStyle(this._dialog);this._resize.x=t.touches[0].clientX,this._resize.width=parseInt(s.width,10),this._resize.y=t.touches[0].clientY,this._resize.height=parseInt(s.height,10),this._resize.type=e,this._resize.minHeight=parseInt(s.minHeight,10),this._resize.minWidth=parseInt(s.minWidth,10);var n=t.target.getBoundingClientRect(),r=t.targetTouches[0].clientX-n.x,a=t.targetTouches[0].clientY-n.y;this._resize.borderHeight=a+parseInt(s.borderTopWidth),this._resize.borderWidth=r+parseInt(s.borderLeftWidth),this._body.style.pointerEvents="none",document.documentElement.addEventListener("touchmove",this.resizeTouchDrag,!1),document.documentElement.addEventListener("touchend",this.resizeStopDrag,!1)}get id(){return this._id}set id(t){if(this._id!==t&&(this._id=t,this._dialog)){this._dialog.id=this._id;let e=this._dialog.querySelector(`#${this._id}-cancel`);e&&(e.id=this._id+"-cancel"),e=this._dialog.querySelector(`#${this._id}-ok`),e&&(e.id=this._id+"-ok"),e=this._dialog.querySelector(`#${this._id}-max`),e&&(e.id=this._id+"-max"),e=this._dialog.querySelector(`#${this._id}-header-close`),e&&(e.id=this._id+"-header-close")}}get title(){return this._title.innerHTML}set title(t){this._title.innerHTML=t}showModal(){if(this._dialog.parentElement||document.body.appendChild(this._dialog),this.makeVisible(!0),this._dialog.returnValue="",this._dialog.open){this.focus();return}this._dialog.showModal(),this._state.show=2,this._dialog.dataset.show=""+this._state.show,window.addEventListener("resize",this._windowResize),this.emit("shown",!0),this.focus()}show(){if(this._dialog.parentElement||document.body.appendChild(this._dialog),this.makeVisible(!0),this._dialog.returnValue="",this._dialog.open){this.focus();return}this._dialog.show(),this._state.show=1,this._dialog.dataset.show=""+this._state.show,window.addEventListener("resize",this._windowResize),this.emit("shown",!1),this.focus()}get opened(){return this._dialog.open}close(t){this._dialog.open&&(this._dialog.backdrop_&&this._dialog.parentNode.removeChild(this._dialog.backdrop_),this._dialog._keydown&&window.document.removeEventListener("keydown",this._dialog._keydown),t&&(this._dialog.returnValue=t),this._dialog.close())}get header(){return this._header}get body(){return this._body}get footer(){return this._footer}get dialog(){return this._dialog}get left(){return this._dialog.style.left}set left(t){this._dialog.style.left=t}get top(){return this._dialog.style.top}set top(t){this._dialog.style.top=t}get width(){return this._dialog.style.width}set width(t){this._dialog.style.width=t}get height(){return this._dialog.style.height}set height(t){this._dialog.style.top=t}get windowState(){return this._state}_width(){let t=this.dialog.offsetWidth||this._dialog.clientWidth;if(!t){let e=document.defaultView.getComputedStyle(this._dialog);t=t||parseInt(e.width,10)}return t}_height(){let t=this.dialog.offsetHeight||this._dialog.clientHeight;if(!t){let e=document.defaultView.getComputedStyle(this._dialog);t=t||parseInt(e.height,10)}return t}get _size(){let t=this.dialog.offsetWidth||this._dialog.clientWidth,e=this.dialog.offsetHeight||this._dialog.clientHeight;if(!t||!e){let s=document.defaultView.getComputedStyle(this._dialog);t=t||parseInt(s.width,10),e=e||parseInt(s.height,10)}return{width:t,height:e}}center(){this.position(48)}position(t){if(t<1)return;let e=this._size;(t&4)===4?this._state.y=0:(t&8)===8?this._state.y=window.innerHeight-e.height:(t&16)===16&&(this._state.y=window.innerHeight/2-e.height/2),(t&1)===1?this._state.x=0:(t&2)===2?this._state.x=window.innerWidth-e.width:(t&32)===32&&(this._state.x=window.innerWidth/2-e.width/2),this._dialog.style.left=this._state.x+"px",this._dialog.style.top=this._state.y+"px",this._state.width=e.width,this._state.height=e.height,this.emit("moved",this._state)}maximize(){this.maximized||(this.maximized=!0,this._dialog.classList.add("maximized"),this._dialog.querySelector(`#${this._id}-max`).firstElementChild.classList.remove("bi-arrows-fullscreen"),this._dialog.querySelector(`#${this._id}-max`).firstElementChild.classList.add("bi-arrows-angle-contract"),this.emit("maximized"))}restore(){this.maximized&&(this.maximized=!1,this._dialog.classList.remove("maximized"),this._dialog.querySelector(`#${this._id}-max`).firstElementChild.classList.add("bi-arrows-fullscreen"),this._dialog.querySelector(`#${this._id}-max`).firstElementChild.classList.remove("bi-arrows-angle-contract"),this.emit("restored"))}getMaxZIndex(t){let e=document.getElementsByTagName("dialog"),s=0,n=e.length,r=parseInt(this._dialog.style.zIndex,10),a=[];for(;s<n;s++){if(!e[s].style.zIndex||!e[s].style.zIndex.length)continue;let o=parseInt(e[s].style.zIndex,10);o>r&&(r=o),a.push({z:o,idx:s,show:parseInt(e[s].dataset.show||"",10)||0})}if(this._state.zIndex=r,t||this._state.zIndex>1e3)for(this._state.zIndex=100,s=0,a.sort((o,h)=>o.show>h.show?1:o.z<h.z?-1:o.z>h.z?1:0);s<n;s++)e[a[s]].backdrop_&&(e[a[s]].backdrop_.style.zIndex=""+this._state.zIndex++),e[a[s].idx].style.zIndex=""+this._state.zIndex++}showFooter(){this._footer.style.display="",this._body.style.bottom=this._footer.clientHeight+1+"px"}hideFooter(){this._footer.style.display="none",this._body.style.bottom="0"}focus(){this._dialog.focus(),this.getMaxZIndex(),this._dialog.style.zIndex=""+ ++this._state.zIndex,this.emit("focus")}makeVisible(t,e){var s=this._dialog.getBoundingClientRect();t?(s.right>window.innerWidth&&(this._state.x=window.innerWidth-this._state.width-16,s.left<0&&(this._state.x=0),this._dialog.style.left=this._state.x+"px"),s.bottom>window.innerHeight&&(this._state.y=window.innerHeight-this._state.height-16,s.top<0&&(this._state.y=0),this._dialog.style.top=this._state.y+"px")):(s.left>window.innerWidth-16&&(this._state.x=window.innerWidth-16,this._dialog.style.left=this._state.x+"px"),s.top>window.innerHeight-16&&(this._state.y=window.innerHeight-16,this._dialog.style.top=this._state.y+"px")),e||this.emit("moved",this._state)}resetState(t){typeof t?.height=="number"?this._dialog.style.height=t.height+"px":t?.height&&t?.height.length>0?this._dialog.style.height=t.height:this._dialog.style.height="480px",typeof t?.minHeight=="number"?this._dialog.style.minHeight=t.minHeight+"px":t?.minHeight&&t?.minHeight.length>0?this._dialog.style.minHeight=t.minHeight:this._dialog.style.minHeight="150px",typeof t?.minWidth=="number"?this._dialog.style.minWidth=t.minWidth+"px":t?.minWidth&&t?.minWidth.length>0?this._dialog.style.minWidth=t.minWidth:this._dialog.style.minWidth="300px",typeof t?.width=="number"?this._dialog.style.width=t.width+"px":t?.width&&t?.width.length>0?this._dialog.style.width=t.width:this._dialog.style.width="640px",typeof t?.y=="number"?this._dialog.style.top=t.y+"px":t?.y&&t?.y.length>0?this._dialog.style.top=t.y:this._dialog.style.top="0",typeof t?.x=="number"?this._dialog.style.left=t.x+"px":t?.x&&t?.x.length>0?this._dialog.style.left=t.x:this._dialog.style.left="0";let e=document.defaultView.getComputedStyle(this._dialog);this._state.x=this._resize.x=parseInt(e.left,10),this._state.width=this._resize.width=parseInt(e.width,10),this._state.y=this._resize.y=parseInt(e.top,10),this._state.height=this._resize.height=parseInt(e.height,10),t&&"maximized"in t&&t.maximized?this.maximize():this.restore(),(this.keepCentered||t&&"center"in t&&t.center)&&this.center(),t&&"position"in t&&t.position>0&&this.position(t.position),this._windowResize()}setBody(t,e){this._body.innerHTML=t,e=e||{};let s=this._body.querySelectorAll("script");for(let n=0,r=s.length;n<r;n++)new Function("body","dialog",...Object.keys(e),s[n].textContent).apply(client,[this._body,this,...Object.values(e),this])}},wt=class extends ve{constructor(u,t,e){super(typeof u=="string"?{title:Pt(e||4)+u,width:300,height:150,keepCentered:!0,center:!0,resizable:!1,moveable:!1,maximizable:!1,buttons:1}:u),this.body.classList.add("d-flex","justify-content-center","align-content-center","align-items-center"),t&&(this.body.innerHTML=`<div class="text-center" style="width: 64px;height:64px;font-size: 40px;">${Pt(e||4)}</div><div class="ms-3 align-self-center flex-fill">${t}</div></div>`)}},st=class extends ve{constructor(u,t,e,s){super(typeof u=="string"?{title:Pt(e||1)+u,width:300,height:150,keepCentered:!0,center:!0,resizable:!1,moveable:!1,maximizable:!1,buttons:s===void 0?12:s}:u),this.body.classList.add("d-flex","justify-content-center","align-content-center","align-items-center"),t&&(this.body.innerHTML=`<div class="text-center" style="width: 64px;height:64px;font-size: 40px;">${Pt(e||1)}</div><div class="ms-3 align-self-center flex-fill">${t}</div></div>`)}},yi=class extends ve{constructor(u,t,e){super(typeof u=="string"?{title:Pt(e||1)+u,width:300,height:150,keepCentered:!0,center:!0,resizable:!1,moveable:!1,maximizable:!1,buttons:2,closeable:!1}:u),this.body.classList.add("text-center","justify-content-center","align-content-center","align-items-center"),this.body.innerHTML=`<div class="align-self-center flex-fill" id="progress-message" style="padding:0 5px">${t||""}</div></div><div class="progress" role="progressbar" aria-label="${u}" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="margin: 5px;"><div class="progress-bar" style="width: 0%"></div></div>`,this._progress=this.body.querySelector(".progress-bar")}set label(u){this._progress.innerHTML=u}get label(){return this._progress.innerHTML}set progress(u){u<0&&(u=0),u>100&&(u=100),this._progress.style.width=u+"%"}get progress(){return parseInt(this._progress.style.width,10)}get message(){return this.body.querySelector("#progress-message").textContent}set message(u){this.body.querySelector("#progress-message").textContent=u}};function Pt(m){if(typeof m=="string")return m+" ";switch(m){case 3:return'<i class="fa-regular fa-circle-xmark"></i> ';case 4:return'<i class="fa-solid fa-circle-exclamation"></i> ';case 1:return'<i class="fa-regular fa-circle-question"></i> '}return'<i class="fa-solid fa-circle-info"></i> '}window.confirm_box=(m,u,t,e)=>new Promise((s,n)=>{let r=new st(m,u,t,e);r.showModal(),r.on("button-click",a=>s(a)),r.on("canceled",()=>n(null)),r.on("closed",a=>a==="Yes"?0:n(null))});window.alert_box=(m,u,t)=>{new wt(m,u,t).showModal()};window.progress_box=(m,u,t)=>new yi(m,u,t);window.Dialog=ve;function ze(){let m=bootstrap.Offcanvas.getInstance(document.getElementById("clientMenu"));m&&m.hide()}function Es(){bootstrap.Offcanvas.getOrCreateInstance(document.getElementById("clientMenu")).show()}function ji(){document.getElementById("btn-menu").addEventListener("click",Es),client.on("connected",()=>{let n=document.getElementById("menu-connect"),r=document.querySelector("#menu-connect a span"),a=document.querySelector("#menu-connect svg")||document.querySelector("#menu-connect i");n.title="Disconnect",n.classList.add("active"),r.textContent="Disconnect",a.classList.add("fa-plug-circle-xmark"),a.classList.remove("fa-plug")}),client.on("closed",()=>{let n=document.getElementById("menu-connect"),r=document.querySelector("#menu-connect a span"),a=document.querySelector("#menu-connect svg")||document.querySelector("#menu-connect i");n.title="Connect",n.classList.remove("active"),r.textContent="Connect",a.classList.remove("fa-plug-circle-xmark"),a.classList.add("fa-plug")}),client.on("scroll-lock",Ui),document.querySelector("#menu-connect a").addEventListener("click",n=>{client.connected?client.close():(client.connect(),ze())}),document.querySelector("#menu-clear a").addEventListener("click",n=>{client.clear(),ze()}),document.querySelector("#menu-lock a").addEventListener("click",n=>{client.toggleScrollLock(),ze()}),document.querySelector("#menu-editor a").addEventListener("click",n=>{ze(),document.getElementById("btn-adv-editor").click()}),document.querySelector("#menu-about a").addEventListener("click",n=>{Me("about"),ze()}),document.querySelector("#menu-settings a").addEventListener("click",n=>{Me("settings"),ze()}),document.querySelector("#menu-profiles a").addEventListener("click",n=>{Me("profiles"),ze()}),document.querySelector("#menu-fullscreen a").addEventListener("click",n=>{var r=window.document,a=r.documentElement,o=a.requestFullscreen||a.mozRequestFullScreen||a.webkitRequestFullScreen||a.msRequestFullscreen,h=r.exitFullscreen||r.mozCancelFullScreen||r.webkitExitFullscreen||r.msExitFullscreen;let c=document.getElementById("menu-fullscreen"),g=document.querySelector("#menu-fullscreen svg")||document.querySelector("#menu-fullscreen i"),f=document.querySelector("#menu-fullscreen a span");!r.fullscreenElement&&!r.mozFullScreenElement&&!r.webkitFullscreenElement&&!r.msFullscreenElement?(c.title="Exit fullscreen",f.textContent="Exit fullscreen",o.call(a),g.classList.add("fa-minimize"),g.classList.remove("fa-maximize")):(c.title="Enter fullscreen",f.textContent="Enter fullscreen",h.call(r),g.classList.add("fa-maximize"),g.classList.remove("fa-minimize")),ze()}),document.querySelector("#menu-buttons a").addEventListener("click",n=>{qi();let r=document.querySelector("#menu-buttons");client.getOption("showButtons")?(r.title="Hide buttons",r.classList.add("active"),document.querySelector("#menu-buttons a span").textContent="Hide buttons"):(r.title="Show buttons",r.classList.remove("active"),document.querySelector("#menu-buttons a span").textContent="Show buttons"),ze()}),Ui();let m=client.plugins.length,u,t,e=document.querySelector("#clientMenu ul");for(let n=0;n<m;n++)if(client.plugins[n].menu&&client.plugins[n].menu.length)for(t=client.plugins[n].menu.length,u=0;u<t;u++){let r=client.plugins[n].menu[u],a,o="menu-"+(r.name||u).toLowerCase().replace(/ /g,"-");r.name==="-"?a='<li><hr class="dropdown-divider"></li>':typeof r.action=="string"?a=`<li id="menu-${o}" class="nav-item" title="${r.name||""}"><a class="nav-link" href="#${r.action}">${r.icon||""}<span>${r.name||""}</span></a></li>`:a=`<li id="menu-${o}" class="nav-item" title="${r.name||""}"><a class="nav-link" href="javascript:void(0)">${r.icon||""}<span>${r.name||""}</span></a></li>`,"position"in r?typeof r.position=="string"?e.querySelector(r.position)&&e.querySelector(r.position).insertAdjacentHTML("afterend",a):r.position>=0&&r.position<e.children.length?e.children[r.position].insertAdjacentHTML("afterend",a):e.insertAdjacentHTML("beforeend",a):e.insertAdjacentHTML("beforeend",a),r.name!=="-"&&typeof r.action=="function"&&document.querySelector(`#menu-${o} a`).addEventListener("click",h=>{let c={client,preventDefault:!1};r.action(c),!c.preventDefault&&ze()})}let s=document.querySelector("#menu-buttons");client.getOption("showButtons")?(s.title="Hide buttons",s.classList.add("active"),document.querySelector("#menu-buttons a span").textContent="Hide buttons"):(s.title="Show buttons",s.classList.remove("active"),document.querySelector("#menu-buttons a span").textContent="Show buttons")}function Ui(){let m=document.getElementById("menu-lock"),u=document.querySelector("#menu-lock a span"),t=document.querySelector("#menu-lock svg")||document.querySelector("#menu-lock i");client.scrollLock?(m.title="Unlock display",m.classList.add("active"),u.textContent="Unlock display",t.classList.add("fa-unlock"),t.classList.remove("fa-lock")):(m.title="Lock display",m.classList.remove("active"),u.textContent="Lock display",t.classList.remove("fa-unlock"),t.classList.add("fa-lock"))}var Kt=class extends pe{constructor(t,e){super();this._simple=!0;this._init=!1;this.colorNames={"No color":"Default",BLACK:"Black",RED:"Maroon",GREEN:"Green",ORANGE:"Olive",BLUE:"Navy",MAGENTA:"Purple",WHITE:"Silver",CYAN:"Teal","BOLD BLACK":"Grey","BOLD RED":"Red","BOLD GREEN":"Lime",YELLOW:"Yellow","BOLD YELLOW":"Yellow","BOLD BLUE":"Blue","BOLD MAGENTA":"Fuchsia","BOLD CYAN":"Aqua",BOLD:"White","BOLD WHITE":"White",RGB000:"Black",RGB001:"Navy Blue",RGB002:"Dark Blue",RGB003:"Blue",RGB004:"Blue",RGB005:"Blue",RGB010:"Dark Green",RGB011:"Deep Sky Blue",RGB012:"Deep Sky Blue",RGB013:"Deep Sky Blue",RGB014:"Cobalt/Dodger Blue",RGB015:"Dodger Blue",RGB020:"Green",RGB021:"Spring Green",RGB022:"Turquoise",RGB023:"Deep Sky Blue",RGB024:"Deep Sky Blue",RGB025:"Dodger Blue",RGB030:"Green",RGB031:"Spring Green",RGB032:"Dark Cyan",RGB033:"Light Sea Green",RGB034:"Deep Sky Blue",RGB035:"Deep Sky Blue",RGB040:"Green",RGB041:"Spring Green",RGB042:"Spring Green",RGB043:"Cyan",RGB044:"Dark Turquoise",RGB045:"Turquoise",RGB050:"Green",RGB051:"Spring Green",RGB052:"Spring Green",RGB053:"Medium Spring Green",RGB054:"Cyan",RGB055:"Cyan",RGB100:"Dark Red",RGB101:"Deep Pink",RGB102:"Purple",RGB103:"Purple",RGB104:"Purple",RGB105:"Blue Violet",RGB110:"Orange",RGB111:"Dark Grey",RGB112:"Medium Purple",RGB113:"Slate Blue",RGB114:"Slate Blue",RGB115:"Royal Blue",RGB120:"Chartreuse",RGB121:"Dark Sea Green",RGB122:"Pale Turquoise",RGB123:"Steel Blue",RGB124:"Steel Blue",RGB125:"Cornflower Blue",RGB130:"Chartreuse",RGB131:"Dark Sea Green",RGB132:"Cadet Blue",RGB133:"Cadet Blue",RGB134:"Sky Blue",RGB135:"Steel Blue",RGB140:"Chartreuse",RGB141:"Pale Green",RGB142:"Sea Green",RGB143:"Aquamarine",RGB144:"Medium Turquoise",RGB145:"Steel Blue",RGB150:"Chartreuse",RGB151:"Sea Green",RGB152:"Sea Green",RGB153:"Sea Green",RGB154:"Aquamarine",RGB155:"Dark Slate Gray",RGB200:"Dark Red",RGB201:"Deep Pink",RGB202:"Dark Magenta",RGB203:"Dark Magenta",RGB204:"Dark Violet",RGB205:"Purple",RGB210:"Orange",RGB211:"Light Pink",RGB212:"Plum",RGB213:"Medium Purple",RGB214:"Medium Purple",RGB215:"Slate Blue",RGB220:"Yellow",RGB221:"Wheat",RGB222:"Grey",RGB223:"Light Slate Grey",RGB224:"Medium Purple",RGB225:"Light Slate Blue",RGB230:"Yellow",RGB231:"Dark Olive Green",RGB232:"Dark Sea Green",RGB233:"Light Sky Blue",RGB234:"Light Sky Blue",RGB235:"Sky Blue",RGB240:"Chartreuse",RGB241:"Dark Olive Green",RGB242:"Pale Green",RGB243:"Dark Sea Green",RGB244:"Dark Slate Gray",RGB245:"Sky Blue",RGB250:"Chartreuse",RGB251:"Light Green",RGB252:"Light Green",RGB253:"Pale Green",RGB254:"Aquamarine",RGB255:"Dark Slate Gray",RGB300:"Red",RGB301:"Deep Pink",RGB302:"Medium Violet Red",RGB303:"Magenta",RGB304:"Dark Violet",RGB305:"Purple",RGB310:"Dark Orange",RGB311:"Indian Red",RGB312:"Hot Pink",RGB313:"Medium Orchid",RGB314:"Medium Orchid",RGB315:"Medium Purple",RGB320:"Dark Goldenrod",RGB321:"Light Salmon",RGB322:"Rosy Brown",RGB323:"Grey",RGB324:"Medium Purple",RGB325:"Medium Purple",RGB330:"Gold",RGB331:"Dark Khaki",RGB332:"Navajo White",RGB333:"Grey",RGB334:"Light Steel Blue",RGB335:"Light Steel Blue",RGB340:"Yellow",RGB341:"Dark Olive Green",RGB342:"Dark Sea Green",RGB343:"Dark Sea Green",RGB344:"Light Cyan",RGB345:"Light Sky Blue",RGB350:"Green Yellow",RGB351:"Dark Olive Green",RGB352:"Pale Green",RGB353:"Dark Sea Green",RGB354:"Dark Sea Green",RGB355:"Pale Turquoise",RGB400:"Crimson/Red",RGB401:"Deep Pink",RGB402:"Deep Pink",RGB403:"Magenta",RGB404:"Magenta",RGB405:"Magenta",RGB410:"Dark Orange",RGB411:"Indian Red",RGB412:"Hot Pink",RGB413:"Hot Pink",RGB414:"Orchid",RGB415:"Medium Orchid",RGB420:"Orange",RGB421:"Light Salmon/Bronze",RGB422:"Light Pink",RGB423:"Pink",RGB424:"Plum",RGB425:"Violet",RGB430:"Gold",RGB431:"Light Goldenrod",RGB432:"Tan",RGB433:"Misty Rose",RGB434:"Thistle",RGB435:"Plum",RGB440:"Yellow",RGB441:"Khaki",RGB442:"Light Goldenrod",RGB443:"Light Yellow",RGB444:"Grey",RGB445:"Light Steel Blue",RGB450:"Yellow",RGB451:"Dark Olive Green",RGB452:"Dark Olive Green",RGB453:"Dark Sea Green",RGB454:"Honeydew",RGB455:"Light Cyan",RGB500:"Red",RGB501:"Deep Pink",RGB502:"Deep Pink",RGB503:"Deep Pink",RGB504:"Magenta",RGB505:"Magenta",RGB510:"Orangered",RGB511:"Indian Red",RGB512:"Indian Red",RGB513:"Hot Pink",RGB514:"Hot Pink",RGB515:"Medium Orchid",RGB520:"Dark Orange",RGB521:"Salmon",RGB522:"Light Coral",RGB523:"Pale Violet Red",RGB524:"Orchid",RGB525:"Orchid",RGB530:"Orange",RGB531:"Sandy Brown",RGB532:"Light Salmon",RGB533:"Light Pink",RGB534:"Pink",RGB535:"Plum",RGB540:"Gold",RGB541:"Light Goldenrod",RGB542:"Light Goldenrod",RGB543:"Navajo White",RGB544:"Misty Rose",RGB545:"Thistle",RGB550:"Yellow",RGB551:"Light Goldenrod",RGB552:"Khaki",RGB553:"Wheat",RGB554:"Corn Silk",RGB555:"White",mono00:"Grey 3",mono01:"Grey 7",mono02:"Grey 11",mono03:"Grey 15",mono04:"Grey 19",mono05:"Grey 23",mono06:"Grey 27",mono07:"Grey 30",mono08:"Grey 35",mono09:"Grey 39",mono10:"Grey 32",mono11:"Grey 46",mono12:"Grey 50",mono13:"Grey 54",mono14:"Grey 58",mono15:"Grey 62",mono16:"Grey 66",mono17:"Grey 70",mono18:"Grey 74",mono19:"Grey 78",mono20:"Grey 82",mono21:"Grey 85",mono22:"Grey 89",mono23:"Grey 93"};this.colorList=[];if(!t)throw new Error("AdvEditor must be a selector, element or jquery object");if(typeof t=="string"){if(this._element=document.querySelector(t),!this._element)throw new Error("Invalid selector for AdvEditor.")}else if(t instanceof $)this._element=t[0];else if(t instanceof HTMLElement)this._element=t;else throw new Error("AdvEditor must be a selector, element or jquery object");this.simple=!e}get id(){return this._element?this._element.id:""}get element(){return this._element}get simple(){return this._simple}set simple(t){t!==this._simple&&(this._simple=t,this.tinymceExist&&(t?this.remove():this.initialize()))}clear(){this.isSimple?this._element.value="":tinymce.activeEditor.setContent("")}get value(){return this.isSimple?this._element.value:this.getFormattedText().replace(/(?:\r)/g,"")}set value(t){this.isSimple?this._element.value=t:tinymce.activeEditor.setContent(t)}insert(t){if(this.isSimple)Ke(this._element,t);else{t=Se(t),t=t.replace(/ /g,"&nbsp;"),t=t.replace(/\t/g,"&nbsp;&nbsp;&nbsp;"),t=t.replace(/(?:\r\n|\r|\n)/g,"<br/>");var e=this.getText();e===`
`?tinymce.activeEditor.undoManager.transact(()=>{tinymce.activeEditor.setContent(t)}):(e.endsWith(`
`)||(t="<br>"+t),tinymce.activeEditor.undoManager.transact(()=>{tinymce.activeEditor.dom.add(tinymce.activeEditor.getBody(),"span",{},t)}))}}get tinymceExist(){return typeof tinymce<"u"}get isSimple(){return this._simple||!this.tinymceExist}loadColors(){var t=Bi(),e,s,n,r,a,o,h=[],c;this._ColorTable=[],this._colors={};var g=client.getOption("colors")||[];for(s=new ne(g[0]||t[0]).toHex().substr(1).toUpperCase(),this._colors[s]="BLACK",this._ColorTable.push(s,"BLACK"),s=new ne(g[1]||t[1]).toHex().substr(1).toUpperCase(),this._colors[s]="RED",this._ColorTable.push(s,"RED"),s=new ne(g[2]||t[2]).toHex().substr(1).toUpperCase(),this._colors[s]="GREEN",this._ColorTable.push(s,"GREEN"),s=new ne(g[3]||t[3]).toHex().substr(1).toUpperCase(),this._colors[s]="ORANGE",this._ColorTable.push(s,"ORANGE"),s=new ne(g[4]||t[4]).toHex().substr(1).toUpperCase(),this._colors[s]="BLUE",this._ColorTable.push(s,"BLUE"),s=new ne(g[5]||t[5]).toHex().substr(1).toUpperCase(),this._colors[s]="MAGENTA",this._ColorTable.push(s,"MAGENTA"),s=new ne(g[6]||t[6]).toHex().substr(1).toUpperCase(),this._colors[s]="CYAN",this._ColorTable.push(s,"CYAN"),s=new ne(g[7]||t[7]).toHex().substr(1).toUpperCase(),this._colors[s]="WHITE",this._ColorTable.push(s,"WHITE"),s=new ne(g[8]||t[8]).toHex().substr(1).toUpperCase(),this._colors[s]="mono11",this._ColorTable.push(s,"BOLD BLACK"),h.push(s),s=new ne(g[9]||t[9]).toHex().substr(1).toUpperCase(),this._colors[s]="BOLD%^%^RED",this._ColorTable.push(s,"BOLD RED"),h.push(s),s=new ne(g[10]||t[10]).toHex().substr(1).toUpperCase(),this._colors[s]="BOLD%^%^GREEN",this._ColorTable.push(s,"BOLD GREEN"),h.push(s),s=new ne(g[11]||t[11]).toHex().substr(1).toUpperCase(),this._colors[s]="BOLD%^%^YELLOW",this._ColorTable.push(s,"BOLD YELLOW"),h.push(s),s=new ne(g[11]||t[11]).toHex().substr(1).toUpperCase(),this._colors[s]="YELLOW",this._ColorTable.push(s,"YELLOW"),h.push(s),s=new ne(g[12]||t[12]).toHex().substr(1).toUpperCase(),this._colors[s]="BOLD%^%^BLUE",this._ColorTable.push(s,"BOLD BLUE"),h.push(s),s=new ne(g[13]||t[13]).toHex().substr(1).toUpperCase(),this._colors[s]="BOLD%^%^MAGENTA",this._ColorTable.push(s,"BOLD MAGENTA"),h.push(s),s=new ne(g[14]||t[14]).toHex().substr(1).toUpperCase(),this._colors[s]="BOLD%^%^CYAN",this._ColorTable.push(s,"BOLD CYAN"),h.push(s),s=new ne(g[15]||t[15]).toHex().substr(1).toUpperCase(),this._colors[s]="BOLD%^%^WHITE",this._ColorTable.push(s,"BOLD WHITE"),n=0;n<6;n++)for(r=0;r<6;r++)for(a=0;a<6;a++)o=`RGB${n}${r}${a}`,s="",e=0,e=n*40+55,e<16&&(s+="0"),s+=e.toString(16),e=0,e=r*40+55,e<16&&(s+="0"),s+=e.toString(16),e=0,e=a*40+55,e<16&&(s+="0"),s+=e.toString(16),s=s.toUpperCase(),this._colors[s]||(this._colors[s]=o),this.colorList.push({color:o,hex:"#"+s,rgb:{r:n*40+55,g:r*40+55,b:a*40+55}});for(n=232;n<=255;n++)r=(n-232)*10+8,r<16?r="0"+r.toString(16).toUpperCase():r=r.toString(16).toUpperCase(),r=r+r+r,n<242?this._colors[r]||(this._colors[r]="mono0"+(n-232)):this._colors[r]||(this._colors[r]="mono"+(n-232));for(a=0,c=h.length;a<c;a++)this._colors["B"+h[a]]=this._colors[this.nearestHex("#"+h[a]).substr(1)].toUpperCase();this._colors.BFFFFFF="RGB555",tinymce.activeEditor.options.set("color_map",this._ColorTable)}initPlugins(){let t=this;tinymce.PluginManager.add("pinkfishtextcolor",function(e,s){let n="#000000",r=["000000","BLACK","800000","RED","008000","GREEN","808000","ORANGE","0000EE","BLUE","800080","MAGENTA","008080","CYAN","BBBBBB","WHITE","808080","BOLD BLACK","FF0000","BOLD RED","00FF00","BOLD GREEN","FFFF00","YELLOW","5C5CFF","BOLD BLUE","FF00FF","BOLD MAGENTA","00FFFF","BOLD CYAN","FFFFFF","BOLD WHITE"],a,o=C=>{let L=C;return{get:()=>L,set:P=>{L=P}}},h=o(n),c=o(n),g=(C,L)=>{let R;return C.dom.getParents(C.selection.getStart(),S=>{let P;(P=S.style[L==="forecolor"?"color":"background-color"])&&(R=R||P)}),R},f=(C,L,R)=>{C.undoManager.transact(()=>{C.focus(),C.formatter.apply(L,{value:R}),C.nodeChanged()})},w=(C,L)=>{C.undoManager.transact(()=>{C.focus(),C.formatter.remove(L,{value:null},null,!0),C.nodeChanged()})},p=C=>{C.addCommand("mceApplyPinkfishcolor",(L,R)=>{f(C,L,R)}),C.addCommand("mceRemovePinkfishcolor",L=>{w(C,L)}),C.addCommand("mceSetPinkfishcolor",(L,R)=>{a&&(B(a,L==="forecolor"?"pinkfishforecolor":L,R),(L==="forecolor"?h:c).set(R))})},k=C=>{let L="choiceitem",R={type:L,text:"Remove color",icon:"color-swatch-remove-color",value:"remove"};return C?[R,{type:L,text:"Custom color",icon:"color-picker",value:"custom"}]:[R]},E=(C,L,R,S)=>{R==="custom"?t.openColorDialog(L,""):R==="remove"?(S(""),C.execCommand("mceRemovePinkfishcolor",L)):(S(R),C.execCommand("mceApplyPinkfishcolor",L,R))},b=C=>{let L=[];for(let R=0;R<C.length;R+=2)L.push({text:C[R+1],value:"#"+C[R],type:"choiceitem"});return L},v=(C,L)=>b(r).concat(k(L)),M=(C,L)=>R=>{R(v(C,L))},B=(C,L,R)=>{let S=L==="pinkfishforecolor"?"tox-icon-text-color__color":"tox-icon-highlight-bg-color__color";C.setIconFill(S,R)},I=(C,L,R,S,P)=>{C.ui.registry.addSplitButton(L,{tooltip:S,presets:"color",icon:L==="pinkfishforecolor"?"text-color":"highlight-bg-color",select:X=>new ne(g(C,R)||"").toHex().toLowerCase()===X.toLowerCase(),columns:5,fetch:M(r,!0),onAction:X=>{a=X,E(C,R,P.get(),()=>{})},onItemAction:(X,J)=>{a=X,E(C,R,J,G=>{P.set(G),C.fire("TextColorChange",{name:L,color:G})})},onSetup:X=>{B(X,L,P.get());let J=G=>{G.name===L&&B(X,G.name,G.color)};return C.on("TextColorChange",J),()=>{C.off("TextColorChange",J)}}})},_=(C,L,R,S)=>{C.ui.registry.addNestedMenuItem(L,{text:S,icon:L==="pinkfishforecolor"?"text-color":"highlight-bg-color",getSubmenuItems:()=>[{type:"fancymenuitem",fancytype:"colorswatch",onAction:P=>{E(C,R,P.value,()=>{})}}]})};p(e),I(e,"pinkfishforecolor","forecolor","Text color",h),I(e,"pinkfishbackcolor","hilitecolor","Background color",c),_(e,"pinkfishforecolor","forecolor","Text color"),_(e,"pinkfishbackcolor","hilitecolor","Background color")}),tinymce.PluginManager.add("pinkfish",function(e){e.addCommand("mceApplyFormat",(r,a)=>{e.undoManager.transact(()=>{e.focus(),t.clearReverse($(".reverse",$(e.getDoc()).contents())),a?e.formatter.apply(r,{value:a}):e.formatter.apply(r),t.addReverse($(".reverse",$(e.getDoc()).contents())),e.nodeChanged()})}),e.addCommand("mceRemoveFormat",r=>{e.undoManager.transact(()=>{e.focus(),t.clearReverse($(".reverse",$(e.getDoc()).contents())),e.formatter.remove(r,{value:null},null,!0),t.addReverse($(".reverse",$(e.getDoc()).contents())),e.nodeChanged()})});function s(r,a){e.on("init",()=>{e.formatter.formatChanged(a,function(o){r.setActive(o)})})}function n(r){(!r||typeof r!="string")&&(r=this.settings.format),tinymce.activeEditor.undoManager.transact(()=>{$("#tinymce",tinymce.activeEditor.getDoc()).removeClass("animate"),this.clearReverse($(".reverse",$(e.getDoc()).contents())),e.execCommand("mceToggleFormat",!1,r),this.addReverse($(".reverse",$(e.getDoc()).contents())),$("#tinymce",tinymce.activeEditor.getDoc()).addClass("animate")})}e.ui.registry.addIcon("overline",'<i class="mce-i-overline"></i>'),e.ui.registry.addIcon("dblunderline",'<i class="mce-i-dblunderline"></i>'),e.ui.registry.addIcon("flash",'<i class="mce-i-flash"></i>'),e.ui.registry.addIcon("reverse",'<i class="mce-i-reverse"></i>'),e.ui.registry.addIcon("pasteformatted",'<i class="mce-i-pasteformatted"></i>'),e.ui.registry.addIcon("copyformatted",'<i class="mce-i-copyformatted"></i>'),e.ui.registry.addSplitButton("send",{icon:"send",tooltip:"Send to mud",onAction:()=>{client.sendCommand(t.getFormattedText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close")},onItemAction:(r,a)=>{switch(a){case"formatted":client.sendCommand(t.getFormattedText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"text":client.sendCommand(t.getText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"formattednoecho":client.sendBackground(t.getFormattedText().replace(/(?:\r)/g,""),!0),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"textnoecho":client.sendBackground(t.getText().replace(/(?:\r)/g,""),!0),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"formattedverbatim":client.send(t.getFormattedText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"textverbatim":client.send(t.getText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"rawformatted":client.sendRaw(t.getFormattedText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"rawtext":client.sendRaw(t.getText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break}},fetch:r=>{r([{text:"Formatted as commands",value:"formatted",type:"choiceitem"},{text:"Text as commands",value:"text",type:"choiceitem"},{text:"Formatted as commands (No echo)",value:"formattednoecho",type:"choiceitem"},{text:"Text as commands (No echo)",value:"textnoecho",type:"choiceitem"},{text:"Formatted verbatim (No echo)",value:"formattedverbatim",type:"choiceitem"},{text:"Text verbatim (No echo)",value:"textverbatim",type:"choiceitem"},{text:"Raw formatted (No echo)",value:"rawformatted",type:"choiceitem"},{text:"Raw text (No echo)",value:"rawtext",type:"choiceitem"}])}}),e.ui.registry.addButton("append",{icon:"browse",tooltip:"Append file...",onAction:()=>t.appendFile()}),e.ui.registry.addButton("clear",{icon:"remove",tooltip:"Clear",onAction:()=>t.clear()}),e.ui.registry.addButton("pasteformatted",{icon:"pasteformatted",tooltip:"Paste formatted",onAction:r=>{pt().then(a=>{t.insertFormatted(a||"")}).catch(a=>{client.enableDebug&&client.debug(a),a.message&&a.message==="Permission not granted!"?alert("Paste permission not granted."):alert("Paste not supported.")})}}),e.ui.registry.addButton("pasteastext",{icon:"paste-text",tooltip:"Paste as text",onAction:r=>{pt().then(a=>{tinymce.activeEditor.execCommand("mceInsertContent",!1,(a||"").replace(/(\r\n|\r|\n)/g,"<br/>").replaceAll("  ","&nbsp;&nbsp;"))}).catch(a=>{client.enableDebug&&client.debug(a),a.message&&a.message==="Permission not granted!"?alert("Paste permission not granted."):alert("Paste not supported.")})}}),e.ui.registry.addButton("copyformatted",{icon:"copyformatted",tooltip:"Copy formatted",onAction:r=>Oe(t.getFormattedSelection().replace(/(?:\r)/g,""))}),e.ui.registry.addToggleButton("overline",{icon:"overline",tooltip:"Overline",format:"overline",onAction:r=>n("overline"),onSetup:r=>s(r,"overline")}),e.ui.registry.addToggleButton("dblunderline",{icon:"dblunderline",tooltip:"Double Underline",format:"dblunderline",onAction:r=>n("dblunderline"),onSetup:r=>s(r,"dblunderline")}),e.ui.registry.addToggleButton("flash",{tooltip:"Flash",format:"flash",icon:"flash",onAction:r=>n("flash"),onSetup:r=>s(r,"flash")}),e.ui.registry.addToggleButton("reverse",{icon:"reverse",tooltip:"Reverse",format:"reverse",onAction:r=>n("reverse"),onSetup:r=>s(r,"reverse")}),e.ui.registry.addMenuItem("style",{text:"Style",menu:[{image:"overline",text:"Overline",format:"overline",onclick:n,onpostrender:s},{image:"dblunderline",text:"Double Underline",format:"dblunderline",onclick:n,onpostrender:s},{text:"Flash",format:"flash",image:"flash",onclick:n,onpostrender:s},{image:"reverse",text:"Reverse",format:"reverse",onclick:n,onpostrender:s}]}),e.ui.registry.addMenuItem("overline",{image:"overline",text:"Overline",format:"overline",onclick:n,onpostrender:s}),e.ui.registry.addMenuItem("dblunderline",{image:"dblunderline",text:"Double Underline",format:"dblunderline",onclick:n,onpostrender:s}),e.ui.registry.addMenuItem("flash",{text:"Flash",format:"flash",image:"flash",onclick:n,onpostrender:s}),e.ui.registry.addMenuItem("reverse",{image:"reverse",text:"Reverse",format:"reverse",onclick:n,onpostrender:s}),e.on("Change",()=>{t.addReverse($(".reverse",$(e.getDoc()).contents()))}),e.addShortcut("ctrl+s","Strikethrough",()=>{n("strikethrough")}),e.addShortcut("ctrl+o","Overline",()=>{n("overline")}),e.addShortcut("ctrl+d","Double Underline",()=>{n("dblunderline")}),e.addShortcut("ctrl+f","Flash",()=>{n("flash")}),e.addShortcut("ctrl+r","Reverse",()=>{n("reverse")})})}clearReverse(t,e){t.each(function(){if($(this).data("reverse")&&!(e&&$(this).hasClass("reverse"))){var s,n;e?(s=$(this).css("color"),n=$(this).css("background-color")):(n=$(this).parent().css("color"),s=$(this).parent().css("background-color")),s==="black"&&(s=""),n==="rgba(0, 0, 0, 0)"&&(n="black"),$(this).css("color",n),$(this).css("background-color",s),$(this).children().length&&this.clearReverse($(this).children(),!0)}})}addReverse(t,e){t.each(function(){if(!(e&&$(this).hasClass("reverse"))){var s,n;e?(s=$(this).css("color"),n=$(this).css("background-color")):(s=$(this).parent().css("color"),n=$(this).parent().css("background-color")),s==="rgba(0, 0, 0, 0)"&&(s="black"),n==="rgba(0, 0, 0, 0)"&&(n="black"),$(this).children().length&&(this.clearReverse($(this).children(),!0),this.addReverse($(this).children(),!0)),$(this).css("color",n),$(this).css("background-color",s),$(this).data("reverse",!0)}})}colorCell(t,e){var s='<td class="mce-grid-cell'+(t==="transparent"?" mce-colorbtn-trans":"")+'">';return s+='<div id="'+e+'"',s+=' data-mce-color="'+t+'"',s+=' role="option"',s+=' tabIndex="-1"',s+=' style="background-color: '+(t==="transparent"?t:"#"+t)+'"',this.colorNames[e]?s+=' title="'+e+", "+this.colorNames[e]+'">':s+=' title="'+e+'">',t==="transparent"&&(s+="&#215;"),s+="</div>",s+="</td>",s}openColorDialog(t,e){if(!this._colorDialog){this._colorDialog=new ve({noFooter:!0,title:'<i class="fas fa-palette"></i> Pick color',center:!0,resizable:!1,moveable:!1,maximizable:!1,width:380,height:340}),this._colorDialog.body.style.alignItems="center",this._colorDialog.body.style.display="flex";let r,a,o,h,c,g;var s='<table style="margin : auto !important;" class="mce-grid mce-grid-border mce-colorbutton-grid" role="list" cellspacing="0"><tbody><tr>';for(r=0,a=this._ColorTable.length;r<a;r+=2)s+=this.colorCell(this._ColorTable[r],this._ColorTable[r+1]),r/2%6===5&&(s+='<td class="mce-grid-cell"></td>');s+='<td class="mce-grid-cell"></td>',s+=this.colorCell("transparent","No color"),s+="</tr><tr><td></td></tr>";var n="";for(o=0;o<6;o++){for(h<3?s+="<tr>":n+="<tr>",h=0;h<6;h++){for(c=0;c<6;c++)g=`RGB${o}${h}${c}`,e="",r=0,r=o*40+55,r<16&&(e+="0"),e+=r.toString(16),r=0,r=h*40+55,r<16&&(e+="0"),e+=r.toString(16),r=0,r=c*40+55,r<16&&(e+="0"),e+=r.toString(16),e=e.toUpperCase(),h<3?s+=this.colorCell(e,g):n+=this.colorCell(e,g);h===2?s+="</tr>":h<3?s+='<td class="mce-grid-cell"></td>':h<5&&(n+='<td class="mce-grid-cell"></td>')}h<3?s+="</tr>":n+="</tr>"}for(s+=n,s+="<tr><td></td></tr><tr>",o=232;o<=255;o++)h=(o-232)*10+8,h<16?h="0"+h.toString(16).toUpperCase():h=h.toString(16).toUpperCase(),h=h+h+h,s+=this.colorCell(h,e),(o===237||o===249)&&(s+='<td class="mce-grid-cell"></td>'),o===243&&(s+="</tr><tr>");s+="</tr></tbody></table>",s+=`<style>
.mce-colorbtn-trans div {line-height: 14px;overflow: hidden;}
.mce-grid td.mce-grid-cell div{border:1px solid #c5c5c5;width:15px;height:15px;margin:0;cursor:pointer}.mce-grid td.mce-grid-cell div:focus{border-color:#91bbe9}.mce-grid td.mce-grid-cell div[disabled]{cursor:not-allowed}            
.mce-grid{border-spacing:2px;border-collapse:separate}.mce-grid a{display:block;border:1px solid transparent}.mce-grid a:hover,.mce-grid a:focus{border-color:#91bbe9}.mce-grid-border{margin:0 4px 0 4px}.mce-grid-border a{border-color:#c5c5c5;width:13px;height:13px}.mce-grid-border a:hover,.mce-grid-border a.mce-active{border-color:#91bbe9;background:#bdd6f2}            
            </style>`,this._colorDialog.body.innerHTML=s;let f=this._colorDialog.body.querySelectorAll("div");for(r=0,a=f.length;r<a;r++)f[r].addEventListener("click",w=>{e=w.currentTarget.dataset.mceColor,e==="transparent"?tinymce.activeEditor.execCommand("mceRemoveFormat",this._colorDialog.dialog.dataset.type):tinymce.activeEditor.execCommand("mceApplyFormat",this._colorDialog.dialog.dataset.type,"#"+e),tinymce.activeEditor.execCommand("mceSetTextcolor",this._colorDialog.dialog.dataset.type,"#"+e),this._colorDialog.close()})}this._colorDialog.dialog.dataset.type=t,this._colorDialog.showModal()}appendFile(){ge("Append file(s)",!0).then(t=>{for(var e=0,s=t.length;e<s;e++)be(t[e]).then(n=>{this.insert(n)}).catch(client.error)}).catch(()=>{})}insertFormatted(t){this.isSimple?Ke(this._element,t):tinymce.activeEditor.execCommand("insertHTML",!1,pi(t).replace(/(\r\n|\r|\n)/g,"<br/>"))}setFormatted(t){this.isSimple?this._element.value=t:tinymce.activeEditor.getBody().innerHTML=pi(t).replace(/(\r\n|\r|\n)/g,"<br/>")}buildHTMLStack(t){for(var e,s,n,r,a=[],o,h=0,c=t.length;h<c;h++)if(s=$(t[h]),e=s.prop("tagName"),e==="EM"||e==="I"?e="ITALIC":(e==="STRONG"||e==="B")&&(e="BOLD"),!e)a.push('"'+s.text()+'"');else if(e==="SPAN"){if(o=[],t[h].className!="")for(e=t[h].className.toUpperCase().split(/\s+/g),r=e.length,n=0;n<r;n++)e[n]==="NOFLASH"?o.push("FLASH"):e[n].length>0&&o.push(e[n]);if(s.css("text-decoration")==="line-through"&&o.push("STRIKEOUT"),s.css("text-decoration")==="underline"&&o.push("UNDERLINE"),s.data("mce-style"))for(e=s.data("mce-style").toUpperCase().split(";"),r=e.length,n=0;n<r;n++)e[n].endsWith("INHERIT")||e[n].endsWith("BLACK")||(e[n]=e[n].trim(),e[n]=e[n].replace("BACKGROUND:","BACKGROUND-COLOR:"),e[n].length>0&&o.push(e[n]));else if(s.css("color")||s.css("background-color")||s.css("background"))for(e=[],s.css("color")&&e.push("COLOR: "+new ne(s.css("color")).toHex().toUpperCase()),s.css("background-color")&&e.push("BACKGROUND-COLOR: "+new ne(s.css("background-color")).toHex().toUpperCase()),s.css("background")&&e.push("BACKGROUND-COLOR: "+new ne(s.css("background")).toHex().toUpperCase()),r=e.length,n=0;n<r;n++)e[n].length>0&&o.push(e[n].trim());for(r=o.length,n=0;n<r;n++)o[n].length&&a.push(o[n].trim());for(a=a.concat(this.buildHTMLStack(s.contents())),n=r-1;n>=0;n--)o[n].length&&a.push("/"+o[n].trim())}else e=="BR"&&s.data("mce-bogus")?a.push("RESET"):(a.push(e),a=a.concat(this.buildHTMLStack(s.contents())),a.push("/"+e));return a}getFormattedSelection(){for(var t=tinymce.activeEditor.dom.getParents(tinymce.activeEditor.selection.getNode()),e=0,s=t.length,n="<html>",r="</html>";e<s;e++){var a=t[e].tagName;if(a==="EM"||a==="I"||a==="STRONG"||a==="B")n+="<"+a+">",r="</"+a+">"+r;else if(a==="SPAN"){n+="<"+a,t[e].className!=""&&(n+=' class="'+t[e].className+'"');var o="";t[e].style.textDecoration!=""&&(o+="text-decoration:"+t[e].style.textDecoration+";"),t[e].style.color!=""&&(o+="color:"+t[e].style.color+";"),t[e].style.background!=""&&(o+="background:"+t[e].style.background+";"),t[e].style.backgroundColor!=""&&(o+="background-color:"+t[e].style.backgroundColor+";"),o.length>0&&(n+=' style="'+o+'"'),t[e].dataset&&t[e].dataset.mceStyle&&(n+=' data-mce-style="'+t[e].dataset.mceStyle+'"'),n+=" >",r="</"+a+">"+r}else if(a==="BODY"){n+="<"+a+">",r="</"+a+">"+r;break}}return this.formatHtml($(n+tinymce.activeEditor.selection.getContent({format:"raw"}).replace(/<\/div><div>/g,"<br>")+r))}getFormattedText(){return this.isSimple?this._element.value:this.formatHtml($("<html>"+this.getRaw()+"</html>"))}getText(){return this.isSimple?this._element.value:tinymce.activeEditor.getContent({format:"text"})}getHTML(){return this.isSimple?this._element.value:tinymce.activeEditor.getContent({format:"html"})}getRaw(){return this.isSimple?this._element.value:tinymce.activeEditor.getContent({format:"raw"})}formatHtml(t){var e=this.buildHTMLStack(t),s=[],n=[],r,a,o,h;for(a=e.length-1;a>=0&&(!e[a].startsWith('"')&&e[a]!="BR"&&e[a]!="RESET");a--)e.pop();for(e[0]==="DIV"&&e.shift(),a=0,o=e.length;a<o;a++)switch(e[a]){case"BOLD":case"ITALIC":case"UNDERLINE":case"STRIKEOUT":case"DBLUNDERLINE":case"OVERLINE":case"FLASH":case"REVERSE":n.push("%^"+e[a]+"%^"),s.push("%^"+e[a]+"%^");break;case"/DBLUNDERLINE":case"/OVERLINE":case"/FLASH":case"/REVERSE":case"/UNDERLINE":case"/BOLD":case"/ITALIC":case"/STRIKEOUT":n.pop(),this.cleanReset(s),s.push("%^RESET%^"),n.length>0&&s.push(n.join(""));break;case"SPAN":case"/SPAN":case"/BR":case"/DIV":break;case"DIV":case"BR":n.length>0&&s.length>0&&!s[s.length-1].endsWith("%^RESET%^")&&(this.cleanReset(s),s.push("%^RESET%^")),s.push(`
`),n.length>0&&s.push(n.join(""));break;case"RESET":n.length>0&&s.length>0&&!s[s.length-1].endsWith("%^RESET%^")&&(this.cleanReset(s),s.push("%^RESET%^")),n.length>0&&s.push(n.join(""));break;default:e[a].startsWith("COLOR: #")?(r=e[a].substr(8),this._colors[r]||(h=new ne(r),r=this.nearestHex(h.toHex()).substr(1)),r=this._colors[r],(r==="BOLD BLACK"||r==="BOLD%^%^BLACK")&&(r="mono11"),n.push("%^"+r+"%^"),s.push("%^"+r+"%^")):e[a].startsWith("COLOR: ")?(r=new ne(e[a].substr(7)).toHex().substr(1),this._colors[r]||(r=this.nearestHex("#"+r).substr(1)),r=this._colors[r],(r==="BOLD BLACK"||r==="BOLD%^%^BLACK")&&(r="mono11"),n.push("%^"+r+"%^"),s.push("%^"+r+"%^")):e[a].startsWith("/COLOR: ")?(n.pop(),this.cleanReset(s),s.push("%^RESET%^"),n.length>0&&s.push(n.join(""))):e[a].startsWith("BACKGROUND-COLOR: #")?(r=e[a].substr(19),this._colors[r]||(h=new ne(r),r=this.nearestHex(h.toHex()).substr(1)),this._colors["B"+r]?r=this._colors["B"+r]:r=this._colors[r],r="%^B_"+r+"%^",n.push(r),s.push(r)):e[a].startsWith("BACKGROUND-COLOR: ")?(r=new ne(e[a].substr(18)).toHex().substr(1),this._colors[r]||(r=this.nearestHex("#"+r).substr(1)),this._colors["B"+r]?r=this._colors["B"+r]:r=this._colors[r],r="%^B_"+r+"%^",n.push(r),s.push(r)):e[a].startsWith("/BACKGROUND-COLOR: ")?(n.pop(),this.cleanReset(s),s.push("%^RESET%^"),n.length>0&&s.push(n.join(""))):e[a].startsWith('"')&&s.push(e[a].substring(1,e[a].length-1));break}return s.join("")}cleanReset(t){let e=t.length-1;for(;e>=0;e--)if(t[e].startsWith("%^"))t.pop();else return t;return t}nearestHex(t){var e=this,s=function(r){var a=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;r=r.replace(a,function(g,f,w,p){return[f,f,w,w,p,p].join()});var o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?/i,h=o.exec(r),c=h?{r:parseInt(h[1],16),g:parseInt(h[2],16),b:parseInt(h[3],16)}:null;return c},n=function(r){if(!r)throw new Error("The hex you provided is not formatted correctly. Please try in a format such as '#FFF' or '#DDFFDD'.");for(var a=Number.MAX_SAFE_INTEGER,o=null,h=0;h<e.colorList.length;h++){var c=e.colorList[h],g=Math.sqrt(Math.pow(r.r-c.rgb.r,2)+Math.pow(r.g-c.rgb.g,2)+Math.pow(r.b-c.rgb.b,2));g<a&&(a=g,o=c.hex)}return o};return n(s(t))}remove(){tinymce.remove(`#${this._element.id}`)}initialize(){this.isSimple||(this.initPlugins(),tinymce.init({license_key:"gpl",custom_colors:!1,selector:`textarea#${this._element.id}`,height:500,menubar:!1,browser_spellcheck:!0,resize:!0,statusbar:!1,nowrap:!0,force_br_newlines:!0,forced_root_block:"div",plugins:"pinkfish insertdatetime pinkfishtextcolor nonbreaking",color_picker_callback:(t,e,s)=>{this.openColorDialog(s,e||"")},color_picker_caption:"More&hellip;",textcolor_rows:"3",textcolor_cols:"8",toolbar:"send | append | undo redo | pinkfishforecolor pinkfishbackcolor | italic underline strikethrough overline dblunderline flash reverse | clear | copy copyformatted | insertdatetime",toolbar_mode:"sliding",content_css:"css/tinymce.content.min.css",formats:{bold:{inline:"strong",exact:!0,links:!0,remove_similar:!0},italic:{inline:"em",exact:!0,links:!0,remove_similar:!0},overline:{inline:"span",classes:"overline",links:!0,remove_similar:!0},dblunderline:{inline:"span",classes:"dblunderline",links:!0,remove_similar:!0},flash:{inline:"span",classes:"flash",links:!0,remove_similar:!0},reverse:{inline:"span",classes:"reverse",links:!0,remove_similar:!0},underline:{inline:"span",classes:"underline",links:!0,remove_similar:!0},strikethrough:{inline:"span",classes:"strikeout",links:!0,remove_similar:!0}},init_instance_callback:t=>{t.shortcuts.add("ctrl+shift+c","Copy formatted",()=>Oe(this.getFormattedSelection().replace(/(?:\r)/g,""))),t.on("PastePreProcess",e=>{client.getOption("enableDebug")&&client.debug("Advanced Before Editor PastePreProcess: "+e.content),this.clearReverse($(".reverse",$(t.getDoc()).contents())),e.content=e.content.replace(/<\/p>/g,"<br>"),e.content=e.content.replace(/<\/h[1-6]>/g,"<br>"),e.content=e.content.replace(/<\/li>/g,"<br>"),e.content=e.content.replace(/ background: #000000;/g,""),e.content=e.content.replace(/background: #000000;/g,""),e.content=e.content.replace(/ background-color: #000000;/g,""),e.content=e.content.replace(/background-color: #000000;/g,""),e.content=e.content.replace(/ color: #BBBBBB;/g,""),e.content=e.content.replace(/color: #BBBBBB;/g,"");for(var s=/<pre(.*?)>((.|\s)*)<\/pre>/mgi,n;(n=s.exec(e.content))!==null;)n.index===s.lastIndex&&s.lastIndex++,e.content=e.content.substring(0,n.index)+e.content.substring(n.index,s.lastIndex).replace(/(\r\n|\r|\n)/g,"<br/>").replaceAll("  ","&nbsp;&nbsp;")+e.content.substring(s.lastIndex);client.getOption("enableDebug")&&client.debug("Advanced After Editor PastePreProcess: "+e.content)}),t.on("PastePreProcess",()=>{this.addReverse($(".reverse",$(t.getDoc()).contents()))}),$(".mce-content-body",tinymce.activeEditor.getDoc()).css("font-size",client.getOption("cmdfontSize")),$(".mce-content-body",tinymce.activeEditor.getDoc()).css("font-family",client.getOption("cmdfont")+", monospace"),tinymce.activeEditor.formatter?tinymce.activeEditor.formatter.register("flash",{inline:"span",classes:client.getOption("flashing")?"flash":"noflash",links:!0,remove_similar:!0}):tinymce.activeEditor.settings.formats.flash={inline:"span",classes:client.getOption("flashing")?"flash":"noflash",links:!0,remove_similar:!0},this.loadColors(),this.setFormatted(this._element.value),t.on("click",e=>{this.emit("click",e)}),this.emit("editor-init"),this._init=!0},paste_data_images:!1,paste_webkit_styles:"color background background-color text-decoration",valid_elements:"strong/b,em/i,u,span[style|class],strike/s,br",valid_styles:{"*":"color,background,background-color,text-decoration,font-weight"},color_map:this._ColorTable}))}focus(){this.isSimple?this._element.focus():this._init&&tinymce.activeEditor&&tinymce.activeEditor.initialized&&tinymce.activeEditor.focus()}};var Zt=class m extends ve{constructor(){super({title:'<i class="fas fa-cogs"></i> Settings',keepCentered:!0,resizable:!1,moveable:!1,center:!0,maximizable:!1}),this.body.style.padding="10px",this.buildMenu();let u="";u+=`<button id="${this.id}-cancel" type="button" class="btn-sm float-end btn btn-light" title="Cancel dialog"><i class="bi bi-x-lg"></i><span class="icon-only"> Cancel</span></button>`,u+=`<button id="${this.id}-save" type="button" class="btn-sm float-end btn btn-primary" title="Confirm dialog"><i class="bi bi-save"></i><span class="icon-only"> Save</span></button>`,u+=`<button id="${this.id}-reset" type="button" class="btn-sm float-start btn btn-light" title="Reset settings"><i class="bi bi-arrow-clockwise"></i><span class="icon-only"> Reset</span></button>`,u+=`<button id="${this.id}-reset-all" type="button" class="btn-sm float-start btn btn-light" title="Reset All settings"><i class="bi bi-arrow-repeat"></i><span class="icon-only"> Reset All</span></button>`,u+='<div class="vr float-start" style="margin-right: 4px;height: 29px;"></div>',u+=`<button id="${this.id}-export" type="button" class="btn-sm float-start btn btn-light" title="Export settings"><i class="bi bi-box-arrow-up"></i><span class="icon-only"> Export</span></button>`,u+=`<button id="${this.id}-import" type="button" class="btn-sm float-start btn btn-light" title="Import settings"><i class="bi bi-box-arrow-in-down"></i><span class="icon-only"> Import</span></button>`,this.footer.innerHTML=u,this.footer.querySelector(`#${this.id}-cancel`).addEventListener("click",()=>{we(this._page),this.close()}),this.footer.querySelector(`#${this.id}-export`).addEventListener("click",()=>{var t=$e(this.settings);t.version=2,fileSaveAs.show(JSON.stringify(t),"oiMUD.settings.txt","text/plain")}),this.footer.querySelector(`#${this.id}-import`).addEventListener("click",()=>{ge("Import settings").then(t=>{be(t[0]).then(e=>{try{var s=JSON.parse(e),n,r;if(s.version===1){for(n=0,r=ee.length;n<r;n++)this.settings[ee[n][0]]=s[ee[n][0]];this.emit("import-rooms",s.rooms)}else if(s.version===2&&!s.profiles)for(n=0,r=ee.length;n<r;n++)this.settings[ee[n][0]]=s[ee[n][0]];else setTimeout(function(){new wt("Invalid file","Unable to import file, not a valid settings file",4).showModal()},50);this.loadPageSettings()}catch(a){setTimeout(function(){new wt("Error importing","Error importing file.",3).showModal()},50),client.error(a)}}).catch(client.error)}).catch(()=>{})}),this.footer.querySelector(`#${this.id}-reset`).addEventListener("click",()=>{if(this._page==="settings-colors"){let t=new st("Reset colors","Reset colors?");t.on("button-click",e=>{if(e.button===4){var s,n=this.settings.colors=[];for(s=0;s<16;s++)this.setColor("color"+s,n[s]||this.getDefaultColor(s));for(s=256;s<280;s++)this.setColor("color"+s,n[s]||this.getDefaultColor(s));this.body.querySelector("#colorScheme").value=0}}),t.showModal()}else if(this._page&&this._page!=="settings"&&this._page.length){let t=this._page.split("-"),e=ke(t[t.length-1].match(/([A-Z]|^[a-z])[a-z]+/g).join(" ")),s=new st(`Reset ${e} settings`,`Reset ${e} settings?`);s.on("button-click",n=>{if(n.button===4){let r=this.body.querySelectorAll("input,select,textarea");for(let a=0,o=r.length;a<o;a++)this.settings[r[a].id]=Fe.defaultValue(r[a].id),r[a].type==="checkbox"?r[a].checked=this.settings[r[a].id]:r[a].value=this.settings[r[a].id]}}),s.showModal()}else{let t=new st("Reset all settings","Reset all settings?");t.on("button-click",e=>{e.button===4&&this.settings.reset()}),t.showModal()}}),this.footer.querySelector(`#${this.id}-reset-all`).addEventListener("click",()=>{let t=new st("Reset all settings","Reset all settings?");t.on("button-click",e=>{e.button===4&&this.settings.reset()}),t.showModal()}),this.footer.querySelector(`#${this.id}-save`).addEventListener("click",()=>{we(this._page);for(var t in this.settings)this.settings.hasOwnProperty(t)&&Fe.setValue(t,this.settings[t]);client.clearCache(),client.loadOptions(),this.close()}),this.settings=new Fe,this.on("closed",()=>{we(this._page)}),this.on("canceled",()=>{we(this._page)})}setBody(u,t){super.setBody(this.dialog.dataset.path==="settings"?m.menuTemplate:u,t),this._page=this.dialog.dataset.path;let e=this._page.split("-"),s="",n=e.length-1;e.length===1?s+='<li><i class="float-start fas fa-cogs" style="padding: 2px;margin-right: 2px;"></i></li>':s+='<li><a href="#'+e.slice(0,1).join("-")+'"><i class="float-start fas fa-cogs" style="padding: 2px;margin-right: 2px;"></i></a></li>';for(let r=0,a=e.length;r<a;r++){let o=ke(e[r].match(/([A-Z]|^[a-z])[a-z]+/g).join(" "));r===n?s+='<li class="breadcrumb-item active">'+o+"</li>":s+='<li class="breadcrumb-item" aria-current="page"><a href="#'+e.slice(0,r+1).join("-")+'">'+o+"</a></li>"}this.title='<ol class="float-start breadcrumb">'+s+"</ol>",this._page==="settings"?(this._menu&&(this._menu.style.display="none"),this.body.style.left="",this.footer.querySelector(`#${this.id}-reset`)&&(this.footer.querySelector(`#${this.id}-reset`).style.display="none"),m.addPlugins(this.body.querySelector("div.contents"))):(this._menu&&(this._menu.style.display=""),this.footer.querySelector(`#${this.id}-reset`)&&(this.footer.querySelector(`#${this.id}-reset`).style.display=""),this.body.style.left="200px"),this.body.scrollTop=0,this.loadPageSettings()}buildMenu(){this.dialog.insertAdjacentHTML("beforeend",m.menuTemplate.replace(' style="top:0;position: absolute;left:0;bottom:49px;right:0;"',"")),this._menu=this.dialog.querySelector(".contents"),this._menu.classList.add("settings-menu"),m.addPlugins(this._menu),this._page==="settings"&&(this._menu.style.display="none"),this.body.style.left="200px"}loadPageSettings(){let u=this.body.querySelectorAll("input,select,textarea");if(this._page==="settings-colors"){var t,e=this.settings.colors||[];for(t=0;t<16;t++)this.setColor("color"+t,e[t]||this.getDefaultColor(t));for(t=256;t<280;t++)this.setColor("color"+t,e[t]||this.getDefaultColor(t));for(let s=0,n=u.length;s<n;s++)u[s].addEventListener("change",r=>{let a=r.currentTarget||r.target,o=a.value,h=parseInt(a.id.substring(5),10);var c=this.settings.colors||[];!c[h]||c[h].length===0?this.getDefaultColor(h)!==o&&(c[h]=o):this.getDefaultColor(h)!==o?delete c[h]:c[h]=o,this.settings.colors=c}),u[s].addEventListener("input",r=>{let a=r.currentTarget||r.target,o=a.value,h=parseInt(a.id.substring(5),10);!this.settings.colors[h]||this.settings.colors[h].length===0?this.getDefaultColor(h)!==o&&(this.settings.colors[h]=o):this.getDefaultColor(h)!==o?delete this.settings.colors[h]:this.settings.colors[h]=o})}else for(let s=0,n=u.length;s<n;s++)if(u[s].type==="radio")u[s].checked=""+this.settings[u[s].name]===u[s].value,u[s].addEventListener("change",r=>{let a=r.currentTarget||r.target;a.checked&&(this.settings[a.name]=this.convertType(a.value,typeof this.settings[a.name]))});else if(u[s].type==="checkbox"){if(u[s].dataset.enum==="true"){let r=u[s].name||u[s].id.substring(0,u[s].id.lastIndexOf("-")),a=+u[s].id.substring(u[s].id.lastIndexOf("-")+1);u[s].checked=(this.settings[r]&a)===a}else u[s].checked=this.settings[u[s].id];u[s].addEventListener("change",r=>{let a=r.currentTarget||r.target;if(a.dataset.enum==="true"){let o=a.name||a.id.substring(0,a.id.lastIndexOf("-")),h=this.body.querySelectorAll(`[name=${o}]`),c=0;for(let g=0,f=h.length;g<f;g++)h[g].checked&&(c|=+h[g].value);this.settings[o]=c}else this.settings[a.id]=a.checked||!1})}else u[s].value=this.settings[u[s].id],u[s].addEventListener("change",r=>{let a=r.currentTarget||r.target;this.setValue(a.id,a.value)}),u[s].addEventListener("input",r=>{let a=r.currentTarget||r.target;this.setValue(a.id,a.value)})}setColor(u,t){!t||typeof t>"u"||t.length===0?this.body.querySelector("#"+u).value="":this.body.querySelector("#"+u).value=this.colorHex(t)}colorHex(u){return u?(u=new ne(u),u.ok?u.toHex():""):!1}getDefaultColor(u){return u===0?"rgb(0,0,0)":u===1?"rgb(128, 0, 0)":u===2?"rgb(0, 128, 0)":u===3?"rgb(128, 128, 0)":u===4?"rgb(0, 0, 128)":u===5?"rgb(128, 0, 128)":u===6?"rgb(0, 128, 128)":u===7?"rgb(192, 192, 192)":u===8?"rgb(128, 128, 128)":u===9?"rgb(255, 0, 0)":u===10?"rgb(0, 255, 0)":u===11?"rgb(255, 255, 0)":u===12?"rgb(0, 0, 255)":u===13?"rgb(255, 0, 255)":u===14?"rgb(0, 255, 255)":u===15?"rgb(255, 255, 255)":u===256?"rgb(0, 0, 0)":u===257?"rgb(118, 0, 0)":u===258?"rgb(0, 108, 0)":u===259?"rgb(145, 136, 0)":u===260?"rgb(0, 0, 108)":u===261?"rgb(108, 0, 108)":u===262?"rgb(0, 108, 108)":u===263?"rgb(160, 160, 160)":u===264?"rgb(0, 0, 0)":u===265?"rgb(128, 0, 0)":u===266?"rgb(0, 128, 0)":u===267?"rgb(128, 128, 0)":u===268?"rgb(0, 0, 128)":u===269?"rgb(128, 0, 128)":u===270?"rgb(0, 128, 128)":u===271?"rgb(192, 192, 192)":u===272?"rgb(0,0,0)":u===273?"rgb(0, 255, 255)":u===274?"rgb(0,0,0)":u===275?"rgb(255, 255, 0)":u===276?"rgb(0, 0, 0)":u===277?"rgb(192, 192, 192)":u===278?"rgb(128, 0, 0)":u===279?"rgb(192, 192, 192)":u===280?"rgb(255,255,255)":""}setValue(u,t){t=="false"&&(t=!1),t=="true"&&(t=!0),t=="null"&&(t=null),t=="undefined"&&(t=void 0),typeof t=="string"&&parseFloat(t).toString()==t&&(t=parseFloat(t)),this.settings[u]=this.convertType(t,typeof this.settings[u])}convertType(u,t){if(typeof u===t)return u;switch(t){case"number":return typeof u=="string"&&parseFloat(u).toString()==u?parseFloat(u):Number(u);case"boolean":return!!u;case"string":return""+u}return u}static addPlugins(u){let t=client.plugins.length,e,s;for(let n=0;n<t;n++)if(client.plugins[n].settings&&client.plugins[n].settings.length)for(s=client.plugins[n].settings.length,e=0;e<s;e++){let r=client.plugins[n].settings[e];if(typeof r.action!="string")continue;let a=`<a href="#${r.action}" class="list-group-item list-group-item-action">${r.icon||""}${r.name||""}</a>`;if("position"in r){if(typeof r.position=="string"){if(u.querySelector(r.position)){u.querySelector(r.position).insertAdjacentHTML("afterend",a);continue}}else if(r.position>=0&&r.position<u.children.length){u.children[r.position].insertAdjacentHTML("afterend",a);continue}}u.insertAdjacentHTML("beforeend",a)}}static get menuTemplate(){return'<div class="contents list-group list-group-flush" style="top:0;position: absolute;left:0;bottom:49px;right:0;"><a href="#settings-general" class="list-group-item list-group-item-action"><i class="fas fa-cogs"></i> General</a><a href="#settings-display" class="list-group-item list-group-item-action"><i class="fas fa-display"></i> Display</a><a href="#settings-colors" class="list-group-item list-group-item-action"><i class="fas fa-palette"></i> Colors</a><a href="#settings-commandLine" class="list-group-item list-group-item-action"><i class="fas fa-terminal"></i> Command line</a><a href="#settings-tabCompletion" class="list-group-item list-group-item-action"><i class="fa-solid fa-arrow-right-to-bracket"></i> Tab completion</a><a href="#settings-telnet" class="list-group-item list-group-item-action"><i class="fas fa-network-wired"></i> Telnet</a><a href="#settings-scripting" class="list-group-item list-group-item-action"><i class="fas fa-code"></i> Scripting</a><a href="#settings-specialCharacters" class="list-group-item list-group-item-action"><i class="fa-regular fa-file-code"></i> Special characters</a><a href="#settings-advanced" class="list-group-item list-group-item-action"><i class="fa-solid fa-sliders"></i> Advanced</a></div>'}};var _t=class extends pe{constructor(t){super();this.$panel1MinSize=200;this.$panel2MinSize=200;this.$splitterWidth=4;this.$splitterDistance=200;this.$dragging=!1;this.$collapsed=0;this.live=!0;t&&t.id&&(this.$id=t.id),t&&(this.$panel1=t.panel1,this.$panel2=t.panel2),t&&t.container?this.parent=t.container.container?t.container.container:t.container:t&&t.parent?this.parent=t.parent:this.parent=document.body,t?("anchor"in t?this.$anchor=t.anchor:this.$anchor=2,this.orientation=t.orientation||0):(this.$anchor=2,this.orientation=0)}hide(){this.$el.style.display="none"}show(){this.$el.style.display=""}get id(){return this.$id||this.parent.id}set id(t){t!==this.$id&&(this.$id=t,this.$el.id=this.id+"-splitter",this.$panel1.id=this.id+"-splitter-panel1",this.$panel2.id=this.id+"-splitter-panel2",this.$dragBar.id=this.id+"-splitter-drag-bar",this.$ghostBar&&(this.$ghostBar.id=this.id+"-ghost-bar"))}set parent(t){typeof t=="string"?t.startsWith("#")?this.$parent=document.getElementById(t.substr(1)):this.$parent=document.getElementById(t):t instanceof $?this.$parent=t[0]:t instanceof HTMLElement&&(this.$parent=t),this.$parent||(this.$parent=document.body),this.createControl()}get parent(){return this.$parent}get panel1(){return this.$panel1}get panel2(){return this.$panel2}get anchor(){return this.$anchor}set anchor(t){this.$anchor!==t&&(this.$anchor=2,this.updatePanels())}set SplitterDistance(t){this.$splitterDistance!==t&&(this.$splitterDistance=t,this.updatePanels(),this.emit("splitter-moved",t))}get SplitterDistance(){return this.$splitterDistance}set Panel1MinSize(t){this.$panel1MinSize!==t&&(this.$panel1MinSize=t,this.$orientation===0?this.$panel1.clientWidth<t&&(this.$splitterDistance=this.parent.clientWidth-this.$panel1MinSize):this.$panel1.clientHeight<t&&(this.$splitterDistance=this.parent.clientHeight-this.$panel1MinSize),this.updatePanels())}get Panel1MinSize(){return this.$panel1MinSize}set Panel2MinSize(t){this.$panel2MinSize!==t&&(this.$panel2MinSize=t,this.$orientation===0?this.$panel2.clientWidth<t&&(this.$splitterDistance=t):this.$panel2.clientHeight<t&&(this.$splitterDistance=t),this.updatePanels())}get Panel2MinSize(){return this.$panel2MinSize}get orientation(){return this.$orientation}set orientation(t){t!==this.$orientation&&(this.$orientation=t,this.updatePanels())}get panel1Collapsed(){return this.$collapsed===1}set panel1Collapsed(t){if(t){if(this.$collapsed===1)return;this.$collapsed=1,this.panel1.dataset.collapsed="true",this.panel2.dataset.collapsed="false",this.emit("collapsed",1),this.updatePanels()}else this.$collapsed===1&&(this.$collapsed=0,delete this.panel1.dataset.collapsed,delete this.panel2.dataset.collapsed,this.emit("collapsed",0),this.updatePanels())}get panel2Collapsed(){return this.$collapsed===2}set panel2Collapsed(t){if(t){if(this.$collapsed===2)return;this.$collapsed=2,this.panel1.dataset.collapsed="false",this.panel2.dataset.collapsed="true",this.emit("collapsed",2),this.updatePanels()}else this.$collapsed===2&&(this.$collapsed=0,delete this.panel1.dataset.collapsed,delete this.panel2.dataset.collapsed,this.emit("collapsed",0),this.updatePanels())}updatePanels(){this.$orientation===0?(this.$panel1.style.left="0",this.$panel1.style.top="0",this.$panel1.style.right="0",this.$panel2.style.left="0",this.$panel2.style.top="",this.$panel2.style.right="0",this.$panel2.style.bottom="0",this.$dragBar.style.left="0",this.$dragBar.style.right="0",this.$anchor===1?(this.$dragBar.style.bottom="",this.$dragBar.style.top=this.$splitterDistance+"px"):(this.$dragBar.style.top="",this.$dragBar.style.bottom=this.$splitterDistance-this.$splitterWidth+"px"),this.$dragBar.style.height=this.$splitterWidth+"px",this.$dragBar.style.cursor="ns-resize",this.$collapsed===1?(this.$panel1.style.display="none",this.$panel2.style.display="",this.$panel2.style.top="0",this.$panel2.style.height="",this.$dragBar.style.display="none"):this.$collapsed===2?(this.$panel1.style.display="",this.$panel1.style.bottom="0",this.$panel1.style.height="",this.$panel2.style.display="none",this.$dragBar.style.display="none"):this.$anchor===1?(this.$panel1.style.display="",this.$panel1.style.height=this.$splitterDistance-this.$splitterWidth+"px",this.$panel2.style.display="",this.$panel2.style.top=this.$splitterDistance-this.$splitterWidth+"px",this.$panel2.style.height="",this.$dragBar.style.display=""):(this.$panel1.style.display="",this.$panel1.style.bottom=this.$splitterDistance+"px",this.$panel2.style.display="",this.$panel2.style.height=this.$splitterDistance-this.$splitterWidth+"px",this.$dragBar.style.display=""),this.$el.classList.remove("vertical"),this.$el.classList.add("horizontal")):(this.$panel1.style.left="0",this.$panel1.style.top="0",this.$panel1.style.bottom="0",this.$panel1.classList.remove("horizontal"),this.$panel1.classList.add("vertical"),this.$panel2.style.left="",this.$panel2.style.top="0",this.$panel2.style.right="0",this.$panel2.style.bottom="0",this.$anchor===1?(this.$dragBar.style.right="",this.$dragBar.style.left=this.$splitterDistance-this.$splitterWidth+"px"):(this.$dragBar.style.left="",this.$dragBar.style.right=this.$splitterDistance-this.$splitterWidth+"px"),this.$dragBar.style.top="0",this.$dragBar.style.bottom="0",this.$dragBar.style.width=this.$splitterWidth+"px",this.$dragBar.style.cursor="ew-resize",this.$collapsed===1?(this.$panel1.style.display="none",this.$panel2.style.display="",this.$panel2.style.left="0",this.$panel2.style.width="",this.$dragBar.style.display="none"):this.$collapsed===2?(this.$panel1.style.display="",this.$panel1.style.right="0",this.$panel1.style.width="",this.$panel2.style.display="none",this.$dragBar.style.display="none"):this.$anchor===1?(this.$panel1.style.display="",this.$panel1.style.width=this.$splitterDistance-this.$splitterWidth+"px",this.$panel2.style.display="",this.$panel2.style.left=this.$splitterDistance-this.$splitterWidth+"px",this.$panel2.style.width="",this.$dragBar.style.display=""):(this.$panel1.style.display="",this.$panel1.style.right=this.$splitterDistance+"px",this.$panel2.style.display="",this.$panel2.style.width=this.$splitterDistance-this.$splitterWidth+"px",this.$dragBar.style.display=""),this.$el.classList.remove("horizontal"),this.$el.classList.add("vertical"))}createControl(){this.$el=document.createElement("div"),this.$el.id=this.id+"-splitter",this.$el.classList.add("splitter"),this.$panel1||(this.$panel1=document.createElement("div"),this.$panel1.id=this.id+"-splitter-panel1"),this.$panel1.classList.add("splitter-panel","splitter-panel-1"),this.$el.appendChild(this.$panel1),this.$panel2||(this.$panel2=document.createElement("div"),this.$panel2.id=this.id+"-splitter-panel2"),this.$panel2.classList.add("splitter-panel","splitter-panel-2"),this.$el.appendChild(this.$panel2),this.$dragBar=document.createElement("div"),this.$dragBar.id=this.id+"-splitter-drag-bar",this.$dragBar.classList.add("spitter-drag-bar"),this.$el.appendChild(this.$dragBar),this.$dragBar.tabIndex=1,this.$dragBar.addEventListener("mousedown",t=>{this.$dragBar.focus(),t.preventDefault(),this.$dragging=!0,this.$ghostBar=document.createElement("div"),this.$ghostBar.id=this.id+"-ghost-bar",this.$ghostBar.classList.add("splitter-ghost-bar");let e=this.$panel2.getBoundingClientRect();this.$anchor===1&&(e=this.$panel1.getBoundingClientRect()),this.$orientation===0?(this.$ghostBar.style.left="0",this.$anchor===1?this.$ghostBar.style.top=e.bottom-this.$elBounds.top+"px":this.$ghostBar.style.top=e.top-this.$elBounds.top-this.$splitterWidth+"px",this.$ghostBar.style.right="0",this.$ghostBar.style.bottom="",this.$ghostBar.style.width="",this.$ghostBar.style.height=this.$splitterWidth+"px",this.$ghostBar.style.cursor="ns-resize"):(this.$anchor===1?this.$ghostBar.style.left=e.right-this.$elBounds.left+"px":this.$ghostBar.style.left=e.left-this.$elBounds.left-this.$splitterWidth+"px",this.$ghostBar.style.top="0",this.$ghostBar.style.bottom="0",this.$ghostBar.style.right="",this.$ghostBar.style.height="",this.$ghostBar.style.width=this.$splitterWidth+"px",this.$ghostBar.style.cursor="ew-resize"),this.$ghostBar.move=s=>{let n;this.$orientation===0&&this.$anchor===1?(n=s.pageY-this.$elBounds.top,n<this.$panel1MinSize+this.$splitterWidth?this.$ghostBar.style.top=this.$panel1MinSize+"px":n>this.parent.clientHeight-this.$panel2MinSize-this.$splitterWidth?this.$ghostBar.style.top=this.parent.clientHeight-this.$panel2MinSize-this.$splitterWidth+"px":this.$ghostBar.style.top=n-2+"px",this.live&&(n<this.$panel1MinSize+this.$splitterWidth?this.SplitterDistance=this.$panel1MinSize+this.$splitterWidth:n>this.parent.clientHeight-this.$panel2MinSize-this.$splitterWidth?this.SplitterDistance=this.parent.clientHeight-this.$panel2MinSize:this.SplitterDistance=n-2+this.$splitterWidth)):this.$orientation===0?(n=s.pageY-this.$elBounds.top,n<this.$panel1MinSize?this.$ghostBar.style.top=this.$panel1MinSize+"px":n>this.parent.clientHeight-this.$panel2MinSize?this.$ghostBar.style.top=this.parent.clientHeight-this.$panel2MinSize+"px":this.$ghostBar.style.top=n-2+"px",this.live&&(n<this.$panel1MinSize?this.SplitterDistance=this.parent.clientHeight-this.$panel1MinSize:n>this.parent.clientHeight-this.$panel2MinSize?this.SplitterDistance=this.$panel2MinSize:this.SplitterDistance=this.parent.clientHeight-n+2)):this.$orientation===1&&this.$anchor===1?(n=s.pageX-this.$elBounds.left,n<this.$panel1MinSize+this.$splitterWidth?this.$ghostBar.style.left=this.$panel1MinSize+"px":n>=this.parent.clientWidth-this.$panel2MinSize-this.$splitterWidth?this.$ghostBar.style.left=this.parent.clientWidth-this.$panel2MinSize-this.$splitterWidth+"px":this.$ghostBar.style.left=n-2+"px",this.live&&(n<this.$panel1MinSize+this.$splitterWidth?this.SplitterDistance=this.$panel1MinSize+this.$splitterWidth:n>=this.parent.clientWidth-this.$panel2MinSize-this.$splitterWidth?this.SplitterDistance=this.parent.clientWidth-this.$panel2MinSize:this.SplitterDistance=n-2+this.$splitterWidth)):(n=s.pageX-this.$elBounds.left,n<this.$panel1MinSize?this.$ghostBar.style.left=this.$panel1MinSize+"px":n>this.parent.clientWidth-this.$panel2MinSize?this.$ghostBar.style.left=this.parent.clientWidth-this.$panel2MinSize+"px":this.$ghostBar.style.left=n-2+"px",this.live&&(n<this.$panel1MinSize?this.SplitterDistance=this.parent.clientWidth-this.$panel1MinSize:n>this.parent.clientWidth-this.$panel2MinSize?this.SplitterDistance=this.$panel2MinSize:this.SplitterDistance=this.parent.clientWidth-n+2)),this.emit("splitter-moving",n)},this.$el.appendChild(this.$ghostBar),document.addEventListener("mousemove",this.$ghostBar.move)}),this.$dragBar.addEventListener("dblclick",t=>{this.emit("dblclick",t)}),window.addEventListener("resize",()=>{this.resize()}),document.addEventListener("mouseup",t=>{if(!this.$dragging)return;t.preventDefault(),t.stopPropagation(),t.cancelBubble=!0;let e;this.$orientation===0?(e=t.pageY-this.$elBounds.top,this.$anchor===1?e<this.$panel1MinSize+this.$splitterWidth?this.SplitterDistance=this.$panel1MinSize+this.$splitterWidth:e>this.parent.clientHeight-this.$panel2MinSize-this.$splitterWidth?this.SplitterDistance=this.parent.clientHeight-this.$panel2MinSize:this.SplitterDistance=e-2+this.$splitterWidth:e<this.$panel1MinSize?this.SplitterDistance=this.parent.clientHeight-this.$panel1MinSize-2:e>this.parent.clientHeight-this.$panel2MinSize?this.SplitterDistance=this.$panel2MinSize:this.SplitterDistance=this.parent.clientHeight-e+2):(e=t.pageX-this.$elBounds.left,this.$anchor===1?e<this.$panel1MinSize+this.$splitterWidth?this.SplitterDistance=this.$panel1MinSize+this.$splitterWidth:e>this.parent.clientWidth-this.$panel2MinSize-this.$splitterWidth?this.SplitterDistance=this.parent.clientWidth-this.$panel2MinSize:this.SplitterDistance=e-2+this.$splitterWidth:e<this.$panel1MinSize?this.SplitterDistance=this.parent.clientWidth-this.$panel1MinSize-2:e>this.parent.clientWidth-this.$panel2MinSize?this.SplitterDistance=this.$panel2MinSize:this.SplitterDistance=this.parent.clientWidth-e+2),this.$el.removeChild(this.$ghostBar),document.removeEventListener("mousemove",this.$ghostBar.move),this.$ghostBar=null,this.$dragging=!1}),this.parent.appendChild(this.$el),setTimeout(()=>{this.$elBounds=this.$el.getBoundingClientRect()},10),this.$resizeObserver=new ResizeObserver((t,e)=>{t.length!==0&&(!t[0].contentRect||t[0].contentRect.width===0||t[0].contentRect.height===0||(!this.$resizeObserverCache||this.$resizeObserverCache.width!==t[0].contentRect.width||this.$resizeObserverCache.height!==t[0].contentRect.height)&&(this.$resizeObserverCache={width:t[0].contentRect.width,height:t[0].contentRect.height},this.resize()))}),this.$resizeObserver.observe(this.$el),this.$observer=new MutationObserver(t=>{let e;for(e of t)e.type==="attributes"&&e.attributeName==="style"&&e.oldValue==="display: none;"&&this.resize()}),this.$observer.observe(this.$el,{attributes:!0,attributeOldValue:!0,attributeFilter:["style"]})}resize(){this.$orientation===0&&this.$anchor===1?this.$panel2.clientHeight&&this.$panel2.clientHeight<this.$panel2MinSize&&this.$panel1.clientHeight>this.$panel1MinSize&&(this.SplitterDistance=this.parent.clientHeight-this.$panel2MinSize):this.$orientation===0?this.$panel1.clientHeight&&this.$panel1.clientHeight<this.$panel1MinSize&&this.$panel2.clientHeight>this.$panel2MinSize&&(this.SplitterDistance=this.$panel1MinSize):this.$orientation===1&&this.$anchor===1?this.$panel2.clientWidth&&this.$panel2.clientWidth<this.$panel2MinSize&&this.$panel1.clientWidth>this.$panel1MinSize&&(this.SplitterDistance=this.parent.clientWidth-this.$panel2MinSize):this.$panel1.clientWidth<this.$panel1MinSize&&this.$panel2.clientWidth>this.$panel2MinSize&&(this.SplitterDistance=this.$panel1MinSize),this.$elBounds=this.$el.getBoundingClientRect()}};var Jt=class extends ve{constructor(){super(Object.assign({},client.getOption("windows.profiles")||{center:!0},{title:'i class="fas fa-users"></i> Profiles',minWidth:410}));this._profilesChanged=!1;this._current={profile:null,profileName:"",item:null,parent:null,itemIdx:-1,collection:"",itemSubIdx:-1};this._canClose=!1;this._small=!1;this.on("resized",e=>{if(e.width<430){if(this._small)return;this.header.querySelector(".breadcrumb").classList.add("breadcrumb-sm"),this._small=!0}else this._small&&(this.header.querySelector(".breadcrumb").classList.remove("breadcrumb-sm"),this._small=!1);client.setOption("windows.profiles",e)}),client.on("profiles-loaded",()=>{this.profiles||(this.profiles=client.profiles.clone(),this.profiles.SortByPriority(),this._buildMenu())}),client.on("profiles-updated",()=>{}),client.on("initialized",()=>{this.profiles||(this.profiles=client.profiles.clone(),this.profiles.SortByPriority(),this._buildMenu())}),this.body.style.padding="10px",this._splitter=new _t({id:"profile",parent:this.body,orientation:1,anchor:1}),client.getOption("profiles.split")>=200&&(this._splitter.SplitterDistance=client.getOption("profiles.split")),this._splitter.on("splitter-moved",e=>{client.setOption("profiles.split",e)}),this._menu=this._splitter.panel1,this._menu.style.overflow="hidden",this._menu.style.overflowY="auto",this._contents=this._splitter.panel2,this._contents.style.overflow="auto",this._contents.style.padding="10px",this._contents.style.paddingLeft="14px",client.profiles&&(this.profiles=client.profiles.clone(),this.profiles.SortByPriority(),this._buildMenu());let t="";t+=`<button id="${this.id}-back" type="button" class="btn-sm float-start btn btn-light" title="Go back"><i class="bi bi-arrow-left"></i><span class="icon-only"> Back</span></button>`,t+='<button id="btn-profile-menu" class="btn-sm float-start btn btn-outline-secondary" type="button" aria-controls="profile-menu" title="Show menu" data-bs-toggle="dropdown" aria-expanded="false" style="margin-right: 4px;"><i class="fa-solid fa-bars"></i></button>',t+=`<ul id="${this.id}-dropdown-menu" class="dropdown-menu" style="overflow: auto;">`,t+=`<li id="${this.id}-add-profile"><a class="dropdown-item">Add profile</a></li>`,t+=`<li id="${this.id}-add-empty-profile"><a class="dropdown-item">Add empty profile</a></li>`,t+=`<li id="${this.id}-add-sep"><hr class="dropdown-divider"></li>`,t+=`<li id="${this.id}-add-alias"><a class="dropdown-item">Add alias</a></li>`,t+=`<li id="${this.id}-add-macro"><a class="dropdown-item">Add macro</a></li>`,t+=`<li id="${this.id}-add-trigger"><a class="dropdown-item">Add trigger</a></li>`,t+=`<li id="${this.id}-add-button"><a class="dropdown-item">Add button</a></li>`,t+=`<li id="${this.id}-add-sep2"><hr class="dropdown-divider"></li>`,t+=`<li id="${this.id}-add-default-buttons"><a class="dropdown-item">Add default buttons</a></li>`,t+=`<li id="${this.id}-add-default-macros"><a class="dropdown-item">Add default macros</a></li>`,t+='<li><hr class="dropdown-divider"></li>',t+=`<li id="${this.id}-export-current"><a class="dropdown-item">Export current profile</a></li>`,t+=`<li id="${this.id}-export"><a class="dropdown-item">Export profiles</a></li>`,t+=`<li id="${this.id}-import"><a class="dropdown-item">Import profiles</a></li>`,t+='<li><hr class="dropdown-divider"></li>',t+=`<li id="${this.id}-refresh"><a class="dropdown-item">Refresh</a></li>`,t+="</ul>",t+='<span id="profile-page-buttons"></span>',t+=`<button id="${this.id}-cancel" type="button" class="btn-sm float-end btn btn-light" title="Close dialog"><i class="bi bi-x-lg"></i><span class="icon-only"> Cancel</span></button>`,t+=`<button id="${this.id}-save" type="button" class="btn-sm float-end btn btn-primary" title="Save changes" disabled><i class="bi bi-save"></i><span class="icon-only"> Save</span></button>`,t+=`<button id="${this.id}-apply" type="button" class="btn-sm float-end btn btn-secondary" title="Apply changes" disabled><i class="bi bi-check-lg"></i><span class="icon-only"> Apply</span></button>`,this.footer.innerHTML=t,this.footer.classList.add("dropup"),document.getElementById("btn-profile-menu").addEventListener("shown.bs.dropdown",()=>{setTimeout(()=>{let e=this.footer.querySelector("#"+this.id+"-dropdown-menu"),s=e.getBoundingClientRect();s.y<10&&(e.style.height=s.height+s.y-10+"px"),s.bottom>document.body.clientHeight-10&&(e.style.height=document.body.clientHeight-s.y-10+"px")},0)}),document.getElementById("btn-profile-menu").addEventListener("hidden.bs.dropdown",()=>{let e=this.footer.querySelector("#"+this.id+"-dropdown-menu");e.style.height=""}),this.footer.querySelector(`#${this.id}-cancel`).addEventListener("click",()=>{we(this._page),this.close()}),this.footer.querySelector(`#${this.id}-back`).addEventListener("click",()=>{this._goBack()}),this.on("closed",()=>{client.setOption("windows.profiles",this.windowState),we(this._page)}),this.on("canceled",()=>{client.setOption("windows.profiles",this.windowState),we(this._page)}),this.on("moved",e=>{client.setOption("windows.profiles",e)}),this.on("maximized",()=>{client.setOption("windows.profiles",this.windowState)}),this.on("restored",()=>{client.setOption("windows.profiles",this.windowState)}),this.on("shown",()=>{client.setOption("windows.profiles",this.windowState)}),this.footer.querySelector(`#${this.id}-add-profile a`).addEventListener("click",()=>{this._createProfile(!0)}),this.footer.querySelector(`#${this.id}-add-empty-profile a`).addEventListener("click",()=>{this._createProfile(!1)}),this.footer.querySelector(`#${this.id}-add-alias a`).addEventListener("click",()=>{this._addItem("aliases")}),this.footer.querySelector(`#${this.id}-add-macro a`).addEventListener("click",()=>{this._addItem("macros")}),this.footer.querySelector(`#${this.id}-add-trigger a`).addEventListener("click",()=>{this._addItem("triggers")}),this.footer.querySelector(`#${this.id}-add-button a`).addEventListener("click",()=>{this._addItem("buttons")}),this.footer.querySelector(`#${this.id}-add-default-buttons a`).addEventListener("click",()=>{let e=Le.DefaultButtons,s=e.length;for(let n=0;n<s;n++)this._addItem("buttons",e[n])}),this.footer.querySelector(`#${this.id}-add-default-macros a`).addEventListener("click",()=>{let e=Le.DefaultMacros,s=e.length;for(let n=0;n<s;n++)this._addItem("macros",e[n])}),this.footer.querySelector(`#${this.id}-export-current a`).addEventListener("click",()=>{let e={version:2,profiles:{}};e.profiles[this._current.profileName]=this._current.profile.clone(2),fileSaveAs.show(JSON.stringify(e),`oiMUD.${this._current.profileName}.txt`,"text/plain")}),this.footer.querySelector(`#${this.id}-export a`).addEventListener("click",()=>{let e={version:2,profiles:this.profiles.clone(2)};fileSaveAs.show(JSON.stringify(e),"oiMUD.profiles.txt","text/plain")}),this.footer.querySelector(`#${this.id}-import a`).addEventListener("click",()=>{ge("Import profile(s)").then(e=>{be(e[0]).then(s=>{try{var n=JSON.parse(s);if(n.version==2){if(n.profiles){for(var r=Object.keys(n.profiles),a,o,h=0,c=r.length;h<c;h++){for(a=r[h],o=0;this.profiles.contains(a);)o===0?a=r[h]+" Copy":a=r[h]+" Copy ("+o+")",o++;n.profiles[r[h]].name=a;let g=Le.load(n.profiles[r[h]]);this.profiles.add(g)}if(c===0)return;this.changed=!0,this._buildMenu(),this._expandPath(this._page)}}else setTimeout(function(){alert_box("Invalid file","Unable to import file, not a valid profile file",4)},50)}catch(g){setTimeout(function(){alert_box("Error importing","Error importing file.",3)},50),client.error(g)}}).catch(client.error)}).catch(()=>{})}),this.footer.querySelector(`#${this.id}-refresh a`).addEventListener("click",()=>{this._buildMenu(),this.setBody(this._page)}),this.footer.querySelector(`#${this.id}-save`).addEventListener("click",()=>{if(this._errorField){this._errorField.focus();return}this._save(),this.close()}),this.footer.querySelector(`#${this.id}-apply`).addEventListener("click",()=>{if(this._errorField){this._errorField.focus();return}this._save()})}set errorField(t){this._errorField=t}get errorField(){return this._errorField}get current(){return this._current}set changed(t){t!==this._profilesChanged&&(this._profilesChanged=t,this.footer.querySelector(`#${this.id}-save`).disabled=!t,this.footer.querySelector(`#${this.id}-apply`).disabled=!t)}get changed(){return this._profilesChanged}get contents(){return this._contents}_getItem(t,e,s,n,r){if(!t||t.length===0)return"";let a="";r=r||0;let o=r*20+16;return a+=`<li class="nav-item" title="${Se(De(t[e]))}" id="${s+"-"+(t[e].useName?this.sanitizeID(t[e].name.toLowerCase()):e)}">`,t[e].items&&t[e].items.length?(a+=`<a style="padding-left: ${o}px" class="nav-link text-dark" href="#${n}/${encodeURIComponent(t[e].name.toLowerCase())}"><i class="align-middle float-start bi bi-chevron-right"></i> <input data-page="${n}/${encodeURIComponent(t[e].name.toLowerCase())}" type="checkbox" class="form-check-input" id="enabled-${s}-${this.sanitizeID(t[e].name.toLowerCase())}"${t[e].enabled?" checked":""}> ${Se(De(t[e]))}</a>`,a+=this._getItems(t[e].items,s+"-"+this.sanitizeID(t[e].name.toLowerCase()),n+"/"+encodeURIComponent(t[e].name.toLowerCase()),r+1)):t[e].useName?a+=`<a style="padding-left: ${o}px" class="nav-link text-dark " href="#${n}/${encodeURIComponent(t[e].name.toLowerCase())}"><i class="align-middle float-start no-icon"></i> <input data-page="${n}/${encodeURIComponent(t[e].name.toLowerCase())}" type="checkbox" class="form-check-input" id="enabled-${s}-${this.sanitizeID(t[e].name.toLowerCase())}"${t[e].enabled?" checked":""}> ${Se(De(t[e]))}</a>`:a+=`<a style="padding-left: ${o}px" class="nav-link text-dark" href="#${n}/${e}"><i class="align-middle float-start no-icon"></i><input type="checkbox" class="form-check-input" data-page="${n}/${e}" id="enabled-${s}-${e}"${t[e].enabled?" checked":""}> ${Se(De(t[e]))}</a>`,a+="</li>",a}_getItems(t,e,s,n){if(!t||t.length===0)return"";let r="";for(let a=0,o=t.length;a<o;a++)r+=this._getItem(t,a,e,s,n);return'<ul class="dropdown-menu dropdown-inline">'+r+"</ul>"}_buildMenu(){let t="";for(let s=0,n=this.profiles.keys.length;s<n;s++)t+=this._profile(this.profiles.keys[s]);this._menu.innerHTML='<ul class="nav" id="profile-menu">'+t+"</ul>";let e=this._menu.querySelectorAll("a");for(let s=0,n=e.length;s<n;s++)this._profileEvents(e[s])}_profileEvents(t){let e=t.querySelectorAll(".bi-chevron-right"),s,n;for(s=0,n=e.length;s<n;s++)e[s].addEventListener("click",r=>{r.target.closest("li").querySelector(".dropdown-menu").classList.toggle("show"),r.target.classList.toggle("bi-chevron-right"),r.target.classList.toggle("bi-chevron-down"),r.preventDefault()});for(e=t.querySelectorAll("input"),s=0,n=e.length;s<n;s++)e[s].addEventListener("change",r=>{let a=r.target.dataset.page.split("/"),o=r.target.checked;switch(a.length){case 2:if(!o&&this.profiles.keys.filter(h=>this.profiles.enabled(h)).length===1){alert_box("Cannot disable","One profile must always be enabled."),r.target.checked=!0;return}this._menu.querySelector(`#enabled-${this.sanitizeID(a[1])}`).checked=o,this._menu.querySelector(`#enabled-${this.sanitizeID(a[1])}-switch`).checked=o,this._page===r.target.dataset.page&&(this._contents.querySelector("#enabled").checked=o),this.profiles.items[a[1]].enabled=o,this.changed=!0;break;case 3:this._menu.querySelector(`#enabled-${this.sanitizeID(a[1])}-${a[2]}`).checked=o,this._page===`profiles/${a[1]}`&&(this._contents.querySelector("#enable"+ke(a[2])).checked=o),this.profiles.items[a[1]]["enable"+ke(a[2])]=o,this.changed=!0;break;case 4:this._menu.querySelector(`#enabled-${this.sanitizeID(a[1])}-${a[2]}-${a[3]}`).checked=o,this._page===r.target.dataset.page?this._contents.querySelector("#enabled").checked=o:this._page===`profiles/${a[1]}/${a[2]}`&&(this._contents.querySelector("#check-"+a[3]).checked=o),this.profiles.items[a[1]][a[2]][+a[3]].enabled=o,this.changed=!0;break}r.stopPropagation(),r.cancelBubble=!0});for(e=t.querySelectorAll(".list-badge-button"),s=0,n=e.length;s<n;s++)e[s].addEventListener("click",r=>{this._deleteProfile(r.target.parentElement.dataset.profile),r.preventDefault()})}_profile(t){let e=`<li class="nav-item" data-profile="${t}" title="${ke(t)}" id="${this.sanitizeID(t)}">`;return e+=`<a class="nav-link text-dark" href="#profiles/${encodeURIComponent(t)}">`,t!=="default"&&(e+=`<span class="list-badge-button badge text-bg-danger" data-profile="${t}"><i class="bi bi-trash"></i></span>`),e+='<i class="align-middle float-start bi bi-chevron-right"></i> ',e+=this._item(ke(t),"enabled-"+t,this.profiles.items[t].enabled),e+="</a>",e+=this._getItems([{name:"Aliases",items:this.profiles.items[t].aliases,useName:!0,enabled:this.profiles.items[t].enableAliases},{name:"Macros",items:this.profiles.items[t].macros,useName:!0,enabled:this.profiles.items[t].enableMacros},{name:"Triggers",items:this.profiles.items[t].triggers,useName:!0,enabled:this.profiles.items[t].enableTriggers},{name:"Buttons",items:this.profiles.items[t].buttons,useName:!0,enabled:this.profiles.items[t].enableButtons}],this.sanitizeID(t),"profiles/"+encodeURIComponent(t),1),e+="</li>",e}_item(t,e,s){return`<span><input type="checkbox" data-page="profiles/${t.toLowerCase()}" class="form-check-input" id="${this.sanitizeID(e)}"${s?" checked":""}> ${t}</span><div class="form-check form-switch"><input type="checkbox" class="form-check-input" id="${e}-switch"${s?" checked":""}> ${t}</div>`}setBody(t,e){if(!this.profiles){setTimeout(()=>{this.setBody(t,e)},100);return}if(this._errorField){setTimeout(()=>this._errorField.focus(),100),window.location.hash=this._page;return}this._page=this.dialog.dataset.path,this._page==="profiles"?this.dialog.dataset.panel="left":this.dialog.dataset.panel="right";let s=this._page.split("/"),n="",r=s.length-1;if(s.length===1?n+='<li><i class="float-start fas fa-users" style="padding: 2px;margin-right: 2px;"></i></li>':n+='<li><a href="#'+s.slice(0,1).join("-")+'"><i class="float-start fas fa-users" style="padding: 2px;margin-right: 2px;"></i></a></li>',s.length<4)for(let c=0,g=s.length;c<g;c++){let f=ke(s[c]);c===r?n+='<li class="breadcrumb-item active">'+f+"</li>":n+='<li class="breadcrumb-item" aria-current="page"><a href="#'+s.slice(0,c+1).join("/")+'">'+f+"</a></li>"}let a,o,h;if(this._expandPath(s),this.footer.querySelector("#profile-page-buttons").innerHTML="",this.footer.querySelector(`#${this.id}-export-current`).style.display="",this.title=`<ol class="breadcrumb${this._small?" breadcrumb-sm":""}" style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;flex-wrap: nowrap;">${n}</ol>`,this._contents.scrollTop=0,!!this._setCurrent(s))if(s.length<2?(this.footer.querySelector(`#${this.id}-export-current`).style.display="none",this.footer.querySelector(`#${this.id}-add-sep`).style.display="none",this.footer.querySelector(`#${this.id}-add-alias`).style.display="none",this.footer.querySelector(`#${this.id}-add-macro`).style.display="none",this.footer.querySelector(`#${this.id}-add-trigger`).style.display="none",this.footer.querySelector(`#${this.id}-add-button`).style.display="none",this.footer.querySelector(`#${this.id}-add-sep2`).style.display="none",this.footer.querySelector(`#${this.id}-add-default-buttons`).style.display="none",this.footer.querySelector(`#${this.id}-add-default-macros`).style.display="none",this._splitter.panel2Collapsed=!0,this.footer.querySelector(`#${this.id}-back`).style.display="none"):(this.footer.querySelector(`#${this.id}-add-sep`).style.display="",this.footer.querySelector(`#${this.id}-add-alias`).style.display="",this.footer.querySelector(`#${this.id}-add-macro`).style.display="",this.footer.querySelector(`#${this.id}-add-trigger`).style.display="",this.footer.querySelector(`#${this.id}-add-button`).style.display="",this.footer.querySelector(`#${this.id}-back`).style.display="",this.footer.querySelector(`#${this.id}-add-sep2`).style.display="",this.footer.querySelector(`#${this.id}-add-default-buttons`).style.display="",this.footer.querySelector(`#${this.id}-add-default-macros`).style.display="",this._splitter.panel2Collapsed=!1),s.length===2){if(this._contentPage!=="properties")this._loadPage("properties").then(c=>{this._contentPage="properties",this._setContents(c);let g=this._contents.querySelectorAll("input");this._contents.querySelector("#name").disabled=this._current.profileName==="default";for(let f=0,w=g.length;f<w;f++)g[f].type==="checkbox"?(g[f].checked=this._current.profile[g[f].id],g[f].addEventListener("change",p=>{let k=p.target.checked;if(p.target.id==="enabled"){if(!k&&this.profiles.keys.filter(E=>this.profiles.enabled(E)).length===1){alert_box("Cannot disable","One profile must always be enabled."),p.target.checked=!0;return}this._menu.querySelector(`#enabled-${this.sanitizeID(this._current.profileName)}`).checked=k,this._menu.querySelector(`#enabled-${this.sanitizeID(this._current.profileName)}-switch`).checked=k,this._page===p.target.dataset.page&&(this._contents.querySelector("#enabled").checked=k),this.profiles.items[this._current.profileName].enabled=k}else this._current.profile[p.target.id]=k,this._menu.querySelector(`#enabled-${this.sanitizeID(this._current.profileName)}-${p.target.id.substring(6).toLowerCase()}`).checked=k,this.changed=!0;this.changed=!0})):(g[f].value=this._current.profile[g[f].id],g[f].addEventListener("change",p=>{let k=p.currentTarget||p.target;k.id==="name"?fe(()=>{let E=this._renameProfile(k.value);E===!0?(g[f].classList.remove("is-invalid"),this._errorField=null):(g[f].classList.add("is-invalid"),this._errorField=g[f],this._contents.querySelector("#name-feedback").textContent=E),this._sortProfiles()},200,"renameProfile"):(this._current.profile[k.id]=k.value,fe(()=>this._sortProfiles(),200,"sortProfiles")),this.changed=!0}),g[f].addEventListener("input",p=>{let k=p.currentTarget||p.target;k.id==="name"?fe(()=>{let E=this._renameProfile(k.value);E===!0?(g[f].classList.remove("is-invalid"),this._errorField=null):(g[f].classList.add("is-invalid"),this._errorField=g[f],this._contents.querySelector("#name-feedback").textContent=E),this._sortProfiles()},200,"renameProfile"):(this._current.profile[k.id]=k.value,fe(()=>this._sortProfiles(),200,"sortProfiles")),this.changed=!0}))}).catch(()=>{});else{this._contents.querySelector("#name").disabled=this._current.profileName==="default";let c=this._contents.querySelectorAll("input");for(let g=0,f=c.length;g<f;g++)c[g].type==="checkbox"?c[g].checked=this._current.profile[c[g].id]:c[g].value=this._current.profile[c[g].id]}if(this._current.profileName!=="default"){let c=`<button id="${this.id}-remove" type="button" class="btn-sm btn btn-danger" title="Remove profile"><i class="bi bi-trash"></i></button>`;this.footer.querySelector("#profile-page-buttons").innerHTML=c,this.footer.querySelector(`#${this.id}-remove`).addEventListener("click",g=>{this._errorField&&(this._errorField=null),this._deleteProfile(this._current.profileName)})}}else if(s.length===3){let c="";if(this._current.item.length===0)h='<h1 id="empty" style="width: 100%;text-align:center">No '+this._current.collection+".</h1>",h+=`<button id="${this.id}-add-contents" type="button" class="btn-sm float-start btn btn-outline-secondary" title="Add ${this._getItemType()}"><i class="bi bi-plus-lg"></i> Add ${this._getItemType()}</button>`;else{for(h="",a=0,o=this._current.item.length;a<o;a++)h+=`<a data-profile ="${this._current.profileName}" id="item-${a}" data-index="${a}" href="#profiles/${encodeURIComponent(this._current.profileName)}/${this._current.collection}/${a}" class="list-group-item list-group-item-action">`,h+=`<span data-index="${a}" class="list-badge-button badge text-bg-danger"><i class="bi bi-trash"></i></span>`,h+='<div class="form-check-inline form-switch" style="margin: 0;">',h+=`<input type="checkbox" class="form-check-input" id="check-${a}" data-profile="${this._current.profileName}" data-index="${a}" data-field="enabled" data-items="${this._current.collection}"${this._current.item[a].enabled?' checked="checked"':""}>`,h+=`</div>${Se(De(this._current.item[a]))}</a>`;c=`<button id="${this.id}-add-contents" type="button" class="btn-sm btn btn-outline-secondary" title="Add ${this._getItemType()}" style="margin-bottom: 5px;width:100%;"><i class="bi bi-plus-lg"></i> Add ${this._getItemType()}</button>`}let g=`<button id="${this.id}-add" type="button" class="btn-sm float-start btn btn-outline-secondary" title="Add ${this._getItemType()}"><i class="bi bi-plus-lg"></i></button>`;this.footer.querySelector("#profile-page-buttons").innerHTML=g,this._setContents(c+'<div class="list-group">'+h+"</div>");let f=this._contents.querySelectorAll(".list-badge-button");for(let w=0,p=f.length;w<p;w++)f[w].addEventListener("click",k=>{this._removeItem(+k.target.parentElement.dataset.index),k.stopPropagation(),k.cancelBubble=!0,k.preventDefault()});this._contentPage=null,this.footer.querySelector(`#${this.id}-add`).addEventListener("click",()=>{this._addItem()}),this._contents.querySelector(`#${this.id}-add-contents`)&&this._contents.querySelector(`#${this.id}-add-contents`).addEventListener("click",()=>{this._addItem()}),f=this._contents.querySelectorAll("input");for(let w=0,p=f.length;w<p;w++)f[w].addEventListener("change",k=>{let E=k.currentTarget||k.target,b=E.checked;this._menu.querySelector(`#enabled-${this.sanitizeID(this._current.profileName)}-${this._current.collection}-${E.dataset.index}`).checked=b,this._current.profile[this._current.collection][+E.dataset.index].enabled=b,this.changed=!0})}else if(s.length===4){let c=`<button id="${this.id}-remove" type="button" class="btn-sm btn btn-danger" title="Remove ${this._getItemType()}"><i class="bi bi-trash"></i></button>`;this.footer.querySelector("#profile-page-buttons").innerHTML=c,this.footer.querySelector(`#${this.id}-remove`).addEventListener("click",g=>{this._removeItem(this._current.itemIdx,0,!0),g.stopPropagation(),g.cancelBubble=!0,g.preventDefault()});for(let g=0,f=s.length;g<f;g++)g===r?n+='<li class="breadcrumb-item active">'+Se(De(this._current.item))+"</li>":n+='<li class="breadcrumb-item" aria-current="page"><a href="#'+s.slice(0,g+1).join("/")+'">'+ke(s[g])+"</a></li>";this.title=`<ol class="breadcrumb${this._small?" breadcrumb-sm":""}" style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;flex-wrap: nowrap;">${n}</ol>`,this._contentPage!==this._current.collection?(this._contentPage=this._current.collection,this._loadPage(this._current.collection).then(g=>{this._setContents(g),this._loadItem(!0)}).catch(()=>{})):this._loadItem()}else if(s.length===5){let c=`<button id="${this.id}-remove" type="button" class="btn-sm btn btn-danger" title="Remove ${this._getItemType()}"><i class="bi bi-trash"></i></button>`;this.footer.querySelector("#profile-page-buttons").innerHTML=c,this.footer.querySelector(`#${this.id}-remove`).addEventListener("click",f=>{this._removeItem(this._current.itemIdx,0,!0),f.stopPropagation(),f.cancelBubble=!0,f.preventDefault()});let g=s.length-1;for(let f=0,w=s.length;f<w;f++)f===g-1?n+='<li class="breadcrumb-item"><a href="#'+s.slice(0,f+1).join("/")+'">'+Se(De(this._current.parent))+"</a></li>":f===g?n+='<li class="breadcrumb-item active">'+Se(De(this._current.item))+"</li>":n+='<li class="breadcrumb-item" aria-current="page"><a href="#'+s.slice(0,f+1).join("/")+'">'+ke(s[f])+"</a></li>";this.title=`<ol class="breadcrumb${this._small?" breadcrumb-sm":""}" style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;flex-wrap: nowrap;">${n}</ol>`,this._contentPage!==this._current.collection?(this._contentPage=this._current.collection,this._loadPage(this._current.collection).then(f=>this._setContents(f)).catch(()=>{this._loadItem(!0)})):this._loadItem()}else{let c=`<button id="btn-${this.id}-add-profile" type="button" class="btn-sm btn btn-outline-secondary" title="Add profile"><i class="bi bi-plus-lg"></i></button>`;this.footer.querySelector("#profile-page-buttons").innerHTML=c,this.footer.querySelector(`#btn-${this.id}-add-profile`).addEventListener("click",()=>{this._createProfile(!0)}),this._contentPage=null,this._setContents("")}}_setCurrent(t){if(!t)return!1;if(this._current.itemIdx=this._current.itemSubIdx=-1,this._current.parent=null,t.length>1){if(this._current.profileName=t[1],!this.profiles.contains(this._current.profileName))return this._setContents(`<h1 id="empty" style="width: 100%;text-align:center">Profile ${this._current.profileName} not found.</h1>`),this._contentPage=null,!1;this._current.profile=this.profiles.items[this._current.profileName]}if(t.length>2){if(this._current.collection=t[2],!this._current.profile[this._current.collection])return this._setContents(`<h1 id="empty" style="width: 100%;text-align:center">${ke(this._current.collection)} not found in ${this._current.profileName}.</h1>`),this._contentPage=null,!1;this._current.item=this._current.profile[t[2]]}if(t.length>3){if(this._current.itemIdx=+t[3],this._current.itemIdx<0||this._current.itemIdx>=this._current.item.length){this._setContents(`<h1 id="empty" style="width: 100%;text-align:center">${ke(this._getItemType())} not found.</h1>`),this._contentPage=null;return}this._current.item=this._current.profile[t[2]][this._current.itemIdx]}if(t.length>4){if(this._current.itemSubIdx=+t[4],!this._current.item.triggers){this._setContents('<h1 id="empty" style="width: 100%;text-align:center">Invalid trigger.</h1>'),this._contentPage=null;return}if(this._current.itemSubIdx<0||this._current.itemSubIdx>=this._current.item.triggers.length){this._setContents('<h1 id="empty" style="width: 100%;text-align:center">Trigger state not found.</h1>'),this._contentPage=null;return}this._current.parent=this._current.item,this._current.item=this._current.item.triggers[this._current.itemSubIdx]}return!0}_loadPage(t){return new Promise((e,s)=>{$.ajax({url:"dialogs/profiles-"+t+".htm",cache:!1,type:"GET"}).done(n=>{n=n.replace(/{profileURL}/g,encodeURIComponent(this._current.profileName)).replace(/{profile}/g,this._current.profileName),e(n)}).fail(function(){s("")})})}_setContents(t){this._contents.innerHTML=t;let e=this._contents.querySelectorAll("script"),s={client,item:this._current.item,FilterArrayByKeyValue:Qe,keyCharToCode:Ii,keyCodeToChar:ut,profile:this._current.profile,profileName:this._current.profileName,parent:this._current.parent,current:this._current,GetDisplay:De,Trigger:Ie,debounce:fe,updateHash:ht,DialogButtons:vt};this.emit("content-changing");for(let n=0,r=e.length;n<r;n++)new Function("body","dialog",...Object.keys(s),"try { "+e[n].textContent+"}catch(e){client.error(e)}").apply(client,[this._contents,this,...Object.values(s),this]);this.emit("content-changed")}_loadItem(t){let e=this._contents.querySelectorAll("input,select,textarea");for(let s=0,n=e.length;s<n;s++)if(!(!(e[s].id in this._current.item)&&e[s].dataset.enum!=="true"))if(e[s].type==="checkbox"){if(e[s].dataset.enum==="true"){let r=e[s].name||e[s].id.substring(0,e[s].id.lastIndexOf("-")),a=+e[s].id.substring(e[s].id.lastIndexOf("-")+1);e[s].checked=(this._current.item[r]&a)===a}else e[s].checked=this._current.item[e[s].id];t&&e[s].addEventListener("change",r=>{let a=r.currentTarget||r.target;if(a.style.display!=="none"){if(a.dataset.enum==="true"){let o=a.name||a.id.substring(0,a.id.lastIndexOf("-")),h=this.body.querySelectorAll(`[name=${o}]`),c=0;for(let g=0,f=h.length;g<f;g++)h[g].checked&&(c|=+h[g].value);this._current.item[o]=c}else this._current.item[a.id]=a.checked||!1,a.id==="enabled"&&(this._menu.querySelector(`#enabled-${this.sanitizeID(this._current.profileName)}-${this._current.collection}-${this._current.itemIdx}`).checked=this._current.item[a.id]);this.changed=!0,this._updateItemMenu()}})}else{e[s].value=this._current.item[e[s].id],t&&(e[s].addEventListener("change",a=>{let o=a.currentTarget||a.target;o.style.display!=="none"&&(this.setValue(this._current.item,o.id,o.value),this.changed=!0,this._updateItemMenu())}),e[s].addEventListener("input",a=>{let o=a.currentTarget||a.target;o.style.display!=="none"&&(this.setValue(this._current.item,o.id,o.value),this.changed=!0,this._updateItemMenu())}));let r=this.changed;e[s].dispatchEvent(new Event("change")),this.changed=r}this.emit("item-loaded",this._current)}_updateItemMenu(t,e,s,n){e=e||this._current.profileName,s=s||this._current.collection,typeof n!="number"&&(n=this._current.itemIdx);let r=this._current.parent;t=t||this._current.item,fe(()=>{let a=this.body.querySelector(`#${this.sanitizeID(e)}-${s}-${n}`);if(!a)return;let o;o=De(r||t),a.title=o,a.firstChild.childNodes[2].textContent=" "+o;let h=this.header.querySelector("ol").children;h.length>4&&(h[4].children.length?h[4].children[0].textContent=o:h[4].textContent=o),h.length>5&&(h[5].textContent=De(t))},200,"updateItemMenu")}_expandPath(t,e){Array.isArray(t)||(t=t.split("/"));let s,n,r,a=0;t[0]==="profiles"&&(a=1);let o=t.length-1;for(let h=a,c=t.length;h<c;h++)if(s=this.sanitizeID(t.slice(a,h+1).join("-")),n=document.getElementById(s),!!n)if(h===o)setTimeout(()=>{let g=this._menu.querySelectorAll(".active");for(let f=0,w=g.length;f<w;f++)g[f].classList.remove("active");Ri(this._menu,n),n.classList.add("active"),e&&n.firstChild.click()},100);else{if(r=n.querySelector(".dropdown-menu"),!r||r.classList.contains("show"))continue;n=n.querySelector("i"),n&&(n.closest("li").querySelector(".dropdown-menu").classList.toggle("show"),n.classList.toggle("bi-chevron-right"),n.classList.toggle("bi-chevron-down"))}}_goBack(){if(this._errorField){this._errorField.focus();return}let t=this._page.split("/");t.length===5?ht(t.slice(0,t.length-2).join("/"),this._page):ht(t.slice(0,t.length-1).join("/"),this._page)}_createProfile(t){let e=this.profiles.length,s="NewProfile"+e;for(;this.profiles.contains(s);)e++,s="NewProfile"+e;let n=new Le(s,t);s=s.toLowerCase(),this.profiles.add(n),this.profiles.SortByPriority();let r=this._profile(s);e=this.profiles.keys.indexOf(s);let a=document.getElementById("profile-menu");(e===-1||e>=a.children.length)&&(e=a.children.length-1),e<0&&(e=0),a.children[e].insertAdjacentHTML("afterend",r),this._profileEvents(a.children[e+1]),this.changed=!0,ht("profiles/"+s,this._page)}_deleteProfile(t){if(!t)return!1;confirm_box("Remove profile?",`Delete "${t}"?`).then(e=>{e.button===4&&(this.profiles.remove(t),this._menu.querySelector("#"+t).remove(),this._page.startsWith("profiles/"+t)&&ht("profiles",this._page),this.changed=!0)})}_renameProfile(t,e){if(!t)return"Name can not be empty!";if(e=(e||this._current.profileName).toLowerCase(),t=t.toLowerCase(),t===e)return!0;if(this.profiles.contains(t))return"A profile named "+t+" already exists!";this.profiles.remove(e),this._current.profile.name=t,this._current.profileName=t,this.profiles.add(this._current.profile);let s=this.sanitizeID(e),n=this.sanitizeID(t),r;return r=this.body.querySelector(`#${s} a`),r.children[2].childNodes[1].textContent=" "+ke(t),document.querySelector(`#${s} a`).children[3].childNodes[1].textContent=" "+ke(t),r=this.body.querySelector(`#${s}`),r.id=n,r.title=t,this._replaceProfileName(this._menu.firstChild,e,t),this._replaceProfileName(this._contents,e,t),this.header.querySelector("ol").children[2].textContent=ke(t),!0}_replaceProfileName(t,e,s){let n,r,a,o=this.sanitizeID(e),h=this.sanitizeID(s);for(n=t.querySelectorAll(`[id*="-${o}-"]`),r=0,a=n.length;r<a;r++)n[r].id=n[r].id.replace(`-${o}-`,`-${h}-`);for(n=t.querySelectorAll(`[id$="-${o}"]`),r=0,a=n.length;r<a;r++)n[r].id=n[r].id.replace(`-${o}`,`-${h}`);for(n=t.querySelectorAll(`[id^="${o}-"]`),r=0,a=n.length;r<a;r++)n[r].id=n[r].id.replace(`${o}-`,`${h}-`);for(n=t.querySelectorAll(`[data-profile="${o}"]`),r=0,a=n.length;r<a;r++)n[r].dataset.profile=h;let c=encodeURIComponent(e),g=encodeURIComponent(s);for(n=t.querySelectorAll(`[href*="/${c}/"]`),r=0,a=n.length;r<a;r++)n[r].href=n[r].getAttribute("href").replace(`/${c}/`,`/${g}/`);for(n=t.querySelectorAll(`[href$="/${c}"]`),r=0,a=n.length;r<a;r++)n[r].href=n[r].getAttribute("href").replace(`/${c}`,`/${g}`);for(n=t.querySelectorAll(`[href^="${c}/"]`),r=0,a=n.length;r<a;r++)n[r].href=n[r].getAttribute("href").replace(`${c}/`,`${g}/`);for(n=t.querySelectorAll(`[data-path*="/${c}/"]`),r=0,a=n.length;r<a;r++)n[r].dataset.path=n[r].dataset.path.replace(`/${c}`,`/${g}`);for(n=t.querySelectorAll(`[data-page*="/${c}/"]`),r=0,a=n.length;r<a;r++)n[r].dataset.page=n[r].dataset.page.replace(`/${c}/`,`/${g}/`);for(n=t.querySelectorAll(`[data-page$="/${c}"]`),r=0,a=n.length;r<a;r++)n[r].dataset.page=n[r].dataset.page.replace(`/${c}`,`/${g}`)}_sortProfiles(){this.profiles.SortByPriority();let t=this._menu.firstChild,e=Array.from(t.children);e.sort((s,n)=>{let r=this.profiles.items[s.dataset.profile].priority,a=this.profiles.items[n.dataset.profile].priority;return r>a?-1:r<a?1:s.dataset.profile==="default"?-1:n.dataset.profile==="default"||(r=s.dataset.profile,a=n.dataset.profile,r>a)?1:r<a?-1:0}),e.forEach(s=>t.appendChild(s))}_save(){return this.changed?this._errorField?(this._errorField.focus(),!1):(this.profiles.save().then(()=>{client.loadProfiles().then(()=>{})}),this.changed=!1,!0):!0}close(){this._canClose?super.close():this.confirmSave().then(t=>{t&&!this._save()||(this._canClose=!0,this.close())}).catch(()=>{this._canClose=!1})}reload(){this._setCurrent(this._page.split("/"))&&(this._loadItem(),this._updateItemMenu())}confirmSave(){return new Promise((t,e)=>{this._profilesChanged?confirm_box("Save changes?","Save changes to profiles?",null,14).then(s=>{s.button===4?t(!0):s.button===8?t(!1):e()}).catch(s=>{e()}):t(!0)})}sanitizeID(t){return t.toLowerCase().replace(/[^a-z0-9:.-]+/gi,"_")}_getItemType(t){if(t=t||this._current.collection,!!t)return t==="aliases"?"alias":t.substring(0,t.length-1)}_addItem(t,e){if(t||(t=this._current.collection),!t)return;var s=this._current.profile[t].length;let n;e||(t==="aliases"?e=new Je:t==="triggers"?e=new Ie:t==="buttons"?e=new me:t==="macros"?e=new at:t==="context"&&(e=new gt)),this._current.profile[t].push(e);let r=this._menu.querySelector(`#${this.sanitizeID(this._current.profileName)}-${t}`);if(s===0){n=this._getItem([{name:ke(t),items:this._current.profile[t],useName:!0,enabled:this._current.profile[t]}],0,this.sanitizeID(this._current.profileName),"profiles/"+encodeURIComponent(this._current.profileName),1);var a=document.createElement("div");a.innerHTML=n,r.replaceWith?r.replaceWith(a.firstChild):r.replaceChild?r.parentNode.replaceChild(a.firstChild,r):r.outerHTML=n,r=this._menu.querySelector(`#${this.sanitizeID(this._current.profileName)}-${t}`),this._profileEvents(r)}else n=this._getItem(this._current.profile[t],s,`${this.sanitizeID(this._current.profileName)}-${t}`,`profiles/${encodeURIComponent(this._current.profileName)}/${t}`,2),r=r.querySelector("ul"),r.insertAdjacentHTML("beforeend",n),r=this._menu.querySelector(`#${this.sanitizeID(this._current.profileName)}-${t}`),this._profileEvents(r.lastChild);ht(`profiles/${encodeURIComponent(this._current.profileName)}/${t}/${s}`,this._page),this.changed=!0}_removeItem(t,e,s){e||(e=this._current.collection),e&&confirm_box("Remove profile?",`Delete ${this._getItemType()}?`).then(n=>{if(n.button===4){let r=`${this.sanitizeID(this._current.profileName)}-${e}`,a=this._current.profile[e];if(a.splice(t,1),this._menu.querySelector(`#${r}-${t}`).remove(),this._current.itemIdx===-1&&this.setBody(this._page),a.length===0)this._menu.querySelector(`#${r} i`).remove(),this._menu.querySelector(`#${r} a`).insertAdjacentHTML("afterbegin",'<i class="align-middle float-start no-icon"></i>');else{let o=this._menu.querySelector(`#${r} ul`),h=o.children.length,c=`#profiles/${encodeURIComponent(this._current.profileName)}/${e}/`;for(;t<h;t++){let g=o.children[t];g.id=`${r}-${t}`,g.firstChild.href=`${c}${t}`,g.firstChild.children[1].id=`enabled-${r}-${t}`}}this.changed=!0,s&&this._goBack()}})}setValue(t,e,s){s=="false"&&(s=!1),s=="true"&&(s=!0),s=="null"&&(s=null),s=="undefined"&&(s=void 0),typeof s=="string"&&parseFloat(s).toString()==s&&(s=parseFloat(s)),t[e]=this.convertType(s,typeof t[e])}convertType(t,e){if(typeof t===e)return t;switch(e){case"number":return typeof t=="string"&&parseFloat(t).toString()==t?parseFloat(t):Number(t);case"boolean":return!!t;case"string":return""+t}return t}};function De(m){return m.displaytype===1?new Function("item","keyCodeToChar","MacroDisplay",m.display)(m,ut,ot):$.isFunction(m.display)?m.display(m):$.isFunction(m[m.display])?m[m.display](m):m[m.display]?m[m.display]:m.name}var ei=class m extends pe{constructor(t,e){super();this._cleanUp=()=>{window.removeEventListener("click",this._cleanUp),window.removeEventListener("mousedown",this._mouseup),window.removeEventListener("keydown",this._cleanUp),this._menu&&this._menu.remove()};this._mouseup=t=>{this._menu.contains(t.srcElement)||this._cleanUp()};this._items=t||[],this._id=e||new Date().getTime(),this._createMenu()}_createMenu(){if(!this._menu){let n=`<ul id="${this._id}" class="dropdown-menu show">`;for(var t=0,e=this._items.length;t<e;t++)n+=`<li><a class="dropdown-item" data-index="${t}" href="#">${this._items[t].name}</a></li>`;n+="</ul>",document.body.insertAdjacentHTML("afterend",n),this._menu=document.getElementById(this._id)}let s=this._menu.querySelectorAll("li a");for(let n=0,r=s.length;n<r;n++)s[n].addEventListener("click",a=>{let o=+a.currentTarget.dataset.index;typeof this._items[o].action=="function"&&this._items[o].action(this._items[n],a),this._cleanUp()})}close(){this._cleanUp()}show(t,e){this._menu.style.left=t+"px",this._menu.style.top=e+"px",this._menu.style.display="block",this._menu.style.position="absolute",setTimeout(()=>{window.addEventListener("click",this._cleanUp),window.addEventListener("mousedown",this._mouseup),window.addEventListener("keydown",this._cleanUp)},100)}static popup(t,e,s){new m(t).show(e,s)}};var oe,le,wi=-1,Xi="",Yi="",Vi="",Ee;function Ls(m){confirm_box("Open?",`Open '${m}'?`).then(u=>{u.button===4&&(window.open(m),client.getOption("CommandonClick")&&client.commandInput.focus())})}function Is(m,u){u.startsWith("OoMUD://")||u.startsWith("jiMUD://")||u.startsWith("client://")?es(0,m,u.substring(8)):confirm_box("Open?",`Open '${u}'?`).then(t=>{t.button===4&&(window.open(u),client.getOption("CommandonClick")&&client.commandInput.focus())})}function es(m,u,t,e,s){var n=u.querySelector("img[ismap]"),r="";if(n){var a=Li(n),o=Math.floor(m.clientX-a.left),h=Math.floor(m.clientY-a.top);r="?"+o+","+h}if(t.constructor===Array||t.__proto__.constructor===Array||Object.prototype.toString.call(t)==="[object Array]"){let f=[];for(var c=0,g=t.length;c<g;c++)t[c]=t[c].replace("&text;",u.textContent),c<s.length?f.push({name:s[c],action:w=>vi(w.cmd,w.pmt),pmt:e,cmd:t[c]+r}):f.push({name:t[c],action:w=>vi(w.cmd,w.pmt),pmt:e,cmd:t[c]+r});ei.popup(f,m.clientX,m.clientY)}else e?(t=t.replace("&text;",u.textContent)+r,client.commandInput.value=t,ci(client.commandInput,t.length,t.length)):client.send(t.replace("&text;",u.textContent)+r+`
`,!0);setTimeout(()=>{client.getOption("CommandonClick")&&client.commandInput.focus()},0)}function vi(m,u){u?(client.commandInput.value=m,ci(client.commandInput,m.length,m.length)):client.send(m,!0),setTimeout(()=>{client.getOption("CommandonClick")&&client.commandInput.focus()},0)}function Ps(m){m.title=m.title.replace("&text;",m.textContent)}window.doLink=Ls;window.doMXPLink=Is;window.doMXPSend=es;window.MXPMenuHandler=vi;window.doMXPTooltip=Ps;function Ms(){let m;ct(0),ji(),window.readClipboard=()=>pt(),window.readClipboardHTML=()=>pt(),client.readClipboard=window.readClipboard,client.readClipboardHTML=window.readClipboardHTML,window.writeClipboard=(u,t)=>Oe(u),client.writeClipboard=window.writeClipboard,client.closeWindow=u=>{switch(u){case"editor":case"help":case"about":nt(u);break;case"profiles":case"profiles-manager":case"profile-manager":case"manager":nt("profiles");break;case"prefs":case"options":case"preferences":nt("settings");break;case"history":case"command-history":nt("history");break;default:client.emit("close-window",u);break}},["repeatnum","i"].forEach(u=>{Object.defineProperty(window,u,{get:function(){if(client)return client.repeatnum},configurable:!0})}),Object.defineProperty(window,"$selected",{get:function(){return client?client.display.selection:""},configurable:!0}),Object.defineProperty(window,"$copied",{get:function(){return""},configurable:!0}),Object.defineProperty(window,"$selword",{get:function(){return client?client.input.vStack.$selword||Xi||(Ee?client.display.getWordFromPosition(Ee.pageX,Ee.pageY):""):""},configurable:!0}),Object.defineProperty(window,"$selurl",{get:function(){if(!client)return"";let u=client.input.vStack.$selurl||Yi||"";if(u)return u;if(!Ee)return"";var t=Ee.srcElement.parentNode;return t&&t.classList&&t.classList.contains("URLLink")?t.title:t&&t.classList&&t.classList.contains("MXPLink")&&t.dataset&&t.dataset.href&&t.dataset.href.length>0?t.dataset.href:""},configurable:!0}),Object.defineProperty(window,"$selline",{get:function(){if(!client)return"";let u=client.input.vStack.$selline||Vi||"";if(u)return u;if(!Ee)return"";var t=client.display.getLineOffset(Ee.pageX,Ee.pageY);return t.y<0||t.y>=client.display.lines.length?"":client.display.getLineText(t.y,!0)},configurable:!0}),Object.defineProperty(window,"$selectedword",{get:function(){return client?client.input.vStack.$selectedword||Xi||(Ee?client.display.getWordFromPosition(Ee.pageX,Ee.pageY):""):""},configurable:!0}),Object.defineProperty(window,"$selectedurl",{get:function(){if(!client)return"";let u=client.input.vStack.$selectedurl||Yi||"";if(u)return u;if(!Ee)return"";var t=Ee.srcElement.parentNode;return t&&t.classList&&t.classList.contains("URLLink")?t.title:t&&t.classList&&t.classList.contains("MXPLink")&&t.dataset&&t.dataset.href&&t.dataset.href.length>0?t.dataset.href:""},configurable:!0}),Object.defineProperty(window,"$selectedline",{get:function(){if(!client)return"";let u=client.input.vStack.$selectedline||Vi||"";if(u)return u;if(!Ee)return"";var t=client.display.getLineOffset(Ee.pageX,Ee.pageY);return t.y<0||t.y>=client.display.lines.length?"":client.display.getLineText(t.y,!0)},configurable:!0}),Object.defineProperty(window,"$action",{get:function(){return client&&(client.input.vStack.$action||(client.input.lastTriggerExecuted?client.input.lastTriggerExecuted.value:""))||""},configurable:!0}),Object.defineProperty(window,"$trigger",{get:function(){return client&&(client.input.vStack.$trigger||client.input.lastTriggered)||""},configurable:!0}),Object.defineProperty(window,"$caption",{get:function(){return client&&client.input.vStack.$caption||""},configurable:!0}),client.input.on("history-navigate",()=>{(client.getOption("commandAutoSize")||client.getOption("commandScrollbars"))&&Ye()}),client.on("options-loaded",()=>{if(client.commandInput.removeEventListener("input",Ye),client.commandInput.removeEventListener("change",Ye),Zi(),Ji(),(client.getOption("commandAutoSize")||client.getOption("commandScrollbars"))&&Ye(),le&&(le.resetState(client.getOption("windows.editor")||{center:!0}),oe.simple!=client.getOption("simpleEditor"))){let u="";oe.isSimple||(u=oe.getFormattedText().replace(/(?:\r)/g,"")),oe.simple=client.getOption("simpleEditor"),oe.isSimple?(oe.value=u,le.showFooter(),le.header.querySelector("#adv-editor-switch").title="Switch to advanced",setTimeout(()=>oe.focus(),100)):(le.hideFooter(),le.header.querySelector("#adv-editor-switch").title="Switch to simple")}V.history&&V.history.resetState(client.getOption("windows.history")||{center:!0,width:400,height:275}),V.profiles&&V.profiles.resetState(client.getOption("windows.profiles")||{center:!0,width:400,height:275})}),client.on("set-title",u=>{window.document.title=u}),client.on("connected",()=>ct(1)),client.on("closed",()=>ct(0)),client.on("received-data",()=>{!client.active&&client.connected&&ct(2)}),client.on("focus",()=>{client.connected?ct(1):ct(0)}),client.on("print",()=>{!client.active&&client.connected&&ct(2)}),client.display.on("selection-done",u=>{client.getOption("AutoCopySelectedToClipboard")&&client.display.hasSelection&&(Oe(client.display.selection),client.display.clearSelection())}),client.on("profiles-loaded",()=>{Os()}),client.on("notify",(u,t,e)=>{if(!(!client.getOption("enableNotifications")||!("Notification"in window))){switch(e=e||{silent:!0},Object.prototype.hasOwnProperty.call(e,"silent")||(e.silent=!0),wi){case 1:e.icon=e.icon||"images/connected.png";break;case 2:e.icon=e.icon||"images/active.png";break;default:e.icon=e.icon||"images/disconnected.png";break}if(t&&(e.body=t,e.body.length>127&&(e.body=e.body.substr(0,127)+"...")),Notification.permission==="granted"){var s=new window.Notification(u,e);s.onclick=()=>{client.emit("notify-clicked",u,t),client.raise("notify-clicked",[u,t])},s.onclose=()=>{client.emit("notify-closed",u,t),client.raise("notify-closed",[u,t])}}else Notification.permission!=="denied"?Notification.requestPermission().then(n=>{if(n==="granted"){var r=new window.Notification(u,e);r.onclick=()=>{client.emit("notify-clicked",u,t),client.raise("notify-clicked",[u,t])},r.onclose=()=>{client.emit("notify-closed",u,t),client.raise("notify-closed",[u,t])}}else client.echo("Notification permission denied.",-7,-8,!0,!0)}):client.echo("Notification permission denied.",-7,-8,!0,!0)}}),client.on("window",(u,t,e)=>{switch(u){case"editor":case"help":case"about":t==="close"?nt(u):Me(u);break;case"profiles":case"profiles-manager":case"profile-manager":case"manager":t==="close"?nt("profiles"):Me("profiles");break;case"prefs":case"options":case"preferences":t==="close"?nt("settings"):Me("settings");break;case"history":case"command-history":t==="close"?nt("history"):Me("history");break}}),document.getElementById("btn-adv-editor").addEventListener("click",u=>{Me("editor")}),m=client.getOption("windows.editor"),m&&m.show&&document.getElementById("btn-adv-editor").click(),m=client.getOption("windows.history"),m&&m.show&&Me("history"),m=client.getOption("windows.profiles"),m&&m.show&&Me("profiles"),document.getElementById("btn-command-history").addEventListener("show.bs.dropdown",function(){document.body.appendChild(document.getElementById("command-history-menu"));let u="",t=document.getElementById("command-history-menu"),e=client.commandHistory;for(let n=0,r=e.length;n<r;n++)u+=`<li id="command-history-item-${n}"><a data-index="${n}" class="dropdown-item" href="javascript:void(0)">${e[n]}</a></li>`;e.length&&(u+='<li><hr class="dropdown-divider"></li>',u+='<li><a id="history-clear" class="dropdown-item" href="javascript:void(0)">Clear history</a></li>'),u+='<li><a id="history-show" class="dropdown-item" href="javascript:void(0)">Show history window...</a></li>',t.innerHTML=u,e.length&&t.querySelector("#history-clear").addEventListener("click",()=>{confirm_box("Clear history?","Clear all history").then(n=>{n.button===4&&client.clearCommandHistory()})}),t.querySelector("#history-show").addEventListener("click",()=>Me("history"));let s=document.querySelectorAll('[id^="command-history-item"] a');for(let n=0,r=s.length;n<r;n++)s[n].addEventListener("click",a=>{var o=client.commandHistory[parseInt(a.currentTarget.dataset.index,10)];client.AddCommandToHistory(o),client.sendCommand(o,null,client.getOption("allowCommentsFromCommand"))})}),document.getElementById("btn-command-history").addEventListener("hidden.bs.dropdown",function(){document.getElementById("btn-command-history").parentElement.appendChild(document.getElementById("command-history-menu"))}),client.commandInput.removeEventListener("input",Ye),client.commandInput.removeEventListener("change",Ye),Zi(),Ji(),(client.getOption("commandAutoSize")||client.getOption("commandScrollbars"))&&Ye(),window.addEventListener("keydown",u=>{u.which===33?client.display.pageUp():u.which===34&&client.display.pageDown()}),window.addEventListener("error",u=>{let{message:t,filename:e,lineno:s,colno:n,error:r}=u;if(!t.includes("ResizeObserver loop completed with undelivered notifications"))return client?(r?client.error(r):t.startsWith("Uncaught Error: ")?client.error(`${t.substr(16)}`):client.error(`${t}`),client.getOption("enableDebug")&&(client.error("Url: "+e),client.error("Line: "+s),client.error("Column: "+n),client.error(r))):(console.error("Message: "+t),console.error("Url: "+e),console.error("Line: "+s),console.error("Column: "+n),console.error(r)),!0}),window.addEventListener("mousemove",u=>{Ee=u}),window.addEventListener("hashchange",Qi,!1),window.addEventListener("load",Qi),client.on("command-history-changed",u=>{_i()}),ts()}function we(m){if(!(!m||m.length===0)){m=m.trim(),m.startsWith("#")&&(m=m.substring(1));var u=decodeURI(window.location.hash.substring(1)).split(",").filter(t=>t.trim()!==m);window.location.hash=u.join(",")}}function ul(m){if(!(!m||m.length===0)){m=m.trim(),m.startsWith("#")&&(m=m.substring(1));var u=decodeURI(window.location.hash.substring(1)).split(",").filter(t=>t.trim()!==m);u.push(m),window.location.hash=u.join(",")}}function ht(m,u){Array.isArray(m)||(m=[m]),u=u||[],Array.isArray(u)||(u=[u]),u=u.concat(...m);var t=decodeURI(window.location.hash.substring(1)).split(",").filter(e=>!u.includes(e.trim()));t=t.concat(...m),window.location.hash=t.join(",")}function Qi(){if(!(!window.location.hash||window.location.hash.length<2)){var m=decodeURI(window.location.hash.substring(1)).split(",").map(u=>u.trim());for(let u=m.length-1;u>=0;u--)switch(m[u]){case"about":Me("about");break;case"editor":document.getElementById("btn-adv-editor").click();break;default:m[u]==="history"||m[u].startsWith("settings")||m[u].startsWith("profiles")?Me(m[u]):client.emit("window",m[u]);break}}}var V={};function Me(m){switch(m){case"about":return V.about||(V.about=new ve({title:'<i class="bi-info-circle"></i> About',noFooter:!0,resizable:!1,center:!0,maximizable:!1}),V.about.on("closed",()=>{delete V.about,we(m)}),V.about.on("canceled",()=>{delete V.about,we(m)})),Ki(V.about,m,1,!0).catch(u=>{client.error(u)}),V.about;case"history":if(!V.history){V.history=new ve(Object.assign({},client.getOption("windows.history")||{center:!0,width:400,height:275},{title:'<i class="bi bi-clock-history"></i> Command history',id:"command-history"})),V.history.on("closed",()=>{client.setOption("windows.history",V.history.windowState),delete V.history,we(m)}),V.history.on("canceled",()=>{client.setOption("windows.history",V.history.windowState),we("history"),delete V.history,we(m)}),V.history.on("resized",t=>{client.setOption("windows.history",t)}),V.history.on("moved",t=>{client.setOption("windows.history",t)}),V.history.on("maximized",()=>{client.setOption("windows.history",V.history.windowState)}),V.history.on("restored",()=>{client.setOption("windows.history",V.history.windowState)}),V.history.on("shown",()=>{client.setOption("windows.history",V.history.windowState)});let u="";u+=`<button id="${V.history.id}-clear" type="button" class="btn-sm float-end btn btn-danger" title="Clear history"><i class="bi bi-trash"></i><span class="icon-only"> Clear</span></button>`,u+=`<button id="${V.history.id}-send" type="button" class="btn-sm float-end btn btn-primary" title="Send"><i class="bi bi-send-fill"></i><span class="icon-only"> Send</span></button>`,u+=`<button id="${V.history.id}-refresh" type="button" class="btn-sm float-start btn btn-light" title="Refresh"><i class="bi bi-arrow-repeat"></i><span class="icon-only"> Refresh</span></button>`,V.history.footer.innerHTML=u,V.history.body.innerHTML='<select id="history-list" multiple="multiple" class="form-select"></select>',V.history.body.querySelector("#history-list").addEventListener("dblclick",t=>{let e=t.currentTarget.value;client.AddCommandToHistory(e),client.sendCommand(e,!1,client.getOption("allowCommentsFromCommand")),V.history.close()}),V.history.body.querySelector("#history-list").addEventListener("change",t=>{client.setHistoryIndex(t.currentTarget.selectedIndex),V.history.footer.querySelector(`#${V.history.id}-send`).style.display=history.length&&V.history.body.querySelector("#history-list").selectedIndex!==-1?"":"none"}),V.history.footer.querySelector(`#${V.history.id}-refresh`).addEventListener("click",()=>_i()),V.history.footer.querySelector(`#${V.history.id}-send`).addEventListener("click",()=>{let t=V.history.body.querySelector("#history-list"),e=[];for(let s=0,n=t.options.length;s<n;s++)t.options[s].selected&&e.push(t.options[s].value);for(let s=0,n=e.length;s<n;s++)client.AddCommandToHistory(e[s]),client.sendCommand(e[s],!1,client.getOption("allowCommentsFromCommand"))}),V.history.footer.querySelector(`#${V.history.id}-clear`).addEventListener("click",()=>{confirm_box("Clear history?","Clear all history").then(t=>{t.button===4&&client.clearCommandHistory()})})}return _i(),V.history.show(),V.history;case"editor":if(!le){le=new ve(Object.assign({},client.getOption("windows.editor")||{center:!0},{title:'<i class="fas fa-edit"></i> Advanced editor',id:"adv-editor"})),le.on("resized",t=>{client.setOption("windows.editor",t)}),le.on("moved",t=>{client.setOption("windows.editor",t)}),le.on("maximized",()=>{client.setOption("windows.editor",le.windowState)}),le.on("restored",()=>{client.setOption("windows.editor",le.windowState)}),le.on("shown",()=>{client.setOption("windows.editor",le.windowState),oe.initialize()}),le.on("closing",()=>{oe.remove()}),le.on("closed",()=>{client.setOption("windows.editor",le.windowState),we("editor")}),le.on("canceling",()=>{oe.remove()}),le.on("canceled",()=>{client.setOption("windows.editor",le.windowState),we("editor")}),le.on("focus",()=>oe.focus());let u=document.createElement("textarea");u.classList.add("form-control","form-control-sm"),u.id="adv-editor-txt",le.body.appendChild(u),le.body.style.overflow="hidden",oe||(oe=new Kt(u,!client.getOption("simpleEditor"))),oe.on("close",()=>{le.close()}),oe.on("editor-init",()=>oe.focus()),oe.on("click",()=>le.focus()),le.dialog.editor=oe,tinymce&&le.header.querySelector("#adv-editor-max").insertAdjacentHTML("afterend",'<button type="button" class="btn btn-light float-end" id="adv-editor-switch" title="Switch to advanced" style="padding: 0 4px;margin-top: -1px;"><i class="bi-shuffle"></i></button>'),le.footer.innerHTML=`<button id="btn-adv-editor-clear" type="button" class="btn-sm float-start btn btn-light" title="Clear editor"><i class="bi bi-journal-x"></i><span class="icon-only"> Clear</span></button>
                    <button id="btn-adv-editor-append" type="button" class="btn-sm float-start btn btn-light" title="Append file..."><i class="bi bi-box-arrow-in-down"></i><span class="icon-only"> Append file...</span></button>
                    <button id="btn-adv-editor-send" type="button" class="btn-sm float-end btn btn-primary" title="Send"><i class="bi bi-send-fill"></i><span class="icon-only"> Send</span></button>`,oe.isSimple||(le.header.querySelector("#adv-editor-switch").title="Switch to simple"),le.header.querySelector("#adv-editor-switch").addEventListener("click",()=>{client.setOption("simpleEditor",!oe.simple);let t="";oe.isSimple||(t=oe.getFormattedText().replace(/(?:\r)/g,"")),oe.simple=!oe.simple,oe.isSimple?(oe.value=t,le.showFooter(),le.header.querySelector("#adv-editor-switch").title="Switch to advanced",setTimeout(()=>oe.focus(),100)):(le.hideFooter(),le.header.querySelector("#adv-editor-switch").title="Switch to simple")}),document.getElementById("btn-adv-editor-append").addEventListener("click",()=>{ge("Append file",!1).then(t=>{be(t[0]).then(e=>{oe.insert(e)}).catch(client.error)}).catch(()=>{})}),document.getElementById("btn-adv-editor-send").addEventListener("click",()=>{client.sendCommand(oe.value()),client.getOption("editorClearOnSend")&&oe.clear(),client.getOption("editorCloseOnSend")&&le.close()}),document.getElementById("btn-adv-editor-clear").addEventListener("click",()=>{oe.clear(),oe.focus()}),oe.isSimple||le.hideFooter()}return le.show(),oe.isSimple&&oe.focus(),le}if(m.startsWith("settings"))return V.settings||(V.settings=new Zt,V.settings.on("closed",()=>{delete V.settings}),V.settings.on("canceled",()=>{delete V.settings})),m==="settings"?(V.settings.dialog.dataset.path=m,V.settings.dialog.dataset.fullPath=m,V.settings.dialog.dataset.hash=window.location.hash,V.settings.setBody("",{client}),V.settings.showModal()):Ki(V.settings,m,2,!1).catch(u=>{client.error(u)}),V.settings;if(m.startsWith("profiles"))return V.profiles||(V.profiles=new Jt,V.profiles.on("closed",()=>{delete V.profiles}),V.profiles.on("canceled",()=>{delete V.profiles})),V.profiles.dialog.dataset.path=m,V.profiles.dialog.dataset.fullPath=m,V.profiles.dialog.dataset.hash=window.location.hash,V.profiles.setBody("",{client}),V.profiles.show(),V.profiles}function Ki(m,u,t,e){return new Promise((s,n)=>{var r=u.split("/");$.ajax({url:"dialogs/"+r[0]+".htm",cache:!1,type:"GET"}).done(function(a){m.dialog.dataset.path=r[0],m.dialog.dataset.fullPath=u,m.dialog.dataset.hash=window.location.hash,m.setBody(a,{client}),t==1?m.show():t===2&&m.showModal(),s(a)}).fail(function(a){e&&client.enableDebug?m.setBody(`<h1 style="width: 100%;text-align:center">Error loading ${u}</h1> ${a.statusText}`):e?m.setBody(`<h1 style="width: 100%;text-align:center">Error loading ${u}</h1>`):m.setBody(""),n(u+": "+r.statusText)})})}function nt(m){V[m]?V[m].close():m==="editor"&&le&&le.close()}function _i(){if(!V.history)return;let m=document.getElementById("history-list");m.innerHTML="";let u=client.commandHistory;for(var t=document.createDocumentFragment(),e=0,s=u.length;e<s;e++){var n=document.createElement("option");n.appendChild(document.createTextNode(u[e])),n.value=u[e],t.append(n)}m.appendChild(t),V.history.footer.querySelector(`#${V.history.id}-clear`).style.display=u.length?"":"none",V.history.footer.querySelector(`#${V.history.id}-send`).style.display=u.length&&m.selectedIndex!==-1?"":"none"}function Ye(){fe(()=>{Bs()},250,"resizeCommand")}async function Zi(){(client.getOption("commandAutoSize")||client.getOption("commandScrollbars"))&&(client.commandInput.addEventListener("input",Ye),client.commandInput.addEventListener("change",Ye)),client.getOption("commandWordWrap")?(document.getElementById("commandMeasure").style.whiteSpace="pre-wrap",document.getElementById("commandMeasure").style.overflowWrap="anywhere"):(document.getElementById("commandMeasure").style.whiteSpace="",document.getElementById("commandMeasure").style.overflowWrap=""),client.getOption("commandScrollbars")?(document.getElementById("commandMeasure").style.overflow="auto",client.commandInput.style.overflow="auto"):(document.getElementById("commandMeasure").style.overflow="",client.commandInput.style.overflow="")}var St={};function Ji(){let m=document.getElementById("commandMeasure");document.body.appendChild(m);let u=client.commandInput.parentElement,t=window.getComputedStyle(u);m.style.fontSize=client.commandInput.style.fontSize,m.style.fontFamily=client.commandInput.style.fontFamily,m.style.width=client.commandInput.offsetWidth+"px";let e=m.innerHTML;m.innerHTML="W";let s=client.getOption("commandMinLines"),n=m.offsetHeight;s=n*(s<1?1:s);let r=parseFloat(t.borderTopWidth)||0;r+=parseFloat(t.borderBottomWidth)||0,r+=parseFloat(t.paddingTop)||0,r+=parseFloat(t.paddingBottom)||0;let a=t.inset.split(" ");r+=(parseFloat(a[0])||0)*2,m.innerHTML=e,u.style.height=n+r+"px",client.commandInput.parentElement.style.height=n+"px",client.commandInput.closest("nav").style.height=n+6+"px",client.display.container.style.bottom=n+r+"px",St={measure:m,cmd:u,cmdSize:t,height:n,padding:r,minHeight:s}}function Bs(){let m=St.measure,u=St.cmd;m.innerHTML=client.commandInput.value+`
`;let t=m.offsetHeight;t<St.minHeight&&(t=St.minHeight);let e=St.padding;u.style.height=t+e+"px",client.commandInput.parentElement.style.height=t+"px",client.commandInput.closest("nav").style.height=t+6+"px",client.display.container.style.bottom=t+e+"px"}function ct(m){if(wi===m)return;wi=m;let u="disconnected";switch(m){case 1:u="connected";break;case 2:u="active";break}document.getElementById("icon1").remove(),document.getElementById("icon2").remove(),document.getElementById("icon3").remove(),document.querySelector("head").insertAdjacentHTML("afterbegin",`<link id="icon1" rel="shortcut icon" href="images/${u}.ico" />
        <link id="icon2" rel="icon" href="images/${u}.ico" />
        <link id="icon3" rel="icon" type="image/x-icon" href="images/${u}.png" />`)}function qi(){client.setOption("showButtons",!client.getOption("showButtons")),ts()}function Rs(m,u){var t="",e="",s=m.caption,n=0;if(s.substring(0,3)==="fa-"?(s=s.split(","),s.length>1?s='<i class="fas '+s[0]+' fa-fw" data-fa-transform="'+s[1]+'"></i>':s='<i class="fas '+s[0]+' fa-fw"></i>',n=26):s.substring(0,4)==="fas-"?(s=s.split(","),s.length>1?s='<i class="fas fa-'+s[0].substring(4)+' fa-fw" data-fa-transform="'+s[1]+'"></i>':s='<i class="fas fa-'+s[0].substring(4)+' fa-fw"></i>',n=26):s.substring(0,4)==="far-"?(s=s.split(","),s.length>1?s='<i class="far fa-'+s[0].substring(4)+' fa-fw" data-fa-transform="'+s[1]+'"></i>':s='<i class="far fa-'+s[0].substring(4)+' fa-fw"></i>',n=26):s.substring(0,4)==="fab-"?(s=s.split(","),s.length>1?s='<i class="fab fa-'+s[0].substring(4)+' fa-fw" data-fa-transform="'+s[1]+'"></i>':s='<i class="fab fa-'+s[0].substring(4)+' fa-fw"></i>',n=26):s.substring(0,7)==="http://"||s.substring(0,7)==="https://"?s='<img src="'+s+'" style="max-width: '+m.width+"px;max-height:"+m.height+'px"/>':(m.iconOnly||(s=m.caption),e=m.caption),m.icon&&m.icon.length){var r=m.icon;r.substring(0,3)==="fa-"?(r=r.split(","),r.length>1?r='<i class="fas '+r[0]+' fa-fw" data-fa-transform="'+r[1]+'"></i>':r='<i class="fas '+r[0]+' fa-fw"></i>',n=26):r.substring(0,4)==="fas-"?(r=r.split(","),r.length>1?r='<i class="fas fa-'+r[0].substring(4)+' fa-fw" data-fa-transform="'+r[1]+'"></i>':r='<i class="fas fa-'+r[0].substring(4)+' fa-fw"></i>',n=26):r.substring(0,4)==="far-"?(r=r.split(","),r.length>1?r='<i class="far fa-'+r[0].substring(4)+' fa-fw" data-fa-transform="'+r[1]+'"></i>':r='<i class="far fa-'+r[0].substring(4)+' fa-fw"></i>',n=26):r.substring(0,4)==="fab-"?(r=r.split(","),r.length>1?r='<i class="fab fa-'+r[0].substring(4)+' fa-fw" data-fa-transform="'+r[1]+'"></i>':r='<i class="fab fa-'+r[0].substring(4)+' fa-fw"></i>',n=26):m.icon.length&&(r='<img src="'+r+'" style="max-width: '+m.width+"px;max-height:"+m.height+'px"/>'),m.iconOnly?s=r:s=r+s}return t+="<button",t+=' data-index="'+u+'"',m.name&&m.name.length!==0&&(t+=' id="button-'+m.name+'"'),t+=' class="user-button" style="',m.left===-1&&m.right===-1&&m.top===-1&&m.bottom===-1?t+="position: static;margin-right:2px;margin-top:2px;":(m.left>=0&&(t+="left:"+(m.left||0)+"px;"),m.top>=0&&(t+="top:"+(m.top||0)+"px;"),m.bottom>=0&&(t+="bottom:"+(m.bottom||0)+"px;"),m.right>=0&&(t+="right:"+(m.right||0)+"px;"),m.right===-1&&m.left===-1&&(t+="right:0px;"),m.bottom===-1&&m.top===-1&&(t+="top:0px;")),m.width?t+="width: "+m.width+"px;":n===26&&(t+="min-width: 26px;"),m.height&&(t+="height: "+m.height+"px;"),t+='" title="'+e+'" draggable="true" data-index="'+u+'">'+s+"</button>",t}function ts(){client.getOption("showButtons")?document.getElementById("buttons").style.visibility="visible":document.getElementById("buttons").style.visibility=""}function Os(){var m="",u=client.buttons,t,e;for(t=0,e=u.length;t<e;t++)u[t].enabled&&(m+=Rs(u[t],t));document.getElementById("buttons").innerHTML=m;let s=document.querySelectorAll("#buttons button");for(let n=0,r=s.length;n<r;n++)s[n].addEventListener("click",a=>{Ds(a.currentTarget,+a.currentTarget.dataset.index)}),As(s[n])}function Ds(m,u){if(u<0)return!1;if(m.dataset.moving==="true"){delete m.dataset.moving;return}var t=client.buttons;if(u>=t.length)return!1;var e=t[u];if(!e.enabled)return!1;var s;switch(e.style){case 1:s=client.parseOutgoing(e.value);break;case 2:var n=new Function("try { "+e.value+"} catch (e) { if(this.options.showScriptErrors) this.error(e);}");s=n.apply(client);break;default:s=e.value;break}if(s===null||typeof s>"u")return!0;if(e.send){if(s.endsWith(`
`)||(s+=`
`),e.chain&&client.commandInput.value.endsWith(" "))return client.commandInput.value+=s,client.sendCommand(),!0;client.connected&&client.send(s),client.telnet.echo&&client.getOption("commandEcho")&&client.echo(s)}else e.append&&(client.commandInput.value+=s);return!0}function As(m){var u=0,t=0,e;document.getElementById(m.id+"header")?document.getElementById(m.id+"header").onmousedown=s:(m.onmousedown=s,m.ontouchstart=a,m.onmouseleave=n);function s(c){if(c=c||window.event,c.buttons===1){c.preventDefault();var g=m.getBoundingClientRect();u=c.pageX-g.left,t=c.pageY-g.top,document.onmouseup=h,e=setTimeout(function(){document.onmousemove=r,e=null},500)}}function n(){e&&h()}function r(c){c=c||window.event,c.preventDefault(),m.style.position="absolute",m.style.top=c.pageY-t+"px",m.style.left=c.pageX-document.body.clientWidth-u+"px",m.dataset.moving="true"}function a(c){if(c=c||window.event,!!c.touches.length){var g=m.getBoundingClientRect();u=c.touches[0].pageX-g.left,t=c.touches[0].pageY-g.top,document.ontouchend=h,e=setTimeout(function(){document.ontouchmove=o,e=null},500)}}function o(c){c=c||window.event,c.preventDefault(),m.style.position="absolute",c.touches.length&&(m.style.top=c.touches[0].pageY-t+"px",m.style.left=c.touches[0].pageX-document.body.clientWidth-u+"px",m.dataset.moving="true")}function h(){var c=m.getBoundingClientRect(),g=parseInt(m.dataset.index,10);if(!(g<0)){var f=client.buttons;if(!(g>=f.length)){var w=f[g];w.enabled&&(w.left===-1&&w.right===-1&&w.top===-1&&w.bottom===-1?(w.top=c.top||-1,w.right=document.body.clientWidth-c.right||-1):(w.left>=0&&(w.left=document.body.clientWidth-c.left||-1),w.top>=0&&(w.top=c.top||-1),w.bottom>=0&&(w.bottom=c.bottom||-1),w.right>=0&&(w.right=document.body.clientWidth-c.right||-1),w.right===-1&&w.left===-1&&(w.right=document.body.clientWidth-c.right||-1),w.bottom===-1&&w.top===-1&&(w.top=c.top||-1)),document.onmouseup=null,document.onmousemove=null,document.ontouchend=null,document.ontouchmove=null,clearTimeout(e),client.saveProfiles())}}}}window.initializeInterface=Ms;var is='<div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="mapper-menu" aria-labelledby="mapper-menu-Label" style="position: absolute;"><div class="offcanvas-body"><button type="button" class="btn btn-close text-reset btn-danger btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close" style="position: absolute;right: 5px;top: 5px;"></button><ul class="navbar-nav justify-content-end flex-grow-1"><li id="mapper-enable" class="nav-item" title="Enable"><a class="nav-link" href="javascript:void(0)"><i class="bi bi-map"></i>&nbsp;<span>Enabled</span></a></li><li id="mapper-legend" class="nav-item" title="Show legend"><a class="nav-link" href="javascript:void(0)"><i class="fa fa-map-marker"></i>&nbsp;<span>Show legend</span></a></li><li id="mapper-room" class="nav-item" title="Show room properties"><a class="nav-link" href="javascript:void(0)"><i class="fa fa-list-alt"></i>&nbsp;<span>Show room properties</span></a></li><li><hr class="dropdown-divider"></li><li id="mapper-refresh" class="nav-item" title="Refresh"><a class="nav-link" href="javascript:void(0)"><i class="fa fa-refresh"></i>&nbsp;<span>Refresh</span></a></li><li><hr class="dropdown-divider"></li><li id="mapper-split" class="nav-item" title="Split areas"><a class="nav-link" href="javascript:void(0)"><i class="fa fa-object-ungroup"></i>&nbsp;<span>Split areas</span></a></li><li id="mapper-fill" class="nav-item" title="Fill walls"><a class="nav-link" href="javascript:void(0)"><i class="fa fa-building"></i>&nbsp;<span>Fill walls</span></a></li><li><hr class="dropdown-divider"></li><li id="mapper-remove" class="nav-item"><a class="nav-link" href="javascript:void(0)" role="button" data-bs-target="#remove-submenu" data-bs-toggle="collapse" aria-expanded="false" aria-controls="remove-submenu"><i class="fa fa-eraser"></i>&nbsp;<span>Remove</span></a><ul class="navbar-nav justify-content-end flex-grow-1 collapse" id="remove-submenu"><li class="nav-item" id="mapper-remove-selected"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Remove selected room</a></li><li class="nav-item" id="mapper-remove-current"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Remove current room</a></li><li><hr class="dropdown-divider"></li><li id="mapper-remove-current-area" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Remove current area</a></li><li id="mapper-remove-all" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Remove all</a></li></ul></li><li id="mapper-export" class="nav-item"><a class="nav-link" href="javascript:void(0)" role="button" data-bs-target="#export-submenu" data-bs-toggle="collapse" aria-expanded="false" aria-controls="export-submenu"><i class="fa fa-exchange"></i>&nbsp;<span>Export/Import</span></a><ul class="navbar-nav justify-content-end flex-grow-1 collapse" id="export-submenu"><li id="mapper-export-image" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Export as image</a></li><li id="mapper-export-scaled-image" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Export as scaled image</a></li><li id="mapper-export-current-image" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Export current view as image</a></li><li><hr class="dropdown-divider"></li><li id="mapper-export-current-area" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Export current area</a></li><li id="mapper-export-all" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Export all</a></li><li><hr class="dropdown-divider"></li><li id="mapper-import-merge" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Import and merge</a></li><li id="mapper-import-replace" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Import and replace</a></li></ul></li><li><hr class="dropdown-divider"></li><li id="mapper-export" class="nav-item"><a class="nav-link" href="javascript:void(0)" role="button" data-bs-target="#actions-submenu" data-bs-toggle="collapse" aria-expanded="false" aria-controls="actions-submenu"><i class="fa-solid fa-shoe-prints"></i>&nbsp;<span>Actions</span></a><ul class="navbar-nav justify-content-end flex-grow-1 collapse" id="actions-submenu"><li id="mapper-follow" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Follow</a></li><li><hr class="dropdown-divider"></li><li id="mapper-focus" class="nav-item"><a class="nav-link" href="javascript:void(0)" style="padding-left: 40px;">Focus on current room</a></li><li id="mapper-set-current" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Set selected as current</a></li><li><hr class="dropdown-divider"></li><li id="mapper-highlight-path" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Highlight path</a></li><li id="mapper-clear-path" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Clear path</a></li><li><hr class="dropdown-divider"></li><li id="mapper-walk-path" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Walk path</a></li><li id="mapper-walk-highlighted-path" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Walk highlighted path</a></li><li><hr class="dropdown-divider"></li><li id="mapper-copy-path" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Copy path</a></li><li id="mapper-copy-stacked" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Copy as stacked</a></li><li id="mapper-copy-speedpath" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Copy as speedpath</a></li><li id="mapper-copy-highlighted-path" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Copy highlighted path</a></li><li id="mapper-copy-highlighted-stacked" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Copy highlighted as stacked</a></li><li id="mapper-copy-highlighted-speedpath" class="nav-item"><a class="nav-link disabled" href="javascript:void(0)" style="padding-left: 40px;">Copy highlighted as speedpath</a></li></ul></li><li><hr class="dropdown-divider"></li><li id="mapper-about" class="nav-item" title="About map"><a class="nav-link" href="javascript:void(0)"><i class="bi-info-circle"></i>&nbsp;<span>About</span></a></li></ul></div></div>';var ss='<div class="dialog-header"><button id="mapper-room-close" style="padding: 4px;" type="button" class="btn btn-close float-end btn-danger" data-dismiss="modal" title="Hide properties"></button><div><i class="fa fa-list-alt"></i>&nbsp;Room properties</div></div><div class="accordion" id="mapper-room-accordion"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#mapper-room-general" aria-expanded="true" aria-controls="General">General </button></h2><div id="mapper-room-general" class="accordion-collapse collapse show" data-bs-parent="#mapper-room-accordion"><div class="accordion-body" style="padding: 5px;"><div class="mb-3"><label for="mapper-room-name">Name</label><input type="text" class="form-control" id="mapper-room-name" placeholder=""></div><div class="mb-3"><label for="mapper-room-background">Background</label><input type="text" class="form-control" id="mapper-room-background" placeholder=""></div></div></div></div><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mapper-room-location" aria-expanded="true" aria-controls="mapper-room-location">Location </button></h2><div id="mapper-room-location" class="accordion-collapse collapse" data-bs-parent="#mapper-room-accordion"><div class="accordion-body" style="padding: 5px;"><div class="mb-3"><label for="mapper-room-area" class="form-label">Area</label><select id="mapper-room-area" class="form-select"></select></div><div class="mb-3"><label for="mapper-room-x" class="form-label">X</label><input type="number" class="form-control" id="mapper-room-x"></div><div class="mb-3"><label for="mapper-room-y" class="form-label">Y</label><input type="number" class="form-control" id="mapper-room-y"></div><div class="mb-3"><label for="mapper-room-z" class="form-label">Z</label><input type="number" class="form-control" id="mapper-room-z"></div><div class="mb-3"><label for="mapper-room-zone" class="form-label">Zone</label><input type="number" class="form-control" id="mapper-room-zone"></div></div></div></div><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mapper-room-details" aria-expanded="true" aria-controls="mapper-room-details">Details </button></h2><div id="mapper-room-details" class="accordion-collapse collapse" data-bs-parent="#mapper-room-accordion"><div class="accordion-body" style="padding: 5px;"><div class="form-check form-switch"><input type="checkbox" class="form-check-input" id="mapper-room-indoors"><label class="form-check-label" for="mapper-room-indoors">Indoors</label></div><div class="mb-3"><label for="font" class="form-label">Terrain</label><div class="input-group"><input id="mapper-room-env" type="text" class="form-control" aria-label="Room terrain"><button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" style="border: var(--bs-border-width) solid var(--bs-border-color);" data-bs-toggle="dropdown" aria-expanded="false"><span class="visually-hidden">Toggle Dropdown</span></button><ul id="mapper-room-terrains" class="dropdown-menu dropdown-menu-end" style="height: 200px;overflow: auto;"><li><a class="dropdown-item" href="javascript:void(0)">beach</a></li><li><a class="dropdown-item" href="javascript:void(0)">bog</a></li><li><a class="dropdown-item" href="javascript:void(0)">city</a></li><li><a class="dropdown-item" href="javascript:void(0)">cliff</a></li><li><a class="dropdown-item" href="javascript:void(0)">cobble</a></li><li><a class="dropdown-item" href="javascript:void(0)">desert</a></li><li><a class="dropdown-item" href="javascript:void(0)">dirt</a></li><li><a class="dropdown-item" href="javascript:void(0)">dirtroad</a></li><li><a class="dropdown-item" href="javascript:void(0)">farmland</a></li><li><a class="dropdown-item" href="javascript:void(0)">forest</a></li><li><a class="dropdown-item" href="javascript:void(0)">grass</a></li><li><a class="dropdown-item" href="javascript:void(0)">grassland</a></li><li><a class="dropdown-item" href="javascript:void(0)">highmountain</a></li><li><a class="dropdown-item" href="javascript:void(0)">hills</a></li><li><a class="dropdown-item" href="javascript:void(0)">icesheet</a></li><li><a class="dropdown-item" href="javascript:void(0)">jungle</a></li><li><a class="dropdown-item" href="javascript:void(0)">lake</a></li><li><a class="dropdown-item" href="javascript:void(0)">mountain</a></li><li><a class="dropdown-item" href="javascript:void(0)">ocean</a></li><li><a class="dropdown-item" href="javascript:void(0)">pavedroad</a></li><li><a class="dropdown-item" href="javascript:void(0)">plains</a></li><li><a class="dropdown-item" href="javascript:void(0)">prairie</a></li><li><a class="dropdown-item" href="javascript:void(0)">river</a></li><li><a class="dropdown-item" href="javascript:void(0)">rockdesert</a></li><li><a class="dropdown-item" href="javascript:void(0)">rocky</a></li><li><a class="dropdown-item" href="javascript:void(0)">sand</a></li><li><a class="dropdown-item" href="javascript:void(0)">sanddesert</a></li><li><a class="dropdown-item" href="javascript:void(0)">savannah</a></li><li><a class="dropdown-item" href="javascript:void(0)">stone</a></li><li><a class="dropdown-item" href="javascript:void(0)">swamp</a></li><li><a class="dropdown-item" href="javascript:void(0)">tundra</a></li><li><a class="dropdown-item" href="javascript:void(0)">underwater</a></li><li><a class="dropdown-item" href="javascript:void(0)">water</a></li></ul></div></div><div><label for="font" class="form-label">Details</label></div><div class="form-check"><input class="form-check-input" type="checkbox" value="1" id="mapper-room-details-1" name="details" data-enum="true"><label class="form-check-label" for="mapper-room-details-1">Dock</label></div><div class="form-check"><input class="form-check-input" type="checkbox" value="2" id="mapper-room-details-2" name="details" data-enum="true"><label class="form-check-label" for="mapper-room-details-2">Pier</label></div><div class="form-check"><input class="form-check-input" type="checkbox" value="4" id="mapper-room-details-4" name="details" data-enum="true"><label class="form-check-label" for="mapper-room-details-4">Bank</label></div><div class="form-check"><input class="form-check-input" type="checkbox" value="8" id="mapper-room-details-8" name="details" data-enum="true"><label class="form-check-label" for="mapper-room-details-8">Shop</label></div><div class="form-check"><input class="form-check-input" type="checkbox" value="16" id="mapper-room-details-16" name="details" data-enum="true"><label class="form-check-label" for="mapper-room-details-16">Hospital</label></div><div class="form-check"><input class="form-check-input" type="checkbox" value="32" id="mapper-room-details-32" name="details" data-enum="true"><label class="form-check-label" for="mapper-room-details-32">Bar</label></div><div class="form-check"><input class="form-check-input" type="checkbox" value="64" id="mapper-room-details-64" name="details" data-enum="true"><label class="form-check-label" for="mapper-room-details-64">Restaurant</label></div><div class="form-check"><input class="form-check-input" type="checkbox" value="128" id="mapper-room-details-128" name="details" data-enum="true"><label class="form-check-label" for="mapper-room-details-128">WaterSource</label></div><div class="form-check"><input class="form-check-input" type="checkbox" value="256" id="mapper-room-details-256" name="details" data-enum="true"><label class="form-check-label" for="mapper-room-details-256">Trainer</label></div><div class="form-check"><input class="form-check-input" type="checkbox" value="512" id="mapper-room-details-512" name="details" data-enum="true"><label class="form-check-label" for="mapper-room-details-512">Stable</label></div></div></div></div><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mapper-room-notes" aria-expanded="true" aria-controls="mapper-room-notes">Notes </button></h2><div id="mapper-room-notes" class="accordion-collapse collapse" data-bs-parent="#mapper-room-accordion"><div class="accordion-body" style="padding: 5px;"><textarea class="form-control" rows="10" style="width: 100%;" id="mapper-room-notes"></textarea></div></div></div></div>';var ti=class extends tt{constructor(u){super(u instanceof Xe?u:u?.client),u&&u instanceof Xe,this._clientContainer=document.getElementById("client-container"),Vt.load().then(t=>{this.map=t}).catch(t=>this.client.error(t))}remove(){if(!this.client)return;this.client.removeListenersFromCaller(this);let u=this.client.telnet.GMCPSupports.indexOf("Room 1");this.client.telnet.GMCPSupports.splice(u,1)}initialize(){if(!this.client)return;this.client.telnet.GMCPSupports.push("Room 1"),this.client.on("received-GMCP",this.processGMCP,this),this.client.on("window",t=>{t==="mapper"&&this.show()}),this.on("debug",t=>this.client.debug(t),this),this.on("error",t=>this.client.error(t),this);let u=client.getOption("windows.mapper");u&&u.show&&this.show()}get menu(){return[{name:"-",position:5},{name:" Show mapper",action:u=>{this.show()},icon:'<i class="bi bi-map"></i>',position:6}]}get settings(){return[]}get map(){return this._map}set map(u){this._map=u,this._dialogMap&&(this._dialogMap.map=u),this.emit("map-loaded")}async processGMCP(u,t){if(this.client.getOption("mapper.enabled"))switch(u){case"Room.Info":this.processData(t);break;case"Room.WrongDir":break}}processData(u){if(!this._map){setTimeout(()=>{this.processData(u)},10);return}try{let t=this._map.getRoom({ID:""+u.num});if(t)this.updateCurrent(t,u);else{if(t=new xe,t.zone=this._map.current.zone,this._map.current.num!==null){switch(u.prevroom.dir){case"west":t.x--;break;case"east":t.x++;break;case"north":t.y--;break;case"south":t.y++;break;case"northeast":t.y--,t.x++;break;case"northwest":t.y--,t.x--;break;case"southeast":t.y++,t.x++;break;case"southwest":t.y++,t.x--;break;case"up":t.z++;break;case"down":t.z--;break;case"out":t.zone=this._map.current.zone-1;break;default:t.zone=this._map.current.zone+1;break}t.x+=this._map.current.x,t.y+=this._map.current.y,t.z+=this._map.current.z}u.area===this._map.current.area?this._map.roomExists({x:t.x,y:t.y,z:t.z,zone:this._map.current.zone,area:this._map.current.area})||u.prevroom.zone?(t.zone=this._map.getFreeZone(this._map.current.zone),this.updateCurrent(t,u)):this.updateCurrent(t,u):this._map.roomExists({x:t.x,y:t.y,z:t.z,zone:this._map.current.zone})||u.prevroom.zone?(t.zone=this._map.getFreeZone(this._map.current.zone),this.updateCurrent(t,u)):this.updateCurrent(t,u)}this._map.save().catch(e=>this.client.error(e))}catch(t){this.emit("error",t)}}updateCurrent(u,t){u.num=t.num,u.area=t.area,u.name=t.name,u.env=t.environment,u.indoors=t.indoors;let e;for(e in t.exits)u.exits[e]=t.exits[e];if(u.details=0,typeof t.details=="number")u.details=t.details;else for(let s=0;s<t.details.length;s++)switch(t.details[s]){case"dock":u.details|=1;break;case"pier":u.details|=2;break;case"bank":u.details|=4;break;case"shop":u.details|=8;break;case"hospital":u.details|=16;break;case"bar":u.details|=32;break;case"restaurant":u.details|=64;break;case"watersource":u.details|=128;break;case"trainer":case"training":case"advance":u.details|=256;break;case"stable":u.details|=512;break}u=this._map.setRoom(u),this._map.current=u.clone(),this.emit("current-changed",this._map.current)}debug(u){this.emit("debug",u)}refresh(){}createDialog(){if(this._dialog)return;this._dialog=new ve(Object.assign({},client.getOption("windows.mapper")||{center:!0},{title:'<i class="bi bi-map"></i><select id="mapper-area" class="form-select form-select-sm me-2 mb-1" title="Select Area"></select>',id:"win-mapper",noFooter:!0,minHeight:350})),this._dialog.on("resized",a=>{this.client.setOption("windows.mapper",a),fe(()=>{this._dialogSplitter.panel1.parentElement.style.top=u.offsetHeight+"px"},25,"mapper-resize")}),this._dialog.on("moved",a=>{this.client.setOption("windows.mapper",a)}),this._dialog.on("maximized",()=>{this.client.setOption("windows.mapper",this._dialog.windowState),fe(()=>{this._dialogSplitter.panel1.parentElement.style.top=u.offsetHeight+"px"},25,"mapper-resize")}),this._dialog.on("restored",()=>{this.client.setOption("windows.mapper",this._dialog.windowState),fe(()=>{this._dialogSplitter.panel1.parentElement.style.top=u.offsetHeight+"px"},25,"mapper-resize")}),this._dialog.on("shown",()=>{this.client.setOption("windows.mapper",this._dialog.windowState),this.client.setOption("showMapper",this._dialog.windowState.show!==0),this._dialogSplitter.panel1.parentElement.style.top=u.offsetHeight+"px"}),this._dialog.on("closing",()=>{}),this._dialog.on("closed",()=>{this.client.setOption("windows.mapper",this._dialog.windowState),we("mapper")}),this._dialog.on("canceling",()=>{}),this._dialog.on("canceled",()=>{this.client.setOption("windows.mapper",this._dialog.windowState),we("mapper")}),this._dialog.on("resizing",()=>{this._dialogSplitter.panel1.parentElement.style.top=u.offsetHeight+"px"});let u=document.createElement("nav");u.id="mapper-toolbar",u.classList.add("navbar","bg-light","align-items-center"),u.innerHTML='<form class="container-fluid justify-content-start"><button id="btn-mapper-menu" class="me-2 mb-1 btn-sm btn btn-outline-secondary" type="button" aria-controls="mapper-menu" title="Show menu" aria-expanded="false" data-bs-toggle="offcanvas" data-bs-target="#mapper-menu" aria-controls="mapper-menu"><i class="fa-solid fa-bars"></i></button><button id="btn-mapper-focus" type="button" class="btn btn-sm btn-outline-secondary me-2 mb-1" title="Focus on current room"><i class="fa fa-crosshairs"></i></button><div class="btn-group me-2 mb-1"><label for="mapper-level" class="mt-1 me-1">Level: </label><input id="mapper-level" class="form-control form-control-sm" type="number" title="Map Level"></div><div class="btn-group me-2 mb-1"><label for="mapper-zone" class="mt-1 me-1">Zone: </label><input id="mapper-zone" class="form-control form-control-sm" type="number" title="Map Zone"></div><div class="btn-group me-2 mb-1"><label for="mapper-zoom" class="me-1">Zoom: </label><input id="mapper-zoom" class="form-range" type="range" min="25" max="300" step="5""><label id="mapper-zoom-display">100%</label></div></form>',this._dialog.body.appendChild(u),this._dialog.body.insertAdjacentHTML("afterbegin",is),this._dialog.body.querySelector("#mapper-enable a").addEventListener("click",()=>{this._dialogMap.enabled=!this._dialogMap.enabled,this._dialogMap.enabled?this._dialog.body.querySelector("#mapper-enable").classList.add("active"):this._dialog.body.querySelector("#mapper-enable").classList.remove("active"),ue()}),this._dialog.body.querySelector("#mapper-legend a").addEventListener("click",()=>{this._dialogMap.showLegend=!this._dialogMap.showLegend,this._dialogMap.showLegend?this._dialog.body.querySelector("#mapper-legend").classList.add("active"):this._dialog.body.querySelector("#mapper-legend").classList.remove("active"),ue()}),this._dialog.body.querySelector("#mapper-room a").addEventListener("click",()=>{this._dialogSplitter.panel2Collapsed=!this._dialogSplitter.panel2Collapsed,this._dialogSplitter.panel2Collapsed?(this._dialog.dialog.dataset.panel="left",this._dialog.body.querySelector("#mapper-room").classList.remove("active"),this._dialog.body.querySelector("#mapper-room").title="Show room properties",this._dialog.body.querySelector("#mapper-room a span").textContent="Show room properties"):(this._dialog.dialog.dataset.panel="right",this._dialog.body.querySelector("#mapper-room").classList.add("active"),this._dialog.body.querySelector("#mapper-room").title="Hide room properties",this._dialog.body.querySelector("#mapper-room a span").textContent="Hide room properties"),this._dialogSplitter.panel1.parentElement.style.top=u.offsetHeight+"px",this.client.setOption("mapper.room",!this._dialogSplitter.panel2Collapsed),ue()}),this._dialog.body.querySelector("#mapper-refresh a").addEventListener("click",()=>{this._dialogMap.refresh(),ue()}),this._dialog.body.querySelector("#mapper-split a").addEventListener("click",()=>{this._dialogMap.splitArea=!this._dialogMap.splitArea,this._dialogMap.splitArea?this._dialog.body.querySelector("#mapper-split").classList.add("active"):this._dialog.body.querySelector("#mapper-split").classList.remove("active"),ue()}),this._dialog.body.querySelector("#mapper-fill a").addEventListener("click",()=>{this._dialogMap.fillWalls=!this._dialogMap.fillWalls,this._dialogMap.fillWalls?this._dialog.body.querySelector("#mapper-fill").classList.add("active"):this._dialog.body.querySelector("#mapper-fill").classList.remove("active"),ue()}),this._dialog.body.querySelector("#mapper-follow a").addEventListener("click",()=>{this._dialogMap.follow=!this._dialogMap.follow,this._dialogMap.follow?document.getElementById("mapper-follow").classList.add("active"):document.getElementById("mapper-follow").classList.remove("active"),ue()}),this._dialog.body.querySelector("#mapper-focus a").addEventListener("click",()=>{this._dialogMap.focusCurrentRoom(),ue()}),this._dialog.body.querySelector("#mapper-set-current a").addEventListener("click",()=>{this._dialogMap.current=this._dialogMap.selected,ue()}),this._dialog.body.querySelector("#btn-mapper-focus").addEventListener("click",()=>{this._dialogMap.focusCurrentRoom(),ue()}),this._dialog.body.querySelector("#mapper-highlight-path a").addEventListener("click",()=>{this._dialogMap.focusCurrentRoom(),this._dialogMap.showPath(),ue()}),this._dialog.body.querySelector("#mapper-clear-path a").addEventListener("click",()=>{this._dialogMap.clearPath(),ue()}),this._dialog.body.querySelector("#mapper-walk-path a").addEventListener("click",()=>{this._dialogMap.walkPath(),ue()}),this._dialog.body.querySelector("#mapper-walk-highlighted-path a").addEventListener("click",()=>{this._dialogMap.walkMarkedPath(),ue()}),this._dialog.body.querySelector("#mapper-copy-path a").addEventListener("click",()=>{this._dialogMap.copyPath(`
`),ue()}),this._dialog.body.querySelector("#mapper-copy-stacked a").addEventListener("click",()=>{this._dialogMap.copyPath(this.client.getOption("commandStackingChar")),ue()}),this._dialog.body.querySelector("#mapper-copy-speedpath a").addEventListener("click",()=>{this._dialogMap.copySpeedpath(),ue()}),this._dialog.body.querySelector("#mapper-copy-highlighted-path a").addEventListener("click",()=>{this._dialogMap.copyMarkedPath(`
`),ue()}),this._dialog.body.querySelector("#mapper-copy-highlighted-stacked a").addEventListener("click",()=>{this._dialogMap.copyMarkedPath(this.client.getOption("commandStackingChar")),ue()}),this._dialog.body.querySelector("#mapper-remove-selected a").addEventListener("click",()=>{confirm_box("Remove selected room?","Are you sure you want to remove selected room?").then(a=>{a.button===4&&this._dialogMap.clearSelectedRoom()}),ue()}),this._dialog.body.querySelector("#mapper-remove-current a").addEventListener("click",()=>{confirm_box("Remove current room?","Are you sure you want to remove current room?").then(a=>{a.button===4&&this._dialogMap.clearCurrentRoom()}),ue()}),this._dialog.body.querySelector("#mapper-remove-current-area a").addEventListener("click",()=>{confirm_box("Remove current area?","Are you sure you want to remove all rooms from current area?").then(a=>{a.button===4&&this._dialogMap.clearArea()}),ue()}),this._dialog.body.querySelector("#mapper-remove-all a").addEventListener("click",()=>{confirm_box("Remove all rooms and areas?","Are you sure you want to remove all rooms?").then(a=>{a.button===4&&this._dialogMap.clearAll()}),ue()}),this._dialog.body.querySelector("#mapper-export-image a").addEventListener("click",()=>{this._dialogMap.exportImage(),ue()}),this._dialog.body.querySelector("#mapper-export-scaled-image a").addEventListener("click",()=>{this._dialogMap.exportImage(!0),ue()}),this._dialog.body.querySelector("#mapper-export-current-image a").addEventListener("click",()=>{this._dialogMap.exportCurrentImage(),ue()}),this._dialog.body.querySelector("#mapper-export-current-area a").addEventListener("click",()=>{this._dialogMap.exportArea(),ue()}),this._dialog.body.querySelector("#mapper-export-all a").addEventListener("click",()=>{this._dialogMap.exportAll(),ue()}),this._dialog.body.querySelector("#mapper-import-merge a").addEventListener("click",()=>{ge("Import map and merge",!1).then(a=>{be(a[0]).then(o=>{this._dialogProgress=progress_box("Importing map"),this._dialogProgress.on("canceled",()=>{this.map.cancelImport()}),this._dialogProgress.on("closed",h=>{h==="canceled"&&this.map.cancelImport()}),this._dialogProgress.on("shown",()=>{this.map.import(JSON.parse(o),0)}),this._dialogProgress.showModal()}).catch(client.error)}).catch(()=>{}),ue()}),this._dialog.body.querySelector("#mapper-import-replace a").addEventListener("click",()=>{confirm_box("Import and Replace?","Are you sure you want to remove all rooms and replace them?").then(a=>{a.button===4&&ge("Import map and replace",!1).then(o=>{be(o[0]).then(h=>{this._dialogProgress=progress_box("Importing map"),this._dialogProgress.showModal(),this.map.import(JSON.parse(h),1)}).catch(client.error)}).catch(()=>{})}),ue()}),this._dialog.body.querySelector("#mapper-copy-highlighted-speedpath a").addEventListener("click",()=>{this._dialogMap.copyMarkedSpeedpath(),ue()}),this._dialog.body.querySelector("#mapper-about a").addEventListener("click",()=>{alert_box({title:'<i class="fa-solid fa-circle-info"></i> Map information',width:300,height:200,keepCentered:!0,center:!0,resizable:!1,moveable:!1,maximizable:!1,buttons:1},`Areas: ${this._map.Areas.length}<br>Rooms: ${this._map.count}<br>Highest zone: ${this._map.zone}`,2),ue()}),this._dialogMap=new Qt(document.createElement("div"),{map:this._map}),this._dialogMap.on("error",a=>this.client.error(a),this),this._dialogMap.on("remove-selected",()=>{confirm_box("Remove selected room?","Are you sure you want to remove selected room?").then(a=>{a.button===4&&this._dialogMap.clearSelectedRoom()})}),this._dialogMap.on("active-room-changed",a=>{let o=document.getElementById("mapper-area");!a.area||a.area.length===0?o.options.length&&(o.value=o.options[0].value):(o.querySelectorAll(`option[value="${a.area.replace(/"/g,"&quot;")}"]`).length||(o.insertAdjacentHTML("beforeend",`<option value="${a.area.replace(/"/g,"&quot;")}">${a.area}</option>`),document.getElementById("mapper-room-area").insertAdjacentHTML("beforeend",`<option value="${a.area.replace(/"/g,"&quot;")}">${a.area}</option>`)),o.value=a.area),document.getElementById("mapper-level").value=a.z,document.getElementById("mapper-zone").value=a.zone,a=a.clone(),a.ID=a.num,delete a.num,this.client.setOption("mapper.active",a)}),this._dialogMap.on("setting-changed",(a,o)=>{a==="active"?(document.getElementById("mapper-area").value=o.area,document.getElementById("mapper-level").value=o.z,document.getElementById("mapper-zone").value=o.zone):a==="scale"&&(document.getElementById("mapper-zoom").value=o,document.getElementById("mapper-zoom-display").textContent=o+"%"),this.client.setOption(`mapper.${a}`,o)}),document.getElementById("mapper-area").addEventListener("change",a=>{this._dialogMap.setArea(a.currentTarget.value)}),document.getElementById("mapper-level").addEventListener("change",a=>{this._dialogMap.setLevel(parseInt(a.currentTarget.value,10))}),document.getElementById("mapper-zone").addEventListener("change",a=>{this._dialogMap.setZone(parseInt(a.currentTarget.value,10))}),this._dialogSplitter=new _t({id:"mapper",parent:this._dialog.body,orientation:1}),this._dialogSplitter.on("splitter-moved",a=>{this.client.setOption("mapper.roomWidth",a)}),this._dialogSplitter.panel2Collapsed=!0,this.client.getOption("mapper.room")&&this._dialog.body.querySelector("#mapper-room a").click(),this._dialogSplitter.SplitterDistance=client.getOption("mapper.roomWidth"),this._dialogSplitter.panel2.innerHTML=ss,document.getElementById("mapper-room-close").addEventListener("click",()=>{this._dialog.body.querySelector("#mapper-room a").click()}),document.getElementById("mapper-room-accordion").querySelectorAll("input,textarea,select,.accordion-body button").forEach(a=>{a.disabled=!0,a.tagName!=="BUTTON"&&(a.type==="checkbox"?a.addEventListener("change",o=>{if(this._dialogMap.selected===null||this._dialogMap.selected.num===null)return;let h=o.currentTarget||o.target,c=a.name||a.id.substring(12);if(h.dataset.enum==="true"){let g=h.name||h.id.substring(0,h.id.lastIndexOf("-")),f=document.getElementById("mapper-room-accordion").querySelectorAll(`[name=${g}]`),w=0;for(let p=0,k=f.length;p<k;p++)f[p].checked&&(w|=+f[p].value);this._dialogMap.selected[g]=w}else this._dialogMap.selected[c]=h.checked;this._map.setRoom(this._dialogMap.selected),this._map.save().catch(g=>this.client.error(g))}):(a.addEventListener("change",o=>{if(this._dialogMap.selected===null||this._dialogMap.selected.num===null)return;let h=a.name||a.id.substring(12);fe(()=>{let c=o.currentTarget||o.target;this._dialogMap.selected[h]=c.value,this._map.setRoom(this._dialogMap.selected),this._map.save().catch(g=>this.client.error(g))},100,h)}),a.addEventListener("input",o=>{if(this._dialogMap.selected===null||this._dialogMap.selected.num===null)return;let h=a.name||a.id.substring(12);fe(()=>{let c=o.currentTarget||o.target;this._dialogMap.selected[h]=c.value,this._map.setRoom(this._dialogMap.selected)},100,h)})))}),this._dialogMap.on("room-selected",a=>{document.getElementById("mapper-room-accordion").querySelectorAll("input,textarea,select,.accordion-body button").forEach(c=>{if(a===null||a.num===null){if(c.disabled=!0,c.tagName==="BUTTON")return;c.type==="checkbox"?c.checked=!1:c.value=""}else{if(c.disabled=!1,c.tagName==="BUTTON")return;let g=c.name||c.id.substring(12);if(c.type==="checkbox")if(c.dataset.enum==="true"){let f=+c.value;c.checked=(a[g]&f)===f}else c.checked=a[g];else c.value=a[g]}});let o=a,h=this._map.current;this.updateMenu("#mapper-remove-selected a",o===null||o.num===null),this.updateMenu("#mapper-set-current a",o===null||o.num===null),this.updateMenu("#mapper-highlight-path a",o===null||o.num===null||!h||h.num===null||o.num===h.num),this.updateMenu("#mapper-walk-path a",o===null||o.num===null||!h||h.num===null||o.num===h.num),this.updateMenu("#mapper-copy-path a",o===null||o.num===null||!h||h.num===null||o.num===h.num),this.updateMenu("#mapper-copy-stacked a",o===null||o.num===null||!h||h.num===null||o.num===h.num),this.updateMenu("#mapper-copy-speedpath a",o===null||o.num===null||!h||h.num===null||o.num===h.num)}),this._dialogMap.on("current-changed",a=>{let o=this._dialogMap.selected,h=a;this.updateMenu("#mapper-remove-current a",h===null||h.num===null),this.updateMenu("#mapper-remove-selected a",o===null||o.num===null),this.updateMenu("#mapper-set-current a",o===null||o.num===null),this.updateMenu("#mapper-highlight-path a",o===null||o.num===null||!h||h.num===null||o.num===h.num),this.updateMenu("#mapper-walk-path a",o===null||o.num===null||!h||h.num===null||o.num===h.num),this.updateMenu("#mapper-copy-path a",o===null||o.num===null||!h||h.num===null||o.num===h.num),this.updateMenu("#mapper-copy-stacked a",o===null||o.num===null||!h||h.num===null||o.num===h.num),this.updateMenu("#mapper-copy-speedpath a",o===null||o.num===null||!h||h.num===null||o.num===h.num)}),this._dialogMap.on("path-shown",()=>{this.updateMenu("#mapper-highlight-path a",!1),this.updateMenu("#mapper-walk-path a",!1),this.updateMenu("#mapper-walk-highlighted-path a",!1),this.updateMenu("#mapper-clear-path a",!1),this.updateMenu("#mapper-copy-highlighted-path a",!1),this.updateMenu("#mapper-copy-highlighted-stacked a",!1),this.updateMenu("#mapper-copy-highlighted-speedpath a",!1)}),this._dialogMap.on("path-cleared",()=>{this.updateMenu("#mapper-clear-path a",!0),this.updateMenu("#mapper-walk-highlighted-path a",!0),this.updateMenu("#mapper-copy-highlighted-path a",!0),this.updateMenu("#mapper-copy-highlighted-stacked a",!0),this.updateMenu("#mapper-copy-highlighted-speedpath a",!0)});let t=this._dialog.body.querySelector("#mapper-room-env"),e=this._dialog.body.querySelectorAll("#mapper-room-terrains .active"),s,n;for(s=0,n=e.length;s<n;s++)e[s].classList.remove("active");for(e=this._dialog.body.querySelectorAll("#mapper-room-terrains .dropdown-item"),s=0,n=e.length;s<n;s++)e[s].addEventListener("click",function(){t.value=this.textContent,t.dispatchEvent(new Event("change"))});t.nextElementSibling.addEventListener("show.bs.dropdown",a=>{let o=this._dialog.body.querySelectorAll("#mapper-room-terrains .dropdown-item");for(s=0,n=o.length;s<n;s++)o[s].classList.remove("active"),t.value===o[s].textContent&&o[s].classList.add("active")}),this._dialogSplitter.panel1.append(this._dialogMap.container),this._dialogMap.container.classList.add("map"),this._dialogMap.active=new xe(client.getOption("mapper.active")),this._dialogMap.active.num=this._dialogMap.active.num||this._dialogMap.active.ID,this._dialogMap.commandDelay=client.getOption("commandDelay"),this._dialogMap.commandDelayCount=client.getOption("commandDelayCount"),this._dialogMap.on("debug",a=>{this.client.debug(a)}),document.getElementById("mapper-level").value=""+this._dialogMap.active.z,document.getElementById("mapper-zone").value=""+this._dialogMap.active.zone,document.getElementById("mapper-zoom").addEventListener("input",a=>{this._dialogMap.scale=+a.currentTarget.value});let r=()=>{let a=this._map.Areas.length,o=document.getElementById("mapper-area");o.addEventListener("mouseup",g=>{g.stopPropagation(),g.cancelBubble=!0}),o.addEventListener("touchstart",g=>{g.stopPropagation(),g.cancelBubble=!0},{passive:!0}),o.addEventListener("mousedown",g=>{g.stopPropagation(),g.cancelBubble=!0});let h="";for(var c=0;c<a;c++)h+=`<option value="${this._map.Areas[c].replace(/"/g,"&quot;")}">${this._map.Areas[c]}</option>`;o.innerHTML=h,document.getElementById("mapper-room-area").innerHTML=h,this._dialogMap.active.area&&this._map.Areas.indexOf(this._dialogMap.active.area)!==-1?o.value=this._dialogMap.active.area:a>0&&(this._dialogMap.active.area=this.map.Areas[0],this._dialogMap.emit("setting-changed","active",this._dialogMap.active.area),o.value=this._dialogMap.active.area),this._dialogMap.refresh(),this._dialogMap.enabled=this.client.getOption("mapper.enabled"),this._dialogMap.enabled&&document.getElementById("mapper-enable").classList.add("active"),this._dialogMap.showLegend=this.client.getOption("mapper.legend"),this._dialogMap.showLegend&&document.getElementById("mapper-legend").classList.add("active"),this._dialogMap.follow=this.client.getOption("mapper.follow"),this._dialogMap.follow&&document.getElementById("mapper-follow").classList.add("active"),this._dialogMap.splitArea=this.client.getOption("mapper.split"),this._dialogMap.splitArea&&document.getElementById("mapper-split").classList.add("active"),this._dialogMap.fillWalls=this.client.getOption("mapper.fill"),this._dialogMap.fillWalls&&document.getElementById("mapper-fill").classList.add("active"),this._dialogMap.follow&&this._dialogMap.focusCurrentRoom(),this._dialogMap.scale=this.client.getOption("mapper.scale"),this._map.on("rooms-removed",g=>{this._map.save()}),this._map.on("areas-removed",g=>{let f=document.getElementById("mapper-area"),w=document.getElementById("mapper-room-area");if(this._map.Areas.length===0)f.innerHTML="",w.innerHTML="";else{for(var p=f.length-1;p>=0;p--)g.indexOf(f.options[p].value)!==-1&&f.remove(p);for(var p=w.length-1;p>=0;p--)g.indexOf(w.options[p].value)!==-1&&w.remove(p)}}),this._map.on("areas-added",g=>{let f="",w=this._map.Areas.length;for(let p=0;p<w;p++)f+=`<option value="${this._map.Areas[p].replace(/"/g,"&quot;")}">${this._map.Areas[p]}</option>`;document.getElementById("mapper-area").innerHTML=f,document.getElementById("mapper-room-area").innerHTML=f,this._dialogMap.active.area&&this._map.Areas.indexOf(this._dialogMap.active.area)!==-1?document.getElementById("mapper-area").value=this._dialogMap.active.area:w>0&&(this._dialogMap.active.area=this.map.Areas[0],this._dialogMap.emit("setting-changed","active",this._dialogMap.active.area),document.getElementById("mapper-area").value=this._dialogMap.active.area)}),this._map.on("import-progress",g=>{this._dialogProgress&&(this._dialogProgress.progress=g)}),this._map.on("import-complete",()=>{client.sendGMCP("Room.Info"),this._dialogProgress&&this._dialogProgress.close(),this._dialogProgress=null,this._dialogMap.refresh(),this._map.save()}),this._map.on("import-canceled",()=>{client.sendGMCP("Room.Info"),this._dialogProgress&&this._dialogProgress.close(),this._dialogProgress=null,this._dialogMap.refresh(),this._map.save()})};this.on("map-loaded",()=>{r()}),this.map&&r()}show(){this.createDialog(),this._dialog.show()}updateMenu(u,t){t?this._dialog.body.querySelector(u).classList.add("disabled"):this._dialog.body.querySelector(u).classList.remove("disabled")}};function ue(){let m=bootstrap.Offcanvas.getInstance(document.getElementById("mapper-menu"));m&&m.hide()}var Xe=class extends pe{constructor(t){super();this._enableDebug=!1;this._itemCache={triggers:null,aliases:null,macros:null,buttons:null,contexts:null,defaultContext:null,alarms:null,alarmPatterns:[]};this._variables={};this._options={};this.active=!0;this.connecting=!1;this.version=$i;this.connectTime=0;this.disconnectTime=0;this.lastSendTime=0;this.defaultTitle="oiMUD";this.errored=!1;if(window.client=this,window.oiMUD=this,this._plugins=[],t=Object.assign({display:"#display",commandInput:"#commandInput"},t||{}),(!("display"in t)||typeof t.display===void 0)&&(t.display="#display"),(!("commandInput"in t)||typeof t.commandInput===void 0)&&(t.commandInput="#commandInput"),this._display=new It(t.display),this.display.on("click",s=>{this.getOption("CommandonClick")&&this._commandInput.focus()}),this.display.on("scroll-lock",s=>{this.scrollLock=s}),this.display.on("update-window",(s,n)=>{this.telnet.updateWindow(s,n)}),this.display.on("update-window",(s,n)=>{this.telnet.updateWindow(s,n)}),this.display.on("debug",s=>{this.debug(s)}),this.display.on("add-line",s=>{this.emit("add-line",s)}),this.display.on("add-line-done",s=>{this.emit("add-line-done",s)}),this.display.on("MXP-tag-reply",(s,n)=>{let r={tag:s,args:n,preventDefault:!1};if(this.emit("MXP-tag-reply",r),!r.preventDefault)switch(s){case"VERSION":this.display.MXPStyleVersion&&this.display.MXPStyleVersion.length?(this.debug(`MXP Tag REPLY: <VERSION MXP=1.0 STYLE=${this.display.MXPStyleVersion} CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>`),this.send(`\x1B[1z<VERSION MXP=1.0 STYLE=${this.display.MXPStyleVersion} CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>\r
`)):(this.debug(`MXP Tag REPLY: <VERSION MXP=1.0 CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>`),this.send(`\x1B[1z<VERSION MXP=1.0 CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>\r
`));break;case"SUPPORT":this.debug(`MXP Tag REPLY: <SUPPORTS ${n.join(" ")}>`),this.send(`\x1B[1z<SUPPORTS ${n.join(" ")}>\r
`);break;case"USER":this.emit("sendUsername",r);break;case"PASSWORD":this.emit("sendPassword",r);break}}),this.display.on("expire-links",s=>{this.emit("expire-links",s)}),this.display.on("parse-done",()=>{this.emit("parse-done")}),this.display.on("set-title",(s,n)=>{typeof s>"u"||s==null||s.length===0?this.emit("set-title",this.getOption("title").replace("$t",this.defaultTitle)||this.defaultTitle):n!==1&&this.emit("set-title",this.getOption("title").replace("$t",s)||"")}),this.display.on("music",s=>{this.emit("music",s)}),this.display.on("sound",s=>{this.emit("sound",s)}),this.display.on("bell",()=>{this.emit("bell")}),typeof t.commandInput=="string"){if(this._commandInput=document.querySelector(t.commandInput),!this._commandInput)throw new Error("Invalid selector for command input.")}else if(t.commandInput instanceof $)this._commandInput=t.commandInput[0];else if(t.commandInput instanceof HTMLElement)this._commandInput=t.commandInput;else throw new Error("Command input must be a selector, element or jquery object");this._telnet=new xt({protocol:t.protocol,scheme:t.scheme}),this._telnet.terminal="oiMUD",this._telnet.version=this.version,this._telnet.GMCPSupports.push("oMUD 1"),this._telnet.on("error",s=>{if(this.enableDebug&&this.debug(s),s){if(s.type==="close"&&s.code===1006)return;let n=[];s.type&&n.push(s.type),s.text&&n.push(s.text),s.message&&n.push(s.message),s.reason&&n.push(s.reason),s.code?this.error(s.code+" : "+n.join(", ")):this.error(n.join(", "))}else this.error("Unknown telnet error.");this.getOption("autoConnect")&&!this._telnet.connected&&setTimeout(()=>{this.connect()},client.getOption("autoConnectDelay")),this.emit("reconnect")}),this.telnet.on("connecting",()=>{this.connecting=!0,this.echo("Trying to connect to "+this.host+":"+this.port,-7,-8,!0,!0)}),this.telnet.on("connect",()=>{this.connecting=!1,this.echo("Connected...",-7,-8,!0,!0),this.connectTime=Date.now(),this.disconnectTime=0,this.lastSendTime=Date.now(),this.emit("connected"),this.raise("connected")}),this.telnet.on("debug",s=>{this.debug(s)}),this.telnet.on("receive-option",s=>{this.emit("received-option",s)}),this.telnet.on("close",()=>{this.connecting=!1,this.echo("Connection closed to "+this.host+":"+this.port,-7,-8,!0,!0),this.disconnectTime=Date.now(),this.emit("closed"),this.raise("disconnected"),this.connectTime=0,this.lastSendTime=0}),this.telnet.on("received-data",s=>{s={value:s},this.emit("received-data",s),!(s==null||typeof s>"u"||s.value==null||typeof s.value>"u")&&(this.printInternal(s.value,!1,!0),this.debug("Latency: "+this.telnet.latency+"ms"),this.debug("Latency: "+this.telnet.latency/1e3+"s"))}),this.telnet.on("received-MSDP",s=>{this.emit("received-MSDP",s)}),this.telnet.on("received-GMCP",s=>{let n=s.value,r,a=0,o=n.length,h;if(o===0)return;for(a=0;a<o&&(h=n.charAt(a),!(h===" "||h==="{"||h==="["));a++);r=n.substr(0,a).trim(),n=n.substr(a).trim(),this.debug("GMCP Module: "+r),this.debug("GMCP Data: "+n);let c;if(r.toLowerCase()==="client.gui"){c=n.split("/n"),n.length>=2?c={version:parseInt(c[0],10),url:c[1]}:n.length>0?c={version:parseInt(c[0],10),url:c[1]}:c={version:c,url:""},this.emit("received-GMCP",r,c);return}try{n.length>0&&(c=JSON.parse(n))}catch{this.error("Invalid GMCP");return}this.emit("received-GMCP",r,c)}),this.telnet.on("windowSize",()=>{this.UpdateWindow()});let e=di("host");e!==null&&e.length?this.host=e:t&&"host"in t?this.host=t.host:this.host="127.0.0.1",e=+di("port"),!isNaN(e)&&e>0?this.port=e:t&&"port"in t?this.port=t.port:this.port=23,this._input=new zt(this),this._input.on("scroll-lock",s=>{this.display.scrollLock=s,this.emit("scroll-lock",s)}),this._input.on("command-history-changed",s=>this.emit("command-history-changed",s)),this._input.on("item-added",(s,n,r)=>{this.emit("item-added",s,n,r)}),this._input.on("item-updated",(s,n,r,a)=>{this.emit("item-updated",s,n,r,a)}),this._input.on("item-removed",(s,n,r)=>{this.emit("item-removed",s,n,r)}),this.loadOptions(),this._commandInput.value="",this._commandInput.focus(),window.addEventListener("blur",()=>{this.active=!1,this.emit("blur"),this.raise("blur")}),window.addEventListener("focus",()=>{this.active=!0,this.emit("focus"),this.raise("focus")}),window.addEventListener("beforeunload",s=>{if(this.connected)return s&&(s.returnValue="Closing or reloading will disconnect you from the mud."),"Closing or reloading will disconnect you from the mud.";this.raise("closed")}),window.addEventListener("unload",()=>{this.connected&&this.close()}),this.addPlugin(new Xt(this)),this.addPlugin(new ti(this)),this.addPlugin(new Yt(this)),this.getOption("autoConnect")&&setTimeout(()=>{this.connect()},client.getOption("autoConnectDelay")),this.emit("initialized")}get telnet(){return this._telnet}get variables(){return this._variables}get commandInput(){return this._commandInput}get display(){return this._display}get profiles(){return this._profiles}get plugins(){return this._plugins}get options(){return this._options}get input(){return this._input}set simpleAlarms(t){this.setOption("simpleAlarms",t)}get simpleAlarms(){return this.getOption("simpleAlarms")}set enableParsing(t){this.setOption("enableParsing",t),this._input.enableParsing=t}get enableParsing(){return this.getOption("enableParsing")}set enableTriggers(t){this.setOption("enableTriggers",t),this._input.enableTriggers=t,this.startAlarms()}get enableTriggers(){return this.getOption("enableTriggers")}get enableDebug(){return this._enableDebug}set enableDebug(t){this._enableDebug=t,this._telnet.enableDebug=t,this._display.enableDebug=t}get host(){return this._telnet.host}set host(t){this._telnet.host=t}get port(){return this._telnet.port}set port(t){this._telnet.port=t}get connected(){return this._telnet.connected}get activeProfile(){return this._profiles.active}get commandHistory(){return this._input.commandHistory}get indices(){return this._input.indices}get repeatnum(){return this._input.repeatnum}get aliases(){if(this._itemCache.aliases)return this._itemCache.aliases;let t=this.profiles.keys,e=[],s=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableAliases?this._itemCache.aliases=[]:this._itemCache.aliases=te(this.profiles.items[t[s]].aliases),this._itemCache.aliases;for(;s<n;s++)!this.profiles.items[t[s]].enabled||!this.profiles.items[t[s]].enableAliases||this.profiles.items[t[s]].aliases.length===0||e.push.apply(e,te(this.profiles.items[t[s]].aliases));return this._itemCache.aliases=e,this._itemCache.aliases}get macros(){if(this._itemCache.macros)return this._itemCache.macros;let t=this.profiles.keys,e=[],s=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableMacros?this._itemCache.macros=[]:this._itemCache.macros=te(this.profiles.items[t[s]].macros),this._itemCache.macros;for(;s<n;s++)!this.profiles.items[t[s]].enabled||!this.profiles.items[t[s]].enableMacros||this.profiles.items[t[s]].macros.length===0||e.push.apply(e,te(this.profiles.items[t[s]].macros));return this._itemCache.macros=e,this._itemCache.macros}get triggers(){if(this._itemCache.triggers)return this._itemCache.triggers;let t=this.profiles.keys,e=[],s=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableTriggers?this._itemCache.triggers=[]:this._itemCache.triggers=te(this.profiles.items[t[0]].triggers),this._itemCache.triggers;for(;s<n;s++)!this.profiles.items[t[s]].enabled||!this.profiles.items[t[s]].enableTriggers||this.profiles.items[t[s]].triggers.length===0||e.push.apply(e,te(this.profiles.items[t[s]].triggers));return this._itemCache.triggers=e,this._itemCache.triggers}removeTrigger(t){let e=this.profiles.keys,s=0,n=e.length,r=-1;if(n!==0){if(n===1){if(!this.profiles.items[e[0]].enabled||!this.profiles.items[e[0]].enableTriggers)return;r=this.profiles.items[e[s]].triggers.indexOf(t)}else for(;s<n&&r!==-1&&!(!(!this.profiles.items[e[s]].enabled||!this.profiles.items[e[s]].enableTriggers||this.profiles.items[e[s]].triggers.length===0)&&(r=this.profiles.items[e[s]].triggers.indexOf(t),r!==-1));s++);r!==-1&&(this.profiles.items[e[s]].triggers.splice(r,1),this._itemCache.triggers=null,(t.triggers.length||t.type===3)&&this._itemCache.alarms&&(r=this._itemCache.alarms.indexOf(t),r!==-1&&(this._itemCache.alarms.splice(r,1),this._itemCache.alarmPatterns.splice(r,1))),this.saveProfiles(),this.emit("item-removed","trigger",e[s],r))}}get alarms(){if(this._itemCache.alarms)return this._itemCache.alarms;let t=this.profiles.keys,e=[],s=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableTriggers?this._itemCache.alarms=[]:this._itemCache.alarms=te(this.profiles.items[t[s]].triggers).filter(r=>{if(r&&r.enabled&&r.triggers.length){if(r.type===3)return!0;for(let a=0,o=r.triggers.length;a<o;a++)if(r.triggers[a].enabled&&r.triggers[a].type===3)return!0;return!1}return r&&r.enabled&&r.type===3}),this._itemCache.alarms.reverse(),this._itemCache.alarms;for(;s<n;s++)!this.profiles.items[t[s]].enabled||!this.profiles.items[t[s]].enableTriggers||this.profiles.items[t[s]].triggers.length===0||e.push.apply(e,te(this.profiles.items[t[s]].triggers));return this._itemCache.alarms=e.filter(r=>{if(r&&r.enabled&&r.triggers.length){if(r.type===3)return!0;for(let a=0,o=r.triggers.length;a<o;a++)if(r.triggers[a].enabled&&r.triggers[a].type===3)return!0;return!1}return r&&r.enabled&&r.type===3}),this._itemCache.alarms.reverse(),this._itemCache.alarms}get buttons(){if(this._itemCache.buttons)return this._itemCache.buttons;let t=this.profiles.keys,e=[],s=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableButtons?this._itemCache.buttons=[]:this._itemCache.buttons=te(this.profiles.items[t[s]].buttons),this._itemCache.buttons;for(;s<n;s++)!this.profiles.items[t[s]].enabled||!this.profiles.items[t[s]].enableButtons||this.profiles.items[t[s]].buttons.length===0||e.push.apply(e,te(this.profiles.items[t[s]].buttons));return this._itemCache.buttons=e,this._itemCache.buttons}get contexts(){if(this._itemCache.contexts)return this._itemCache.contexts;let t=this.profiles.keys,e=[],s=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableContexts?this._itemCache.contexts=[]:this._itemCache.contexts=te(this.profiles.items[t[s]].contexts),this._itemCache.contexts;for(;s<n;s++)!this.profiles.items[t[s]].enabled||!this.profiles.items[t[s]].enableContexts||this.profiles.items[t[s]].contexts.length===0||e.push.apply(e,te(this.profiles.items[t[s]].contexts));return this._itemCache.contexts=e,this._itemCache.contexts}get defaultContext(){return this._itemCache.defaultContext!==null?this._itemCache.defaultContext:(this._itemCache.defaultContext=this.profiles.defaultContext,this._itemCache.defaultContext)}addPlugin(t){t&&(this.plugins.push(t),t.initialize())}removePlugin(t){if(!this.plugins.length)return;let e=this.plugins.indexOf(t);e!==-1&&(t.remove(),this.plugins.splice(e,1))}getVariable(t){return this.variables[t]}setVariable(t,e){this.variables[t]=e}setVariables(t){let e=Object.keys(t);if(e.length===0)return;let s=e.length,n;for(let r=0;r<s;r++)n=e[r],this.variables[n]=t[n]}hasVariable(t){return this.variables.hasOwnProperty(t)}removeVariable(t){this.variables.hasOwnProperty(t)&&delete this.variables[t]}setHistoryIndex(t){this._input.setHistoryIndex(t)}clearCommandHistory(){this._input.clearCommandHistory()}AddCommandToHistory(t){this._input.AddCommandToHistory(t)}loadProfiles(){return new Promise(t=>{Nt.load().then(e=>{this._profiles=e,this.profiles.contains("default")||(this.profiles.add(Le.Default),this.saveProfiles()),this.clearCache(),this.startAlarms(),this.emit("profiles-loaded"),t(this._profiles)})})}removeProfile(t){t&&(this.profiles.remove(t),this.clearCache(),this.startAlarms(),this.emit("profile-removed",t))}saveProfiles(){this._profiles.save(),this.clearCache(),this.emit("profiles-updated")}toggleProfile(t){this.profiles.toggle(t),this.saveProfiles(),this.clearCache(),this.startAlarms(),this.emit("profile-toggled",t,this.profiles[t].enabled)}startAlarms(){let t=this.alarms.length;(t===0||!this.getOption("enableTriggers"))&&this._alarm?(clearInterval(this._alarm),this._alarm=null):t&&!this._alarm&&(this._alarm=setInterval(e=>{e.process_alarms()},1e3,this))}setAlarmState(t,e){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length)return;let s=this._itemCache.alarmPatterns[t];if(!s){s={},this.alarms[t].type===3&&(s[0]=Be.parse(this.alarms[t]));for(let n=0,r=this.alarms[t].triggers.length;n<r;n++)this.alarms[t].triggers[n].enabled&&this.alarms[t].triggers[n].type===3&&(s[n]=Be.parse(this.alarms[t].triggers[n]));this._itemCache.alarmPatterns[t]=s}for(let n in s)s.hasOwnProperty(n)&&(e?(s[n].startTime+=Date.now()-s[n].suspended,s[n].prevTime+=Date.now()-s[n].suspended,s[n].tempTime&&(s[n].tempTime+=Date.now()-s[n].suspended),s[n].suspended=0):s[n].suspended=Date.now())}setAlarmTempTime(t,e){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length)return;let s=this._itemCache.alarmPatterns[t];if(!s){s={},this.alarms[t].type===3&&(s[0]=Be.parse(this.alarms[t]));for(let n=0,r=this.alarms[t].triggers.length;n<r;n++)this.alarms[t].triggers[n].enabled&&this.alarms[t].triggers[n].type===3&&(s[n]=Be.parse(this.alarms[t].triggers[n]));this._itemCache.alarmPatterns[t]=s}s[0]&&s[0].setTempTime(e)}restartAlarmState(t,e,s){if(e===s||(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length))return;let n=this._itemCache.alarmPatterns[t];if(!n){n={},this.alarms[t].type===3&&(n[0]=Be.parse(this.alarms[t]));for(let r=0,a=this.alarms[t].triggers.length;r<a;r++)this.alarms[t].triggers[r].enabled&&this.alarms[t].triggers[r].type===3&&(n[r]=Be.parse(this.alarms[t].triggers[r]));this._itemCache.alarmPatterns[t]=n}n[e]&&(n[e].restart=Date.now()),n[s]&&(n[s].restart=Date.now())}getRemainingAlarmTime(t){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length||!this.alarms[t].enabled)return 0;let e=this._itemCache.alarmPatterns[t];if(!e){e={},this.alarms[t].type===3&&(e[0]=Be.parse(this.alarms[t]));for(let s=0,n=this.alarms[t].triggers.length;s<n;s++)this.alarms[t].triggers[s].enabled&&this.alarms[t].triggers[s].type===3&&(e[s]=Be.parse(this.alarms[t].triggers[s]));this._itemCache.alarmPatterns[t]=e}if(e[0]){let s=e[0],n=Date.now(),r=new Date,a=n,o=a+9e7,h=1e3;if(s.seconds!==-1?h=1e3:s.minutes!==-1?h=6e4:s.hours!==-1&&(h=36e5),s.tempTime)return s.tempTime-n>0?s.tempTime-n:0;for(;a<o;){if(this.alarm_match(s,a,r))return a-n;a+=h,r.setTime(r.getTime()+h)}return-1}return 0}updateAlarms(){if(this._itemCache.alarmPatterns){let t=this._itemCache.alarmPatterns,e=this.alarms;this._itemCache.alarmPatterns=[],this._itemCache.alarms=null;let s=this.alarms.length,n=-1;for(let r=0;r<s;r++)n=e.indexOf(this.alarms[r]),n!==-1&&(this._itemCache.alarmPatterns[r]=t[n])}this.startAlarms()}process_alarms(){if(!this.getOption("enableTriggers"))return;let t=0,e=!1,s=this.alarms.length;if(s===0&&this._alarm){clearInterval(this._alarm),this._alarm=null;return}let n=this._itemCache.alarmPatterns,r=Date.now(),a=this.alarms,o=new Date;for(t=s-1;t>=0;t--){let h=a[t],c=h;if(!h.enabled)continue;if(h.state>h.triggers.length&&(h.state=0),h.state!==0&&h.triggers&&h.triggers.length){for(h=h.triggers[h.state-1];!h.enabled&&c.state!==0;){if(c.state++,c.state>c.triggers.length){c.state=0,h=h.triggers[c.state-1];break}c.state?h=h.triggers[c.state-1]:h=c,e=!0}if(e&&(this.getOption("saveTriggerStateChanges")&&this.saveProfiles(),this.emit("item-updated","trigger",c.profile.name,c.profile.triggers.indexOf(c))),!h.enabled)continue}if(h.type===131072||h.type===262144){let w=this._input.adjustLastLine(this.display.lines.length,!0),p=this.display.lines[w];t=this._input.TestTrigger(h,c,t,p,this.display.lines[w].raw||p,w===this.display.lines.length-1);continue}if(h.type!==3)continue;let g=n[t];if(!g){try{n[t]={},h.type===3&&(n[t][0]=Be.parse(h));for(let w=0,p=h.triggers.length;w<p;w++)h.triggers[w].type===3&&(n[t][w]=Be.parse(h.triggers[w]))}catch(w){throw n[t]=null,this.getOption("disableTriggerOnError")&&(h.enabled=!1,setTimeout(()=>{this.saveProfiles(),this.emit("item-updated","trigger",c.profile,c.profile.triggers.indexOf(c),c)})),w}if(g=n[t],!g)continue}g=g[h.state],g.restart&&(g.startTime=Date.now(),g.prevTime=g.startTime,g.tempTime&&(g.tempTime+=Date.now()-g.restart),g.restart=0);let f=!0;if(g.tempTime?(f=r>=g.tempTime,f&&(g.tempTime=0)):f=this.alarm_match(g,r,o),f&&!g.suspended){g.prevTime=r;let w=c.state;if(this._input.lastTriggered=g.pattern,this._input.ExecuteTrigger(h,[g.pattern],!1,-t,null,null,c),w!==c.state&&(g.restart=Date.now()),g.temp)if(c.triggers.length)if(w===0){let p=c.triggers.shift();p.state=w,p.priority=c.priority,p.name=c.name,p.profile=c.profile,p.state>p.triggers.length&&(p.state=0),p.triggers=c.triggers,a[t]=p,n[t]=null,this.saveProfiles();let k=c.profile.triggers.indexOf(c);c.profile.triggers[k]=p,this.emit("item-updated","trigger",c.profile.name,k,p)}else{c.triggers.splice(w-1,1),n[t].splice(w-1,1),c.state=w,c.state>c.triggers.length&&(c.state=0),this.saveProfiles();let p=c.profile.triggers.indexOf(c);this.emit("item-updated","trigger",c.profile.name,p,c)}else this._input.clearTriggerState(t),this.removeTrigger(c);t=-this._input.cleanUpTriggerState(-t)}}}alarm_match(t,e,s){if(!t||t.suspended)return!1;let n=!0,r,a,o,h,c,g,f;if(!moment||this.simpleAlarms){if(r=e-this.connectTime,r<1e3)return!1;a=Math.round(r/1e3),o=Math.floor(a/60),h=Math.floor(o/60),c=h,g=Math.floor(o%60),f=Math.floor(a%60)}else{if(t.start?r=moment.duration(e-this.connectTime):r=moment.duration(e-t.startTime),r.asMilliseconds()<1e3)return!1;a=Math.round(r.asMilliseconds()/1e3),o=Math.floor(a/60),h=Math.floor(o/60),c=r.hours(),g=r.minutes(),f=r.seconds()}return t.hoursWildCard?t.hours===0?n=n&&c===0:t.hours!==-1&&(n=n&&h!==0&&h%t.hours===0):t.hours!==-1&&(n=n&&t.hours===(t.start?c:s.getHours())),t.minutesWildcard?t.minutes===0?n=n&&g===0:t.minutes!==-1&&(n=n&&o!==0&&o%t.minutes===0):t.minutes!==-1&&(n=n&&t.minutes===(t.start?g:s.getMinutes())),t.secondsWildcard?t.seconds===0?n=n&&f===0:t.seconds!==-1&&(n=n&&a%t.seconds===0):t.seconds!==-1&&(n=n&&t.seconds===(t.start?f:s.getSeconds())),n}loadOptions(){this._options=new Fe,this.enableDebug=this._options.enableDebug,this.display.maxLines=this._options.bufferSize,this.display.enableFlashing=this._options.flashing,this.display.enableMXP=this._options.enableMXP,this.display.showInvalidMXPTags=this._options["display.showInvalidMXPTags"],this.display.enableURLDetection=this._options.enableURLDetection,this.display.enableMSP=this._options.enableMSP,this.display.enableColors=this._options["display.enableColors"],this.display.enableBackgroundColors=this._options["display.enableBackgroundColors"],this.display.wordWrap=this._options["display.wordWrap"],this.display.wrapAt=this._options["display.wrapAt"],this.display.indent=this._options["display.indent"],this.display.showTimestamp=this._options["display.showTimestamp"],this.display.tabWidth=this._options["display.tabWidth"],this.display.timestampFormat=this._options["display.timestampFormat"];let t=this.getOption("colors");if(t&&t.length>0){let e,s=t.length;for(e=0;e<s;e++)!t[e]||t[e].length===0||this.display.SetColor(e,t[e])}this._telnet&&(this._telnet.options.MCCP=this._options.enableMCCP,this._telnet.options.MXP=this._options.enableMXP,this._telnet.UTF8=this._options.enableUTF8,this._telnet.options.ECHO=this._options.enableEcho,this._telnet.enableLatency=this._options.lagMeter,this._telnet.enablePing=this._options.enablePing),this._input.scrollLock=this._options.scrollLocked,this._input.enableParsing=this._options.enableParsing,this._input.enableTriggers=this._options.enableTriggers,this.display.scrollLock=this._options.scrollLocked,this.display.hideTrailingEmptyLine=this._options["display.hideTrailingEmptyLine"],this.display.displayControlCodes=this.getOption("display.displayControlCodes"),this.display.emulateTerminal=this.getOption("display.emulateTerminal"),this.display.emulateControlCodes=this.getOption("display.emulateControlCodes"),this._commandInput.wrap=this.getOption("commandWordWrap")?"on":"off",this.UpdateFonts&&this.UpdateFonts(),this.display.scrollDisplay(),this.loadProfiles(),this.emit("options-loaded")}setOption(t,e){t===-1||t==="-1"||(this._options[t]=e,Fe.setValue(t,e),this.emit("option=changed",t,e))}getOption(t){return this._options&&t in this._options?this._options[t]:this._options[t]=Fe.getValue(t)}UpdateFonts(){this.display&&(this.display.updateFont(this._options.font+", monospace",this._options.fontSize),this._commandInput.style.fontSize=this._options.cmdfontSize,this._commandInput.style.fontFamily=this._options.cmdfont+", monospace")}parse(t){this.parseInternal(t,!1,!1,!0)}parseInternal(t,e,s,n){this.display.append(t,e,s,n)}error(t){this.enableDebug&&this.debug(t);let e="";t==null||typeof t>"u"?t=new Error("Unknown"):typeof t=="string"&&t.length===0&&(t=new Error("Unknown")),t.stack&&this.getOption("showErrorsExtended")?e=t.stack:t instanceof Error||t instanceof TypeError?e=t.name+": "+t.message:t.message?e=t.message:e=""+t,e.match(/^.*Error: /g)||e.match(/^.*Error - /g)?this.echo(e,-11,-12,!0,!0):this.echo("Error: "+e,-11,-12,!0,!0),this.getOption("logErrors")&&(this.getOption("showErrorsExtended")?t.stack||(t=new Error(t||e),e=t.stack):(t.stack||(t=new Error(t||e)),e=t.stack),window.console.log(new Date().toLocaleString()),window.console.log(e),localforage.getItem("oiMUDErrorLog",function(s,n){localforage.setItem("oiMUDErrorLog",n=(n||"")+new Date().toLocaleString()+`
`+e+`
`)})),t==="Error: ECONNRESET - read ECONNRESET."&&this.telnet.connected&&this.close(),this.raise("error",e)}echo(t,e,s,n,r){t==null&&(t=""),n==null&&(n=!1),r==null&&(r=!1),e==null&&(e=-3),s==null&&(s=-4);let a="\x1B[0m"+this.display.CurrentAnsiCode()+`
`;t=""+t,t.endsWith(`
`)&&(t=t.substr(0,t.length-1)),this.telnet.prompt&&r?(this.print(`
\x1B[`+e+";"+s+"m"+t+a,n),this.telnet.prompt=!1):this.print("\x1B["+e+";"+s+"m"+t+a,n)}print(t,e){this.printInternal(t,e,!1,!0)}printInternal(t,e,s,n){t==null||typeof t>"u"||(e==null&&(e=!1),s==null&&(s=!1),e&&this.display.textLength>0&&!this.display.EndOfLine&&this.display.EndOfLineLength!==0&&!this.telnet.prompt&&!this.display.parseQueueEndOfLine&&(t=`
`+t),this.emit("print"),this.parseInternal(t,s,!1,n))}send(t,e){this.telnet.sendData(t),this.lastSendTime=Date.now(),e&&this.telnet.echo&&this.getOption("commandEcho")?this.echo(t):e&&this.echo(`
`)}sendRaw(t){this.telnet.sendData(t,!0),this.lastSendTime=Date.now()}sendGMCP(t){this.telnet.sendGMCP(t),this.lastSendTime=Date.now()}debug(t,e){let s={value:t};this.emit("debug",s),!(!this._enableDebug||s==null||typeof s>"u"||s.value==null||typeof s.value>"u"||s.value.length===0)&&window.console&&(e?window.console.log("%c"+t,e):window.console.log(s.value))}sendCommand(t,e,s){t==null&&(t=this._commandInput.value,this.telnet.echo?this._input.AddCommandToHistory(t):this._commandInput.value=""),t=""+t,t.endsWith(`
`)||(t=t+`
`);let n={value:t,handled:!1,comments:s};this.emit("parse-command",n),!(n==null||typeof n>"u")&&(n.handled||n.value==null||typeof n.value>"u"||(n.value.length>0&&this.send(n.value,!e),this.getOption("keepLastCommand")?this.getOption("selectLastCommand")&&Pi(this._commandInput):this._commandInput.value=""))}sendBackground(t,e,s){t==null&&(t=this._commandInput.value,this.telnet.echo?this._input.AddCommandToHistory(t):this._commandInput.value=""),t=""+t,t.endsWith(`
`)||(t=t+`
`);let n={value:t,handled:!1,comments:s};this.emit("parse-command",n),!(n==null||typeof n>"u")&&(n.value==null||typeof n.value>"u"||!n.handled&&n.value.length>0&&this.send(n.value,!e))}get scrollLock(){return this._input.scrollLock}set scrollLock(t){this._input.scrollLock=t}toggleScrollLock(){this._input.toggleScrollLock()}UpdateWindow(){this.display.updateWindow()}close(){this.telnet.close()}connect(){this.errored=!1,this.emit("connecting"),this.display.ClearMXP(),this.display.ResetMXPLine(),this.telnet.connect(),this.emit("connect"),this._commandInput.focus()}receivedData(t){this.telnet.receivedData(t)}notify(t,e,s){this.enableDebug&&(this.emit("debug","notify title: "+t),this.emit("debug","notify msg: "+e)),this.emit("notify",t,e,s)}clear(){this.display.clear(),this.emit("cleared")}parseInline(t){return this._input.parseInline(t)}parseOutgoing(t,e,s,n){return this._input.parseOutgoing(t,e,s,n)}clearCache(){this._input.clearCaches(),this._itemCache={triggers:null,aliases:null,macros:null,buttons:null,contexts:null,defaultContext:null,alarms:null,alarmPatterns:[]}}beep(){this.emit("bell")}raise(t,e,s){if(!this.profiles){setTimeout(()=>{this.raise(t,e,s)},100);return}!s||s<1?this._input.triggerEvent(t,e):setTimeout(()=>{this._input.triggerEvent(t,e)},s)}show(){this.emit("show")}hide(){this.emit("hide")}toggle(){this.emit("toggle")}};window.Client=Xe;window.Display=It;})();
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
/**
 * A class to parse color values
 * @author Stoyan Stefanov <sstoo@gmail.com>
 * @link   http://www.phpied.com/rgb-color-parser-in-javascript/
 * @license Use it if you like it
 */
//# sourceMappingURL=oiMUD.min.js.map
