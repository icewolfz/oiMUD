(()=>{var fi=Object.create;var Xt=Object.defineProperty;var mi=Object.getOwnPropertyDescriptor;var di=Object.getOwnPropertyNames;var gi=Object.getPrototypeOf,bi=Object.prototype.hasOwnProperty;var jt=(p,h)=>()=>(h||p((h={exports:{}}).exports,h),h.exports);var yi=(p,h,t,e)=>{if(h&&typeof h=="object"||typeof h=="function")for(let i of di(h))!bi.call(p,i)&&i!==t&&Xt(p,i,{get:()=>h[i],enumerable:!(e=mi(h,i))||e.enumerable});return p};var Vt=(p,h,t)=>(t=p!=null?fi(gi(p)):{},yi(h||!p||!p.__esModule?Xt(t,"default",{value:p,enumerable:!0}):t,p));var ei=jt(Jt=>{(function(){"use strict";var p=void 0,h=!0,t=this;function e(L,P){var G=L.split("."),M=t;!(G[0]in M)&&M.execScript&&M.execScript("var "+G[0]);for(var E;G.length&&(E=G.shift());)!G.length&&P!==p?M[E]=P:M=M[E]?M[E]:M[E]={}}var i=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u"&&typeof DataView<"u";function n(L){var P=L.length,G=0,M=Number.POSITIVE_INFINITY,E,D,B,V,w,K,O,R,A,z;for(R=0;R<P;++R)L[R]>G&&(G=L[R]),L[R]<M&&(M=L[R]);for(E=1<<G,D=new(i?Uint32Array:Array)(E),B=1,V=0,w=2;B<=G;){for(R=0;R<P;++R)if(L[R]===B){for(K=0,O=V,A=0;A<B;++A)K=K<<1|O&1,O>>=1;for(z=B<<16|R,A=K;A<E;A+=w)D[A]=z;++V}++B,V<<=1,w<<=1}return[D,G,M]}function s(L,P,G){this.u=[],this.i=G||32768,this.v=0,this.a=P===p?0:P,this.d=this.e=0,this.input=i?new Uint8Array(L):L,this.b=new(i?Uint8Array:Array)(this.i),this.c=0,this.t=this.l=!1,this.f=0,this.status=o}var o=0;s.prototype.j=function(L,P){var G=!1;for(L!==p&&(this.input=L),P!==p&&(this.a=P);!G;)switch(this.status){case o:case 1:var M,E=p;if(this.status=1,N(this),0>(E=d(this,3)))J(this),M=-1;else{switch(E&1&&(this.l=h),E>>>=1,E){case 0:this.h=0;break;case 1:this.h=1;break;case 2:this.h=2;break;default:throw Error("unknown BTYPE: "+E)}this.status=2,M=p}0>M&&(G=h);break;case 2:case 3:switch(this.h){case 0:var D,B=p,V=p,w=this.input,K=this.a;if(this.status=3,K+4>=w.length)D=-1;else{if(B=w[K++]|w[K++]<<8,V=w[K++]|w[K++]<<8,B===~V)throw Error("invalid uncompressed block header: length verify");this.d=this.e=0,this.a=K,this.m=B,this.status=4,D=p}0>D&&(G=h);break;case 1:this.status=3,this.k=k,this.n=b,this.status=4;break;case 2:var O;e:{var R=p,A=p,z=p,re=new(i?Uint8Array:Array)(a.length),ce=p;if(this.status=3,N(this),R=d(this,5)+257,A=d(this,5)+1,z=d(this,4)+4,0>R||0>A||0>z)J(this),O=-1;else{try{for(var he=p,ae=p,Le=0,me=p,Q=p,de=p,$t=p,de=0;de<z;++de){if(0>(he=d(this,3)))throw Error("not enough input");re[a[de]]=he}for(ce=n(re),Q=new(i?Uint8Array:Array)(R+A),de=0,$t=R+A;de<$t;){if(ae=v(this,ce),0>ae)throw Error("not enough input");switch(ae){case 16:if(0>(he=d(this,2)))throw Error("not enough input");for(me=3+he;me--;)Q[de++]=Le;break;case 17:if(0>(he=d(this,3)))throw Error("not enough input");for(me=3+he;me--;)Q[de++]=0;Le=0;break;case 18:if(0>(he=d(this,7)))throw Error("not enough input");for(me=11+he;me--;)Q[de++]=0;Le=0;break;default:Le=Q[de++]=ae}}new(i?Uint8Array:Array)(R),new(i?Uint8Array:Array)(A),this.k=n(i?Q.subarray(0,R):Q.slice(0,R)),this.n=n(i?Q.subarray(R):Q.slice(R))}catch{J(this),O=-1;break e}this.status=4,O=0}}0>O&&(G=h)}break;case 4:case 5:switch(this.h){case 0:var Et;e:{var Ut=this.input,nt=this.a,_t=this.b,rt=this.c,Ct=this.m;for(this.status=5;Ct--;){if(rt===_t.length&&(_t=oe(this,{o:2})),nt>=Ut.length){this.a=nt,this.c=rt,this.m=Ct+1,Et=-1;break e}_t[rt++]=Ut[nt++]}0>Ct&&(this.status=6),this.a=nt,this.c=rt,Et=0}0>Et&&(G=h);break;case 1:case 2:0>se(this)&&(G=h)}break;case 6:this.l?G=h:this.status=o}var Ht,ve=this.c,zt;return Ht=this.t?i?new Uint8Array(this.b.subarray(this.f,ve)):this.b.slice(this.f,ve):i?this.b.subarray(this.f,ve):this.b.slice(this.f,ve),this.f=ve,ve>32768+this.i&&(this.c=this.f=32768,i?(zt=this.b,this.b=new Uint8Array(this.i+32768),this.b.set(zt.subarray(ve-32768,ve))):this.b=this.b.slice(ve-32768)),Ht};var r=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],a=i?new Uint16Array(r):r,l=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],f=i?new Uint16Array(l):l,c=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],y=i?new Uint8Array(c):c,u=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],x=i?new Uint16Array(u):u,S=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],m=i?new Uint8Array(S):S,g=new(i?Uint8Array:Array)(288),T,I;for(T=0,I=g.length;T<I;++T)g[T]=143>=T?8:255>=T?9:279>=T?7:8;var k=n(g),H=new(i?Uint8Array:Array)(30),C,_;for(C=0,_=H.length;C<_;++C)H[C]=5;var b=n(H);function d(L,P){for(var G=L.e,M=L.d,E=L.input,D=L.a,B;M<P;){if(E.length<=D)return-1;B=E[D++],G|=B<<M,M+=8}return B=G&(1<<P)-1,L.e=G>>>P,L.d=M-P,L.a=D,B}function v(L,P){for(var G=L.e,M=L.d,E=L.input,D=L.a,B=P[0],V=P[1],w,K,O;M<V;){if(E.length<=D)return-1;w=E[D++],G|=w<<M,M+=8}if(K=B[G&(1<<V)-1],O=K>>>16,O>M)throw Error("invalid code length: "+O);return L.e=G>>O,L.d=M-O,L.a=D,K&65535}function N(L){L.s=L.a,L.r=L.d,L.q=L.e}function J(L){L.a=L.s,L.d=L.r,L.e=L.q}function se(L){var P=L.b,G=L.c,M,E,D,B,V=L.k,w=L.n,K=P.length,O;for(L.status=5;;){if(N(L),M=v(L,V),0>M)return L.c=G,J(L),-1;if(M===256)break;if(256>M)G===K&&(P=oe(L),K=P.length),P[G++]=M;else{if(E=M-257,B=f[E],0<y[E]){if(O=d(L,y[E]),0>O)return L.c=G,J(L),-1;B+=O}if(M=v(L,w),0>M)return L.c=G,J(L),-1;if(D=x[M],0<m[M]){if(O=d(L,m[M]),0>O)return L.c=G,J(L),-1;D+=O}for(G+B>=K&&(P=oe(L),K=P.length);B--;)P[G]=P[G++-D];if(L.a===L.input.length)return L.c=G,-1}}for(;8<=L.d;)L.d-=8,L.a--;L.c=G,L.status=6}function oe(L,P){var G,M=L.input.length/L.a+1|0,E,D,B,V=L.input,w=L.b;return P&&(typeof P.o=="number"&&(M=P.o),typeof P.p=="number"&&(M+=P.p)),2>M?(E=(V.length-L.a)/L.k[2],B=258*(E/2)|0,D=B<w.length?w.length+B:w.length<<1):D=w.length*M,i?(G=new Uint8Array(D),G.set(w)):G=w,L.b=G,L.b}function ee(L){this.input=L===p?new(i?Uint8Array:Array):L,this.a=0,this.g=new s(this.input,this.a),this.b=this.g.b}ee.prototype.j=function(L){var P;if(L!==p)if(i){var G=new Uint8Array(this.input.length+L.length);G.set(this.input,0),G.set(L,this.input.length),this.input=G}else this.input=this.input.concat(L);var M;if(M=this.method===p){var E,D=this.a,B=this.input,V=B[D++],w=B[D++];if(V===p||w===p)E=-1;else{switch(V&15){case 8:this.method=8;break;default:throw Error("unsupported compression method")}if(((V<<8)+w)%31!==0)throw Error("invalid fcheck flag:"+((V<<8)+w)%31);if(w&32)throw Error("fdict flag is not supported");this.a=D,E=p}M=0>E}return M?new(i?Uint8Array:Array):(P=this.g.j(this.input,this.a),this.g.a!==0&&(this.input=i?this.input.subarray(this.g.a):this.input.slice(this.g.a),this.a=0),P)},e("Zlib.InflateStream",ee),e("Zlib.InflateStream.prototype.decompress",ee.prototype.j)}).call(Jt)});var ri=jt((ni,yt)=>{(function(p,h){"use strict";typeof yt<"u"&&yt.exports?yt.exports=h():typeof define=="function"&&define.amd?define([],h):p.buzz=h()})(ni,function(){"use strict";var p=window.AudioContext||window.webkitAudioContext,h={defaults:{autoplay:!1,duration:5e3,formats:[],loop:!1,placeholder:"--",preload:"metadata",volume:80,webAudioApi:!1,document:window.document},types:{mp3:"audio/mpeg",ogg:"audio/ogg",wav:"audio/wav",aac:"audio/aac",m4a:"audio/x-m4a"},sounds:[],el:document.createElement("audio"),getAudioContext:function(){if(this.audioCtx===void 0)try{this.audioCtx=p?new p:null}catch{this.audioCtx=null}return this.audioCtx},sound:function(t,e){e=e||{};var i=e.document||h.defaults.document,n=0,s=[],o={},r=h.isSupported();this.load=function(){return r?(this.sound.load(),this):this},this.play=function(){return r?(this.sound.play(),this):this},this.togglePlay=function(){return r?(this.sound.paused?this.sound.play():this.sound.pause(),this):this},this.pause=function(){return r?(this.sound.pause(),this):this},this.isPaused=function(){return r?this.sound.paused:null},this.stop=function(){return r?(this.setTime(0),this.sound.pause(),this):this},this.isEnded=function(){return r?this.sound.ended:null},this.loop=function(){return r?(this.sound.loop="loop",this.bind("ended.buzzloop",function(){this.currentTime=0,this.play()}),this):this},this.unloop=function(){return r?(this.sound.removeAttribute("loop"),this.unbind("ended.buzzloop"),this):this},this.mute=function(){return r?(this.sound.muted=!0,this):this},this.unmute=function(){return r?(this.sound.muted=!1,this):this},this.toggleMute=function(){return r?(this.sound.muted=!this.sound.muted,this):this},this.isMuted=function(){return r?this.sound.muted:null},this.setVolume=function(x){return r?(x<0&&(x=0),x>100&&(x=100),this.volume=x,this.sound.volume=x/100,this):this},this.getVolume=function(){return r?this.volume:this},this.increaseVolume=function(x){return this.setVolume(this.volume+(x||1))},this.decreaseVolume=function(x){return this.setVolume(this.volume-(x||1))},this.setTime=function(x){if(!r)return this;var S=!0;return this.whenReady(function(){S===!0&&(S=!1,this.sound.currentTime=x)}),this},this.getTime=function(){if(!r)return null;var x=Math.round(this.sound.currentTime*100)/100;return isNaN(x)?h.defaults.placeholder:x},this.setPercent=function(x){return r?this.setTime(h.fromPercent(x,this.sound.duration)):this},this.getPercent=function(){if(!r)return null;var x=Math.round(h.toPercent(this.sound.currentTime,this.sound.duration));return isNaN(x)?h.defaults.placeholder:x},this.setSpeed=function(x){return r?(this.sound.playbackRate=x,this):this},this.getSpeed=function(){return r?this.sound.playbackRate:null},this.getDuration=function(){if(!r)return null;var x=Math.round(this.sound.duration*100)/100;return isNaN(x)?h.defaults.placeholder:x},this.getPlayed=function(){return r?a(this.sound.played):null},this.getBuffered=function(){return r?a(this.sound.buffered):null},this.getSeekable=function(){return r?a(this.sound.seekable):null},this.getErrorCode=function(){return r&&this.sound.error?this.sound.error.code:0},this.getErrorMessage=function(){if(!r)return null;switch(this.getErrorCode()){case 1:return"MEDIA_ERR_ABORTED";case 2:return"MEDIA_ERR_NETWORK";case 3:return"MEDIA_ERR_DECODE";case 4:return"MEDIA_ERR_SRC_NOT_SUPPORTED";default:return null}},this.getStateCode=function(){return r?this.sound.readyState:null},this.getStateMessage=function(){if(!r)return null;switch(this.getStateCode()){case 0:return"HAVE_NOTHING";case 1:return"HAVE_METADATA";case 2:return"HAVE_CURRENT_DATA";case 3:return"HAVE_FUTURE_DATA";case 4:return"HAVE_ENOUGH_DATA";default:return null}},this.getNetworkStateCode=function(){return r?this.sound.networkState:null},this.getNetworkStateMessage=function(){if(!r)return null;switch(this.getNetworkStateCode()){case 0:return"NETWORK_EMPTY";case 1:return"NETWORK_IDLE";case 2:return"NETWORK_LOADING";case 3:return"NETWORK_NO_SOURCE";default:return null}},this.set=function(x,S){return r?(this.sound[x]=S,this):this},this.get=function(x){return r?x?this.sound[x]:this.sound:null},this.bind=function(x,S){if(!r)return this;x=x.split(" ");for(var m=this,g=function(H){S.call(m,H)},T=0;T<x.length;T++){var I=x[T],k=I;I=k.split(".")[0],s.push({idx:k,func:g}),this.sound.addEventListener(I,g,!0)}return this},this.unbind=function(x){if(!r)return this;x=x.split(" ");for(var S=0;S<x.length;S++)for(var m=x[S],g=m.split(".")[0],T=0;T<s.length;T++){var I=s[T].idx.split(".");(s[T].idx===m||I[1]&&I[1]===m.replace(".",""))&&(this.sound.removeEventListener(g,s[T].func,!0),s.splice(T,1))}return this},this.bindOnce=function(x,S){if(!r)return this;var m=this;return o[n++]=!1,this.bind(x+"."+n,function(){o[n]||(o[n]=!0,S.call(m)),m.unbind(x+"."+n)}),this},this.trigger=function(x,S){if(!r)return this;x=x.split(" ");for(var m=0;m<x.length;m++)for(var g=x[m],T=0;T<s.length;T++){var I=s[T].idx.split(".");if(s[T].idx===g||I[0]&&I[0]===g.replace(".","")){var k=i.createEvent("HTMLEvents");k.initEvent(I[0],!1,!0),k.originalEvent=S,this.sound.dispatchEvent(k)}}return this},this.fadeTo=function(x,S,m){if(!r)return this;S instanceof Function?(m=S,S=h.defaults.duration):S=S||h.defaults.duration;var g=this.volume,T=S/Math.abs(g-x),I=this;this.play();function k(){setTimeout(function(){g<x&&I.volume<x?(I.setVolume(I.volume+=1),k()):g>x&&I.volume>x?(I.setVolume(I.volume-=1),k()):m instanceof Function&&m.apply(I)},T)}return this.whenReady(function(){k()}),this},this.fadeIn=function(x,S){return r?this.setVolume(0).fadeTo(100,x,S):this},this.fadeOut=function(x,S){return r?this.fadeTo(0,x,S):this},this.fadeWith=function(x,S){return r?(this.fadeOut(S,function(){this.stop()}),x.play().fadeIn(S),this):this},this.whenReady=function(x){if(!r)return null;var S=this;this.sound.readyState===0?this.bind("canplay.buzzwhenready",function(){x.call(S)}):x.call(S)},this.addSource=function(x){var S=this,m=i.createElement("source");return m.src=x,h.types[l(x)]&&(m.type=h.types[l(x)]),this.sound.appendChild(m),m.addEventListener("error",function(g){S.trigger("sourceerror",g)}),m};function a(x){for(var S=[],m=x.length-1,g=0;g<=m;g++)S.push({start:x.start(g),end:x.end(g)});return S}function l(x){return x.split(".").pop()}if(r&&t){for(var f in h.defaults)h.defaults.hasOwnProperty(f)&&e[f]===void 0&&(e[f]=h.defaults[f]);if(this.sound=i.createElement("audio"),e.webAudioApi){var c=h.getAudioContext();c&&(this.source=c.createMediaElementSource(this.sound),this.source.connect(c.destination))}if(t instanceof Array)for(var y in t)t.hasOwnProperty(y)&&this.addSource(t[y]);else if(e.formats.length)for(var u in e.formats)e.formats.hasOwnProperty(u)&&this.addSource(t+"."+e.formats[u]);else this.addSource(t);e.loop&&this.loop(),e.autoplay&&(this.sound.autoplay="autoplay"),e.preload===!0?this.sound.preload="auto":e.preload===!1?this.sound.preload="none":this.sound.preload=e.preload,this.setVolume(e.volume),h.sounds.push(this)}},group:function(t){t=i(t,arguments),this.getSounds=function(){return t},this.add=function(n){n=i(n,arguments);for(var s=0;s<n.length;s++)t.push(n[s])},this.remove=function(n){n=i(n,arguments);for(var s=0;s<n.length;s++)for(var o=0;o<t.length;o++)if(t[o]===n[s]){t.splice(o,1);break}},this.load=function(){return e("load"),this},this.play=function(){return e("play"),this},this.togglePlay=function(){return e("togglePlay"),this},this.pause=function(n){return e("pause",n),this},this.stop=function(){return e("stop"),this},this.mute=function(){return e("mute"),this},this.unmute=function(){return e("unmute"),this},this.toggleMute=function(){return e("toggleMute"),this},this.setVolume=function(n){return e("setVolume",n),this},this.increaseVolume=function(n){return e("increaseVolume",n),this},this.decreaseVolume=function(n){return e("decreaseVolume",n),this},this.loop=function(){return e("loop"),this},this.unloop=function(){return e("unloop"),this},this.setSpeed=function(n){return e("setSpeed",n),this},this.setTime=function(n){return e("setTime",n),this},this.set=function(n,s){return e("set",n,s),this},this.bind=function(n,s){return e("bind",n,s),this},this.unbind=function(n){return e("unbind",n),this},this.bindOnce=function(n,s){return e("bindOnce",n,s),this},this.trigger=function(n){return e("trigger",n),this},this.fade=function(n,s,o,r){return e("fade",n,s,o,r),this},this.fadeIn=function(n,s){return e("fadeIn",n,s),this},this.fadeOut=function(n,s){return e("fadeOut",n,s),this};function e(){for(var n=i(null,arguments),s=n.shift(),o=0;o<t.length;o++)t[o][s].apply(t[o],n)}function i(n,s){return n instanceof Array?n:Array.prototype.slice.call(s)}},all:function(){return new h.group(h.sounds)},isSupported:function(){return!!h.el.canPlayType},isOGGSupported:function(){return!!h.el.canPlayType&&h.el.canPlayType('audio/ogg; codecs="vorbis"')},isWAVSupported:function(){return!!h.el.canPlayType&&h.el.canPlayType('audio/wav; codecs="1"')},isMP3Supported:function(){return!!h.el.canPlayType&&h.el.canPlayType("audio/mpeg;")},isAACSupported:function(){return!!h.el.canPlayType&&(h.el.canPlayType("audio/x-m4a;")||h.el.canPlayType("audio/aac;"))},toTimer:function(t,e){var i,n,s;return i=Math.floor(t/3600),i=isNaN(i)?"--":i>=10?i:"0"+i,n=Math.floor(e?t/60%60:t/60),n=isNaN(n)?"--":n>=10?n:"0"+n,s=Math.floor(t%60),s=isNaN(s)?"--":s>=10?s:"0"+s,e?i+":"+n+":"+s:n+":"+s},fromTimer:function(t){var e=t.toString().split(":");return e&&e.length===3&&(t=parseInt(e[0],10)*3600+parseInt(e[1],10)*60+parseInt(e[2],10)),e&&e.length===2&&(t=parseInt(e[0],10)*60+parseInt(e[1],10)),t},toPercent:function(t,e,i){var n=Math.pow(10,i||0);return Math.round(t*100/e*n)/n},fromPercent:function(t,e,i){var n=Math.pow(10,i||0);return Math.round(e/100*t*n)/n}};return h})});var ie=class{#e={};bind(h,t,e){(!Array.isArray(this.#e[h])||typeof this.#e[h]>"u")&&(this.#e[h]=[]),this.#e[h].push({listener:t,caller:e})}on(h,t,e){this.bind(h,t,e)}addEventListener(h,t,e){this.bind(h,t,e)}fire(h,t,e){if(!h||typeof h!="string")throw new Error("Event missing.");if(Array.isArray(this.#e[h])){!t||t===null||typeof t>"u"?t=[]:Array.isArray(t)||(t=[t]),e=e||this;for(var i=this.#e[h],n=0,s=i.length;n<s;n++)i[n].listener.apply(i[n].caller||e,t)}}emit(h,...t){this.fire(h,t)}dispatchEvent(h,t,e){this.fire(h,t,e)}unbind(h,t){if(!h||!t||!Array.isArray(this.#e[h]))return;let e=this.#e[h];for(let i=e.length-1;i>=0;i--)if(e[i].listener===t){e.splice(i,1);break}}remove(h,t){this.unbind(h,t)}off(h,t){this.unbind(h,t)}removeListener(h,t){this.unbind(h,t)}removeAllListeners(h){if(!h){this.#e=[];return}Array.isArray(this.#e[h])&&delete this.#e[h]}removeListenersFromCaller(h,t){if(!t){Object.keys(this.#e).forEach(i=>{let n=this.#e[i];for(let s=n.length-1;s>=0;s--)if(n[s].caller===h){n.splice(s,1);break}});return}if(!Array.isArray(this.#e[t]))return;let e=this.#e[t];for(let i=0,n=e.length;i<n;i++)if(e[i].caller===h){e.splice(i,1);break}}listeners(h){return h?this.#e[h]||[]:this.#e}};Array.prototype.filter||(Array.prototype.filter=function(p){var h=this.length>>>0;if(typeof p!="function")throw new TypeError;for(var t=[],e=arguments[1],i=0;i<h;i++)if(i in this){var n=this[i];p.call(e,n,i,this)&&t.push(n)}return t});function wi(p,h){return p.priority>h.priority?-1:p.priority<h.priority?1:0}function Si(p,h){return p.priority>h.priority?-1:p.priority<h.priority?1:p.index<h.index?-1:p.index>h.index?1:0}function U(p){let h=p.map((t,e)=>({index:e,priority:t.priority}));return h.sort(Si),h.map(t=>p[t.index])}function We(p,h,t){let e=[];if(!p||p.length===0)return e;let i=p.length;for(let n=0;n<i;n++)p[n].enabled&&p[n][h]===t&&e.push(p[n]);return e.length<=1?e:e.sort(wi)}var lt=document.createElement("div");function Ie(p){return lt.textContent=p,lt.innerHTML}function Lt(p){return lt.innerHTML=p,lt.textContent}function F(p){return p=p.replace(/^"(.+(?="$))?"$/,"$1"),p=p.replace(/^'(.+(?='$))?'$/,"$1"),p}var xe=class{constructor(h){this.length=0;typeof h=="string"&&h.length>0?this.buffer=[h]:this.buffer=[],this.length=0}prepend(h){return this.buffer.unshift(h),this.length+=h.length,this}append(h){return this.buffer.push(h),this.length+=h.length,this}push(h){typeof h=="number"?this.appendCode(h):this.append(h)}appendCode(h){return this.buffer.push(String.fromCharCode(h)),this.length++,this}toString(){return this.buffer.join("")}clear(h){return this.buffer=[],this.length=0,h&&typeof h<"u"&&h.length&&(this.buffer.push(h),this.length=h.length),this}concat(h){this.buffer=this.buffer.concat(h)}};function ot(p,h){if(p.length>1)return!1;if(p==="-"||p==="_"||p==="."||p==="~"||p==="!"||p==="*"||p==="'"||p===";"||p===":"||p==="@"||p==="&"||p==="="||p==="+"||p==="$"||p===","||p==="/"||p==="\\"||p==="?"||p==="%"||p==="#"||p==="["||p==="]"||p==="("||p===")")return!h;let t=p.charCodeAt(0);return t>64&&t<91||t>96&&t<123||t>47&&t<58||t>=160&&t<=55295||t>=57344&&t<=64975||t>=65008&&t<=65533||t>=65536&&t<=131069||t>=131072&&t<=196605||t>=196608&&t<=262141||t>=262144&&t<=327677||t>=327680&&t<=393213||t>=393216&&t<=458749||t>=458752&&t<=524285||t>=524288&&t<=589821||t>=589824&&t<=655357||t>=655360&&t<=720893||t>=720896&&t<=786429||t>=786432&&t<=851965||t>=851968&&t<=917501||t>=921600&&t<=983037||t>=983040&&t<=1048573||t>=1048576&&t<=1114109}var It={3:"Cancel",6:"Help",8:"Backspace",9:"Tab",19:"Pause/Break",20:"Caps Lock",21:"Kana",22:"Eisu",23:"Junja",24:"Final",25:"Hanja",27:"Esc",28:"Convert",29:"Nonconvert",30:"Accept",31:"Modechange",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",41:"Select",42:"Print",43:"Execute",44:"Printscreen",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",58:"Colon",59:"Semicolon",60:"Less Than",61:"Equals2",62:"Greater Than",63:"Question Mark",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",93:"Context Menu",95:"Sleep",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",124:"F13",125:"F14",126:"F15",127:"F16",128:"F17",129:"F18",130:"F19",131:"F20",132:"F21",133:"F22",134:"F23",135:"F24",144:"Num Lock",145:"Scroll Lock",146:"Win Oem Fj Jisho",147:"Win Oem Fj Masshou",148:"Win Oem Fj Touroku",149:"Win Oem Fj Loya",150:"Win Oem Fj Roya",160:"Circumflex",161:"Exclamation",162:"Double Quote",163:"Hash",164:"Dollar",165:"Percent",166:"Ampersand",167:"Underscore",168:"Open Paren",169:"Close Paren",170:"Asterisk",171:"Plus",172:"Pipe",173:"Hyphen Minus",174:"Open Curly Bracket",175:"Close Curly Bracket",176:"Tilde",181:"Volume Mute",182:"Volume Down",183:"Volume Up",186:";",187:"Equals",188:",",189:"Minus",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",227:"Win Ico Help",228:"Win Ico 00",230:"Win Ico Clear",233:"Win Oem Reset",234:"Win Oem Jump",235:"Win Oem Pa1",236:"Win Oem Pa2",237:"Win Oem Pa3",238:"Win Oem Wsctrl",239:"Win Oem Cusel",240:"Win Oem Attn",241:"Win Oem Finish",242:"Win Oem Copy",243:"Win Oem Auto",244:"Win Oem Enlw",245:"Win Oem Backtab",246:"Attn",247:"Crsel",248:"Exsel",249:"Ereof",250:"Play",251:"Zoom",253:"Pa1",254:"Win Oem Clear"};(function(p){p.fn.hasHorizontalScrollBar=function(){return p(this)[0].scrollWidth>p(this).innerWidth()}})(jQuery);function ge(p,h){return JSON.parse(JSON.stringify(p,h))}function qt(p){!p||p.value.length===0||(p.setSelectionRange?(p.focus(),p.setSelectionRange(0,p.value.length)):p.select())}CanvasRenderingContext2D.prototype.fillRoundedRect=function(p,h,t,e,i){this.beginPath(),this.moveTo(p+i,h),this.lineTo(p+t-i,h),this.quadraticCurveTo(p+t,h,p+t,h+i),this.lineTo(p+t,h+e-i),this.quadraticCurveTo(p+t,h+e,p+t-i,h+e),this.lineTo(p+i,h+e),this.quadraticCurveTo(p,h+e,p,h+e-i),this.lineTo(p,h+i),this.quadraticCurveTo(p,h,p+i,h),this.closePath(),this.fill()};CanvasRenderingContext2D.prototype.strokeRoundedRect=function(p,h,t,e,i){this.beginPath(),this.moveTo(p+i,h),this.lineTo(p+t-i,h),this.quadraticCurveTo(p+t,h,p+t,h+i),this.lineTo(p+t,h+e-i),this.quadraticCurveTo(p+t,h+e,p+t-i,h+e),this.lineTo(p+i,h+e),this.quadraticCurveTo(p,h+e,p,h+e-i),this.lineTo(p,h+i),this.quadraticCurveTo(p,h,p+i,h),this.closePath(),this.stroke()};Object.keys||(Object.keys=function(p){if(p!==Object(p))throw new TypeError("Object.keys called on a non-object");var h=[],t;for(t in p)Object.prototype.hasOwnProperty.call(p,t)&&h.push(t);return h});Object.toType||(Object.toType=function(p){return{}.toString.call(p).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()});typeof String.prototype.startsWith!="function"&&(String.prototype.startsWith=function(p){return this.slice(0,p.length)==p});typeof String.prototype.endsWith!="function"&&(String.prototype.endsWith=function(p){return this.slice(-p.length)==p});typeof String.prototype.splice!="function"&&(String.prototype.splice=function(p,h,t){return typeof t>"u"&&(t=0),this.slice(0,p)+h+this.slice(p+Math.abs(t))});typeof String.prototype.padStart!="function"&&(String.prototype.padStart=function(p){return typeof p=="number"&&(p=" ".repeat(p)),String(p+this).slice(-p.length)});typeof String.prototype.padEnd!="function"&&(String.prototype.padEnd=function(p){return typeof p=="number"?p<=this.length?this:(p=" ".repeat(p-this.length),this+p):p.length<=this.length?this:this+p.slice(-this.length)});String.prototype.replaceAll||(String.prototype.replaceAll=function(p,h){return Object.prototype.toString.call(p).toLowerCase()==="[object regexp]"?this.replace(p,h):this.replace(new RegExp(p,"g"),h)});typeof Uint8Array.prototype.charAt!="function"&&(Uint8Array.prototype.charAt=function(p){return String.fromCharCode(this[p])});typeof Uint8Array.prototype.charCodeAt!="function"&&(Uint8Array.prototype.charCodeAt=function(p){return this[p]});function vi(p,h){return!p||!p.length?p:h?p.replace(/\\/g,"\\\\").replace(/\u0008/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\u0000/g,"\\0"):p.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"')}String.prototype.addSlashes=function(){return vi(this)};String.prototype.splitQuote=function(p,h,t,e){if(this.length===0)return[];if(!p||!p.length)return[this];h||(h=3),t||(t=3),e||(e="\\");let i=!1,n=!1,s=[],o=0,r=0,a,l="",f,c=p.length,y,u=this.length;for(;r<u;r++){if(a=this.charAt(r),a==='"'&&(h&2)===2)(t&2)===2?(r===0||l!==e)&&(i=!i):i=!i;else if(a==="'"&&(h&1)===1)(t&1)===1?(r===0||l!==e)&&(n=!n):n=!n;else if(!i&&!n){for(f=0;f<c;f++)if(y=p.charAt(f),a===y)if(r>o||r===0){s.push(this.substr(o,r-o)),o=r+1;break}else if(r===o){s.push(""),o=r+1;break}else r===u-1&&s.push("")}l=a}return r===u&&r===o&&p.indexOf(l)!==-1&&(s.push(""),o=r+1),r>o&&s.push(this.substr(o,r-o)),s};function Rt(p){let h,t=[];return h=Math.floor(p/(1e3*60*60*24)),p-=h*(1e3*60*60*24),h===1?t.push(h+" day"):h>0&&t.push(h+" days"),h=Math.floor(p/(1e3*60*60)),p-=h*(1e3*60*60),h===1?t.push(h+" hour"):h>0&&t.push(h+" hours"),h=Math.floor(p/(1e3*60)),p-=h*(1e3*60),h===1?t.push(h+" minute"):h>0&&t.push(h+" minutes"),h=Math.floor(p/1e3),p-=h*1e3,h===1?t.push(h+" second"):h>0&&t.push(h+" seconds"),t.length===0&&t.push("0 seconds"),t.join(", ")}function Pt(p,h){if(!p)return"";p=p.split(" ");let t,e,i,n=h?1:p.length;for(e=0;e<n;e++){let s=p[e].length;for(i=0;i<s;i++)if(t=p[e].charAt(i),t>="a"&&t<="z"||t>="A"&&t<="Z"){p[e]=p[e].substr(0,i)+t.toUpperCase()+p[e].substr(i+1).toLowerCase();break}}return p.join(" ")}function at(p,h,t,e,i){if(typeof t>"u"&&(t=3),typeof e>"u"&&(e=0),typeof i>"u"&&(i="\\"),!p||p.length===0)return[];if(!h||h.length===0)return[p];h=h.split("");let n=!1,s=!1,o=[],r=0,a=0,l=p.length,f;for(;a<l;a++)if(f=p.charAt(a),f==='"'&&(t&2)===2)(e&2)===2&&a>0?a-1>0&&p.charAt(a-1)!==i&&(n=!n):n=!n;else if(f==="'"&&(t&1)===1)(e&1)===1&&a>0?a-1>0&&p.charAt(a-1)!==i&&(s=!s):s=!s;else if(!s&&!n){let c=h.length;for(let y=0;y<c;y++)if(f===h[y])if(a>r||a===0){o.push(p.substring(r,a)),r=a+1;break}else if(a===r){o.push(""),r=a+1;break}else a===l-1&&o.push("")}return a===l&&a===r&&h.indexOf(p.charAt(a-1))>-1&&(o.push(""),r=a+1),a>r&&o.push(p.substring(r,a)),o}function Kt(p){if(!p)return 0;if(typeof p.selectionStart=="number")return p.selectionDirection=="backward"?p.selectionStart:p.selectionEnd;if(document.selection){p.focus();var h=document.selection.createRange();return h.moveStart("character",-p.value.length),h.text.length}return 0}var q;function Bt(p){p=p||"",p=p.split("%^"),q||xi();let h=[],t=[],e=0,i=p.length,n=!1,s=!1,o=[];for(;e<i;e++)switch(p[e]){case"ITALIC":h.push("<em>"),t.push("</em>");break;case"UNDERLINE":o.push("underline");break;case"STRIKEOUT":o.push("strikeout");break;case"DBLUNDERLINE":o.push("dblunderline");break;case"OVERLINE":o.push("overline");break;case"FLASH":o.push("noflash");break;case"REVERSE":o.push("reverse");break;case"RESET":case"DEFAULT":let r=t.length;for(let a=0;a<r;a++)h.push(t[a]);t=[],o=[];break;case"BOLD":n=!0;break;case"":break;default:if(p[e].startsWith("B_")){p[e]=p[e].substr(2),n&&(h.push('<span style="border: inherit;text-decoration:inherit;color: #'+q["BOLD%^%^WHITE"]+'">'),t.push("</span>")),h.push('<span style="border: inherit;text-decoration:inherit;background-color: #'+q[p[e]]+'">'),t.push("</span>"),n=!1;continue}else if(q[p[e]]){if(n&&!q["BOLD%^%^"+p[e]])h.push('<span style="border: inherit;text-decoration:inherit;color: #'+q["BOLD%^%^WHITE"]+'">'),t.push("</span>"),s=!0;else if(n){h.push('<span style="border: inherit;text-decoration:inherit;color: #'+q["BOLD%^%^"+p[e]]+'">'),t.push("</span>"),s=!0;continue}h.push('<span style="border: inherit;text-decoration:inherit;color: #'+q[p[e]]+'">'),t.push("</span>");continue}else n&&!s&&(h.push('<span style="border: inherit;text-decoration:inherit;color: #'+q["BOLD%^%^WHITE"]+'">'),t.push("</span>"));o.length&&(h.push('<span class="'+o.join(" ")+'">'),t.push("</span>"),o=[]),h.push(p[e]),n=!1,s=!1;break}for(o.length&&(h.push('<span class="'+o.join(" ")+'">'),t.push("</span>")),e=0,i=t.length;e<i;e++)h.push(t[e]);return h.join("")}function xi(){let p,h,t,e,i,n;for(q={},q.BLACK="000000",q.RED="800000",q.GREEN="008000",q.ORANGE="808000",q.BLUE="0000EE",q.MAGENTA="800080",q.CYAN="008080",q.WHITE="BBBBBB",q.mono11="808080",q["BOLD%^%^RED"]="FF0000",q["BOLD%^%^GREEN"]="00FF00",q.YELLOW="FFFF00",q["BOLD%^%^YELLOW"]="FFFF00",q["BOLD%^%^BLUE"]="5C5CFF",q["BOLD%^%^MAGENTA"]="FF00FF",q["BOLD%^%^CYAN"]="00FFFF",q["BOLD%^%^WHITE"]="FFFFFF",q["BOLD%^%^BLACK"]="808080",t=0;t<6;t++)for(e=0;e<6;e++)for(i=0;i<6;i++)n=`RGB${t}${e}${i}`,h="",p=0,p=t*40+55,p<16&&(h+="0"),h+=p.toString(16),p=0,p=e*40+55,p<16&&(h+="0"),h+=p.toString(16),p=0,p=i*40+55,p<16&&(h+="0"),h+=p.toString(16),q[n]||(q[n]=h.toUpperCase());for(t=232;t<=255;t++)e=(t-232)*10+8,e<16?e="0"+e.toString(16).toUpperCase():e=e.toString(16).toUpperCase(),e=e+e+e,t<242?q["mono0"+(t-232)]=e:q["mono"+(t-232)]=e}function Zt(){let p=[],h,t,e,i;for(h=0;h<6;h++)for(t=0;t<6;t++)for(e=0;e<6;e++)i=16+h*36+t*6+e,p[i]="rgb(",h>0?p[i]+=h*40+55:p[i]+="0",p[i]+=",",t>0?p[i]+=t*40+55:p[i]+="0",p[i]+=",",e>0?p[i]+=e*40+55:p[i]+="0",p[i]+=")";for(h=232;h<=255;h++)t=(h-232)*10+8,p[h]=["rgb(",t,",",t,",",t,")"].join("");return p[0]="rgb(0,0,0)",p[1]="rgb(128, 0, 0)",p[2]="rgb(0, 128, 0)",p[3]="rgb(128, 128, 0)",p[4]="rgb(0, 0, 238)",p[5]="rgb(128, 0, 128)",p[6]="rgb(0, 128, 128)",p[7]="rgb(187, 187, 187)",p[8]="rgb(128, 128, 128)",p[9]="rgb(255, 0, 0)",p[10]="rgb(0, 255, 0)",p[11]="rgb(255, 255, 0)",p[12]="rgb(92, 92, 255)",p[13]="rgb(255, 0, 255)",p[14]="rgb(0, 255, 255)",p[15]="rgb(255, 255, 255)",p[256]="rgb(0, 0, 0)",p[257]="rgb(118, 0, 0)",p[258]="rgb(0, 108, 0)",p[259]="rgb(145, 136, 0)",p[260]="rgb(0, 0, 167)",p[261]="rgb(108, 0, 108)",p[262]="rgb(0, 108, 108)",p[263]="rgb(161, 161, 161)",p[264]="rgb(0, 0, 0)",p[265]="rgb(128, 0, 0)",p[266]="rgb(0, 128, 0)",p[267]="rgb(128, 128, 0)",p[268]="rgb(0, 0, 238)",p[269]="rgb(128, 0, 128)",p[270]="rgb(0, 128, 128)",p[271]="rgb(187, 187, 187)",p[272]="rgb(0,0,0)",p[273]="rgb(0, 255, 255)",p[274]="rgb(0,0,0)",p[275]="rgb(255, 255, 0)",p[276]="rgb(0, 0, 0)",p[277]="rgb(229, 229, 229)",p[278]="rgb(205, 0, 0)",p[279]="rgb(229, 229, 229)",p[280]="rgb(255,255,255)",p}function Me(p,h){return p&&(/^\d+c$/.test(p)?h?parseInt(p,10)*h+"px":p+"h":/^\d+$/.test(p)?parseInt(p,10)+"px":p)}function ke(p){return!p||p.length===0||!p.match(/^[a-zA-Z_$][a-zA-Z_$0-9]*$/g)?!1:["break","case","catch","continue","debugger","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with","class","const","enum","export","extends","import","super","implements","interface","let","package","private","protected","public","static","yield","null","true","false","NaN","Infinity","undefined","eval","arguments"].indexOf(p)===-1}function Re(p,h){if(!p)return;let t=document.activeElement;(!t||t!=p)&&p.focus(),document.execCommand("insertText",!1,h),t&&t!=p&&t.focus()}Array.isArray||(Array.isArray=function(p){return Object.prototype.toString.call(p)==="[object Array]"});var Qt;function Fe(p){return window.TextDecoder!==void 0?(Qt||(Qt=new TextDecoder)).decode(new Uint8Array(p)):ki(String.fromCharCode.apply(null,Array.prototype.slice.apply(new Uint8Array(p))))}function ki(p){var h;try{return decodeURIComponent(escape(p))}catch(t){if(h=t,h instanceof URIError)return p;throw h}}function Ei(p){var h,t,e,i,n,s;for(n=p.length,h=[],i=!1,e=s=0;0<=n?s<n:s>n;e=0<=n?++s:--s)if(t=String.prototype.charCodeAt.call(p,e),t>255){i=!0,h=null;break}else h.push(t);return i===!0?unescape(encodeURIComponent(p)):String.fromCharCode.apply(null,Array.prototype.slice.apply(h))}var Yt;function Ne(p){var h,t,e,i,n,s;if(window.TextEncoder!==void 0)return(Yt||(Yt=new TextEncoder)).encode(p);for(h=Ei(p),t=h.length,e=new ArrayBuffer(t),i=new Uint8Array(e),n=s=0;0<=t?s<t:s>t;n=0<=t?++s:--s)i[n]=String.prototype.charCodeAt.call(h,n);return i}function Ot(p){return new Promise(function(h,t){try{if(typeof navigator<"u"&&typeof navigator.clipboard<"u"&&typeof navigator.permissions<"u"){var e=new Blob([p],{type:"text/plain"}),i=[new ClipboardItem({"text/plain":e})];navigator.permissions.query({name:"clipboardWrite"}).then(function(s){s.state==="granted"||s.state==="prompt"?navigator.clipboard.write(i).then(h,t).catch(t):t(new Error("Permission not granted!"))})}else if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var n=document.createElement("textarea");n.value=p,n.textContent=p,n.style.position="fixed",n.style.width="2em",n.style.height="2em",n.style.padding="0",n.style.border="none",n.style.outline="none",n.style.boxShadow="none",n.style.background="transparent",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),document.body.removeChild(n),h(null)}catch(s){document.body.removeChild(n),t(s)}}else t(new Error("None of copying methods are supported by this browser!"))}catch(s){t(s)}})}function Dt(){return new Promise(function(p,h){try{if(typeof navigator<"u"&&typeof navigator.clipboard<"u"&&typeof navigator.permissions<"u")navigator.permissions.query({name:"clipboardRead"}).then(function(e){e.state==="granted"||e.state==="prompt"?navigator.clipboard.readText().then(p,h).catch(h):h(new Error("Permission not granted!"))});else if(document.queryCommandSupported&&document.queryCommandSupported("paste")){var t=document.createElement("textarea");t.style.position="fixed",t.style.width="2em",t.style.height="2em",t.style.padding="0",t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("paste",!1,null),p(t.value),document.body.removeChild(t)}catch(e){document.body.removeChild(t),h(e)}}else h(new Error("None of pasting methods are supported by this browser!"))}catch(e){h(e)}})}function At(p,h){if(!p)return null;h||(h=window.location.href),p=p.replace(/[[\]]/g,"\\$&");var t=new RegExp("[?&]"+p+"(=([^&#]*)|&|#|$)"),e=t.exec(h);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function _i(){var p="download"in document.createElement("a"),h=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,t=window.URL||window.webkitURL||window.mozURL||window.msURL;navigator.saveBlob=navigator.saveBlob||navigator.msSaveBlob||navigator.mozSaveBlob||navigator.webkitSaveBlob,window.saveAs=window.saveAs||window.webkitSaveAs||window.mozSaveAs||window.msSaveAs;var e={"image/jpeg":!0,"image/png":!0,"image/gif":!0,"image/svg+xml":!0,"image/bmp":!0,"image/x-windows-bmp":!0,"image/webp":!0,"audio/wav":!0,"audio/mpeg":!0,"audio/webm":!0,"audio/ogg":!0,"video/mpeg":!0,"video/webm":!0,"video/ogg":!0,"text/plain":!0,"text/html":!0,"text/xml":!0,"application/xhtml+xml":!0,"application/json":!0};h&&(window.saveAs||navigator.saveBlob)?this.show=function(i,n,s){var o=new h;o.append(i);var r=o.getBlob(s||"application/octet-stream");n||(n="Download.bin"),window.saveAs?window.saveAs(r,n):navigator.saveBlob(r,n)}:h&&t?this.show=function(i,n,s){var o,r,a=new h;if(a.append(i),s||(s="application/octet-stream"),p){o=a.getBlob(s),r=t.createObjectURL(o);var l=document.createElement("a");l.setAttribute("href",r),l.setAttribute("download",n||"Download.bin");var f=document.createEvent("MouseEvents");f.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),l.dispatchEvent(f)}else e[s.split(";")[0]]===!0&&(s="application/octet-stream"),o=a.getBlob(s),r=t.createObjectURL(o),window.open(r,"_blank","");setTimeout(function(){t.revokeObjectURL(r)},250)}:Blob&&t?this.show=function(i,n,s){var o,r;if(s||(s="application/octet-stream"),o=new Blob([i],{type:s}),p){r=t.createObjectURL(o);var a=document.createElement("a");a.setAttribute("href",r),a.setAttribute("download",n||"Download.bin");var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(l)}else e[s.split(";")[0]]===!0&&(s="application/octet-stream"),r=t.createObjectURL(o),window.open(r,"_blank","");setTimeout(function(){t.revokeObjectURL(r)},250)}:/\bMSIE\b/.test(navigator.userAgent)||(this.show=function(i,n,s){s||(s="application/octet-stream"),e[s.split(";")[0]]===!0&&(s="application/octet-stream"),window.open("data:"+s+","+encodeURIComponent(i),"_blank","")})}window.fileSaveAs=new _i;function Ci(){var p,h;function t(e,i){var n=e.charCodeAt(h);if(!(n&128))p=n;else if((n&224)==192)p=(n&31)<<6|e.charCodeAt(h+1)&63,h+=1;else if((n&240)==224)p=(n&15)<<12|(e.charCodeAt(h+1)&63)<<6|e.charCodeAt(h+2)&63,h+=2;else if((n&248)==240)p=(n&7)<<18|(e.charCodeAt(h+1)&63)<<12|(e.charCodeAt(h+2)&63)<<6|e.charCodeAt(h+3)&63,h+=1;else return!1;return!0}this.decode=function(e){var i=new xe,n=e.length;for(h=0;h<n;h++)t(e,n)&&i.appendCode(p);return i.toString()},this.decode2=function(e){var i=new xe,n=e.length,s,o;for(s=0;s<n;s++){if(o=e.charCodeAt(s),o&128)if((o&224)==192)o=(o&31)<<6|e.charCodeAt(s+1)&63,s+=1;else if((o&240)==224)o=(o&15)<<12|(e.charCodeAt(s+1)&63)<<6|e.charCodeAt(s+2)&63,s+=2;else if((o&248)==240)o=(o&7)<<18|(e.charCodeAt(s+1)&63)<<12|(e.charCodeAt(s+2)&63)<<6|e.charCodeAt(s+3)&63,s+=1;else continue;i.appendCode(o)}return i.toString()}}window.UTF8=new Ci;function Ee(p){if(p===null||typeof p>"u")return p;var h,t,e=0;for(h=p.byteLength,t=new xe;e<h;e++)p[e]<32||p[e]>=127?t.append("<"+p[e]+">"):t.append(String.fromCharCode(p[e]));return t.toString()}function Mt(){let p=document.createElement("div");p.style.visibility="hidden",p.style.overflow="scroll",p.style.msOverflowStyle="scrollbar",document.body.appendChild(p);let h=document.createElement("div");p.appendChild(h);let t=p.offsetWidth-h.offsetWidth;return p.parentNode.removeChild(p),t}function be(p,h,t){return new Promise((e,i)=>{let n=document.createElement("dialog");if(typeof n.showModal!="function"){i("Browser does not support dialogs.");return}n.id="openFileDialog",n.style.zIndex="2000",n.style.height="155px",n.style.width="350px",n.innerHTML=`<div class="dialog-header" style="font-weight: bold"><button type="button" class="btn btn-close float-end btn-danger" data-dismiss="modal" onclick="document.getElementById('openFileDialog').close();"></button><div>${p||"Open file..."}</div></div><div class="dialog-body"><div class="m-3"><input class="form-control" type="file" id="openFileDialog-files"${h?" multiple":""} required${t&&t.length?' accept="'+t+'"':""}></div></div><div class="dialog-footer"><button id="openFileDialog-cancel" style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('openFileDialog').close();">Cancel</button><button id="openFileDialog-ok" style="float: right" type="button" class="btn btn-primary">Ok</button></div>`,document.body.appendChild(n),n.addEventListener("close",s=>{s.target===n&&(document.body.removeChild(n),n.returnValue!=="file-ok"&&i("closed"))}),n.addEventListener("cancel",s=>{s.target===n&&(document.body.removeChild(n),n.returnValue!=="file-ok"&&i("canceled"))}),document.getElementById("openFileDialog-ok").addEventListener("click",()=>{let s=document.getElementById("openFileDialog-files");if(!s.files||s.files.length===0){s.classList.add("is-invalid");return}s.classList.remove("is-invalid"),n.close(),n.returnValue="files-ok",e(s.files)}),n.showModal()})}function ye(p){return new Promise((h,t)=>{p||t(new Error("Invalid file"));var e=new FileReader;e.onerror=t,e.onload=i=>{h(i.target.result)},e.readAsText(p)})}var Tt={};function Ge(p,h,t){t=t||"default",clearTimeout(Tt[t]),Tt[t]=setTimeout(()=>{p(),delete Tt[t]},h)}var ti=Vt(ei()),Ye=class extends ie{constructor(t){super();this._splitBuffer=[];this._connected=!1;this._MTTS=0;this.zStream=0;this._latencyTime=null;this._doPing=!1;this._closed=!0;this._zlib=!1;this.options={MCCP:!0,MXP:!0,NAWS:!0,MSDP:!0,GMCP:!0,MSSP:!1,ECHO:!0,TTYPE:!0,EOR:!0,NEWENVIRON:!1,ZMP:!1,ATCP:!1,CHARSET:!0};this.host="";this.port=23;this.prompt=!1;this.echo=!0;this.firstSent=!0;this.firstReceived=!0;this.server={NAWS:!1,MSDP:!1,GMCP:!1,MXP:!1,MCCP1:!1,MCCP2:!1,MSSP:!1,NEWENVIRON:!1,ZMP:!1,EOR:!1,ATCP:!1,CHARSET:!1};this.version="2.0";this.terminal="ansi";this.UTF8=!0;this.MSSP={};this.socket=null;this.latency=0;this.latencyAvg=null;this.enableLatency=!1;this.enablePing=!1;this.GMCPSupports=["Core 1","Char 1","Char.Vitals 1","Char.Experience 1"];this.enableDebug=!1;this.scheme="ws://";this.protocol="binary";t&&("host"in t&&(t.host&&t.host.length&&(this.host=t.host),delete t.host),"port"in t&&(this.port=t.port,delete t.port),"scheme"in t&&(t.scheme&&t.scheme.length&&(this.scheme=t.scheme),delete t.scheme),"protocol"in t&&(t.protocol&&t.protocol.length&&(this.protocol=t.protocol),delete t.protocol)),this.options=Object.assign(this.options,t||{})}get connected(){return!this.socket||typeof this.socket>"u"?!1:this._connected}reset(){this._MTTS=0,this.firstSent=!0,this.firstReceived=!0,this.prompt=!1,this.echo=!0,this.server={NAWS:!1,MSDP:!1,GMCP:!1,MXP:!1,MCCP1:!1,MCCP2:!1,MSSP:!1,EOR:!1,NEWENVIRON:!1,ATCP:!1,CHARSET:!1,ZMP:!1},this._splitBuffer=[],this._endMCCP(),this._connected=!1,this._closed=!1,this.enableDebug&&this.emit("debug","Reset")}connect(){this._destroySocket(),this.reset(),this.emit("connecting"),this.socket=this._createSocket(this.host,this.port),this.enableDebug&&this.emit("debug","Connecting to "+this.host+":"+this.port)}close(){this._closed||(this._destroySocket(),this.reset(),this.emit("close"),this._closed=!0,this.enableDebug&&this.emit("debug","Closed"))}receivedData(t,e,i){this.enableLatency&&(this._latencyTime!==null?(this.latency=new Date().getTime()-this._latencyTime.getTime(),this.latencyAvg==null?this.latencyAvg=this.latency:this.latencyAvg=(this.latency+this.latencyAvg)/2,this._latencyTime=null,this._doPing=!1,this.emit("latency-changed",this.latency,this.latencyAvg)):!this._doPing&&this.enablePing?this._doPing=!0:(this._latencyTime=null,this._doPing=!1)),this.enableDebug&&this.emit("debug","PreProcess:"+t,1),t=this.processData(t,e,!1,i),this.enableDebug&&this.emit("debug","PostProcess:"+t,1),this.emit("received-data",t),this.enableLatency&&(this._splitBuffer.length>0?(this.enablePing&&(this._doPing=!0),this._latencyTime=null):this._doPing&&this.enablePing?setTimeout(()=>{this._latencyTime=new Date,this.sendGMCP("Core.Ping "+this.latencyAvg)}):this._doPing=!1)}sendTerminal(){if(this.enableDebug&&(this._MTTS===0?this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>"+this.terminal+"<IAC><SE>"):this._MTTS===1?this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>ANSI-256COLOR<IAC><SE>"):this._MTTS>=2&&this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>MTTS 9<IAC><SE>")),this._MTTS===0){var t=new Uint8Array(6+this.terminal.length);t.set([255,250,24,0],0),t.set(Ne(this.terminal),4),t.set([255,240],4+this.terminal.length),this.sendData(t,!0)}else this._MTTS===1?this.sendData([255,250,24,0,65,78,83,73,45,50,53,54,67,79,76,79,82,255,240],!0):this._MTTS>=2&&this.sendData([255,250,24,0,77,84,84,83,32,57,255,240],!0)}sendData(t,e){if(!(t==null||typeof t>"u"||t.length===0)){if(this.connected)try{e||(this.prompt=!1,t=this._escapeData(t),this.enableLatency&&(this._latencyTime=new Date)),this.socket!==null&&(t instanceof Uint8Array?(this.enableDebug&&this.emit("debug","sendDataU8:"+Ee(t)),this.socket.send(t)):Array.isArray(t)?(this.enableDebug&&this.emit("debug","sendDataBA"+Ee(new Uint8Array(t))),this.socket.send(new Uint8Array(t))):(this.enableDebug&&this.emit("debug","sendDataR:"+Ee(Ne(t))),this.socket.send(t)),e||(this.firstSent=!1))}catch(i){this.emit("error",i)}else this.enableLatency&&(this._latencyTime=null);this.emit("data-sent",t,e)}}processData(t,e,i,n){let s,o="",r;if(t==null||(e||(t=this._decompressData(t)),s=t.byteLength,s===0))return t;r=this._splitBuffer,r.length>0&&(this.enableDebug&&this.emit("debug","Split buffer length: "+r.length,1),o=new Uint8Array(s+r.length),n?(o.set(t,0),o.set(r,t.byteLength)):(o.set(r,0),o.set(t,r.length)),t=o,r=[],s=t.byteLength);let a=0,l=0,f=new xe,c=this.prompt,y=0,u=0,x="",S="",m,g=0,T,I=0;o="",this.prompt=!1;let k="";try{for(;I<s;I++)switch(g=t[I],a){case 0:if(g===255)this.enableDebug&&(k="TELOP: <IAC>"),r.push(g),a=1;else if(this.UTF8||this.options.CHARSET&&this.server.CHARSET){if((g&128)===128&&I>=s-4){let H=0;if((g&192)===192?H=1:(g&224)===224?H=2:(g&240)===240&&(H=3),I+H>=s){r.push(...t.slice(I)),this.enableDebug&&(this.emit("debug","Unicode split length: "+H,1),this.emit("debug","Split buffer length: "+r.length,1));break}}f.appendCode(g)}else f.appendCode(g);break;case 1:if(g===255)this.enableDebug&&(this.emit("debug",k+"<IAC>"),k=""),f.appendCode(g),r=[],a=0;else if((!this.options.EOR||!this.server.EOR)&&g===239)this.enableDebug&&(this.emit("debug",k+"<NOP>"),k=""),r=[],a=0;else if(g===241||g===130)this.enableDebug&&(this.emit("debug",k+"<NOP>"),k=""),r=[],a=0;else if(g===249||g===239)this.enableDebug&&(g===239?this.emit("debug",k+"<EOR>"):this.emit("debug",k+"<GA>"),k=""),I+1<s&&s-I>2?(f.push(`
`),this.prompt=!1):this.prompt=!0,r=[],a=0;else if(g===253||g===254||g===251||g===252){if(this.enableDebug)switch(g){case 253:k+="<DO>";break;case 254:k+="<DONT>";break;case 251:k+="<WILL>";break;case 252:k+="<WONT>";break}r.push(g),y=g,a=2}else g===250?(this.enableDebug&&(k+="<SB>"),r.push(g),a=3):(this.enableDebug&&(k+=this._formatByte(g)),r=[],a=0);break;case 2:g===1?(this.enableDebug&&(this.emit("debug",k+"<ECHO>"),k=""),y===253?this.options.ECHO?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><ECHO>"),this.replyToOption(g,251,y),this.echo=!1):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(g,254,y)):y===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><ECHO>"),this.replyToOption(g,252,y),this.echo=!0):y===251?this.options.ECHO?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><ECHO>"),this.replyToOption(g,253,y),this.echo=!1):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(g,254,y)):y===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(g,254,y)),a=0,r=[]):g===24?(this.enableDebug&&(this.emit("debug",k+"<TERMINALTYPE>"),k=""),y===253?this.options.TTYPE?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><TERMINALTYPE>"),this.replyToOption(g,251,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(g,254,y)):y===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><TERMINALTYPE>"),this.replyToOption(g,252,y)):y===251?this.options.TTYPE?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><TERMINALTYPE>"),this.replyToOption(g,253,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(g,254,y)):y===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(g,254,y)),a=0,r=[]):g===25?(this.enableDebug&&(this.emit("debug",k+"<ENDOFRECORD>"),k=""),y===253?(this.server.EOR=!0,this.options.EOR?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><ENDOFRECORD>"),this.replyToOption(g,251,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(g,254,y))):y===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><ENDOFRECORD>"),this.replyToOption(g,252,y)):y===251?(this.server.EOR=!0,this.options.EOR?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><ENDOFRECORD>"),this.replyToOption(g,253,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(g,254,y))):y===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(g,254,y)),a=0,r=[]):g===31?(this.enableDebug&&(this.emit("debug",k+"<NAWS>"),k=""),y===253?(this.server.NAWS=!0,this.options.NAWS?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><NAWS>"),this.replyToOption(g,251,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(g,254,y))):y===254?(this.server.NAWS=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><NAWS>"),this.replyToOption(g,252,y)):y===251?(this.server.NAWS=!0,this.options.NAWS?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><NAWS>"),this.replyToOption(g,253,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(g,254,y))):y===252&&(this.server.NAWS=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(g,254,y)),this.emit("windowSize"),a=0,r=[]):g===36||g===39?(this.enableDebug&&(this.emit("debug",k+"<NEWENVIRON>"),k=""),y===253?(this.server.NEWENVIRON=!0,this.options.NEWENVIRON?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><NEWENVIRON>"),this.replyToOption(g,251,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(g,254,y))):y===254?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><NEWENVIRON>"),this.replyToOption(g,252,y)):y===251?(this.server.NEWENVIRON=!0,this.options.NEWENVIRON?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><NEWENVIRON>"),this.replyToOption(g,253,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(g,254,y))):y===252&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(g,254,y)),a=0,r=[]):g===69?(this.enableDebug&&(this.emit("debug",k+"<MSDP>"),k=""),y===253?(this.server.MSDP=!0,this.options.MSDP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSDP>"),this.replyToOption(g,251,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(g,254,y))):y===254?(this.server.MSDP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSDP>"),this.replyToOption(g,252,y)):y===251?(this.server.MSDP=!0,this.options.MSDP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSDP>"),this.replyToOption(g,253,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(g,254,y))):y===252&&(this.server.MSDP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(g,254,y)),a=0,r=[]):g===70?(this.enableDebug&&(this.emit("debug",k+"<MSSP>"),k=""),y===253?(this.server.MSSP=!0,this.options.MSSP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSSP>"),this.replyToOption(g,251,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(g,254,y))):y===254?(this.server.MSSP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSSP>"),this.replyToOption(g,252,y)):y===251?(this.server.MSSP=!0,this.options.MSSP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSSP>"),this.replyToOption(g,253,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(g,254,y))):y===252&&(this.server.MSSP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(g,254,y)),a=0,r=[]):g===85?(this.enableDebug&&(this.emit("debug",k+"<MCCP1>"),k=""),y===253?(this.server.MCCP1=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MCCP1>"),this.replyToOption(g,251,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(g,254,y))):y===254?(this.server.MCCP1=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MCCP1>"),this.replyToOption(g,252,y)):y===251?(this.server.MCCP1=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MCCP1>"),this.replyToOption(g,253,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(g,254,y))):y===252&&(this.server.MCCP1=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(g,254,y)),a=0,r=[]):g===86?(this.enableDebug&&(this.emit("debug",k+"<MCCP2>"),k=""),y===253?(this.server.MCCP2=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MCCP2>"),this.replyToOption(g,251,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(g,254,y))):y===254?(this.server.MCCP2=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MCCP2>"),this.replyToOption(g,252,y)):y===251?(this.server.MCCP2=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MCCP2>"),this.replyToOption(g,253,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(g,254,y))):y===252&&(this.server.MCCP2=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(g,254,y)),a=0,r=[]):g===91?(this.enableDebug&&(this.emit("debug",k+"<MXP>"),k=""),y===253?(this.server.MXP=!0,this.options.MXP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MXP>"),this.replyToOption(g,251,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(g,254,y))):y===254?(this.server.MXP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MXP>"),this.replyToOption(g,252,y)):y===251?(this.server.MXP=!0,this.options.MXP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MXP>"),this.replyToOption(g,253,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(g,254,y))):y===252&&(this.server.MXP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(g,254,y)),a=0,r=[]):g===130||g===241?(this.enableDebug&&(this.emit("debug",k+"<NOP>"),k=""),this._fireReceiveOption(g,y,""),r=[],a=0):g===201?(this.enableDebug&&(this.emit("debug",k+"<GMCP>"),k=""),y===253?(this.server.GMCP=!0,this.options.GMCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><GMCP>"),this.replyToOption(g,251,y),this._startGMCP()):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(g,254,y))):y===254?(this.server.GMCP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><GMCP>"),this.replyToOption(g,252,y)):y===251?(this.server.GMCP=!0,this.options.GMCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><GMCP>"),this.replyToOption(g,253,y),this._startGMCP()):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(g,254,y))):y===252&&(this.server.GMCP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(g,254,y)),a=0,r=[]):g===42?(this.enableDebug&&(this.emit("debug",k+"<CHARSET>"),k=""),y===253?(this.server.CHARSET=!0,this.options.CHARSET?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><CHARSET>"),this.replyToOption(g,251,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(g,254,y))):y===254?(this.server.CHARSET=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><CHARSET>"),this.replyToOption(g,252,y)):y===251?(this.server.CHARSET=!0,this.options.CHARSET?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><CHARSET>"),this.replyToOption(g,253,y)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(g,254,y))):y===252&&(this.server.CHARSET=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(g,254,y)),a=0,r=[]):(this.enableDebug&&(this.emit("debug",k+this._formatByte(g)),k=""),y===251||y===252?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><"+g+">"),this.replyToOption(g,254,y)):(y===254||y===253)&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><"+g+">"),this.replyToOption(g,252,y)),a=0,r=[]);break;case 3:u=g,g===24?(this.enableDebug&&(k+="<TERMINALTYPE>"),r.push(g),u=g,a=4):g===36||g===39?(this.enableDebug&&(k+="<NEWENVIRON>"),r.push(g),u=g,a=12,T=-1):g===69?(this.enableDebug&&(k+="<MSDP>"),r.push(g),u=g,a=4):g===70?(this.enableDebug&&(k+="<MSSP>"),r.push(g),u=g,a=8,m={}):g===85||g===86?(this.enableDebug&&(k+=g===85?"<MCCP1>":"<MCCP2>"),r.push(g),u=g,a=11):g===201?(this.enableDebug&&(k+="<GMCP>"),r.push(g),u=g,a=7):g===240?(this.enableDebug&&(this.emit("debug",k+"<SE>"),k=""),o=Fe(r.slice(1,r.length-4)),this._fireReceiveOption(u,250,o),o=null,a=0,r=[]):g===42?(this.enableDebug&&(k+="<CHARSET>"),r.push(g),u=g,a=17,x=""):(this.enableDebug&&(k+=this._formatByte(g)),r.push(g));break;case 4:u===24&&g===1?(this.enableDebug&&(k+="<SEND>"),r.push(g),y=1):g===240?(this.enableDebug&&(this.emit("debug",k+"<SE>"),k=""),u===24&&y===1&&(o=!1,this._fireReceiveOption(u,250,""),o||(this.sendTerminal(),this.sendTerminal(),this._MTTS++)),a=0,r=[]):u===69&&g===1?(this.enableDebug&&(k+="<MSDP_VAR>"),r.push(g),S="",a=5):(this.enableDebug&&(k+=this._formatByte(g)),r.push(g));break;case 5:g===2?(this.enableDebug&&(k+="<MSDP_VAL>"),r.push(g),x="",a=6):(this.enableDebug&&(k+=this._formatByte(g)),S+=String.fromCharCode(g),r.push(g));break;case 6:g===255?(this.enableDebug&&(k+="<IAC>"),r.push(g)):g===1?(this.enableDebug&&(k+="<MSDP_VAR>"),this._fireReceiveMSDP(S,x),x="",S="",r.push(g),a=5):g===240?(this.enableDebug&&(this.emit("debug",k+"<SE>"),k=""),o=Fe(r.slice(1,r.length-4)),this._fireReceiveOption(u,250,o),o=null,this._fireReceiveMSDP(S,x),x="",S="",a=0,r=[]):(this.enableDebug&&(k+=this._formatByte(g)),x+=String.fromCharCode(g),r.push(g));break;case 7:g===255?(this.enableDebug&&(k+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",k+"<SE>"),k=""),o=Fe(r.slice(1,r.length-4)),this._fireReceiveOption(u,250,o),o=null,this._fireReceiveGMCP(x),a=0,x="",r=[]):(this.enableDebug&&(k+=this._formatByte(g)),x+=String.fromCharCode(g),r.push(g));break;case 8:g===255?(this.enableDebug&&(k+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",k+"<SE>"),this.emit("debug",this.MSSP),k=""),o=Fe(r.slice(1,r.length-4)),this._fireReceiveOption(u,250,o),o=null,this.emit("receive-MSSP",m),x="",S="",m=0,a=0,r=[]):g===1?(this.enableDebug&&(k+="<MSSP_VAR>"),r.push(g),S="",a=9):(this.enableDebug&&(k+=this._formatByte(g)),r.push(g));break;case 9:g===255?(this.enableDebug&&(k+="<IAC>"),r.push(g),a=8):g===1?(this.enableDebug&&(k+="<MSSP_VAR>"),r.push(g),S=""):g===2?(this.enableDebug&&(k+="<MSSP_VAL>"),r.push(g),this.MSSP[S]="",m[S]="",a=10):(this.enableDebug&&(k+=this._formatByte(g)),S+=String.fromCharCode(g),r.push(g));break;case 10:g===255?(this.enableDebug&&(k+="<IAC>"),r.push(g),a=8):g===1?(this.enableDebug&&(k+="<MSSP_VAR>"),r.push(g),S="",a=9):g===2?(this.enableDebug&&(k+="<MSSP_VAL>"),r.push(g),this.MSSP[S]="",m[S]=""):(this.enableDebug&&(k+=this._formatByte(g)),this.MSSP[S]+=String.fromCharCode(g),m[S]+=String.fromCharCode(g),r.push(g));break;case 11:g===255?(this.enableDebug&&(k+="<IAC>"),r.push(g)):g===240&&(this.enableDebug&&(this.emit("debug",k+"<SE>"),k=""),this._fireReceiveOption(u,86,""),this._startMCCP(),a=0,r=[],I<s-1&&f.append(this.processData(t.subarray(I+1),e,!0)),I=s);break;case 12:g===255?(this.enableDebug&&(k+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",k+"<SE>"),k=""),o=Fe(r.slice(1,r.length-4)),this._fireReceiveOption(u,250,o),o=null,this._fireReceiveGMCP(x),a=0,x="",r=[]):g===0?(this.enableDebug&&(k+="<IS>"),r.push(g),a=13,y=g):g===1?(this.enableDebug&&(k+="<SEND>"),r.push(g),a=13,y=g):g===2?(this.enableDebug&&(k+="<SEND>"),r.push(g),a=13,y=g):(this.enableDebug&&(k+=this._formatByte(g)),x+=String.fromCharCode(g),r.push(g));break;case 13:g===0?(this.enableDebug&&(k+="<VAR>"),r.push(g),a=14,y=g,S="",T===-1&&(T=0)):g===1?(this.enableDebug&&(k+="<VALUE>"),r.push(g),a=13,y=g,T===-1&&(T=1)):g===3?(this.enableDebug&&(k+="<USERVAR>"),r.push(g),a=13,y=g):g===255?(this.enableDebug&&(k+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",k+"<SE>"),k=""),o=Fe(r.slice(1,r.length-4)),o=this._fireReceiveOption(u,250,o),this.emit("receive-NEWENVIRON",x),o||(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><NEWENVIRON><IS><IAC><SE>"),this.sendData(new Uint8Array([255,250]),!0),this.sendData(u,!0),this.sendData(new Uint8Array([0,255,240]),!0)),a=0,x="",r=[]):(this.enableDebug&&(k+=this._formatByte(g)),x+=String.fromCharCode(g),r.push(g));break;case 14:g===2?(this.enableDebug&&(k+=this._formatByte(g)),r.push(g),a=15,l=14):g===255||g<=3?(I--,a=13):(this.enableDebug&&(k+=this._formatByte(g)),S+=String.fromCharCode(g),r.push(g));break;case 15:this.enableDebug&&(k+=this._formatByte(g)),l===16?x+=String.fromCharCode(g):S+=String.fromCharCode(g),a=l,r.push(g);break;case 16:break;case 17:g===1?(this.enableDebug&&(k+="<REQUEST>"),r.push(g),a=18,x=""):g===255?(this.enableDebug&&(k+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",k+"<SE>"),k=""),o=this._fireReceiveOption(u,250,x),this.emit("receive-CHARSET",x),o||(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><CHARSET><REJECTED><IAC><SE>"),this.sendData(new Uint8Array([255,250,42,3,255,240]),!0)),a=0,x="",r=[]):(this.enableDebug&&(k+=this._formatByte(g)),x+=String.fromCharCode(g),r.push(g));break;case 18:g===255?(this.enableDebug&&(k+="<IAC>"),r.push(g)):g===240?(this.enableDebug&&(this.emit("debug",k+"<SE>"),k=""),o=this._fireReceiveOption(u,250,x),this.emit("receive-CHARSET",x.slice(1)),o||(this.options.CHARSET&&x.slice(1).toLowerCase()==="utf-8"?(this.server.CHARSET=!0,this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><ACCEPTED>UTF-8<IAC><SE>"),this.sendData(new Uint8Array([255,250,42,2]),!0),this.sendData("UTF-8",!0),this.sendData(new Uint8Array([255,240]),!0)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><CHARSET><REJECTED><IAC><SE>"),this.sendData(new Uint8Array([255,250,42,3,255,240]),!0))),a=0,x="",r=[]):(this.enableDebug&&(k+=this._formatByte(g)),x+=String.fromCharCode(g),r.push(g));break}}catch(H){this.emit("error",H)}return this.enableDebug&&(k.length>0&&this.emit("debug",k),this.emit("debug","Post Split buffer length: "+r.length,1),this.emit("debug","PostSplit buffer  "+Ee(new Uint8Array(r)),1)),c&&f.length>0?f.prepend(`
`):c&&(this.prompt=!0),f.length>0&&(this.firstReceived=!1),this._splitBuffer=r,i?f:this.UTF8||this.options.CHARSET&&this.server.CHARSET?UTF8.decode2(f.toString()):f.toString()}replyToOption(t,e,i,n){return typeof n>"u"&&(n=""),this._fireReceiveOption(t,i,n)?!1:(this.sendData(new Uint8Array([255,e,t]),!0),!0)}updateWindow(t,e){if(!(e<1||t<1||!this.connected||!this.server.NAWS))try{let i,n,s,o,r=Math.floor;i=r(t/256),i>256&&(i=255),n=t%256,s=r(e/256),s>256&&(s=255),o=e%256,this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><NAWS><"+i+"><"+n+"><"+s+"><"+o+"><IAC><SE>"),this.sendData(new Uint8Array([255,250,31,i,n,s,o,255,240]),!0)}catch(i){this.emit("error",{message:"UpdateWindow Error: "+i,err:i})}}sendGMCP(t){this.connected&&this.server.GMCP&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>"+this._escapeData(t).toString("binary")+"<IAC><SE>"),this.sendData(new Uint8Array([255,250,201]),!0),this.sendData(this._escapeData(t),!0),this.sendData(new Uint8Array([255,240]),!0))}_startGMCP(){this.server.GMCP&&(this.enableDebug&&this.emit("debug",'REPLY: <IAC><SB><GMCP>Core.Hello { "client": "'+this.terminal+'", "version": "'+this.version+'" }<IAC><SE>'),this.sendData(new Uint8Array([255,250,201]),!0),this.sendData('Core.Hello { "client": "'+this.terminal+'", "version": "'+this.version+'" }',!0),this.sendData(new Uint8Array([255,240]),!0),this.sendData(new Uint8Array([255,250,201]),!0),this.GMCPSupports.length>0?(this.GMCPSupports.indexOf("Core 1")===-1&&this.GMCPSupports.unshift("Core 1"),this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>"+JSON.stringify(this.GMCPSupports)+"<IAC><SE>"),this.sendData("Core.Supports.Set "+JSON.stringify(this.GMCPSupports))):(this.enableDebug&&this.emit("debug",'REPLY: <IAC><SB><GMCP>Core.Supports.Set [ "Core 1" ]<IAC><SE>'),this.sendData('Core.Supports.Set [ "Core 1" ]',!0)),this.sendData(new Uint8Array([255,240]),!0))}_startMCCP(){this._zlib=!0}_endMCCP(){this._zlib=!1,this.zStream=0}_decompressData(t){return this._zlib?(this.zStream||(this.zStream=new ti.Zlib.InflateStream),this.enableDebug&&this.emit("debug","Pre decompress:"+Ee(t),1),t=this.zStream.decompress(t),this.enableDebug&&this.emit("debug","Post decompress:"+Ee(t),1),new Uint8Array(t)):t}_escapeData(t){if(t==null||typeof t>"u")return t;let e,i,n=0,s,o;if(t instanceof Uint8Array){for(e=t.byteLength,i=new xe;n<e;n++)i.appendCode(t[n]),t[n]===255?i.appendCode(255):t[n]===13&&e===1?i.append(`\r
`):t[n]===10&&e===1&&i.append("\r\0");return i.toString()}for(e=t.length,i=new xe;n<e;n++)o=t.charAt(n),s=t.charCodeAt(n),i.append(o),s===255?i.append(o):s===13&&e===1?i.append(`\r
`):s===10&&e===1&&i.append("\r\0");return i.toString()}_createSocket(t,e){let i;try{let n=/^[a-z0-9]+:\/\//.test(t);return n&&e>0?i=new WebSocket(t+":"+e,this.protocol||"binary"):n?i=new WebSocket(t,this.protocol||"binary"):t&&e>0?i=new WebSocket((this.scheme||"ws://")+t+":"+e,this.protocol||"binary"):t&&(i=new WebSocket((this.scheme||"ws://")+t,this.protocol||"binary")),i.binaryType="arraybuffer",i.onclose=s=>{s.code===1006&&s.type==="close"&&!this._closed?this.close():s.code!==1e3&&!this._closed&&(this.emit("error",{message:"Closed due to transmission error",err:s}),this.close())},i.onopen=()=>{this._connected=!0,this.emit("connect")},i.onmessage=s=>{if(s.data instanceof ArrayBuffer){var o=new Uint8Array(s.data);this.enableDebug&&this.emit("debug","Data ArrayBuffer received:"+Ee(o)),this.receivedData(o)}else if(s.data instanceof Blob){var r=new FileReader;r.onloadend=()=>{var a=new Uint8Array(r.result);this.receivedData(a),this.enableDebug&&this.emit("debug","Data Blob received:"+Ee(r.result))},r.readAsArrayBuffer(s.data)}else this.enableDebug&&this.emit("debug","Data received:"+s.data),this.receivedData(s.data)},i.onerror=s=>{this._closed||this.emit("error",s)},i}catch(n){this.emit("error",n)}return null}_destroySocket(){if(!(!this.socket||this.socket==null)){try{this.socket.onopen=function(){},this.socket.onclose=function(){},this.socket.onmessage=function(){},this.socket.onerror=function(){},this.connected&&this.socket.close(),delete this.socket}catch(t){this.emit("error",t)}this.socket=null}}_fireReceiveOption(t,e,i){let n={telnet:this,option:t,verb:250,value:i,handled:!1};return this.emit("received-option",n),n.handled}_fireReceiveMSDP(t,e){let i={telnet:this,variable:t,value:e,handled:!1};return this.emit("received-MSDP",i),i.handled}_fireReceiveGMCP(t){let e={telnet:this,value:t,handled:!1};return this.emit("received-GMCP",e),e.handled}_formatByte(t){return t<32||t>=127?"<"+t+">":String.fromCharCode(t)}};window.telnet=new Ye;function Z(p,h){switch(p.toLowerCase()){case"black":return h?40:30;case"red":return h?41:31;case"green":return h?42:32;case"yellow":return h?43:33;case"blue":return h?44:34;case"magenta":return h?45:35;case"cyan":return h?46:36;case"white":return h?47:37;case"default":return h?49:39}return-1}function Ft(p){let h=-1,t=-1,e=!1;switch(p-1024>=0&&(p-=1024),p-512>=0&&(p-=512),p-256>=0&&(p-=256),p-128>=0&&(p-=128,e=!0),p-112>=0&&(p-=112,t=47),p-96>=0&&(p-=96,t=43),p-80>=0&&(p-=80,t=45),p-64>=0&&(p-=64,t=41),p-48>=0&&(p-=48,t=46),p-32>=0&&(p-=32,t=42),p-16>=0&&(p-=16,t=44),p>=8&&(p-=8,e=!0),p){case 0:h=30;break;case 1:h=34;break;case 2:h=32;break;case 3:h=36;break;case 4:h=31;break;case 5:h=35;break;case 6:h=33;break;case 7:h=37;break}return e&&h===-1?h=370:e&&(h*=10),h===-1?`,${t}`:t===-1?h.toString():`${h},${t}`}function le(p){return!p||p.length===0?!1:["indianred","lightcoral","salmon","darksalmon","lightsalmon","crimson","red","firebrick","darkred","pink","lightpink","hotpink","deeppink","mediumvioletred","palevioletred","lightsalmon","coral","tomato","orangered","darkorange","orange","gold","yellow","lightyellow","lemonchiffon","lightgoldenrodyellow","papayawhip","moccasin","peachpuff","palegoldenrod","khaki","darkkhaki","lavender","thistle","plum","violet","orchid","fuchsia","magenta","mediumorchid","mediumpurple","blueviolet","darkviolet","darkorchid","darkmagenta","purple","indigo","slateblue","darkslateblue","mediumslateblue","greenyellow","chartreuse","lawngreen","lime","limegreen","palegreen","lightgreen","mediumspringgreen","springgreen","mediumseagreen","seagreen","forestgreen","green","darkgreen","yellowgreen","olivedrab","olive","darkolivegreen","mediumaquamarine","darkseagreen","lightseagreen","darkcyan","teal","aqua","cyan","lightcyan","paleturquoise","aquamarine","turquoise","mediumturquoise","darkturquoise","cadetblue","steelblue","lightsteelblue","powderblue","lightblue","skyblue","lightskyblue","deepskyblue","dodgerblue","cornflowerblue","mediumslateblue","royalblue","blue","mediumblue","darkblue","navy","midnightblue","cornsilk","blanchedalmond","bisque","navajowhite","wheat","burlywood","tan","rosybrown","sandybrown","goldenrod","darkgoldenrod","peru","chocolate","saddlebrown","sienna","brown","maroon","white","snow","honeydew","mintcream","azure","aliceblue","ghostwhite","whitesmoke","seashell","beige","oldlace","floralwhite","ivory","antiquewhite","linen","lavenderblush","mistyrose","gainsboro","lightgrey","silver","darkgray","gray","dimgray","lightslategray","slategray","darkslategray","black"].indexOf(p.toLowerCase())!=-1}function _e(p,h){switch(p){case"errortextbackground":case"errorbackground":return-12;case"errortext":return h?-12:-11;case"infobackground":return-8;case"infotext":return h?-8:-7;case"localecho":return h?-4:-3;case"localechoback":return-4;case"reset":return 0;case"bold":return 1;case"faint":return 2;case"italic":return 3;case"underline":return 4;case"blink":return 5;case"blinkrapid":return 6;case"reverse":return 7;case"hidden":return 8;case"strikethrough":return 9;case"doubleunderline":return 21;case"boldoff":return 22;case"italicoff":return 23;case"underlineoff":return 24;case"blinkoff":return 25;case"blinkrapidoff":return 26;case"reverseoff":return 27;case"visible":return 28;case"strikethroughoff":return 29;case"black":return h?40:30;case"red":return h?41:31;case"green":return h?42:32;case"yellow":return h?43:33;case"blue":return h?44:34;case"magenta":return h?45:35;case"cyan":return h?46:36;case"white":return h?47:37;case"default":case"defaultfore":return h?49:39;case"blackbackground":return 40;case"redbackground":return 41;case"greenbackground":return 42;case"yellowbackground":return 43;case"bluebackground":return 44;case"magentabackground":return 45;case"cyanbackground":return 46;case"whitebackground":return 47;case"defaultbackground":case"defaultback":return 49;case"overline":return 53;case"subscript":return 74;case"superscript":return 73;case"subsuperoff":return 75;case"xblack":return h?100:90;case"xred":return h?101:91;case"xgreen":return h?102:92;case"xyellow":return h?103:93;case"xblue":return h?104:94;case"xmagenta":return h?105:95;case"xcyan":return h?106:96;case"xwhite":return h?107:97;case"xblackbackground":return 100;case"xredbackground":return 101;case"xgreenbackground":return 102;case"xyellowbackground":return 103;case"xbluebackground":return 104;case"xmagentabackground":return 105;case"xcyanbackground":return 106;case"xwhitebackground":return 107}return-1}var $e=class{constructor(h,t){this.width=0;this.height=0;this.width=h,this.height=t}};var W=[["bufferSize",0,2,500],["commandDelay",0,2,500],["commandDelayCount",0,2,5],["commandHistorySize",0,2,20],["fontSize",0,0,"1em",0],["cmdfontSize",0,0,"1em",0],["commandEcho",0,1,!0],["flashing",0,1,!1],["autoConnect",0,1,!0],["enableAliases",-1,1,!0],["enableTriggers",-1,1,!0],["enableMacros",-1,1,!0],["showScriptErrors",0,1,!1],["commandStacking",0,1,!0],["commandStackingChar",0,0,";",1],["htmlLog",0,1,!0],["keepLastCommand",0,1,!0],["enableMCCP",0,1,!0],["enableUTF8",0,1,!0],["font",0,5,"'Courier New', Courier, monospace",0],["cmdfont",0,5,"'Courier New', Courier, monospace",0],["aliases",-1,4],["macros",-1,4],["triggers",-1,4],["mapFollow","mapper.follow",1,!0],["mapEnabled","mapper.enabled",1,!0],["MapperSplitArea","mapper.split",1,!1],["MapperFillWalls","mapper.fill",1,!1],["MapperOpen","showMapper",1,!1],["fullScreen",-1,3,!1],["enableMXP",0,1,!0],["enableMSP",0,1,!0],["parseCommands",0,3,!0],["lagMeter",0,1,!1],["enablePing",0,1,!1],["enableEcho",0,1,!0],["enableSpeedpaths",0,1,!0],["speedpathsChar",0,0,"!",1],["parseSpeedpaths",0,1,!0],["profile",-1,0,"Default",1],["parseSingleQuotes",0,1,!1],["parseDoubleQuotes",0,1,!0],["logEnabled",0,1,!1],["logPrepend",0,1,!1],["logOffline",0,1,!1],["logUniqueOnConnect",0,1,!0],["enableURLDetection",0,1,!0],["colors",0,4],["notifyMSPPlay",0,1,!1],["CommandonClick",0,1,!0],["allowEval",0,1,!0],["allowEscape",0,1,!0],["AutoCopySelectedToClipboard",0,1,!1],["enableDebug",0,1,!1],["editorPersistent",0,1,!1],["askonclose",0,1,!0],["dev",0,1,!1],["chat.captureLines",0,1,!1],["chat.captureAllLines",0,1,!1],["chat.captureReviews",0,1,!1],["chat.captureTells",0,1,!1],["chat.captureTalk",0,1,!1],["chat.gag",0,1,!1],["chat.CaptureOnlyOpen",0,1,!1],["checkForUpdates",0,1,!1],["autoCreateCharacter",0,1,!1],["askonchildren",0,1,!0],["mapper.legend",0,1,!1],["mapper.room",0,1,!1],["mapper.importType",0,2,1],["mapper.vscroll",0,2,0],["mapper.hscroll",0,2,0],["mapper.scale",0,2,1],["mapper.alwaysOnTop",0,1,!1],["mapper.alwaysOnTopClient",0,1,!0],["mapper.memory",0,1,!1],["mapper.memorySavePeriod",0,2,9e5],["mapper.active.ID",0,0,null],["mapper.active.x",0,2,0],["mapper.active.y",0,2,0],["mapper.active.z",0,2,0],["mapper.active.area",0,0,null],["mapper.active.zone",0,2,0],["mapper.persistent",0,1,!0],["profiles.split",0,2,-1],["profiles.askoncancel",0,1,!0],["profiles.triggersAdvanced",0,1,!1],["profiles.aliasesAdvanced",0,1,!1],["profiles.buttonsAdvanced",0,1,!1],["profiles.macrosAdvanced",0,1,!1],["profiles.contextsAdvanced",0,1,!1],["profiles.codeEditor",0,1,!0],["profiles.watchFiles",0,1,!0],["chat.alwaysOnTop",0,1,!1],["chat.alwaysOnTopClient",0,1,!0],["chat.log",0,1,!1],["chat.persistent",0,1,!1],["chat.zoom",0,2,1],["chat.font",0,5,"'Courier New', Courier, monospace"],["chat.fontSize",0,0,"1em"],["title",0,0,"$t"],["logGagged",0,1,!1],["logTimeFormat",0,0,"YYYYMMDD-HHmmss"],["autoConnectDelay",0,2,600],["autoLogin",0,1,!0],["onDisconnect",0,2,2],["enableKeepAlive",0,1,!1],["keepAliveDelay",0,2,0],["newlineShortcut",0,2,1],["logWhat",0,2,1],["logErrors",0,1,!0],["showErrorsExtended",0,1,!1],["reportCrashes",0,1,!1],["enableCommands",0,1,!0],["commandChar",0,0,"#",1],["escapeChar",0,0,"\\",1],["enableVerbatim",0,1,!0],["verbatimChar",0,0,"`"],["soundPath",0,0,""],["logPath",0,0,""],["theme",0,0,""],["gamepads",0,1,!1],["buttons.connect",0,1,!0],["buttons.characters",0,1,!0],["buttons.preferences",0,1,!0],["buttons.log",0,1,!0],["buttons.clear",0,1,!0],["buttons.lock",0,1,!0],["buttons.map",0,1,!0],["buttons.user",0,1,!0],["buttons.mail",0,1,!1],["buttons.compose",0,1,!1],["buttons.immortal",0,1,!0],["buttons.codeEditor",0,1,!1],["find.case",0,1,!1],["find.word",0,1,!1],["find.reverse",0,1,!1],["find.regex",0,1,!1],["find.selection",0,1,!1],["find.show",0,1,!1],["display.split",0,1,!1],["display.splitHeight",0,2,-1],["display.splitLive",0,1,!0],["display.roundedOverlays",0,1,!0],["backupLoad",0,2,30],["backupSave",0,2,30],["backupAllProfiles",0,1,!0],["scrollLocked",0,1,!1],["showStatus",0,1,!0],["showCharacterManager",0,1,!1],["showChat",0,1,!1],["showEditor",0,1,!1],["showArmor",0,1,!1],["showStatusWeather",0,1,!0],["showStatusLimbs",0,1,!0],["showStatusHealth",0,1,!0],["showStatusExperience",0,1,!0],["showStatusPartyHealth",0,1,!0],["showStatusCombatHealth",0,1,!0],["showButtonBar",0,1,!0],["allowNegativeNumberNeeded",0,1,!1],["spellchecking",0,1,!0],["hideOnMinimize",0,1,!1],["showTrayIcon",0,1,!1],["statusExperienceNeededProgressbar",0,1,!1],["trayClick",0,2,0],["trayDblClick",0,2,0],["pasteSpecialPrefix",0,0,""],["pasteSpecialPostfix",0,0,""],["pasteSpecialReplace",0,0,""],["pasteSpecialPrefixEnabled",0,1,!0],["pasteSpecialPostfixEnabled",0,1,!0],["pasteSpecialReplaceEnabled",0,1,!0],["display.showSplitButton",0,1,!0],["chat.split",0,1,!1],["chat.splitHeight",0,2,-1],["chat.splitLive",0,1,!0],["chat.roundedOverlays",0,1,!0],["chat.showSplitButton",0,1,!0],["chat.bufferSize",0,2,500],["chat.flashing",0,1,!1],["display.hideTrailingEmptyLine",0,1,!0],["display.enableColors",0,1,!0],["display.enableBackgroundColors",0,1,!0],["enableSound",0,1,!0],["allowHalfOpen",0,1,!0],["editorClearOnSend",0,1,!0],["editorCloseOnSend",0,1,!0],["askOnCloseAll",0,1,!0],["askonloadCharacter",0,1,!0],["mapper.roomWidth",0,2,200],["mapper.roomGroups",0,2,7],["mapper.showInTaskBar",0,1,!1],["profiles.enabled",0,4,[]],["profiles.sortOrder",0,2,12],["profiles.sortDirection",0,2,1],["profiles.showInTaskBar",0,1,!1],["profiles.profileSelected",0,0,"default"],["profiles.profileExpandSelected",0,1,!0],["chat.lines",0,4,[]],["chat.showInTaskBar",0,1,!1],["chat.showTimestamp",0,1,!1],["chat.timestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["chat.tabWidth",0,2,8],["chat.displayControlCodes",0,1,!1],["chat.emulateTerminal",0,1,!1],["chat.emulateControlCodes",0,1,!0],["chat.wordWrap",0,1,!1],["chat.wrapAt",0,2,0],["chat.indent",0,2,4],["chat.scrollLocked",0,1,!1],["chat.find.case",0,1,!1],["chat.find.word",0,1,!1],["chat.find.reverse",0,1,!1],["chat.find.regex",0,1,!1],["chat.find.selection",0,1,!1],["chat.find.show",0,1,!1],["chat.find.highlight",0,1,!1],["chat.find.location",0,4,[5,20]],["codeEditor.showInTaskBar",0,1,!1],["codeEditor.persistent",0,1,!1],["codeEditor.alwaysOnTop",0,1,!1],["codeEditor.alwaysOnTopClient",0,1,!0],["autoTakeoverLogin",0,1,!1],["fixHiddenWindows",0,1,!0],["maxReconnectDelay",0,2,3600],["enableBackgroundThrottling",0,1,!0],["enableBackgroundThrottlingClients",0,1,!1],["showInTaskBar",0,1,!0],["showLagInTitle",0,1,!1],["mspMaxRetriesOnError",0,2,0],["logTimestamp",0,1,!1],["logTimestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["disableTriggerOnError",0,1,!0],["prependTriggeredLine",0,1,!0],["enableParameters",0,1,!0],["parametersChar",0,0,"%",1],["enableNParameters",0,1,!0],["nParametersChar",0,0,"$",1],["enableParsing",0,1,!0],["externalWho",0,1,!0],["externalHelp",0,1,!0],["watchForProfilesChanges",0,1,!1],["onProfileChange",0,2,0],["onProfileDeleted",0,2,0],["enableDoubleParameterEscaping",0,1,!1],["ignoreEvalUndefined",0,1,!0],["enableInlineComments",0,1,!0],["enableBlockComments",0,1,!0],["inlineCommentString",0,0,"//"],["blockCommentString",0,0,"/*"],["allowCommentsFromCommand",0,1,!1],["saveTriggerStateChanges",0,1,!0],["groupProfileSaves",0,1,!1],["groupProfileSaveDelay",0,2,2e4],["returnNewlineOnEmptyValue",0,1,!1],["pathDelay",0,2,0],["pathDelayCount",0,2,1],["echoSpeedpaths",0,1,!1],["alwaysShowTabs",0,1,!1],["scriptEngineType",0,2,4],["initializeScriptEngineOnLoad",0,1,!1],["find.highlight",0,1,!1],["find.location",0,4,[5,20]],["display.showInvalidMXPTags",0,1,!1],["display.showTimestamp",0,1,!1],["display.timestampFormat",0,0,"[[]MM-DD HH:mm:ss.SSS[]] "],["display.displayControlCodes",0,1,!1],["display.emulateTerminal",0,1,!1],["display.emulateControlCodes",0,1,!0],["display.wordWrap",0,1,!1],["display.tabWidth",0,2,8],["display.wrapAt",0,2,0],["display.indent",0,2,4],["statusWidth",0,2,-1],["showEditorInTaskBar",0,1,!0],["trayMenu",0,2,0],["lockLayout",0,1,!1],["loadLayout",0,0,""],["useSingleInstance",0,1,!0],["onSecondInstance",0,2,0],["characterManagerDblClick",0,2,0],["enableTabCompletion",1,!0],["ignoreCaseTabCompletion",0,1,!1],["tabCompletionBufferLimit",0,2,100],["enableNotifications",0,1,!0],["echo",0,2,0],["commandAutoSize",0,1,!1],["commandWordWrap",0,1,!1],["commandScrollbars",0,1,!1],["tabCompletionList",0,0,""],["tabCompletionLookupType",0,2,1],["tabCompletionReplaceCasing",0,2,0],["characterManagerAddButtonAction",0,2,0],["enableCrashReporting",0,1,!1],["characterManagerPanelWidth",0,2,0],["ignoreInputLeadingWhitespace",0,1,!1],["profiles.find.case",0,1,!1],["profiles.find.word",0,1,!1],["profiles.find.reverse",0,1,!1],["profiles.find.regex",0,1,!1],["profiles.find.selection",0,1,!1],["profiles.find.show",0,1,!1],["profiles.find.value",0,1,!1],["skipMore",0,1,!1],["skipMoreDelay",0,2,5e3],["commandMinLines",0,2,1],["backupReplaceCharacters",0,1,!0],["simpleAlarms",0,1,!1],["simpleEditor",0,1,!1]];var we=class p{constructor(){for(var h=0,t=W.length;h<t;h++)W[h][2]!==4&&(this[W[h][0]]=p.getValue(W[h][0]));this.colors=p.getValue("colors")}static{this.settingError=!1}static getValue(h,t){var e;if(p.settingError)return t===null||typeof t>"u"?p.defaultValue(h):t;try{if(e=$.jStorage.get(h),typeof e>"u"||e===null)return t===null||typeof t>"u"?p.defaultValue(h):t;switch(h){case"showChat":case"showStatus":case"showButtons":case"enableCommands":case"enableVerbatim":case"allowEscape":case"autoConnect":case"mapFollow":case"mapEnabled":case"flashing":case"commandEcho":case"enableAliases":case"enableTriggers":case"enableButtons":case"enableMacros":case"commandStacking":case"htmlLog":case"keepLastCommand":case"fullScreen":case"enableMXP":case"enableURLDetection":case"enableMCCP":case"enableUTF8":case"parseCommands":case"lagMeter":case"showScriptErrors":case"enablePing":case"enableEcho":case"enableSpeedpaths":case"parseSpeedpaths":case"MapperSplitArea":case"parseSingleQuotes":case"parseDoubleQuotes":case"logEnabled":case"logOffline":case"logPrepend":case"logUniqueOnConnect":case"toolsPinned":case"notifyMSPPlay":case"CommandonClick":case"allowEval":case"disableTriggerOnError":case"prependTriggeredLine":case"chat.captureLines":case"chat.captureAllLines":case"chat.captureReviews":case"chat.captureTells":case"chat.captureTalk":case"chat.gag":case"chat.CaptureOnlyOpen":case"simpleAlarms":case"simpleEditor":return e==1;case"colors":case"chat.lines":return e===null||typeof e>"u"||e.length===0?[]:JSON.parse(e)}return e}catch(i){return p.settingError||(alert(`Unable to save to localStorage so reverting to default,

Error description: `+i.message),p.settingError=!0),t===null||typeof t>"u"?p.defaultValue(t):t}}static setValue(h,t){switch(h){case"colors":case"chat.lines":t===null||typeof t>"u"||t.length===0?$.jStorage.deleteKey(h):$.jStorage.set(h,JSON.stringify(t));break;default:typeof t=="boolean"?t?$.jStorage.set(h,1):$.jStorage.set(h,0):$.jStorage.set(h,t);break}}static clearValue(h){$.jStorage.deleteKey(h)}static defaultValue(h){switch(h){case"bufferSize":return 500;case"commandDelay":return 500;case"commandDelayCount":return 5;case"commandHistorySize":return 20;case"fontSize":return"1em";case"cmdfontSize":return"1em";case"commandEcho":return!0;case"flashing":return!1;case"autoConnect":return!0;case"enableAliases":return!0;case"enableTriggers":return!0;case"enableMacros":return!0;case"showScriptErrors":return!1;case"commandStacking":return!0;case"commandStackingChar":return";";case"htmlLog":return!0;case"keepLastCommand":return!0;case"enableMCCP":return!0;case"enableUTF8":return!0;case"font":return"'Courier New', Courier, monospace";case"cmdfont":return"'Courier New', Courier, monospace";case"mapFollow":case"mapper.follow":return!0;case"mapEnabled":case"mapper.enabled":return!0;case"MapperSplitArea":case"mapper.split":return!1;case"MapperFillWalls":case"mapper.fill":return!1;case"MapperOpen":case"showMapper":return!1;case"fullScreen":return!1;case"enableMXP":return!0;case"enableMSP":return!0;case"parseCommands":return!0;case"lagMeter":return!1;case"enablePing":return!1;case"enableEcho":return!0;case"enableSpeedpaths":return!0;case"speedpathsChar":return"!";case"parseSpeedpaths":return!0;case"profile":return"Default";case"parseSingleQuotes":return!1;case"parseDoubleQuotes":return!0;case"logEnabled":return!1;case"logPrepend":return!1;case"logOffline":return!1;case"logUniqueOnConnect":return!0;case"enableURLDetection":return!0;case"notifyMSPPlay":return!1;case"CommandonClick":return!0;case"allowEval":return!0;case"allowEscape":return!0;case"AutoCopySelectedToClipboard":return!1;case"enableDebug":return!1;case"editorPersistent":return!1;case"askonclose":return!0;case"dev":return!1;case"chat.captureLines":return!1;case"chat.captureAllLines":return!1;case"chat.captureReviews":return!1;case"chat.captureTells":return!1;case"chat.captureTalk":return!1;case"chat.gag":return!1;case"chat.CaptureOnlyOpen":return!1;case"checkForUpdates":return!1;case"autoCreateCharacter":return!1;case"askonchildren":return!0;case"mapper.legend":return!1;case"mapper.room":return!1;case"mapper.importType":return 1;case"mapper.vscroll":return 0;case"mapper.hscroll":return 0;case"mapper.scale":return 1;case"mapper.active":return{ID:null,x:0,y:0,z:0,area:null,zone:0};case"mapper.active.ID":return null;case"mapper.active.x":return 0;case"mapper.active.y":return 0;case"mapper.active.z":return 0;case"mapper.active.area":return null;case"mapper.active.zone":return 0;case"profiles.split":return-1;case"profiles.askoncancel":return!0;case"profiles.triggersAdvanced":return!1;case"profiles.aliasesAdvanced":return!1;case"profiles.buttonsAdvanced":return!1;case"profiles.macrosAdvanced":return!1;case"profiles.contextsAdvanced":return!1;case"profiles.codeEditor":return!0;case"chat.log":return!1;case"chat.zoom":return 1;case"chat.font":return"'Courier New', Courier, monospace";case"chat.fontSize":return"1em";case"title":return"$t";case"logGagged":return!1;case"logTimeFormat":return"YYYYMMDD-HHmmss";case"autoConnectDelay":return 600;case"autoLogin":return!0;case"onDisconnect":return 2;case"enableKeepAlive":return!1;case"keepAliveDelay":return 0;case"newlineShortcut":return 1;case"logWhat":return 1;case"logErrors":return!0;case"showErrorsExtended":return!1;case"reportCrashes":return!1;case"enableCommands":return!0;case"commandChar":return"#";case"escapeChar":return"\\";case"enableVerbatim":return!0;case"verbatimChar":return"`";case"soundPath":return"";case"logPath":return"";case"theme":return"";case"gamepads":return!1;case"backupLoad":return 30;case"backupSave":return 30;case"backupAllProfiles":return!0;case"backupReplaceCharacters":return!0;case"scrollLocked":return!1;case"showStatus":return!0;case"showChat":return!1;case"showEditor":return!1;case"showArmor":return!1;case"showStatusWeather":return!0;case"showStatusLimbs":return!0;case"showStatusHealth":return!0;case"showStatusExperience":return!0;case"showStatusPartyHealth":return!0;case"showStatusCombatHealth":return!0;case"allowNegativeNumberNeeded":return!1;case"spellchecking":return!0;case"statusExperienceNeededProgressbar":return!1;case"pasteSpecialPrefix":return"";case"pasteSpecialPostfix":return"";case"pasteSpecialReplace":return"";case"pasteSpecialPrefixEnabled":return!0;case"pasteSpecialPostfixEnabled":return!0;case"pasteSpecialReplaceEnabled":return!0;case"display.showSplitButton":return!0;case"chat.bufferSize":return 500;case"chat.flashing":return!1;case"display.hideTrailingEmptyLine":return!0;case"display.enableColors":return!0;case"display.enableBackgroundColors":return!0;case"enableSound":return!0;case"editorClearOnSend":return!0;case"editorCloseOnSend":return!0;case"askOnCloseAll":return!0;case"askonloadCharacter":return!0;case"mapper.roomWidth":return 200;case"mapper.roomGroups":return 7;case"mapper.showInTaskBar":return!1;case"profiles.enabled":return[];case"profiles.sortOrder":return 12;case"profiles.sortDirection":return 1;case"profiles.profileSelected":return"default";case"profiles.profileExpandSelected":return!0;case"chat.lines":return[];case"chat.showTimestamp":return!1;case"chat.timestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"chat.tabWidth":return 8;case"chat.displayControlCodes":return!1;case"chat.emulateTerminal":return!1;case"chat.emulateControlCodes":return!0;case"chat.wordWrap":return!1;case"chat.wrapAt":return 0;case"chat.indent":return 4;case"autoTakeoverLogin":return!1;case"maxReconnectDelay":return 3600;case"showLagInTitle":return!1;case"mspMaxRetriesOnError":return 0;case"logTimestamp":return!1;case"logTimestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"disableTriggerOnError":return!0;case"prependTriggeredLine":return!0;case"enableParameters":return!0;case"parametersChar":return"%";case"enableNParameters":return!0;case"nParametersChar":return"$";case"enableParsing":return!0;case"onProfileChange":return 0;case"onProfileDeleted":return 0;case"enableDoubleParameterEscaping":return!1;case"ignoreEvalUndefined":return!0;case"enableInlineComments":return!0;case"enableBlockComments":return!0;case"inlineCommentString":return"//";case"blockCommentString":return"/*";case"allowCommentsFromCommand":return!1;case"saveTriggerStateChanges":return!0;case"groupProfileSaves":return!1;case"groupProfileSaveDelay":return 2e4;case"returnNewlineOnEmptyValue":return!1;case"pathDelay":return 0;case"pathDelayCount":return 1;case"echoSpeedpaths":return!1;case"scriptEngineType":return 4;case"initializeScriptEngineOnLoad":return!1;case"display.showInvalidMXPTags":return!1;case"display.showTimestamp":return!1;case"display.timestampFormat":return"[[]MM-DD HH:mm:ss.SSS[]] ";case"display.displayControlCodes":return!1;case"display.emulateTerminal":return!1;case"display.emulateControlCodes":return!0;case"display.wordWrap":return!1;case"display.tabWidth":return 8;case"display.wrapAt":return 0;case"display.indent":return 4;case"statusWidth":return-1;case"extensions":return{};case"warnAdvancedSettings":return!0;case"showAdvancedSettings":return!1;case"enableTabCompletion":return!0;case"ignoreCaseTabCompletion":return!1;case"tabCompletionBufferLimit":return 100;case"enableNotifications":return!0;case"echo":return 0;case"commandAutoSize":return!1;case"commandWordWrap":return!1;case"commandMinLines":return 1;case"tabCompletionLookupType":return 1;case"tabCompletionList":return"";case"tabCompletionReplaceCasing":return 0;case"ignoreInputLeadingWhitespace":return!1;case"skipMore":return!1;case"skipMoreDelay":return 5e3;case"simpleAlarms":return!1;case"simpleEditor":return!1}return null}save(){for(var h in this)this.hasOwnProperty(h)&&p.setValue(h,this[h])}reset(){for(var h=0,t=W.length;h<t;h++)W[h][2]!==4&&(this[W[h][0]]=p.defaultValue(W[h][0]));this.colors=[]}};var Ke=(r=>(r[r.Regular=0]="Regular",r[r.CommandInputRegular=1]="CommandInputRegular",r[r.Event=2]="Event",r[r.Alarm=3]="Alarm",r[r.Pattern=8]="Pattern",r[r.CommandInputPattern=16]="CommandInputPattern",r[r.Expression=64]="Expression",r[r.LoopExpression=128]="LoopExpression",r))(Ke||{});var Ze=(a=>(a[a.Skip=512]="Skip",a[a.Wait=1024]="Wait",a[a.LoopPattern=4096]="LoopPattern",a[a.LoopLines=8192]="LoopLines",a[a.Duration=16384]="Duration",a[a.WithinLines=32768]="WithinLines",a[a.Manual=65536]="Manual",a[a.ReParse=131072]="ReParse",a[a.ReParsePattern=262144]="ReParsePattern",a))(Ze||{});function Je(p){let h=[];if(p.gamepad>0)return h.push("Gamepad "+p.gamepad),p.key>0?h.push("Button "+p.key):p.gamepadAxes<0?h.push("Axis "+-p.gamepadAxes):p.gamepadAxes>0&&h.push("Axis "+p.gamepadAxes),h.length===1?"None":h.join("+");if(p.key===0)return p.name&&p.name.length>0?"None - "+p.name:"None";if((p.modifiers&4)===4&&h.push("Ctrl"),(p.modifiers&2)===2&&h.push("Alt"),(p.modifiers&8)===8&&h.push("Shift"),(p.modifiers&16)===16&&h.push("Meta"),It[p.key])h.push(It[p.key]);else return p.name&&p.name.length>0?"None - "+p.name:"None";return p.name&&p.name.length>0?h.join("+")+" - "+p.name:h.join("+")}var ue=class p{constructor(h,t){this.temp=!1;this.start=!1;this.seconds=-1;this.secondsWildcard=!0;this.hours=-1;this.hoursWildcard=!0;this.minutes=-1;this.minutesWildcard=!0;this.suspended=0;this.restart=0;typeof h=="string"&&(t=h,h=0),this.parent=h,this.pattern=t,this.startTime=Date.now(),this.prevTime=this.startTime}static parse(h,t,e){if(typeof h=="string"&&(t=h,h=0),!t||t.length===0)if(typeof h=="object")t=h.pattern;else throw new Error("Blank pattern");let i=new p(h,t);for(;t[0]==="-"||t[0]==="+";)t[0]==="-"?i.start=!0:t[0]==="+"&&(i.temp=!0),t=t.substr(1);if(t!=="*"){let n=t.split(":"),s;if(n.length===0)throw new Error("Invalid format: "+t);if(n.length===1)if(n[0]==="*")i.secondsWildcard=!0,i.seconds=-1;else{if(n[0][0]==="*"?(i.secondsWildcard=!0,n[0]=n[0].substr(1)):i.secondsWildcard=!1,s=parseInt(n[0],10),isNaN(s))throw new Error("Invalid Format: "+n[0]);if(s<0)throw new Error("Seconds must be greater than or equal to 0.");s>59&&(i.secondsWildcard=!0),i.seconds=s}else if(n.length===2){if(n[0]==="*")i.minutesWildcard=!0,i.minutes=-1;else{if(n[0][0]==="*"?(i.minutesWildcard=!0,n[0]=n[0].substr(1)):i.minutesWildcard=!1,s=parseInt(n[0],10),isNaN(s))throw new Error("Invalid Format: "+n[0]);if(s<0||s>59)throw new Error("Minutes can only be 0 to 59");i.minutes=s}if(n[1]==="*")i.secondsWildcard=!0,i.seconds=-1;else{if(n[1][0]==="*"?(i.secondsWildcard=!0,n[1]=n[1].substr(1)):i.secondsWildcard=!1,s=parseInt(n[1],10),isNaN(s))throw new Error("Invalid Format: "+n[1]);if(s<0||s>59)throw new Error("Seconds can only be 0 to 59");i.seconds=s}}else{if(n[0]==="*")i.hoursWildcard=!0,i.hours=-1;else{if(n[0][0]==="*"?(i.hoursWildcard=!0,n[0]=n[0].substr(1)):i.hoursWildcard=!1,s=parseInt(n[0],10),isNaN(s))throw new Error("Invalid Format: "+n[0]);if(s<0||s>23)throw new Error("Hours can only be 0 to 23");i.hours=s}if(n[1]==="*")i.minutesWildcard=!0,i.seconds=-1;else{if(n[1][0]==="*"?(i.minutesWildcard=!0,n[1]=n[1].substr(1)):i.minutesWildcard=!1,s=parseInt(n[1],10),isNaN(s))throw new Error("Invalid Format: "+n[1]);if(s<0||s>59)throw new Error("Minutes can only be 0 to 59");i.minutes=s}if(n[2]==="*")i.secondsWildcard=!0,i.seconds=-1;else{if(n[2][0]==="*"?(i.secondsWildcard=!0,n[2]=n[2].substr(2)):i.secondsWildcard=!1,s=parseInt(n[2],10),isNaN(s))throw new Error("Invalid Format: "+n[2]);if(s<0||s>59)throw new Error("Seconds can only be 0 to 59");i.seconds=s}}}return e&&(i.temp=!1),i}setTempTime(h){h?this.tempTime=Date.now()+h:this.tempTime=0}},Pe=class p{constructor(h,t){this.name="";this.priority=0;this.display="name";this.displaytype=0;this.value="";this.style=1;this.group="";this.enabled=!0;this.notes="";if(typeof h=="object"){let e;for(e in h)h.hasOwnProperty(e)&&(this[e]=h[e])}this.profile=t}clone(){return new p(this)}},He=class p extends Pe{constructor(t,e){super(t);this.caption="";this.icon="";this.append=!1;this.send=!0;this.chain=!1;this.stretch=!1;this.parse=!1;this.top=-1;this.left=-1;this.right=-1;this.bottom=-1;this.width=64;this.height=64;if(this.caption="NewButton",this.display="caption",typeof t=="object"){let i;for(i in t)t.hasOwnProperty(i)&&(this[i]=t[i])}this.profile=e}clone(){return new p(this)}},qe=class p extends Pe{constructor(t,e){super();this.key=0;this.append=!1;this.send=!0;this.modifiers=0;this.chain=!1;this.gamepad=0;this.gamepadAxes=0;if(this.display="return MacroDisplay(item)",this.displaytype=1,typeof t=="object"){let i;for(i in t)t.hasOwnProperty(i)&&(this[i]=t[i])}this.profile=e}clone(){return new p(this)}},ze=class p extends Pe{constructor(t,e,i){super();this.pattern="NewAlias";this.regexp=!1;this.multi=!1;this.append=!0;this.params="";if(typeof t=="string"&&(this.pattern=t),e!=null&&(this.value=e),this.display="pattern",typeof t=="object"){let n;for(n in t)t.hasOwnProperty(n)&&(this[n]=t[n])}this.profile=i}clone(){return new p(this)}},pe=class p extends Pe{constructor(t,e){super(t);this.pattern="NewTrigger";this.verbatim=!1;this.triggerNewline=!0;this.triggerPrompt=!1;this.type=0;this.temp=!1;this.caseSensitive=!1;this.raw=!1;this.state=0;this.params="";this.triggers=[];this.fired=!1;if(this.display="pattern",typeof t=="object"){let i;for(i in t)if(t.hasOwnProperty(i))if(i==="triggers"){this.triggers=[];let n=t.triggers.length;for(let s=0;s<n;s++)this.triggers.push(new p(t.triggers[s]))}else this[i]=t[i]}this.profile=e}clone(){return new p(this)}},Nt=class p extends Pe{constructor(t,e){super(t);this.caption="";this.icon="";this.append=!1;this.send=!0;this.chain=!1;this.parent="";this.items=[];this.parse=!1;if(this.caption="NewContext",this.display="caption",typeof t=="object"){let i;for(i in t)if(t.hasOwnProperty(i))if(i==="items"){let n=0,s=t[i].length;for(;n<s;n++)this.items.push(new p(t[i][n]))}else this[i]=t[i]}this.profile=e}clone(){return new p(this)}},ht=class p extends Pe{constructor(t,e){super(t);this._type="string";this.type=1;this.defaultValue="";this.useDefault=!1;this.params="";this.profile=e,this.useDefault&&this.setValue(this.defaultValue)}set setValue(t){switch(this.type){case 2:typeof t=="string"?(t=parseInt(t,10),isNaN(t)&&(t=0)):typeof t=="boolean"&&(t=t?1:0);break;case 7:typeof t=="string"?(t=parseFloat(t),isNaN(t)&&(t=0)):typeof t=="boolean"&&(t=t?1:0);break}this.value=t,this._type=typeof t}get getValue(){switch(this.type){case 1:if(typeof this.value!==this._type)switch(this._type){case"number":return Number(this.value);case"string":return this.value.toString();case"boolean":return!!this.value}return this.value;case 7:return parseFloat(this.value);case 2:return parseInt(this.value,10);case 6:if(typeof this.value=="string")try{return JSON.parse(this.value)}catch{return this.value}return this.value;case 5:return typeof this.value=="string"?at(this.value,"|"):this.value}return this.value}clone(){return new p(this)}toString(){switch(this.type){case 6:return typeof this.value=="string"?this.value:JSON.stringify(this.value);case 5:return typeof this.value=="string"?this.value:'"'+this.value.join('"|"')+'"'}return this.value?.toString()}},Se=class p{constructor(h,t){this.name="";this.file="";this.priority=0;this.enabled=!0;this.aliases=[];this.triggers=[];this.macros=[];this.buttons=[];this.contexts=[];this.enableMacros=!0;this.enableTriggers=!0;this.enableAliases=!0;this.enableButtons=!0;this.enableContexts=!0;this.enableDefaultContext=!0;typeof h=="string"?(this.name=h,this.file=h.toLowerCase(),(t==null||t)&&(this.macros=p.DefaultMacros)):typeof h=="boolean"?h&&(this.macros=p.DefaultMacros):(t==null||t)&&(this.macros=p.DefaultMacros)}static get Default(){return new p("Default")}static get DefaultMacros(){let h=[{key:97,display:"return MacroDisplay(item)",displaytype:1,value:"sw",style:1,append:!1,send:!0,name:"SouthWest",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:98,display:"return MacroDisplay(item)",displaytype:1,value:"s",style:1,append:!1,send:!0,name:"South",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:99,display:"return MacroDisplay(item)",displaytype:1,value:"se",style:1,append:!1,send:!0,name:"SouthEast",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:100,display:"return MacroDisplay(item)",displaytype:1,value:"w",style:1,append:!1,send:!0,name:"West",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:101,display:"return MacroDisplay(item)",displaytype:1,value:"l",style:1,append:!1,send:!0,name:"Look",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:102,display:"return MacroDisplay(item)",displaytype:1,value:"e",style:1,append:!1,send:!0,name:"East",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:103,display:"return MacroDisplay(item)",displaytype:1,value:"nw",style:1,append:!1,send:!0,name:"NorthWest",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:104,display:"return MacroDisplay(item)",displaytype:1,value:"n",style:1,append:!1,send:!0,name:"North",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""},{key:105,display:"return MacroDisplay(item)",displaytype:1,value:"ne",style:1,append:!1,send:!0,name:"NorthEast",group:"",enabled:!0,modifiers:0,chain:!0,priority:0,notes:""}],t=[],e=h.length;for(let i=0;i<e;i++)t.push(new qe(h[i]));return t}static load(h){let t,e;if(typeof h=="object")e=h;else return new p;t=new p(!1);let i;for(i in e)e.hasOwnProperty(i)&&(i==="aliases"||i==="triggers"||i==="macros"||i==="buttons"||i==="contexts"||i==="variables"||(t[i]=e[i]));let n,s;if(e.aliases&&e.aliases.length>0)for(s=e.aliases.length,n=0;n<s;n++)t.aliases.push(new ze(e.aliases[n],null,t));if(e.triggers&&e.triggers.length>0)for(s=e.triggers.length,n=0;n<s;n++)t.triggers.push(new pe(e.triggers[n],t));if(e.macros&&e.macros.length>0)for(s=e.macros.length,t.macros=[],n=0;n<s;n++)t.macros.push(new qe(e.macros[n],t));if(e.buttons&&e.buttons.length>0)for(s=e.buttons.length,n=0;n<s;n++)t.buttons.push(new He(e.buttons[n],t));if(e.contexts&&e.contexts.length>0)for(s=e.contexts.length,n=0;n<s;n++)t.contexts.push(new Nt(e.contexts[n],t));return t.file=t.name,t}clone(h){let t,e,i;if(h===2){if(t={name:this.name,priority:this.priority,enabled:this.enabled,aliases:[],triggers:[],macros:[],buttons:[],contexts:[],enableMacros:this.enableMacros,enableTriggers:this.enableTriggers,enableAliases:this.enableAliases,enableButtons:this.enableButtons,enableContexts:this.enableContexts,enableDefaultContext:this.enableDefaultContext},this.aliases.length>0)for(i=this.aliases.length,e=0;e<i;e++)t.aliases.push({pattern:this.aliases[e].pattern,value:this.aliases[e].value,priority:this.aliases[e].priority,regexp:this.aliases[e].regexp,style:this.aliases[e].style,multi:this.aliases[e].multi,append:this.aliases[e].append,name:this.aliases[e].name,group:this.aliases[e].group,enabled:this.aliases[e].enabled,params:this.aliases[e].params,display:this.aliases[e].display,notes:this.aliases[e].notes||""});if(this.triggers.length>0)for(i=this.triggers.length,e=0;e<i;e++){let o={pattern:this.triggers[e].pattern,value:this.triggers[e].value,priority:this.triggers[e].priority,verbatim:this.triggers[e].verbatim,style:this.triggers[e].style,name:this.triggers[e].name,group:this.triggers[e].group,enabled:this.triggers[e].enabled,display:this.triggers[e].display,triggernewline:this.triggers[e].triggerNewline,caseSensitive:this.triggers[e].caseSensitive,triggerprompt:this.triggers[e].triggerPrompt,raw:this.triggers[e].raw,type:this.triggers[e].type,notes:this.triggers[e].notes||"",state:this.triggers[e].state||0,params:this.triggers[e].params||"",triggers:[]};if(this.triggers[e].triggers&&this.triggers[e].triggers.length){let r=this.triggers[e].triggers.length;for(let a=0;a<r;a++)o.triggers.push({pattern:this.triggers[e].triggers[a].pattern,value:this.triggers[e].triggers[a].value,priority:this.triggers[e].triggers[a].priority,verbatim:this.triggers[e].triggers[a].verbatim,style:this.triggers[e].triggers[a].style,name:this.triggers[e].triggers[a].name,group:this.triggers[e].triggers[a].group,enabled:this.triggers[e].triggers[a].enabled,display:this.triggers[e].triggers[a].display,triggernewline:this.triggers[e].triggers[a].triggerNewline,caseSensitive:this.triggers[e].triggers[a].caseSensitive,triggerprompt:this.triggers[e].triggers[a].triggerPrompt,raw:this.triggers[e].triggers[a].raw,type:this.triggers[e].triggers[a].type,notes:this.triggers[e].triggers[a].notes||"",state:this.triggers[e].triggers[a].state||0,params:this.triggers[e].triggers[a].params||"",triggers:[]})}t.triggers.push(o)}if(this.macros.length>0)for(i=this.macros.length,e=0;e<i;e++)t.macros.push({key:this.macros[e].key,value:this.macros[e].value,style:this.macros[e].style,append:this.macros[e].append,send:this.macros[e].send,name:this.macros[e].name,group:this.macros[e].group,enabled:this.macros[e].enabled,display:'if(item.key === 0) return "None"; return keyCodeToChar[item.key]',displaytype:1,modifiers:this.macros[e].modifiers,chain:this.macros[e].chain,notes:this.macros[e].notes||""});if(this.buttons.length>0)for(i=this.buttons.length,e=0;e<i;e++)t.buttons.push(ge(this.buttons[e],(o,r)=>{if(o!=="profile")return r}));if(this.contexts.length>0)for(i=this.contexts.length,e=0;e<i;e++)t.contexts.push(ge(this.contexts[e],(o,r)=>{if(o!=="profile")return r}));return t}t=ge(this);let n=new p(!1),s;for(s in t)t.hasOwnProperty(s)&&(s==="aliases"||s==="triggers"||s==="macros"||s==="buttons"||s==="contexts"||s==="variables"||(n[s]=t[s]));if(t.aliases&&t.aliases.length>0)for(i=t.aliases.length,e=0;e<i;e++)n.aliases.push(new ze(t.aliases[e],null,n));if(t.triggers&&t.triggers.length>0)for(i=t.triggers.length,e=0;e<i;e++)n.triggers.push(new pe(t.triggers[e],n));if(t.macros&&t.macros.length>0)for(i=t.macros.length,n.macros=[],e=0;e<i;e++)n.macros.push(new qe(t.macros[e],n));if(t.buttons&&t.buttons.length>0)for(i=t.buttons.length,e=0;e<i;e++)n.buttons.push(new He(t.buttons[e],n));if(t.contexts&&t.contexts.length>0)for(i=t.contexts.length,e=0;e<i;e++){let o=t.contexts[e].clone();o.profile=n,n.contexts.push(o)}return n}find(h,t,e){let i;if(!h||h.length===0||!this[h]||this[h].length===0)return null;i=U(this[h]);let n=i.length;for(let s=0;s<n;s++)if(i[s][t]===e)return i[s];return null}findAny(h,t,e){let i;if(!h||h.length===0||!this[h]||this[h].length===0)return null;i=U(this[h]);let n=i.length;if(typeof t=="object"){for(let s=0;s<n;s++)for(let o in t)if(t.hasOwnProperty(o)&&i[s][o]===t[o])return i[s];return-1}for(let s=0;s<n;s++)if(i[s][t]===e)return i[s];return null}indexOfAny(h,t,e){let i;if(!h||h.length===0||!this[h]||this[h].length===0)return null;i=U(this[h]);let n=i.length;if(typeof t=="object"){for(let s=0;s<n;s++)for(let o in t)if(t.hasOwnProperty(o)&&i[s][o]===t[o])return this[h].indexOf(i[s]);return-1}for(let s=0;s<n;s++)if(i[s][t]===e)return this[h].indexOf(i[s]);return-1}indexOf(h,t,e){let i;if(!h||h.length===0||!this[h]||this[h].length===0)return null;i=U(this[h]);let n=i.length;if(typeof t=="object"){for(let s=0;s<n;s++){for(let o in t)t.hasOwnProperty(o)&&(i[s][o],t[o]);return this[h].indexOf(i[s])}return-1}for(let s=0;s<n;s++)if(i[s][t]===e)return this[h].indexOf(i[s]);return-1}},ut=class p{constructor(h){this.items={};this.keys=[];this.add(h??Se.Default)}SortByPriority(){this.keys.sort((h,t)=>{let e=this.items[h].priority,i=this.items[t].priority;return e>i?-1:e<i?1:(e=this.items[h].name,i=this.items[t].name,e==="default"?-1:i==="default"?1:e>i?-1:e<i?1:0)})}enabled(h){return!h||this.keys.length===0?!1:typeof h=="string"?this.items[h.toLowerCase()]?this.items[h.toLowerCase()].enabled:!1:this.items[h.name.toLowerCase()]?this.items[h.name.toLowerCase()].enabled:!1}contains(h){return!h||this.keys.length===0?!1:typeof h=="string"?!!this.items[h.toLowerCase()]:!!this.items[h.name.toLowerCase()]}canDisable(h){if(!h||this.keys.length===0)return!1;let t;if(typeof h=="number"){if(h<0||h>=this.keys.length)return!1;t=this.keys[h]}else if(typeof h=="object")t=h.name.toLowerCase();else if(typeof h=="string")t=h.toLowerCase();else return!1;if(!this.items[t])return!1;if(!!this.items[t].enabled){let i=!1;for(let n in this.items)if(n!==t){this.items[n].enabled&&(i=!0);break}if(!i)return!1}return!0}toggle(h){if(!h||this.keys.length===0)return!1;let t;if(typeof h=="number"){if(h<0||h>=this.keys.length)return!1;t=this.keys[h]}else if(typeof h=="object")t=h.name.toLowerCase();else if(typeof h=="string")t=h.toLowerCase();else return!1;if(!this.items[t])return!1;let e=!this.items[t].enabled;if(!e){let i=!1;for(let n in this.items)if(n!==t){this.items[n].enabled&&(i=!0);break}if(!i)return!1}return this.items[t].enabled=e,!0}update(){this.keys=Object.keys(this.items),this.SortByPriority()}add(h){h&&(this.items[h.name.toLowerCase()]=h,this.update())}remove(h){if(!(!h||this.keys.length===0)){if(typeof h=="string")delete this.items[h.toLowerCase()];else if(typeof h=="number"){if(h<0||h>=this.keys.length)return;delete this.items[this.keys[h]]}else delete this.items[h.name.toLowerCase()];this.update()}}copy(h){return h?this.keys.length===0?null:typeof h=="string"?this.items[h.toLowerCase()]?this.items[h.toLowerCase()].clone():null:typeof h=="number"?h<0||h>=this.keys.length?null:this.items[this.keys[h]].clone():h.clone():ge(this.items)}clone(h){if(h===2){let e={};for(let i in this.items)e[this.items[i].name]=this.items[i].clone(2);return e}let t=new p;for(let e in this.items)t.items[this.items[e].name]=this.items[e].clone();return t.update(),t}load(h){return new Promise((t,e)=>{localforage.getItem(h||"OoMUDProfiles").then(i=>{if(typeof i=="string"&&(i=JSON.parse(i)),!i)this.add(Se.Default);else{let n=Object.keys(i),s=0,o=n.length;for(;s<o;s++)this.add(Se.load(i[n[s]]))}t(this)}).catch(e)})}save(h){localforage.setItem(h||"OoMUDProfiles",JSON.stringify(this.items,(t,e)=>{if(t!=="profile")return e}))}get length(){return this.keys.length}count(){return this.keys.length}get active(){let h=this.keys;if(h.length===0)return this.add(Se.Default),this.items.default;if(h.length===1)return this.items[h[0]].enabled?this.items[h[0]]:this.items[h[0]].name==="Default"?(this.items[h[0]].enable=!0,this.items.default):(this.add(Se.Default),this.items.default);for(let t in h)if(this.items[t].enabled)return this.items[t];return this.items.default?(this.items.default.enabled=!0,this.items.default):(this.add(Se.Default),this.items.default)}get aliases(){let h=this.keys,t=[],e=0,i=h.length;if(i===0)return[];if(i===1)return!this.items[h[0]].enabled||!this.items[h[0]].enableAliases?[]:this.items[h[0]].aliases;for(;e<i;e++)!this.items[h[e]].enabled||!this.items[h[e]].enableAliases||this.items[h[e]].aliases.length===0||(t=t.concat(this.items[h[e]].aliases));return t}get triggers(){let h=this.keys,t=[],e=0,i=h.length;if(i===0)return[];if(i===1)return!this.items[h[0]].enabled||!this.items[h[0]].enableTriggers?[]:this.items[h[0]].triggers;for(;e<i;e++)!this.items[h[e]].enabled||!this.items[h[e]].enableTriggers||this.items[h[e]].triggers.length===0||(t=t.concat(this.items[h[e]].triggers));return t}get macros(){let h=this.keys,t=[],e=0,i=h.length;if(i===0)return[];if(i===1)return!this.items[h[0]].enabled||!this.items[h[0]].enableMacros?[]:this.items[h[0]].macros;for(;e<i;e++)!this.items[h[e]].enabled||!this.items[h[e]].enableMacros||this.items[h[e]].macros.length===0||(t=t.concat(this.items[h[e]].macros));return t}get buttons(){let h=this.keys,t=[],e=0,i=h.length;if(i===0)return[];if(i===1)return!this.items[h[0]].enabled||!this.items[h[0]].enableButtons?[]:this.items[h[0]].buttons;for(;e<i;e++)!this.items[h[e]].enabled||!this.items[h[e]].enableButtons||this.items[h[e]].buttons.length===0||(t=t.concat(this.items[h[e]].buttons));return t}get contexts(){let h=this.keys,t=[],e=0,i=h.length;if(i===0)return[];if(i===1)return!this.items[h[0]].enabled||!this.items[h[0]].enableContexts?[]:this.items[h[0]].contexts;for(;e<i;e++)!this.items[h[e]].enabled||!this.items[h[e]].enableContexts||this.items[h[e]].contexts.length===0||(t=t.concat(this.items[h[e]].contexts));return t}get defaultContext(){let h=this.keys,t=0,e=h.length;if(e===0)return!0;if(e===1)return this.items[h[0]].enabled?this.items[h[0]].enableDefaultContext:!0;for(;t<e;t++)if(this.items[h[t]].enabled&&!this.items[h[t]].enableDefaultContext)return!1;return!0}};function Ue(p,h){if(!p||!p.length)return"";let t;(C=>(C[C.None=0]="None",C[C.Ampersand=1]="Ampersand",C[C.Percent=2]="Percent",C[C.StringMatch=3]="StringMatch",C[C.SubPattern=4]="SubPattern",C[C.AmpersandPercent=5]="AmpersandPercent",C[C.AmpersandPattern=6]="AmpersandPattern",C[C.AmpersandRange=7]="AmpersandRange",C[C.PercentRegex=8]="PercentRegex",C[C.Escape=9]="Escape",C[C.Variable=10]="Variable"))(t||={});let e=0,i=[],n=0,s=p.length,o,r,a,l,f=0;for(n=0;n<s;n++)switch(o=p.charAt(n),r=p.charCodeAt(n),e){case 1:if(a.length===0&&(o==="*"||o==="?"||o==="^"||o==="$"))l=o;else if(a.length===0&&o==="%")e=5;else if(l.length===0&&o==="(")l=o,e=6;else if(l.length===0&&o==="[")l=o,e=7;else{if(o==="{")continue;if(o==="}"||!(r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||r===95||r===36)){if(!ke(a))throw new Error("Invalid variable name");!l.length&&/^\d+$/.exec(a)?i.push("{",a,"}"):l.length?i.push("(?<",a,">",Ue(l),")"):i.push("(?<",a,">.*)"),o!=="}"&&n--,e=0}else a+=o}break;case 5:l+="%"+o,e=1;break;case 6:l+=o,o===")"&&(e=1);break;case 7:l+=o,o==="]"&&(e=1);break;case 2:switch(o){case"d":i.push("\\d+"),e=0;break;case"n":i.push("[+-]?\\d+"),e=0;break;case"w":i.push("\\w"),e=0;break;case"a":i.push("[a-zA-Z0-9]*"),e=0;break;case"s":i.push("\\s*"),e=0;break;case"x":i.push("\\S*"),e=0;break;case"y":i.push("\\S*"),e=0;break;case"p":i.push(`[\\.\\?\\!\\:\\;\\-\\\u2014\\(\\)\\[\\]\\'\\"\\\\/\\,]{1}`),e=0;break;case"q":i.push(`[\\.\\?\\!\\:\\;\\-\\\u2014\\(\\)\\[\\]\\'\\"\\\\/\\,]{1}`),e=0;break;case"t":e=0;break;case"e":i.push("\x1B"),e=0;break;case"/":e=8,a="";break}break;case 8:if(o==="%"){if(!a.endsWith("/"))throw new Error("Invalid %/regex/% pattern");i.push(a.substr(0,a.length-1))}else a+=o;break;case 3:o==="^"&&a.length===0?l=!0:o==="}"?(l?i.push("[^",a,"]"):i.push(a),e=0):a+=o;break;case 4:o===":"?(i.push("(?<",a,">"),e=0):o===")"?(i.push("(",Ue(a),")"),e=0,f--):a+=o;break;case 9:i.push("\\",o),e=0;break;case 10:if(o==="{"&&a.length===0)continue;if(o==="}"||!(r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||r===95||r===36)){if(!ke(a))throw new Error("Invalid variable name");h&&(h.variables[a]instanceof ht?i.push(h.variables[a].value||""):i.push(h.variables[a]||"")),o!=="}"&&n--,e=0}else a+=o;break;default:o==="*"?i.push(".*"):o==="?"?i.push("."):o==="~"?e=9:o==="@"?(e=10,a=""):o==="&"?(a="",l="",e=1):o==="%"?e=2:o==="{"?(e=3,a=""):o==="("?(e=4,a="",f++):(o===")"&&f--,i.push(o));break}switch(e){case 1:if(!ke(a))throw new Error("Invalid variable name");!l.length&&/^\d+$/.exec(a)?i.push("{",a,"}"):l.length?i.push("(?<",a,">",Ue(l),")"):i.push("(?<",a,">.*)");break;case 5:case 6:case 7:throw new Error("Invalid &VarName pattern");case 2:throw new Error("Invalid % pattern");case 8:throw new Error("Invalid %/regex/% pattern");case 3:throw new Error("Invalid string match pattern");case 4:throw new Error("Invalid (sub:pattern) pattern");case 9:throw new Error("Invalid escape pattern");case 10:if(!ke(a))throw new Error("Invalid variable name");h&&(h.variables[a]instanceof ht?i.push(h.variables[a].getValue()||""):i.push(h.variables[a]||""));break}if(f)throw new Error("Invalid save matched pattern");return i.join("")}var et,Be,ct=["$selectedword","$selword","$selectedurl","$selurl","$selectedline","$selline","$selected","$character","$copied","$action","$trigger","$caption","$characterid"];function pt(p){return p.replace(/\w*\S*/g,h=>h.charAt(0).toUpperCase()+h.substr(1).toLowerCase())}function ii(){switch(~~(Math.random()*6)+1){case 1:case 4:return-1;case 3:case 2:return 1}return 0}var ft=class extends ie{constructor(t){super();this._historyIdx=-1;this._tabIdx=-1;this._tabWords=null;this._locked=0;this._TriggerCache=null;this._TriggerStates={};this._TriggerFunctionCache={};this._TriggerRegExCache={};this._LastTriggered="";this._LastTrigger=null;this._scrollLock=!1;this._gag=0;this._gagID=[];this._gags=[];this._stack=[];this._vStack=[];this._controllers={};this._controllersCount=0;this._gamepadCaches=null;this._lastSuspend=-1;this._MacroCache={};this._loops=[];this._pathQueue=[];this._pathTimeout=null;this._pathPaused=!1;this.client=null;this.enableParsing=!0;this.enableTriggers=!0;if(!t)throw new Error("Invalid client!");this.client=t,et=()=>Be||(this.initMathJS(),Be),this._commandHistory=[],document.addEventListener("keydown",e=>{!this.isLocked&&this.ProcessMacros(e.which,e.altKey,e.ctrlKey,e.shiftKey,e.metaKey)?(e.preventDefault(),e.stopPropagation()):e.key==="ScrollLock"&&this.toggleScrollLock()}),this.client.on("parse-command",e=>{this.client.getOption("parseCommands")&&(e.value=this.parseOutgoing(e.value,null,null,null,null,!e.comments))}),this.client.on("add-line",e=>{if(this.ExecuteTriggers(140,e.line,e.raw,e.fragment,!1,!0),this._gag>0&&!e.fragment&&(e.gagged=!0,this._gag--),!e.fragment)for(let i in this._TriggerStates)this._TriggerStates[i].lineCount&&this._TriggerStates[i].lineCount--}),this.client.on("options-loaded",()=>{!Be&&this.client.getOption("initializeScriptEngineOnLoad")&&this.initMathJS(),this.initPads()}),this.client.commandInput.addEventListener("keyup",e=>{e.key!=="Escape"&&e.key!=="ArrowUp"&&e.key!=="ArrowDown"&&(this._historyIdx=this._commandHistory.length)}),this.client.commandInput.addEventListener("keydown",e=>{switch(e.key){case"Escape":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this.client.commandInput.blur(),this.client.commandInput.value="",this.client.commandInput.select(),this._historyIdx=this._commandHistory.length,this._tabIdx=-1,this._tabWords=null,this._tabSearch=null,this.emit("history-navigate",e);break;case"ArrowUp":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this._historyIdx===this._commandHistory.length&&this.client.commandInput.value.length>0&&(this.AddCommandToHistory(this.client.commandInput.value),this.client.commandInput.value===this._commandHistory[this._historyIdx-1]&&this._historyIdx--),this._historyIdx--,this._historyIdx<0&&(this._historyIdx=0),this._commandHistory.length<0?(this._historyIdx=-1,this.client.commandInput.value=""):this._commandHistory.length>0&&this._historyIdx<this._commandHistory.length&&this._historyIdx>=0&&(this.client.commandInput.value=this._commandHistory[this._historyIdx]),setTimeout(()=>this.client.commandInput.select(),0),this.emit("history-navigate",e);break;case"ArrowDown":if(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)return;this._historyIdx===this._commandHistory.length&&this.client.commandInput.value.length>0&&this.AddCommandToHistory(this.client.commandInput.value),this._historyIdx++,this._historyIdx>=this._commandHistory.length||this._commandHistory.length<1?(this._historyIdx=this._commandHistory.length,this.client.commandInput.value=""):this._commandHistory.length>0&&this._historyIdx<this._commandHistory.length&&this._historyIdx>=0&&(this.client.commandInput.value=this._commandHistory[this._historyIdx]),setTimeout(()=>this.client.commandInput.select(),0),this.emit("history-navigate",e);break;case"Enter":switch(this.client.getOption("newlineShortcut")){case 1:if(e.ctrlKey&&!e.shiftKey&&!e.metaKey&&!e.altKey)return Re(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 8:if(e.ctrlKey&&e.shiftKey&&!e.metaKey&&!e.altKey)return Re(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 4:if((e.ctrlKey||e.shiftKey)&&!e.metaKey&&!e.altKey)return Re(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break;case 2:if(e.ctrlKey&&e.shiftKey&&!e.metaKey&&!e.altKey)return Re(this.client.commandInput,`
`),this.emit("history-navigate",e),this.client.commandInput.blur(),this.client.commandInput.focus(),!0;break}!e.ctrlKey&&!e.shiftKey&&!e.metaKey&&!e.altKey&&(this._tabIdx=-1,this._tabWords=null,this._tabSearch=null,this.client.sendCommand(null,null,this.client.getOption("allowCommentsFromCommand")),this.emit("history-navigate",e)),e.preventDefault();break;case"Tab":if(!this.client.getOption("enableTabCompletion")||this.client.commandInput.value.length===0||e.altKey||e.ctrlKey||e.metaKey)return;e.shiftKey?this._tabIdx--:this._tabIdx++;let i=this.client.commandInput.selectionStart,n=this.client.commandInput.selectionEnd;if(this._tabWords===null){let o=Kt(this.client.commandInput),r=this.client.commandInput.value.indexOf(" ",o);r===-1&&(r=this.client.commandInput.value.indexOf(`
`,o));let a=this.client.commandInput.value.lastIndexOf(" ",o-1);a===-1&&(a=this.client.commandInput.value.indexOf(`
`,o-1)),r===-1&&(r=this.client.commandInput.value.length),a===-1?a=0:a++,i=a,n=r,i===n&&n++;let l=this.client.commandInput.value.substring(a,r);if(l.length===0)return;this._tabSearch={start:a,end:r,find:l.length};let f=new RegExp(`^${l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}`,this.client.getOption("ignoreCaseTabCompletion")?"i":"");this.client.getOption("tabCompletionLookupType")===8?this._tabWords=[...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(c=>c.match(f)))]:(this._tabWords=[].concat(...this.client.display.lines.slice(this.client.display.lines.length-this.client.getOption("tabCompletionBufferLimit")).map(c=>c.text.split(/\s+/))).filter(c=>c.match(f)).reverse(),this.client.getOption("tabCompletionLookupType")===1?this._tabWords=[...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(c=>c.match(f)).reverse())].concat(this._tabWords):this.client.getOption("tabCompletionLookupType")===2&&(this._tabWords=this._tabWords.concat([...new Set(this.client.getOption("tabCompletionList").split(/\s+/).filter(c=>c.match(f)).reverse())])),this._tabWords=[...new Set(this._tabWords)])}else i-=this._tabSearch.find;if(this._tabWords.length===0)return;this._tabIdx<0&&(this._tabIdx=this._tabWords.length-1),this._tabIdx>=this._tabWords.length&&(this._tabIdx=0);let s=this.client.getOption("tabCompletionReplaceCasing");this.client.commandInput.value=this.client.commandInput.value.substring(0,i)+(s===1?this._tabWords[this._tabIdx].toLowerCase():s===2?this._tabWords[this._tabIdx].toUpperCase():this._tabWords[this._tabIdx])+this.client.commandInput.value.substring(n,this.client.commandInput.value.length),this.client.commandInput.selectionStart=this._tabSearch.start+this._tabSearch.find,this.client.commandInput.selectionEnd=this._tabSearch.start+this._tabWords[this._tabIdx].length,e.preventDefault(),this.emit("history-navigate",e);break;case"Shift":case"Control":case"Meta":case"Alt":case"CapsLock":case"Fn":case"NumLock":case"ScrollLock":case"Super":case"PageDown":case"PageUp":case"End":case"Home":case"ArrowLeft":case"ArrowRight":case"ContextMenu":break;default:this._tabIdx=-1,this._tabWords=null,this._tabSearch=null;break}}),this.client.commandInput.addEventListener("mouseup",e=>{this._tabIdx=-1,this._tabWords=null,this._tabSearch=null}),window.addEventListener("gamepadconnected",e=>{this.client.getOption("gamepads")&&(this._gamepadCaches||(this._gamepadCaches=[]),this._controllers[e.gamepad.index]={pad:e.gamepad,axes:ge(e.gamepad.axes),state:{axes:[],buttons:[]},pState:{axes:[],buttons:[]}},this._controllersCount++,this.updatePads())}),window.addEventListener("gamepaddisconnected",e=>{this.client.getOption("gamepads")&&(delete this._controllers[e.gamepad.index],this._controllersCount--)}),this.initPads()}getScope(){let t={};if(Object.assign(t,this.client.variables),ct.forEach(e=>{t[e]=window[e],t[e.substr(1)]=window[e]}),this._stack.length===0||!this.stack.named&&!this.loops.length)return t;if(this.stack.named&&Object.assign(t,this.stack.named),this.loops.length){t.repeatnum=this.repeatnum;let e=this.loops.length;for(let i=0;i<e&&i<18;i++)t[String.fromCharCode(105+i)]=this.loops[i]}return t}setScope(t){if(t===this.client.variables)return;let e=this.loops.length;for(let i in t)if(!(!Object.prototype.hasOwnProperty.call(t,i)||i==="i"||i==="repeatnum")&&!(ct.indexOf(i)!==-1||ct.indexOf("$"+i)!==-1)){switch(i){case"clientid":continue}i.length===1&&e&&i.charCodeAt(0)>=105&&i.charCodeAt(0)<105+e||this.stack.named&&Object.prototype.hasOwnProperty.call(this.stack.named,i)||(this.client.variables[i]=t[i])}}evaluate(t){let e=this.getScope(),i=et().evaluate(t,e);return this.setScope(e),i}get stack(){return this._stack.length===0&&this._stack.push({args:0,named:0,used:0,append:!1}),this._stack[this._stack.length-1]}get repeatnum(){return this.loops.length===0?0:this.loops[this.loops.length-1]}get loops(){return this._stack.length===0||!this.stack.hasOwnProperty("loops")?this._loops:this.stack.loops}get regex(){let t=this._stack.length;if(t===0)return null;for(;t>=0;)if(t--,this._stack[t].hasOwnProperty("regex"))return this._stack[t].regex;return null}get indices(){let t=this._stack.length;if(t===0)return[];for(;t>=0;)if(t--,this._stack[t].hasOwnProperty("indices"))return this._stack[t].indices;return[]}get vStack(){return this._vStack.length===0?{}:this._vStack[this._vStack.length-1]}vStackPush(t){this._vStack.push(t)}vStackPop(){this._vStack.pop()}get scrollLock(){return this._scrollLock}set scrollLock(t){t!==this._scrollLock&&(this._scrollLock=t,this.emit("scroll-lock",this.scrollLock))}get lastTriggerExecuted(){return this._LastTrigger}get lastTriggered(){return this._LastTriggered}set lastTriggered(t){this._LastTriggered=t}getDiceArguments(t,e,i){let n=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString());if(!n||n.length<3)if(n=/(\d+)\s*?d\s*?\/\s*?(100)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!n||n.length<3){if(t=t.compile().evaluate(e),n=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!n||n.length<3){if(n=/(\d+)\s*?d\s*?\/\s*?(100)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(t.toString()),!n||n.length<3)throw new Error("Invalid dice for "+(i||"dice"));n[2]="%"}}else n[2]="%";return n}initMathJS(){Be=math;let t={esc:"\x1B",cr:`
`,lf:"\r",crlf:`\r
`,diceavg:(e,i,n)=>{let s,o,r,a,l,f;if(e.length===0)throw new Error("Invalid arguments for diceavg");if(e.length===1)s=this.getDiceArguments(e[0],n,"diceavg"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length<4)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Too many arguments for diceavg");return l=1,r==="F"||r==="f"?(l=-1,f=1):r==="%"?(f=1,l=0):f=parseInt(r),a?i.evaluate((l+f)/2*o+a,n):(l+f)/2*o},dicemin:(e,i,n)=>{let s,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for dicemin");if(e.length===1)s=s=this.getDiceArguments(e[0],n,"dicemin"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length<4)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Too many arguments for dicemin");return l=1,r==="F"||r==="f"?l=-1:r==="%"&&(l=0),a?i.evaluate(l*o+a,n):l*o},dicemax:(e,i,n)=>{let s,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for dicemax");if(e.length===1)s=this.getDiceArguments(e[0],n,"dicemax"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length<4)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Too many arguments for dicemax");return r==="F"||r==="f"||r==="%"?l=1:l=parseInt(r),a?i.evaluate(l*o+a,n):l*o},dicedev:(e,i,n)=>{let s,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for dicedev");if(e.length===1)s=this.getDiceArguments(e[0],n,"dicedev"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length<4)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Too many arguments for dicedev");return r==="F"||r==="f"?l=6:r==="%"?l=1:l=parseInt(r),a?i.evaluate(Math.sqrt((l*l-1)/12*o)+a,n):Math.sqrt((l*l-1)/12*o)},zdicedev:(e,i,n)=>{let s,o,r,a,l;if(e.length===0)throw new Error("Invalid arguments for zdicedev");if(e.length===1)s=this.getDiceArguments(e[0],n,"zdicedev"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length<4)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Too many arguments for zdicedev");return r==="F"||r==="f"?l=6:r==="%"?l=1:l=parseInt(r),l--,a?i.evaluate(Math.sqrt((l*l-1)/12*o)+a,n):Math.sqrt((l*l-1)/12*o)},dice:(e,i,n)=>{let s,o,r,a;if(e.length===1)s=this.getDiceArguments(e[0],n,"dice"),o=parseInt(s[1]),r=s[2],s.length>3&&(a=s[3]);else if(e.length>1)o=e[0].compile().evaluate(n),r=e[1].toString().trim(),r!=="F"&&r!=="%"&&(r=e[1].compile().evaluate(n)),e.length>2&&(a=e[2].compile().evaluate(n));else throw new Error("Invalid arguments for dice");let l=0;for(let f=0;f<o;f++)r==="F"||r==="f"?l+=ii():r==="%"?l+=~~(Math.random()*100)+1:l+=~~(Math.random()*r)+1;return r==="%"&&(l/=100),a?i.evaluate(l+a,n):l},isdefined:(e,i,n)=>{if(e.length===1)return e[0]=this.stripQuotes(e[0].toString()),this.client.variables.hasOwnProperty(e[0])||n.has(e[0])?1:0;throw new Error("Invalid arguments for isdefined")},defined:(e,i,n)=>{let s;if(e.length===0)throw new Error("Missing arguments for defined");if(e.length===1){e[0]=this.stripQuotes(e[0],!0);let o=this.client.profiles.keys,r=0,a=o.length;if(a===0)return 0;for(;r<a;r++)if(s=U(this.client.profiles.items[o[r]].aliases),s=s.find(l=>l.pattern===e[0]),s||(s=U(this.client.profiles.items[o[r]].triggers),s=s.find(l=>l.pattern===e[0]||l.name===e[0]),s)||(s=U(this.client.profiles.items[o[r]].macros),s=s.find(l=>Je(l).toLowerCase()===e[0].toLowerCase()||l.name===e[0]),s)||(s=U(this.client.profiles.items[o[r]].aliases),s=s.find(l=>l.caption===e[0]||l.name===e[0]),s))return 1;return this.client.variables.hasOwnProperty(e[0])}else if(e.length===2){e[0]=this.stripQuotes(e[0].toString()),e[0]=this.stripQuotes(e[1].toString());let o=this.client.profiles.keys,r=0,a=o.length;if(a===0)return 0;for(;r<a;r++)switch(e[1]){case"alias":return s=U(this.client.profiles.items[o[r]].aliases),s=s.find(l=>l.pattern===e[0]),s?1:0;case"event":return s=U(this.client.profiles.items[o[r]].triggers),s=s.find(l=>l.type===2&&(l.pattern===e[0]||l.name===e[0])),s?1:0;case"trigger":return s=U(this.client.profiles.items[o[r]].triggers),s=s.find(l=>l.pattern===e[0]||l.name===e[0]),s?1:0;case"macro":return s=U(this.client.profiles.items[o[r]].macros),s=s.find(l=>Je(l).toLowerCase()===e[0].toLowerCase()||l.name===e[0]),s?1:0;case"button":return s=U(this.client.profiles.items[o[r]].aliases),s=s.find(l=>l.caption===e[0]||l.name===e[0]),s?1:0}if(e[1]==="variable")return this.client.variables.hasOwnProperty(e[0])||n.has(e[0])}else throw new Error("Too many arguments for defined");return 0},time:(e,i,n)=>{if(e.length>1)throw new Error("Too many arguments for time");return moment?e.length?moment().format(e[0].compile().evaluate(n)):moment().format():new Date().toISOString()},clip:(e,i,n)=>{if(e.length>1)throw new Error("Too many arguments for clip");if(e.length){this.client.writeClipboard(e[0].compile().evaluate(n));return}return this.client.readClipboard()},if:(e,i,n)=>{if(e.length<3)throw new Error("Missing arguments for if");if(e.length!==3)throw new Error("Too many arguments for if");return e[0].compile().evaluate(n)?e[1].compile().evaluate(n):e[2].compile().evaluate(n)},len:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for len");if(e.length!==1)throw new Error("Too many arguments for len");return e[0].compile().evaluate(n).toString().length},stripansi:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for len");if(e.length!==1)throw new Error("Too many arguments for len");let s=new RegExp("[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))","g");return e[0].compile().evaluate(n).toString().replace(s,"")},ansi:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for ansi");e=e.map(f=>_e(f.toString())===-1&&f.toString()!=="current"?f.compile().evaluate(n).toString():f.toString());let s=e.length,o=[],r={},a,l;for(a=0;a<s;a++)if(e[a].trim()==="current")o.push(e[a].trim());else{if(l=_e(e[a].trim()),l===-1)throw new Error("Invalid color or style for ansi");l>=0&&l<30?r[l]=1:o.push(e[a])}if(o.length>2)throw new Error("Too many colors for ansi");if(o.length>1&&(o[1]==="current"?o[1]="":o[1]=_e(o[1],!0)),o.length>0&&(r[1]&&o[0]==="white"||o[0]==="current"?o[0]="":o[0]=_e(o[0])),r=[...Object.keys(r),...o],!r.length)throw new Error("Invalid colors or styles for ansi");return r=r.filter(f=>f!==""),`\x1B[${r.join(";")}m`},color:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for color");e=e.map(r=>_e(r.toString())===-1&&r.toString()!=="current"?r.compile().evaluate(n).toString():r.toString());let s,o;if(e.length===1){if(e[0]==="bold")return"370";if(s=Z(e[0]),s===-1)throw new Error("Invalid fore color");return s.toString()}else if(e.length===2){if(e[0]==="bold")s=370;else{if(s=Z(e[0]),s===-1)throw new Error("Invalid fore color");if(e[1]==="bold")return(s*10).toString()}if(o=s.toString(),s=Z(e[1],!0),s===-1)throw new Error("Invalid back color");return o+","+s.toString()}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[2]!=="bold")throw new Error("Only bold is supported as third argument for color");if(s=Z(e[0]),s===-1)throw new Error("Invalid fore color");if(o=(s*10).toString(),s=Z(e[1],!0),s===-1)throw new Error("Invalid back color");return o+","+s.toString()}throw new Error("Too many arguments")},zcolor:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for zcolor");if(e.length>1)throw new Error("Too many arguments for zcolor");return Ft(parseInt(e[0].compile().evaluate(n),10))},case:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for case");let s=e[0].compile().evaluate(n);return s>0&&s<e.length?e[s].compile().evaluate(n):null},switch:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for switch");if(e.length%2===1)throw new Error("All expressions must have a value for switch");let s=e.length;for(let o=0;o<s;o+=2)if(e[o].compile().evaluate(n))return e[o+1].compile().evaluate(n);return null},ascii:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for ascii");if(e.length>1)throw new Error("Too many arguments for ascii");if(e[0].toString().trim().length===0)throw new Error("Invalid argument, empty string for ascii");return e[0].toString().trim().charCodeAt(0)},char:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for char");if(e.length>1)throw new Error("Too many arguments for char");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for char");return String.fromCharCode(s)},bitand:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitand");if(e.length!==2)throw new Error("Too many arguments for bitand");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitand");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitand");return s&o},bitnot:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitnot");if(e.length!==1)throw new Error("Too many arguments for bitnot");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitnot");return~s},bitor:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitor");if(e.length!==2)throw new Error("Too many arguments for bitor");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitor");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitor");return s|o},bitset:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitset");if(e.length>3)throw new Error("Too many arguments for bitset");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitset");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitset");o--;let r=1;if(e.length===3&&(r=e[2].compile().evaluate(n),isNaN(r)))throw new Error("Invalid argument '"+e[2].toString()+"' must be a number for bitset");return s&~(1<<o)|(r?1:0)<<o},bitshift:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitshift");if(e.length!==2)throw new Error("Too many arguments for bitshift");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitshift");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitshift");return o<0?s>>-o:s<<o},bittest:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bittest");if(e.length!==2)throw new Error("Too many arguments for bittest");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bittest");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bittest");return o--,(s>>o)%2!=0?1:0},bitxor:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for bitxor");if(e.length!==2)throw new Error("Too many arguments for bitxor");let s=e[0].compile().evaluate(n);if(isNaN(s))throw new Error("Invalid argument '"+e[0].toString()+"' must be a number for bitxor");let o=e[1].compile().evaluate(n);if(isNaN(o))throw new Error("Invalid argument '"+e[1].toString()+"' must be a number for bitxor");return s^o},tonumber:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for number");if(e.length>1)throw new Error("Too many arguments for number");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)?parseInt(e[0],10):e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(e[0]):e[0]==="true"?1:(e[0]==="false",0)},isfloat:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for isfloat");if(e.length>1)throw new Error("Too many arguments for isfloat");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0},isnumber:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for isnumber");if(e.length>1)throw new Error("Too many arguments for isnumber");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)||e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0},tostring:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for string");if(e.length>1)throw new Error("Too many arguments for string");return e[0].compile().evaluate(n).toString()},float:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for float");if(e.length>1)throw new Error("Too many arguments for float");return e[0]=e[0].compile().evaluate(n).toString(),e[0].match(/^\s*?[-|+]?\d+\s*?$/)||e[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(e[0]):e[0]==="true"?1:(e[0]==="false",0)},trim:(e,i,n)=>{if(e.length!==1)throw new Error("Missing arguments for trim");return e[0].compile().evaluate(n).toString().trim()},trimleft:(e,i,n)=>{if(e.length!==1)throw new Error("Missing arguments for trimleft");return e[0].compile().evaluate(n).toString().trimLeft()},trimright:(e,i,n)=>{if(e.length!==1)throw new Error("Missing arguments for trimright");return e[0].compile().evaluate(n).toString().trimRight()},pos:(e,i,n)=>{if(e.length<2)throw new Error("Missing arguments for pos");if(e.length>2)throw new Error("Too many arguments for pos");return e[0]=e[0].compile().evaluate(n).toString(),e[1]=e[1].compile().evaluate(n).toString(),e[1].indexOf(e[0])+1},ipos:(e,i,n)=>{if(e.length<2)throw new Error("Missing arguments for pos");if(e.length>2)throw new Error("Too many arguments for pos");return e[0]=e[0].compile().evaluate(n).toString().toLowerCase(),e[1]=e[1].compile().evaluate(n).toString().toLowerCase(),e[1].indexOf(e[0])+1},ends:(e,i,n)=>{if(e.length<2)throw new Error("Missing arguments for ends");if(e.length>2)throw new Error("Too many arguments for ends");return e[0]=e[0].compile().evaluate(n).toString().toLowerCase(),e[1]=e[1].compile().evaluate(n).toString().toLowerCase(),e[0].endsWith(e[1])},begins:(e,i,n)=>{if(e.length<2)throw new Error("Missing arguments for begins");if(e.length>2)throw new Error("Too many arguments for begins");return e[0]=e[0].compile().evaluate(n).toString().toLowerCase(),e[1]=e[1].compile().evaluate(n).toString().toLowerCase(),e[0].startsWith(e[1])},alarm:(e,i,n)=>{let s,o,r,a,l;switch(e.length){case 0:throw new Error("Missing arguments for alarm");case 1:if(e[0]=e[0].compile().evaluate(n).toString(),s=this.client.alarms,r=s.length,r===0)throw new Error("No alarms set.");for(o=0;o<r;o++)if(s[o].type===3&&(s[o].name===e[0]||s[o].pattern===e[0]))return s[o].suspended?0:this.client.getRemainingAlarmTime(o);return;case 2:if(a=e[1].compile().evaluate(n),e[0]=e[0].compile().evaluate(n).toString(),s=this.client.alarms,r=s.length,r===0)throw new Error("No alarms set.");if(o=0,typeof a=="string"){for(;o<r;o++)if(s[o].type===3&&(s[o].name===e[0]||s[o].pattern===e[0])){if(s[o].profile.name.toUpperCase()!==a.toUpperCase())continue;return s[o].suspended?0:this.client.getRemainingAlarmTime(o)}throw new Error("Alarm not found in profile: "+a+".")}else{for(;o<r;o++)if(s[o].type===3&&(s[o].name===e[0]||s[o].pattern===e[0]))return s[o].suspended||this.client.setAlarmTempTime(o,a),a;throw new Error("Alarm not found.")}case 3:if(a=e[1].compile().evaluate(n),e[0]=e[0].compile().evaluate(n).toString(),l=e[2].compile().evaluate(n).toString(),s=this.client.alarms,r=s.length,r===0)throw new Error("No alarms set.");for(o=0;o<r;o++)if(s[o].type===3&&(s[o].name===e[0]||s[o].pattern===e[0])){if(s[o].profile.name.toUpperCase()!==l.toUpperCase())continue;return s[o].suspended||this.client.setAlarmTempTime(o,a),a}throw Error("Could not set time, alarm not found in profile: "+e[2]+".")}throw new Error("Too many arguments for alarm")},state:(e,i,n)=>{let s;if(e.length===0)throw new Error("Missing arguments for state");if(e.length>2)throw new Error("Too many arguments for state");if(e[0]=e[0].compile().evaluate(n).toString(),e.length===1){let o=this.client.profiles.keys,r=0,a=o.length;if(a===0)return null;if(a===1){if(!this.client.profiles.items[o[0]].enabled||!this.client.profiles.items[o[0]].enableTriggers)throw Error("No enabled profiles found!");s=U(this.client.profiles.items[o[r]].triggers),s=s.find(l=>l.name===e[0]||l.pattern===e[0])}else for(;r<a&&!(!(!this.client.profiles.items[o[r]].enabled||!this.client.profiles.items[o[r]].enableTriggers||this.client.profiles.items[o[r]].triggers.length===0)&&(s=U(this.client.profiles.items[o[r]].triggers),s=s.find(l=>l.name===e[0]||l.pattern===e[0]),s));r++);}else if(e.length===2){e[1]=e[1].compile().evaluate(n);let o;if(this.client.profiles.contains(e[1]))o=this.client.profiles.items[e[1].toLowerCase()];else throw new Error("Profile not found: "+e[1]);s=U(o.triggers),s=s.find(r=>r.name===e[0]||r.pattern===e[0])}if(s)return s.triggers&&s.triggers.length?s.state:0;throw new Error("Trigger not found")},isnull:(e,i,n)=>{if(e.length===0)return null;if(e.length!==1)throw new Error("Too many arguments for null");return e[0].compile().evaluate(n)?1:0},escape:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for unescape");if(e.length!==1)throw new Error("Too many arguments for unescape");let s;if(e[0]=e[0].compile().evaluate(n).toString(),this.client.getOption("allowEscape")){let o=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";return s=o,o==="\\"&&(s+=o),this.client.getOption("parseDoubleQuotes")&&(s+='"'),this.client.getOption("parseSingleQuotes")&&(s+="'"),this.client.getOption("commandStacking")&&(s+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(s+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(s+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(s+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(s+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(s+=this.client.getOption("nParametersChar")),e.replace(new RegExp(`[${s}]`,"g"),o+"$&")}return e.replace(/[\\"']/g,"$&")},unescape:(e,i,n)=>{if(e.length===0)throw new Error("Missing arguments for unescape");if(e.length!==1)throw new Error("Too many arguments for unescape");let s;if(e[0]=e[0].compile().evaluate(n).toString(),this.client.getOption("allowEscape")){let o=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";return s=o,o==="\\"&&(s+=o),this.client.getOption("parseDoubleQuotes")&&(s+='"'),this.client.getOption("parseSingleQuotes")&&(s+="'"),this.client.getOption("commandStacking")&&(s+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(s+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(s+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(s+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(s+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(s+=this.client.getOption("nParametersChar")),o==="\\"?e[0].replace(new RegExp(`\\\\[${s}]`,"g"),r=>r.substr(1)):e[0].replace(new RegExp(`${o}[${s}]`,"g"),r=>r.substr(1))}return e[0].replace(/\\[\\"']/g,o=>o.substr(1))},prompt:(e,i,n)=>{if(e.length>3)throw new Error("Too many arguments");return e.length===0?window.prompt():(e=e.map(s=>s.compile().evaluate(n).toString()),window.prompt(...e))}};for(let e in t)!t.hasOwnProperty(e)||typeof t[e]!="function"||(t[e].rawArgs=!0);Be.import(t,{})}resetExpressionEngine(){Be&&(Be=void 0)}async initPads(){if(!this.client||!this.client.options){setTimeout(this.initPads,5);return}if(this._controllers=[],this._controllersCount=0,this._gamepadCaches=null,!this.client.getOption("gamepads"))return;let t=navigator.getGamepads(),e=0,i=t.length;for(;e<i;e++)t[e]&&(this._controllers[t[e].index]={pad:t[e],axes:ge(t[e].axes),state:{axes:[],buttons:[]},pState:{axes:[],buttons:[]}},this._controllersCount++);this.updatePads()}updatePads(){if(this._controllersCount===0||!this.client.getOption("gamepads"))return;let t=navigator.getGamepads(),e=0,i=t.length;for(!this._gamepadCaches&&i>0&&(this._gamepadCaches=[]);e<i;e++){let n=t[e];if(!n||!this._controllers[n.index])continue;let s=this._controllers[n.index].state,o=this._controllers[n.index].axes,r=n.buttons.length,a,l;this._gamepadCaches[e]||(this._gamepadCaches[e]=We(this.client.macros,"gamepad",e+1)),l=this._gamepadCaches[e];let f=0,c=l.length;if(c===0)continue;for(a=0;a<r;a++){let x=n.buttons[a],S;if(typeof x=="object"?(S=x.pressed,x=x.value):S=x>=.5,s.buttons[a]){if(s.buttons[a].pressed!==S&&(s.buttons[a].pressed=S,!S)){for(;f<c;f++)if(l[f].enabled&&l[f].key===a+1&&this.ExecuteMacro(l[f])){(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()});return}}}else s.buttons[a]={pct:Math.round(x*100),pressed:S}}let y=n.axes.length,u=0;for(a=0;a<y;a++)if(s.axes[a]!==n.axes[a]&&n.axes[a]!==o[a]&&(s.axes[a]=n.axes[a]),s.axes[a]<-.75?u=-(a+1):s.axes[a]>.75&&(u=a+1),u!==0){for(;f<c;f++)if(l[f].enabled&&l[f].gamepadAxes===a+1&&this.ExecuteMacro(l[f])){(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()});return}}}(this._controllersCount>0||t.length>0)&&requestAnimationFrame(()=>{this.updatePads()})}adjustLastLine(t,e){return!this.client.display.lines||this.client.display.lines.length===0?0:(e?t===this.client.display.lines.length?(t--,this.client.display.lines[t].text.length===0&&this.client.display.lines[t].raw.length&&t--):t===this.client.display.lines.length-1&&this.client.display.lines[t].text.length===0&&this.client.display.lines[t].raw.length&&t--:t===this.client.display.lines.length?(t--,this.client.display.lines[t].text.length===0&&t--):t===this.client.display.lines.length-1&&this.client.display.lines[t].text.length===0&&t--,t)}get isLocked(){return this._locked!==0}addLock(){this._locked++}removeLock(){this._locked--}AddCommandToHistory(t){(this._commandHistory.length<1||this._commandHistory[this._commandHistory.length-1]!==t)&&t.length>0&&(this._commandHistory.length>=this.client.getOption("commandHistorySize")&&this._commandHistory.shift(),this._commandHistory.push(t),this.emit("command-history-changed",this._commandHistory))}clearCommandHistory(){this._commandHistory=[],this._historyIdx=-1,this.emit("command-history-changed",this._commandHistory)}setHistoryIndex(t){t<0||this._commandHistory.length===0?this._historyIdx=-1:t>=this._commandHistory.length?this._historyIdx=this._commandHistory.length-1:this._historyIdx=t}get commandHistory(){return this._commandHistory}executeScript(t){if(t==null)return t;let e=0,i=0,n,s=t.length,o="",r=[],a="",l,f=0,c=this.client.getOption("parseDoubleQuotes"),y=this.client.getOption("parseSingleQuotes"),u=this.client.getOption("commandChar");for(;i<s;i++)switch(n=t.charAt(i),e){case 1:n===" "?(e=2,l+=n):(o+=n,l+=n);break;case 2:n==="{"?(e=7,a+=n):n==="("?(e=8,a+=n):n===" "?(r.push(a),a=""):(n==='"'&&c?e=3:n==="'"&&y&&(e=4),a+=n),l+=n;break;case 3:n==='"'&&(e=2),a+=n,l+=n;break;case 4:n==="'"&&(e=2),a+=n,l+=n;break;case 7:a+=n,n==="}"?f===0?e=2:f--:n==="{"&&f++,l+=n;break;case 8:a+=n,n===")"?f===0?e=2:f--:n==="("&&f++,l+=n;break;default:if(i===0&&n===u)e=1,o="",r=[],a="",l=n;else return t;break}return o.length>0?(a.endsWith(`
`)&&(a=a.substring(0,a.length-1)),a.length>0&&r.push(a),this.executeFunction(o,r,l,u)):t}executeFunction(t,e,i,n){let s,o=!1,r,a,l,f,c=null,y=null,u,x,S,m,g,T,I;switch(t.toLowerCase()){case"unaction":case"untrigger":case"unt":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),c=null,y=null,S=!0,e.length<1||e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"unt\x1B[0;-11;-12mrigger {pattern|name} \x1B[3mprofile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid name or pattern");if(e[0].match(/^\{.*\}$/g)?e[0]=this.parseInline(e[0].substr(1,e[0].length-2)):e[0]=this.parseInline(this.stripQuotes(e[0])),e.length===2&&(c=this.stripQuotes(e[2]),c=this.parseInline(c)),!c||c.length===0){let b=this.client.profiles.keys,d=0,v=b.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[b[0]].enabled||!this.client.profiles.items[b[0]].enableTriggers)throw Error("No enabled profiles found!");u=this.client.profiles.items[b[d]].findAny("triggers",{name:e[0],pattern:e[0]})}else for(;d<v;d++)if(!(!this.client.profiles.items[b[d]].enabled||!this.client.profiles.items[b[d]].enableTriggers||this.client.profiles.items[b[d]].triggers.length===0)&&(u=this.client.profiles.items[b[d]].findAny("triggers",{name:e[0],pattern:e[0]}),u)){c=this.client.profiles.items[b[d]];break}if(!u)throw new Error("Trigger '"+e[0]+"' not found in '"+c.name+"'!");this.client.removeTrigger(u),this.client.echo("Trigger '"+e[0]+"' removed from '"+c.name+"'.",-7,-8,!0,!0)}else if(c=this.parseInline(c),this.client.profiles.contains(c)){if(c=this.client.profiles.items[c.toLowerCase()],u=c.findAny("triggers",{name:e[0],pattern:e[0]}),!u)throw new Error("Trigger '"+e[0]+"' not found in '"+c.name+"'!");this.client.removeTrigger(u),this.client.echo("Trigger '"+e[0]+"' removed from '"+c.name+"'.",-7,-8,!0,!0)}else throw new Error("Profile not found: "+c);return null;case"suspend":case"sus":switch((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length){case 0:return f=this.client.alarms,f.length===0?this.client.echo("No alarms defined.",-7,-8,!0,!0):(this.client.setAlarmState(0,!1),this._lastSuspend=0,this.client.echo("Last alarm suspended.",-7,-8,!0,!0)),null;case 1:r=this.parseInline(this.stripQuotes(e[0])),f=this.client.alarms,a=f.length;for(let b=f.length-1;b>=0;b--)if(f[b].name===r||f[b].pattern===r){this.client.setAlarmState(b,!1),this.client.echo("Alarm '"+r+"' suspended.",-7,-8,!0,!0),this._lastSuspend=b;break}return null;default:throw new Error("Invalid syntax use \x1B[4m"+n+"sus\x1B[0;-11;-12mpend id \x1B[3mprofile\x1B[0;-11;-12m or \x1B[4m"+n+"sus\x1B[0;-11;-12mpend")}case"resume":case"resu":switch((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length){case 0:return this._lastSuspend===-1||(this.client.setAlarmState(this._lastSuspend,!0),this.client.echo("Last alarm suspended resumed.",-7,-8,!0,!0),this._lastSuspend=-1),null;case 1:r=this.parseInline(this.stripQuotes(e[0])),f=this.client.alarms,a=f.length;for(let b=a-1;b>=0;b--)if(f[b].name===r||f[b].pattern===r){this.client.setAlarmState(b,!0),this.client.echo("Alarm '"+r+"' resumed.",-7,-8,!0,!0);break}return null;default:throw new Error("Invalid syntax use \x1B[4m"+n+"resu\x1B[0;-11;-12mme id \x1B[3mprofile\x1B[0;-11;-12m or \x1B[4m"+n+"resu\x1B[0;-11;-12mme")}case"action":case"ac":case"trigger":case"tr":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),u={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+n+"tr\x1B[0;-11;-12migger name {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or \x1B[4m"+n+"tr\x1B[0;-11;-12migger {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid trigger name or pattern");if(e[0].match(/^\{.*\}$/g))u.pattern=e.shift(),u.pattern=this.parseInline(u.pattern.substr(1,u.pattern.length-2));else{if(u.name=this.parseInline(this.stripQuotes(e.shift())),!u.name||u.name.length===0)throw new Error("Invalid trigger name");e[0].match(/^\{.*\}$/g)&&(u.pattern=e.shift(),u.pattern=this.parseInline(u.pattern.substr(1,u.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(u.commands=e.shift(),u.commands=u.commands.substr(1,u.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(b=>{switch(b.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":u.options[b.trim()]=!0;break;default:if(b.trim().startsWith("param=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${b.trim()}'`);u.options.params=f[1]}else if(b.trim().startsWith("type=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${b.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid trigger type");u.options.type=f[1]}else if(b.trim().startsWith("pri=")||b.trim().startsWith("priority=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${b.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");u.options.priority=l}else throw new Error(`Invalid trigger option '${b.trim()}'`)}});else throw new Error("Invalid trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(b=>{switch(b.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":u.options[b.trim()]=!0;break;default:if(b.trim().startsWith("param=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${b.trim()}'`);u.options.params=f[1]}else if(b.trim().startsWith("type=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${b.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid trigger type");u.options.type=f[1]}else if(b.trim().startsWith("pri=")||b.trim().startsWith("priority=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${b.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");u.options.priority=l}else throw new Error(`Invalid trigger option '${b.trim()}'`)}});else throw new Error("Invalid trigger options");u.profile=this.stripQuotes(e[1]),u.profile.length!==0&&(u.profile=this.parseInline(u.profile))}}return this.createTrigger(u.pattern,u.commands,u.profile,u.options,u.name),null;case"event":case"ev":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),c=null,S=!0,u={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+n+"ev\x1B[0;-11;-12ment name {commands} \x1B[3moptions profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid event name");if(u.name=this.parseInline(this.stripQuotes(e.shift())),!u.name||u.name.length===0)throw new Error("Invalid event name");if(e.length===0)throw new Error("Missing commands or options");if(e[0].match(/^\{[\s\S]*\}$/g))u.commands=e.shift(),u.commands=u.commands.substr(1,u.commands.length-2);else throw new Error("Missing commands");if(e.length===1)if(e[0]=e[0].substr(1,e[0].length-2),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(b=>{switch(b.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"temporary":case"temp":u.options[b.trim()]=!0;break;default:if(b.trim().startsWith("pri=")||b.trim().startsWith("priority=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid event priority option '${b.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid event priority value '"+f[1]+"' must be a number");u.options.priority=l}else throw new Error(`Invalid event option '${b.trim()}'`)}});else throw new Error("Invalid event options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(b=>{switch(b.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"temporary":case"temp":u.options[b.trim()]=!0;break;default:if(b.trim().startsWith("pri=")||b.trim().startsWith("priority=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid event priority option '${b.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid event priority value '"+f[1]+"' must be a number");u.options.priority=l}else throw new Error(`Invalid event option '${b.trim()}'`)}});else throw new Error("Invalid event options");u.profile=this.stripQuotes(e[1]),u.profile.length!==0&&(u.profile=this.parseInline(u.profile))}if(!u.profile||u.profile.length===0){let b=this.client.profiles.keys,d=0,v=b.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[b[0]].enabled||!this.client.profiles.items[b[0]].enableTriggers)throw Error("No enabled profiles found!");c=this.client.profiles.items[b[0]],f=U(this.client.profiles.items[b[d]].triggers.filter(N=>N.type===2)),m=f.find(N=>N.name===u.name||N.pattern===u.name)}else{for(;d<v;d++)if(!(!this.client.profiles.items[b[d]].enabled||!this.client.profiles.items[b[d]].enableTriggers||this.client.profiles.items[b[d]].triggers.length===0)&&(f=U(this.client.profiles.items[b[d]].triggers.filter(N=>N.type===2)),m=f.find(N=>N.name===u.name||N.pattern===u.name),m)){c=this.client.profiles.items[b[d]];break}c||(c=this.client.activeProfile)}}else{if(this.client.profiles.contains(u.profile))c=this.client.profiles.items[u.profile.toLowerCase()];else throw new Error("Profile not found: "+u.profile);m=f.find(b=>b.name===u.name||b.pattern===u.name)}return m?this.client.echo("Event '"+m.name+"' updated.",-7,-8,!0,!0):(m=new pe,m.name=u.name,c.triggers.push(m),this.client.echo("Event '"+m.name+"' added.",-7,-8,!0,!0),u.new=!0),m.pattern=u.name,u.commands!==null&&(m.value=u.commands),m.type=2,u.options.prompt&&(m.triggerPrompt=!0),u.options.nocr&&(m.triggerNewline=!1),u.options.case&&(m.caseSensitive=!0),u.options.raw&&(m.raw=!0),u.options.verbatim&&(m.verbatim=!0),u.options.disable?m.enabled=!1:u.options.enable&&(m.enabled=!0),(u.options.temporary||u.options.temp)&&(m.temp=!0),m.priority=u.options.priority,this.client.saveProfiles(),S&&this.client.clearCache(),u.new?this.emit("item-added","trigger",c.name,m):this.emit("item-updated","trigger",c.name,c.triggers.indexOf(m),m),c=null,null;case"unevent":case"une":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"une\x1B[0;-11;-12mvent name or \x1B[4m"+n+"une\x1B[0;-11;-12mvent {name} \x1B[3mprofile\x1B[0;-11;-12m");if(S=!0,c=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"une\x1B[0;-11;-12mvent name or \x1B[4m"+n+"une\x1B[0;-11;-12mvent {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(c=this.parseInline(this.stripQuotes(e[1])).toLowerCase(),this.client.profiles.contains(c))c=this.client.profiles.items[c];else throw new Error("Profile not found: "+c);else c=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?s=this.parseInline(this.stripQuotes(e[0])):s=this.parseInline(e[0].substr(1,e[0].length-2))}else s=this.parseInline(e.join(" ")),c=this.client.activeProfile;return r=U(c.triggers.filter(b=>b.type===2)),s=this.stripQuotes(s),f=s,s=r.findIndex(b=>b.pattern===s||b.name===s),o=s!==-1,o?(this.client.echo("Event '"+(r[s].name||r[s].pattern)+"' removed.",-7,-8,!0,!0),S?this.client.removeTrigger(r[s]):(s=c.triggers.indexOf(r[s]),c.triggers.splice(s,1),this.client.saveProfiles(),this.emit("item-removed","trigger",c.name,s)),c=null):this.client.echo("Event '"+f+"' not found.",-7,-8,!0,!0),null;case"button":case"bu":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===1){if(s=this.parseInline(this.stripQuotes(e[0])),r=document.getElementById("user-buttons").children,/^\s*?\d+\s*?$/.exec(s)){if(s=parseInt(s,10),s<0||s>=r.length)throw new Error("Button index must be >= 0 and < "+r.length);r[s].click()}else if(r[s])r[s].click();else throw new Error(`Button '${s}' not found`);return null}if(c=null,S=!0,u={profile:null,name:null,caption:null,commands:null,icon:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+n+"bu\x1B[0;-11;-12mtton name|index or \x1B[4m"+n+"bu\x1B[0;-11;-12mtton name \x1B[3mcaption\x1B[0;-11;-12m {commands} \x1B[3m{icon} options profile\x1B[0;-11;-12m or \x1B[4m"+n+"by\x1B[0;-11;-12mutton \x1B[3mcaption\x1B[0;-11;-12m {commands} \x1B[3m{icon} {options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid button name, caption or commands");if(e[0].match(/^\{[\s\S]*\}$/g))u.commands=e.shift(),u.commands=u.commands.substr(1,u.commands.length-2);else{if(u.name=this.parseInline(this.stripQuotes(e.shift())),!u.name||u.name.length===0)throw new Error("Invalid button name or caption");if(e[0].match(/^\{[\s\S]*\}$/g))u.commands=e.shift(),u.commands=u.commands.substr(1,u.commands.length-2);else if(u.caption=this.stripQuotes(e.shift()),!e[0].match(/^\{[\s\S]*\}$/g))throw new Error("Missing commands")}if(e.length!==0){if(e[0].match(/^\{.*\}$/g)&&(u.icon=e.shift(),u.icon=u.icon.substr(1,u.icon.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(b=>{switch(b.trim()){case"nosend":case"chain":case"append":case"stretch":case"disable":case"enable":u.options[b.trim()]=!0;break;default:if(b.trim().startsWith("pri=")||b.trim().startsWith("priority=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid button priority option '${b.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid button priority value '"+f[1]+"' must be a number");u.options.priority=l}else throw new Error(`Invalid button option '${b.trim()}'`)}});else throw new Error("Invalid button options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(b=>{switch(b.trim()){case"nosend":case"chain":case"append":case"stretch":case"disable":case"enable":u.options[b.trim()]=!0;break;default:if(b.trim().startsWith("pri=")||b.trim().startsWith("priority=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid button priority option '${b.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid button priority value '"+f[1]+"' must be a number");u.options.priority=l}else throw new Error(`Invalid button option '${b.trim()}'`)}});else throw new Error("Invalid button options");u.profile=this.stripQuotes(e[1]),u.profile.length!==0&&(u.profile=this.parseInline(u.profile))}}if(!u.profile||u.profile.length===0){let b=this.client.profiles.keys,d=0,v=b.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[b[0]].enabled||!this.client.profiles.items[b[0]].enableTriggers)throw Error("No enabled profiles found!");c=this.client.profiles.items[b[0]],u.name!==null?m=this.client.profiles.items[b[d]].find("buttons","name",u.name):m=this.client.profiles.items[b[d]].find("buttons","caption",u.caption)}else{for(;d<v;d++)if(!(!this.client.profiles.items[b[d]].enabled||!this.client.profiles.items[b[d]].enableTriggers||this.client.profiles.items[b[d]].triggers.length===0)&&(u.name!==null?m=this.client.profiles.items[b[d]].find("buttons","name",u.name):m=this.client.profiles.items[b[d]].find("buttons","caption",u.caption),m)){c=this.client.profiles.items[b[d]];break}c||(c=this.client.activeProfile)}}else{if(this.client.profiles.contains(u.profile))c=this.client.profiles.items[u.profile.toLowerCase()];else throw new Error("Profile not found: "+u.profile);u.name!==null?m=c.find("buttons","name",u.name):m=c.find("buttons","caption",u.caption)}return m?this.client.echo("Button '"+(m.name||m.caption||"")+"' updated.",-7,-8,!0,!0):(m=new He,m.name=u.name||"",m.caption=u.caption||"",c.buttons.push(m),!u.name&&!u.caption?this.client.echo("Button added.",-7,-8,!0,!0):this.client.echo("Button '"+(m.name||m.caption||"")+"' added.",-7,-8,!0,!0),u.new=!0),u.caption!==null&&(m.caption=u.caption),u.commands!==null&&(m.value=u.commands),u.options.icon&&(m.icon=u.options.icon),u.options.nosend&&(m.send=!1),u.options.chain&&(m.chain=!0),u.options.append&&(m.append=!0),u.options.stretch&&(m.stretch=!0),u.options.disable?m.enabled=!1:u.options.enable&&(m.enabled=!0),m.priority=u.options.priority,this.client.saveProfiles(),S&&this.client.clearCache(),u.new?this.emit("item-added","button",c.name,m):this.emit("item-updated","button",c.name,c.buttons.indexOf(m),m),c=null,null;case"unbutton":case"unb":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"unb\x1B[0;-11;-12mtton name or \x1B[4m"+n+"unb\x1B[0;-11;-12mtton {name} \x1B[3mprofile\x1B[0;-11;-12m");if(S=!0,c=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"unb\x1B[0;-11;-12mtton name or \x1B[4m"+n+"unb\x1B[0;-11;-12mtton {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(c=this.parseInline(this.stripQuotes(e[1])),this.client.profiles.contains(c))c=this.client.profiles.items[c.toLowerCase()];else throw new Error("Profile not found: "+c);else c=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?s=this.parseInline(this.stripQuotes(e[0])):s=this.parseInline(e[0].substr(1,e[0].length-2))}else s=this.parseInline(e.join(" ")),c=this.client.activeProfile;if(r=U(c.buttons),f=s,/^\s*?\d+\s*?$/.exec(s)){if(s=parseInt(s,10),s<0||s>=r.length)throw new Error("Button index must be >= 0 and < "+r.length);o=!0}else s=this.stripQuotes(s),s=r.findIndex(b=>b.name===s||b.caption===s),o=s!==-1;return o?(r[s].name.length===0&&r[s].caption.length===0?this.client.echo("Button '"+f+"' removed.",-7,-8,!0,!0):this.client.echo("Button '"+(r[s].name||r[s].caption)+"' removed.",-7,-8,!0,!0),s=c.buttons.indexOf(r[s]),c.buttons.splice(s,1),this.client.saveProfiles(),S&&this.client.clearCache(),this.emit("item-removed","button",c.name,s),c=null):this.client.echo("Button '"+f+"' not found.",-7,-8,!0,!0),null;case"alarm":case"ala":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),c=null,y=null,S=!0,s=!1,e.length<2||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+n+"ala\x1B[0;-11;-12mrm name {timepattern} {commands} \x1B[3mprofile\x1B[0;-11;-12m, \x1B[4m"+n+"ala\x1B[0;-11;-12mrm name {timepattern} \x1B[3mprofile\x1B[0;-11;-12m, or \x1B[4m"+n+"ala\x1B[0;-11;-12mrm {timepattern} {commands} \x1B[3mprofile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid name or timepattern");if(e[0].match(/^\{.*\}$/g)){if(e.length>3)throw new Error("Invalid syntax use \x1B[4m"+n+"ala\x1B[0;-11;-12mrm {timepattern} {commands} profile");if(e[0]=e[0].substr(1,e[0].length-2),e[0]=this.parseInline(e[0]),e[1].match(/^\{[\s\S]*\}$/g)&&(e[1]=e[1].substr(1,e[1].length-2)),e.length===3&&(c=this.stripQuotes(e[2]),c=this.parseInline(c)),!c||c.length===0)c=this.client.activeProfile;else if(this.client.profiles.contains(c))c=this.client.profiles.items[c.toLowerCase()];else throw new Error("Profile not found: "+c);return m=new pe,m.pattern=e[0],m.value=e[1],m.type=3,c.triggers.push(m),this.client.saveProfiles(),S&&(this._lastSuspend=-1,this.client.updateAlarms()),this.client.echo("Alarm '"+m.pattern+"' added.",-7,-8,!0,!0),this.emit("item-added","trigger",c.name,m),c=null,null}if(y=this.stripQuotes(e[0]),!y||y.length===0)throw new Error("Invalid alarm name");y=this.parseInline(y);let H=e[1],C=null;if(H.match(/^\{.*\}$/g)&&(H=H.substr(1,H.length-2)),H=this.parseInline(H),e.length===3?e[2].match(/^\{[\s\S]*\}$/g)?C=e[2].substr(1,e[2].length-2):c=this.stripQuotes(e[2]):e.length===4&&(C=e[2],c=this.stripQuotes(e[3]),C.match(/^\{[\s\S]*\}$/g)&&(C=C.substr(1,C.length-2))),!c||c.length===0){let b=this.client.profiles.keys,d=0,v=b.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[b[0]].enabled||!this.client.profiles.items[b[0]].enableTriggers)throw Error("No enabled profiles found!");if(c=this.client.profiles.items[b[0]],m=c.find("triggers","name",y),!m&&!C)throw new Error("Alarm not found!");m?this.client.echo("Alarm '"+m.name+"' updated.",-7,-8,!0,!0):(m=new pe,m.name=y,c.triggers.push(m),this.client.echo("Alarm '"+m.name+"' added.",-7,-8,!0,!0),s=!0)}else{for(;d<v;d++)if(!(!this.client.profiles.items[b[d]].enabled||!this.client.profiles.items[b[d]].enableTriggers||this.client.profiles.items[b[d]].triggers.length===0)&&(m=this.client.profiles.items[b[d]].find("triggers","name",y),m)){c=this.client.profiles.items[b[d]];break}if(!c&&!C)throw new Error("Alarm not found!");c||(c=this.client.activeProfile),m?this.client.echo("Alarm '"+m.name+"' updated.",-7,-8,!0,!0):(m=new pe,s=!0,m.name=y,c.triggers.push(m),this.client.echo("Alarm '"+m.name+"' added.",-7,-8,!0,!0))}}else{if(c=this.parseInline(c),this.client.profiles.contains(c))c=this.client.profiles.items[c.toLowerCase()];else throw new Error("Profile not found: "+c);if(m=c.find("triggers","name",y),!m&&!C)throw new Error("Alarm not found!");m?this.client.echo("Alarm '"+m.name+"' updated.",-7,-8,!0,!0):(m=new pe,m.name=y,c.triggers.push(m),s=!0,this.client.echo("Alarm '"+m.name+"' added.",-7,-8,!0,!0))}return m.pattern=H,m.type=3,C&&(m.value=C),this.client.saveProfiles(),s?this.emit("item-added","trigger",c.name,m):this.emit("item-updated","trigger",c.name,c.triggers.indexOf(m),m),c=null,S&&(this._lastSuspend=-1,this.client.updateAlarms()),null;case"ungag":case"ung":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length>0)throw new Error("Invalid syntax use \x1B[4m"+n+"ung\x1B[0;-11;-12mag number or \x1B[4m"+n+"ung\x1B[0;-11;-12mag");return this._gagID.length&&(clearTimeout(this._gagID.pop()),this._gags.pop()),this._gag=0,null;case"gag":case"ga":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)return this._gags.length&&this._gags[this._gags.length-1]==this.client.display.lines.length&&(this._gag=0,this._gags.pop()),this._gags.push(this.client.display.lines.length),this._gagID.push(setTimeout(()=>{if(s=this.adjustLastLine(this._gags.pop()),this._gags.length){let b=this._gags.length;for(;b>=0;)b--,this._gags[b]>s&&this._gags[b]--}this.client.display.removeLine(s)},0)),this._gag=0,null;if(e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"ga\x1B[0;-11;-12mg number or \x1B[4m"+n+"ga\x1B[0;-11;-12mg");if(l=parseInt(e[0],10),isNaN(l))throw new Error("Invalid number '"+e[0]+"'");return this._gags.length&&this._gags[this._gags.length-1]==this.client.display.lines.length&&(this._gag=0,this._gags.pop()),this._gags.push(this.client.display.lines.length),l>=0?(this._gagID.push(setTimeout(()=>{if(s=this.adjustLastLine(this._gags.pop()),this._gags.length){let b=this._gags.length;for(;b>=0;)b--,this._gags[b]>s&&this._gags[b]--}this.client.display.removeLine(s),this._gag=l},0)),this._gag=0):(this._gagID.push(setTimeout(()=>{s=this.adjustLastLine(this._gags.pop()),l*=-1,l>this.client.display.lines.length&&(l=this.client.display.lines.length),this.client.display.removeLines(s-l,l),this._gag=0},0)),this._gag=0),null;case"wait":case"wa":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=e.filter(b=>b),e.length===0||e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"wa\x1B[0;-11;-12mit number");if(l=parseInt(this.parseInline(e[0]),10),isNaN(l))throw new Error("Invalid number '"+l+"' for wait");if(l<1)throw new Error("Must be greater then zero for wait");return l;case"showclient":case"showcl":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.show(),null;case"hideclient":case"hidecl":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.hide(),null;case"toggleclient":case"togglecl":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.toggle(),null;case"raiseevent":case"raise":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.getOption("parseDoubleQuotes")&&e.forEach(b=>b.replace(/^\"(.*)\"$/g,(d,v,N)=>v.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(b=>b.replace(/^\'(.*)\'$/g,(d,v,N)=>v.replace(/\\\'/g,"'"))),e.length===0)throw new Error("Invalid syntax use "+n+"\x1B[4mraise\x1B[0;-11;-12mevent name or "+n+"\x1B[4mraise\x1B[0;-11;-12mevent name arguments");return e.length===1?this.client.raise(e[0]):this.client.raise(e[0],e.slice(1)),null;case"window":case"win":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.getOption("parseDoubleQuotes")&&e.forEach(b=>b.replace(/^\"(.*)\"$/g,(d,v,N)=>v.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(b=>b.replace(/^\'(.*)\'$/g,(d,v,N)=>v.replace(/\\\'/g,"'"))),e.length===0||e.length>3)throw new Error("Invalid syntax use "+n+"\x1B[4mwin\x1B[0;-11;-12mdow name \x1B[3mclose\x1B[0;-11;-12m or "+n+"\x1B[4mwin\x1B[0;-11;-12mdow new \x1B[3mcharacter\x1B[0;-11;-12m");return e.length===3?this.client.emit("window",this.stripQuotes(this.parseInline(e[0])),this.stripQuotes(this.parseInline(e[1])),this.stripQuotes(this.parseInline(e.slice(2).join(" ")))):e.length===1?this.client.emit("window",this.stripQuotes(this.parseInline(e[0]))):this.client.emit("window",this.stripQuotes(this.parseInline(e[0])),this.stripQuotes(this.parseInline(e.slice(1).join(" ")))),null;case"raisedelayed":case"raisede":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"raisede\x1B[0;-11;-12mlayed milliseconds name or \x1B[4m"+n+"raisede\x1B[0;-11;-12mlayed milliseconds name arguments");if(l=parseInt(this.stripQuotes(this.parseInline(e[0])),10),isNaN(l))throw new Error("Invalid number '"+e[0]+"' for raisedelayed");if(l<1)throw new Error("Must be greater then zero for raisedelayed");return e.shift(),this.client.getOption("parseDoubleQuotes")&&e.forEach(b=>b.replace(/^\"(.*)\"$/g,(d,v,N)=>v.replace(/\\\"/g,'"'))),this.client.getOption("parseSingleQuotes")&&e.forEach(b=>b.replace(/^\'(.*)\'$/g,(d,v,N)=>v.replace(/\\\'/g,"'"))),e.length===1?this.client.raise(e[0],0,l):this.client.raise(e[0],e.slice(1),l),null;case"notify":case"not":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"not\x1B[0;-11;-12mify title \x1B[3mmessage icon\x1B[0;-11;-12m");if(e[0]=this.stripQuotes(e[0]),e[e.length-1].match(/^\{.*\}$/g)&&(u=e.pop(),s={icon:this.parseInline(u.substr(1,u.length-2))}),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"not\x1B[0;-11;-12mify title \x1B[3mmessage icon\x1B[0;-11;-12m");return e.length===1?this.client.notify(this.parseInline(this.stripQuotes(e[0])),null,s):this.client.notify(this.parseInline(this.stripQuotes(e[0])),this.parseInline(e.slice(1).join(" ")),s),null;case"idle":case"idletime":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.lastSendTime?this.client.echo("You have been idle: "+Rt(Date.now()-this.client.lastSendTime),-7,-8,!0,!0):this.client.echo("Not connected",-7,-8,!0,!0),null;case"connect":case"connecttime":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.connectTime?this.client.echo("You have been connected: "+Rt(Date.now()-this.client.connectTime),-7,-8,!0,!0):!moment&&this.client.disconnectTime?this.client.echo("Disconnected since: "+new Date(this.client.disconnectTime).toLocaleString(),-7,-8,!0,!0):this.client.disconnectTime?this.client.echo("Disconnected since: "+new moment(this.client.disconnectTime).format("MM/DD/YYYY hh:mm:ss A"),-7,-8,!0,!0):this.client.echo("Not connected",-7,-8,!0,!0),null;case"beep":case"be":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.beep(),null;case"version":case"ve":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.echo(this.client.telnet.terminal+" v"+this.client.version,-7,-8,!0,!0),null;case"showprompt":case"showp":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.telnet.receivedData(Ne(e),!0,!0),this.client.telnet.prompt=!0,null;case"show":case"sh":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=this.parseInline(e.join(" ")+`
`),this.client.telnet.receivedData(Ne(e),!0,!0),null;case"sayprompt":case"sayp":case"echoprompt":case"echop":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.print("\x1B[-7;-8m"+e+"\x1B[0m",!1),null;case"say":case"sa":case"echo":case"ec":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=this.parseInline(e.join(" ")),this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"print":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),l=this.client.enableTriggers,this.client.enableTriggers=!1,e=this.parseInline(e.join(" ")),this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,this.client.enableTriggers=l,null;case"printprompt":case"printp":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),l=this.client.enableTriggers,this.client.enableTriggers=!1,e=this.parseInline(e.join(" ")),this.client.print("\x1B[-7;-8m"+e+"\x1B[0m",!1),this.client.enableTriggers=l,null;case"alias":case"al":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"al\x1B[0;-11;-12mias name value or \x1B[4m"+n+"al\x1B[0;-11;-12mias name {value} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===1)throw new Error("Must supply an alias value");if(s=this.parseInline(this.stripQuotes(e.shift())),S=!0,c=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"al\x1B[0;-11;-12mias name value or \x1B[4m"+n+"al\x1B[0;-11;-12mias name {value} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(c=this.parseInline(this.stripQuotes(e[1])),this.client.profiles.contains(c))c=this.client.profiles.items[c.toLowerCase()];else throw new Error("Profile not found: "+c);else c=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?e=this.parseInline(this.stripQuotes(e[0])):e=this.parseInline(e[0].substr(1,e[0].length-2))}else e=e.join(" "),c=this.client.activeProfile;if(r=c.aliases,e=this.stripQuotes(e),/^\s*?\d+\s*?$/.exec(s)){if(s=parseInt(s,10),s<0||s>=r.length)throw new Error("Alias index must be >= 0 and < "+r.length);r[s].value=e,this.client.echo("Alias '"+r[s].pattern+"' updated.",-7,-8,!0,!0)}else{for(l=0,a=r.length;l<a;l++)if(r[l].pattern===s){r[l].value=e,this.client.echo("Alias '"+s+"' updated.",-7,-8,!0,!0),this.emit("item-updated","alias",c.name,l,f),o=!0;break}o||(f=new ze(s,e),r.push(f),this.emit("item-added","alias",c.name,f),this.client.echo("Alias '"+s+"' added.",-7,-8,!0,!0))}return c.aliases=r,this.client.saveProfiles(),c=null,S&&this.client.clearCache(),null;case"unalias":case"una":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"una\x1B[0;-11;-12mlias name or \x1B[4m"+n+"una\x1B[0;-11;-12mlias {name} \x1B[3mprofile\x1B[0;-11;-12m");if(S=!0,c=null,e[0].match(/^\{.*\}$/g)||e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)){if(e.length>2)throw new Error("Invalid syntax use \x1B[4m"+n+"una\x1B[0;-11;-12mlias name or \x1B[4m"+n+"una\x1B[0;-11;-12mlias {name} \x1B[3mprofile\x1B[0;-11;-12m");if(e.length===2)if(c=this.stripQuotes(e[1]),c=this.parseInline(c),this.client.profiles.contains(c))c=this.client.profiles.items[c.toLowerCase()];else throw new Error("Profile not found: "+c);else c=this.client.activeProfile;e[0].match(/^".*"$/g)||e[0].match(/^'.*'$/g)?s=this.parseInline(this.stripQuotes(e[0])):s=this.parseInline(e[0].substr(1,e[0].length-2))}else s=this.parseInline(e.join(" ")),c=this.client.activeProfile;if(r=c.aliases,s=this.stripQuotes(s),/^\s*?\d+\s*?$/.exec(s)){if(f=s,s=parseInt(s,10),s<0||s>=r.length)throw new Error("Alias index must be >= 0 and < "+r.length);o=!0}else f=s,s=r.findIndex(b=>b.pattern===s),o=s!==-1;return o?(this.client.echo("Alias '"+r[s].pattern+"' removed.",-7,-8,!0,!0),r.splice(s,1),c.aliases=r,this.client.saveProfiles(),S&&this.client.clearCache(),c=null,this.emit("item-removed","alias",c.name,s)):this.client.echo("Alias '"+f+"' not found.",-7,-8,!0,!0),null;case"setsetting":case"sets":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"sets\x1B[0;-11;-12metting name value");if(e.length===1)throw new Error("Must supply a setsetting value");if(s=this.stripQuotes(this.parseInline(e[0])),e=this.stripQuotes(this.parseInline(e.slice(1).join(" "))),/^\s*?\d+\s*?$/.exec(s)){if(f=s,s=parseInt(s,10),s<0||s>=W.length)throw new Error("Setting index must be >= 0 and < "+W.length);o=!0}else for(s=s.toLowerCase(),l=0,a=W.length;l<a;l++)if(W[l][0].toLowerCase()===s){s=l,o=!0;break}if(o)switch(W[s][2]){case 0:if(W[s][4]>0&&e.length>W[s][4])throw new Error("String can not be longer then "+W[s][4]+" characters");this.client.setOption(W[s][1]||W[s][0],e),this.client.echo("Setting '"+W[s][0]+"' set to '"+e+"'.",-7,-8,!0,!0),this.client.loadOptions();break;case 1:case 3:switch(e.toLowerCase()){case"true":case"1":case"yes":this.client.setOption(W[s][1]||W[s][0],!0),this.client.echo("Setting '"+W[s][0]+"' set to true.",-7,-8,!0,!0),this.client.loadOptions();break;case"no":case"false":case"0":this.client.setOption(W[s][1]||W[s][0],!1),this.client.echo("Setting '"+W[s][0]+"' set to false.",-7,-8,!0,!0),this.client.loadOptions();break;case"toggle":e=!this.client.getOption(W[s][1]||W[s][0]),this.client.setOption(W[s][1]||W[s][0],e),this.client.echo("Setting '"+W[s][0]+"' set to "+e+".",-7,-8,!0,!0),this.client.loadOptions();break;default:throw new Error("Invalid value, must be true or false")}break;case 2:if(l=parseInt(e,10),isNaN(l))throw new Error("Invalid number '"+e+"'");this.client.setOption(W[s][1]||W[s][0],l),this.client.echo("Setting '"+W[s][0]+"' set to '"+l+"'.",-7,-8,!0,!0),this.client.loadOptions();break;case 4:case 5:throw new Error("Unsupported setting '"+s+"'")}else throw new Error("Unknown setting '"+f+"'");return null;case"getsetting":case"gets":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"gets\x1B[0;-11;-12metting name");if(s=this.stripQuotes(this.parseInline(e.join(" "))),/^\s*?\d+\s*?$/.exec(s)){if(s=parseInt(s,10),s<0||s>=W.length)throw new Error("Setting index must be >= 0 and < "+W.length);o=!0}else{if(f=s,s=s.toLowerCase(),s!=="all"){for(l=0,a=W.length;l<a;l++)if(W[l][0].toLowerCase()===s){s=l,o=!0;break}}if(s==="all"){for(f=`Current settings:
`,l=0,a=W.length;l<a;l++)switch(W[l][2]){case 0:case 2:f+="    "+W[l][0]+": "+this.client.getOption(W[s][1]||W[s][0])+`
`;break;case 1:case 3:this.client.getOption(W[s][1]||W[s][0])?f+="    "+W[l][0]+`: true
`:f+="    "+W[l][0]+`: false
`;break}this.client.echo(f,-7,-8,!0,!0)}else if(o)switch(W[s][2]){case 0:case 2:this.client.echo("Setting '"+W[s][0]+"' is '"+this.client.getOption(W[s][1]||W[s][0])+"'",-7,-8,!0,!0);break;case 1:case 3:this.client.getOption(W[s][1]||W[s][0])?this.client.echo("Setting '"+W[s][0]+"' is true",-7,-8,!0,!0):this.client.echo("Setting '"+W[s][0]+"' is false",-7,-8,!0,!0);break}else throw new Error("Unknown setting '"+s+"'")}return null;case"profilelist":(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.echo("\x1B[4mProfiles:\x1B[0m",-7,-8,!0,!0);let _=this.client.profiles.keys;for(a=_.length,l=0;l<a;l++)this.client.profiles.items[_[l]]&&this.client.profiles.items[_[l]].enabled?this.client.echo("   "+this.client.profiles.keys[l]+" is enabled",-7,-8,!0,!0):this.client.echo("   "+_[l]+" is disabled",-7,-8,!0,!0);return null;case"profile":case"pro":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name enable/disable");if(e.length===1){if(e[0]=this.parseInline(e[0]),this.client.toggleProfile(e[0]),this.client.profiles.contains(e[0])){if(this.client.profiles.length===1)throw new Error(e[0]+" can not be disabled as it is the only one enabled")}else throw new Error("Profile not found");this.client.profiles.contains(e[0].toLowerCase())?this.client.profiles.items[e[0].toLowerCase()].enabled?e=e[0]+" is enabled":e=e[0]+" is disabled":e="Profile not found"}else{if(e[0]=this.parseInline(e[0]).toLowerCase(),!this.client.profiles.contains(e[0]))throw new Error("Profile not found");if(!e[1])throw new Error("Invalid syntax use \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name enable/disable");switch(e[1]=this.parseInline(e[1]),e[1].toLowerCase()){case"enable":case"on":case"yes":this.client.profiles.items[e[0].toLowerCase()].enabled?e=e[0]+" is already enabled":(this.client.toggleProfile(e[0]),this.client.profiles.items[e[0].toLowerCase()].enabled!==-1?e=e[0]+" is enabled":e=e[0]+" remains disabled");break;case"disable":case"off":case"no":if(!this.client.profiles.items[e[0].toLowerCase()].enabled)e=e[0]+" is already disabled";else{if(this.client.profiles.length===1)throw new Error(e[0]+" can not be disabled as it is the only one enabled");this.client.toggleProfile(e[0]),e=e[0]+" is disabled"}break;default:throw new Error("Invalid syntax use \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name or \x1B[4m"+n+"pro\x1B[0;-11;-12mfile name enable/disable")}}return this.client.telnet.prompt?this.client.print(`
\x1B[-7;-8m`+e+`\x1B[0m
`,!1):this.client.print("\x1B[-7;-8m"+e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"color":case"co":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length>1&&e.length<4)return u={profile:null,pattern:null,commands:null},u.pattern=e.shift(),u.pattern.match(/^\{.*\}$/g)?u.pattern=this.parseInline(u.pattern.substr(1,u.pattern.length-2)):u.pattern=this.parseInline(this.stripQuotes(u.pattern)),e.length===2?(u.commands=n+"COLOR "+this.parseInline(e[0]),u.profile=this.stripQuotes(e[1]),u.profile.length!==0&&(u.profile=this.parseInline(u.profile))):u.commands=n+"COLOR "+this.parseInline(e[0]),this.createTrigger(u.pattern,u.commands,u.profile),null;if(e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+n+"co\x1B[0;-11;-12mlor color or \x1B[4m"+n+"co\x1B[0;-11;-12mlor {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+n+"co\x1B[0;-11;-12mlor color or \x1B[4m"+n+"co\x1B[0;-11;-12mlor {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(e[0]=this.parseInline(this.stripQuotes(e[0])),s=this.client.display.lines.length,e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.colorSubStrByLine(s,parseInt(e[0],10))},0);else if(e[0].trim().match(/^[-|+]?\d+\s*?,\s*?[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.colorSubStrByLine(s,parseInt(e[0][0],10),parseInt(e[0][1],10))},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(l=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Z(e[0]),l===-1)if(le(e[0]))l=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.colorSubStrByLine(s,l)},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")l=370;else if(e[0]==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Z(e[0]),l===-1)if(le(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{s=this.adjustLastLine(s),l===370?this.client.display.colorSubStrByLine(s,l):this.client.display.colorSubStrByLine(s,l*10)},0);else{if(x=l,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Z(e[1],!0),l===-1)if(le(e[1]))l=e[1];else throw new Error("Invalid back color");setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.colorSubStrByLine(s,x,l)},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Z(e[0]),l===-1)if(le(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(l?x=l*10:l=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Z(e[1],!0),l===-1)if(le(e[1]))l=e[0];else throw new Error("Invalid back color");setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.colorSubStrByLine(s,x,l)},0)}return null;case"cw":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),m=this.stack.regex,e.length>1&&e.length<4)return u={profile:null,pattern:null,commands:null},u.pattern=e.shift(),u.pattern.match(/^\{.*\}$/g)?u.pattern=this.parseInline(u.pattern.substr(1,u.pattern.length-2)):u.pattern=this.parseInline(this.stripQuotes(u.pattern)),e.length===2?(u.commands=n+"CW "+this.parseInline(e[0]),u.profile=this.stripQuotes(e[1]),u.profile.length!==0&&(u.profile=this.parseInline(u.profile))):u.commands=n+"CW "+this.parseInline(e[0]),this.createTrigger(u.pattern,u.commands,u.profile),null;if(e.length!==1)throw new Error("Invalid syntax use "+n+"cw color or "+n+"cw {pattern} color \x1B[3mprofile\x1B[0;-11;-12m");if(!m)return null;if(e[0]=this.parseInline(this.stripQuotes(e[0])),s=this.client.display.lines.length,e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{if(s=this.adjustLastLine(s),m.length===1)this.client.display.colorSubStrByLine(s,parseInt(e[0],10));else{m[1].lastIndex=0,f=m[0].matchAll(m[1]);for(let b of f)this.client.display.colorSubStrByLine(s,parseInt(e[0],10),null,b.index,b[0].length)}},0);else if(e[0].trim().match(/^[-|+]?\d+,[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{if(s=this.adjustLastLine(s),m.length===1)this.client.display.colorSubStrByLine(s,parseInt(e[0][0],10),parseInt(e[0][1],10));else{m[1].lastIndex=0,f=m[0].matchAll(m[1]);for(let b of f)this.client.display.colorSubStrByLine(s,parseInt(e[0],10),parseInt(e[0][1],10),b.index,b[0].length)}},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(l=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Z(e[0]),l===-1)if(le(e[0]))l=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{if(s=this.adjustLastLine(s),m.length===1)this.client.display.colorSubStrByLine(s,l);else{m[1].lastIndex=0,f=m[0].matchAll(m[1]);for(let b of f)this.client.display.colorSubStrByLine(s,l,null,b.index,b[0].length)}},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")l=370;else if(e[0]==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Z(e[0]),l===-1)if(le(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{if(s=this.adjustLastLine(s),l!==370&&(l*=10),m.length===1)this.client.display.colorSubStrByLine(s,l);else{m[1].lastIndex=0,f=m[0].matchAll(m[1]);for(let b of f)this.client.display.colorSubStrByLine(s,l,null,b.index,b[0].length)}},0);else{if(x=l,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Z(e[1],!0),l===-1)if(le(e[1]))l=e[1];else throw new Error("Invalid back color");setTimeout(()=>{if(s=this.adjustLastLine(s),m.length===1)this.client.display.colorSubStrByLine(s,x,l);else{m[1].lastIndex=0,f=m[0].matchAll(m[1]);for(let b of f)this.client.display.colorSubStrByLine(s,x,l,b.index,b[0].length)}},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Z(e[0]),l===-1)if(le(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(l?x=l*10:l=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Z(e[1],!0),l===-1)if(le(e[1]))l=e[0];else throw new Error("Invalid back color");setTimeout(()=>{if(s=this.adjustLastLine(s),m.length===1)this.client.display.colorSubStrByLine(s,x,l);else{m[1].lastIndex=0,f=m[0].matchAll(m[1]);for(let b of f)this.client.display.colorSubStrByLine(s,x,l,b.index,b[0].length)}},0)}return null;case"pcol":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<1||e.length>5)throw new Error("Invalid syntax use "+n+"pcol color \x1B[3mXStart, XEnd, YStart, YEnd\x1B[0;-11;-12m");if(e.length>1){if(f=[].concat(...e.slice(1).map(b=>this.parseInline(this.stripQuotes(b)).split(" "))),f.length>4)throw new Error("Too many arguments use "+n+"pcol color \x1B[3mXStart, XEnd, YStart, YEnd\x1B[0;-11;-12m");if(u={xStart:0},f.length>0&&(u.xStart=parseInt(f[0],10)),f.length>1&&(u.xEnd=parseInt(f[1],10)),f.length>2&&(u.yStart=parseInt(f[2],10)),f.length>3&&(u.yEnd=parseInt(f[3],10)),u.hasOwnProperty("yEnd")&&u.yEnd>u.yStart)throw new Error("yEnd must be smaller or equal to yStart");if(u.hasOwnProperty("xEnd")&&u.xEnd<u.xStart)throw new Error("xEnd must be larger or equal to xStart")}else u={xStart:0};if(e[0]=this.parseInline(this.stripQuotes(e[0])),s=this.adjustLastLine(this.client.display.lines.length),e[0].trim().match(/^[-|+]?\d+$/g))setTimeout(()=>{this.colorPosition(s,parseInt(e[0],10),null,u)},0);else if(e[0].trim().match(/^[-|+]?\d+\s*?,\s*?[-|+]?\d+$/g))e[0]=e[0].split(","),setTimeout(()=>{this.colorPosition(s,parseInt(e[0][0],10),parseInt(e[0][1],10),u)},0);else if(e=e[0].toLowerCase().split(","),e.length===1){if(e[0]==="bold"&&(l=370),e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Z(e[0]),l===-1)if(le(e[0]))l=e[0];else throw new Error("Invalid fore color");setTimeout(()=>{this.colorPosition(s,l,null,u)},0)}else if(e.length===2){if(e[0]==="bold"&&e[1]==="bold")throw new Error("Invalid fore color");if(e[0]==="bold")l=370;else if(e[0]==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Z(e[0]),l===-1)if(le(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[1]==="bold")setTimeout(()=>{this.colorPosition(s,l===370?l:l*10,null,u)},0);else{if(x=l,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Z(e[1],!0),l===-1)if(le(e[1]))l=e[1];else throw new Error("Invalid back color");setTimeout(()=>{this.colorPosition(s,x,l,u)},0)}}else if(e.length===3){if(e[0]==="bold"&&(e.shift(),e.push("bold")),e[0].trim()==="current")l=null;else if(e[0].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[0].trim();else if(e[0].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[0].trim(),10);else if(l=Z(e[0]),l===-1)if(le(e[0]))l=e[0];else throw new Error("Invalid fore color");if(e[2]!=="bold")throw new Error("Only bold is supported as third argument");if(l?x=l*10:l=370,e[1].trim().match(/^#(?:[a-f0-9]{3}|[a-f0-9]{6})\b$/g))l=e[1].trim();else if(e[1].trim().match(/^[-|+]?\d+$/g))l=parseInt(e[1].trim(),10);else if(l=Z(e[1],!0),l===-1)if(le(e[1]))l=e[0];else throw new Error("Invalid back color");setTimeout(()=>{this.colorPosition(s,x,l,u)},0)}return null;case"highlight":case"hi":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length>0&&e.length<2)return u={profile:null,pattern:null,commands:n+"HIGHLIGHT"},u.pattern=e.shift(),u.pattern.match(/^\{.*\}$/g)?u.pattern=this.parseInline(u.pattern.substr(1,u.pattern.length-2)):u.pattern=this.parseInline(this.stripQuotes(u.pattern)),e.length===1&&(u.profile=this.parseInline(this.stripQuotes(e[0]))),this.createTrigger(u.pattern,u.commands,u.profile),null;if(e.length)throw new Error("Too many arguments use \x1B[4m"+n+"hi\x1B[0;-11;-12mghlight \x1B[3mpattern profile\x1B[0;-11;-12m");return s=this.client.display.lines.length,setTimeout(()=>{s=this.adjustLastLine(s),this.client.display.highlightSubStrByLine(s)},0),null;case"break":case"br":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use \x1B[4m"+n+"br\x1B[0;-11;-12meak\x1B[0;-11;-12m");if(!this.loops.length)throw new Error("\x1B[4m"+n+"br\x1B[0;-11;-12meak\x1B[0;-11;-12m must be used in a loop.");return this.stack.break?this.stack.break++:this.stack.break=1,-1;case"continue":case"cont":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use \x1B[4m"+n+"cont\x1B[0;-11;-12minue\x1B[0;-11;-12m");if(!this.loops.length)throw new Error("\x1B[4m"+n+"cont\x1B[0;-11;-12minue\x1B[0;-11;-12m must be used in a loop.");return this.stack.continue=!0,-2;case"if":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),!e.length||e.length>3)throw new Error("Invalid syntax use "+n+"if {expression} {true-command} \x1B[3m{false-command}\x1B[0;-11;-12m");return e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),f=null,this.evaluate(this.parseInline(e[0]))?(e[1].match(/^\{[\s\S]*\}$/g)&&(e[1]=e[1].substr(1,e[1].length-2)),f=this.parseOutgoing(e[1])):e.length>2&&(e[2].match(/^\{[\s\S]*\}$/g)&&(e[2]=e[2].substr(1,e[2].length-2)),f=this.parseOutgoing(e[2])),f!=null&&f.length>0?f:null;case"case":case"ca":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),!e.length||e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"ca\x1B[0;-11;-12mse\x1B[0;-11;-12m index {command 1} \x1B[3m{command n}\x1B[0;-11;-12m");return e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),s=this.evaluate(this.parseInline(e[0])),typeof s!="number"?null:s>0&&s<e.length&&(e[s].match(/^\{[\s\S]*\}$/g)&&(e[s]=e[s].substr(1,e[s].length-2)),f=this.parseOutgoing(e[s]),f!=null&&f.length>0)?f:null;case"switch":case"sw":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),!e.length||e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"sw\x1B[0;-11;-12mitch\x1B[0;-11;-12m (expression) {command} \x1B[3m(expression) {command} ... {else_command}\x1B[0;-11;-12m");for(e.length%2===1?s=e.pop():s=null,a=e.length,l=0;l<a;l+=2)if(e[l].match(/^\{[\s\S]*\}$/g)&&(e[l]=e[l].substr(1,e[l].length-2)),this.evaluate(this.parseInline(e[l])))return e[l+1].match(/^\{[\s\S]*\}$/g)&&(e[l+1]=e[l+1].substr(1,e[l+1].length-2)),f=this.parseOutgoing(e[l+1]),f!=null&&f.length>0?f:null;return s&&(s.match(/^\{[\s\S]*\}$/g)&&(s=s.substr(1,s.length-2)),f=this.parseOutgoing(s),f!=null&&f.length>0)?f:null;case"loop":case"loo":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"loo\x1B[0;-11;-12mp\x1B[0;-11;-12m range {commands}");if(s=this.parseInline(e.shift()).split(","),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),s.length===1){if(f=parseInt(s[0],10),isNaN(f))throw new Error("Invalid loop range '"+s[0]+"' must be a number");return this.executeForLoop(0,f,e)}if(f=parseInt(s[0],10),isNaN(f))throw new Error("Invalid loop min '"+s[0]+"' must be a number");if(l=parseInt(s[1],10),isNaN(l))throw new Error("Invalid loop max '"+s[1]+"' must be a number");return f>l?f++:f--,this.executeForLoop(f,l,e);case"repeat":case"rep":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"rep\x1B[0;-11;-12meat\x1B[0;-11;-12m expression {commands}");if(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.evaluate(this.parseInline(l)),typeof l!="number")throw new Error("Arguments must be a number");return e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),l<1?this.executeForLoop(-l+1,1,e):this.executeForLoop(0,l,e);case"until":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use "+n+"until expression {commands}");for(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),f=[],this.loops.push(0);!this.evaluate(this.parseInline(l));){let b=this.parseOutgoing(e);if(b!=null&&b.length>0&&f.push(b),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}return this.loops.pop(),f.length>0?f.map(b=>b.trim()).join(`
`):null;case"while":case"wh":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"wh\x1B[0;-11;-12mile expression {commands}");for(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),f=[],this.loops.push(0);this.evaluate(this.parseInline(l));){let b=this.parseOutgoing(e);if(b!=null&&b.length>0&&f.push(b),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}return this.loops.pop(),f.length>0?f.map(b=>b.trim()).join(`
`):null;case"forall":case"fo":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"fo\x1B[0;-11;-12mrall stringlist {commands}");for(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),f=[],l=this.splitByQuotes(this.stripQuotes(this.parseInline(l)),"|"),a=l.length,s=0;s<a;s++){this.loops.push(l[s]);let b=this.parseOutgoing(e);if(b!=null&&b.length>0&&f.push(b),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}this.loops.pop()}return f.length>0?f.map(b=>b.trim()).join(`
`):null;case"variable":case"var":case"va":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0){for(l=Object.keys(this.client.variables),a=l.length,f=[],s=0;s<a;s++)f.push(l[s]+" = "+this.client.variables[l[s]]);return f.join(`
`)}if(l=e.shift(),l.match(/^\{.*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),!ke(l))throw new Error("Invalid variable name");return e.length===0?this.client.variables[l]?.toString():(e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.parseInline(e),e.match(/^\s*?[-|+]?\d+\s*?$/)?this.client.variables[l]=parseInt(e,10):e.match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?this.client.variables[l]=parseFloat(e):e==="true"?this.client.variables[l]=!0:e==="false"?this.client.variables[l]=!1:this.client.variables[l]=this.stripQuotes(e),null);case"unvar":case"unv":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length!==1)throw new Error("Invalid syntax use \x1B[4m"+n+"unv\x1B[0;-11;-12mar name ");return l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),delete this.client.variables[l],null;case"add":case"ad":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"ad\x1B[0;-11;-12md name value");if(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),this.client.variables.hasOwnProperty(l)&&typeof this.client.variables[l]!="number")throw new Error(l+" is not a number for add");if(e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.evaluate(this.parseInline(e)),typeof e!="number")throw new Error("Value is not a number for add");return this.client.variables.hasOwnProperty(l)?this.client.variables[l]+=e:this.client.variables[l]=e,null;case"math":case"mat":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length<2)throw new Error("Invalid syntax use \x1B[4m"+n+"mat\x1B[0;-11;-12mh name value");if(l=e.shift(),l.match(/^\{[\s\S]*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),e=this.evaluate(this.parseInline(e)),typeof e!="number")throw new Error("Value is not a number for add");return this.client.variables[l]=e,null;case"evaluate":case"eva":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"eva\x1B[0;-11;-12mluate expression");return e=this.evaluate(this.parseInline(e.join(" "))),this.client.getOption("ignoreEvalUndefined")&&typeof e>"u"?e="":e=""+e,this.client.telnet.prompt?this.client.print(`
`+e+`\x1B[0m
`,!1):this.client.print(e+`\x1B[0m
`,!1),this.client.telnet.prompt=!1,null;case"freeze":case"fr":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)this.scrollLock=!this.scrollLock,this.scrollLock?this.client.display.scrollAtBottom&&this.client.display.scrollUp():this.client.display.scrollDisplay();else if(e.length===1)e[0]==="0"||e[0]==="false"?this.scrollLock&&(this.scrollLock=!1,this.client.display.scrollDisplay()):this.scrollLock||(this.scrollLock=!0,this.client.display.scrollAtBottom&&this.client.display.scrollUp());else if(e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"fr\x1B[0;-11;-12meeze \x1B[3mnumber\x1B[0;-11;-12m");return null;case"clr":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length)throw new Error("Invalid syntax use "+n+"CLR");if(this.client.display.lines.length===0)return null;for(l=this.client.display.WindowSize.height+2,s=this.client.display.lines.length;s--&&l&&!this.client.display.lines[s].text.length;)l--;for(f=[];l--;)f.push(`
`);return this.client.print(f.join(""),!0),null;case"fire":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=this.parseInline(e.join(" ")+`
`),this.ExecuteTriggers(140,e,e,!1,!1),null;case"state":case"sta":switch((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=e.map(b=>!b||!b.length?b:b.match(/^\{.*\}$/g)?this.parseInline(b.substr(1,b.length-2)):this.parseInline(this.stripQuotes(b))),e.length){case 0:throw new Error("Invalid syntax use \x1B[4m"+n+"sta\x1B[0;-11;-12mte \x1B[3m name|pattern state profile\x1B[0;-11;-12m");case 1:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");m=this._LastTrigger,s=m.state,m.state=parseInt(e[0],10)}else{let b=this.client.profiles.keys,d=0,v=b.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[b[0]].enabled||!this.client.profiles.items[b[0]].enableTriggers)throw Error("No enabled profiles found!");m=U(this.client.profiles.items[b[d]].triggers),m=m.find(N=>N.name===e[0]||N.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[b[d]].enabled||!this.client.profiles.items[b[d]].enableTriggers||this.client.profiles.items[b[d]].triggers.length===0)&&(m=U(this.client.profiles.items[b[d]].triggers),m=m.find(N=>N.name===e[0]||N.pattern===e[0]),m));d++);if(!m)throw new Error("Trigger not found: "+e[0]);s=m.state,m.state=0}break;case 2:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/))throw new Error("Invalid argument to "+n+"state, first argument must be name|pattern");if(e[1].match(/^\s*?[-|+]?\d+\s*?$/)){let b=this.client.profiles.keys,d=0,v=b.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[b[0]].enabled||!this.client.profiles.items[b[0]].enableTriggers)throw Error("No enabled profiles found!");m=U(this.client.profiles.items[b[d]].triggers),m=m.find(N=>N.name===e[0]||N.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[b[d]].enabled||!this.client.profiles.items[b[d]].enableTriggers||this.client.profiles.items[b[d]].triggers.length===0)&&(m=U(this.client.profiles.items[b[d]].triggers),m=m.find(N=>N.name===e[0]||N.pattern===e[0]),m));d++);if(!m)throw new Error("Trigger not found: "+e[0]);s=m.state,m.state=parseInt(e[1],10)}else{if(c=e[1],this.client.profiles.contains(c))c=this.client.profiles.items[c.toLowerCase()];else throw new Error("Profile not found: "+e[1]);if(m=U(c.triggers),m=m.find(b=>b.name===e[0]||b.pattern===e[0]),!m)throw new Error("Trigger not found: "+e[0]+" in profile: "+c.name);s=m.state,m.state=0}break;case 3:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/))throw new Error("Invalid argument to "+n+"state, first argument must be name|pattern");if(c=e[2],this.client.profiles.contains(c))c=this.client.profiles.items[c.toLowerCase()];else throw new Error("Profile not found: "+e[2]);if(m=U(c.triggers),m=m.find(b=>b.name===e[0]||b.pattern===e[0]),!m)throw new Error("Trigger not found: "+e[0]);s=m.state,m.state=parseInt(e[1],10);break;default:throw new Error("Invalid syntax use \x1B[4m"+n+"sta\x1B[0;-11;-12mte \x1B[3m name|pattern state profile\x1B[0;-11;-12m")}if(m.state<0||m.state>m.triggers.length)throw m.state=s,new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+m.triggers.length);return l=m.fired,m.fired=!1,this.resetTriggerState(this._TriggerCache.indexOf(m),s,l),this.client.restartAlarmState(m,s,m.state),this.client.saveProfiles(),this.client.emit("item-updated","trigger",m.profile.name,m.profile.triggers.indexOf(m),m),this.client.echo("Trigger state set to "+m.state+".",-7,-8,!0,!0),null;case"set":switch((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=e.map(b=>!b||!b.length?b:b.match(/^\{.*\}$/g)?this.parseInline(b.substr(1,b.length-2)):this.parseInline(this.stripQuotes(b))),s=0,l=!1,e.length){case 0:throw new Error("Invalid syntax use "+n+"set \x1B[3mname|pattern\x1B[0;-11;-12m state \x1B[3mvalue profile\x1B[0;-11;-12m");case 1:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");if(m=this._LastTrigger,s=parseInt(e[0],10),s<0||s>m.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+m.triggers.length);s===0?(l=m.fired,m.fired=!0):(l=m.triggers[s-1].fired,m.triggers[s-1].fired=!0)}else throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+m.triggers.length);break;case 2:if(e[0].match(/^\s*?[-|+]?\d+\s*?$/)){if(!this._LastTrigger)throw new Error("No trigger has fired yet, unable to set state");if(m=this._LastTrigger,s=parseInt(e[0],10),s<0||s>m.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+m.triggers.length);if(e[1]!=="0"&&e[1]!=="1"&&e[1]!=="true"&&e[1]!=="false")throw new Error("Value must be 0, 1, true, or false");s===0?(l=m.fired,m.fired=e[1]==="1"||e[1]==="true"):(l=m.triggers[s-1].fired,m.triggers[s-1].fired=e[1]==="1"||e[1]==="true")}else{let b=this.client.profiles.keys,d=0,v=b.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[b[0]].enabled||!this.client.profiles.items[b[0]].enableTriggers)throw Error("No enabled profiles found!");m=U(this.client.profiles.items[b[d]].triggers),m=m.find(N=>N.name===e[0]||N.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[b[d]].enabled||!this.client.profiles.items[b[d]].enableTriggers||this.client.profiles.items[b[d]].triggers.length===0)&&(m=U(this.client.profiles.items[b[d]].triggers),m=m.find(N=>N.name===e[0]||N.pattern===e[0]),m));d++);if(!m)throw new Error("Trigger not found: "+e[0]);if(s=parseInt(e[1],10),s<0||s>m.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+m.triggers.length);s===0?(l=m.fired,m.fired=!0):(l=m.triggers[s-1].fired,m.triggers[s-1].fired=!0)}break;case 3:if(e[2]==="0"&&e[2]!=="1"&&e[2]!=="true"&&e[21]!=="false"){if(c=e[2],this.client.profiles.contains(c))c=this.client.profiles.items[c.toLowerCase()];else throw new Error("Profile not found: "+c);if(m=U(c.triggers),m=m.find(b=>b.name===e[0]||b.pattern===e[0]),!m)throw new Error("Trigger not found: "+e[0]+" in profile: "+c.name);if(s=parseInt(e[1],10),s<0||s>m.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+m.triggers.length);s===0?(l=m.fired,m.fired=!0):(l=m.triggers[s-1].fired,m.triggers[s-1].fired=!0)}else{let b=this.client.profiles.keys,d=0,v=b.length;if(v===0)return null;if(v===1){if(!this.client.profiles.items[b[0]].enabled||!this.client.profiles.items[b[0]].enableTriggers)throw Error("No enabled profiles found!");m=U(this.client.profiles.items[b[d]].triggers),m=m.find(N=>N.name===e[0]||N.pattern===e[0])}else for(;d<v&&!(!(!this.client.profiles.items[b[d]].enabled||!this.client.profiles.items[b[d]].enableTriggers||this.client.profiles.items[b[d]].triggers.length===0)&&(m=U(this.client.profiles.items[b[d]].triggers),m=m.find(N=>N.name===e[0]||N.pattern===e[0]),m));d++);if(!m)throw new Error("Trigger not found: "+e[0]);if(s=parseInt(e[1],10),s<0||s>m.triggers.length)throw new Error("Trigger state must be greater than or equal to 0 or less than or equal to "+m.triggers.length);s===0?(l=m.fired,m.fired=e[2]==="1"||e[2]==="true"):(l=m.triggers[s-1].fired,m.triggers[s-1].fired=e[2]==="1"||e[2]==="true")}break;case 4:if(c=e[2],this.client.profiles.contains(c))c=this.client.profiles.items[c.toLowerCase()];else throw new Error("Profile not found: "+c);if(m=U(c.triggers),m=m.find(b=>b.name===e[0]||b.pattern===e[0]),!m)throw new Error("Trigger not found: "+e[0]+" in profile: "+c.name);if(e[2]!=="0"&&e[2]!=="1"&&e[2]!=="true"&&e[2]!=="false")throw new Error("Value must be 0, 1, true, or false");s===0?(l=m.fired,m.fired=e[2]==="1"||e[2]==="true"):(l=m.triggers[s-1].fired,m.triggers[s-1].fired=e[2]==="1"||e[2]==="true");break;default:throw new Error("Invalid syntax use "+n+"set \x1B[3mname|pattern\x1B[0;-11;-12m state \x1B[3mvalue profile\x1B[0;-11;-12m")}return this.client.saveProfiles(),this.client.emit("item-updated","trigger",m.profile.name,m.profile.triggers.indexOf(m),m),this.resetTriggerState(this._TriggerCache.indexOf(m),s,l),s===0?this.client.echo("Trigger state 0 fired state set to "+m.fired+".",-7,-8,!0,!0):(this.client.echo("Trigger state "+s+" fired state set to "+m.triggers[s-1].fired+".",-7,-8,!0,!0),m.enabled&&m.triggers[s-1].enabled&&m.triggers[s-1].type===65536&&(this._LastTriggered="",this.ExecuteTrigger(m,[],!1,this._TriggerCache.indexOf(m),0,0,m))),null;case"condition":case"cond":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),u={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use \x1B[4m"+n+"cond\x1B[0;-11;-12mition name|pattern {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or \x1B[4m"+n+"cond\x1B[0;-11;-12mition {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid trigger name or pattern");if(e[0].match(/^\{.*\}$/g))u.pattern=e.shift(),u.pattern=this.parseInline(u.pattern.substr(1,u.pattern.length-2));else{if(u.name=this.parseInline(this.stripQuotes(e.shift())),!u.name||u.name.length===0)throw new Error("Invalid trigger name");e[0].match(/^\{.*\}$/g)&&(u.pattern=e.shift(),u.pattern=this.parseInline(u.pattern.substr(1,u.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(u.commands=e.shift(),u.commands=u.commands.substr(1,u.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(b=>{switch(b.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":case"reparse":case"reparsepattern":case"manual":case"skip":case"looplines":case"looppattern":case"wait":case"duration":case"withinlines":u.options[b.trim()]=!0;break;default:if(b.trim().startsWith("param=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${b.trim()}'`);u.options.params=f[1]}else if(b.trim().startsWith("type=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${b.trim()}'`);if(!this.isTriggerType(f[1]))throw new Error("Invalid trigger type");u.options.type=f[1]}else if(b.trim().startsWith("pri=")||b.trim().startsWith("priority=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${b.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");u.options.priority=l}else throw new Error(`Invalid trigger option '${b.trim()}'`)}});else throw new Error("Invalid trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(b=>{switch(b.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"temporary":case"temp":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":case"reparse":case"reparsepattern":case"manual":case"skip":case"looplines":case"looppattern":case"wait":case"duration":case"withinlines":u.options[b.trim()]=!0;break;default:if(b.trim().startsWith("param=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger param option '${b.trim()}'`);u.options.params=f[1]}else if(b.trim().startsWith("type=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger type option '${b.trim()}'`);if(!this.isTriggerType(f[1]))throw new Error("Invalid trigger type");u.options.type=f[1]}else if(b.trim().startsWith("pri=")||b.trim().startsWith("priority=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid trigger priority option '${b.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid trigger priority value '"+f[1]+"' must be a number");u.options.priority=l}else throw new Error(`Invalid trigger option '${b.trim()}'`)}});else throw new Error("Invalid trigger options");u.profile=this.stripQuotes(e[1]),u.profile.length!==0&&(u.profile=this.parseInline(u.profile))}}return this.createTrigger(u.pattern,u.commands,u.profile,u.options,u.name,!0),null;case"cr":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.sendBackground(`
`),null;case"send":case"se":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"se\x1B[0;-11;-12mnd file \x1B[3mprefix suffix\x1B[0;-11;-12m or \x1B[4m"+n+"se\x1B[0;-11;-12mnd text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"se\x1B[0;-11;-12mnd file \x1B[3mprefix suffix\x1B[0;-11;-12m or \x1B[4m"+n+"se\x1B[0;-11;-12mnd text");return this.client.sendBackground(this.stripQuotes(e),this.client.getOption("allowCommentsFromCommand")),null;case"sendfile":case"sendf":return((b,d)=>{be().then(v=>{ye(v[0]).then(N=>{(this.client.getOption("echo")&4)===4&&this.client.echo(d,-3,-4,!0,!0),x="",l="",b.length>1&&(x=this.stripQuotes(this.parseInline(b[0]))),b.length>2&&(l=this.stripQuotes(this.parseInline(b[1]))),r=N.split(/\r?\n/),r.forEach(J=>{this.client.sendBackground(x+J+l,null,this.client.getOption("allowCommentsFromCommand"))})}).catch(this.client.error)}).catch(()=>{})})(e,i),null;case"sendfileraw":case"sendfiler":return((b,d)=>{be().then(v=>{ye(v[0]).then(N=>{(this.client.getOption("echo")&4)===4&&this.client.echo(d,-3,-4,!0,!0),x="",l="",b.length>1&&(x=this.stripQuotes(this.parseInline(b[0]))),b.length>2&&(l=this.stripQuotes(this.parseInline(b[1]))),r=N.split(/\r?\n/),r.forEach(J=>{this.client.sendRaw(x+J+l)})}).catch(this.client.error)}).catch(()=>{})})(e,i),null;case"sendraw":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+n+"sendraw text or "+n+"sendraw file \x1B[3mprefix suffix\x1B[0;-11;-12m");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use "+n+"sendraw text or "+n+"sendraw file \x1B[3mprefix suffix\x1B[0;-11;-12m");return e.endsWith(`
`)||(e=e+`
`),this.client.sendRaw(e),null;case"sendprompt":case"sendp":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"sendp\x1B[0;-11;-12mrompt text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use \x1B[4m"+n+"sendp\x1B[0;-11;-12mrompt text");return this.client.sendRaw(e),null;case"character":case"char":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),this.client.sendRaw(window.$character||""),null;case"speak":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+n+"speak text");if(e=e.join(" "),e.length===0)throw new Error("Invalid syntax use "+n+"speak text");return e=this.stripQuotes(this.parseInline(e)),e.length!==0&&window.speechSynthesis.speak(new SpeechSynthesisUtterance(e)),null;case"speakstop":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+n+"speakstop");return window.speechSynthesis.cancel(),null;case"speakpause":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+n+"speakpause");return window.speechSynthesis.pause(),null;case"speakresume":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length!==0)throw new Error("Invalid syntax use "+n+"speakresume");return window.speechSynthesis.resume(),null;case"comment":case"comm":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),null;case"noop":case"no":return(this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length&&this.parseInline(e.join(" ")),null;case"temp":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),u={profile:null,name:null,pattern:null,commands:null,options:{priority:0}},e.length<2||e.length>5)throw new Error("Invalid syntax use "+n+"temp name {pattern} {commands} \x1B[3moptions profile\x1B[0;-11;-12m or "+n+"temp {pattern} {commands} \x1B[3m{options} profile\x1B[0;-11;-12m");if(e[0].length===0)throw new Error("Invalid temporary trigger or pattern");if(e[0].match(/^\{.*\}$/g))u.pattern=e.shift(),u.pattern=this.parseInline(u.pattern.substr(1,u.pattern.length-2));else{if(u.name=this.parseInline(this.stripQuotes(e.shift())),!u.name||u.name.length===0)throw new Error("Invalid temporary trigger name");e[0].match(/^\{.*\}$/g)&&(u.pattern=e.shift(),u.pattern=this.parseInline(u.pattern.substr(1,u.pattern.length-2)))}if(e.length!==0){if(e[0].match(/^\{[\s\S]*\}$/g)&&(u.commands=e.shift(),u.commands=u.commands.substr(1,u.commands.length-2)),e.length===1)if(e[0].match(/^\{[\s\S]*\}$/g)?e[0]=e[0].substr(1,e[0].length-2):e[0]=this.stripQuotes(e[0]),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(b=>{switch(b.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":u.options[b.trim()]=!0;break;default:if(b.trim().startsWith("param=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger param option '${b.trim()}'`);u.options.params=f[1]}else if(b.trim().startsWith("type=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger type option '${b.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid temporary trigger type");u.options.type=f[1]}else if(b.trim().startsWith("pri=")||b.trim().startsWith("priority=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger priority option '${b.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid temporary trigger priority value '"+f[1]+"' must be a number");u.options.priority=l}else throw new Error(`Invalid temporary trigger option '${b.trim()}'`)}});else throw new Error("Invalid temporary trigger options");else if(e.length===2){if(e[0].match(/^\{[\s\S]*\}$/g)&&(e[0]=e[0].substr(1,e[0].length-2)),e[0].length!==0)this.parseInline(e[0]).split(",").forEach(b=>{switch(b.trim()){case"nocr":case"prompt":case"case":case"verbatim":case"disable":case"enable":case"cmd":case"raw":case"pattern":case"regular":case"alarm":case"event":case"cmdpattern":case"loopexpression":u.options[b.trim()]=!0;break;default:if(b.trim().startsWith("param=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger param option '${b.trim()}'`);u.options.params=f[1]}else if(b.trim().startsWith("type=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger type option '${b.trim()}'`);if(!this.isTriggerType(f[1],1))throw new Error("Invalid temporary trigger type");u.options.type=f[1]}else if(b.trim().startsWith("pri=")||b.trim().startsWith("priority=")){if(f=b.trim().split("="),f.length!==2)throw new Error(`Invalid temporary trigger priority option '${b.trim()}'`);if(l=parseInt(f[1],10),isNaN(l))throw new Error("Invalid temporary trigger priority value '"+f[1]+"' must be a number");u.options.priority=l}else throw new Error(`Invalid temporary trigger option '${b.trim()}'`)}});else throw new Error("Invalid temporary trigger options");u.profile=this.stripQuotes(e[1]),u.profile.length!==0&&(u.profile=this.parseInline(u.profile))}}return u.options.temporary=!0,this.createTrigger(u.pattern,u.commands,u.profile,u.options,u.name),null;case"wrap":case"wr":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e=e.filter(b=>b),e.length>1)throw new Error("Invalid syntax use \x1B[4m"+n+"wr\x1B[0;-11;-12map or \x1B[4m"+n+"wr\x1B[0;-11;-12map number");if(e.length===0)this.client.setOption("display.wordWrap",!this.client.getOption("display.wordWrap")),this.client.display.wordWrap=this.client.getOption("display.wordWrap");else{if(l=parseInt(this.parseInline(e[0]),10),isNaN(l))throw new Error("Invalid number '"+l+"' for wrap");if(l<0)throw new Error("Must be greater then or equal to zero for wrap");this.client.setOption("display.wordWrap",!0),this.client.setOption("display.wordWrap",l),this.client.display.wordWrap=!0,this.client.display.wrapAt=l}return null;case"prompt":case"pr":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0||e.length>4)throw new Error("Invalid syntax use \x1B[4m"+n+"pr\x1B[0;-11;-12mompt variable \x1B[3mmessage defaultValue mask\x1B[0;-11;-12m");if(l=e.shift(),l.match(/^\{.*\}$/g)&&(l=l.substr(1,l.length-2)),l=this.parseInline(l),!ke(l))throw new Error("Invalid variable name");return e=e.map(b=>this.parseInline(this.stripQuotes(b))),e.length===3&&e[2]&&e[2].toLowerCase()==="true"&&(e[2]=!0),e=window.prompt(...e),e?.match(/^\s*?[-|+]?\d+\s*?$/)?this.client.variables[l]=parseInt(e,10):e?.match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?this.client.variables[l]=parseFloat(e):e==="true"?this.client.variables[l]=!0:e==="false"?this.client.variables[l]=!1:this.client.variables[l]=e,null;case"setmap":if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),e.length===0)throw new Error("Invalid syntax use "+n+"setmap file \x1B[3msetCharacter\x1B[0;-11;-12m");if(f=this.stripQuotes(this.parseInline(e.shift()))||"",!f||!f.length)throw new Error("Empty file\x1B[0;-11;-12m");return e.length>1?x=this.stripQuotes(this.parseInline(e.join(" "))).toLocaleLowerCase().trim():x="",this.emit("setmap",f,x==="true"||x==="yes",!0),null}if(t.match(/^[-|+]?\d+$/)){if((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),l=parseInt(t,10),e.length===0)throw new Error("Invalid syntax use "+n+"nnn commands");return e=e.join(" "),e.match(/^\{[\s\S]*\}$/g)&&(e=e.substr(1,e.length-2)),l<1?this.executeForLoop(-l+1,1,e):this.executeForLoop(0,l,e)}let k={name:t,args:e,raw:i,handled:!1,return:null};return this.client.emit("function",k),k.handled?((this.client.getOption("echo")&4)===4&&this.client.echo(i,-3,-4,!0,!0),k.return):k.raw.startsWith(n)?n+this.parseOutgoing(k.raw.substr(1),null,null,null,!0):this.parseOutgoing(k.raw+`
`,null,null,null,!0)}executeForLoop(t,e,i){let n=[],s;if(t>e)for(s=t-1;s>=e;s--){this.loops.push(s);try{let o=this.parseOutgoing(i);if(o!=null&&o.length>0&&n.push(o),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}catch(o){throw o}finally{this.loops.pop()}}else for(s=t;s<e;s++){this.loops.push(s+1);try{let o=this.parseOutgoing(i);if(o!=null&&o.length>0&&n.push(o),this.stack.continue){this.stack.continue=!1;continue}if(this.stack.break){this.stack.break--;break}}catch(o){throw o}finally{this.loops.pop()}}return n.length>0?n.map(o=>o.trim()).join(`
`):null}parseInline(t){return this.parseOutgoing(t,!1,null,!1,!0)}parseOutgoing(t,e,i,n,s,o){let r=t.length;if(!this.enableParsing||t==null||r===0)return t;let a="",l="",f,c=0,y=this.client.aliases,u=this.client.getOption("commandStackingChar"),x=this.client.getOption("speedpathsChar"),S=this.client.getOption("enableSpeedpaths"),m=this.client.getOption("enableCommands"),g=this.client.getOption("commandChar"),T=this.client.getOption("allowEscape"),I=this.client.getOption("escapeChar"),k=this.client.getOption("verbatimChar"),H=this.client.getOption("enableVerbatim"),C=this.client.getOption("enableDoubleParameterEscaping"),_=this.client.getOption("parametersChar"),b=this.client.getOption("enableParameters"),d=this.client.getOption("nParametersChar"),v=this.client.getOption("enableNParameters"),N=this.client.getOption("allowEval"),J=this.client.getOption("ignoreEvalUndefined"),se=this.client.getOption("enableInlineComments")&&!o,oe=this.client.getOption("enableBlockComments")&&!o,ee=this.client.getOption("inlineCommentString").split(""),L=this.client.getOption("blockCommentString").split(""),P=this.client.getOption("ignoreInputLeadingWhitespace"),G="",M=[],E="",D=!0,B="",V,w,K,O=0,R,A,z=!0,re=!1,ce=!1,he=!1,ae=0,Le=this.client.getOption("parseDoubleQuotes"),me=this.client.getOption("parseSingleQuotes");for(e==null?e=y.length>0:e=e&&y.length>0,u.length===0?i=!1:i==null?i=this.client.getOption("commandStacking"):i=i&&this.client.getOption("commandStacking"),O=0;O<r;O++)switch(w=t.charAt(O),c){case 1:T&&w===I?c=27:(w==='"'&&Le&&(c=0),e&&D?l+=w:a+=w),z=!1;break;case 27:c=1,w!=='"'&&w!==I?(O--,e&&D?l+=I:a+=I):e&&D?l+=w:a+=w;break;case 2:T&&w===I?c=27:(w==="'"&&me&&(c=0),e&&D?l+=w:a+=w),z=!1;break;case 28:c=2,w!=="'"&&w!==I?(O--,e&&D?l+=I:a+=I):e&&D?l+=w:a+=w;break;case 3:if(w==='"'&&Le)E+=w,c=4,z=!1;else if(w==="'"&&me)E+=w,c=5,z=!1;else if(T&&w===I)c=17,z=!1;else if(O===r-1||w===`
`||i&&w===u){for(w===`
`||i&&w===u||(E+=w),E.length>0&&M.push(this.parseInline(E)),K=f.length,V=0;V<K;V++){if(a=this.ExecuteAlias(f[V],M),typeof a=="number")return a>=0&&this.executeWait(t.substr(O+1),a,e,i,n,s,o),B.length===0?null:B;if(a!==null&&(B+=a),a="",!V.multi)break;if(this.stack.continue||this.stack.break)return B.length===0?null:B}l="",c=0,f=null,z=!0}else w===" "?(M.push(this.parseInline(E)),E="",z=!1):(E+=w,z=!1);break;case 4:w==='"'&&(c=3),E+=w,z=!1;break;case 5:w==="'"&&(c=3),E+=w,z=!1;break;case 17:c=3,w===I||i&&w===u||H&&w===k||S&&w===x||m&&w===g||C&&w===_||v&&w===d?E+=w:se&&w==ee[0]||oe&&w==L[0]?A=w:`"'{`.indexOf(w)!==-1?E+=w:E+=I+w;break;case 6:if(T&&w===I)c=18,z=!1;else if(w===`
`||i&&w===u){if(c=0,a=this.ProcessPath(a),a!==null&&(B+=a),a="",z=!0,this.stack.continue||this.stack.break)return B.length===0?null:B}else O===1&&w===x?(c=0,O--,z=!1):(a+=w,z=!1);break;case 18:c=6,w===I||i&&w===u||H&&w===k||S&&w===x||m&&w===g||C&&w===_||v&&w===d?a+=w:se&&w==ee[0]||oe&&w==L[0]?A=w:`"'{`.indexOf(w)!==-1?a+=w:a+=I+w;break;case 7:if(w==="{")z=!1,a+=w,ae++;else if(w==="}")z=!1,a+=w,ae--;else if(ae===0&&T&&w===I)c=19,z=!1;else if(ae===0&&(w===`
`||i&&w===u)){if(c=0,a=this.executeScript(g+a),typeof a=="number")return a>=0&&this.executeWait(t.substr(O+1),a,e,i,n,s,o),B.length===0?null:B;if(a!==null&&(B+=G+a+`
`),this.stack.continue||this.stack.break)return B.length===0?null:B;a="",z=!0}else a+=w,z=!1;break;case 19:c=7,a+=I+w;break;case 8:if(w==="{"&&E.length===0){c=9;continue}switch(w){case _:E.length===0&&(e&&D?l+=_:a+=_,c=0,C||O--);break;case"*":if(E.length===0){this.stack.args?(e&&D?l+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):e&&D?l+=_+"*":a+=_+"*",c=0;break}case"-":if(E.length===0){re=!0;break}else if(ce&&E.length==1){re=!0;break}else he=!0;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":if(!he){E+=w;break}case"x":if(!he&&E.length===0){ce=!0;break}default:if(this.stack.args&&E.length>0)R=parseInt(E,10),ce?re&&this.stack.args.indices&&R<this.stack.args.length?R=this.stack.indices.slice(R).map(Q=>Q?Q[0]+" "+Q[1]:"0 0").join(" "):this.stack.args.indices&&R<this.stack.args.length?R=this.stack.args.indices[R]?this.stack.args.indices[R][0]+" "+this.stack.args.indices[R][1]:"0 0":re?R=_+"x-"+R:R=_+"x"+R:(re&&R<this.stack.args.length?R=this.stack.args.slice(E).join(" "):R<this.stack.args.length?R=this.stack.args[R]:re?R=_+"-"+R:R=_+R,re?this.stack.used=this.stack.args.length:E>this.stack.used&&(this.stack.used=parseInt(E,10))),e&&D?l+=R:a+=R,O--;else{if(E.length===0&&this.loops.length>0&&(R=w.charCodeAt(0)-105,R>=0&&R<18&&R<this.loops.length)){e&&D?l+=this.loops[R]:a+=this.loops[R],c=0;break}e&&D?(l+=_,re&&(l+="-"),ce&&(l+="x")):(a+=_,re&&(a+="-"),ce&&(a+="x")),O=O-E.length-1}c=0,E="";break}break;case 26:w.match(/[^a-zA-Z0-9_]/g)?(this.stack.named.hasOwnProperty(E)?e&&D?l+=this.stack.named[E]:a+=this.stack.named[E]:e&&D?l+=_+E:a+=_+E,O--,c=0,E=""):E+=w;break;case 9:w==="}"&&ae===0?(E==="i"?A=this.loops[0]:E==="repeatnum"?A=this.repeatnum:this.stack.args&&E==="*"?(A=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):this.stack.named&&this.stack.named.hasOwnProperty(E)?A=this.stack.named[E]:this.stack.args&&!isNaN(E)?(R=parseInt(E,10),R<0?-R>=this.stack.args.length?N?A=R:(A=_,O=O-R.length-2):(A=this.stack.args.slice(R).join(" "),this.stack.used=this.stack.args.length):R<this.stack.args.length?(A=this.stack.args[R],E>this.stack.used&&(this.stack.used=R)):N?A=R:(A=_,O=O-E.length-2)):this.stack.args&&this.stack.args.indices&&E.match(/^x[-|+]?\d+$/)?(R=parseInt(E.substring(1),10),R<0?-R>=this.stack.args.length?(A=_,O=O-R.length-2):A=this.stack.indices.slice(R).map(Q=>Q?Q[0]+" "+Q[1]:"0 0").join(" "):R<this.stack.args.length?A=this.stack.args.indices[R]?this.stack.args.indices[R][0]+" "+this.stack.args.indices[R][1]:"0 0":(A=_,O=O-E.length-2)):(R=this.parseVariable(E),R!=null?A=R:N?(A=this.evaluate(this.parseInline(E)),J&&typeof A>"u"?A=null:A=""+A):(A=_,O=O-E.length-2)),A!=null&&e&&D?l+=A:A!=null&&(a+=A),c=0,E=""):w==="{"?(ae++,E+=w):(w==="}"&&ae--,E+=w);break;case 11:w==="{"?c=12:w.match(/[^a-zA-Z_$]/g)?(c=0,O--,e&&D?l+=d:a+=d):(E=w,c=14);break;case 14:w.match(/[^a-zA-Z0-9_]/g)?(this.stack.named&&this.stack.named.hasOwnProperty(E)?e&&D?l+=this.stack.named[E]:a+=this.stack.named[E]:this.client.variables.hasOwnProperty(E)?e&&D?l+=this.client.variables[E]:a+=this.client.variables[E]:e&&D?l+=d+E:a+=d+E,O--,c=0,E=""):E+=w;break;case 12:w==="}"&&ae===0?(A=null,E==="i"?A=this.loops[0]:E==="repeatnum"?A=this.repeatnum:this.stack.args&&E==="*"?(A=this.stack.args.slice(1).join(" "),this.stack.used=this.stack.args.length):this.stack.named&&this.stack.named.hasOwnProperty(E)?A=this.stack.named[E]:this.stack.args&&!isNaN(E)?(R=parseInt(E,10),R<0?-R>=this.stack.args.length?N?A=R:(A=d,O=O-E.length-2):(A=this.stack.args.slice(R).join(" "),this.stack.used=this.stack.args.length):R<this.stack.args.length?(A=this.stack.args[R],R>this.stack.used&&(this.stack.used=R)):N?A=R:(A=d,O=O-E.length-2)):this.stack.args&&this.stack.args.indices&&E.match(/^x[-|+]?\d+$/)?(R=parseInt(E.substring(1),10),R<0?-R>=this.stack.args.length?(A=d,O=O-E.length-2):A=this.stack.indices.slice(R).map(Q=>Q?Q[0]+" "+Q[1]:"0 0").join(" "):R<this.stack.args.length?A=this.stack.args.indices[R]?this.stack.args.indices[R][0]+" "+this.stack.args.indices[R][1]:"0 0":(A=d,O=O-E.length-2)):(w=this.parseVariable(E),w!=null?A=w:N?(A=this.evaluate(this.parseInline(E)),J&&typeof A>"u"?A=null:A=""+A):(A=d,O=O-E.length-2)),A!=null&&e&&D?l+=A:A!=null&&(a+=A),c=0,E=""):w==="{"?(ae++,E+=w):(w==="}"&&ae--,E+=w);break;case 15:w===I||i&&w===u||H&&w===k||S&&w===x||m&&w===g||C&&w===_||v&&w===d||se&&w==ee[0]||oe&&w==L[0]||`"'{`.indexOf(w)!==-1?A=w:A=I+w,e&&D?l+=A:a+=A,c=0;break;case 16:w===`
`?(c=0,B+=a+w,a="",z=!0):(a+=w,z=!1);break;case 20:se&&w===ee[1]?c=22:oe&&w===L[1]?c=24:(c=0,e&&D?l+=ee[0]:a+=ee[0],O--);break;case 21:w===ee[1]?c=22:(c=0,e&&D?l+=ee[0]:a+=ee[0],O--);break;case 23:oe&&w===L[1]?c=25:(c=0,e&&D?l+=L[0]:a+=L[0],O--);break;case 22:w===`
`&&(c=0,z?(l="",D=!0,z=!0):O--);break;case 24:L.length===1?w===L[0]&&(c=0):w===L[1]&&(c=25);break;case 25:w===L[0]?c=0:c=24;break;default:if((se||oe)&&w===ee[0]&&w===L[0]){se&&ee.length===1?c=22:oe&&L.length===1?c=24:c=20;continue}else if(se&&w===ee[0]){ee.length===1?c=22:c=21;continue}else if(oe&&w===L[0]){L.length===1?c=24:c=23;continue}else if(T&&w===I){c=15,z=!1;continue}else if(b&&w===_)c=8,re=!1,ce=!1,he=!1,E="",z=!1;else if(v&&w===d)c=11,re=!1,ce=!1,he=!1,E="",z=!1;else if(!s&&m&&z&&w===g)c=7,z=!1,l.length?(G=l,l=""):(G=a||"",a="");else if(H&&z&&w===k)c=16,z=!1;else if(S&&z&&w===x)c=6,z=!1;else if(w==='"'&&Le)e&&D?l+=w:a+=w,c=1,z=!1;else if(w==="'"&&me)e&&D?l+=w:a+=w,c=2,z=!1;else if(z&&P&&(w===" "||w==="	"||w==="\f"||w==="\r"||w==="\v"||w===" "||w==="\xA0"||w==="\u1680"||w==="\u2000-"||w==="\u200A"||w==="\u2028"||w==="\u2029"||w==="\u202F"||w==="\u205F"||w==="\u3000"||w==="\uFEFF"))e&&D?l+=w:a+=w;else if(e&&D&&w===" ")f=We(y,"pattern",P?l.trimStart():l),f.length>0?(c=3,M.length=0,E="",M.push(P?l.trimStart():l)):(a+=l+" ",l="",f=null),D=!1,z=!1;else if(w===`
`||i&&w===u){if(e&&D&&l.length>0)if(f=We(y,"pattern",P?l.trimStart():l),f.length>0){for(M.push(P?l.trimStart():l),K=f.length,V=0;V<K;V++){if(a=this.ExecuteAlias(f[V],M),typeof a=="number")return a>=0&&this.executeWait(t.substr(O+1),a,e,i,n,s,o),B.length===0?null:B;if(a!==null&&(B+=a),!V.multi)break;if(this.stack.continue||this.stack.break)return B.length===0?null:B}a="",M.length=0,E=""}else{if(a=this.ExecuteTriggers(17,l,l,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(O+1),a,e,i,n,s,o),B.length===0?null:B;a!==null&&(B+=a+`
`),a="",f=null}else{if(a=this.ExecuteTriggers(17,a,a,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(O+1),a,e,i,n,s,o),B.length===0?null:B;a!==null&&(B+=a+`
`),a=""}if(this.stack.continue||this.stack.break)return B.length===0?null:B;l="",D=!0,z=!0}else e&&D?(l+=w,z=!1):(a+=w,z=!1);break}if(c===15?a+=I:c===14&&E.length>0?this.stack.named&&this.stack.named[E]?a+=this.stack.named[E]:this.client.variables.hasOwnProperty(E)?a+=this.client.variables[E]:(E=this.parseInline(E),a+=d,E!=null&&(a+=E)):c===8&&E.length>0?this.stack.args?(E=parseInt(E,10),ce&&this.stack.args.indices&&E<this.stack.args.length?a+=this.stack.args.indices[E]?this.stack.args.indices[E][0]+" "+this.stack.args.indices[E][1]:"0 0":(re&&E<this.stack.args.length?a+=this.stack.args.slice(E).join(" "):E<this.stack.args.length&&(a+=this.stack.args[E]),re?this.stack.used=this.stack.args.length:E>this.stack.used&&(this.stack.used=E))):(E=this.parseInline(E),a+=_,re&&(a+="-"),ce&&(a+="x"),E!=null&&(a+=E)):c===9?(E=this.parseInline(E),a+=_+"{",E!=null&&(a+=E)):c===11&&E.length>0?this.stack.named?this.stack.named.hasOwnProperty(E)?a+=this.stack.named[E]:(E=this.parseInline(E),a+=d,E!=null&&(a+=E)):(E=this.parseInline(E),a+=d,E!=null&&(a+=E)):c===12?(E=this.parseInline(E),a+=`${d}{`,E!=null&&(a+=E)):c===6?(a=this.ProcessPath(a),a!==null&&(B+=a),a=""):c===20||c===21?(a+=ee[0],O--):c===23&&(a+=L[0],O--),!s&&c===7){if(a=this.executeScript(g+a),typeof a=="number")return a>=0&&this.executeWait(t.substr(O+1),a,e,i,n,s,o),B.length===0?null:B;if(a!==null){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let Q=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),Q=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,Q&&(a+=`
`)}B+=G+a}else if(B.length===0)return null;if(this.stack.continue||this.stack.break)return B.length===0?null:B}else if(c===16){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let Q=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),Q=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,Q&&(a+=`
`)}B+=a}else if(l.length>0&&e&&D){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let Q=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),Q=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,Q&&(a+=`
`)}if(a.length>0&&(l+=a),f=We(y,"pattern",P?l.trimStart():l),f.length>0)for(M.push(P?l.trimStart():l),K=f.length,V=0;V<K;V++){if(a=this.ExecuteAlias(f[V],M),typeof a=="number")return a>=0&&this.executeWait(t.substr(O+1),a,e,i,n,s,o),B.length===0?null:B;if(a!==null)B+=a;else if(B.length===0)return null;if(this.stack.continue||this.stack.break)return B;if(!V.multi)break}else{if(a=this.ExecuteTriggers(17,l,l,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(O+1),a,e,i,n,s,o),B.length===0?null:B;if(a!==null)B+=a;else if(B.length===0)return null;if(this.stack.continue||this.stack.break)return B}f=null}else if(l.length>0){if(a.length>0&&(l+=a),a=this.ExecuteTriggers(17,l,l,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(O+1),a,e,i,n,s,o),B.length===0?null:B;if(a!==null){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let Q=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),Q=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),this.stack.used=this.stack.args.length,Q&&(a+=`
`)}B+=a}else if(B.length===0)return null;if(this.stack.continue||this.stack.break)return B.length===0?null:B}else if(a.length>0){if(a=this.ExecuteTriggers(17,a,a,!1,!0),typeof a=="number")return a>=0&&this.executeWait(t.substr(O+1),a,e,i,n,s,o),B.length===0?null:B;if(a!==null){if(n&&e&&this.stack.args&&this.stack.append&&this.stack.args.length-1>0&&this.stack.used+1<this.stack.args.length){let Q=!1;a.endsWith(`
`)&&(a=a.substring(0,a.length-1),Q=!0),a.endsWith(" ")||(a+=" "),this.stack.used<1?a+=this.stack.args.slice(1).join(" "):a+=this.stack.args.slice(this.stack.used+1).join(" "),Q&&(a+=`
`)}B+=a}else if(B.length===0)return null;if(this.stack.continue||this.stack.break)return B.length===0?null:B}return M.length=0,M=null,E=null,l=null,B}parseVariable(t){let e;switch(t){case"esc":return"\x1B";case"cr":return`
`;case"lf":return"\r";case"crlf":return`\r
`;case"copied":return window.$copied;case"copied.lower":return window.$copied.toLowerCase();case"copied.upper":return window.$copied.toUpperCase();case"copied.proper":return pt(window.$copied);case"i":return this.loops[0];case"repeatnum":return this.vStack.$repeatnum||this.repeatnum;case"character":return window.$character;case"character.lower":return window.$character.toLowerCase();case"character.upper":return window.$character.toUpperCase();case"character.proper":return pt(window.$character);case"selected":case"selectedurl":case"selectedline":case"selectedword":case"selurl":case"selline":case"selword":case"action":case"trigger":return this.vStack["$"+t]||window["$"+t]||"";case"selected.lower":case"selectedurl.lower":case"selectedline.lower":case"selectedword.lower":case"selurl.lower":case"selline.lower":case"selword.lower":return(this.vStack["$"+t.substr(0,t.length-6)]||window["$"+t.substr(0,t.length-6)]||"").toLowerCase();case"selected.upper":case"selectedurl.upper":case"selectedline.upper":case"selectedword.upper":case"selurl.upper":case"selline.upper":case"selword.upper":return(this.vStack["$"+t.substr(0,t.length-6)]||window["$"+t.substr(0,t.length-6)]||"").toUpperCase();case"selected.proper":case"selectedurl.proper":case"selectedline.proper":case"selectedword.proper":case"selurl.proper":case"selline.proper":case"selword.proper":return pt(this.vStack["$"+t.substr(0,t.length-7)]||window["$"+t.substr(0,t.length-7)]);case"random":return et().randomInt(0,100)}if(ct.indexOf(t)!==-1)return this.vStack["$"+t]||window["$"+t]||"";if(this.loops.length&&t.length===1){let y=t.charCodeAt(0)-105;if(y>=0&&y<18&&y<this.loops.length)return this.loops[y]}let n=new RegExp("^([a-zA-Z]+)\\((.*)\\)$","g").exec(t);if(!n||!n.length){let y={raw:t,name:t,args:[],handled:!1,return:null};return this.client.emit("variable",y),y.handled?y.return:null}let s,o,r,a,l,f=this.client.getOption("allowEscape")?this.client.getOption("escapeChar"):"";switch(n[1]){case"time":return moment?n[2]&&n[2].length>0?moment().format(this.stripQuotes(this.parseInline(n[2]))):moment().format():new Date().toISOString();case"clip":return n[2]&&n[2].length>0?(this.client.writeClipboard(this.stripQuotes(this.parseInline(n[2]))),null):this.client.readClipboard();case"lower":return this.stripQuotes(this.parseInline(n[2]).toLowerCase());case"upper":return this.stripQuotes(this.parseInline(n[2]).toUpperCase());case"proper":return pt(this.stripQuotes(this.parseInline(n[2])));case"eval":return r=this.evaluate(this.parseInline(n[2])),this.client.getOption("ignoreEvalUndefined")&&typeof r>"u"?null:""+r;case"dice":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid dice");if(r.length===1){if(n=/(\d+)\s*?d(F|f|%|\d+)(\s*?[-|+|*|\/]?\s*?\d+)?/g.exec(r[0]),!n||n.length<3)return null;e=parseInt(n[1]),s=n[2],n.length>3&&(o=n[3])}else if(r.length<4)e=parseInt(r[0]),s=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for dice");s==="F"||s==="f"?s="F":s!=="%"&&(s=parseInt(s));let y=0;for(let S=0;S<e;S++)s==="F"||s==="f"?y+=ii():s==="%"?y+=~~(Math.random()*100)+1:y+=~~(Math.random()*s)+1;return s==="%"&&(y/=100),o?this.evaluate(y+o):""+y;case"diceavg":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid dice for diceavg");if(r.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!n||n.length<3)return null;e=parseInt(n[1]),s=n[2],n.length>3&&(o=n[3])}else if(r.length<4)e=parseInt(r[0]),s=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for diceavg");return a=1,s==="F"||s==="f"?(a=-1,l=1):s==="%"?(a=0,l=1):l=parseInt(s),o?this.evaluate((a+l)/2*e+o):""+(a+l)/2*e;case"dicemin":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid dice for dicemin");if(r.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!n||n.length<3)return null;e=parseInt(n[1]),s=n[2],n.length>3&&(o=n[3])}else if(r.length<4)e=parseInt(r[0]),s=r[1].trim(),r.length>2&&(o=r[2]);else throw new Error("Too many arguments for dicemin");return a=1,s==="F"||s==="f"?a=-1:s==="%"&&(a=0),o?this.evaluate(a*e+o):""+a*e;case"dicemax":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid dice for dicemax");if(r.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!n||n.length<3)return null;e=parseInt(n[1]),s=n[2],n.length>3&&(o=n[3])}else if(r.length<4)e=parseInt(r[0]),s=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for dicemax");return s==="F"||s==="f"||s==="%"?l=1:l=parseInt(s),o?this.evaluate(l*e+o):""+l*e;case"zdicedev":case"dicedev":let u=n[1];if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid dice for "+u);if(r.length===1){if(n=/(\d+)d(F|f|%|\d+)([-|+|*|/]?\d+)?/g.exec(r[0]),!n||n.length<3)return null;e=parseInt(n[1]),s=n[2],n.length>3&&(o=n[3])}else if(r.length<4)e=parseInt(r[0]),s=r[1].trim(),r.length>2&&(o=r[2].trim());else throw new Error("Too many arguments for "+u);return s==="F"||s==="f"?l=6:s==="%"?l=1:l=parseInt(s),u==="zdicedev"&&l--,o?this.evaluate(Math.sqrt((l*l-1)/12*e)+o):""+Math.sqrt((l*l-1)/12*e);case"color":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for color");if(r.length===1){if(r[0]==="bold")return"370";if(e=Z(r[0]),e===-1)throw new Error("Invalid fore color");return e.toString()}else if(r.length===2){if(r[0]==="bold")e=370;else{if(e=Z(r[0]),e===-1)throw new Error("Invalid fore color");if(r[1]==="bold")return(e*10).toString()}if(s=e.toString(),e=Z(r[1],!0),e===-1)throw new Error("Invalid back color");return s+","+e.toString()}else if(r.length===3){if(r[0]==="bold"&&(r.shift(),r.push("bold")),r[2]!=="bold")throw new Error("Only bold is supported as third argument for color");if(e=Z(r[0]),e===-1)throw new Error("Invalid fore color");if(s=(e*10).toString(),e=Z(r[1],!0),e===-1)throw new Error("Invalid back color");return s+","+e.toString()}throw new Error("Too many arguments");case"zcolor":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for zcolor");if(r.length>1)throw new Error("Too many arguments for zcolor");return Ft(parseInt(r[0],10));case"ansi":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for ansi");for(e=r.length,o=[],a={},s=0;s<e;s++)if(r[s].trim()==="current")o.push(r[s].trim());else{if(l=_e(r[s].trim()),l===-1)throw new Error("Invalid color or style for ansi");l>=0&&l<30?a[l]=1:o.push(r[s])}if(o.length>2)throw new Error("Too many colors for ansi");if(o.length>1&&(o[1]==="current"?o[1]="":o[1]=_e(o[1],!0)),o.length>0&&(a[1]&&o[0]==="white"||o[0]==="current"?o[0]="":o[0]=_e(o[0])),a=[...Object.keys(a),...o],!a.length)throw new Error("Invalid colors or styles for ansi");return a=a.filter(S=>S!==""),`\x1B[${a.join(";")}m`;case"random":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Invalid random");if(r.length===1)return et().randomInt(0,parseInt(r[0],10)+1);if(r.length===2)return et().randomInt(parseInt(r[0],10),parseInt(r[1],10)+1);throw new Error("Too many arguments for random");case"case":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for case");return e=this.evaluate(this.parseInline(r[0])),typeof e!="number"?"":e>0&&e<r.length?this.stripQuotes(r[e]):"";case"switch":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for switch");if(r.length%2===1)throw new Error("All expressions must have a value for switch");for(s=r.length,e=0;e<s;e+=2)if(this.evaluate(r[e]))return this.stripQuotes(r[e+1]);return"";case"if":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length<3)throw new Error("Missing arguments for if");if(r.length!==3)throw new Error("Too many arguments for if");return this.evaluate(r[0])?this.stripQuotes(r[1].trim()):this.stripQuotes(r[2].trim());case"ascii":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for ascii");if(r.length>1)throw new Error("Too many arguments for ascii");if(r[0].trim().length===0)throw new Error("Invalid argument, empty string for ascii");return r[0].trim().charCodeAt(0);case"char":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for char");if(r.length>1)throw new Error("Too many arguments for char");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for char");return String.fromCharCode(e);case"begins":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length<2)throw new Error("Missing arguments for begins");if(r.length>2)throw new Error("Too many arguments for begins");return this.stripQuotes(r[0]).startsWith(this.stripQuotes(r[1]));case"ends":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length<2)throw new Error("Missing arguments for ends");if(r.length>2)throw new Error("Too many arguments for ends");return this.stripQuotes(r[0]).endsWith(this.stripQuotes(r[1]));case"len":return this.stripQuotes(this.parseInline(n[2])).length;case"stripansi":let x=new RegExp("[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))","g");return this.stripQuotes(this.parseInline(n[2])).replace(x,"");case"pos":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length<2)throw new Error("Missing arguments for pos");if(r.length>2)throw new Error("Too many arguments for pos");return this.stripQuotes(r[1]).indexOf(this.stripQuotes(r[0]))+1;case"ipos":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length<2)throw new Error("Missing arguments for ipos");if(r.length>2)throw new Error("Too many arguments for ipos");return this.stripQuotes(r[1]).toLowerCase().indexOf(this.stripQuotes(r[0]).toLowerCase())+1;case"regex":if(r=this.splitByQuotes(n[2],","),r.length<2)throw new Error("Missing arguments for regex");if(e=new RegExp(this.stripQuotes(r[1]),"gd"),e=e.exec(this.stripQuotes(this.parseInline(r[0]))),r.shift(),r.shift(),e==null||e.length===0)return 0;if(r.length){for(s=1;s<e.length&&r.length;s++)this.client.variables[this.stripQuotes(this.parseInline(r[0]))]=e[s],r.shift();r.length&&(this.client.variables[this.stripQuotes(this.parseInline(r[0]))]=e[0].length)}return e.indices[0]?e.indices[0][0]+1:1;case"trim":return this.stripQuotes(this.parseInline(n[2])).trim();case"trimleft":return this.stripQuotes(this.parseInline(n[2])).trimLeft();case"trimright":return this.stripQuotes(this.parseInline(n[2])).trimRight();case"bitand":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitand");if(r.length!==2)throw new Error("Too many arguments for bitand");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitand");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitand");return e&s;case"bitnot":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitnot");if(r.length!==1)throw new Error("Too many arguments for bitnot");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitnot");return~e;case"bitor":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitor");if(r.length!==2)throw new Error("Too many arguments for bitor");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitor");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitor");return e|s;case"bitset":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitset");if(r.length>3)throw new Error("Too many arguments for bitset");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitset");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitset");if(s--,o=1,r.length===3&&(o=parseInt(r[2],10),isNaN(o)))throw new Error("Invalid argument '"+r[2]+"' must be a number for bitset");return e&~(1<<s)|(o?1:0)<<s;case"bitshift":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitshift");if(r.length!==2)throw new Error("Too many arguments for bitshift");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitshift");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitshift");return s<0?e>>-s:e<<s;case"bittest":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bittest");if(r.length!==2)throw new Error("Too many arguments for bittest");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bittest");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bittest");return s--,(e>>s)%2!=0?1:0;case"bitxor":if(r=this.parseInline(n[2]).split(","),r.length===0)throw new Error("Missing arguments for bitxor");if(r.length!==2)throw new Error("Too many arguments for bitxor");if(e=parseInt(r[0],10),isNaN(e))throw new Error("Invalid argument '"+r[0]+"' must be a number for bitxor");if(s=parseInt(r[1],10),isNaN(s))throw new Error("Invalid argument '"+r[1]+"' must be a number for bitxor");return e^s;case"number":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for number");if(r.length>1)throw new Error("Too many arguments for number");return r[0]=this.stripQuotes(r[0],!0),r[0].match(/^\s*?[-|+]?\d+\s*?$/)?parseInt(r[0],10):r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(r[0]):r[0]==="true"?1:(r[0]==="false",0);case"isfloat":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for isfloat");if(r.length>1)throw new Error("Too many arguments for isfloat");return r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0;case"isnumber":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for isnumber");if(r.length>1)throw new Error("Too many arguments for isnumber");return r[0].match(/^\s*?[-|+]?\d+\s*?$/)||r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?1:0;case"string":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for string");if(r.length>1)throw new Error("Too many arguments for string");return`"${this.stripQuotes(r[0]),!0}"`;case"float":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for float");if(r.length>1)throw new Error("Too many arguments for float");return r[0]=this.stripQuotes(r[0],!0),r[0].match(/^\s*?[-|+]?\d+\s*?$/)||r[0].match(/^\s*?[-|+]?\d+\.\d+\s*?$/)?parseFloat(r[0]):r[0]==="true"?1:(r[0]==="false",0);case"isdefined":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for isdefined");if(r.length>1)throw new Error("Too many arguments for isdefined");return r[0]=this.stripQuotes(r[0],!0),this.client.variables.hasOwnProperty(r[0])?1:0;case"defined":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for defined");if(r.length===1){r[0]=this.stripQuotes(r[0],!0);let S=this.client.profiles.keys,m=0,g=S.length;if(g===0)return 0;for(;m<g;m++)if(s=U(this.client.profiles.items[S[m]].aliases),s=s.find(T=>T.pattern===r[0]),s||(s=U(this.client.profiles.items[S[m]].triggers),s=s.find(T=>T.pattern===r[0]||T.name===r[0]),s)||(s=U(this.client.profiles.items[S[m]].macros),s=s.find(T=>Je(T).toLowerCase()===r[0].toLowerCase()||T.name===r[0]),s)||(s=U(this.client.profiles.items[S[m]].aliases),s=s.find(T=>T.caption===r[0]||T.name===r[0]),s))return 1;return this.client.variables.hasOwnProperty(r[0])}else if(r.length===2){r[0]=this.stripQuotes(r[0],!0),r[1]=this.stripQuotes(r[1],!0).toLowerCase();let S=this.client.profiles.keys,m=0,g=S.length;if(g===0)return 0;for(;m<g;m++)switch(r[1]){case"alias":return s=U(this.client.profiles.items[S[m]].aliases),s=s.find(T=>T.pattern===r[0]),s?1:0;case"event":return s=U(this.client.profiles.items[S[m]].triggers),s=s.find(T=>T.type===2&&(T.pattern===r[0]||T.name===r[0])),s?1:0;case"trigger":return s=U(this.client.profiles.items[S[m]].triggers),s=s.find(T=>T.pattern===r[0]||T.name===r[0]),s?1:0;case"macro":return s=U(this.client.profiles.items[S[m]].macros),s=s.find(T=>Je(T).toLowerCase()===r[0].toLowerCase()||T.name===r[0]),s?1:0;case"button":return s=U(this.client.profiles.items[S[m]].aliases),s=s.find(T=>T.caption===r[0]||T.name===r[0]),s?1:0}if(r[1]==="variable")return this.client.variables.hasOwnProperty(r[0])}else throw new Error("Too many arguments for defined");return 0;case"escape":return r=this.stripQuotes(this.parseInline(n[2])),this.client.getOption("allowEscape")?(e=f,f==="\\"&&(e+=f),this.client.getOption("parseDoubleQuotes")&&(e+='"'),this.client.getOption("parseSingleQuotes")&&(e+="'"),this.client.getOption("commandStacking")&&(e+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(e+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(e+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(e+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(e+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(e+=this.client.getOption("nParametersChar")),r.replace(new RegExp(`[${e}]`,"g"),f+"$&")):r.replace(/[\\"']/g,"$&");case"unescape":return r=this.stripQuotes(this.parseInline(n[2])),this.client.getOption("allowEscape")?(e=f,f==="\\"&&(e+=f),this.client.getOption("parseDoubleQuotes")&&(e+='"'),this.client.getOption("parseSingleQuotes")&&(e+="'"),this.client.getOption("commandStacking")&&(e+=this.client.getOption("commandStackingChar")),this.client.getOption("enableSpeedpaths")&&(e+=this.client.getOption("speedpathsChar")),this.client.getOption("enableCommands")&&(e+=this.client.getOption("commandChar")),this.client.getOption("enableVerbatim")&&(e+=this.client.getOption("verbatimChar")),this.client.getOption("enableDoubleParameterEscaping")&&(e+=this.client.getOption("parametersChar")),this.client.getOption("enableNParameters")&&(e+=this.client.getOption("nParametersChar")),f==="\\"?r.replace(new RegExp(`\\\\[${e}]`,"g"),S=>S.substr(1)):r.replace(new RegExp(`${f}[${e}]`,"g"),S=>S.substr(1))):r.replace(/\\[\\"']/g,S=>S.substr(1));case"alarm":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for alarm");if(r.length>3)throw new Error("Too many arguments for alarm");if(r[0]=this.stripQuotes(r[0]),s=this.client.alarms,l=s.length,l===0)throw new Error("No alarms set.");if(e=0,r.length===1){for(;e<l;e++)if(s[e].type===3&&(s[e].name===r[0]||s[e].pattern===r[0]))return s[e].suspended?0:this.client.getRemainingAlarmTime(e)}else if(r.length===2)if(o=parseInt(r[1],10),isNaN(o)){for(r[1]=this.stripQuotes(r[1].trim());e<l;e++)if(s[e].type===3&&(s[e].name===r[0]||s[e].pattern===r[0])){if(s[e].profile.name.toUpperCase()!==r[1].toUpperCase())continue;return s[e].suspended?0:this.client.getRemainingAlarmTime(e)}throw Error("Alarm not found in profile: "+r[1]+".")}else{for(;e<l;e++)if(s[e].type===3&&(s[e].name===r[0]||s[e].pattern===r[0]))return s[e].suspended||this.client.setAlarmTempTime(e,o),o;throw Error("Alarm not found.")}else if(r.length===3){if(o=parseInt(r[1],10),isNaN(o))throw new Error("Invalid time for alarm");for(r[2]=this.stripQuotes(r[2].trim());e<l;e++)if(s[e].type===3&&(s[e].name===r[0]||s[e].pattern===r[0])){if(s[e].profile.name.toUpperCase()!==r[2].toUpperCase())continue;return s[e].suspended||this.client.setAlarmTempTime(e,o),o}throw Error("Could not set time, alarm not found in profile: "+r[2]+".")}return 0;case"state":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)throw new Error("Missing arguments for state");if(r.length>2)throw new Error("Too many arguments for state");if(r[0]=this.stripQuotes(r[0]),o=null,r.length===1){let S=this.client.profiles.keys,m=0,g=S.length;if(g===0)return null;if(g===1){if(!this.client.profiles.items[S[0]].enabled||!this.client.profiles.items[S[0]].enableTriggers)throw Error("No enabled profiles found!");s=U(this.client.profiles.items[S[m]].triggers),s=s.find(T=>T.name===r[0]||T.pattern===r[0])}else for(;m<g&&!(!(!this.client.profiles.items[S[m]].enabled||!this.client.profiles.items[S[m]].enableTriggers||this.client.profiles.items[S[m]].triggers.length===0)&&(s=U(this.client.profiles.items[S[m]].triggers),s=s.find(T=>T.name===r[0]||T.pattern===r[0]),s));m++);}else if(r.length===2){if(r[1]=this.stripQuotes(r[1].trim()),this.client.profiles.contains(r[1]))o=this.client.profiles.items[r[1].toLowerCase()];else throw new Error("Profile not found: "+r[1]);s=U(o.triggers),s=s.find(S=>S.name===r[0]||S.pattern===r[0])}if(s)return s.triggers&&s.triggers.length?s.state:0;throw new Error("Trigger not found");case"isnull":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)return null;if(r.length!==1)throw new Error("Too many arguments for null");return this.evaluate(r[0])===null?1:0;case"prompt":if(r=this.splitByQuotes(this.parseInline(n[2]),","),r.length===0)return window.prompt()||"";if(r.length>3)throw new Error("Too many arguments");return r=r.map(S=>this.stripQuotes(S)),window.prompt(...r)||""}let c={raw:t,name:n[1],args:n[2]&&n[2].length?this.parseOutgoing(n[2]).split(","):[],handled:!1,return:null};return this.client.emit("variable",c),c.handled?c.return:null}GetNamedArguments(t,e,i){if(t==="*")return e;if(i==null&&(i=!1),t==null||t.length===0)return i?e:[];let n=t.split(","),s=n.length,o=e.length;if(s===0)return i?e:[];let r;i?r=e.slice():r=[];for(let a=0;a<s;a++)n[a]=$.trim(n[a]),!(n[a].length<1)&&(n[a].startsWith("$")&&(n[a]=n[a].substring(1)),n[a].match(/^[a-zA-Z0-9_][a-zA-Z0-9_]+$/g)&&ke(n[a])&&(r[n[a]]||(r[n[a]]=a+1<o?e[a+1]:"")));return r}ExecuteAlias(t,e){if(!t.enabled)return;let i;if(t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:e,named:this.GetNamedArguments(t.params,e),append:t.append,used:0}),i=this.parseOutgoing(t.value,null,null,!0),this._stack.pop();break;case 2:(this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0);let n=this.GetNamedArguments(t.params,e);n?i=Object.keys(n).map(o=>`let ${o} = this.input.stack.named["${o}"];`).join("")+`
`:i="";let s=new Function("try { "+i+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`);this._stack.push({loops:[],args:e,named:n,append:t.append,used:0});try{i=s.apply(this.client,e)}catch(o){throw o}finally{this._stack.pop()}typeof i=="string"&&(i=this.parseOutgoing(i,null,null,!0));break;default:i=t.value;break}return i==null||i===void 0||(i=this.ExecuteTriggers(17,i,i,!1,!0),i==null||i===void 0)||(typeof i!="string"&&(i=i.toString()),i.length===0&&!this.client.getOption("returnNewlineOnEmptyValue"))?null:i.endsWith(`
`)?i:i+`
`}ProcessMacros(t,e,i,n,s){if(!t||t>9&&t<19)return!1;let o=this._MacroCache[t]||(this._MacroCache[t]=We(this.client.macros,"key",t)),r=0,a=o.length,l=0;for(e&&(l|=2),i&&(l|=4),n&&(l|=8),s&&(l|=16);r<a;r++)if(!(!o[r].enabled||l!==o[r].modifiers)&&this.ExecuteMacro(o[r]))return!0;return!1}ExecuteMacro(t){if(!t.enabled)return!1;let e;if(t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:0,named:0,used:0});try{e=this.parseOutgoing(t.value)}catch(n){throw n}finally{this._stack.pop()}break;case 2:(this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0);let i=new Function("try { "+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`);this._stack.push({loops:[],args:0,named:0,used:0});try{e=i.apply(this.client)}catch(n){throw n}finally{this._stack.pop()}break;default:e=t.value;break}return e==null||e===void 0?!0:(typeof e!="string"&&(e=e.toString()),e.length===0&&!this.client.getOption("returnNewlineOnEmptyValue")?null:(t.send?(e.endsWith(`
`)||(e+=`
`),t.chain&&this.client.commandInput.value.endsWith(" ")?(this.client.commandInput.value=this.client.commandInput.value+e,this.client.sendCommand(null,null,this.client.getOption("allowCommentsFromCommand"))):this.client.send(e,!0)):t.append&&(this.client.commandInput.value=this.client.commandInput.value+e),!0))}ProcessPath(t,e){if(t.length===0)return"";let i=[],n=0,s="",o="",r=0,a,l,f,c,y=0,u=t.length;for(;r<u;r++)switch(a=t.charAt(r),l=t.charCodeAt(r),n){case 1:l>47&&l<58?o+=a:a==="\\"?n=2:(n=0,s=a);break;case 2:l>47&&l<58?s+=a:(s+="\\",r--),n=0;break;case 3:y===0&&a===")"?n=0:(a==="("?y++:a===")"&&y--,s+=a);break;case 4:y===0&&a==="}"?n=0:(a==="{"?y++:a==="}"&&y--,s+=a);break;default:if(l>47&&l<58){if(s.length>0){for(o.length===0?f=1:f=parseInt(o,10),c=0;c<f;c++)i.push(s);s=""}n=1,o=a}else a==="("?(n=3,y=0):a==="{"?(n=4,y=0):a==="\\"?n=2:s+=a;break}if(s.length>0)for(o.length===0?f=1:f=parseInt(o,10),c=0;c<f;c++)i.push(s);return e&&this._pathQueue.length?this._pathQueue[0]={id:t,current:i,previous:[]}:this._pathQueue.push({id:t,current:i,previous:[]}),this.ExecutePath(),null}ExecutePath(){if(this._pathTimeout||!this._pathQueue.length||this._pathPaused)return;let t=this.client.getOption("pathDelay");t<0&&(t=0),this._pathTimeout=setTimeout(()=>{let e=this.client.getOption("parseSpeedpaths"),i=this.client.getOption("echoSpeedpaths"),n=this.client.getOption("pathDelayCount");n<1&&(n=1);let s=this._pathQueue[0];for(;n--;){let o=s.current.shift();if(s.previous.push(o),e?this.client.sendBackground(o+`
`,!i):this.client.send(o+`
`,!i),!s.current.length)break}s.current.length||this._pathQueue.shift(),this._pathTimeout=null,!(this._pathQueue.length&&this._pathQueue[0].manual)&&this.ExecutePath()},t)}toggleScrollLock(){this.scrollLock=!this.scrollLock}hasTriggerType(t,e){return e===3&&(t&32)==32||e===16&&(t&16)==16||e===1&&(t&1)==1||e===2&&(t&2)==2||e===8&&(t&8)==8||e===0&&(t&4)==4||e===128&&(t&128)==128}isSubTriggerType(t){return(t&512)==512||(t&1024)==1024||(t&4096)==4096||(t&8192)==8192||(t&16384)==16384||(t&32768)==32768||(t&65536)==65536||(t&131072)==131072||(t&262144)==262144}getTriggerType(t){return t===0?4:t===3?32:t}ExecuteTriggers(t,e,i,n,s,o){if(!this.enableTriggers||e==null)return e;s==null&&(s=!1),n==null&&(n=!1),i=i||e,this.buildTriggerCache();let r=0,a,l=!1,f,c=this._TriggerCache,y=c.length,u=this._TriggerStates,x=this._TriggerRegExCache,S;for(;r<y;r++){let m=c[r],g=m;if(m.enabled){if((!g.triggers||!g.triggers.length||m.state>g.triggers.length)&&(g.state=0),m.state!==0&&g.triggers&&g.triggers.length){for(m=g.triggers[m.state-1];!m.enabled&&g.state!==0;){if(g.state++,g.state>g.triggers.length){g.state=0,m=g;break}g.state?m=g.triggers[g.state-1]:m=g,l=!0}if(l&&(this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",g.profile.name,g.profile.triggers.indexOf(g),g)),!m.enabled)continue}if(S=this.getTriggerType(m.type),!(m.type!==void 0&&(t&S)!==S&&(!o||o&&!this.isSubTriggerType(m.type)))&&m.type!==65536&&!(n&&!m.triggerPrompt)&&!(!n&&!m.triggerNewline&&m.triggerNewline!==void 0)){if(u[r]){if(u[r].type===1024){if(u[r].time>Date.now())continue;delete u[r]}else if(u[r].type===16384){if(u[r].time<Date.now()){delete u[r],this.advanceTrigger(m,g,r),u[r]?u[r].reParse=!0:u[r]={reParse:!0},r=this.cleanUpTriggerState(r);continue}}else if(u[r].type===512){if(u[r].lineCount>0)continue;delete u[r]}else if(u[r].type===8192){if(u[r].lineCount<1){this.advanceTrigger(m,g,r),u[r]?u[r].reParse=!0:u[r]={reParse:!0},r=this.cleanUpTriggerState(r);continue}}else if(u[r].type===32768&&u[r].lineCount<1){this.advanceTrigger(m,g,r),u[r]?u[r].reParse=!0:u[r]={reParse:!0},r=this.cleanUpTriggerState(r);continue}}try{if(m.type===128)if(this.evaluate(this.parseInline(m.pattern))){if(u[r]){if(u[r].loop!==-1&&u[r].lineCount<1)continue}else{let T=this.createTriggerState(m,!1,g);T&&(u[r]=T)}this._LastTriggered=m.raw?i:e,f=this.ExecuteTrigger(m,[this._LastTriggered],s,r,[this._LastTriggered],0,g)}else{this.advanceTrigger(m,g,r);continue}else if(m.verbatim){if(!m.caseSensitive&&(m.raw?i:e).toLowerCase()!==m.pattern.toLowerCase()){!u[r]&&(m.type===131072||m.type===262144)&&(this.advanceTrigger(m,g,r),r=this.cleanUpTriggerState(r));continue}else if(m.caseSensitive&&(m.raw?i:e)!==m.pattern){!u[r]&&(m.type===131072||m.type===262144)&&(this.advanceTrigger(m,g,r),r=this.cleanUpTriggerState(r));continue}this._LastTriggered=m.raw?i:e,f=this.ExecuteTrigger(m,[this._LastTriggered],s,r,[this._LastTriggered],0,g)}else{let T;m.type===8||m.type===16||m.type===262144?a=Ue(m.pattern,this.client):a=m.pattern,m.caseSensitive?T=x["g"+a]||(x["g"+a]=new RegExp(a,"gd")):T=x["gi"+a]||(x["gi"+a]=new RegExp(a,"gid")),T.lastIndex=0;let I=T.exec(m.raw?i:e);if(!I||!I.length){!u[r]&&(m.type===131072||m.type===262144)&&(this.advanceTrigger(m,g,r),r=this.cleanUpTriggerState(r));continue}let k;this._LastTriggered=m.raw?i:e,(m.raw?i:e)===I[0]||!this.client.getOption("prependTriggeredLine")?k=I:(k=[this._LastTriggered,...I],k.indices=[[0,k[0].length],...I.indices]),I.groups&&Object.keys(I.groups).map(H=>this.client.variables[H]=I.groups[H]),f=this.ExecuteTrigger(m,k,s,r,[this._LastTriggered,T],I.groups,g)}if(u[r]&&u[r].reParse)!u[r].type||u[r].type===131072||u[r].type===262144?delete u[r]:delete u[r].reParse,r--;else if(s)return f}catch(T){this.client.getOption("disableTriggerOnError")&&(m.enabled=!1,setTimeout(()=>{this.client.saveProfiles(),this.emit("item-updated","trigger",g.profile,g.profile.triggers.indexOf(g),g)})),this.client.getOption("showScriptErrors")?this.client.error(T):this.client.debug(T)}}}}return e}TestTrigger(t,e,i,n,s,o){let r,a;try{if(t.verbatim){if(!t.caseSensitive&&(t.raw?s:n).toLowerCase()!==t.pattern.toLowerCase())return this._TriggerStates[i]||(this.advanceTrigger(t,e,i),i=this.cleanUpTriggerState(i)),i;if(t.caseSensitive&&(t.raw?s:n)!==t.pattern)return this._TriggerStates[i]||(this.advanceTrigger(t,e,i),i=this.cleanUpTriggerState(i)),i;this._LastTriggered=t.raw?s:n,r=this.ExecuteTrigger(t,[this._LastTriggered],!1,i,[this._LastTriggered],0,e)}else{let l;t.type===8||t.type===16||t.type===262144?a=Ue(t.pattern,this.client):a=t.pattern,t.caseSensitive?l=this._TriggerRegExCache["g"+a]||(this._TriggerRegExCache["g"+a]=new RegExp(a,"gd")):l=this._TriggerRegExCache["gi"+a]||(this._TriggerRegExCache["gi"+a]=new RegExp(a,"gid")),l.lastIndex=0;let f=l.exec(t.raw?s:n);if(!f||!f.length)return!this._TriggerStates[i]&&(t.type===131072||t.type===262144)&&(this.advanceTrigger(t,e,i),i=this.cleanUpTriggerState(i)),i;let c;this._LastTriggered=t.raw?s:n,(t.raw?s:n)===f[0]||!this.client.getOption("prependTriggeredLine")?c=f:(c=[this._LastTriggered,...f],c.indices=[[0,c[0].length],...f.indices]),f.groups&&Object.keys(f.groups).map(y=>this.client.variables[y]=f.groups[y]),r=this.ExecuteTrigger(t,c,!1,i,[this._LastTriggered,l],f.groups,e)}i=this.cleanUpTriggerState(i)}catch(l){this.client.getOption("disableTriggerOnError")&&(t.enabled=!1,setTimeout(()=>{this.client.saveProfiles(),this.emit("item-updated","trigger",e.profile,e.profile.triggers.indexOf(e),e)})),this.client.getOption("showScriptErrors")?this.client.error(l):this.client.debug(l)}return i}ExecuteTrigger(t,e,i,n,s,o,r){if(i==null&&(i=!1),!t.enabled)return"";if(this._TriggerStates[n]&&this._TriggerStates[n].type===16384&&delete this._TriggerStates[n],t.fired)return t.fired=!1,this.advanceTrigger(t,r,n),this._TriggerStates[n]?this._TriggerStates[n].reParse=!0:this._TriggerStates[n]={reParse:!0},"";this._LastTrigger=t;let a;if(t.temp)if(r.triggers.length)if(r.state===0){let l=r.triggers.shift();l.triggers=r.triggers,l.state=r.state,l.name=r.name,l.profile=r.profile,l.state>l.triggers.length&&(l.state=0),n>=0&&(this._TriggerCache[n]=l),this.client.saveProfiles();let f=r.profile.triggers.indexOf(r);r.profile.triggers[f]=l,this.client.emit("item-updated","trigger",r.profile.name,f,l)}else r.triggers.splice(r.state-1,1),r.state>r.triggers.length&&(r.state=0),this.client.saveProfiles(),this.client.emit("item-updated","trigger",r.profile.name,r.profile.triggers.indexOf(r),r);else n>=0&&this._TriggerCache.splice(n,1),this._TriggerStates[n]&&this.clearTriggerState(n),this.client.removeTrigger(r);else r.triggers.length&&this.advanceTrigger(t,r,n);if((this.client.getOption("echo")&8)===8&&this.client.echo("Trigger fired: "+t.pattern,-7,-8,!0,!0),t.value.length)switch(t.style){case 1:this._stack.push({loops:[],args:e,named:0,used:0,regex:s});try{a=this.parseOutgoing(t.value)}catch(l){throw l}finally{this._stack.pop()}break;case 2:if((this.client.getOption("echo")&2)===2&&this.client.echo(t.value,-7,-8,!0,!0),t.temp)a=new Function("try { "+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`),a=a.apply(this.client,e);else{this._TriggerFunctionCache[n]||(o?a=Object.keys(o).map(l=>`let ${l} = this.variables["${l}"];`).join("")+`
`:a="",this._TriggerFunctionCache[n]=new Function("try { "+a+t.value+`
} catch (e) { if(this.getOption('showScriptErrors')) this.error(e);}`)),this._stack.push({loops:[],args:e,named:0,used:0,regex:s,indices:e.indices});try{a=this._TriggerFunctionCache[n].apply(this.client,e)}catch(l){throw l}finally{this._stack.pop()}}typeof a=="string"&&(a=this.parseOutgoing(a));break;default:a=t.value;break}if(a==null||a===void 0)return null;if(i)return a;if(typeof a!="string"&&(a=a.toString()),a.length===0&&!this.client.getOption("returnNewlineOnEmptyValue"))return null;a.endsWith(`
`)||(a+=`
`),this.client.connected&&this.client.telnet.sendData(a),this.client.telnet.echo&&this.client.getOption("commandEcho")&&setTimeout(()=>{this.client.echo(a)},1)}advanceTrigger(t,e,i){if(this._TriggerStates[i]){if(this._TriggerStates[i].type===4096){if(this._TriggerStates[i].loop--,this._TriggerStates[i].loop>0)return;this.clearTriggerState(i)}else if(this._TriggerStates[i].type===8192){if(this._TriggerStates[i].lineCount>0)return;this.clearTriggerState(i)}else if(this._TriggerStates[i].type===32768)this.clearTriggerState(i);else if(this._TriggerStates[i].type===128&&(this._TriggerStates[i].loop===-1||this._TriggerStates[i].lineCount>0))return}if(e.state++,e.state>e.triggers.length&&(e.state=0),this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",e.profile.name,e.profile.triggers.indexOf(e),e),e.state!==0){let n=this.createTriggerState(e.triggers[e.state-1]);n&&(this._TriggerStates[i]=n)}}createTriggerState(t,e,i){let n,s;switch(t.type){case 131072:case 262144:s={reParse:!0};break;case 16384:case 1024:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=0)):n=0,s={time:Date.now()+n};break;case 32768:case 8192:case 512:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=1)):n=1,s={lineCount:n+1};break;case 4096:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=0)):n=0,s={loop:n};break;case 128:n=t.params,n&&n.length?(n=parseInt(n,10),isNaN(n)&&(n=1),i===t?s={lineCount:n-1}:s={lineCount:n}):s={loop:-1};break}return s&&(s.type=t.type),!s&&e?{reParse:!0}:(e&&(s.reparse=!0),s)}updateTriggerState(t,e){if(!this._TriggerStates[e])return;let i;switch(this._TriggerStates[e].type){case 1024:case 16384:i=t.params,i&&i.length?(i=parseInt(i,10),isNaN(i)&&(i=0)):i=0,this._TriggerStates[e].time=Date.now()+i;break;case 32768:case 512:case 8192:i=t.params,i&&i.length?(i=parseInt(i,10),isNaN(i)&&(i=0)):i=0,this._TriggerStates[e].lineCount=i;break;case 4096:i=t.params,i&&i.length?(i=parseInt(i,10),isNaN(i)&&(i=0)):i=0,this._TriggerStates[e].loop=i;break;case 128:i=t.params,i&&i.length?(i=parseInt(i,10),isNaN(i)&&(i=1),this._TriggerStates[e].lineCount=i+1):this._TriggerStates[e].loop=-1;break}}getTriggerState(t){return this._TriggerStates[t]}cleanUpTriggerState(t){return this._TriggerStates[t]&&this._TriggerStates[t].reParse&&(!this._TriggerStates[t].type||this._TriggerStates[t].type===131072||this._TriggerStates[t].type===262144?delete this._TriggerStates[t]:delete this._TriggerStates[t].reParse,t<0?t++:t--),t}clearTriggerState(t){delete this._TriggerStates[t]}setTriggerState(t,e){this._TriggerStates[t]=e}clearTriggerCache(){this._TriggerCache=null,this._TriggerStates={},this._TriggerFunctionCache={},this._TriggerRegExCache={}}resetTriggerState(t,e,i){if(t===-1||t<0||t>=this._TriggerCache.length)return;let n=this._TriggerCache[t],s,o=n,r,a=!1;if(o.state!==0&&(n=o.triggers[o.state-1]),e===0?s=o:s=o.triggers[e-1],e===o.state)this._TriggerStates[t]?n.fired?this.clearTriggerState(t):this.updateTriggerState(n,t):n.fired||this.updateTriggerState(n,t);else if(this._TriggerStates[t]&&(!this._TriggerStates[t].type||this._TriggerStates[t].type!==262144&&this._TriggerStates[t].type!==131072)&&(a=this._TriggerStates[t].reParse),this.clearTriggerState(t),n.fired)this._TriggerStates[t]={reParse:!0};else{let l=this.createTriggerState(n,a);l&&(this._TriggerStates[t]=l)}}buildTriggerCache(){this._TriggerCache==null&&(this._TriggerCache=$.grep(this.client.triggers,t=>{if(t&&t.enabled&&t.triggers.length){if(t.type!==3)return!0;for(let e=0,i=t.triggers.length;e<i;e++)if(t.triggers[e].enabled&&t.triggers[e].type!==3)return!0;return!1}return t.enabled&&t.type!==3}))}clearCaches(){this._TriggerCache=null,this._TriggerStates={},this._TriggerFunctionCache={},this._TriggerRegExCache={},this._gamepadCaches=null,this._lastSuspend=-1,this._MacroCache={}}triggerEvent(t,e){if(!this.enableTriggers)return;this.buildTriggerCache();let i=0;e?Array.isArray(e)?e.unshift(t):e=[t,e]:e=[t];let n=this._TriggerCache.length;for(;i<n;i++){let s=this._TriggerCache[i],o=s,r=!1;if(s.enabled){if(s.state>o.triggers.length&&(s.state=0),s.state!==0&&o.triggers&&o.triggers.length){for(s=o.triggers[s.state-1];!s.enabled&&o.state!==0;){if(o.state++,o.state>o.triggers.length){o.state=0,s=o;break}o.state?s=o.triggers[o.state-1]:s=o,r=!0}if(r&&(this.client.getOption("saveTriggerStateChanges")&&this.client.saveProfiles(),this.client.emit("item-updated","trigger",o.profile.name,o.profile.triggers.indexOf(o),o)),!s.enabled)continue}if(s.type===131072||s.type===262144){let a=this.adjustLastLine(this.client.display.lines.length,!0),l=this.client.display.lines[a];i=this.TestTrigger(s,o,i,l,this.client.display.lines[a].raw||l,a===this.client.display.lines.length-1);continue}s.type===2&&(s.caseSensitive&&t!==s.pattern||!s.caseSensitive&&t.toLowerCase()!==s.pattern.toLowerCase()||(this._LastTriggered=t,this.ExecuteTrigger(s,e,!1,i,0,0,o),i=this.cleanUpTriggerState(i)))}}}executeWait(t,e,i,n,s,o,r){if(!t||t.length===0)return;let a={loops:this.loops.splice(0),args:0,named:0,used:this.stack.used,append:this.stack.append};this.stack.args&&(a.args=this.stack.args.slice()),this.stack.named&&(a.named=this.stack.named.slice()),e<0&&(e=0),setTimeout(()=>{this._stack.push(a);let l=this.parseOutgoing(t,i,n,s,o,r);this._stack.pop(),!(l==null||typeof l>"u"||l.length===0)&&(l.endsWith(`
`)||(l=l+`
`),this.client.send(l,!0))},e)}buildScript(t){if(!t)return"";let e;this.client.getOption("commandStacking")&&this.client.getOption("commandStackingChar")&&this.client.getOption("commandStackingChar").length>0?e=t.splitQuote(`
`+this.client.getOption("commandStackingChar")):e=t.splitQuote(`
`);let i=0,n=e.length,s=[],o=[],r=this.client.getOption("commandChar");for(;i<n;i++)e[i].trim().startsWith(r+"wait ")?(s.push("setTimeout(()=> {"),o.unshift(parseInt(e[i].trim().substr(5),10)||0)):(s.push("client.sendCommand('"),s.push(e[i]),s.push("\\n');"));let a=o.length;for(i=0;i<a;i++)s.push("}, "),s.push(o[i]),s.push(");");return s.join("")}stripQuotes(t,e,i){return!t||t.length===0||((e||this.client.getOption("parseDoubleQuotes"))&&(t=t.replace(/^\"(.*)\"$/g,(n,s,o)=>s.replace(/\\\"/g,'"'))),(i||this.client.getOption("parseSingleQuotes"))&&(t=t.replace(/^\'(.*)\'$/g,(n,s,o)=>s.replace(/\\\'/g,"'")))),t}splitByQuotes(t,e,i,n){let s=0,o=0;return!t||t.length===0?[]:((i||this.client.getOption("parseDoubleQuotes"))&&(s|=2,o|=this.client.getOption("allowEscape")?2:0),(n||this.client.getOption("parseSingleQuotes"))&&(s|=1,o|=this.client.getOption("allowEscape")?1:0),at(t,e,s,o,this.client.getOption("escapeChar")))}createTrigger(t,e,i,n,s,o){let r,a,l=!0,f=!1;if(!t&&!s)throw new Error(`Trigger '${s||""}' not found`);if(i){if(typeof i=="string"){if(this.client.profiles.contains(i.toLowerCase()))i=this.client.profiles.items[i.toLowerCase()];else throw new Error("Profile not found: "+i);if(o)if(s)r=i.findAny("triggers",{name:s,pattern:s});else{if(!i.triggers.length)throw new Error("No triggers exist");r=i.triggers[i.triggers.length-1]}else s!==null?r=i.find("triggers","name",s):r=i.find("triggers","pattern",t)}}else{let c=this.client.profiles.keys,y=0,u=c.length;if(u===0)return;if(u===1){if(!this.client.profiles.items[c[0]].enabled||!this.client.profiles.items[c[0]].enableTriggers)throw Error("No enabled profiles found!");if(i=this.client.profiles.items[c[0]],o)if(s)r=this.client.profiles.items[c[y]].findAny("triggers",{name:s,pattern:s});else{if(!this.client.profiles.items[c[y]].triggers.length)throw new Error("No triggers exist");r=this.client.profiles.items[c[y]].triggers[this.client.profiles.items[c[y]].triggers.length-1]}else s!==null?r=this.client.profiles.items[c[y]].find("triggers","name",s):r=this.client.profiles.items[c[y]].find("triggers","pattern",t)}else{for(;y<u;y++)if(!(!this.client.profiles.items[c[y]].enabled||!this.client.profiles.items[c[y]].enableTriggers||this.client.profiles.items[c[y]].triggers.length===0)){if(o)if(s)r=this.client.profiles.items[c[y]].findAny("triggers",{name:s,pattern:s});else{if(!this.client.profiles.items[c[y]].triggers.length)throw new Error("No triggers exist");r=this.client.profiles.items[c[y]].triggers[this.client.profiles.items[c[y]].triggers.length-1]}else s!==null?r=this.client.profiles.items[c[y]].find("triggers","name",s):r=this.client.profiles.items[c[y]].find("triggers","pattern",t);if(r){i=this.client.profiles.items[c[y]];break}}i||(i=this.client.activeProfile)}}if(o){if(!r)throw new Error(`Trigger '${s||""}' not found`);if(a=new pe,a.pattern=t,l=!1,t!==null&&(a.pattern=t),e!==null&&(a.value=e),n&&(n.cmd&&(a.type=1),n.pattern&&(a.type=8),n.regular&&(a.type=0),n.alarm&&(a.type=3),n.event&&(a.type=2),n.cmdpattern&&(a.type=16),n.loopexpression&&(a.type=128),n.reparse&&(a.type=131072),n.reparsepattern&&(a.type=262144),n.manual&&(a.type=65536),n.skip&&(a.type=512),n.looplines&&(a.type=8192),n.looppattern&&(a.type=4096),n.wait&&(a.type=1024),n.duration&&(a.type=16384),n.withinlines&&(a.type=32768),n.prompt&&(a.triggerPrompt=!0),n.nocr&&(a.triggerNewline=!1),n.case&&(a.caseSensitive=!0),n.raw&&(a.raw=!0),n.verbatim&&(a.verbatim=!0),n.disable?a.enabled=!1:n.enable&&(a.enabled=!0),(n.temporary||n.temp)&&(a.temp=!0),n.params&&(a.params=n.params),n.type))if(this.isTriggerType(n.type))a.type=this.convertTriggerType(n.type);else throw new Error("Invalid trigger type");r.triggers.push(a),this.client.echo("Trigger sub state added.",-7,-8,!0,!0)}else{if(r)this.client.echo("Trigger updated.",-7,-8,!0,!0);else{if(!t)throw new Error(`Trigger '${s||""}' not found`);r=new pe,r.name=s||"",r.pattern=t,i.triggers.push(r),this.client.echo("Trigger added.",-7,-8,!0,!0),f=!0}if(t!==null&&(r.pattern=t),e!==null&&(r.value=e),n){if(n.cmd&&(r.type=1),n.pattern&&(r.type=8),n.regular&&(r.type=0),n.alarm&&(r.type=3),n.event&&(r.type=2),n.cmdpattern&&(r.type=16),n.loopexpression&&(r.type=128),n.prompt&&(r.triggerPrompt=!0),n.nocr&&(r.triggerNewline=!1),n.case&&(r.caseSensitive=!0),n.raw&&(r.raw=!0),n.verbatim&&(r.verbatim=!0),n.disable?r.enabled=!1:n.enable&&(r.enabled=!0),(n.temporary||n.temp)&&(r.temp=!0),n.params&&(r.params=n.params),n.type)if(this.isTriggerType(n.type,1))r.type=this.convertTriggerType(n.type);else throw new Error("Invalid trigger type");r.priority=n.priority}else r.priority=0}this.client.saveProfiles(),l&&this.client.clearCache(),f?this.emit("item-added","trigger",i.name,r):this.emit("item-updated","trigger",i.name,i.triggers.indexOf(r),r),i=null}isTriggerType(t,e){switch(e||(e=3),t.replace(/ /g,"").toUpperCase()){case"REGULAREXPRESSION":case"COMMANDINPUTREGULAREXPRESSION":return(e&1)===1;case"0":case"1":case"2":case"3":case"8":case"16":case"128":case"REGULAR":case"COMMANDINPUTREGULAR":case"EVENT":case"ALARM":case"COMMAND":case"COMMANDINPUTPATTERN":case"LOOPEXPRSSION":return(e&1)===1;case"SKIP":case"512":case"WAIT":case"1024":case"LOOPPATTERN":case"4096":case"LOOPLINES":case"8192":case"DURATION":case"16384":case"WITHINLINES":case"32768":case"MANUAL":case"65536":case"REPARSE":case"131072":case"REPARSEPATTERN":case"262144":return(e&2)===2}return!1}convertTriggerType(t){switch(t.replace(/ /g,"").toUpperCase()){case"REGULAREXPRESSION":return 0;case"COMMANDINPUTREGULAREXPRESSION":return 1;case"0":case"1":case"2":case"3":case"8":case"16":case"128":return Ke[parseInt(t,10)];case"REGULAR":case"COMMANDINPUTREGULAR":case"EVENT":case"ALARM":case"COMMAND":case"COMMANDINPUTPATTERN":case"LOOPEXPRSSION":return Ke[t];case"512":case"1024":case"4096":case"8192":case"16384":case"32768":case"65536":case"131072":case"262144":return Ze[parseInt(t,10)];case"SKIP":case"WAIT":case"LOOPPATTERN":case"LOOPLINES":case"DURATION":case"WITHINLINES":case"MANUAL":case"REPARSE":case"REPARSEPATTERN":return Ze[t]}throw new Error("Invalid trigger type")}colorPosition(t,e,i,n){if(t=this.adjustLastLine(t),!n.hasOwnProperty("yStart"))this.client.display.colorSubStringByLine(t,e,i,n.xStart,n.hasOwnProperty("xEnd")&&n.xEnd>=0?n.xEnd:null);else{let s=n.hasOwnProperty("xEnd")&&n.xEnd>=0?n.xEnd:null,o=n.xStart,r=t-n.yStart,a=t;for(n.hasOwnProperty("yEnd")&&(a=t-n.yEnd);r<=a;)this.client.display.colorSubStringByLine(r,e,i,o,s),r++}}};function X(p){this.ok=!1,p.charAt(0)=="#"&&(p=p.substr(1,6)),p=p.replace(/ /g,""),p=p.toLowerCase();var h={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(var t in h)p==t&&(p=h[t]);for(var e=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(l){return[parseInt(l[1],10),parseInt(l[2],10),parseInt(l[3],10)]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(l){return[parseInt(l[1],16),parseInt(l[2],16),parseInt(l[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(l){return[parseInt(l[1]+l[1],16),parseInt(l[2]+l[2],16),parseInt(l[3]+l[3],16)]}}],i=0,n=e.length;i<n;i++){var s=e[i].re,o=e[i].process,r=s.exec(p);if(r){var a=o(r);this.r=a[0],this.g=a[1],this.b=a[2],this.ok=!0}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r,this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g,this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var l=this.r.toString(16),f=this.g.toString(16),c=this.b.toString(16);return l.length==1&&(l="0"+l),f.length==1&&(f="0"+f),c.length==1&&(c="0"+c),"#"+l+f+c}}var ne=(w=>(w[w.None=0]="None",w[w.B=1]="B",w[w.BOLD=2]="BOLD",w[w.STRONG=3]="STRONG",w[w.I=4]="I",w[w.ITALIC=5]="ITALIC",w[w.EM=6]="EM",w[w.U=7]="U",w[w.UNDERLINE=8]="UNDERLINE",w[w.S=9]="S",w[w.STRIKEOUT=10]="STRIKEOUT",w[w.STRIKE=11]="STRIKE",w[w.C=12]="C",w[w.COLOR=13]="COLOR",w[w.H=14]="H",w[w.HIGH=15]="HIGH",w[w.FONT=16]="FONT",w[w.HR=17]="HR",w[w.NOBR=18]="NOBR",w[w.P=19]="P",w[w.BR=20]="BR",w[w.SBR=21]="SBR",w[w.A=22]="A",w[w.SEND=23]="SEND",w[w.EXPIRE=24]="EXPIRE",w[w.VERSION=25]="VERSION",w[w.SUPPORT=26]="SUPPORT",w[w.RESET=27]="RESET",w[w.H1=28]="H1",w[w.H2=29]="H2",w[w.H3=30]="H3",w[w.H4=31]="H4",w[w.H5=32]="H5",w[w.H6=33]="H6",w[w.V=34]="V",w[w.VAR=35]="VAR",w[w.USER=36]="USER",w[w.PASSWORD=37]="PASSWORD",w[w.Custom=38]="Custom",w[w.GAUGE=39]="GAUGE",w[w.STAT=40]="STAT",w))(ne||{});var mt=class{constructor(){this.on=!1;this.lineType=0;this.locked=!1;this.paragraph=!1;this.noBreak=!1;this.expanded=!1;this.lineExpanded=!1;this.capture=0;this.captured=[];this.gagged=!1}},dt=class{constructor(h){this.name="";this.value="";this.description="";this.publish=!1;this.remote=!1;this.remote=h??!1}},Gt=class{constructor(h){this.name="";this.definition="";this.closeDefinition="";this.attributes={};this.attributeIndexes=[];this.tag=-1;this.flag="";this.open=!1;this.empty=!1;this.remote=!1;this.gagged=!1;this.remote=h??!1}},gt=class{constructor(h,t,e,i){this.index=-1;this.window="";this.gag=!1;this.fore="";this.back="";this.enabled=!0;this.remote=!1;this.element="";this.definition="";this.closeDefinition="";h!=null&&(this.index=h),t!=null&&(this.fore=t),e!=null&&(this.back=e),i!=null&&(this.remote=i)}},Xe=class{constructor(h,t,e,i,n){this.tag=0;this.custom="";this.font=null;this.fontSize=null;this.style=0;this.fore="";this.back="";this.high=!1;this.obj=null;this.gagged=!1;this.open=!1;this.properties=null;h!=null&&(this.style=h),t!=null&&(this.fore=t),e!=null&&(this.back=e),this.high=i||!1,this.open=n||!1}},bt=class extends ie{constructor(t){super();this.parsing=[];this.protocols=[["m","a","i","l","t","o"],["s","k","y","p","e"],["a","i","m"],["c","a","l","l","t","o"],["g","t","a","l","k"],["i","m"],["i","t","m","s"],["m","s","n","i","m"],["t","e","l"],["y","m","s","g","r"]];this._ColorTable=null;this._CurrentForeColor=37;this._CurrentBackColor=40;this._CurrentAttributes=0;this._SplitBuffer="";this.mxpState=new mt;this.mxpStyles=[];this.mxpEntities={};this.mxpElements={};this.mxpLines=[];this.iMXPDefaultMode=0;this.displayControlCodes=!1;this.emulateControlCodes=!0;this.StyleVersion="";this.EndOfLine=!1;this.textLength=0;this.rawLength=0;this.enableMXP=!0;this.DefaultImgUrl="";this.enableDebug=!1;this.showInvalidMXPTags=!1;this.enableLinks=!0;this.enableMSP=!0;this.enableURLDetection=!0;this.window=new $e(0,0);this.enableFlashing=!1;this.emulateTerminal=!1;this.enableBell=!0;this.display=null;this.tabWidth=8;this.busy=!1;t!=null&&(t.DefaultImageURL&&(this.DefaultImgUrl=t.DefaultImageURL),t.enableMXP!=null&&(this.enableMXP=t.enableMXP),t.enableDebug!=null&&(this.enableDebug=t.enableDebug),t.showInvalidMXPTags!=null&&(this.showInvalidMXPTags=t.showInvalidMXPTags),t.enableMSP!=null&&(this.enableMSP=t.enableMSP),t.enableURLDetection!=null&&(this.enableURLDetection=t.enableURLDetection),t.window!=null&&(this.window=t.window),t.enableFlashing!=null&&(this.enableFlashing=t.enableFlashing),t.emulateTerminal!=null&&(this.emulateTerminal=t.emulateTerminal),t.enableBell!=null&&(this.enableBell=t.enableBell),t.display!=null&&(this.display=t.display),t.enableLinks&&(this.enableLinks=t.enableLinks))}getColors(t){typeof t>"u"&&(t=this.GetCurrentStyle());let e,i,n=-1,s=-1;return t.fore.length>0?(this._CurrentAttributes&1)===1?e=this.IncreaseColor(t.fore,.5):(this._CurrentAttributes&2)===2?e=this.DecreaseColor(t.fore,.5):e=t.fore:typeof this._CurrentForeColor=="string"?e="rgb("+this._CurrentForeColor.replace(/;/g,",")+")":(e=this._CurrentForeColor,(this._CurrentAttributes&1)===1?(e>999&&(e/=1e3),e>=0&&e<99&&(e*=10),n=e,e<=-16&&(e=this.IncreaseColor(this.GetColor(e),.5))):(this._CurrentAttributes&2)===2?(e>99&&e<999&&(e/=10),e>=0&&e<999&&(e*=100),n=e,e<=-16&&(e=this.DecreaseColor(this.GetColor(e),.15))):n=e),t.high&&(typeof e=="number"?e=this.IncreaseColor(this.GetColor(e),.25):e=this.IncreaseColor(e,.25)),t.back.length>0?i=t.back:typeof this._CurrentBackColor=="string"?i="rgb("+this._CurrentBackColor.replace(/;/g,",")+")":i=s=this._CurrentBackColor,(this._CurrentAttributes&64)===64||(t.style&64)===64?{fore:i,back:e,foreCode:s,backCode:n}:{fore:e,back:i,foreCode:n,backCode:s}}getFormatBlock(t){let e=this.GetCurrentStyle(),i=this.getColors(e);return{formatType:0,offset:t,color:i.fore||0,background:i.back||0,size:e.fontSize||0,font:e.font||0,style:e.style|this._CurrentAttributes&-2,unicode:!1}}ResetColors(){this._CurrentForeColor=37,this._CurrentBackColor=40,this._CurrentAttributes=0}ProcessAnsiColorParams(t){let e=0,i=t.length,n,s;for(;e<i;e++)switch(n=+t[e]||0,n){case 0:this.ResetColors();break;case 1:this._CurrentAttributes|=1,this._CurrentAttributes&=-3;break;case 2:this._CurrentAttributes|=2,this._CurrentAttributes&=-2;break;case 3:this._CurrentAttributes|=4;break;case 4:this._CurrentAttributes|=8;break;case 5:this._CurrentAttributes|=16;break;case 6:this._CurrentAttributes|=32;break;case 7:this._CurrentAttributes|=64;break;case 8:this._CurrentAttributes|=128;break;case 9:this._CurrentAttributes|=256;break;case 21:this._CurrentAttributes|=512;break;case 22:this._CurrentAttributes&=-2,this._CurrentAttributes&=-3;break;case 23:this._CurrentAttributes&=-5;break;case 24:this._CurrentAttributes&=-9,this._CurrentAttributes&=-513;break;case 25:this._CurrentAttributes&=-17;break;case 26:this._CurrentAttributes&=-33;break;case 27:this._CurrentAttributes&=-65;break;case 28:this._CurrentAttributes&=-129;break;case 29:this._CurrentAttributes&=-257;break;case-11:case-7:case-3:case 30:case 31:case 32:case 33:case 34:case 35:case 36:case 37:this._CurrentForeColor=n;break;case 38:if(e+2<i&&t[e+1]==="5")this._CurrentForeColor=+t[e+2],isNaN(this._CurrentForeColor)?this._CurrentForeColor=37:(this._CurrentForeColor+=16,this._CurrentForeColor*=-1),e+=2;else if(e+4<i&&t[e+1]==="2"){if(n=+t[e+2]||0,n<0||n>255||(s=n+";",n=+t[e+3]||0,n<0||n>255)||(s+=n+";",n=+t[e+4]||0,n<0||n>255))continue;s+=n,this._CurrentForeColor=s,e+=4}break;case 39:this._CurrentForeColor=-1;break;case-12:case-8:case-4:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:this._CurrentBackColor=n;break;case 48:if(e+2<i&&t[e+1]==="5")this._CurrentBackColor=+t[e+2],isNaN(this._CurrentBackColor)?this._CurrentBackColor=40:(this._CurrentBackColor+=16,this._CurrentBackColor*=-1),e+=2;else if(e+4<i&&t[e+1]==="2"){if(n=+t[e+2]||0,n<0||n>255||(s=n+";",n=+t[e+3]||0,n<0||n>255)||(s+=n+";",n=+t[e+4]||0,n<0||n>255))continue;s+=n,this._CurrentBackColor=s,e+=4}break;case 49:this._CurrentBackColor=-2;break;case 53:this._CurrentAttributes|=1024;break;case 55:this._CurrentAttributes&=-1025;break;case 50:case 51:case 52:case 54:case 56:case 57:case 58:case 59:this._CurrentForeColor=n-20,this._CurrentAttributes|=1;break;case 90:case 91:case 92:case 93:case 94:case 95:case 96:case 97:this._CurrentForeColor=n;break;case 100:case 101:case 102:case 103:case 104:case 105:case 106:case 107:this._CurrentBackColor=n;break}}buildColorTable(){let t=[],e,i,n,s;for(e=0;e<6;e++)for(i=0;i<6;i++)for(n=0;n<6;n++)s=16+e*36+i*6+n,t[s]="rgb(",e>0?t[s]+=e*40+55:t[s]+="0",t[s]+=",",i>0?t[s]+=i*40+55:t[s]+="0",t[s]+=",",n>0?t[s]+=n*40+55:t[s]+="0",t[s]+=")";for(e=232;e<=255;e++)i=(e-232)*10+8,t[e]=["rgb(",i,",",i,",",i,")"].join("");t[0]="rgb(0,0,0)",t[1]="rgb(128, 0, 0)",t[2]="rgb(0, 128, 0)",t[3]="rgb(128, 128, 0)",t[4]="rgb(0, 0, 238)",t[5]="rgb(128, 0, 128)",t[6]="rgb(0, 128, 128)",t[7]="rgb(187, 187, 187)",t[8]="rgb(128, 128, 128)",t[9]="rgb(255, 0, 0)",t[10]="rgb(0, 255, 0)",t[11]="rgb(255, 255, 0)",t[12]="rgb(92, 92, 255)",t[13]="rgb(255, 0, 255)",t[14]="rgb(0, 255, 255)",t[15]="rgb(255, 255, 255)",t[256]="rgb(0, 0, 0)",t[257]="rgb(118, 0, 0)",t[258]="rgb(0, 108, 0)",t[259]="rgb(145, 136, 0)",t[260]="rgb(0, 0, 167)",t[261]="rgb(108, 0, 108)",t[262]="rgb(0, 108, 108)",t[263]="rgb(161, 161, 161)",t[264]="rgb(0, 0, 0)",t[265]="rgb(128, 0, 0)",t[266]="rgb(0, 128, 0)",t[267]="rgb(128, 128, 0)",t[268]="rgb(0, 0, 238)",t[269]="rgb(128, 0, 128)",t[270]="rgb(0, 128, 128)",t[271]="rgb(187, 187, 187)",t[272]="rgb(0,0,0)",t[273]="rgb(0, 255, 255)",t[274]="rgb(0,0,0)",t[275]="rgb(255, 255, 0)",t[276]="rgb(0, 0, 0)",t[277]="rgb(229, 229, 229)",t[278]="rgb(205, 0, 0)",t[279]="rgb(229, 229, 229)",t[280]="rgb(255,255,255)",this._ColorTable=t}GetColor(t){switch(this._ColorTable==null&&this.buildColorTable(),t){case-12:return this._ColorTable[279];case-11:return this._ColorTable[278];case-10:return this._ColorTable[280];case-8:return this._ColorTable[272];case-7:return this._ColorTable[273];case-4:return this._ColorTable[274];case-3:return this._ColorTable[275];case 49:case-2:return this._ColorTable[276];case 39:case-1:return this._ColorTable[277];case 0:case 30:return this._ColorTable[0];case 1:case 31:return this._ColorTable[1];case 2:case 32:return this._ColorTable[2];case 3:case 33:return this._ColorTable[3];case 4:case 34:return this._ColorTable[4];case 5:case 35:return this._ColorTable[5];case 6:case 36:return this._ColorTable[6];case 7:case 37:return this._ColorTable[7];case 40:return this._ColorTable[264];case 41:return this._ColorTable[265];case 42:return this._ColorTable[266];case 43:return this._ColorTable[267];case 44:return this._ColorTable[268];case 45:return this._ColorTable[269];case 46:return this._ColorTable[270];case 47:return this._ColorTable[271];case 8:case 90:case 100:case 300:case 400:return this._ColorTable[8];case 9:case 91:case 101:case 310:case 410:return this._ColorTable[9];case 10:case 92:case 102:case 320:case 420:return this._ColorTable[10];case 11:case 93:case 103:case 330:case 430:return this._ColorTable[11];case 12:case 94:case 104:case 340:case 440:return this._ColorTable[12];case 13:case 95:case 105:case 350:case 450:return this._ColorTable[13];case 14:case 96:case 106:case 360:case 460:return this._ColorTable[14];case 15:case 97:case 107:case 370:case 470:return this._ColorTable[15];case 4e3:case 3e3:return this._ColorTable[256];case 4100:case 3100:return this._ColorTable[257];case 4200:case 3200:return this._ColorTable[258];case 4300:case 3300:return this._ColorTable[259];case 4400:case 3400:return this._ColorTable[260];case 4500:case 3500:return this._ColorTable[261];case 4600:case 3600:return this._ColorTable[262];case 4700:case 3700:return this._ColorTable[263];default:return t<=-16&&(t+=16,t*=-1),t>=0&&t<281?this._ColorTable[t]:this._ColorTable[277]}}SetColor(t,e){this._ColorTable==null&&this.buildColorTable(),!(t<0||t>=this._ColorTable.length)&&(e=new X(e),e.ok&&(this._ColorTable[t]=e.toRGB()))}AddLine(t,e,i,n,s,o){let r={raw:e,line:t,fragment:i,gagged:n,formats:this.pruneFormats(s,t.length,i),remote:o};this.emit("add-line",r),this.EndOfLine=!i}pruneFormats(t,e,i){if(!t||t.length<2)return t;let n=t.length,s=[];for(let o=0;o<n;o++){let r=t[o],a;if(o<n-1){let l=t[o+1];if(r.offset===l.offset&&l.formatType===r.formatType||(a=l.offset,r.formatType===1&&a-r.offset===0&&l.formatType===2)||r.formatType===7&&a-r.offset===0&&l.formatType===8||r.formatType===3&&a-r.offset===0&&l.formatType===4)continue}else if(!i&&r.offset===e&&e!==0&&(r.formatType===0&&!r.hr||r.formatType===1||r.formatType===7||r.formatType===3))continue;s.push(r)}return s}GetEntity(t){return t==="text"?t:this.mxpEntities[t]?(this.mxpState.expanded=!0,this.mxpEntities[t].value):t}ClearMXPToTag(t,e,i){e==null&&(e="");let n=new Xe;n.tag=0;let s=this.mxpStyles.length-1;for(;s>=0&&(this.mxpStyles[s].tag!==t&&this.mxpStyles[s].custom!==e);s--){if(!this.mxpStyles[s].open&&!i)continue;n=this.mxpStyles.splice(s,1)[0]}return s>=0&&this.mxpStyles.length>0?n=this.mxpStyles.splice(s,1)[0]:this.mxpStyles.length===0&&this.ResetMXP(),n}ClearMXPOpen(){let t=this.mxpStyles.length;for(;t--;)this.mxpStyles[t].open&&this.mxpStyles.splice(t,1);this.mxpStyles.length===0&&this.ResetMXP()}getMXPOpenFormatBlocks(){if(!this.mxpState.on)return[];let t=0,e=this.mxpStyles.length,i=[];for(;t<e;t++)(this.mxpStyles[t].tag===22||this.mxpStyles[t].tag===23)&&i.push(Object.assign({},this.mxpStyles[t].properties));return i}getMXPCloseFormatBlocks(){if(!this.mxpState.on)return[];let t=this.mxpStyles.length,e=[];for(;t--;)this.mxpStyles[t].tag===22?e.push({formatType:4}):this.mxpStyles[t].tag===23&&e.push({formatType:8});return e}getMXPBlock(t,e,i,n,s){let o,r,a,l,f,c,y=e.length,u,x,S,m="",g="",T="",I=!1;switch(t=t.toUpperCase(),this.enableDebug&&(this.emit("debug","MXP Tag: "+t),this.emit("debug","MXP Tag Args: "+e)),t){case"C":case"COLOR":if(o=this.CloneCurrentStyle(),o.tag=ne[t],o.open=!0,y>0)if(r=e[0].split("="),r.length>1){if(f=new X(F(r[1])),!f.ok)return null;r[0].toUpperCase()==="BACK"?o.back=f.toRGB():o.fore=f.toRGB()}else f=new X(F(r[0])),f.ok&&(o.fore=f.toRGB());if(y>1)if(r=e[1].split("="),r.length>1){if(f=new X(F(r[1])),!f.ok)return null;r[0].toUpperCase()==="FORE"?o.fore=f.toRGB():o.back=f.toRGB()}else f=new X(F(r[0])),f.ok&&(o.back=f.toRGB());return o.custom="",this.mxpStyles.push(o),null;case"B":case"BOLD":case"STRONG":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=ne[t],o.style|=1,o.custom="",this.mxpStyles.push(o),null;case"FONT":for(o=this.CloneCurrentStyle(),o.open=!0,o.tag=ne[t],c=0;c<y;c++)if(r=e[c].split("="),r.length>1)switch(r[0].toUpperCase()){case"SIZE":this.isNumber(r[1])?o.fontSize=r[1]+"pt":o.fontSize=r[1]||0;break;case"COLOR":for(l=r[1].split(","),f=new X(F(l[0])),f.ok&&(o.fore=f.toRGB()),S=1,x=l.length;S<x;S++)switch(l[S].toLowerCase()){case"bold":o.style|=1;break;case"italic":o.style|=4;break;case"underline":o.style|=8;break;case"blink":o.style|=16;break;case"inverse":o.style|=64;break;case"hidden":o.style|=128;break;case"strikeout":o.style|=256;break;case"overline":o.style|=1024;break;case"doubleunderline":o.style|=512;break}break;case"BACK":f=new X(F(r[1])),f.ok&&(o.back=f.toRGB());break;case"FACE":o.font=F(r[1])||0;break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+r[0]);break}else c===0?o.font=F(e[c])||0:c===1?this.isNumber(e[c])?o.fontSize=e[c]+"pt":o.fontSize=e[c]||0:c===2?(f=new X(F(e[c])),f.ok&&(o.fore=f.toRGB())):c===3&&(f=new X(F(e[c])),f.ok&&(o.back=f.toRGB()));return o.custom="",this.mxpStyles.push(o),null;case"H":case"HIGH":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=ne[t],o.high=!0,o.custom="",this.mxpStyles.push(o),null;case"I":case"ITALIC":case"EM":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=ne[t],o.style|=4,o.custom="",this.mxpStyles.push(o),null;case"U":case"UNDERLINE":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=ne[t],o.style|=8,o.custom="",this.mxpStyles.push(o),null;case"S":case"STRIKEOUT":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=ne[t],o.style|=256,o.custom="",this.mxpStyles.push(o),null;case"/B":case"/BOLD":case"/STRONG":case"/H":case"/HIGH":case"/I":case"/ITALIC":case"/EM":case"/U":case"/UNDERLINE":case"/S":case"/STRIKEOUT":case"/C":case"/COLOR":case"/FONT":return this.ClearMXPToTag(ne[t.substring(1)]),null}if(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4)switch(t){case"IMAGE":for(u={formatType:5,name:"",url:this.DefaultImgUrl,t:"",h:"",w:"",hspace:"",vspace:"",align:"bottom",ismap:!1},c=0;c<y;c++)switch(r=e[c].split("="),r[0].toUpperCase()){case"FNAME":u.name=F(r[1]);break;case"URL":u.url=F(r[1]);break;case"TYPE":case"T":r[1].length>0&&(u.type=r[1]);break;case"HEIGHT":case"H":u.h=F(r[1]);break;case"WIDTH":case"W":u.w=F(r[1]);break;case"HSPACE":u.hspace=r[1];break;case"VSPACE":u.vspace=r[1];break;case"ALIGN":u.align=r[1].toLowerCase();break;case"ISMAP":u.ismap=!0;break;default:c===0?u.name=F(e[c]):c===1?u.url=F(e[c]):c===2&&e[c].length>0?u.type=e[c]:c===3?u.h=F(e[c]):c===4?u.w=F(e[c]):c===5?u.hspace=e[c]:c===6?u.vspace=e[c]:c===7&&(u.align=e[c].toLowerCase());break}return{format:u,text:null};case"!AT":case"!ATTLIST":if(e.length===0||(u=e[0],!this.mxpElements[u]||this.mxpEntities[u].remote!==u.remote&&!this.mxpEntities[u].open))return null;for(this.mxpElements[u].attributes={},this.mxpElements[u].attributeIndexes=[],c=1;c<y;c++)l=e[c].split("="),l.length>1?this.mxpElements[u].attributes[l[0].toLowerCase()]=l[1]:this.mxpElements[u].attributes[l[0].toLowerCase()]="",this.mxpElements[u].attributeIndexes.push(l[0].toLowerCase());break;case"!TAG":for(u=new gt,u.remote=i,c=0;c<y;c++)switch(r=e[c].split("="),r[0].toUpperCase()){case"WINDOWNAME":u.window=F(r[1]);break;case"FORE":f=new X(F(r[1])),f.ok&&(u.fore=f.toRGB());break;case"BACK":f=new X(F(r[1])),f.ok&&(u.back=f.toRGB());break;case"GAG":u.gag=!0;break;case"ENABLE":u.enabled=!0;break;case"DISABLE":u.enabled=!1;break;default:c===0?(o=+e[c],isNaN(o)||(u.index=o)):c===1?u.window=F(e[c]):c===2?(f=new X(F(e[c])),f.ok&&(u.fore=f.toRGB())):c===3&&(f=new X(F(e[c])),f.ok&&(u.back=f.toRGB()));break}u.fore.length>0&&u.back.length>0?u.definition=`<C "${u.fore}" "${u.back}">`:u.fore.length>0?u.definition=`<C "${u.fore}">`:u.back.length>0&&(u.definition=`<C BACK="${u.fore}">`),u.definition.length>0&&(u.closeDefinition="</C>"),this.mxpLines[u.index]?(u.remote||this.mxpLines[u.index].remote===u.remote)&&(this.mxpLines[u.index]=u):this.mxpLines[u.index]=u;break;case"!EL":case"!ELEMENT":for(u=new Gt(i),c=0;c<y;c++){if(e[c].toUpperCase().startsWith("ATT=")){for(r=F(e[c]).substring(4).split(" "),S=0,x=r.length;S<x;S++)l=F(r[S]).split("="),l.length>1?u.attributes[l[0].toLowerCase()]=F(l[1]):u.attributes[l[0].toLowerCase()]="",u.attributeIndexes.push(l[0].toLowerCase());continue}switch(r=e[c].split("="),r[0].toUpperCase()){case"TAG":o=+r[1],isNaN(o)||(u.tag=o);break;case"FLAG":u.flag=F(r[1]);break;case"OPEN":u.open=!0;break;case"DELETE":return this.mxpElements[u.name]&&(this.mxpEntities[u.name].remote===u.remote||this.mxpEntities[u.name].open)&&delete this.mxpEntities[u.name],null;case"EMPTY":u.empty=!0;break;case"SECURE":u.open=!1;break;default:if(c===0)u.name=F(e[c]).toUpperCase();else if(c===1)u.definition=F(e[c]),u.closeDefinition=this.GetCloseTags(u.definition),this.enableDebug&&this.emit("debug","MXP close definition: "+u.closeDefinition);else if(c===2)for(r=e[c].substring(4).split(" "),S=0,x=r.length;S<x;S++)l=r[S].split("="),l.length>1?u.attributes[l[0]]=l[1]:u.attributes[l[0]]="",u.attributeIndexes.push(l[0]);else c===3?(o=+e[c],isNaN(o)||(u.tag=o)):c===4&&(u.flag=F(e[c]));break}}u.tag>19&&u.tag<100&&(o=new gt(u.tag),o.element=u.name,this.mxpLines[o.index]?(u.remote||this.mxpLines[o.index].remote===u.remote)&&(this.mxpLines[o.index]=o):this.mxpLines[o.index]=o),this.mxpElements[u.name]?(this.mxpElements[u.name].remote===u.remote||this.mxpEntities[u.name].open)&&(this.mxpElements[u.name]=u):this.mxpElements[u.name]=u;break;case"!EN":case"!ENTITY":for(u=new dt(i),c=0;c<y;c++)switch(r=e[c].split("="),r[0].toUpperCase()){case"DESC":u.description=F(r[1]);break;case"PRIVATE":u.publish=!1;break;case"PUBLISH":u.publish=!0;break;case"DELETE":return this.mxpEntities[u.name]&&this.mxpEntities[u.name].remote===u.remote&&delete this.mxpEntities[u.name],null;case"ADD":if(this.mxpEntities[u.name]&&this.mxpEntities[u.name].remote===u.remote)return this.mxpEntities[u.name].value?this.mxpEntities[u.name].value+="|"+u.value:this.mxpEntities[u.name].value=u.value,null;break;case"REMOVE":if(this.mxpEntities[u.name]&&this.mxpEntities[u.name].remote===u.remote&&this.mxpEntities[u.name].value){for(l=this.mxpEntities[u.name].value.split("|"),a=[],S=0,x=l.length;S<x;S++)l[S]!==u.value&&a.push(l[S]);this.mxpEntities[u.name].value=a.join("|")}return null;default:c===0?u.name=F(e[c]):c===1?u.value=F(e[c]):c===2&&(u.description=F(e[c]));break}this.mxpEntities[u.name]?this.mxpEntities[u.name].remote===u.remote&&(this.mxpEntities[u.name]=u):this.mxpEntities[u.name]=u;break;case"/V":case"/VAR":for(o=this.ClearMXPToTag(ne[t.substring(1)]),u=new dt(i),this.mxpState.captured.length>0?u.value=this.mxpState.captured.pop().join(""):u.value="",this.mxpState.capture--,this.enableDebug&&this.emit("debug","MXP captured: "+u.value),e=o.obj,y=e.length,c=0;c<y;c++)switch(r=e[c].split("="),r[0].toUpperCase()){case"DESC":u.description=F(r[1]);break;case"PRIVATE":u.publish=!1;break;case"PUBLISH":u.publish=!0;break;case"DELETE":return this.mxpEntities[u.name]&&this.mxpEntities[u.name].remote===u.remote&&delete this.mxpEntities[u.name],null;case"ADD":if(this.mxpEntities[u.name]&&this.mxpEntities[u.name].remote===u.remote)return this.mxpEntities[u.name].value?this.mxpEntities[u.name].value+="|"+u.value:this.mxpEntities[u.name].value=u.value,null;break;case"REMOVE":if(this.mxpEntities[u.name]&&this.mxpEntities[u.name].remote===u.remote&&this.mxpEntities[u.name].value){for(l=this.mxpEntities[u.name].value.split("|"),a=[],S=0,x=l.length;S<x;S++)l[S]!==u.value&&a.push(l[S]);this.mxpEntities[u.name].value=a.join("|")}return null;default:c===0?u.name=F(e[c]):c===1&&(u.description=F(e[c]));break}this.mxpEntities[u.name]?this.mxpEntities[u.name].remote===u.remote&&(this.mxpEntities[u.name]=u):this.mxpEntities[u.name]=u;break;case"V":case"VAR":return this.mxpState.captured.push([]),this.mxpState.capture++,o=this.CloneCurrentStyle(),o.open=!1,o.tag=ne[t],o.obj=e,o.custom="",this.mxpStyles.push(o),null;case"GAUGE":for(u={value:0,max:1,caption:"",color:0},c=0;c<y;c++)if(r=e[c].split("="),r.length>1)switch(r[0].toUpperCase()){case"VALUE":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),u.value=o;break;case"MAX":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),u.max=o;break;case"CAPTION":r[1].length>0&&(u.caption=F(r[1]));break;case"COLOR":f=new X(F(r[1])),f.ok&&(u.color=f.toRGB());break}else c===0?(o=parseFloat(this.GetEntity(e[c])),isNaN(o)&&(o=this.GetEntity(e[c])),u.value=o):c===1?(o=parseFloat(this.GetEntity(e[c])),isNaN(o)&&(o=this.GetEntity(e[c])),u.max=o):c===2&&e[c].length>0?u.caption=F(e[c]):c===3&&e[c].length>0&&(f=new X(F(r[1])),f.ok&&(u.color=f.toRGB()));this.mxpState.expanded=!1,this.emit("gauge",u);break;case"STAT":for(u={value:0,max:1,caption:""},c=0;c<y;c++)if(r=e[c].split("="),r.length>1)switch(r[0].toUpperCase()){case"VALUE":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),u.value=o;break;case"MAX":o=parseFloat(this.GetEntity(r[1])),isNaN(o)&&(o=this.GetEntity(r[1])),u.max=o;break;case"CAPTION":r[1].length>0&&(u.caption=F(r[1]));break}else c===0?(o=parseFloat(this.GetEntity(e[c])),isNaN(o)&&(o=this.GetEntity(e[c])),u.value=o):c===1?(o=parseFloat(this.GetEntity(e[c])),isNaN(o)&&(o=this.GetEntity(e[c])),u.max=o):c===2&&e[c].length>0&&(u.caption=F(e[c]));this.mxpState.expanded=!1,this.emit("stat",u);break;case"MUSIC":for(u={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},c=0;c<y;c++)if(r=e[c].split("="),r.length>1)switch(r[0].toUpperCase()){case"FNAME":u.file=F(r[1]),u.file.toLowerCase()==="off"&&(u.off=!0,u.file="");break;case"V":o=+r[1],isNaN(o)&&(o=100),u.volume=o;break;case"L":o=+r[1],isNaN(o)&&(o=1),u.repeat=o;break;case"C":u.continue=r[1]!=="0";break;case"T":r[1].length>0&&(u.type=r[1]);break;case"U":u.url=F(r[1]),!u.url.endsWith("/")&&u.url.length>0&&(u.url+="/");break}else c===0?(u.file=F(e[c]),u.file.toLowerCase()==="off"&&(u.off=!0,u.file="")):c===1?(o=+e[c],isNaN(o)&&(o=100),u.volume=o):c===2?(o=+e[c],isNaN(o)&&(o=1),u.repeat=o):c===3?u.continue=e[c]!=="0":c===4?e[c].length>0&&(u.type=e[c]):c===5&&(u.url=F(e[c]),!u.url.endsWith("/")&&u.url.length>0&&(u.url+="/"));this.emit("music",u);break;case"SOUND":for(u={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},c=0;c<y;c++)if(r=e[c].split("="),r.length>1)switch(r[0].toUpperCase()){case"FNAME":u.file=F(r[1]),u.file.toLowerCase()==="off"&&(u.off=!0,u.file="");break;case"V":o=+r[1],isNaN(o)&&(o=100),u.volume=o;break;case"L":o=+r[1],isNaN(o)&&(o=1),u.repeat=o;break;case"P":o=+r[1],isNaN(o)&&(o=1),u.priority=o;break;case"T":r[1].length>0&&(u.type=r[1]);break;case"U":u.url=F(r[1]),!u.url.endsWith("/")&&u.url.length>0&&(u.url+="/");break}else c===0?(u.file=F(e[c]),u.file.toLowerCase()==="off"&&(u.off=!0,u.file="")):c===1?(o=+e[c],isNaN(o)&&(o=100),u.volume=o):c===2?(o=+e[c],isNaN(o)&&(o=1),u.repeat=o):c===3?(o=+e[c],isNaN(o)&&(o=1),u.priority=o):c===4?e[c].length>0&&(u.type=e[c]):c===5&&(u.url=F(e[c]),!u.url.endsWith("/")&&u.url.length>0&&(u.url+="/"));this.emit("sound",u);break;case"EXPIRE":this.emit("expire-links",e),this.cleanMXPExpired(s,e?.[0]||"");break;case"VERSION":y>0?this.StyleVersion=e[0]:this.emit("MXP-tag-reply",t,[]);break;case"USER":case"PASSWORD":this.emit("MXP-tag-reply",t,e);break;case"SUPPORT":if(l=[],y>0)for(c=0;c<y;c++)if(r=F(e[c]),r.indexOf(".")===-1)switch(r=r.toUpperCase(),r){case"IMAGE":case"HR":case"A":case"SEND":case"B":case"I":case"COLOR":case"C":case"EM":case"ITALIC":case"STRONG":case"BOLD":case"UNDERLINE":case"U":case"S":case"STRIKEOUT":case"STRIKE":case"H":case"HIGH":case"EXPIRE":case"VERSION":case"SUPPORT":case"NOBR":case"P":case"BR":case"SBR":case"SOUND":case"MUSIC":case"VAR":case"USER":case"PASSWORD":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"RESET":case"GAUGE":case"STAT":l.push("+"+name);break;default:l.push("-"+name);break}else switch(r=e[c].split("."),r[0]=r[0].toUpperCase(),r[0]){case"IMAGE":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+image.fname"),l.push("+image.url"),l.push("+image.t"),l.push("+image.h"),l.push("+image.w"),l.push("+image.hspace"),l.push("+image.vspace"),l.push("+image.align"),l.push("+image.ismap"));break;case"SOUND":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+sound.v"),l.push("+sound.l"),l.push("+sound.p"),l.push("+sound.t"),l.push("+sound.u"));break;case"MUSIC":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+music.v"),l.push("+music.l"),l.push("+music.c"),l.push("+music.t"),l.push("+music.u"));break;case"A":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+a.href"),l.push("+a.hint"),l.push("+a.expire"));break;case"SEND":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+send.href"),l.push("+send.hint"),l.push("+send.prompt"),l.push("+send.expire"));break;case"COLOR":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+color.fore"),l.push("+color.back"));break;case"C":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+c.fore"),l.push("+c.back"));break;case"FONT":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("-font.face"),l.push("-font.size"),l.push("+font.color"),l.push("+font.back"));break;case"EXPIRE":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):l.push("+expire.Name");break;case"GAUGE":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+gauge.max"),l.push("+gauge.caption"),l.push("+gauge.color"));break;case"STAT":r[1]!=="*"?l.push("+"+r[0]+"."+r[1]):(l.push("+stat.max"),l.push("+stat.caption"));break;default:r[1]!=="*"?l.push("-"+r[0]+"."+r[1]):l.push("-"+r[0]);break}else l=["+A","+SEND","+B","+I","+COLOR","+C","+EM","+ITALIC","+STRONG","+BOLD","+UNDERLINE","+U","+S","+STRIKEOUT","+H","+HIGH","-FONT","+EXPIRE","+VERSION","+SUPPORT","+NOBR","+P","+BR","+SBR","+VAR","+SOUND","+MUSIC","+USER","+PASSWORD","+RESET","+STRIKE","+H1","+H2","+H3","+H4","+H5","+H6","+IMAGE","+STAT","+GAUGE"];this.emit("MXP-tag-reply",t,l);break;case"A":for(o=this.CloneCurrentStyle(),o.open=!1,o.tag=ne[t],c=0;c<y;c++)if(r=e[c].split("="),r.length>1)switch(r[0].toUpperCase()){case"HREF":m=F(r[1]);break;case"HINT":g=F(r[1]);break;case"EXPIRE":T=F(r[1]);break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+r[0]);break}else c===0?m=F(e[c]):c===1?g=F(e[c]):c===2&&(T=F(e[c]));return o.custom="",o.properties={formatType:3,href:m,hint:g,expire:T},this.mxpStyles.push(o),g.length===0&&(g=m),{format:{formatType:3,href:m,hint:g,expire:T},text:null};case"SEND":for(o=this.CloneCurrentStyle(),o.open=!1,o.tag=ne[t],c=0;c<y;c++)if(r=e[c].split("="),r[0]==="PROMPT")I=!0;else if(r.length>1)switch(r[0].toUpperCase()){case"HREF":m=F(r[1]);break;case"HINT":g=F(r[1]);break;case"EXPIRE":T=F(r[1]);break;case"PROMPT":I=!0;break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+r[0]);break}else c===0?m=F(e[c]):c===1?g=F(e[c]):c===2?I=!0:c===3&&(T=F(e[c]));o.custom="",this.mxpStyles.push(o),m.length===0&&(m="&text;"),g.length===0&&(g=m);let k=m.split("|"),H;if(k.length>1){let b=g.split("|");b.length===k.length+1&&(g=b[0],b.shift(),H="['"+b.join("','")+"']"),m="['"+k.join("','")+"']"}else m="'"+m+"'";return o.properties={formatType:7,href:m,hint:g,expire:T,prompt:I,tt:H||""},{format:{formatType:7,href:m,hint:g,expire:T,prompt:I,tt:H||""},text:null};case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return o=this.CloneCurrentStyle(),o.open=!0,o.tag=ne[t],o.style|=1,o.custom="",this.mxpStyles.push(o),null;case"/A":return this.ClearMXPToTag(ne[t.substring(1)]),{format:{formatType:4},text:null};case"/SEND":return this.ClearMXPToTag(ne[t.substring(1)]),{format:{formatType:8},text:null};case"/H1":case"/H2":case"/H3":case"/H4":case"/H5":case"/H6":return this.ClearMXPToTag(ne[t.substring(1)]),null;case"NOBR":return this.mxpState.noBreak=!0,null;case"/P":return this.ClearMXPToTag(ne[t.substring(1)]),this.mxpState.paragraph=!1,null;case"P":return o=this.CloneCurrentStyle(),o.open=!1,o.tag=ne[t],o.custom="",this.mxpStyles.push(o),this.mxpState.paragraph=!0,null;case"SBR":return{format:null,text:" \u200B"};case"RESET":return this.ResetMXP(),null;case"HR":let C=this.GetCurrentStyle(),_=this.getColors(C);return{format:{formatType:0,offset:0,color:_.fore,background:_.back,size:C.fontSize,font:C.font,style:C.style|this._CurrentAttributes&-2,hr:!0},text:null}}if(this.mxpElements[t]){if(u=this.mxpElements[t],!u.open&&this.mxpState.lineType!==1&&this.mxpState.lineType!==6&&this.mxpState.lineType!==4)return null;for(o=this.CloneCurrentStyle(),o.open=u.open,o.tag=38,o.custom=u.name,r=u.definition,l={},S=0,x=u.attributeIndexes.length;S<x;S++)l[u.attributeIndexes[S]]=u.attributes[u.attributeIndexes[S]];for(c=0;c<y;c++)a=e[c].split("="),a[0]=a[0].toLowerCase(),u.attributes[a[0]]?l[a[0]]=a[1]:c<u.attributeIndexes.length&&(l[u.attributeIndexes[c]]=a[0]);for(a in l)l.hasOwnProperty(a)&&(r=r.replace("&"+a+";",l[a]));return u.empty||(this.mxpState.captured.push([]),this.mxpState.capture++),u.tag>19&&u.tag<100&&this.mxpLines[u.tag].enabled&&this.mxpLines[u.tag].definition.length>0&&(r=this.mxpLines[u.tag].definition+r,o.gagged=this.mxpLines[u.tag].gag),this.mxpState.gagged=o.gagged,this.mxpState.expanded=!0,{format:null,text:r}}else if(t.startsWith("/")&&this.mxpElements[t.substring(1)]&&!this.mxpElements[t.substring(1)].empty)return t=t.substring(1),u=this.mxpElements[t],!u.open&&this.mxpState.lineType!==1&&this.mxpState.lineType!==6&&this.mxpState.lineType!==4||(!u.empty&&this.mxpState.capture>0&&(this.mxpState.captured.length>0&&(a=this.mxpState.captured.pop().join("")),this.mxpState.capture--),r=u.closeDefinition,u.flag.length>0&&(u.flag.length>4&&u.flag.toLowerCase().startsWith("set ")&&this.emit("set-variable",u.flag.substring(4),a),this.emit("MXP-flag",u.flag,a)),u.tag>19&&u.tag<100&&this.mxpLines[u.tag].enabled&&this.mxpLines[u.tag].closeDefinition.length>0&&(r+=this.mxpLines[u.tag].closeDefinition),this.mxpState.gagged=!u.gagged,u.empty)?null:(this.mxpState.expanded=!0,{format:null,text:r});if(this.showInvalidMXPTags){switch(t){case"IMAGE":case"!AT":case"!ATTLIST":case"!TAG":case"!EL":case"!ELEMENT":case"!EN":case"!ENTITY":case"/V":case"/VAR":case"V":case"VAR":case"GAUGE":case"STAT":case"MUSIC":case"SOUND":case"EXPIRE":case"VERSION":case"USER":case"PASSWORD":case"SUPPORT":case"A":case"SEND":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"/A":case"/SEND":case"/H1":case"/H2":case"/H3":case"/H4":case"/H5":case"/H6":case"NOBR":case"/P":case"P":case"SBR":case"RESET":case"HR":return null}return{format:null,text:"<"+n+">"}}return null}cleanMXPExpired(t,e){if(!t||t.length===0||e===null)return;let i=t.length;for(let n=0;n<i;n++){let s=t[n];if(!(s.formatType!==7&&s.formatType!==3)&&(e.length===0||s.expire===e)){let o,r=0,a=0,l=s.formatType;for(s.formatType===3?o=4:o=8,s.formatType=9;a<i;a++)if(t[a].formatType===o)if(r===0){t[a].formatType=10;break}else r--;else t[a]===l&&r++}}}GetCloseTags(t){if(typeof t>"u"||t.length===0)return"";let e=0,i=t.length,n=[],s=[],o,r=0;for(;e<i;e++)switch(o=t.charAt(e),r){case 1:o===" "?(n.push(s.join("")),s=[],r=2):o===">"?(n.push(s.join("")),s=[],r=0):s.push(o);break;case 2:o===">"&&(r=0);break;default:o==="<"&&(r=1);break}return r===1&&n.push(s.join("")),n.length===0?"":"</"+n.reverse().join("></")+">"}CloneCurrentStyle(){let t;return this.mxpStyles.length===0&&this.mxpStyles.push(new Xe(0,"","",!1)),t=this.mxpStyles[this.mxpStyles.length-1],this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(t.gagged=this.mxpLines[this.mxpState.lineType].gag),Object.assign({},t)}GetCurrentStyle(){let t;return this.mxpStyles.length===0&&this.mxpStyles.push(new Xe(0,"","",!1)),t=this.mxpStyles[this.mxpStyles.length-1],this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(t.gagged=this.mxpLines[this.mxpState.lineType].gag),t}DecreaseColor(t,e){let i=new X(t);return i.ok?(i.b-=Math.ceil(i.b*e),i.b<0&&(i.b=0),i.g-=Math.ceil(i.g*e),i.g<0&&(i.g=0),i.r-=Math.ceil(i.r*e),i.r<0&&(i.r=0),i.toRGB()):t}IncreaseColor(t,e){let i=new X(t);return i.ok?(i.b+=Math.ceil(i.b*e),i.b>255&&(i.b=255),i.g+=Math.ceil(i.g*e),i.g>255&&(i.g=255),i.r+=Math.ceil(i.r*e),i.r>255&&(i.r=255),i.toRGB()):t}MXPCapture(t){if(this.mxpState.capture<1)return;let e=this.mxpState.captured.length;for(let i=0;i<e;i++)this.mxpState.captured[i].push(t)}MXPDeCapture(t){if(this.mxpState.capture<1)return;let e=this.mxpState.captured.length;for(let i=0;i<e;i++)for(let n=0;n<t;n++)this.mxpState.captured[i].pop()}isNumber(t){return/^\d+$/.test(t)}CurrentAnsiCode(){let t="\x1B[";return typeof this._CurrentForeColor=="string"?t+="38;2;"+this._CurrentForeColor:this._CurrentForeColor<=-16?t+="38;5;"+(this._CurrentForeColor*-1-16)+";":t+=this._CurrentForeColor+";",typeof this._CurrentBackColor=="string"?t+="48;2;"+this._CurrentBackColor:this._CurrentBackColor<=-16?t+="38;5;"+(this._CurrentBackColor*-1-16)+";":t+=this._CurrentBackColor+";",this._CurrentAttributes>0&&((this._CurrentAttributes&64)===64&&(t+="7;"),(this._CurrentAttributes&1)===1&&(t+="1;"),(this._CurrentAttributes&4)===4&&(t+="3;"),(this._CurrentAttributes&8)===8&&(t+="4;"),(this._CurrentAttributes&16)===16&&(t+="5;"),(this._CurrentAttributes&32)===32&&(t+="6;"),(this._CurrentAttributes&256)===256&&(t+="9;"),(this._CurrentAttributes&2)===2&&(t+="2;"),(this._CurrentAttributes&512)===512&&(t+="21;"),(this._CurrentAttributes&1024)===1024&&(t+="53;")),t+"m"}get parseQueueLength(){return this.parsing.length}get parseQueueEndOfLine(){return this.parsing.length?this.parsing[this.parsing.length-1][0].endsWith(`
`):!1}parse(t,e,i,n){if(t==null||t.length===0)return t;if(e==null&&(e=!1),this.parsing.length>0&&!i){this.parsing.push([t,e,n]);return}let s="",o=null,r=null,a=[],l=[],f=[],c=0,y=0,u=0,x,S=0,m,g,T,I,k,H=!1;this.busy=!0,this.parsing.unshift([t,e,n]);let C;if(this._SplitBuffer.length>0&&(n?t=t+this._SplitBuffer:t=this._SplitBuffer+t,this._SplitBuffer=""),!this.EndOfLine&&(this.textLength>0||this.rawLength>0)){let w=this.display.lines;w.length>0?(x=this.display.lines[w.length-1].text,I=this.display.lines[w.length-1].raw,l.push.apply(l,this.display.lines[w.length-1].formats),this.display.removeLine(w.length-1,!0),C=l[l.length-1],C.formatType===1&&(l.pop(),C=l[l.length-1]),C.width=0,C.height=0,C.marginWidth=0,C.marginHeight=0,u=C.offset,C.offset!==0?(a.push(x.substring(0,C.offset)),x=x.substring(C.offset),(this.mxpState.locked||this.mxpState.on)&&(S=x.length),t=x+t):((this.mxpState.locked||this.mxpState.on)&&(S=x.length),t=x+t),I.endsWith(x)?f.push(I.substr(0,I.length-x.length)):f.push(I)):l.push(C=this.getFormatBlock(u)),w=null}else l.push(C=this.getFormatBlock(u));let _=0,b=t.length,d,v,N=this.emulateControlCodes,J=this.displayControlCodes,se=this.emulateTerminal,oe=this.enableURLDetection,ee=this.enableMSP,L=this.tabWidth,P=0,G=0,M=0,E=0,D=null,B,V=this.protocols.length;try{for(_=0;_<b;_++)switch(d=t.charAt(_),v=t.charCodeAt(_),_>=S&&f.push(d),this.rawLength++,c){case 2:if(d==="C"||d==="K"||d==="s"||d==="u"||d==="l"||d==="h"||d==="A"||d==="B"||d==="D"||d==="E"||d==="F"||d==="f"||d==="G"||d==="H"||d==="n"||d==="S"||d==="T"||d==="r")this.ClearMXPOpen(),this._SplitBuffer="",r=null,c=0;else if(d==="z"){m=r.split(";"),r=0;for(let w=m.length-1;w>=0;w--)if(m[w].length>0){r=m[0];break}switch(x=+r,isNaN(x)&&(x=0),this.mxpState.on=!0,this.mxpState.noBreak=!1,this.mxpState.paragraph=!1,this.mxpState.lineType===0&&this.ClearMXPOpen(),x){case 2:this.mxpState.on=!1,this.mxpState.locked=!1,this.mxpState.lineType=2,this.ClearMXPOpen();break;case 3:this.ResetMXP();break;case 4:if(this.mxpState.lineType=4,_+1>=b){this._SplitBuffer+=d;break}t.charAt(_+1)!=="<"&&(this.mxpState.lineType=0,this.mxpState.on=!1),this.mxpState.locked=!1,this.ClearMXPOpen();break;case 5:this.iMXPDefaultMode=0,this.mxpState.locked=!0,this.mxpState.lineType=5,this.ClearMXPOpen();break;case 6:this.iMXPDefaultMode=1,this.mxpState.lineType=6,this.mxpState.locked=!0,this.ClearMXPOpen();break;case 7:this.iMXPDefaultMode=2,this.mxpState.lineType=7,this.mxpState.locked=!0,this.ClearMXPOpen();break;default:x<0||x>99?this.ClearMXPOpen():(this.mxpState.lineType=x,this.mxpState.locked=!1,this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(x="",this.mxpLines[this.mxpState.lineType].element.length>0&&(x+="<"+this.mxpLines[this.mxpState.lineType].element+">"),this.mxpLines[this.mxpState.lineType].definition.length>0&&(x+=this.mxpLines[this.mxpState.lineType].definition),x.length>0&&(t=t.splice(_+1,x),b=t.length)));break}this._SplitBuffer="",r=null,c=0}else if(d==="J"){if(this.ClearMXPOpen(),r.length>0&&+r==2){u=0,x=this.window.height,l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(u),...this.getMXPCloseFormatBlocks()];for(let w=0;w<x;w++)this.AddLine("",`
`,!1,!1,l,e),this.MXPCapture(`
`);this.textLength+=x,this.mxpState.noBreak=!1}l=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(u)],this._SplitBuffer="",r=null,c=0}else d==="m"?(this.ProcessAnsiColorParams(r.split(";")),l.push(C=this.getFormatBlock(u)),this._SplitBuffer="",r=null,c=0):d===`
`||d==="\x1B"?(_--,f.pop(),this.rawLength--,c=0,this._SplitBuffer="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen()):(this._SplitBuffer+=d,r+=d);break;case 3:v===7?(this._SplitBuffer="",this.emit("set-title",s,o??0),s="",o=null,c=0):d===";"&&o==null?(o=+s,isNaN(o)&&(o=0),s="",this._SplitBuffer+=d):d==="\x1B"?this._SplitBuffer.charAt(this._SplitBuffer.length-1)===`
`&&(this._SplitBuffer=""):(this._SplitBuffer+=d,s+=d);break;case 1:d==="["?(this._SplitBuffer+=d,r="",c=2):d==="]"?(this._SplitBuffer+=d,s="",c=3):(d==="D"||d==="E"||d==="M"||d==="1"||d==="2"||d==="7"||d==="8"||d===">"||d==="="||d==="#")&&(J&&(a.push("\u241B"),v<16?(a.push(String.fromCharCode(parseInt("240"+v.toString(16),16))),this.MXPCapture("&#x241B&#x240"+v.toString(16)+";")):(a.push(String.fromCharCode(parseInt("24"+v.toString(16),16))),this.MXPCapture("&#x241B&#x24"+v.toString(16)+";")),u+=2,this.textLength+=2,this.mxpState.noBreak=!1),c=0,this._SplitBuffer="");break;case 4:if(m==="!--")_--,f.pop(),this.rawLength--,y=0,c=8,I="<!--",m="",k=[];else if(m.endsWith("<!--"))_--,f.pop(),this.rawLength--,y=c,c=8,I="<!--",m=m.substring(0,m.length-4),k=[];else if(d==='"')c=6,k[k.length-1]+=d,this._SplitBuffer+=d;else if(d==="'")c=5,k[k.length-1]+=d,this._SplitBuffer+=d;else if(d==="&")T="",y=c,c=7,this._SplitBuffer="";else if(d===`
`||d==="\x1B")_--,f.pop(),this.rawLength--,c=0,this._SplitBuffer="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen();else if(d===" ")c=9,k.push(""),this._SplitBuffer+=d;else if(d===">"){if(g=m,m=m.toUpperCase(),m==="HR"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))u>0&&(u=0,this.MXPCapture(`
`),l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(u)]),m=this.getMXPBlock(m,[],e),m&&m.format&&(m.format.offset=u,l.push(m.format),l[0].hr=m.format.hr),l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),this.textLength++,a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(u)];else if(m==="BR"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))this.MXPCapture(`
`),l.push(...this.getMXPCloseFormatBlocks()),this.AddLine(a.join(""),f.join(""),!1,!1,l,e),H=!1,u=0,a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(u)],this.textLength++;else if(m==="IMAGE"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))m=this.getMXPBlock(m,k,e),m&&m.format!==null&&(l.push(m.format),u+=m.length,this.textLength+=m.length),l.push(C=this.getFormatBlock(u));else{if(m=this.getMXPBlock(m,[],e,g,l),this.mxpState.expanded){m&&m.text!==null&&(t=t.splice(_+1,m.text)),b=t.length,this.mxpState.expanded=!1,c=0,m="",this._SplitBuffer="";continue}m?(m.format&&(m.format.offset=u,l.push(m.format)),l.push(C=this.getFormatBlock(u)),m.text!==null&&m.text.length>0&&(a.push(m.text),u+=m.text.length,this.textLength+=m.text.length)):l.push(C=this.getFormatBlock(u))}c=0,this._SplitBuffer=""}else d==="<"?(this.enableDebug&&this.emit("debug","Malformed MXP Tag: "+m),_--,f.pop(),this.rawLength--,a.push("<"+m),u+=m.length+1,this.textLength+=m.length+1,c=0,this._SplitBuffer=""):(this._SplitBuffer+=d,m+=d);break;case 5:d==="'"?(c=9,this._SplitBuffer+=d,k[k.length-1]+=d):(this._SplitBuffer+=d,k[k.length-1]+=d);break;case 6:d==='"'?(c=9,this._SplitBuffer+=d,k[k.length-1]+=d):(this._SplitBuffer+=d,k[k.length-1]+=d);break;case 9:if(d==="'")c=5,k[k.length-1]+=d,this._SplitBuffer+=d;else if(d==='"')c=6,k[k.length-1]+=d,this._SplitBuffer+=d;else if(d===`
`||d==="\x1B")_--,f.pop(),this.rawLength--,c=0,this._SplitBuffer="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen();else if(d===" ")c=9,k.push(""),this._SplitBuffer+=d;else if(d===">"){if(m.toUpperCase()==="IMAGE"&&(this.mxpState.lineType===1||this.mxpState.lineType===6||this.mxpState.lineType===4))m=this.getMXPBlock(m,k,e,m),m!==null&&m.format!==null&&(m.format.offset=u,l.push(m.format)),l.push(C=this.getFormatBlock(u));else{if(m=this.getMXPBlock(m,k,e,m,l),this.mxpState.expanded){m!==null&&(t=t.splice(_+1,m.text)),b=t.length,this.mxpState.expanded=!1,c=0,this._SplitBuffer="";continue}m!==null?(m!==null&&m.format&&(m.format.offset=u,l.push(m.format)),l.push(C=this.getFormatBlock(u)),m.text!==null&&(a.push(m.text),u+=m.text.length,this.textLength+=m.text.length)):l.push(C=this.getFormatBlock(u))}c=0,this._SplitBuffer=""}else this._SplitBuffer+=d,k[k.length-1]+=d;break;case 7:if(d===`
`||d==="\x1B"){if(_--,f.pop(),this.rawLength--,this.enableDebug&&this.emit("debug","MXP Entity: "+T),y===4)m+="&"+T,c=y;else{if(T=this.GetEntity(T),this.mxpState.expanded){m!==null&&(t=t.splice(_+1,T)),b=t.length,this.mxpState.expanded=!1,c=0,this._SplitBuffer="";continue}g=Lt("&"+T),a.push(g),this.MXPCapture("&"+T),u+=g.length,this.textLength+=g.length,this.mxpState.noBreak=!1,c=0,this._SplitBuffer="",C.unicode=!0}this.mxpState.on&&d===`
`&&this.ClearMXPOpen()}else if(d===";"){if(this.enableDebug&&this.emit("debug","MXP Entity: "+T),y!==4){if(T=this.GetEntity(T),this.mxpState.expanded){t=t.splice(_+1,T),b=t.length,this.mxpState.expanded=!1,c=y,this._SplitBuffer="";continue}g=Lt("&"+T+";"),a.push(g),this.MXPCapture("&"),this.MXPCapture(T),this.MXPCapture(";"),u+=g.length,this.textLength+=g.length,this.mxpState.noBreak=!1,this._SplitBuffer=""}else m+="&"+T+";";C.unicode=!0,c=y}else d==="&"?(this.enableDebug&&this.emit("debug","Malformed MXP Entity: "+T),y!==4?(a.push("&"+T),this.MXPCapture("&"),this.MXPCapture(T),u+=T.length+1,this.textLength+=T.length+1,this.mxpState.noBreak=!1,this._SplitBuffer="",_--,f.pop(),this.rawLength--):m+="&"+T,C.unicode=!0,c=y):(this._SplitBuffer+=d,T+=d);break;case 8:I.endsWith("-->")?(this.enableDebug&&this.emit("debug","MXP Comment: "+I),_--,f.pop(),this.rawLength--,c=y,c===0&&(this._SplitBuffer=""),I=""):d===`
`||d==="\x1B"?(this.enableDebug&&this.emit("debug","MXP Comment: "+I),_--,f.pop(),this.rawLength--,c=y,I="",this.mxpState.on&&d===`
`&&this.ClearMXPOpen()):I+=d;break;case 10:if(_>P+2)a.pop(),a.pop(),f.pop(),f.pop(),this.rawLength-=2,u-=2,this.textLength-=2,this.MXPDeCapture(2),_=P,c=0;else if(d==="/"){if(a.push(d),this.MXPCapture(d),u++,this.textLength++,_===P+2){for(c=11,P=a.length-4,E=a.length-1,G=l.length,M-=2;P>0&&ot(a[P],!0);)P--,M--;ot(a[P],!0)||(P++,M++),D=[],P>0&&a[P-1]==="("&&D.push(")"),P>0&&a[P-1]==="["&&D.push("]")}}else _>P+1?(a.pop(),f.pop(),this.rawLength--,u--,this.textLength--,this.MXPDeCapture(1),_=P,c=0):(_=P,c=0,f.pop(),this.rawLength--);break;case 11:ot(d,!1)?D.length>1&&D[D.length-1]===d?(D.pop(),a.push(d),this.MXPCapture(d),u++,this.textLength++,v>255&&(C.unicode=!0)):D.length>0&&d==="("?(D.push(")"),a.push(d),this.MXPCapture(d),u++,this.textLength++,v>255&&(C.unicode=!0)):D.length>0&&d==="["?(D.push("]"),a.push(d),this.MXPCapture(d),u++,this.textLength++,v>255&&(C.unicode=!0)):D.length===1&&D[D.length-1]===d?(E!==a.length-1&&(I+=a.slice(P).join(""),this.enableDebug&&this.emit("debug","URL Found: "+I),l.splice(G,0,{formatType:1,href:I,offset:M}),l.push({formatType:2,href:I,offset:u}),l.push(C=this.getFormatBlock(u))),c=0,_--,f.pop(),this.rawLength--):(v>255&&(C.unicode=!0),a.push(d),this.MXPCapture(d),u++,this.textLength++):(E!==a.length-1&&(I+=a.slice(P).join(""),this.enableDebug&&this.emit("debug","URL Found: "+I),l.splice(G,0,{formatType:1,offset:M,href:I}),l.push({formatType:2,offset:u,href:I}),l.push(C=this.getFormatBlock(u))),c=0,_--,f.pop(),this.rawLength--);break;case 12:d===")"?(P=this.mxpState.lineType,this.mxpState.lineType=4,this.getMXPBlock("SOUND",k,e),this.mxpState.lineType=P,c=0,_+1<b&&t.charAt(_+1)===`
`?(_++,H=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(u)],this.mxpState.noBreak=!1,u=0):_+2<b&&t[_+1]==="\r"&&t[_+2]===`
`&&(_+=2,H=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(u)],this.mxpState.noBreak=!1,u=0)):d===" "?k.push(""):k[k.length-1]+=d;break;case 13:d===")"?(P=this.mxpState.lineType,this.mxpState.lineType=4,this.getMXPBlock("MUSIC",k,e),this.mxpState.lineType=P,c=0,_+1<b&&t.charAt(_+1)===`
`?(_++,H=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(u)],this.mxpState.noBreak=!1,u=0):_+2<b&&t[_+1]==="\r"&&t[_+2]===`
`&&(_+=2,H=!1,a=[],l=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(u)],this.mxpState.noBreak=!1,u=0)):d===" "?k.push(""):k[k.length-1]+=d;break;default:if(N&&v===7)se?(d="\u2407",a.push(d),this.MXPCapture(d),u++,this.textLength++,this.mxpState.noBreak=!1):J&&(a.push(d),this.MXPCapture("&#x2407;"),u++,this.textLength++,this.mxpState.noBreak=!1),this.emit("bell");else if(N&&d==="\b"){if(H=!1,u>0){if(a.length){for(;a[a.length-1].length===0;)a.pop();a[a.length-1].length===1?a.pop():a[a.length-1]=a[a.length-1].substring(0,a[a.length-1].length-1)}C.offset===u&&C.offset--,u--,this.textLength--}J&&(d="\u25D8",a.push(d),this.MXPCapture(d),u++,this.textLength++),this.mxpState.noBreak=!1}else if(N&&d==="	"){let w=L-u%L;w>0&&(a.push(Array(w+1).join(" ")),this.MXPCapture(Array(w+1).join(" ")),u+=w,this.textLength+=w,this.mxpState.noBreak=!1)}else if(d===`
`){if(this.mxpState.noBreak||this.mxpState.paragraph)continue;if(this.mxpState.locked)l.push(...this.getMXPCloseFormatBlocks()),this.mxpState.on&&this.ClearMXPOpen();else{if(this.mxpState.lineType!==0&&this.emit("MXP-tag-end",this.mxpState.lineType,a.join(""),l),!this.mxpState.lineExpanded&&this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(x="",this.mxpLines[this.mxpState.lineType].element.length>0&&(x+="</"+this.mxpLines[this.mxpState.lineType].element+">"),this.mxpLines[this.mxpState.lineType].closeDefinition.length>0&&(x+=this.mxpLines[this.mxpState.lineType].closeDefinition),x.length>0)){t=t.splice(_,x),b=t.length,_--,f.pop(),this.rawLength--,this.mxpState.lineExpanded=!0;continue}this.mxpState.lineExpanded=!1,l.push(...this.getMXPCloseFormatBlocks()),this.mxpState.on&&this.ClearMXPOpen(),this.mxpState.on=!1,this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&this.mxpLines[this.mxpState.lineType].gag&&(H=!0),this.mxpState.lineType=this.iMXPDefaultMode,this.mxpState.lineType!==2&&!this.enableMXP&&this.ResetMXP()}u=0,H||this.MXPCapture(`
`),this.AddLine(a.join(""),f.join(""),!1,H,l,e),H=!1,a=[],f=[],l=[...this.getMXPOpenFormatBlocks(),C=this.getFormatBlock(u)],this.textLength++,this.mxpState.noBreak=!1}else{if(N&&d==="\r")continue;if(N&&d==="\x1B")this._SplitBuffer+=d,c=1;else if(v<32||v===127)if(se)v===1?d="\u263A":v===2?d="\u263B":v===3?d="\u2665":v===4?d="\u2666":v===5?d="\u2663":v===6?d="\u2660":v===7?d="\u2407":v===8?d="\u25D8":v===9?d="\u25CB":v===10?d="\u25D9":v===11?d="\u2642":v===12?d="\u2640":v===13?d="\u266A":v===14?d="\u266B":v===15?d="\u263C":v===16?d="\u25BA":v===17?d="\u25C4":v===18?d="\u2195":v===19?d="\u203C":v===20?d="\xB6":v===21?d="\xA7":v===22?d="\u25AC":v===23?d="\u21A8":v===24?d="\u2191":v===25?d="\u2193":v===26?d="\u2192":v===27?d="\u2190":v===28?d="\u221F":v===29?d="\u2194":v===30?d="\u25B2":v===31?d="\u25BC":v===127&&(d="\u2302"),a.push(d),this.MXPCapture(d),u++,this.textLength++,this.mxpState.noBreak=!1;else if(J)v=9216+v,a.push(String.fromCharCode(v)),this.MXPCapture("&#"),this.MXPCapture(v.toString()),this.MXPCapture(";"),u++,this.textLength++,this.mxpState.noBreak=!1;else continue;else if(d===" "||this._CurrentAttributes>0&&(this._CurrentAttributes&128)===128)a.push(" "),this.MXPCapture(" "),u++,this.textLength++,this.mxpState.noBreak=!1;else if(d==="<"&&_>=S)this.enableMXP&&this.mxpState.on?(m="",k=[],this._SplitBuffer+=d,c=4):(a.push("<"),this.MXPCapture("&lt;"),u++,this.textLength++);else if(d===">")a.push(">"),this.MXPCapture("&gt;"),u++,this.textLength++,this.mxpState.noBreak=!1;else if(d==="&"&&_>=S)this.enableMXP&&this.mxpState.on?(T="",this._SplitBuffer+=d,y=c,c=7):(a.push(d),u++,this.textLength++,this.mxpState.noBreak=!1);else if(d==='"')a.push(d),this.MXPCapture("&quot;"),u++,this.textLength++,this.mxpState.noBreak=!1;else if(d==="'")a.push(d),this.MXPCapture("&apos;"),u++,this.textLength++,this.mxpState.noBreak=!1;else if(d===":"){if(a.push(d),this.MXPCapture(d),u++,this.textLength++,this.mxpState.noBreak=!1,oe){I="";let w,K=!1;for(B=0;B<V;B++){if(_-this.protocols[B].length<0)continue;w=!1;let O=this.protocols[B].length;for(let R=0;R<O;R++)if(t[_-(O-R)]!==this.protocols[B][R]){w=!0;break}if(!w&&(P=a.length,M=u,G=l.length,!(P>1+O&&a[P-(2+O)].length===1&&/\S/.test(a[P-(2+O)])&&a[P-(2+O)]!=="("&&a[P-(2+O)]!=="[")&&(D=[],P=a.length-(1+O),M-=1+O,E=a.length-1,P>0&&a[P-1]==="("&&D.push(")"),P>0&&a[P-1]==="["&&D.push("]"),c=11,K=!0,K)))break}K||(c=10,P=_,M=u)}}else if(d==="."){if(a.push(d),this.MXPCapture(d),u++,this.textLength++,this.mxpState.noBreak=!1,oe&&_-3>=0&&(I="http://",(t[_-1]==="w"||_[P-1]==="W")&&(t[_-2]==="w"||_[P-2]==="W")&&(t[_-3]==="w"||_[P-3]==="W"))){if(P=a.length,M=u,G=l.length,P>4&&a[P-5].length===1&&/\S/.test(a[P-5])&&a[P-5]!=="("&&a[P-5]!=="[")continue;D=[],P=a.length-4,M-=4,E=a.length-1,P>0&&a[P-1]==="("&&D.push(")"),P>0&&a[P-1]==="["&&D.push("]"),c=11}}else ee&&u===0&&t.substring(_,_+8)==="!!MUSIC("?(k=[""],c=13,_+=7,this.mxpState.noBreak=!1):ee&&u===0&&t.substring(_,_+8)==="!!SOUND("?(k=[""],c=12,_+=7,this.mxpState.noBreak=!1):(se&&v>127&&v<255?v===128?d="\xC7":v===129?d="\xFC":v===130?d="\xE9":v===131?d="\xE2":v===132?d="\xE4":v===133?d="\xE0":v===134?d="\xE5":v===135?d="\xE7":v===136?d="\xEA":v===137?d="\xEB":v===138?d="\xE8":v===139?d="\xEF":v===140?d="\xEE":v===141?d="\xEC":v===142?d="\xC4":v===143?d="\xC5":v===144?d="\xC9":v===145?d="\xE6":v===146?d="\xC6":v===147?d="\xF4":v===148?d="\xF6":v===149?d="\xF2":v===150?d="\xFB":v===151?d="\xF9":v===152?d="\xFF":v===153?d="\xD6":v===154?d="\xDC":v===155?d="\xA2":v===156?d="\xA3":v===157?d="\xA5":v===158?d="\u20A7":v===159?d="\u0192":v===160?d="\xE1":v===161?d="\xED":v===162?d="\xF3":v===163?d="\xFA":v===164?d="\xF1":v===165?d="\xD1":v===166?d="\xAA":v===167?d="\xBA":v===168?d="\xBF":v===169?d="\u2310":v===170?d="\xAC":v===171?d="\xBD":v===172?d="\xBC":v===173?d="\xA1":v===174?d="\xAB":v===175?d="\xBB":v===176?d="\u2591":v===177?d="\u2592":v===178?d="\u2593":v===179?d="\u2502":v===180?d="\u2524":v===181?d="\u2561":v===182?d="\u2562":v===183?d="\u2556":v===184?d="\u2555":v===185?d="\u2563":v===186?d="\u2551":v===187?d="\u2557":v===188?d="\u255D":v===189?d="\u255C":v===190?d="\u255B":v===191?d="\u2510":v===192?d="\u2514":v===193?d="\u2534":v===194?d="\u252C":v===195?d="\u251C":v===196?d="\u2500":v===197?d="\u253C":v===198?d="\u255E":v===199?d="\u255F":v===200?d="\u255A":v===201?d="\u2554":v===202?d="\u2569":v===203?d="\u2566":v===204?d="\u2560":v===205?d="\u2550":v===206?d="\u256C":v===207?d="\u2567":v===208?d="\u2568":v===209?d="\u2564":v===210?d="\u2565":v===211?d="\u2559":v===212?d="\u2558":v===213?d="\u2552":v===214?d="\u2553":v===215?d="\u256B":v===216?d="\u256A":v===217?d="\u2518":v===218?d="\u250C":v===219?d="\u2588":v===220?d="\u2584":v===221?d="\u258C":v===222?d="\u2590":v===223?d="\u2580":v===224?d="\u03B1":v===225?d="\u03B2":v===226?d="\u0393":v===227?d="\u03C0":v===228?d="\u03A3":v===229?d="\u03C3":v===230?d="\xB5":v===231?d="\u03C4":v===232?d="\u03A6":v===233?d="\u0398":v===234?d="\u03A9":v===235?d="\u03B4":v===236?d="\u221E":v===237?d="\u2205":v===238?d="\u2208":v===239?d="\u2229":v===240?d="\u2261":v===241?d="\xB1":v===242?d="\u2265":v===243?d="\u2264":v===244?d="\u2320":v===245?d="\u2321":v===246?d="\xF7":v===247?d="\u2248":v===248?d="\xB0":v===249?d="\u2219":v===250?d="\xB7":v===251?d="\u221A":v===252?d="\u207F":v===253?d="\xB2":v===254&&(d="\u25A0"):v>255&&(C.unicode=!0),a.push(d),this.MXPCapture(d),u++,this.textLength++,this.mxpState.noBreak=!1)}break}this._SplitBuffer.length&&(this.rawLength-=this._SplitBuffer.length,f.splice(f.length-this._SplitBuffer.length,this._SplitBuffer.length)),l.push(...this.getMXPCloseFormatBlocks()),c===11&&l.splice(G,0,{formatType:1,offset:M,href:I+=a.slice(P).join("")}),this.AddLine(a.join(""),f.join(""),!0,!1,l,e)}catch(w){this.enableDebug&&this.emit("debug",w)}this.busy=!1,this.emit("parse-done"),this.parsing.shift(),this.parsing.length>0&&setTimeout(this.parseNext(),0)}parseNext(){let t=this.parsing.shift();return()=>{this.parse(t[0],t[1],!0,t[2])}}updateWindow(t,e){this.window={width:t,height:e}}Clear(){this.ResetColors(),this.textLength=0,this._SplitBuffer=""}ClearMXP(){this.mxpEntities={},this.ResetMXP(),this.mxpElements={},this.mxpState=new mt}ResetMXP(){this.mxpStyles=[],this.mxpStyles.push(new Xe(0,"","",!1))}ResetMXPLine(){this.iMXPDefaultMode=0,this.mxpState.lineType=0}GetPublicEntity(t){return this.mxpEntities[t]&&this.mxpEntities[t].publish?this.mxpEntities[t].value:t}};var tt=class extends ie{constructor(t,e){super();this._updating=0;this._enableDebug=!1;this._maxView=0;this._padding=[0,0,0,0];this._enableColors=!0;this._enableBackgroundColors=!0;this._hideTrailingEmptyLine=!0;this._maxLines=500;this._wordWrap=!1;this._indent=4;this._indentPadding=0;this._wrapAt=0;this._scrollAtEnd=!1;this._lineCache=[];this._expireCache=[];this._timestamp=0;this._timestampFormat="[[]MM-DD HH:mm:ss.SSS[]] ";this._timestampWidth=new Date().toISOString().length+1;this.scrollLock=!1;if(!t)throw new Error("Container must be a selector, element or jquery object");if(typeof t=="object"&&"container"in t&&(e=Object.assign(e||{},t),t=e.container,delete e.container),typeof t=="string"){if(this._container=document.querySelector(t),!this._container)throw new Error("Invalid selector for display.")}else if(t instanceof $)this._container=t[0];else if(t instanceof HTMLElement)this._container=t;else throw new Error("Container must be a selector, element or jquery object");this._styles=document.createElement("style"),this._container.appendChild(this._styles),this._character=document.createElement("span"),this._character.id=this.id+"-Character",this._character.className="line",this._character.innerHTML='<span style="border-bottom: 1px solid rgb(0, 0, 0);">W</span>',this._character.style.visibility="hidden",this._container.appendChild(this._character),this._view=document.createElement("div"),this._view.className="view",this._view.addEventListener("scroll",()=>{this._scrollAtEnd=this._view.clientHeight+this._view.scrollTop>=this._view.scrollHeight}),this._view.addEventListener("click",i=>{this.emit("click",i)}),this._view.addEventListener("contextmenu",i=>{this.emit("contextmenu",i)}),this._container.appendChild(this._view),this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width),e?e.display=this:e={display:this},this.model=new Wt(e),this._wResize=i=>{this._scrollAtEnd&&this.scrollDisplay(),Ge(()=>{this.doUpdate(17)},250,"resize")},window.addEventListener("resize",this._wResize.bind(this)),this._resizeObserver=new ResizeObserver((i,n)=>{i.length!==0&&(!i[0].contentRect||i[0].contentRect.width===0||i[0].contentRect.height===0||Ge(()=>{(!this._resizeObserverCache||this._resizeObserverCache.width!==i[0].contentRect.width||this._resizeObserverCache.height!==i[0].contentRect.height)&&(this._scrollAtEnd&&this.scrollDisplay(),this._resizeObserverCache={width:i[0].contentRect.width,height:i[0].contentRect.height},this.doUpdate(17),this.emit("resize"))},250,"resize"))}),this._resizeObserver.observe(this._container),this._observer=new MutationObserver(i=>{let n;for(n of i)n.type==="attributes"&&n.attributeName==="style"&&(this._scrollAtEnd&&this.scrollDisplay(),this.doUpdate(17),this.emit("resize"))}),this._observer.observe(this._container,{attributes:!0,attributeOldValue:!0,attributeFilter:["style"]}),!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.updateFont()}get showTimestamp(){return this._timestamp}set showTimestamp(t){t!==this._timestamp&&(this._timestamp=t,!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.buildStyleSheet(),this.doUpdate(35))}get timestampFormat(){return this._timestampFormat}set timestampFormat(t){this._timestampFormat!==t&&(this._timestampFormat=t,!moment||this._timestamp!==2?this._timestampWidth=new Date().toISOString().length+1:this._timestampWidth=moment().format(this._timestampFormat).length,this.doUpdate(51))}get wordWrap(){return this._wordWrap}set wordWrap(t){t!==this._wordWrap&&(this._wordWrap=t,this.buildStyleSheet(),this.doUpdate(1))}get wrapAt(){return this._wrapAt}set wrapAt(t){t!==this._wrapAt&&(this._wrapAt=t,this.buildStyleSheet(),this.doUpdate(3))}get indent(){return this._indent}set indent(t){t!==this._indent&&(this._indent=t,this.buildStyleSheet(),this.doUpdate(3))}get linkFunction(){return this._linkFunction||"doLink"}set linkFunction(t){this._linkFunction=t}get mxpLinkFunction(){return this._mxpLinkFunction||"doMXPLink"}set mxpLinkFunction(t){this._mxpLinkFunction=t}get mxpSendFunction(){return this._mxpSendFunction||"doMXPSend"}set mxpSendFunction(t){this._mxpSendFunction=t}get mxpTooltipFunction(){return this._mxpTooltipFunction||"doMXPTooltip"}set mxpTooltipFunction(t){this._mxpTooltipFunction=t}get id(){return this._container?this._container.id:""}get container(){return this._container}get lines(){return this._model.lines}get model(){return this._model}set model(t){this._model!==t&&(this._model&&this._model.removeAllListeners(),this._model=t,this._model.on("debug",this.debug,this),this._model.on("bell",()=>{this.emit("bell")}),this._model.on("add-line",e=>{this.emit("add-line",e)}),this._model.on("add-line-done",e=>{this.emit("add-line-done",e)}),this._model.on("line-added",(e,i)=>{this._lineCache.push(this.getLineHTML(e.idx))}),this._model.on("expire-links",e=>{if(this._expireCache.length){let i,n;for(let s=0,o=this._expireCache.length;s<o;s++)this.rebuildLine(this._expireCache[s])}this._expireCache=[],this.emit("expire-links")}),this._model.on("parse-done",()=>{this._view.insertAdjacentHTML("beforeend",this._lineCache.join("")),this._lineCache=[],this.doUpdate(2),this.emit("parse-done")}),this._model.on("set-title",(e,i)=>{this.emit("set-title",e,i)}),this._model.on("music",e=>{this.emit("music",e)}),this._model.on("sound",e=>{this.emit("sound",e)}),this._model.on("MXP-tag-reply",(e,i)=>{this.emit("MXP-tag-reply",e,i)}),this._model.on("expire-link-line",e=>{this._expireCache.push(e),this.doUpdate(2)}))}get maxLines(){return this._maxLines}set maxLines(t){t!==this._maxLines&&(this._maxLines=t,this.doUpdate(4))}get enableDebug(){return this._enableDebug}get enableColors(){return this._enableColors}set enableColors(t){t!==this._enableColors&&(this._enableColors=t,this.buildStyleSheet())}get enableBackgroundColors(){return this._enableBackgroundColors}set enableBackgroundColors(t){t!==this._enableBackgroundColors&&(this._enableBackgroundColors=t,this.buildStyleSheet())}get hideTrailingEmptyLine(){return this._hideTrailingEmptyLine}set hideTrailingEmptyLine(t){t!==this._hideTrailingEmptyLine&&(this._hideTrailingEmptyLine=t,this.doUpdate(2))}set enableDebug(t){this._enableDebug=t,this._model.enableDebug=t}get tabWidth(){return this._model.tabWidth}set tabWidth(t){this._model.tabWidth=t}get textLength(){return this._model.textLength}get EndOfLine(){return this._model.EndOfLine}get parseQueueLength(){return this._model.parseQueueLength}get parseQueueEndOfLine(){return this._model.parseQueueEndOfLine}get EndOfLineLength(){return this.lines.length===0?0:this.lines[this.lines.length-1].text.length}set enableFlashing(t){this._model.enableFlashing=t}get enableFlashing(){return this._model.enableFlashing}set enableMXP(t){this._model.enableMXP=t}get enableMXP(){return this._model.enableMXP}set showInvalidMXPTags(t){this._model.showInvalidMXPTags=t}get showInvalidMXPTags(){return this._model.showInvalidMXPTags}set enableBell(t){this._model.enableBell=t}get enableBell(){return this._model.enableBell}set enableURLDetection(t){this._model.enableURLDetection=t}get enableURLDetection(){return this._model.enableURLDetection}set enableMSP(t){this._model.enableMSP=t}get enableMSP(){return this._model.enableMSP}set displayControlCodes(t){this._model.displayControlCodes=t}get displayControlCodes(){return this._model.displayControlCodes}set emulateTerminal(t){this._model.emulateTerminal=t}get emulateTerminal(){return this._model.emulateTerminal}set emulateControlCodes(t){this._model.emulateControlCodes=t}get emulateControlCodes(){return this._model.emulateControlCodes}set MXPStyleVersion(t){this._model.MXPStyleVersion=t}get MXPStyleVersion(){return this._model.MXPStyleVersion}get WindowSize(){return new $e(this.WindowWidth,this.WindowHeight)}get WindowWidth(){return Math.trunc(this._maxView/this._charWidth)}get WindowHeight(){return this._view.scrollWidth>this._view.clientWidth?Math.trunc((this._innerHeight-Mt()-this._padding[0]-this._padding[2])/this._charHeight):Math.trunc((this._innerHeight-this._padding[0]-this._padding[2])/this._charHeight)}get html(){let t=this.lines.length,e=[];for(let i=0;i<t;i++)e.push(this.getLineHTML(i));return e.join("")}get text(){return this._model.text}get raw(){return this._model.raw}get scrollAtBottom(){return this._scrollAtEnd}debug(t){this.emit("debug",t)}scrollDisplay(){this.scrollLock||(this._view.scrollTop=this._view.scrollHeight)}scrollTo(t,e){this._view.scrollTo(t,e)}scrollToCharacter(t,e){this._view.scrollTo(t*this._charHeight,e*this._charWidth)}scrollBy(t,e){this._view.scrollBy(t,e)}scrollUp(){this._view.scrollBy(0,-this._charHeight)}scrollDown(){this._view.scrollBy(0,this._charHeight)}pageUp(){this._view.scrollBy(0,-this._view.clientHeight)}pageDown(){this._view.scrollBy(0,this._view.clientHeight)}trimLines(){if(this._maxLines!==-1&&this.lines.length>this._maxLines){let t=this.lines.length-this._maxLines,e=t;for(;e-- >0;)this._view.removeChild(this._view.firstChild);this._model.removeLines(0,t)}}append(t,e,i,n){this._model.append(t,e||!1,i||!1,n||!1)}CurrentAnsiCode(){return this._model.CurrentAnsiCode()}removeLine(t,e){if(t<0||t>=this.lines.length)return;this.emit("line-removed",t,this.lines[t].text);let i=this._model.getLineID(t),n=document.querySelector(`[data-id="${i}"]`);this._view.removeChild(n),this._model.removeLine(t)}removeLines(t,e){t<0||t>=this.lines.length||(e<1&&(e=1),this.emit("lines-removed",t,this.lines.slice(t,t+e-1)),this._view.replaceChildren(...[].slice.call(this._view.children,0,t),...[].slice.call(this._view.children,t+e)),this._model.removeLines(t,e))}updateDisplay(){this._view.classList.remove("animate"),this.doUpdate(4),this._hideTrailingEmptyLine&&this.lines.length&&this.lines[this.lines.length-1].text.length===0&&(this._view.lastChild.style.display="none"),this.doUpdate(24),this._view.classList.add("animate")}updateWindow(t,e){t===void 0&&(t=this.WindowWidth,e=this.WindowHeight),this._model.updateWindow(t,e),this.emit("update-window",t,e)}clear(){this._model.clear(),this._view.innerHTML=""}dispose(){for(document.body.removeChild(this._character),document.body.removeChild(this._styles);this._container.firstChild;)this._view.removeChild(this._view.firstChild);window.removeEventListener("resize",this._wResize)}update(){let t=Mt();this._maxView=this._view.clientWidth-this._padding[1]-this._padding[3]-t-this._indentPadding,this._timestamp!==0&&(this._maxView-=this._timestampWidth*this._charWidth),this._innerHeight=this._view.clientHeight}updateFont(t,e){!t||t.length===0?t='"Courier New", Courier, monospace':t+=", monospace",(!e||e.length===0)&&(e="1em"),(t!==this._container.style.fontFamily||e!==this._container.style.fontSize)&&(this._container.style.fontSize=e,this._container.style.fontFamily=t,this._character.style.fontSize=e,this._character.style.fontFamily=t,this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width),setTimeout(()=>{this._charHeight=parseFloat(window.getComputedStyle(this._character).height),this._charWidth=parseFloat(window.getComputedStyle(this._character.firstElementChild).width)},250),this.buildStyleSheet(),this.doUpdate(25));let i=window.getComputedStyle(this._view),n=[parseInt(i.getPropertyValue("padding-top"))||0,parseInt(i.getPropertyValue("padding-right"))||0,parseInt(i.getPropertyValue("padding-bottom"))||0,parseInt(i.getPropertyValue("padding-left"))||0];(n[0]!==this._padding[0]||n[1]!==this._padding[1]||n[2]!==this._padding[2]||n[3]!==this._padding[3])&&(this._padding=n,this.doUpdate(1))}buildStyleSheet(){let t="";this._enableColors||(t+=".view > span span {color: inherit !important;}"),(!this._enableColors||!this._enableBackgroundColors)&&(t+=".background > span span {background-color: inherit !important;}"),this._wordWrap?t+=".view {white-space: break-spaces; }":this._wrapAt>0&&(t+=`.view {white-space: break-spaces; } .line {width: ${this._wrapAt*this._charWidth}px !important;max-width:  ${this._wrapAt*this._charWidth}px;min-width:  ${this._wrapAt*this._charWidth}px;display: block;}`),(this._wordWrap||this._wrapAt>0)&&this._indent>0&&(t+=`.view {  padding-left: 0px !important; text-indent: ${this._indent*this._charWidth}px hanging; }`),t+=`.line > span { min-height: ${this._charHeight}}`,this._timestamp!==0&&(t+=".timestamp { display: inline-block; }"),this._styles.innerHTML=t,(this._wordWrap||this._wrapAt>0)&&this._indent>0?this._indentPadding=parseFloat(window.getComputedStyle(this._view).paddingLeft)/2:this._indentPadding=0}getLineHTML(t,e,i,n){t===void 0||t>=this.lines.length?t=this.lines.length-1:t<0&&(t=0),(e===void 0||e<0)&&(e=0),(i===void 0||i===-1)&&(i=this.lines[t].text.length);let s=[],o=0,r="",a="",l=this.lines[t].text,f=this.lines[t].formats,c=f.length,y=!1,u=this._model.getLineID(t);this._timestamp===2&&moment?s.push('<span class="timestamp" style="color:',this._model.GetColor(-7),";background:",this._model.GetColor(-8),';"',a,">",moment(this.lines[t].timestamp).format(this._timestampFormat),"</span>"):this._timestamp===1&&s.push('<span class="timestamp" style="color:',this._model.GetColor(-7),";background:",this._model.GetColor(-8),';"',a,">",new Date(this.lines[t].timestamp).toISOString()," </span>");for(let x=0;x<c;x++){let S=f[x],m,g,T=[];if(x<c-1){if(m=f[x+1],S.offset===m.offset&&m.formatType===S.formatType)continue;g=m.offset}else g=l.length;if(o=S.offset,g>i&&(g=i),o<e&&(o=e),S.formatType===0){if(r=[],a=[],typeof S.background=="number"?r.push("background:",this._model.GetColor(S.background),";"):S.background&&r.push("background:",S.background,";"),typeof S.color=="number"?r.push("color:",this._model.GetColor(S.color),";"):S.color&&r.push("color:",S.color,";"),S.font&&r.push("font-family: ",S.font,";"),S.size&&r.push("font-size: ",S.size,";"),S.style!==0?((S.style&1)===1&&r.push("font-weight: bold;"),(S.style&4)===4&&r.push("font-style: italic;"),(S.style&1024)===1024&&T.push("overline "),((S.style&512)===512||(S.style&8)===8)&&T.push("underline "),(S.style&512)===512?r.push("border-bottom: 1px solid ",typeof S.color=="number"?this._model.GetColor(S.color):S.color,";"):r.push("border-bottom: 1px solid ",typeof S.background=="number"?this._model.GetColor(S.background):S.background,";"),((S.style&32)===32||(S.style&16)===16)&&(this.enableFlashing?a.push(" ansi-blink"):(S.style&512)!==512&&(S.style&8)!==8&&T.push("underline ")),(S.style&256)===256&&T.push("line-through "),T.length>0&&r.push("text-decoration:",T.join("").trim(),";")):r.push("border-bottom: 1px solid ",typeof S.background=="number"?this._model.GetColor(S.background):S.background,";"),o<e||g<e)continue;r=r.join("").trim(),a.length!==0?a=' class="'+a.join("").trim()+'"':a="",S.hr?s.push('<span style="',r,'min-width:100%;width:100%;"',a,'><div style="position:relative;top: 50%;transform: translateY(-50%);height:4px;width:100%; background-color:',typeof S.color=="number"?this._model.GetColor(S.color):S.color,'"></div></span>'):g-o!==0&&s.push('<span style="',r,'"',a,">",Ie(l.substring(o,g)),"</span>")}else if(S.formatType===1){if(o<e||g<e||(s.push('<a draggable="false" class="URLLink" href="javascript:void(0);" title="'),s.push(S.href.replace(/"/g,"&quot;")),s.push('" onclick="',this.linkFunction,"('",S.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),`');return false;">`),g-o===0))continue;s.push('<span style="',r,'"',a,">"),s.push(Ie(l.substring(o,g))),s.push("</span>")}else if(S.formatType===2||S.formatType===4||S.formatType===8){if(o<e||g<e)continue;s.push("</a>")}else if(S.formatType===3){if(o<e||g<e||(s.push('<a draggable="false" class="MXPLink" href="javascript:void(0);" title="'),s.push(S.href.replace(/"/g,"&quot;")),s.push('"'),S.expire&&S.expire.length&&s.push(` data-expire="${S.expire}"`),s.push(' onclick="',this.mxpLinkFunction,"(this, '",S.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),`');return false;">`),g-o===0))continue;s.push('<span style="',r,'"',a,">"),s.push(Ie(l.substring(o,g))),s.push("</span>")}else if(S.formatType===7){if(o<e||g<e||(s.push('<a draggable="false" class="MXPLink" href="javascript:void(0);" title="'),s.push(S.hint.replace(/"/g,"&quot;")),s.push('"'),S.expire&&S.expire.length&&s.push(` data-expire="${S.expire}"`),s.push(' onmouseover="',this.mxpTooltipFunction,'(this);"'),s.push(' onclick="',this.mxpSendFunction,"(event||window.event, this, ",S.href.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),", ",S.prompt?"1":"0",", ",S.tt.replace(/\\/g,"\\\\").replace(/"/g,"&quot;"),');return false;">'),g-o===0))continue;s.push('<span style="',r,'"',a,">"),s.push(Ie(l.substring(o,g))),s.push("</span>")}else if(S.formatType===9&&g-o!==0){if(o<e||g<e)continue;s.push('<span style="',r,'"',a,">"),s.push(Ie(l.substring(o,g))),s.push("</span>")}else if(S.formatType===5){if(o<e||g<e)continue;let I="";switch(s.push('<img src="'),S.url.length>0&&(s.push(S.url),I+=S.url,S.url.endsWith("/")||(s.push("/"),I+="/")),S.t.length>0&&(s.push(S.t),I+=S.t,S.t.endsWith("/")||(s.push("/"),I+="/")),I+=S.name,s.push(S.name,'"  style="'),S.w.length>0&&s.push("width:",Me(S.w,this._charWidth),";"),S.h.length>0&&s.push("height:",Me(S.h,this._charHeight),";"),S.align.toLowerCase()){case"left":s.push("float:left;");break;case"right":s.push("float:right;"),y=!0;break;case"top":case"middle":case"bottom":s.push("vertical-align:",S.align,";");break}S.hspace.length>0&&S.vspace.length>0?(s.push("margin:"),s.push(Me(S.vspace,this._charWidth)," "),s.push(Me(S.hspace,this._charHeight),";")):S.hspace.length>0?(s.push("margin:"),s.push("0px ",Me(S.hspace,this._charHeight),";")):S.vspace.length>0&&(s.push("margin:"),s.push(Me(S.vspace,this._charWidth)," 0px;")),s.push('"'),S.ismap&&s.push(' ismap onclick="return false;"'),s.push(`src="${I}"/>`)}}return n?y&&i<this.lines[t].text.length?s.join(""):y?s.join("")+"<br>":i<this.lines[t].text.length?s.join(""):s.join("")+"<br>":y&&i<this.lines[t].text.length?`<span data-id="${u}" class="line" style="min-width:100%">${s.join("")}</span>`:y?`<span data-id="${u}" class="line" style="min-width:100%">${s.join("")}<br></span>`:i<this.lines[t].text.length?`<span data-id="${u}" class="line">${s.join("")}</span>`:`<span  data-id="${u}" class="line">${s.join("")}<br></span>`}getLineText(t,e){return t<0||t>=this.lines.length||!this.lines[t]?"":this.lines[t].text}rebuildLine(t){this.rebuildLines(t,t)}rebuildLines(t,e){if(!this.lines.length)return;(t===void 0||t<0)&&(t=0),(e===void 0||e===-1||e>=this.lines.length)&&(e=this.lines.length-1);let i=this.lines,n=[],s=t;for(;s<=e;s++)n.push(this.getLineHTML(s));t===0&&e===this.lines.length-1?this._view.innerHTML=n.join(""):(this._view.replaceChildren(...[].slice.call(this._view.children,0,t),...[].slice.call(this._view.children,e+1)),t===0?this._view.firstElementChild.insertAdjacentHTML("beforebegin",n.join("")):this._view.children[t-1].insertAdjacentHTML("afterend",n.join("")))}doUpdate(t){t&&(this._updating|=t,this._updating!==0&&window.requestAnimationFrame(()=>{this._updating!==0&&((this._updating&32)===32&&(this.rebuildLines(),this._updating&=-33),(this._updating&1)===1&&(this.update(),this._updating&=-2),(this._updating&2)===2&&(this.updateDisplay(),this._updating&=-3),(this._updating&4)===4&&(this.trimLines(),this._updating&=-5),(this._updating&8)===8&&(this.scrollDisplay(),this._updating&=-9),(this._updating&16)===16&&(this.updateWindow(),this._updating&=-17),this.doUpdate(this._updating))}))}colorSubStrByLine(t,e,i,n,s,o){this.colorSubStringByLine(t,e,i,n,(n||0)+(s||0),o)}colorSubStringByLine(t,e,i,n,s,o){this._model.colorSubStringByLine(t,e,i,n,s,o)&&this.rebuildLine(t)}removeStyleSubStrByLine(t,e,i,n){this.removeStyleSubStringByLine(t,e,i,(i||0)+(n||0))}removeStyleSubStringByLine(t,e,i,n){this._model.removeStyleSubStringByLine(t,e,i,n)&&this.rebuildLine(t)}highlightSubStrByLine(t,e,i){this.highlightStyleSubStringByLine(t,e,(e||0)+(i||0))}highlightStyleSubStringByLine(t,e,i,n){this._model.highlightStyleSubStringByLine(t,e,i,n)&&this.rebuildLine(t)}SetColor(t,e){this._model.SetColor(t,e)}ClearMXP(){this._model.ClearMXP()}ResetMXPLine(){this._model.ResetMXPLine()}},Wt=class extends ie{constructor(t){super();this._lineID=0;this.lines=[];this.lineIDs=[];this._expire={};this._expire2=[];this._parser=new bt(t),this._parser.on("debug",e=>{this.emit(e)}),this._parser.on("bell",()=>{this.emit("bell")}),this._parser.on("add-line",e=>{this.addParserLine(e,!0)}),this._parser.on("expire-links",e=>{let i,n,s;if(!e||e.length===0){for(n in this._expire2)this._expire2.hasOwnProperty(n)&&this.expireLineLinkFormat(this._expire2[n],+n);for(s in this._expire)if(this._expire.hasOwnProperty(s)){i=this._expire[s];for(n in i)i.hasOwnProperty(n)&&this.expireLineLinkFormat(i[n],+n)}this._expire2=[],this._expire={},this.emit("expire-links",e)}else if(this._expire[e]){i=this._expire[e];for(n in i)i.hasOwnProperty(n)&&this.expireLineLinkFormat(i[n],+n);delete this._expire[e],this.emit("expire-links",e)}}),this._parser.on("parse-done",()=>{this.emit("parse-done")}),this._parser.on("set-title",(e,i)=>{this.emit("set-title",e,i)}),this._parser.on("music",e=>{this.emit("music",e)}),this._parser.on("sound",e=>{this.emit("sound",e)}),this._parser.on("MXP-tag-reply",(e,i)=>{this.emit("MXP-tag-reply",e,i)})}get enableDebug(){return this._parser.enableDebug}set enableDebug(t){this._parser.enableDebug=t}get tabWidth(){return this._parser.tabWidth}set tabWidth(t){this._parser.tabWidth=t}get textLength(){return this._parser.textLength}get EndOfLine(){return this._parser.EndOfLine}get parseQueueLength(){return this._parser.parseQueueLength}get parseQueueEndOfLine(){return this._parser.parseQueueEndOfLine}set enableFlashing(t){this._parser.enableFlashing=t}get enableFlashing(){return this._parser.enableFlashing}set enableMXP(t){this._parser.enableMXP=t}get enableMXP(){return this._parser.enableMXP}set showInvalidMXPTags(t){this._parser.showInvalidMXPTags=t}get showInvalidMXPTags(){return this._parser.showInvalidMXPTags}set enableBell(t){this._parser.enableBell=t}get enableBell(){return this._parser.enableBell}set enableURLDetection(t){this._parser.enableURLDetection=t}get enableURLDetection(){return this._parser.enableURLDetection}set enableMSP(t){this._parser.enableMSP=t}get enableMSP(){return this._parser.enableMSP}set displayControlCodes(t){this._parser.displayControlCodes=t}get displayControlCodes(){return this._parser.displayControlCodes}set emulateTerminal(t){this._parser.emulateTerminal=t}get emulateTerminal(){return this._parser.emulateTerminal}set emulateControlCodes(t){this._parser.emulateControlCodes=t}get emulateControlCodes(){return this._parser.emulateControlCodes}set MXPStyleVersion(t){this._parser.StyleVersion=t}get MXPStyleVersion(){return this._parser.StyleVersion}addParserLine(t,e){if(t.timestamp=Date.now(),this.emit("add-line",t),t==null||typeof t>"u"||t.line==null||typeof t.line>"u"||(this.emit("add-line-done",t),t.gagged))return;let i={text:t.line===`
`||t.line.length===0?"":t.line,raw:t.raw,formats:t.formats,id:this._lineID,timestamp:t.timestamp};this.lines.push(i),this.lineIDs.push(this._lineID),this._lineID++,this.buildLineExpires(this.lines.length-1),this.emit("line-added",t,e)}expireLineLinkFormat(t,e){let i,n,s,o,r,a,l,f=0;for(n=0,o=t.length;n<o;n++)for(s=this.lines[e].formats.length,i=t[n],l=this.lines[e].formats[i],r=l.formatType,l.formatType===3?a=4:a=8,l.formatType=9,i++;i<s;i++)if(this.lines[e].formats[i]===a)if(f===0){this.lines[e].formats[i].formatType=10;break}else f--;else this.lines[e].formats[i]===r&&f++;this.emit("expire-link-line",e)}clear(){this._parser.Clear(),this.lines=[],this._expire={},this._expire2=[],this.lineIDs=[],this._lineID=0}IncreaseColor(t,e){return this._parser.IncreaseColor(t,e)}GetColor(t){return this._parser.GetColor(t)}append(t,e,i,n){this._parser.parse(t,e||!1,i||!1,n||!1)}CurrentAnsiCode(){return this._parser.CurrentAnsiCode()}updateWindow(t,e){this._parser.updateWindow(t,e)}SetColor(t,e){this._parser.SetColor(t,e)}ClearMXP(){this._parser.ClearMXP()}ResetMXPLine(){this._parser.ResetMXPLine()}get busy(){return this._parser.busy}removeLine(t){this.lines.splice(t,1),this.lineIDs.splice(t,1),this._expire2.splice(t,1)}removeLines(t,e){this.lines.splice(t,e),this.lineIDs.splice(t,e),this._expire2.splice(t,e);for(let i in this._expire)!this._expire.hasOwnProperty(i)||this._expire[i].length===0||t>=this._expire[i].length||this._expire[i].splice(t,e)}getLineID(t){return t<0||t>=this.lineIDs.length?-1:this.lineIDs[t]}get getNextLineID(){return this._lineID}getLineFromID(t){return this.lineIDs.indexOf(t)}buildLineExpires(t){t===void 0&&(t=this.lines.length-1);let e=this.lines[t].formats;for(let s in this._expire)this._expire.hasOwnProperty(s)&&this._expire[s][t]&&delete this._expire[s][t];delete this._expire2[t];let i=e.length,n;for(;i--;)n=e[i],(n.formatType===7||n.formatType===3)&&(n.expire&&n.expire.length>0?(this._expire[n.expire]||(this._expire[n.expire]=[]),this._expire[n.expire][t]||(this._expire[n.expire][t]=[]),this._expire[n.expire][t].push(i)):(this._expire2[t]||(this._expire2[t]=[]),this._expire2[t].push(i)))}colorSubStrByLine(t,e,i,n,s,o){return this.colorSubStringByLine(t,e,i,n,n+s,o)}colorSubStringByLine(t,e,i,n,s,o){if(t<0||t>=this.lines.length)return!1;let r=this.lines[t].text.length;if(n>=r||((!n||n<0)&&(n=0),(!s||s>r)&&(s=r),n===s))return!1;let a=this.lines[t].formats,l=a.length,f=!1;if(n===0&&s>=r){for(let c=0;c<l;c++){let y=a[c];y.formatType===0&&(f=!0,y.bStyle&&(y.bStyle=0,y.fStyle=0,y.fCls=0),y.color=e||y.color,y.background=i||y.background,y.style|=o||0)}f||a.unshift({formatType:0,offset:0,color:e||0,background:i||0,size:0,font:0,style:o||0,unicode:!1})}else{let c,y;for(let u=0;u<l;u++){let x=a[u];if(x.formatType===0){if(u<l-1){let S=u+1;if(c=a[S],x.offset===c.offset&&c.formatType===x.formatType)continue;for(;x.offset===c.offset&&c.formatType===x.formatType&&S<l-1;)c=a[++S];S===l&&x.offset===c.offset?y=r:y=c.offset}else y=r;n<x.offset||n>=y||(f=!0,x.bStyle&&(x.bStyle=0,x.fStyle=0,x.fCls=0),s<y&&(x.width=0,a.splice(u+1,0,{formatType:x.formatType,offset:s,color:x.color,background:x.background,size:x.size,font:x.font,style:x.style,unicode:x.unicode}),l++),n!=x.offset?(x.width=0,a.splice(u+1,0,{formatType:x.formatType,offset:n,color:e||x.color,background:i||x.background,size:x.size,font:x.font,style:x.style|(o||0),unicode:x.unicode}),l++):(x.color=e||x.color,x.background=i||x.background,x.style|=o||0),s>y&&(n=y))}}this.lines[t].formats=this.pruneFormats(a,this.textLength)}return!0}removeStyleSubStrByLine(t,e,i,n){return this.removeStyleSubStringByLine(t,e,i,i+n)}removeStyleSubStringByLine(t,e,i,n){if(t<0||t>=this.lines.length)return!1;let s=this.lines[t].text.length;if(i>=s)return!1;(!i||i<0)&&(i=0),(!n||n>s)&&(n=s);let o=this.lines[t].formats,r=o.length,a=!1;if(i===0&&n>=s){for(let l=0;l<r;l++){let f=o[l];f.formatType===0&&(a=!0,f.bStyle&&(f.bStyle=0,f.fStyle=0,f.fCls=0),f.style&=~(e||0))}a||o.unshift({formatType:0,offset:0,color:0,background:0,size:0,font:0,style:0,unicode:!1})}else{let l,f;for(let c=0;c<r;c++){let y=o[c];if(y.formatType===0){if(c<r-1){let u=c+1;if(l=o[u],y.offset===l.offset&&l.formatType===y.formatType)continue;for(;y.offset===l.offset&&l.formatType===y.formatType&&u<r-1;)l=o[++u];u===r&&y.offset===l.offset?f=s:f=l.offset}else f=s;i<y.offset||i>=f||(a=!0,y.bStyle&&(y.bStyle=0,y.fStyle=0,y.fCls=0),n<f&&(y.width=0,o.splice(c+1,0,{formatType:y.formatType,offset:n,color:y.color,background:y.background,size:y.size,font:y.font,style:y.style,unicode:y.unicode}),r++),i!=y.offset?(y.width=0,o.splice(c+1,0,{formatType:y.formatType,offset:i,color:y.color,background:y.background,size:y.size,font:y.font,style:y.style&~(e||0),unicode:y.unicode}),r++):y.style&=~(e||0),n>f&&(i=f))}}this.lines[t].formats=this.pruneFormats(o,this.textLength)}return!0}highlightSubStrByLine(t,e,i){return this.highlightStyleSubStringByLine(t,e,e+i)}highlightStyleSubStringByLine(t,e,i,n){if(t<0||t>=this.lines.length)return!1;let s=this.lines[t].text.length;if(e>=s)return!1;(!e||e<0)&&(e=0),(!i||i>s)&&(i=s);let o=this.lines[t].formats,r=o.length,a=!1;if(e===0&&i>=s){for(let l=0;l<r;l++){let f=o[l];f.formatType===0&&(a=!0,f.bStyle&&(f.bStyle=0,f.fStyle=0,f.fCls=0),n||(f.style&1)===1?typeof f.color=="number"?f.color=this._parser.IncreaseColor(this._parser.GetColor(f.color),.25):f.color=this._parser.IncreaseColor(f.color,.25):f.style|=1)}a||o.unshift({formatType:0,offset:0,color:n?370:0,background:0,size:0,font:0,style:n?0:1,unicode:!1})}else{let l,f;for(let c=0;c<r;c++){let y=o[c];if(y.formatType===0){if(c<r-1){let u=c+1;if(l=o[u],y.offset===l.offset&&l.formatType===y.formatType)continue;for(;y.offset===l.offset&&l.formatType===y.formatType&&u<r-1;)l=o[++u];u===r&&y.offset===l.offset?f=s:f=l.offset}else f=s;e<y.offset||e>=f||(a=!0,y.bStyle&&(y.bStyle=0,y.fStyle=0,y.fCls=0),i<f&&(y.width=0,o.splice(c+1,0,{formatType:y.formatType,offset:i,color:y.color,background:y.background,size:y.size,font:y.font,style:y.style,unicode:y.unicode}),r++),e!=y.offset?(y.width=0,l={formatType:y.formatType,offset:e,color:y.color,background:y.background,size:y.size,font:y.font,style:y.style,unicode:y.unicode},n||(y.style&1)===1?typeof y.color=="number"?l.color=this._parser.IncreaseColor(this._parser.GetColor(y.color),.25):l.color=this._parser.IncreaseColor(y.color,.25):l.style|=1,o.splice(c+1,0,l),r++):n||(y.style&1)===1?typeof y.color=="number"?y.color=this._parser.IncreaseColor(this._parser.GetColor(y.color),.25):y.color=this._parser.IncreaseColor(y.color,.25):y.style|=1,i>f&&(e=f))}}this.lines[t].formats=this.pruneFormats(o,this.textLength)}return!0}pruneFormats(t,e){if(!t||t.length<2)return t;let i=t.length,n=[];for(let s=0;s<i;s++){let o=t[s],r;if(s<i-1){let a=t[s+1];if(o.offset===a.offset&&a.formatType===o.formatType||(r=a.offset,o.formatType===1&&r-o.offset===0&&a.formatType===2)||o.formatType===7&&r-o.offset===0&&a.formatType===8||o.formatType===3&&r-o.offset===0&&a.formatType===4)continue;if(o.formatType===a.formatType&&o.color===a.color&&o.background===a.background&&o.size===a.size&&o.font===a.font&&o.style===a.style&&o.unicode===a.unicode){a.offset=o.offset,a.width=0;continue}}else if(o.offset===e&&e!==0&&(o.formatType===0&&!o.hr||o.formatType===1||o.formatType===7||o.formatType===3))continue;n.push(o)}return n}get text(){return this.lines.map(t=>t.text).join(`
`)}get raw(){return this.lines.map(t=>t.raw).join("")}getText(t,e,i){return t<0||t>=this.lines.length?"":(e<0&&(e=0),typeof i>"u"||i>this.lines[t].text.length?this.lines[t].text.substring(e):this.lines[t].text.substring(e,i))}};var si="0.0.1-alpha";var Oe=Vt(ri());var it=class extends ie{#e;get client(){return this.#e}set client(h){h!==this.#e&&(this.remove(),this.#e=h,this.initialize())}constructor(h){super(),this.#e=h}};var wt=class extends ie{constructor(){super(...arguments);this._file="";this._repeats=1;this._volume=100;this._priority=50;this._retries=0;this.current=0;this.sound=null;this.playing=!1;this.url="";this.continue=!0;this.maxErrorRetries=0}set file(t){this.continue||this.close(),this._file=t}get file(){return this._file}set repeats(t){t>=-1?this._repeats=t:this._repeats=1,this.current=0}get repeats(){return this._repeats}set volume(t){t>=0&&t<=100?this._volume=t:this._volume=1}get volume(){return this._volume}set priority(t){t>=0&&t<=100?this._priority=t:this._priority=50}get priority(){return this._priority}play(){this.playing=!0,this._repeats>0&&this.current<this._repeats?(this.current++,this.close(),this.open().then(()=>{this._retries=0,this.sound.setVolume(this._volume).play(),this.current<this._repeats?this.sound.bind("ended abort",t=>{this.play()}):this.sound.bind("ended abort",t=>{this.playing=!1,this.emit("ended")}),this.sound.isEnded()&&(this.playing=!1)}).catch(t=>{this._retries<this.maxErrorRetries?(this.current--,this.play(),this._retries++):this._retries=0})):this._repeats===-1?(this.close(),this.open().then(()=>{this._retries=0,this.sound.setVolume(this._volume).loop().play(),this.sound.isEnded()&&(this.playing=!1)}).catch(t=>{this._retries<this.maxErrorRetries?(this.play(),this._retries++):this._retries=0})):this.playing=!1}async open(){return this.close(),new Promise((t,e)=>{this.sound=new Oe.sound()(this.url+this._file),this.sound.bind("loadeddata",i=>{this.emit("playing",{file:this._file,sound:this.sound,state:this,duration:Oe.toTimer(this.sound.getDuration())}),t(1)}),this.sound.bind("error",i=>{if(i&&i.currentTarget&&i.currentTarget.error)switch(i.currentTarget.error.code){case 1:this.emit("error",new Error(`MSP - Aborted: ${this.url}${this._file}`));break;case 2:this.emit("error",new Error(`MSP - Network error: ${this.url}${this._file}`));break;case 3:this.emit("error",new Error(`MSP - Could not decode: ${this.url}${this._file}`));break;case 4:this.emit("error",new Error(`MSP - Source not supported: ${this.url}${this._file}`));break}else i&&i.currentTarget&&i.currentTarget.networkState===3?this.emit("error",new Error(`MSP - Source not found or unable to play: ${this.url}${this._file}`)):this.emit("error",new Error("MSP - Unknown error"));e()}),this.emit("opened")})}close(){this.sound?(this.stop(),delete this.sound,this.sound=null):this.playing&&(this.playing=!1),this.emit("closed")}stop(){this.sound&&this.sound.stop(),this.playing=!1,this.emit("stopped")}},St=class extends it{constructor(t){super(t instanceof je?t:t?.client);this._enabled=!0;this._enableSound=!0;this._maxErrorRetries=1;this.server=!1;this.enableDebug=!1;this.defaultSoundURL="";this.defaultMusicURL="";this.forcedDefaultMusicURL="http://"+window.location.hostname+"/sounds/";this.forcedDefaultSoundURL="http://"+window.location.hostname+"/sounds/";this.defaultSoundExt=".m4a";this.defaultMusicExt=".m4a";this.MusicState=new wt;this.SoundState=new wt;this.parseMode=0;t&&!(t instanceof je)&&("forcedDefaultMusicURL"in t&&(this.forcedDefaultMusicURL=t.forcedDefaultMusicURL),"forcedDefaultSoundURL"in t&&(this.forcedDefaultSoundURL=t.forcedDefaultSoundURL)),this.MusicState.on("playing",e=>{e.type=1,this.emit("playing",e)}),this.SoundState.on("playing",e=>{e.type=0,this.emit("playing",e)}),this.MusicState.on("error",e=>{this.emit("error",e)}),this.SoundState.on("error",e=>{this.emit("error",e)}),this.MusicState.maxErrorRetries=this._maxErrorRetries,this.SoundState.maxErrorRetries=this._maxErrorRetries}remove(){this.client&&this.client.removeListenersFromCaller(this)}initialize(){this.client&&(this.client.on("connecting",()=>this.reset(),this),this.client.on("close",()=>this.reset(),this),this.client.on("received-option",this.processOption,this),this.client.on("received-GMCP",this.processGMCP,this),this.client.on("music",this.music,this),this.client.on("sound",this.sound,this),this.client.on("options-loaded",this.loadOptions,this),this.client.on("option-loaded",this.setOption,this),this.client.on("function",this.processFunction,this),this.on("playing",t=>{this.client&&(this.debug("MSP "+(t.type?"Music":"Sound")+" Playing "+t.file+" for "+t.duration),this.debug(t),this.client.getOption("notifyMSPPlay")&&this.client.echo((t.type?"Music":"Sound")+" Playing "+t.file+" for "+t.duration,-7,-8,!0,!0))}),this.on("debug",t=>this.client.debug(t),this),this.on("error",t=>this.client.error(t),this),this.loadOptions())}get menu(){return[]}get settings(){return[]}loadOptions(){this.enableDebug=this.client.getOption("enableDebug"),this.enabled=this.client.getOption("enableMSP"),this.enableSound=this.client.getOption("enableSound"),this.maxErrorRetries=this.client.getOption("mspMaxRetriesOnError")}setOption(t,e){switch(t){case"enableMSP":this.enabled=this.client.getOption("enableMSP");break;case"mspMaxRetriesOnError":this.maxErrorRetries=this.client.getOption("mspMaxRetriesOnError");break;case"enableSound":case"enableDebug":this[t]=e;break}}get enabled(){return this._enabled}set enabled(t){t!==this._enabled&&(this._enabled=t,this.MusicState?.close(),this.SoundState?.close())}get maxErrorRetries(){return this._maxErrorRetries}set maxErrorRetries(t){t!==this._maxErrorRetries&&(this._maxErrorRetries=t,this.MusicState&&(this.MusicState.maxErrorRetries=t),this.SoundState&&(this.SoundState.maxErrorRetries=t))}get enableSound(){return this._enableSound}set enableSound(t){t!==this._enableSound&&(this._enableSound=t,this.MusicState?.close(),this.SoundState?.close())}getArguments(t,e){let i={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},n=[],s=0,o=[],r=0,a=t.length,l,f,c;for(;r<a;r++)switch(l=t.charAt(r),s){case 1:l==="'"&&(s=0),o.push(l);break;case 2:l==="'"&&(s=0),o.push(l);break;default:l===" "?(n.push(o.join("")),o=[]):l==="'"?(s=1,o.push(l)):(l==="'"&&(s=2),o.push(l));break}for(o.length>0&&(n.push(o.join("")),o=[]),r=0,a=n.length,this.debug("MSP arguments found: "+n),r=0;r<a;r++)if(f=n[r].split("="),f.length>1)switch(f[0].toUpperCase()){case"FNAME":i.file=F(f[1]),i.file.toLowerCase()==="off"&&(i.off=!0,i.file="");break;case"V":c=parseInt(f[1],10),isNaN(c)&&(c=100),i.volume=c;break;case"L":c=parseInt(f[1],10),isNaN(c)&&(c=1),i.repeat=c;break;case"P":c=parseInt(f[1],10),isNaN(c)&&(c=1),i.priority=c;break;case"C":i.continue=f[1]!=="0";break;case"T":f[1].length>0&&(i.type=f[1]);break;case"U":i.url=F(f[1]),!i.url.endsWith("/")&&i.url.length>0&&(i.url+="/");break}else r===0?(i.file=F(n[r]),i.file.toLowerCase()==="off"&&(i.off=!0,i.file="")):r===1?(c=parseInt(n[r],10),isNaN(c)&&(c=100),i.volume=c):r===2?(c=parseInt(n[r],10),isNaN(c)&&(c=1),i.repeat=c):r===3&&e===1?i.continue=n[r]!=="0":r===3?(c=parseInt(n[r],10),isNaN(c)&&(c=1),i.priority=c):r===4?n[r].length>0&&(i.type=n[r]):r===5&&(i.url=F(n[r]),!i.url.endsWith("/")&&i.url.length>0&&(i.url+="/"));return this.debug(i),i}reset(){this.server=!1}music(t){if(!this.enabled&&!this.enableSound)return!1;if(!t.file||t.file.length===0){t.off&&t.url&&t.url.length>0?this.defaultMusicURL=t.url:t.off&&this.MusicState.stop();return}else if(t.off){this.MusicState.stop();return}this.MusicState.volume=t.volume,this.MusicState.repeats=t.repeat,this.MusicState.continue=t.continue;let e=this.MusicState.file;t.file.lastIndexOf(".")===-1?this.MusicState.file=t.file+this.defaultMusicExt:this.MusicState.file=t.file,t.url&&t.url.length>0?this.MusicState.url=t.url:this.forcedDefaultMusicURL&&this.forcedDefaultMusicURL.length>0?this.MusicState.url=this.forcedDefaultMusicURL:this.defaultMusicURL&&this.defaultMusicURL.length>0?this.MusicState.url=this.defaultMusicURL:this.MusicState.url="",this.MusicState.url.length>0&&!this.MusicState.url.endsWith("/")&&(this.MusicState.url+="/"),t.type&&t.type.length>0&&(this.MusicState.url+=t.type,this.MusicState.url.length>0&&!this.MusicState.url.endsWith("/")&&(this.MusicState.url+="/")),(e!==this.MusicState.file||!t.continue||!this.MusicState.playing)&&(this.enableSound?this.MusicState.play():this.emit("playing",{type:1,file:this.MusicState.file,sound:this.MusicState.sound,state:this.MusicState,duration:"--:--"}))}sound(t){if(!this.enabled&&!this.enableSound)return!1;if(!t.file||t.file.length===0){t.off&&t.url&&t.url.length>0?this.defaultSoundURL=t.url:t.off&&this.SoundState.stop();return}else if(t.off){this.SoundState.stop();return}if(this.SoundState.playing&&t.priority<this.SoundState.priority)return!1;this.SoundState.volume=t.volume,this.SoundState.repeats=t.repeat,this.SoundState.priority=t.priority,t.file.lastIndexOf(".")===-1?this.SoundState.file=t.file+this.defaultSoundExt:this.SoundState.file=t.file,t.url&&t.url.length>0?this.SoundState.url=t.url:this.forcedDefaultSoundURL&&this.forcedDefaultSoundURL.length>0?this.SoundState.url=this.forcedDefaultSoundURL:this.defaultSoundURL&&this.defaultSoundURL.length>0?this.SoundState.url=this.defaultSoundURL:this.SoundState.url="",this.SoundState.url.length>0&&!this.SoundState.url.endsWith("/")&&(this.SoundState.url+="/"),t.type&&t.type.length>0&&(this.SoundState.url+=t.type,this.SoundState.url.length>0&&!this.SoundState.url.endsWith("/")&&(this.SoundState.url+="/")),this.enableSound?this.SoundState.play():this.emit("playing",{type:0,file:this.SoundState.file,sound:this.SoundState.sound,state:this.SoundState,duration:"--:--"})}processOption(t){t.option===90&&(this.debug("<MSP>"),t.verb===253?(this.server=!0,this.enabled?(this.debug("REPLY: <IAC><WILL><MSP>"),t.telnet.sendData([255,251,90],!0)):(this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0))):t.verb===254?(this.server=!1,this.debug("REPLY: <IAC><WONT><MSP>"),t.telnet.sendData([255,252,90],!0)):t.verb===251?(this.server=!0,this.enabled?(this.debug("REPLY: <IAC><DO><MSP>"),t.telnet.sendData([255,253,90],!0)):(this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0))):t.verb===252&&(this.server=!1,this.debug("REPLY: <IAC><DONT><MSP>"),t.telnet.sendData([255,254,90],!0)),t.handled=!0)}async processGMCP(t,e){switch(t){case"Client.Media.Default":e.type==="sound"||!e.type?this.sound({off:!0,url:e.url}):e.type==="music"&&this.music({off:!0,url:e.url});break;case"Client.Media.Load":break;case"Client.Media.Play":let i={off:!1,file:e.name,url:"",volume:50,repeat:1,priority:50,type:"",continue:!0};e.hasOwnProperty("url")&&(i.url=e.url),e.hasOwnProperty("tag")&&(i.type=e.tag),e.hasOwnProperty("volume")&&(i.volume=e.volume),e.hasOwnProperty("loops")&&(i.repeat=e.loops),e.hasOwnProperty("priority")&&(i.priority=e.priority),e.type==="sound"||!e.type?this.sound(i):e.type==="music"&&(e.hasOwnProperty("continue")&&(e.continue==="false"||!e.continue)&&(i.continue=!1),this.music(i));break;case"Client.Media.Stop":e.type==="sound"||!e.type?this.sound({off:!0}):e.type==="music"&&this.music({off:!0});break}}debug(t){this.enableDebug&&this.emit("debug",t)}processFunction(t){let e,i,n;if(t)switch(t.name.toLowerCase()){case"soundinfo":this.SoundState.playing?this.client.echo("Playing Sound - "+this.SoundState.file+" - "+Oe.toTimer(this.SoundState.sound.getTime())+"/"+Oe.toTimer(this.SoundState.sound.getDuration()),-7,-8,!0,!0):this.client.echo("No sound currently playing.",-7,-8,!0,!0),t.handled=!0;break;case"musicinfo":this.MusicState.playing?this.client.echo("Playing Music - "+this.MusicState.file+" -  "+Oe.toTimer(this.MusicState.sound.getTime())+"/"+Oe.toTimer(this.MusicState.sound.getDuration()),-7,-8,!0,!0):this.client.echo("No music currently playing.",-7,-8,!0,!0),t.handled=!0;break;case"playmusic":case"playm":e=this.client.input.parseOutgoing(t.args.join(" "),!1),i={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},n=e.lastIndexOf("/"),n===-1?i.file=e:(i.file=e.substring(n+1),i.url=e.substring(0,n+1)),this.music(i),t.handled=!0;break;case"playsound":case"plays":e=this.client.input.parseOutgoing(t.args.join(" "),!1),i={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},n=e.lastIndexOf("/"),n===-1?i.file=e:(i.file=e.substring(n+1),i.url=e.substring(0,n+1)),this.sound(i),t.handled=!0;break;case"stopmusic":case"stopm":this.MusicState.close(),t.handled=!0;break;case"stopsound":case"stops":this.SoundState.close(),t.handled=!0;break;case"stopallsound":case"stopa":this.MusicState.close(),this.SoundState.close(),t.handled=!0;break}}};var je=class extends ie{constructor(t){super();this._enableDebug=!1;this._itemCache={triggers:null,aliases:null,macros:null,buttons:null,contexts:null,defaultContext:null,alarms:null,alarmPatterns:[]};this._variables={};this._options={};this.active=!0;this.connecting=!1;this.version=si;this.connectTime=0;this.disconnectTime=0;this.lastSendTime=0;this.defaultTitle="oiMUD";this.errored=!1;if(window.client=this,window.oiMUD=this,this._plugins=[],t=Object.assign({display:"#display",commandInput:"#commandInput"},t||{}),(!("display"in t)||typeof t.display===void 0)&&(t.display="#display"),(!("commandInput"in t)||typeof t.commandInput===void 0)&&(t.commandInput="#commandInput"),this._display=new tt(t.display),this.display.on("click",i=>{this.getOption("CommandonClick")&&this._commandInput.focus()}),this.display.on("scroll-lock",i=>{this.scrollLock=i}),this.display.on("update-window",(i,n)=>{this.telnet.updateWindow(i,n)}),this.display.on("update-window",(i,n)=>{this.telnet.updateWindow(i,n)}),this.display.on("debug",i=>{this.debug(i)}),this.display.on("add-line",i=>{this.emit("add-line",i)}),this.display.on("add-line-done",i=>{this.emit("add-line-done",i)}),this.display.on("MXP-tag-reply",(i,n)=>{let s={tag:i,args:n,preventDefault:!1};if(this.emit("MXP-tag-reply",s),!s.preventDefault)switch(i){case"VERSION":this.display.MXPStyleVersion&&this.display.MXPStyleVersion.length?(this.debug(`MXP Tag REPLY: <VERSION MXP=1.0 STYLE=${this.display.MXPStyleVersion} CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>`),this.send(`\x1B[1z<VERSION MXP=1.0 STYLE=${this.display.MXPStyleVersion} CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>\r
`)):(this.debug(`MXP Tag REPLY: <VERSION MXP=1.0 CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>`),this.send(`\x1B[1z<VERSION MXP=1.0 CLIENT=jiMUD VERSION=${this.version} REGISTERED=no>\r
`));break;case"SUPPORT":this.debug(`MXP Tag REPLY: <SUPPORTS ${n.join(" ")}>`),this.send(`\x1B[1z<SUPPORTS ${n.join(" ")}>\r
`);break;case"USER":this.emit("sendUsername",s);break;case"PASSWORD":this.emit("sendPassword",s);break}}),this.display.on("expire-links",i=>{this.emit("expire-links",i)}),this.display.on("parse-done",()=>{this.emit("parse-done")}),this.display.on("set-title",(i,n)=>{typeof i>"u"||i==null||i.length===0?this.emit("set-title",this.getOption("title").replace("$t",this.defaultTitle)||this.defaultTitle):n!==1&&this.emit("set-title",this.getOption("title").replace("$t",i)||"")}),this.display.on("music",i=>{this.emit("music",i)}),this.display.on("sound",i=>{this.emit("sound",i)}),this.display.on("bell",()=>{this.emit("bell")}),typeof t.commandInput=="string"){if(this._commandInput=document.querySelector(t.commandInput),!this._commandInput)throw new Error("Invalid selector for command input.")}else if(t.commandInput instanceof $)this._commandInput=t.commandInput[0];else if(t.commandInput instanceof HTMLElement)this._commandInput=t.commandInput;else throw new Error("Command input must be a selector, element or jquery object");this._telnet=new Ye({protocol:t.protocol,scheme:t.scheme}),this._telnet.terminal="oiMUD",this._telnet.version=this.version,this._telnet.GMCPSupports.push("oMUD 1"),this._telnet.GMCPSupports.push("Client.Media 1"),this._telnet.on("error",i=>{if(this.enableDebug&&this.debug(i),i){if(i.type==="close"&&i.code===1006)return;let n=[];i.type&&n.push(i.type),i.text&&n.push(i.text),i.message&&n.push(i.message),i.reason&&n.push(i.reason),i.code?this.error(i.code+" : "+n.join(", ")):this.error(n.join(", "))}else this.error("Unknown telnet error.");this.getOption("autoConnect")&&!this._telnet.connected&&setTimeout(()=>{this.connect()},client.getOption("autoConnectDelay")),this.emit("reconnect")}),this.telnet.on("connecting",()=>{this.connecting=!0,this.echo("Trying to connect to "+this.host+":"+this.port,-7,-8,!0,!0)}),this.telnet.on("connect",()=>{this.connecting=!1,this.echo("Connected...",-7,-8,!0,!0),this.connectTime=Date.now(),this.disconnectTime=0,this.lastSendTime=Date.now(),this.emit("connected"),this.raise("connected")}),this.telnet.on("debug",i=>{this.debug(i)}),this.telnet.on("receive-option",i=>{this.emit("received-option",i)}),this.telnet.on("close",()=>{this.connecting=!1,this.echo("Connection closed to "+this.host+":"+this.port,-7,-8,!0,!0),this.disconnectTime=Date.now(),this.emit("closed"),this.raise("disconnected"),this.connectTime=0,this.lastSendTime=0}),this.telnet.on("received-data",i=>{i={value:i},this.emit("received-data",i),!(i==null||typeof i>"u"||i.value==null||typeof i.value>"u")&&(this.printInternal(i.value,!1,!0),this.debug("Latency: "+this.telnet.latency+"ms"),this.debug("Latency: "+this.telnet.latency/1e3+"s"))}),this.telnet.on("received-MSDP",i=>{this.emit("received-MSDP",i)}),this.telnet.on("received-GMCP",i=>{let n=i.value,s,o=0,r=n.length,a;if(r===0)return;for(o=0;o<r&&(a=n.charAt(o),!(a===" "||a==="{"||a==="["));o++);s=n.substr(0,o).trim(),n=n.substr(o).trim(),this.debug("GMCP Module: "+s),this.debug("GMCP Data: "+n);let l;if(s.toLowerCase()==="client.gui"){l=n.split("/n"),n.length>=2?l={version:parseInt(l[0],10),url:l[1]}:n.length>0?l={version:parseInt(l[0],10),url:l[1]}:l={version:l,url:""},this.emit("received-GMCP",s,l);return}try{n.length>0&&(l=JSON.parse(n))}catch{this.error("Invalid GMCP");return}this.emit("received-GMCP",s,l)}),this.telnet.on("windowSize",()=>{this.UpdateWindow()});let e=At("host");e!==null&&e.length?this.host=e:t&&"host"in t?this.host=t.host:this.host="127.0.0.1",e=+At("port"),!isNaN(e)&&e>0?this.port=e:t&&"port"in t?this.port=t.port:this.port=23,this._input=new ft(this),this._input.on("scroll-lock",i=>{this.display.scrollLock=i,this.emit("scroll-lock",i)}),this._input.on("command-history-changed",i=>this.emit("command-history-changed",i)),this._input.on("item-added",(i,n,s)=>{this.emit("item-added",i,n,s)}),this._input.on("item-updated",(i,n,s,o)=>{this.emit("item-updated",i,n,s,o)}),this._input.on("item-removed",(i,n,s)=>{this.emit("item-removed",i,n,s)}),this.loadOptions(),this._commandInput.value="",this._commandInput.focus(),window.addEventListener("blur",()=>{this.active=!1,this.emit("blur"),this.raise("blur")}),window.addEventListener("focus",()=>{this.active=!0,this.emit("focus"),this.raise("focus")}),window.addEventListener("beforeunload",i=>{if(this.connected)return i&&(i.returnValue="Closing or reloading will disconnect you from the mud."),"Closing or reloading will disconnect you from the mud.";this.raise("closed")}),window.addEventListener("unload",()=>{this.connected&&this.close()}),this.addPlugin(new St(this)),this.getOption("autoConnect")&&setTimeout(()=>{this.connect()},client.getOption("autoConnectDelay")),this.emit("initialized")}get telnet(){return this._telnet}get variables(){return this._variables}get commandInput(){return this._commandInput}get display(){return this._display}get profiles(){return this._profiles}get plugins(){return this._plugins}get options(){return this._options}get input(){return this._input}set simpleAlarms(t){this.setOption("simpleAlarms",t)}get simpleAlarms(){return this.getOption("simpleAlarms")}set enableParsing(t){this.setOption("enableParsing",t),this._input.enableParsing=t}get enableParsing(){return this.getOption("enableParsing")}set enableTriggers(t){this.setOption("enableTriggers",t),this._input.enableTriggers=t,this.startAlarms()}get enableTriggers(){return this.getOption("enableTriggers")}get enableDebug(){return this._enableDebug}set enableDebug(t){this._enableDebug=t,this._telnet.enableDebug=t,this._display.enableDebug=t}get host(){return this._telnet.host}set host(t){this._telnet.host=t}get port(){return this._telnet.port}set port(t){this._telnet.port=t}get connected(){return this._telnet.connected}get activeProfile(){return this._profiles.active}get commandHistory(){return this._input.commandHistory}get indices(){return this._input.indices}get repeatnum(){return this._input.repeatnum}get aliases(){if(this._itemCache.aliases)return this._itemCache.aliases;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableAliases?this._itemCache.aliases=[]:this._itemCache.aliases=U(this.profiles.items[t[i]].aliases),this._itemCache.aliases;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableAliases||this.profiles.items[t[i]].aliases.length===0||e.push.apply(e,U(this.profiles.items[t[i]].aliases));return this._itemCache.aliases=e,this._itemCache.aliases}get macros(){if(this._itemCache.macros)return this._itemCache.macros;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableMacros?this._itemCache.macros=[]:this._itemCache.macros=U(this.profiles.items[t[i]].macros),this._itemCache.macros;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableMacros||this.profiles.items[t[i]].macros.length===0||e.push.apply(e,U(this.profiles.items[t[i]].macros));return this._itemCache.macros=e,this._itemCache.macros}get triggers(){if(this._itemCache.triggers)return this._itemCache.triggers;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableTriggers?this._itemCache.triggers=[]:this._itemCache.triggers=U(this.profiles.items[t[0]].triggers),this._itemCache.triggers;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableTriggers||this.profiles.items[t[i]].triggers.length===0||e.push.apply(e,U(this.profiles.items[t[i]].triggers));return this._itemCache.triggers=e,this._itemCache.triggers}removeTrigger(t){let e=this.profiles.keys,i=0,n=e.length,s=-1;if(n!==0){if(n===1){if(!this.profiles.items[e[0]].enabled||!this.profiles.items[e[0]].enableTriggers)return;s=this.profiles.items[e[i]].triggers.indexOf(t)}else for(;i<n&&s!==-1&&!(!(!this.profiles.items[e[i]].enabled||!this.profiles.items[e[i]].enableTriggers||this.profiles.items[e[i]].triggers.length===0)&&(s=this.profiles.items[e[i]].triggers.indexOf(t),s!==-1));i++);s!==-1&&(this.profiles.items[e[i]].triggers.splice(s,1),this._itemCache.triggers=null,(t.triggers.length||t.type===3)&&this._itemCache.alarms&&(s=this._itemCache.alarms.indexOf(t),s!==-1&&(this._itemCache.alarms.splice(s,1),this._itemCache.alarmPatterns.splice(s,1))),this.saveProfiles(),this.emit("item-removed","trigger",e[i],s))}}get alarms(){if(this._itemCache.alarms)return this._itemCache.alarms;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableTriggers?this._itemCache.alarms=[]:this._itemCache.alarms=$.grep(U(this.profiles.items[t[i]].triggers),s=>{if(s&&s.enabled&&s.triggers.length){if(s.type===3)return!0;for(let o=0,r=s.triggers.length;o<r;o++)if(s.triggers[o].enabled&&s.triggers[o].type===3)return!0;return!1}return s&&s.enabled&&s.type===3}),this._itemCache.alarms.reverse(),this._itemCache.alarms;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableTriggers||this.profiles.items[t[i]].triggers.length===0||e.push.apply(e,U(this.profiles.items[t[i]].triggers));return this._itemCache.alarms=$.grep(e,s=>{if(s&&s.enabled&&s.triggers.length){if(s.type===3)return!0;for(let o=0,r=s.triggers.length;o<r;o++)if(s.triggers[o].enabled&&s.triggers[o].type===3)return!0;return!1}return s&&s.enabled&&s.type===3}),this._itemCache.alarms.reverse(),this._itemCache.alarms}get buttons(){if(this._itemCache.buttons)return this._itemCache.buttons;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableButtons?this._itemCache.buttons=[]:this._itemCache.buttons=U(this.profiles.items[t[i]].buttons),this._itemCache.buttons;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableButtons||this.profiles.items[t[i]].buttons.length===0||e.push.apply(e,U(this.profiles.items[t[i]].buttons));return this._itemCache.buttons=e,this._itemCache.buttons}get contexts(){if(this._itemCache.contexts)return this._itemCache.contexts;let t=this.profiles.keys,e=[],i=0,n=t.length;if(n===0)return[];if(n===1)return!this.profiles.items[t[0]].enabled||!this.profiles.items[t[0]].enableContexts?this._itemCache.contexts=[]:this._itemCache.contexts=U(this.profiles.items[t[i]].contexts),this._itemCache.contexts;for(;i<n;i++)!this.profiles.items[t[i]].enabled||!this.profiles.items[t[i]].enableContexts||this.profiles.items[t[i]].contexts.length===0||e.push.apply(e,U(this.profiles.items[t[i]].contexts));return this._itemCache.contexts=e,this._itemCache.contexts}get defaultContext(){return this._itemCache.defaultContext!==null?this._itemCache.defaultContext:(this._itemCache.defaultContext=this.profiles.defaultContext,this._itemCache.defaultContext)}addPlugin(t){t&&(this.plugins.push(t),t.initialize())}removePlugin(t){if(!this.plugins.length)return;let e=this.plugins.indexOf(t);e!==-1&&(t.remove(),this.plugins.splice(e,1))}getVariable(t){return this.variables[t]}setVariable(t,e){this.variables[t]=e}setVariables(t){let e=Object.keys(t);if(e.length===0)return;let i=e.length,n;for(let s=0;s<i;s++)n=e[s],this.variables[n]=t[n]}hasVariable(t){return this.variables.hasOwnProperty(t)}removeVariable(t){this.variables.hasOwnProperty(t)&&delete this.variables[t]}setHistoryIndex(t){this._input.setHistoryIndex(t)}clearCommandHistory(){this._input.clearCommandHistory()}AddCommandToHistory(t){this._input.AddCommandToHistory(t)}loadProfiles(){this._profiles=new ut,this._profiles.load().then(()=>{this.profiles.contains("default")||(this.profiles.add(Se.Default),this.saveProfiles()),this.clearCache(),this.startAlarms(),this.emit("profiles-loaded")})}removeProfile(t){t&&(this.profiles.remove(t),this.clearCache(),this.startAlarms(),this.emit("profile-removed",t))}saveProfiles(){this._profiles.save(),this.clearCache(),this.emit("profiles-updated")}toggleProfile(t){this.profiles.toggle(t),this.saveProfiles(),this.clearCache(),this.startAlarms(),this.emit("profile-toggled",t,this.profiles[t].enabled)}startAlarms(){let t=this.alarms.length;(t===0||!this.getOption("enableTriggers"))&&this._alarm?(clearInterval(this._alarm),this._alarm=null):t&&!this._alarm&&(this._alarm=setInterval(e=>{e.process_alarms()},1e3,this))}setAlarmState(t,e){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length)return;let i=this._itemCache.alarmPatterns[t];if(!i){i={},this.alarms[t].type===3&&(i[0]=ue.parse(this.alarms[t]));for(let n=0,s=this.alarms[t].triggers.length;n<s;n++)this.alarms[t].triggers[n].enabled&&this.alarms[t].triggers[n].type===3&&(i[n]=ue.parse(this.alarms[t].triggers[n]));this._itemCache.alarmPatterns[t]=i}for(let n in i)i.hasOwnProperty(n)&&(e?(i[n].startTime+=Date.now()-i[n].suspended,i[n].prevTime+=Date.now()-i[n].suspended,i[n].tempTime&&(i[n].tempTime+=Date.now()-i[n].suspended),i[n].suspended=0):i[n].suspended=Date.now())}setAlarmTempTime(t,e){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length)return;let i=this._itemCache.alarmPatterns[t];if(!i){i={},this.alarms[t].type===3&&(i[0]=ue.parse(this.alarms[t]));for(let n=0,s=this.alarms[t].triggers.length;n<s;n++)this.alarms[t].triggers[n].enabled&&this.alarms[t].triggers[n].type===3&&(i[n]=ue.parse(this.alarms[t].triggers[n]));this._itemCache.alarmPatterns[t]=i}i[0]&&i[0].setTempTime(e)}restartAlarmState(t,e,i){if(e===i||(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length))return;let n=this._itemCache.alarmPatterns[t];if(!n){n={},this.alarms[t].type===3&&(n[0]=ue.parse(this.alarms[t]));for(let s=0,o=this.alarms[t].triggers.length;s<o;s++)this.alarms[t].triggers[s].enabled&&this.alarms[t].triggers[s].type===3&&(n[s]=ue.parse(this.alarms[t].triggers[s]));this._itemCache.alarmPatterns[t]=n}n[e]&&(n[e].restart=Date.now()),n[i]&&(n[i].restart=Date.now())}getRemainingAlarmTime(t){if(typeof t=="object"&&(t=this.alarms.indexOf(t)),t===-1||t>=this.alarms.length||!this.alarms[t].enabled)return 0;let e=this._itemCache.alarmPatterns[t];if(!e){e={},this.alarms[t].type===3&&(e[0]=ue.parse(this.alarms[t]));for(let i=0,n=this.alarms[t].triggers.length;i<n;i++)this.alarms[t].triggers[i].enabled&&this.alarms[t].triggers[i].type===3&&(e[i]=ue.parse(this.alarms[t].triggers[i]));this._itemCache.alarmPatterns[t]=e}if(e[0]){let i=e[0],n=Date.now(),s=new Date,o=n,r=o+9e7,a=1e3;if(i.seconds!==-1?a=1e3:i.minutes!==-1?a=6e4:i.hours!==-1&&(a=36e5),i.tempTime)return i.tempTime-n>0?i.tempTime-n:0;for(;o<r;){if(this.alarm_match(i,o,s))return o-n;o+=a,s.setTime(s.getTime()+a)}return-1}return 0}updateAlarms(){if(this._itemCache.alarmPatterns){let t=this._itemCache.alarmPatterns,e=this.alarms;this._itemCache.alarmPatterns=[],this._itemCache.alarms=null;let i=this.alarms.length,n=-1;for(let s=0;s<i;s++)n=e.indexOf(this.alarms[s]),n!==-1&&(this._itemCache.alarmPatterns[s]=t[n])}this.startAlarms()}process_alarms(){if(!this.getOption("enableTriggers"))return;let t=0,e=!1,i=this.alarms.length;if(i===0&&this._alarm){clearInterval(this._alarm),this._alarm=null;return}let n=this._itemCache.alarmPatterns,s=Date.now(),o=this.alarms,r=new Date;for(t=i-1;t>=0;t--){let a=o[t],l=a;if(!a.enabled)continue;if(a.state>a.triggers.length&&(a.state=0),a.state!==0&&a.triggers&&a.triggers.length){for(a=a.triggers[a.state-1];!a.enabled&&l.state!==0;){if(l.state++,l.state>l.triggers.length){l.state=0,a=a.triggers[l.state-1];break}l.state?a=a.triggers[l.state-1]:a=l,e=!0}if(e&&(this.getOption("saveTriggerStateChanges")&&this.saveProfiles(),this.emit("item-updated","trigger",l.profile.name,l.profile.triggers.indexOf(l))),!a.enabled)continue}if(a.type===131072||a.type===262144){let y=this._input.adjustLastLine(this.display.lines.length,!0),u=this.display.lines[y];t=this._input.TestTrigger(a,l,t,u,this.display.lines[y].raw||u,y===this.display.lines.length-1);continue}if(a.type!==3)continue;let f=n[t];if(!f){try{n[t]={},a.type===3&&(n[t][0]=ue.parse(a));for(let y=0,u=a.triggers.length;y<u;y++)a.triggers[y].type===3&&(n[t][y]=ue.parse(a.triggers[y]))}catch(y){throw n[t]=null,this.getOption("disableTriggerOnError")&&(a.enabled=!1,setTimeout(()=>{this.saveProfiles(),this.emit("item-updated","trigger",l.profile,l.profile.triggers.indexOf(l),l)})),y}if(f=n[t],!f)continue}f=f[a.state],f.restart&&(f.startTime=Date.now(),f.prevTime=f.startTime,f.tempTime&&(f.tempTime+=Date.now()-f.restart),f.restart=0);let c=!0;if(f.tempTime?(c=s>=f.tempTime,c&&(f.tempTime=0)):c=this.alarm_match(f,s,r),c&&!f.suspended){f.prevTime=s;let y=l.state;if(this._input.lastTriggered=f.pattern,this._input.ExecuteTrigger(a,[f.pattern],!1,-t,null,null,l),y!==l.state&&(f.restart=Date.now()),f.temp)if(l.triggers.length)if(y===0){let u=l.triggers.shift();u.state=y,u.priority=l.priority,u.name=l.name,u.profile=l.profile,u.state>u.triggers.length&&(u.state=0),u.triggers=l.triggers,o[t]=u,n[t]=null,this.saveProfiles();let x=l.profile.triggers.indexOf(l);l.profile.triggers[x]=u,this.emit("item-updated","trigger",l.profile.name,x,u)}else{l.triggers.splice(y-1,1),n[t].splice(y-1,1),l.state=y,l.state>l.triggers.length&&(l.state=0),this.saveProfiles();let u=l.profile.triggers.indexOf(l);this.emit("item-updated","trigger",l.profile.name,u,l)}else this._input.clearTriggerState(t),this.removeTrigger(l);t=-this._input.cleanUpTriggerState(-t)}}}alarm_match(t,e,i){if(!t||t.suspended)return!1;let n=!0,s,o,r,a,l,f,c;if(!moment||this.simpleAlarms){if(s=e-this.connectTime,s<1e3)return!1;o=Math.round(s/1e3),r=Math.floor(o/60),a=Math.floor(r/60),l=a,f=Math.floor(r%60),c=Math.floor(o%60)}else{if(t.start?s=moment.duration(e-this.connectTime):s=moment.duration(e-t.startTime),s.asMilliseconds()<1e3)return!1;o=Math.round(s.asMilliseconds()/1e3),r=Math.floor(o/60),a=Math.floor(r/60),l=s.hours(),f=s.minutes(),c=s.seconds()}return t.hoursWildCard?t.hours===0?n=n&&l===0:t.hours!==-1&&(n=n&&a!==0&&a%t.hours===0):t.hours!==-1&&(n=n&&t.hours===(t.start?l:i.getHours())),t.minutesWildcard?t.minutes===0?n=n&&f===0:t.minutes!==-1&&(n=n&&r!==0&&r%t.minutes===0):t.minutes!==-1&&(n=n&&t.minutes===(t.start?f:i.getMinutes())),t.secondsWildcard?t.seconds===0?n=n&&c===0:t.seconds!==-1&&(n=n&&o%t.seconds===0):t.seconds!==-1&&(n=n&&t.seconds===(t.start?c:i.getSeconds())),n}loadOptions(){this._options=new we,this.enableDebug=this._options.enableDebug,this.display.maxLines=this._options.bufferSize,this.display.enableFlashing=this._options.flashing,this.display.enableMXP=this._options.enableMXP,this.display.showInvalidMXPTags=this._options["display.showInvalidMXPTags"],this.display.enableURLDetection=this._options.enableURLDetection,this.display.enableMSP=this._options.enableMSP,this.display.enableColors=this._options["display.enableColors"],this.display.enableBackgroundColors=this._options["display.enableBackgroundColors"],this.display.wordWrap=this._options["display.wordWrap"],this.display.wrapAt=this._options["display.wrapAt"],this.display.indent=this._options["display.indent"],this.display.showTimestamp=this._options["display.showTimestamp"],this.display.tabWidth=this._options["display.tabWidth"],this.display.timestampFormat=this._options["display.timestampFormat"];let t=this.getOption("colors");if(t&&t.length>0){let e,i=t.length;for(e=0;e<i;e++)!t[e]||t[e].length===0||this.display.SetColor(e,t[e])}this._telnet&&(this._telnet.options.MCCP=this._options.enableMCCP,this._telnet.options.MXP=this._options.enableMXP,this._telnet.UTF8=this._options.enableUTF8,this._telnet.options.ECHO=this._options.enableEcho,this._telnet.enableLatency=this._options.lagMeter,this._telnet.enablePing=this._options.enablePing),this._input.scrollLock=this._options.scrollLocked,this._input.enableParsing=this._options.enableParsing,this._input.enableTriggers=this._options.enableTriggers,this.display.scrollLock=this._options.scrollLocked,this.display.hideTrailingEmptyLine=this._options["display.hideTrailingEmptyLine"],this.display.displayControlCodes=this.getOption("display.displayControlCodes"),this.display.emulateTerminal=this.getOption("display.emulateTerminal"),this.display.emulateControlCodes=this.getOption("display.emulateControlCodes"),this._commandInput.wrap=this.getOption("commandWordWrap")?"on":"off",this.UpdateFonts&&this.UpdateFonts(),this.display.scrollDisplay(),this.loadProfiles(),this.emit("options-loaded")}setOption(t,e){t===-1||t==="-1"||(this._options[t]=e,we.setValue(t,e),this.emit("option=changed",t,e))}getOption(t){return this._options&&t in this._options?this._options[t]:this._options[t]=we.getValue(t)}UpdateFonts(){this.display&&(this.display.updateFont(this._options.font+", monospace",this._options.fontSize),this._commandInput.style.fontSize=this._options.cmdfontSize,this._commandInput.style.fontFamily=this._options.cmdfont+", monospace")}parse(t){this.parseInternal(t,!1,!1,!0)}parseInternal(t,e,i,n){this.display.append(t,e,i,n)}error(t){this.enableDebug&&this.debug(t);let e="";t==null||typeof t>"u"?t=new Error("Unknown"):typeof t=="string"&&t.length===0&&(t=new Error("Unknown")),t.stack&&this.getOption("showErrorsExtended")?e=t.stack:t instanceof Error||t instanceof TypeError?e=t.name+": "+t.message:t.message?e=t.message:e=""+t,e.match(/^.*Error: /g)||e.match(/^.*Error - /g)?this.echo(e,-11,-12,!0,!0):this.echo("Error: "+e,-11,-12,!0,!0),this.getOption("logErrors")&&(this.getOption("showErrorsExtended")?t.stack||(t=new Error(t||e),e=t.stack):(t.stack||(t=new Error(t||e)),e=t.stack),window.console.log(new Date().toLocaleString()),window.console.log(e),localforage.getItem("oiMUDErrorLog",function(i,n){localforage.setItem("oiMUDErrorLog",n=(n||"")+new Date().toLocaleString()+`
`+e+`
`)})),t==="Error: ECONNRESET - read ECONNRESET."&&this.telnet.connected&&this.close(),this.raise("error",e)}echo(t,e,i,n,s){t==null&&(t=""),n==null&&(n=!1),s==null&&(s=!1),e==null&&(e=-3),i==null&&(i=-4);let o="\x1B[0m"+this.display.CurrentAnsiCode()+`
`;t=""+t,t.endsWith(`
`)&&(t=t.substr(0,t.length-1)),this.telnet.prompt&&s?(this.print(`
\x1B[`+e+";"+i+"m"+t+o,n),this.telnet.prompt=!1):this.print("\x1B["+e+";"+i+"m"+t+o,n)}print(t,e){this.printInternal(t,e,!1,!0)}printInternal(t,e,i,n){t==null||typeof t>"u"||(e==null&&(e=!1),i==null&&(i=!1),e&&this.display.textLength>0&&!this.display.EndOfLine&&this.display.EndOfLineLength!==0&&!this.telnet.prompt&&!this.display.parseQueueEndOfLine&&(t=`
`+t),this.parseInternal(t,i,!1,n))}send(t,e){this.telnet.sendData(t),this.lastSendTime=Date.now(),e&&this.telnet.echo&&this.getOption("commandEcho")?this.echo(t):e&&this.echo(`
`)}sendRaw(t){this.telnet.sendData(t,!0),this.lastSendTime=Date.now()}sendGMCP(t){this.telnet.sendGMCP(t),this.lastSendTime=Date.now()}debug(t,e){let i={value:t};this.emit("debug",i),!(!this._enableDebug||i==null||typeof i>"u"||i.value==null||typeof i.value>"u"||i.value.length===0)&&window.console&&(e?window.console.log("%c"+t,e):window.console.log(i.value))}sendCommand(t,e,i){t==null&&(t=this._commandInput.value,this.telnet.echo?this._input.AddCommandToHistory(t):this._commandInput.value=""),t=""+t,t.endsWith(`
`)||(t=t+`
`);let n={value:t,handled:!1,comments:i};this.emit("parse-command",n),!(n==null||typeof n>"u")&&(n.handled||n.value==null||typeof n.value>"u"||(n.value.length>0&&this.send(n.value,!e),this.getOption("keepLastCommand")?qt(this._commandInput):this._commandInput.value=""))}sendBackground(t,e,i){t==null&&(t=this._commandInput.value,this.telnet.echo?this._input.AddCommandToHistory(t):this._commandInput.value=""),t=""+t,t.endsWith(`
`)||(t=t+`
`);let n={value:t,handled:!1,comments:i};this.emit("parse-command",n),!(n==null||typeof n>"u")&&(n.value==null||typeof n.value>"u"||!n.handled&&n.value.length>0&&this.send(n.value,!e))}get scrollLock(){return this._input.scrollLock}set scrollLock(t){this._input.scrollLock=t}toggleScrollLock(){this._input.toggleScrollLock()}UpdateWindow(){this.display.updateWindow()}close(){this.telnet.close()}connect(){this.errored=!1,this.emit("connecting"),this.display.ClearMXP(),this.display.ResetMXPLine(),this.telnet.connect(),this.emit("connect"),this._commandInput.focus()}receivedData(t){this.telnet.receivedData(t)}notify(t,e,i){this.enableDebug&&(this.emit("debug","notify title: "+t),this.emit("debug","notify msg: "+e)),this.emit("notify",t,e,i)}clear(){this.display.clear(),this.emit("cleared")}parseInline(t){return this._input.parseInline(t)}parseOutgoing(t,e,i,n){return this._input.parseOutgoing(t,e,i,n)}clearCache(){this._input.clearCaches(),this._itemCache={triggers:null,aliases:null,macros:null,buttons:null,contexts:null,defaultContext:null,alarms:null,alarmPatterns:[]}}beep(){this.emit("bell")}raise(t,e,i){!i||i<1?this._input.triggerEvent(t,e):setTimeout(()=>{this._input.triggerEvent(t,e)},i)}show(){this.emit("show")}hide(){this.emit("hide")}toggle(){this.emit("toggle")}};window.Client=je;window.Display=tt;function De(){let p=bootstrap.Offcanvas.getInstance(document.getElementById("clientMenu"));p&&p.hide()}function Bi(){bootstrap.Offcanvas.getOrCreateInstance(document.getElementById("clientMenu")).show()}function ai(){document.getElementById("btn-menu").addEventListener("click",Bi),client.on("connected",()=>{let i=document.getElementById("menu-connect"),n=document.querySelector("#menu-connect a span"),s=document.querySelector("#menu-connect svg")||document.querySelector("#menu-connect i");i.title="Disconnect",i.classList.add("active"),n.textContent="Disconnect",s.classList.add("fa-plug-circle-xmark"),s.classList.remove("fa-plug")}),client.on("closed",()=>{let i=document.getElementById("menu-connect"),n=document.querySelector("#menu-connect a span"),s=document.querySelector("#menu-connect svg")||document.querySelector("#menu-connect i");i.title="Connect",i.classList.remove("active"),n.textContent="Connect",s.classList.remove("fa-plug-circle-xmark"),s.classList.add("fa-plug")}),client.on("scroll-lock",oi),document.querySelector("#menu-connect a").addEventListener("click",i=>{client.connected?client.close():(client.connect(),De())}),document.querySelector("#menu-clear a").addEventListener("click",i=>{client.clear(),De()}),document.querySelector("#menu-lock a").addEventListener("click",i=>{client.toggleScrollLock(),De()}),document.querySelector("#menu-editor a").addEventListener("click",i=>{De(),document.getElementById("btn-adv-editor").click()}),document.querySelector("#menu-about a").addEventListener("click",i=>{st("about"),De()}),document.querySelector("#menu-settings a").addEventListener("click",i=>{st("settings"),De()}),document.querySelector("#menu-fullscreen a").addEventListener("click",i=>{var n=window.document,s=n.documentElement,o=s.requestFullscreen||s.mozRequestFullScreen||s.webkitRequestFullScreen||s.msRequestFullscreen,r=n.exitFullscreen||n.mozCancelFullScreen||n.webkitExitFullscreen||n.msExitFullscreen;let a=document.getElementById("menu-fullscreen"),l=document.querySelector("#menu-fullscreen svg")||document.querySelector("#menu-fullscreen i"),f=document.querySelector("#menu-fullscreen a span");!n.fullscreenElement&&!n.mozFullScreenElement&&!n.webkitFullscreenElement&&!n.msFullscreenElement?(a.title="Exit fullscreen",f.textContent="Exit fullscreen",o.call(s),l.classList.add("fa-minimize"),l.classList.remove("fa-maximize")):(a.title="Enter fullscreen",f.textContent="Enter fullscreen",r.call(n),l.classList.add("fa-maximize"),l.classList.remove("fa-minimize")),De()}),oi();let p=client.plugins.length,h,t,e=document.querySelector("#clientMenu ul");for(let i=0;i<p;i++)if(client.plugins[i].settings&&client.plugins[i].settings.length)for(t=client.plugins[i].settings.length,h=0;h<t;h++){let n=client.plugins[i].settings[h],s,o="menu-"+(n.name||"").toLowerCase().replace(/ /g,"-");if(n.name==="-"?s='<li><hr class="dropdown-divider"></li>':typeof n.action=="string"?s=`<li id="menu-${o}" class="nav-item" title="${n.name||""}"><a class="nav-link" href="#${n.action}">${n.icon||""}${n.name||""}</i><span>${n.name||""}</span></a></li>`:s=`<li id="menu-${o}" class="nav-item" title="${n.name||""}"><a class="nav-link" href="javascript:void(0)">${n.icon||""}${n.name||""}<span>${n.name||""}</span></a></li>`,"position"in n){if(typeof n.position=="string"){if(e.querySelector(n.position)){e.querySelector(n.position).insertAdjacentHTML("afterend",s);continue}}else if(n.position>=0&&n.position<e.children.length){e.children[n.position].insertAdjacentHTML("afterend",s);continue}}e.insertAdjacentHTML("beforeend",s),n.name!=="-"&&typeof n.action=="function"&&document.querySelector(`#${o} a`).addEventListener("click",r=>{let a={client,preventDefault:!1};n.action(a),!a.preventDefault&&De()})}}function oi(){let p=document.getElementById("menu-lock"),h=document.querySelector("#menu-lock a span"),t=document.querySelector("#menu-lock svg")||document.querySelector("#menu-lock i");client.scrollLock?(p.title="Unlock display",p.classList.add("active"),h.textContent="Unlock display",t.classList.add("fa-unlock"),t.classList.remove("fa-lock")):(p.title="Lock display",p.classList.remove("active"),h.textContent="Lock display",t.classList.remove("fa-unlock"),t.classList.add("fa-lock"))}var fe=class extends ie{constructor(t){super();this._state={x:0,y:0,height:0,width:0,zIndex:100,maximized:!1,show:0};this._resize={x:0,y:0,height:0,width:0,type:0,minHeight:150,minWidth:300,borderHeight:1,borderWidth:1};this._dragPosition={x:0,y:0};this._windowResize=()=>{Ge(()=>{this.keepCentered||this._state.show===2&&!this.moveable?this.center():this.makeVisible(),this._footer.style.display!=="none"&&(this._body.style.bottom=this._body.style.bottom=this._footer.clientHeight+1+"px"),+"px"},250,this._id+"dialogResize")};this.resizeDoDrag=t=>{let e;if((this._resize.type&1)===1&&(e=this._resize.width+t.clientX-this._resize.x,e>window.innerWidth&&(e=window.innerWidth),this._dialog.style.width=e+"px"),(this._resize.type&2)===2&&(e=this._resize.height+t.clientY-this._resize.y,e>window.innerWidth-16&&(e=window.innerHeight-16),this._dialog.style.height=e+"px"),(this._resize.type&8)===8){if(e=this._resize.height-t.clientY+this._resize.y-this._resize.borderHeight,e+this._resize.borderHeight>window.innerHeight&&(e=window.innerHeight),e+this._resize.borderHeight<=this._resize.minHeight){this._dialog.style.height=this._resize.minHeight+"px";return}this._dialog.style.height=e+"px",e=t.clientY,e>window.innerHeight&&(e=window.innerHeight),this._dialog.style.top=e+"px"}if((this._resize.type&4)===4){if(e=this._resize.width-t.clientX+this._resize.x-this._resize.borderWidth,e+this._resize.borderWidth>window.innerWidth&&(e=window.innerWidth),e+this._resize.borderWidth<=this._resize.minWidth){this._dialog.style.width=this._resize.minWidth+"px";return}this._dialog.style.width=e+"px",e=t.clientX,e>window.innerWidth&&(e=window.innerWidth),this._dialog.style.left=e+"px"}};this.resizeTouchDrag=t=>{if(!t.touches.length)return;let e;if((this._resize.type&1)===1&&(e=this._resize.width+t.touches[0].clientX-this._resize.x,e>window.innerWidth&&(e=window.innerWidth),this._dialog.style.width=e+"px"),(this._resize.type&2)===2&&(e=this._resize.height+t.touches[0].clientY-this._resize.y,e>window.innerWidth&&(e=window.innerHeight),this._dialog.style.height=e+"px"),(this._resize.type&8)===8){if(e=this._resize.height-t.touches[0].clientY+this._resize.y-this._resize.borderHeight,e+this._resize.borderHeight>window.innerHeight&&(e=window.innerHeight),e+this._resize.borderHeight<=this._resize.minHeight){this._dialog.style.height=this._resize.minHeight+"px";return}this._dialog.style.height=e+"px",e=t.touches[0].clientY,e>window.innerHeight&&(e=window.innerHeight),this._dialog.style.top=e+"px"}if((this._resize.type&4)===4){if(e=this._resize.width-t.touches[0].clientX+this._resize.x-this._resize.borderWidth,e+this._resize.borderWidth>window.innerWidth&&(e=window.innerWidth),e+this._resize.borderWidth<=this._resize.minWidth){this._dialog.style.width=this._resize.minWidth+"px";return}this._dialog.style.width=e+"px",e=t.touches[0].clientX,e>window.innerWidth&&(e=window.innerWidth),this._dialog.style.left=e+"px"}};this.resizeStopDrag=t=>{document.documentElement.removeEventListener("mousemove",this.resizeDoDrag),document.documentElement.removeEventListener("mouseup",this.resizeStopDrag),document.documentElement.removeEventListener("touchmove",this.resizeTouchDrag),document.documentElement.removeEventListener("touchend",this.resizeStopDrag);let e=document.defaultView.getComputedStyle(this._dialog);this._state.x=parseInt(e.left,10),this._state.width=parseInt(e.width,10),this._state.y=parseInt(e.top,10),this._state.height=parseInt(e.height,10),this._body.style.pointerEvents="",this.emit("resized",this._state)};this.dragMouseDown=t=>{this.maximized||(this._dragPosition.x=t.clientX,this._dragPosition.y=t.clientY,document.documentElement.addEventListener("mouseup",this.dragMouseUp),document.documentElement.addEventListener("mousemove",this.dragMouseMove),this._header.style.cursor="move")};this.dragTouchStart=t=>{this.maximized||(this._dragPosition.x=t.clientX,this._dragPosition.y=t.clientY,document.documentElement.addEventListener("touchend",this.dragMouseUp),document.documentElement.addEventListener("touchmove",this.dragTouchMove),this._header.style.cursor="move")};this.dragMouseMove=t=>{let e=this._dragPosition.x-t.clientX,i=this._dragPosition.y-t.clientY;this._dragPosition.x=t.clientX,this._dragPosition.y=t.clientY,this._state.x=this._dialog.offsetLeft-e,this._state.y=this._dialog.offsetTop-i,this._state.x>window.innerWidth-16&&(this._state.x=window.innerWidth-16),this._state.y>window.innerHeight-16&&(this._state.y=window.innerHeight-16);let n=this._size;this._state.x<16-n.width&&(this._state.x=16-n.width),this._state.y<16-n.height&&(this._state.y=16-n.height),this._dialog.style.left=this._state.x+"px",this._dialog.style.top=this._state.y+"px"};this.dragTouchMove=t=>{if(!t.touches.length)return;let e=this._dragPosition.x-t.touches[0].clientX,i=this._dragPosition.y-t.touches[0].clientY;this._dragPosition.x=t.touches[0].clientX,this._dragPosition.y=t.touches[0].clientY,this._state.x=this._dialog.offsetLeft-e,this._state.y=this._dialog.offsetTop-i,this._state.x>window.innerWidth-16&&(this._state.x=window.innerWidth-16),this._state.y>window.innerHeight-16&&(this._state.y=window.innerHeight-16);let n=this._size;this._state.x<16-n.width&&(this._state.x=16-n.width),this._state.y<16-n.height&&(this._state.y=16-n.height),this._dialog.style.left=this._state.x+"px",this._dialog.style.top=this._state.y+"px"};this.dragMouseUp=()=>{document.documentElement.removeEventListener("mouseup",this.dragMouseUp),document.documentElement.removeEventListener("mousemove",this.dragMouseMove),document.documentElement.removeEventListener("touchend",this.dragMouseUp),document.documentElement.removeEventListener("touchmove",this.dragTouchMove),this._header.style.cursor="";let t=document.defaultView.getComputedStyle(this._dialog);this._state.x=parseInt(t.left,10),this._state.width=parseInt(t.width,10),this._state.y=parseInt(t.top,10),this._state.height=parseInt(t.height,10),this.emit("moved",this._state)};this.keepCentered=!1;this.moveable=!0;this.resizable=!0;this._maximizable=!0;t&&"type"in t&&t.type==1?(this._dialog=document.createElement("div"),this._dialog.open=!1):this._dialog=document.createElement("dialog"),typeof this._dialog.showModal!="function"&&(this._dialog.showModal=()=>{this._dialog.open||(this._dialog.style.display="block",this._dialog.style.visibility="visible",this._dialog.open=!0,this._state.show=2,this._dialog.dataset.show=""+this._state.show,this._dialog._keydown||(this._dialog._keydown=l=>{l.key==="Escape"&&l.srcElement.tagName!=="TEXTAREA"&&l.srcElement.tagName!=="INPUT"&&l.srcElement.tagName!=="SELECT"&&this.close()}),this._dialog.backdrop_||(this._dialog.backdrop_=document.createElement("div"),this._dialog.backdrop_.className="backdrop",this._dialog.backdrop_MouseEvent=function(l){if(this.hasAttribute("tabindex"))this.focus();else{var f=document.createElement("div");this.insertBefore(f,this.firstChild),f.tabIndex=-1,f.focus(),this.removeChild(f)}var c=document.createEvent("MouseEvents");c.initMouseEvent(l.type,l.bubbles,l.cancelable,window,l.detail,l.screenX,l.screenY,l.clientX,l.clientY,l.ctrlKey,l.altKey,l.shiftKey,l.metaKey,l.button,l.relatedTarget),this.dispatchEvent(c),l.stopPropagation()},this._dialog.backdrop_.addEventListener("mouseup",this._dialog.backdrop_MouseEvent.bind(this._dialog)),this._dialog.backdrop_.addEventListener("mousedown",this._dialog.backdrop_MouseEvent.bind(this._dialog)),this._dialog.backdrop_.addEventListener("click",this._dialog.backdrop_MouseEvent.bind(this._dialog))),this._dialog.parentNode.insertBefore(this._dialog.backdrop_,this._dialog.nextSibling),window.document.addEventListener("keydown",this._dialog._keydown))}),typeof this._dialog.show!="function"&&(this._dialog.show=()=>{this._dialog.open||(this._dialog.style.display="block",this._dialog.style.visibility="visible",this._dialog.open=!0,this._state.show=1,this._dialog.dataset.show=""+this._state.show)}),typeof this._dialog.close!="function"&&(this._dialog.close=()=>{this._dialog.style.display="",this._dialog.style.visibility="",this._dialog.open=!1,this._state.show=0,this._dialog.dataset.show=""+this._state.show,window.removeEventListener("resize",this._windowResize),this.emit("closed")}),this._dialog.dialog=this,t&&"id"in t&&t.id&&t.id.length?this._id=t.id:(!this._id||!this._id.length)&&(this._id="dialog"+new Date().getTime()),this._dialog.id=this._id,this._dialog.style.zIndex="100",this._dialog.style.margin="0",this._dialog.classList.add("dialog"),(!t||!t.noAdaptive)&&this._dialog.classList.add("adaptive"),t&&"moveable"in t&&(this.moveable=t.moveable),t&&"resizable"in t&&(this.resizable=t.resizable),t&&"maximizable"in t&&(this._maximizable=t.maximizable),typeof t?.height=="number"?this._dialog.style.height=t.height+"px":t?.height&&t?.height.length>0?this._dialog.style.height=t.height:this._dialog.style.height="480px",typeof t?.minHeight=="number"?this._dialog.style.minHeight=t.minHeight+"px":t?.minHeight&&t?.minHeight.length>0?this._dialog.style.minHeight=t.minHeight:this._dialog.style.minHeight="150px",typeof t?.minWidth=="number"?this._dialog.style.minWidth=t.minWidth+"px":t?.minWidth&&t?.minWidth.length>0?this._dialog.style.minWidth=t.minWidth:this._dialog.style.minWidth="300px",typeof t?.width=="number"?this._dialog.style.width=t.width+"px":t?.width&&t?.width.length>0?this._dialog.style.width=t.width:this._dialog.style.width="640px",typeof t?.y=="number"?this._dialog.style.top=t.y+"px":t?.y&&t?.y.length>0?this._dialog.style.top=t.y:this._dialog.style.top="0",typeof t?.x=="number"?this._dialog.style.left=t.x+"px":t?.x&&t?.x.length>0?this._dialog.style.left=t.x:this._dialog.style.left="0";let e="";if(t&&(t.buttons&2)===2&&(e+=`<button id="${this._id}-cancel" type="button" class="float-end btn btn-light" title="Cancel dialog">Cancel</button>`),t&&(t.buttons&1)===1&&(e+=`<button id="${this._id}-ok" type="button" class="float-end btn btn-primary" title="Confirm dialog">Ok</button>`),t&&(t.buttons&8)===8&&(e+=`<button id="${this._id}-no" type="button" class="float-end btn btn-light" title="No">No</button>`),t&&(t.buttons&4)===4&&(e+=`<button id="${this._id}-yes" type="button" class="float-end btn btn-primary" title="Yes">Yes</button>`),this._dialog.innerHTML=`<div class="dialog-header">
        <button id="${this._id}-header-close" style="padding: 4px;" type="button" class="btn btn-close float-end btn-danger" data-dismiss="modal" title="Close window"></button>
        <button type="button" class="btn btn-light float-end maximize" id="${this._id}-max" title="Maximize window" style="padding: 0 4px;margin-top: -1px;"><i class="bi-arrows-fullscreen"></i></button>
        <div>${t?.title||""}</div>
    </div>
    <div class="dialog-body"></div>
    <div class="dialog-footer">${e}</div>`,this._dialog.querySelector(`#${this._id}-header-close`).addEventListener("click",()=>{this.close()}),this._dialog.querySelector(`#${this._id}-max`).addEventListener("click",()=>{this.maximized?this.restore():this.maximize()}),this._dialog.addEventListener("close",l=>{if(l.target!==this._dialog)return;let f={preventDefault:!1};if(this.emit("closing",f),f.preventDefault){l.preventDefault();return}document.body.removeChild(this._dialog),this._state.show=0,this._dialog.dataset.show=""+this._state.show,this._dialog.backdrop_&&this._dialog.parentNode.removeChild(this._dialog.backdrop_),this._dialog._keydown&&window.document.removeEventListener("keydown",this._dialog._keydown),window.removeEventListener("resize",this._windowResize),this.emit("closed",this._dialog.returnValue)}),this._dialog.addEventListener("cancel",l=>{if(l.target!==this._dialog)return;let f={preventDefault:!1};if(this.emit("canceling",f),f.preventDefault){l.preventDefault();return}if(document.activeElement&&(document.activeElement.tagName==="TEXTAREA"||document.activeElement.tagName==="iNPUT"||document.activeElement.tagName==="SELECT")){l.preventDefault();return}this._dialog.open=!1,document.body.removeChild(this._dialog),this._state.show=0,this._dialog.dataset.show=""+this._state.show,this._dialog.backdrop_&&this._dialog.parentNode.removeChild(this._dialog.backdrop_),this._dialog._keydown&&window.document.removeEventListener("keydown",this._dialog._keydown),window.removeEventListener("resize",this._windowResize),this._dialog.returnValue!=="ok"&&this.emit("canceled")}),document.body.appendChild(this._dialog),this._maximizable?this._dialog.querySelector(`#${this._id}-max`).style.display="":this._dialog.querySelector(`#${this._id}-max`).style.display="none",t&&(t.buttons&2)===2&&this._dialog.querySelector(`#${this._id}-cancel`).addEventListener("click",()=>{let l={preventDefault:!1,button:2};this.emit("button-click",l),!l.preventDefault&&(this._dialog.returnValue="cancel",this.close())}),t&&(t.buttons&8)===8&&this._dialog.querySelector(`#${this._id}-no`).addEventListener("click",()=>{let l={preventDefault:!1,button:8};this.emit("button-click",l),!l.preventDefault&&(this._dialog.returnValue="no",this.close())}),t&&(t.buttons&1)===1&&this._dialog.querySelector(`#${this._id}-ok`).addEventListener("click",()=>{let l={preventDefault:!1,button:1};this.emit("button-click",l),!l.preventDefault&&(this._dialog.returnValue="ok",this._dialog.close())}),t&&(t.buttons&4)===4&&this._dialog.querySelector(`#${this._id}-yes`).addEventListener("click",()=>{let l={preventDefault:!1,button:4};this.emit("button-click",l),!l.preventDefault&&(this._dialog.returnValue="yes",this._dialog.close())}),this._body=this._dialog.querySelector('[class="dialog-body"]'),this._title=this._dialog.querySelector('[class="dialog-header"] div'),this._footer=this._dialog.querySelector('[class="dialog-footer"]'),this._header=this._dialog.querySelector('[class="dialog-header"]'),this.resizable){this._dialog.classList.add("resizable");var i=document.createElement("div");i.className="resizer-right",this._dialog.appendChild(i),i.addEventListener("mousedown",l=>{this.initResize(l,1)},!1),i.addEventListener("touchstart",l=>{this.initResizeTouch(l,1)},{passive:!0});var n=document.createElement("div");n.className="resizer-bottom",this._dialog.appendChild(n),n.addEventListener("mousedown",l=>{this.initResize(l,2)},!1),n.addEventListener("touchstart",l=>{this.initResizeTouch(l,2)},{passive:!0});var s=document.createElement("div");s.className="resizer-se",this._dialog.appendChild(s),s.addEventListener("mousedown",l=>{this.initResize(l,3)},!1),s.addEventListener("touchstart",l=>{this.initResizeTouch(l,3)},{passive:!0}),s=document.createElement("div"),s.className="resizer-ne",this._dialog.appendChild(s),s.addEventListener("mousedown",l=>{this.initResize(l,9)},!1),s.addEventListener("touchstart",l=>{this.initResizeTouch(l,9)},{passive:!0}),s=document.createElement("div"),s.className="resizer-nw",this._dialog.appendChild(s),s.addEventListener("mousedown",l=>{this.initResize(l,12)},!1),s.addEventListener("touchstart",l=>{this.initResizeTouch(l,12)},{passive:!0}),s=document.createElement("div"),s.className="resizer-sw",this._dialog.appendChild(s),s.addEventListener("mousedown",l=>{this.initResize(l,6)},!1),s.addEventListener("touchstart",l=>{this.initResizeTouch(l,6)},{passive:!0});var o=document.createElement("div");o.className="resizer-left",this._dialog.appendChild(o),o.addEventListener("mousedown",l=>{this.initResize(l,4)},!1),o.addEventListener("touchstart",l=>{this.initResizeTouch(l,4)},{passive:!0});var r=document.createElement("div");r.className="resizer-top",this._dialog.appendChild(r),r.addEventListener("mousedown",l=>{this.initResize(l,8)},!1),r.addEventListener("touchstart",l=>{this.initResizeTouch(l,8)},{passive:!0})}this.moveable&&(this._dialog.addEventListener("mousedown",()=>{this.focus()}),this._header.addEventListener("mousedown",this.dragMouseDown),this._header.addEventListener("touchstart",this.dragTouchStart,{passive:!0}));let a=document.defaultView.getComputedStyle(this._dialog);this._state.x=this._resize.x=parseInt(a.left,10),this._state.width=this._resize.width=parseInt(a.width,10),this._state.y=this._resize.y=parseInt(a.top,10),this._state.height=this._resize.height=parseInt(a.height,10),t&&"noFooter"in t&&t.noFooter&&this.hideFooter(),t&&"maximized"in t&&t.maximized&&this.maximize(),t&&"showModal"in t&&t.showModal?this.showModal():t&&"show"in t&&t.show&&(t.show===2?this.showModal():this.show()),t&&"keepCentered"in t&&t.keepCentered&&(this.keepCentered=t.keepCentered),(this.keepCentered||t&&"center"in t&&t.center)&&this.center(),t&&"position"in t&&t.position>0&&this.position(t.position),this._windowResize()}get maximizable(){return this._maximizable}set maximizable(t){t!==this._maximizable&&(this._maximizable=t,this.maximizable?this._dialog.querySelector(`#${this._id}-max`).style.display="":this._dialog.querySelector(`#${this._id}-max`).style.display="none")}set maximized(t){this._state.maximized!==t&&(this._state.maximized=t)}get maximized(){return this._state.maximized}initResize(t,e){if(this.maximized)return;let i=document.defaultView.getComputedStyle(this._dialog);this._resize.x=t.clientX,this._resize.width=parseInt(i.width,10),this._resize.y=t.clientY,this._resize.height=parseInt(i.height,10),this._resize.type=e,this._resize.minHeight=parseInt(i.minHeight,10),this._resize.minWidth=parseInt(i.minWidth,10),this._resize.borderHeight=t.offsetY+parseInt(i.borderTopWidth),this._resize.borderWidth=t.offsetX+parseInt(i.borderLeftWidth),this._body.style.pointerEvents="none",document.documentElement.addEventListener("mousemove",this.resizeDoDrag,!1),document.documentElement.addEventListener("mouseup",this.resizeStopDrag,!1)}initResizeTouch(t,e){if(!t.touches.length||this.maximized)return;let i=document.defaultView.getComputedStyle(this._dialog);this._resize.x=t.touches[0].clientX,this._resize.width=parseInt(i.width,10),this._resize.y=t.touches[0].clientY,this._resize.height=parseInt(i.height,10),this._resize.type=e,this._resize.minHeight=parseInt(i.minHeight,10),this._resize.minWidth=parseInt(i.minWidth,10);var n=t.target.getBoundingClientRect(),s=t.targetTouches[0].clientX-n.x,o=t.targetTouches[0].clientY-n.y;this._resize.borderHeight=o+parseInt(i.borderTopWidth),this._resize.borderWidth=s+parseInt(i.borderLeftWidth),this._body.style.pointerEvents="none",document.documentElement.addEventListener("touchmove",this.resizeTouchDrag,!1),document.documentElement.addEventListener("touchend",this.resizeStopDrag,!1)}get id(){return this._id}set id(t){if(this._id!==t&&(this._id=t,this._dialog)){let e=this._dialog.id;this._dialog.id=this._id;let i=this._dialog.querySelector(`#${this._id}-cancel`);i&&(i.id=this._id+"-cancel"),i=this._dialog.querySelector(`#${this._id}-ok`),i&&(i.id=this._id+"-ok"),i=this._dialog.querySelector(`#${this._id}-max`),i&&(i.id=this._id+"-max"),i=this._dialog.querySelector(`#${this._id}-header-close`),i&&(i.id=this._id+"-header-close")}}get title(){return this._title.innerHTML}set title(t){this._title.innerHTML=t}showModal(){if(this._dialog.parentElement||document.body.appendChild(this._dialog),this.makeVisible(!0),this._dialog.open){this.focus();return}this._dialog.showModal(),this._state.show=2,this._dialog.dataset.show=""+this._state.show,window.addEventListener("resize",this._windowResize),this.emit("shown",!0),this.focus()}show(){if(this._dialog.parentElement||document.body.appendChild(this._dialog),this.makeVisible(!0),this._dialog.open){this.focus();return}this._dialog.show(),this._state.show=1,this._dialog.dataset.show=""+this._state.show,window.addEventListener("resize",this._windowResize),this.emit("shown",!1),this.focus()}get opened(){return this._dialog.open}close(){this._dialog.open&&(this._dialog.backdrop_&&this._dialog.parentNode.removeChild(this._dialog.backdrop_),this._dialog._keydown&&window.document.removeEventListener("keydown",this._dialog._keydown),this._dialog.close())}get header(){return this._header}get body(){return this._body}get footer(){return this._footer}get dialog(){return this._dialog}get left(){return this._dialog.style.left}set left(t){this._dialog.style.left=t}get top(){return this._dialog.style.top}set top(t){this._dialog.style.top=t}get width(){return this._dialog.style.width}set width(t){this._dialog.style.width=t}get height(){return this._dialog.style.height}set height(t){this._dialog.style.top=t}get windowState(){return this._state}_width(){let t=this.dialog.offsetWidth||this._dialog.clientWidth;if(!t){let e=document.defaultView.getComputedStyle(this._dialog);t=t||parseInt(e.width,10)}return t}_height(){let t=this.dialog.offsetHeight||this._dialog.clientHeight;if(!t){let e=document.defaultView.getComputedStyle(this._dialog);t=t||parseInt(e.height,10)}return t}get _size(){let t=this.dialog.offsetWidth||this._dialog.clientWidth,e=this.dialog.offsetHeight||this._dialog.clientHeight;if(!t||!e){let i=document.defaultView.getComputedStyle(this._dialog);t=t||parseInt(i.width,10),e=e||parseInt(i.height,10)}return{width:t,height:e}}center(){this.position(48)}position(t){if(t<1)return;let e=this._size;(t&4)===4?this._state.y=0:(t&8)===8?this._state.y=window.innerHeight-e.height:(t&16)===16&&(this._state.y=window.innerHeight/2-e.height/2),(t&1)===1?this._state.x=0:(t&2)===2?this._state.x=window.innerWidth-e.width:(t&32)===32&&(this._state.x=window.innerWidth/2-e.width/2),this._dialog.style.left=this._state.x+"px",this._dialog.style.top=this._state.y+"px",this._state.width=e.width,this._state.height=e.height,this.emit("moved",this._state)}maximize(){this.maximized||(this.maximized=!0,this._dialog.classList.add("maximized"),this._dialog.querySelector(`#${this._id}-max`).firstElementChild.classList.remove("bi-arrows-fullscreen"),this._dialog.querySelector(`#${this._id}-max`).firstElementChild.classList.add("bi-arrows-angle-contract"),this.emit("maximized"))}restore(){this.maximized&&(this.maximized=!1,this._dialog.classList.remove("maximized"),this._dialog.querySelector(`#${this._id}-max`).firstElementChild.classList.add("bi-arrows-fullscreen"),this._dialog.querySelector(`#${this._id}-max`).firstElementChild.classList.remove("bi-arrows-angle-contract"),this.emit("restored"))}getMaxZIndex(t){let e=document.getElementsByTagName("dialog"),i=0,n=e.length,s=parseInt(this._dialog.style.zIndex,10),o=[];for(;i<n;i++){if(!e[i].style.zIndex||!e[i].style.zIndex.length)continue;let r=parseInt(e[i].style.zIndex,10);r>s&&(s=r),o.push({z:r,idx:i,show:parseInt(e[i].dataset.show||"",10)||0})}if(this._state.zIndex=s,t||this._state.zIndex>1e3)for(this._state.zIndex=100,i=0,o.sort((r,a)=>r.show>a.show?1:r.z<a.z?-1:r.z>a.z?1:0);i<n;i++)e[o[i]].backdrop_&&(e[o[i]].backdrop_.style.zIndex=""+this._state.zIndex++),e[o[i].idx].style.zIndex=""+this._state.zIndex++}showFooter(){this._footer.style.display="",this._body.style.bottom=this._footer.clientHeight+1+"px"}hideFooter(){this._footer.style.display="none",this._body.style.bottom="0"}focus(){this._dialog.focus(),this.getMaxZIndex(),this._dialog.style.zIndex=""+ ++this._state.zIndex,this.emit("focus")}makeVisible(t,e){t?(this._state.x+this._state.width>window.innerWidth&&(this._state.x=window.innerWidth-this._state.width-16,this._state.x<0&&(this._state.x=0),this._dialog.style.left=this._state.x+"px"),this._state.y+this._state.height>window.innerHeight-16&&(this._state.y=window.innerHeight-this._state.height-16,this._state.y<0&&(this._state.y=0),this._dialog.style.top=this._state.y+"px")):(this._state.x>window.innerWidth-16&&(this._state.x=window.innerWidth-16,this._dialog.style.left=this._state.x+"px"),this._state.y>window.innerHeight-16&&(this._state.y=window.innerHeight-16,this._dialog.style.top=this._state.y+"px")),e||this.emit("moved",this._state)}resetState(t){typeof t?.height=="number"?this._dialog.style.height=t.height+"px":t?.height&&t?.height.length>0?this._dialog.style.height=t.height:this._dialog.style.height="480px",typeof t?.minHeight=="number"?this._dialog.style.minHeight=t.minHeight+"px":t?.minHeight&&t?.minHeight.length>0?this._dialog.style.minHeight=t.minHeight:this._dialog.style.minHeight="150px",typeof t?.minWidth=="number"?this._dialog.style.minWidth=t.minWidth+"px":t?.minWidth&&t?.minWidth.length>0?this._dialog.style.minWidth=t.minWidth:this._dialog.style.minWidth="300px",typeof t?.width=="number"?this._dialog.style.width=t.width+"px":t?.width&&t?.width.length>0?this._dialog.style.width=t.width:this._dialog.style.width="640px",typeof t?.y=="number"?this._dialog.style.top=t.y+"px":t?.y&&t?.y.length>0?this._dialog.style.top=t.y:this._dialog.style.top="0",typeof t?.x=="number"?this._dialog.style.left=t.x+"px":t?.x&&t?.x.length>0?this._dialog.style.left=t.x:this._dialog.style.left="0";let e=document.defaultView.getComputedStyle(this._dialog);this._state.x=this._resize.x=parseInt(e.left,10),this._state.width=this._resize.width=parseInt(e.width,10),this._state.y=this._resize.y=parseInt(e.top,10),this._state.height=this._resize.height=parseInt(e.height,10),t&&"maximized"in t&&t.maximized?this.maximize():this.restore(),(this.keepCentered||t&&"center"in t&&t.center)&&this.center(),t&&"position"in t&&t.position>0&&this.position(t.position),this._windowResize()}},Ve=class extends fe{constructor(h,t,e){super(typeof h=="string"?{title:vt(e||4)+h,width:300,height:150,keepCentered:!0,center:!0,resizable:!1,moveable:!1,maximizable:!1,buttons:1}:h),this.body.classList.add("d-flex","justify-content-center","talign-content-center","align-items-center"),t&&(this.body.innerHTML=`<div class="text-center" style="width: 64px;height:64px;font-size: 40px;">${vt(e||4)}</div><div class="ms-3 align-self-center flex-fill">${t}</div></div>`)}},Ae=class extends fe{constructor(h,t,e){super(typeof h=="string"?{title:vt(e||1)+h,width:300,height:150,keepCentered:!0,center:!0,resizable:!1,moveable:!1,maximizable:!1,buttons:12}:h),this.body.classList.add("d-flex","justify-content-center","align-content-center","align-items-center"),t&&(this.body.innerHTML=`<div class="text-center" style="width: 64px;height:64px;font-size: 40px;">${vt(e||1)}</div><div class="ms-3 align-self-center flex-fill">${t}</div></div>`)}};function vt(p){if(typeof p=="string")return p+" ";switch(p){case 3:return'<i class="fa-regular fa-circle-xmark"></i> ';case 4:return'<i class="fa-solid fa-circle-exclamation"></i> ';case 1:return'<i class="fa-regular fa-circle-question"></i> '}return'<i class="fa-solid fa-circle-info"></i> '}window.confirm_box=(p,h,t)=>new Promise((e,i)=>{let n=new Ae(p,h,t);n.showModal(),n.on("button-click",s=>e(s)),n.on("canceled",()=>i(null)),n.on("closed",s=>s==="Yes"?0:i(null))});window.alert_box=(p,h,t)=>{new Ve(p,h,t).showModal()};window.Dialog=fe;var xt=class extends ie{constructor(t,e){super();this._simple=!0;this._init=!1;this.colorNames={"No color":"Default",BLACK:"Black",RED:"Maroon",GREEN:"Green",ORANGE:"Olive",BLUE:"Navy",MAGENTA:"Purple",WHITE:"Silver",CYAN:"Teal","BOLD BLACK":"Grey","BOLD RED":"Red","BOLD GREEN":"Lime",YELLOW:"Yellow","BOLD YELLOW":"Yellow","BOLD BLUE":"Blue","BOLD MAGENTA":"Fuchsia","BOLD CYAN":"Aqua",BOLD:"White","BOLD WHITE":"White",RGB000:"Black",RGB001:"Navy Blue",RGB002:"Dark Blue",RGB003:"Blue",RGB004:"Blue",RGB005:"Blue",RGB010:"Dark Green",RGB011:"Deep Sky Blue",RGB012:"Deep Sky Blue",RGB013:"Deep Sky Blue",RGB014:"Cobalt/Dodger Blue",RGB015:"Dodger Blue",RGB020:"Green",RGB021:"Spring Green",RGB022:"Turquoise",RGB023:"Deep Sky Blue",RGB024:"Deep Sky Blue",RGB025:"Dodger Blue",RGB030:"Green",RGB031:"Spring Green",RGB032:"Dark Cyan",RGB033:"Light Sea Green",RGB034:"Deep Sky Blue",RGB035:"Deep Sky Blue",RGB040:"Green",RGB041:"Spring Green",RGB042:"Spring Green",RGB043:"Cyan",RGB044:"Dark Turquoise",RGB045:"Turquoise",RGB050:"Green",RGB051:"Spring Green",RGB052:"Spring Green",RGB053:"Medium Spring Green",RGB054:"Cyan",RGB055:"Cyan",RGB100:"Dark Red",RGB101:"Deep Pink",RGB102:"Purple",RGB103:"Purple",RGB104:"Purple",RGB105:"Blue Violet",RGB110:"Orange",RGB111:"Dark Grey",RGB112:"Medium Purple",RGB113:"Slate Blue",RGB114:"Slate Blue",RGB115:"Royal Blue",RGB120:"Chartreuse",RGB121:"Dark Sea Green",RGB122:"Pale Turquoise",RGB123:"Steel Blue",RGB124:"Steel Blue",RGB125:"Cornflower Blue",RGB130:"Chartreuse",RGB131:"Dark Sea Green",RGB132:"Cadet Blue",RGB133:"Cadet Blue",RGB134:"Sky Blue",RGB135:"Steel Blue",RGB140:"Chartreuse",RGB141:"Pale Green",RGB142:"Sea Green",RGB143:"Aquamarine",RGB144:"Medium Turquoise",RGB145:"Steel Blue",RGB150:"Chartreuse",RGB151:"Sea Green",RGB152:"Sea Green",RGB153:"Sea Green",RGB154:"Aquamarine",RGB155:"Dark Slate Gray",RGB200:"Dark Red",RGB201:"Deep Pink",RGB202:"Dark Magenta",RGB203:"Dark Magenta",RGB204:"Dark Violet",RGB205:"Purple",RGB210:"Orange",RGB211:"Light Pink",RGB212:"Plum",RGB213:"Medium Purple",RGB214:"Medium Purple",RGB215:"Slate Blue",RGB220:"Yellow",RGB221:"Wheat",RGB222:"Grey",RGB223:"Light Slate Grey",RGB224:"Medium Purple",RGB225:"Light Slate Blue",RGB230:"Yellow",RGB231:"Dark Olive Green",RGB232:"Dark Sea Green",RGB233:"Light Sky Blue",RGB234:"Light Sky Blue",RGB235:"Sky Blue",RGB240:"Chartreuse",RGB241:"Dark Olive Green",RGB242:"Pale Green",RGB243:"Dark Sea Green",RGB244:"Dark Slate Gray",RGB245:"Sky Blue",RGB250:"Chartreuse",RGB251:"Light Green",RGB252:"Light Green",RGB253:"Pale Green",RGB254:"Aquamarine",RGB255:"Dark Slate Gray",RGB300:"Red",RGB301:"Deep Pink",RGB302:"Medium Violet Red",RGB303:"Magenta",RGB304:"Dark Violet",RGB305:"Purple",RGB310:"Dark Orange",RGB311:"Indian Red",RGB312:"Hot Pink",RGB313:"Medium Orchid",RGB314:"Medium Orchid",RGB315:"Medium Purple",RGB320:"Dark Goldenrod",RGB321:"Light Salmon",RGB322:"Rosy Brown",RGB323:"Grey",RGB324:"Medium Purple",RGB325:"Medium Purple",RGB330:"Gold",RGB331:"Dark Khaki",RGB332:"Navajo White",RGB333:"Grey",RGB334:"Light Steel Blue",RGB335:"Light Steel Blue",RGB340:"Yellow",RGB341:"Dark Olive Green",RGB342:"Dark Sea Green",RGB343:"Dark Sea Green",RGB344:"Light Cyan",RGB345:"Light Sky Blue",RGB350:"Green Yellow",RGB351:"Dark Olive Green",RGB352:"Pale Green",RGB353:"Dark Sea Green",RGB354:"Dark Sea Green",RGB355:"Pale Turquoise",RGB400:"Crimson/Red",RGB401:"Deep Pink",RGB402:"Deep Pink",RGB403:"Magenta",RGB404:"Magenta",RGB405:"Magenta",RGB410:"Dark Orange",RGB411:"Indian Red",RGB412:"Hot Pink",RGB413:"Hot Pink",RGB414:"Orchid",RGB415:"Medium Orchid",RGB420:"Orange",RGB421:"Light Salmon/Bronze",RGB422:"Light Pink",RGB423:"Pink",RGB424:"Plum",RGB425:"Violet",RGB430:"Gold",RGB431:"Light Goldenrod",RGB432:"Tan",RGB433:"Misty Rose",RGB434:"Thistle",RGB435:"Plum",RGB440:"Yellow",RGB441:"Khaki",RGB442:"Light Goldenrod",RGB443:"Light Yellow",RGB444:"Grey",RGB445:"Light Steel Blue",RGB450:"Yellow",RGB451:"Dark Olive Green",RGB452:"Dark Olive Green",RGB453:"Dark Sea Green",RGB454:"Honeydew",RGB455:"Light Cyan",RGB500:"Red",RGB501:"Deep Pink",RGB502:"Deep Pink",RGB503:"Deep Pink",RGB504:"Magenta",RGB505:"Magenta",RGB510:"Orangered",RGB511:"Indian Red",RGB512:"Indian Red",RGB513:"Hot Pink",RGB514:"Hot Pink",RGB515:"Medium Orchid",RGB520:"Dark Orange",RGB521:"Salmon",RGB522:"Light Coral",RGB523:"Pale Violet Red",RGB524:"Orchid",RGB525:"Orchid",RGB530:"Orange",RGB531:"Sandy Brown",RGB532:"Light Salmon",RGB533:"Light Pink",RGB534:"Pink",RGB535:"Plum",RGB540:"Gold",RGB541:"Light Goldenrod",RGB542:"Light Goldenrod",RGB543:"Navajo White",RGB544:"Misty Rose",RGB545:"Thistle",RGB550:"Yellow",RGB551:"Light Goldenrod",RGB552:"Khaki",RGB553:"Wheat",RGB554:"Corn Silk",RGB555:"White",mono00:"Grey 3",mono01:"Grey 7",mono02:"Grey 11",mono03:"Grey 15",mono04:"Grey 19",mono05:"Grey 23",mono06:"Grey 27",mono07:"Grey 30",mono08:"Grey 35",mono09:"Grey 39",mono10:"Grey 32",mono11:"Grey 46",mono12:"Grey 50",mono13:"Grey 54",mono14:"Grey 58",mono15:"Grey 62",mono16:"Grey 66",mono17:"Grey 70",mono18:"Grey 74",mono19:"Grey 78",mono20:"Grey 82",mono21:"Grey 85",mono22:"Grey 89",mono23:"Grey 93"};this.colorList=[];if(!t)throw new Error("AdvEditor must be a selector, element or jquery object");if(typeof t=="string"){if(this._element=document.querySelector(t),!this._element)throw new Error("Invalid selector for AdvEditor.")}else if(t instanceof $)this._element=t[0];else if(t instanceof HTMLElement)this._element=t;else throw new Error("AdvEditor must be a selector, element or jquery object");this.simple=!e}get id(){return this._element?this._element.id:""}get element(){return this._element}get simple(){return this._simple}set simple(t){t!==this._simple&&(this._simple=t,this.tinymceExist&&(t?this.remove():this.initialize()))}clear(){this.isSimple?this._element.value="":tinymce.activeEditor.setContent("")}get value(){return this.isSimple?this._element.value:this.getFormattedText().replace(/(?:\r)/g,"")}set value(t){this.isSimple?this._element.value=t:tinymce.activeEditor.setContent(t)}insert(t){if(this.isSimple)Re(this._element,t);else{t=Ie(t),t=t.replace(/ /g,"&nbsp;"),t=t.replace(/\t/g,"&nbsp;&nbsp;&nbsp;"),t=t.replace(/(?:\r\n|\r|\n)/g,"<br/>");var e=this.getText();e===`
`?tinymce.activeEditor.undoManager.transact(()=>{tinymce.activeEditor.setContent(t)}):(e.endsWith(`
`)||(t="<br>"+t),tinymce.activeEditor.undoManager.transact(()=>{tinymce.activeEditor.dom.add(tinymce.activeEditor.getBody(),"span",{},t)}))}}get tinymceExist(){return typeof tinymce<"u"}get isSimple(){return this._simple||!this.tinymceExist}loadColors(){var t=Zt(),e,i,n,s,o,r,a=[],l;this._ColorTable=[],this._colors={};var f=client.getOption("colors")||[];for(i=new X(f[0]||t[0]).toHex().substr(1).toUpperCase(),this._colors[i]="BLACK",this._ColorTable.push(i,"BLACK"),i=new X(f[1]||t[1]).toHex().substr(1).toUpperCase(),this._colors[i]="RED",this._ColorTable.push(i,"RED"),i=new X(f[2]||t[2]).toHex().substr(1).toUpperCase(),this._colors[i]="GREEN",this._ColorTable.push(i,"GREEN"),i=new X(f[3]||t[3]).toHex().substr(1).toUpperCase(),this._colors[i]="ORANGE",this._ColorTable.push(i,"ORANGE"),i=new X(f[4]||t[4]).toHex().substr(1).toUpperCase(),this._colors[i]="BLUE",this._ColorTable.push(i,"BLUE"),i=new X(f[5]||t[5]).toHex().substr(1).toUpperCase(),this._colors[i]="MAGENTA",this._ColorTable.push(i,"MAGENTA"),i=new X(f[6]||t[6]).toHex().substr(1).toUpperCase(),this._colors[i]="CYAN",this._ColorTable.push(i,"CYAN"),i=new X(f[7]||t[7]).toHex().substr(1).toUpperCase(),this._colors[i]="WHITE",this._ColorTable.push(i,"WHITE"),i=new X(f[8]||t[8]).toHex().substr(1).toUpperCase(),this._colors[i]="mono11",this._ColorTable.push(i,"BOLD BLACK"),a.push(i),i=new X(f[9]||t[9]).toHex().substr(1).toUpperCase(),this._colors[i]="BOLD%^%^RED",this._ColorTable.push(i,"BOLD RED"),a.push(i),i=new X(f[10]||t[10]).toHex().substr(1).toUpperCase(),this._colors[i]="BOLD%^%^GREEN",this._ColorTable.push(i,"BOLD GREEN"),a.push(i),i=new X(f[11]||t[11]).toHex().substr(1).toUpperCase(),this._colors[i]="BOLD%^%^YELLOW",this._ColorTable.push(i,"BOLD YELLOW"),a.push(i),i=new X(f[11]||t[11]).toHex().substr(1).toUpperCase(),this._colors[i]="YELLOW",this._ColorTable.push(i,"YELLOW"),a.push(i),i=new X(f[12]||t[12]).toHex().substr(1).toUpperCase(),this._colors[i]="BOLD%^%^BLUE",this._ColorTable.push(i,"BOLD BLUE"),a.push(i),i=new X(f[13]||t[13]).toHex().substr(1).toUpperCase(),this._colors[i]="BOLD%^%^MAGENTA",this._ColorTable.push(i,"BOLD MAGENTA"),a.push(i),i=new X(f[14]||t[14]).toHex().substr(1).toUpperCase(),this._colors[i]="BOLD%^%^CYAN",this._ColorTable.push(i,"BOLD CYAN"),a.push(i),i=new X(f[15]||t[15]).toHex().substr(1).toUpperCase(),this._colors[i]="BOLD%^%^WHITE",this._ColorTable.push(i,"BOLD WHITE"),n=0;n<6;n++)for(s=0;s<6;s++)for(o=0;o<6;o++)r=`RGB${n}${s}${o}`,i="",e=0,e=n*40+55,e<16&&(i+="0"),i+=e.toString(16),e=0,e=s*40+55,e<16&&(i+="0"),i+=e.toString(16),e=0,e=o*40+55,e<16&&(i+="0"),i+=e.toString(16),i=i.toUpperCase(),this._colors[i]||(this._colors[i]=r),this.colorList.push({color:r,hex:"#"+i,rgb:{r:n*40+55,g:s*40+55,b:o*40+55}});for(n=232;n<=255;n++)s=(n-232)*10+8,s<16?s="0"+s.toString(16).toUpperCase():s=s.toString(16).toUpperCase(),s=s+s+s,n<242?this._colors[s]||(this._colors[s]="mono0"+(n-232)):this._colors[s]||(this._colors[s]="mono"+(n-232));for(o=0,l=a.length;o<l;o++)this._colors["B"+a[o]]=this._colors[this.nearestHex("#"+a[o]).substr(1)].toUpperCase();this._colors.BFFFFFF="RGB555",tinymce.activeEditor.options.set("color_map",this._ColorTable)}initPlugins(){let t=this;tinymce.PluginManager.add("pinkfishtextcolor",function(e,i){let n="#000000",s=["000000","BLACK","800000","RED","008000","GREEN","808000","ORANGE","0000EE","BLUE","800080","MAGENTA","008080","CYAN","BBBBBB","WHITE","808080","BOLD BLACK","FF0000","BOLD RED","00FF00","BOLD GREEN","FFFF00","YELLOW","5C5CFF","BOLD YELLOW","5C5CFF","BOLD BLUE","FF00FF","BOLD MAGENTA","00FFFF","BOLD CYAN","FFFFFF","BOLD WHITE"],o,r=C=>{let _=C;return{get:()=>_,set:v=>{_=v}}},a=r(n),l=r(n),f=(C,_)=>{let b;return C.dom.getParents(C.selection.getStart(),d=>{let v;(v=d.style[_==="forecolor"?"color":"background-color"])&&(b=b||v)}),b},c=(C,_,b)=>{C.undoManager.transact(()=>{C.focus(),C.formatter.apply(_,{value:b}),C.nodeChanged()})},y=(C,_)=>{C.undoManager.transact(()=>{C.focus(),C.formatter.remove(_,{value:null},null,!0),C.nodeChanged()})},u=C=>{C.addCommand("mceApplyTextcolor",(_,b)=>{c(C,_,b)}),C.addCommand("mceRemoveTextcolor",_=>{y(C,_)}),C.addCommand("mceSetTextcolor",(_,b)=>{o&&(I(o,_==="forecolor"?"pinkfishforecolor":_,b),(_==="forecolor"?a:l).set(b))})},x=C=>{let _="choiceitem",b={type:_,text:"Remove color",icon:"color-swatch-remove-color",value:"remove"};return C?[b,{type:_,text:"Custom color",icon:"color-picker",value:"custom"}]:[b]},S=(C,_,b,d)=>{b==="custom"?t.openColorDialog(_,""):b==="remove"?(d(""),C.execCommand("mceRemoveTextcolor",_)):(d(b),C.execCommand("mceApplyTextcolor",_,b))},m=C=>{let _=[];for(let b=0;b<C.length;b+=2)_.push({text:C[b+1],value:"#"+C[b],type:"choiceitem"});return _},g=(C,_)=>m(s).concat(x(_)),T=(C,_)=>b=>{b(g(C,_))},I=(C,_,b)=>{let d=_==="pinkfishforecolor"?"tox-icon-text-color__color":"tox-icon-highlight-bg-color__color";C.setIconFill(d,b)},k=(C,_,b,d,v)=>{C.ui.registry.addSplitButton(_,{tooltip:d,presets:"color",icon:_==="pinkfishforecolor"?"text-color":"highlight-bg-color",select:N=>new X(f(C,b)||"").toHex().toLowerCase()===N.toLowerCase(),columns:5,fetch:T(s,!0),onAction:N=>{o=N,S(C,b,v.get(),()=>{})},onItemAction:(N,J)=>{o=N,S(C,b,J,se=>{v.set(se),C.fire("TextColorChange",{name:_,color:se})})},onSetup:N=>{I(N,_,v.get());let J=se=>{se.name===_&&I(N,se.name,se.color)};return C.on("TextColorChange",J),()=>{C.off("TextColorChange",J)}}})},H=(C,_,b,d)=>{C.ui.registry.addNestedMenuItem(_,{text:d,icon:_==="pinkfishforecolor"?"text-color":"highlight-bg-color",getSubmenuItems:()=>[{type:"fancymenuitem",fancytype:"colorswatch",onAction:v=>{S(C,b,v.value,()=>{})}}]})};u(e),k(e,"pinkfishforecolor","forecolor","Text color",a),k(e,"pinkfishbackcolor","hilitecolor","Background color",l),H(e,"pinkfishforecolor","forecolor","Text color"),H(e,"pinkfishbackcolor","hilitecolor","Background color")}),tinymce.PluginManager.add("pinkfish",function(e){e.addCommand("mceApplyFormat",(s,o)=>{e.undoManager.transact(()=>{e.focus(),t.clearReverse($(".reverse",$(e.getDoc()).contents())),o?e.formatter.apply(s,{value:o}):e.formatter.apply(s),t.addReverse($(".reverse",$(e.getDoc()).contents())),e.nodeChanged()})}),e.addCommand("mceRemoveFormat",s=>{e.undoManager.transact(()=>{e.focus(),t.clearReverse($(".reverse",$(e.getDoc()).contents())),e.formatter.remove(s,{value:null},null,!0),t.addReverse($(".reverse",$(e.getDoc()).contents())),e.nodeChanged()})});function i(s,o){e.on("init",()=>{e.formatter.formatChanged(o,function(r){s.setActive(r)})})}function n(s){(!s||typeof s!="string")&&(s=this.settings.format),tinymce.activeEditor.undoManager.transact(()=>{$("#tinymce",tinymce.activeEditor.getDoc()).removeClass("animate"),this.clearReverse($(".reverse",$(e.getDoc()).contents())),e.execCommand("mceToggleFormat",!1,s),this.addReverse($(".reverse",$(e.getDoc()).contents())),$("#tinymce",tinymce.activeEditor.getDoc()).addClass("animate")})}e.ui.registry.addIcon("overline",'<i class="mce-i-overline"></i>'),e.ui.registry.addIcon("dblunderline",'<i class="mce-i-dblunderline"></i>'),e.ui.registry.addIcon("flash",'<i class="mce-i-flash"></i>'),e.ui.registry.addIcon("reverse",'<i class="mce-i-reverse"></i>'),e.ui.registry.addIcon("pasteformatted",'<i class="mce-i-pasteformatted"></i>'),e.ui.registry.addIcon("copyformatted",'<i class="mce-i-copyformatted"></i>'),e.ui.registry.addSplitButton("send",{icon:"arrow-right",tooltip:"Send to mud",onAction:()=>{client.sendCommand(t.getFormattedText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close")},onItemAction:(s,o)=>{switch(o){case"formatted":client.sendCommand(t.getFormattedText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"text":client.sendCommand(t.getText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"formattednoecho":client.sendBackground(t.getFormattedText().replace(/(?:\r)/g,""),!0),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"textnoecho":client.sendBackground(t.getText().replace(/(?:\r)/g,""),!0),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"formattedverbatim":client.send(t.getFormattedText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"textverbatim":client.send(t.getText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"rawformatted":client.sendRaw(t.getFormattedText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break;case"rawtext":client.sendRaw(t.getText().replace(/(?:\r)/g,"")),client.getOption("editorClearOnSend")&&tinymce.activeEditor.setContent(""),client.getOption("editorCloseOnSend")&&t.emit("close");break}},fetch:s=>{s([{text:"Formatted as commands",value:"formatted",type:"choiceitem"},{text:"Text as commands",value:"text",type:"choiceitem"},{text:"Formatted as commands (No echo)",value:"formattednoecho",type:"choiceitem"},{text:"Text as commands (No echo)",value:"textnoecho",type:"choiceitem"},{text:"Formatted verbatim (No echo)",value:"formattedverbatim",type:"choiceitem"},{text:"Text verbatim (No echo)",value:"textverbatim",type:"choiceitem"},{text:"Raw formatted (No echo)",value:"rawformatted",type:"choiceitem"},{text:"Raw text (No echo)",value:"rawtext",type:"choiceitem"}])}}),e.ui.registry.addButton("append",{icon:"browse",tooltip:"Append file...",onAction:()=>t.appendFile()}),e.ui.registry.addButton("clear",{icon:"remove",tooltip:"Clear",onAction:()=>t.clear()}),e.ui.registry.addButton("pasteformatted",{icon:"pasteformatted",tooltip:"Paste formatted",onAction:s=>{Dt().then(o=>{t.insertFormatted(o||"")}).catch(o=>{client.enableDebug&&client.debug(o),o.message&&o.message==="Permission not granted!"?alert("Paste permission not granted."):alert("Paste not supported.")})}}),e.ui.registry.addButton("pasteastext",{icon:"paste-text",tooltip:"Paste as text",onAction:s=>{Dt().then(o=>{tinymce.activeEditor.execCommand("mceInsertContent",!1,(o||"").replace(/(\r\n|\r|\n)/g,"<br/>").replaceAll("  ","&nbsp;&nbsp;"))}).catch(o=>{client.enableDebug&&client.debug(o),o.message&&o.message==="Permission not granted!"?alert("Paste permission not granted."):alert("Paste not supported.")})}}),e.ui.registry.addButton("copyformatted",{icon:"copyformatted",tooltip:"Copy formatted",onAction:s=>Ot(t.getFormattedSelection().replace(/(?:\r)/g,""))}),e.ui.registry.addToggleButton("overline",{icon:"overline",tooltip:"Overline",format:"overline",onAction:s=>n("overline"),onSetup:s=>i(s,"overline")}),e.ui.registry.addToggleButton("dblunderline",{icon:"dblunderline",tooltip:"Double Underline",format:"dblunderline",onAction:s=>n("dblunderline"),onSetup:s=>i(s,"dblunderline")}),e.ui.registry.addToggleButton("flash",{tooltip:"Flash",format:"flash",icon:"flash",onAction:s=>n("flash"),onSetup:s=>i(s,"flash")}),e.ui.registry.addToggleButton("reverse",{icon:"reverse",tooltip:"Reverse",format:"reverse",onAction:s=>n("reverse"),onSetup:s=>i(s,"reverse")}),e.ui.registry.addMenuItem("style",{text:"Style",menu:[{image:"overline",text:"Overline",format:"overline",onclick:n,onpostrender:i},{image:"dblunderline",text:"Double Underline",format:"dblunderline",onclick:n,onpostrender:i},{text:"Flash",format:"flash",image:"flash",onclick:n,onpostrender:i},{image:"reverse",text:"Reverse",format:"reverse",onclick:n,onpostrender:i}]}),e.ui.registry.addMenuItem("overline",{image:"overline",text:"Overline",format:"overline",onclick:n,onpostrender:i}),e.ui.registry.addMenuItem("dblunderline",{image:"dblunderline",text:"Double Underline",format:"dblunderline",onclick:n,onpostrender:i}),e.ui.registry.addMenuItem("flash",{text:"Flash",format:"flash",image:"flash",onclick:n,onpostrender:i}),e.ui.registry.addMenuItem("reverse",{image:"reverse",text:"Reverse",format:"reverse",onclick:n,onpostrender:i}),e.on("Change",()=>{t.addReverse($(".reverse",$(e.getDoc()).contents()))}),e.addShortcut("ctrl+s","Strikethrough",()=>{n("strikethrough")}),e.addShortcut("ctrl+o","Overline",()=>{n("overline")}),e.addShortcut("ctrl+d","Double Underline",()=>{n("dblunderline")}),e.addShortcut("ctrl+f","Flash",()=>{n("flash")}),e.addShortcut("ctrl+r","Reverse",()=>{n("reverse")})})}clearReverse(t,e){t.each(function(){if($(this).data("reverse")&&!(e&&$(this).hasClass("reverse"))){var i,n;e?(i=$(this).css("color"),n=$(this).css("background-color")):(n=$(this).parent().css("color"),i=$(this).parent().css("background-color")),i==="black"&&(i=""),n==="rgba(0, 0, 0, 0)"&&(n="black"),$(this).css("color",n),$(this).css("background-color",i),$(this).children().length&&this.clearReverse($(this).children(),!0)}})}addReverse(t,e){t.each(function(){if(!(e&&$(this).hasClass("reverse"))){var i,n;e?(i=$(this).css("color"),n=$(this).css("background-color")):(i=$(this).parent().css("color"),n=$(this).parent().css("background-color")),i==="rgba(0, 0, 0, 0)"&&(i="black"),n==="rgba(0, 0, 0, 0)"&&(n="black"),$(this).children().length&&(this.clearReverse($(this).children(),!0),this.addReverse($(this).children(),!0)),$(this).css("color",n),$(this).css("background-color",i),$(this).data("reverse",!0)}})}colorCell(t,e){var i='<td class="mce-grid-cell'+(t==="transparent"?" mce-colorbtn-trans":"")+'">';return i+='<div id="'+e+'"',i+=' data-mce-color="'+t+'"',i+=' role="option"',i+=' tabIndex="-1"',i+=' style="background-color: '+(t==="transparent"?t:"#"+t)+'"',this.colorNames[e]?i+=' title="'+e+", "+this.colorNames[e]+'">':i+=' title="'+e+'">',t==="transparent"&&(i+="&#215;"),i+="</div>",i+="</td>",i}openColorDialog(t,e){if(!this._colorDialog){this._colorDialog=new fe({noFooter:!0,title:'<i class="fas fa-palette"></i> Pick color',center:!0,resizable:!1,moveable:!1,maximizable:!1,width:380,height:340}),this._colorDialog.body.style.alignItems="center",this._colorDialog.body.style.display="flex";let s,o,r,a,l,f;var i='<table style="margin : auto !important;" class="mce-grid mce-grid-border mce-colorbutton-grid" role="list" cellspacing="0"><tbody><tr>';for(s=0,o=this._ColorTable.length;s<o;s+=2)i+=this.colorCell(this._ColorTable[s],this._ColorTable[s+1]),s/2%6===5&&(i+='<td class="mce-grid-cell"></td>');i+='<td class="mce-grid-cell"></td>',i+=this.colorCell("transparent","No color"),i+="</tr><tr><td></td></tr>";var n="";for(r=0;r<6;r++){for(a<3?i+="<tr>":n+="<tr>",a=0;a<6;a++){for(l=0;l<6;l++)f=`RGB${r}${a}${l}`,e="",s=0,s=r*40+55,s<16&&(e+="0"),e+=s.toString(16),s=0,s=a*40+55,s<16&&(e+="0"),e+=s.toString(16),s=0,s=l*40+55,s<16&&(e+="0"),e+=s.toString(16),e=e.toUpperCase(),a<3?i+=this.colorCell(e,f):n+=this.colorCell(e,f);a===2?i+="</tr>":a<3?i+='<td class="mce-grid-cell"></td>':a<5&&(n+='<td class="mce-grid-cell"></td>')}a<3?i+="</tr>":n+="</tr>"}for(i+=n,i+="<tr><td></td></tr><tr>",r=232;r<=255;r++)a=(r-232)*10+8,a<16?a="0"+a.toString(16).toUpperCase():a=a.toString(16).toUpperCase(),a=a+a+a,i+=this.colorCell(a,e),(r===237||r===249)&&(i+='<td class="mce-grid-cell"></td>'),r===243&&(i+="</tr><tr>");i+="</tr></tbody></table>",i+=`<style>
.mce-colorbtn-trans div {line-height: 14px;overflow: hidden;}
.mce-grid td.mce-grid-cell div{border:1px solid #c5c5c5;width:15px;height:15px;margin:0;cursor:pointer}.mce-grid td.mce-grid-cell div:focus{border-color:#91bbe9}.mce-grid td.mce-grid-cell div[disabled]{cursor:not-allowed}            
.mce-grid{border-spacing:2px;border-collapse:separate}.mce-grid a{display:block;border:1px solid transparent}.mce-grid a:hover,.mce-grid a:focus{border-color:#91bbe9}.mce-grid-border{margin:0 4px 0 4px}.mce-grid-border a{border-color:#c5c5c5;width:13px;height:13px}.mce-grid-border a:hover,.mce-grid-border a.mce-active{border-color:#91bbe9;background:#bdd6f2}            
            </style>`,this._colorDialog.body.innerHTML=i;let c=this._colorDialog.body.querySelectorAll("div");for(s=0,o=c.length;s<o;s++)c[s].addEventListener("click",y=>{e=y.currentTarget.dataset.mceColor,e==="transparent"?tinymce.activeEditor.execCommand("mceRemoveFormat",this._colorDialog.dialog.dataset.type):tinymce.activeEditor.execCommand("mceApplyFormat",this._colorDialog.dialog.dataset.type,"#"+e),tinymce.activeEditor.execCommand("mceSetTextcolor",this._colorDialog.dialog.dataset.type,"#"+e),this._colorDialog.close()})}this._colorDialog.dialog.dataset.type=t,this._colorDialog.showModal()}appendFile(){be("Append file(s)",!0).then(t=>{for(var e=0,i=t.length;e<i;e++)ye(t[e]).then(n=>{this.insert(n)}).catch(client.error)}).catch(()=>{})}insertFormatted(t){this.isSimple?Re(this._element,t):tinymce.activeEditor.execCommand("insertHTML",!1,Bt(t).replace(/(\r\n|\r|\n)/g,"<br/>"))}setFormatted(t){this.isSimple?this._element.value=t:tinymce.activeEditor.setContent(Bt(t).replace(/(\r\n|\r|\n)/g,"<br/>"),{format:"html"})}buildHTMLStack(t){for(var e,i,n,s,o=[],r=0,a=t.length;r<a;r++)if(i=$(t[r]),e=i.prop("tagName"),e==="EM"||e==="I"?e="ITALIC":(e==="STRONG"||e==="B")&&(e="BOLD"),!e)o.push('"'+i.text()+'"');else if(e==="SPAN"){if(t[r].className!=""){for(e=t[r].className.toUpperCase().split(/\s+/g),s=e.length,n=0;n<s;n++)e[n]==="NOFLASH"?o.push("FLASH"):e[n].length>0&&o.push(e[n]);for(o=o.concat(this.buildHTMLStack(i.contents())),n=0;n<s;n++)e[n]==="NOFLASH"?o.push("FLASH"):e[n].length>0&&o.push("/"+e[n]);continue}else if(i.css("text-decoration")==="line-through")e="STRIKEOUT";else if(i.css("text-decoration")==="underline")e="UNDERLINE";else if(i.data("mce-style")){for(e=i.data("mce-style").toUpperCase().split(";"),s=e.length,n=0;n<s;n++)e[n].endsWith("INHERIT")||e[n].endsWith("BLACK")||(e[n]=e[n].trim(),e[n]=e[n].replace("BACKGROUND:","BACKGROUND-COLOR:"),e[n].length>0&&o.push(e[n]));for(o=o.concat(this.buildHTMLStack(i.contents())),n=0;n<s;n++)e[n].endsWith("INHERIT")||e[n].endsWith("BLACK")||e[n].length>0&&o.push("/"+e[n].trim());continue}else if(i.css("color")||i.css("background-color")||i.css("background")){for(e=[],i.css("color")&&e.push("COLOR: "+new X(i.css("color")).toHex().toUpperCase()),i.css("background-color")&&e.push("BACKGROUND-COLOR: "+new X(i.css("background-color")).toHex().toUpperCase()),i.css("background")&&e.push("BACKGROUND-COLOR: "+new X(i.css("background")).toHex().toUpperCase()),s=e.length,n=0;n<s;n++)e[n].length>0&&o.push(e[n].trim());for(o=o.concat(this.buildHTMLStack(i.contents())),n=0;n<s;n++)e[n].length>0&&o.push("/"+e[n].trim());continue}o.push(e),o=o.concat(this.buildHTMLStack(i.contents())),o.push("/"+e)}else e=="BR"&&i.data("mce-bogus")?o.push("RESET"):(o.push(e),o=o.concat(this.buildHTMLStack(i.contents())),o.push("/"+e));return o}getFormattedSelection(){for(var t=tinymce.activeEditor.dom.getParents(tinymce.activeEditor.selection.getNode()),e=0,i=t.length,n="<html>",s="</html>";e<i;e++){var o=t[e].tagName;if(o==="EM"||o==="I"||o==="STRONG"||o==="B")n+="<"+o+">",s="</"+o+">"+s;else if(o==="SPAN"){n+="<"+o,t[e].className!=""&&(n+=' class="'+t[e].className+'"');var r="";t[e].style.textDecoration!=""&&(r+="text-decoration:"+t[e].style.textDecoration+";"),t[e].style.color!=""&&(r+="color:"+t[e].style.color+";"),t[e].style.background!=""&&(r+="background:"+t[e].style.background+";"),t[e].style.backgroundColor!=""&&(r+="background-color:"+t[e].style.backgroundColor+";"),r.length>0&&(n+=' style="'+r+'"'),t[e].dataset&&t[e].dataset.mceStyle&&(n+=' data-mce-style="'+t[e].dataset.mceStyle+'"'),n+=" >",s="</"+o+">"+s}else if(o==="BODY"){n+="<"+o+">",s="</"+o+">"+s;break}}return this.formatHtml($(n+tinymce.activeEditor.selection.getContent({format:"raw"}).replace(/<\/div><div>/g,"<br>")+s))}getFormattedText(){return this.isSimple?this._element.value:this.formatHtml($("<html>"+this.getRaw().replace(/<\/div><div>/g,"<br>")+"</html>"))}getText(){return this.isSimple?this._element.value:tinymce.activeEditor.getContent({format:"text"})}getHTML(){return this.isSimple?this._element.value:tinymce.activeEditor.getContent({format:"html"})}getRaw(){return this.isSimple?this._element.value:tinymce.activeEditor.getContent({format:"raw"})}formatHtml(t){var e=this.buildHTMLStack(t),i=[],n=[],s,o,r,a;for(o=e.length-1;o>=0&&(!e[o].startsWith('"')&&e[o]!="BR"&&e[o]!="RESET");o--)e.pop();for(e[0]==="DIV"&&e.shift(),o=0,r=e.length;o<r;o++)switch(e[o]){case"BOLD":case"ITALIC":case"UNDERLINE":case"STRIKEOUT":case"DBLUNDERLINE":case"OVERLINE":case"FLASH":case"REVERSE":n.push("%^"+e[o]+"%^"),i.push("%^"+e[o]+"%^");break;case"/DBLUNDERLINE":case"/OVERLINE":case"/FLASH":case"/REVERSE":case"/UNDERLINE":case"/BOLD":case"/ITALIC":case"/STRIKEOUT":n.pop(),this.cleanReset(i),i.push("%^RESET%^"),n.length>0&&i.push(n.join(""));break;case"SPAN":case"/SPAN":case"/BR":case"/DIV":break;case"DIV":case"BR":n.length>0&&i.length>0&&!i[i.length-1].endsWith("%^RESET%^")&&(this.cleanReset(i),i.push("%^RESET%^")),i.push(`
`),n.length>0&&i.push(n.join(""));break;case"RESET":n.length>0&&i.length>0&&!i[i.length-1].endsWith("%^RESET%^")&&(this.cleanReset(i),i.push("%^RESET%^")),n.length>0&&i.push(n.join(""));break;default:e[o].startsWith("COLOR: #")?(s=e[o].substr(8),this._colors[s]||(a=new X(s),s=this.nearestHex(a.toHex()).substr(1)),s=this._colors[s],(s==="BOLD BLACK"||s==="BOLD%^%^BLACK")&&(s="mono11"),n.push("%^"+s+"%^"),i.push("%^"+s+"%^")):e[o].startsWith("COLOR: ")?(s=new X(e[o].substr(7)).toHex().substr(1),this._colors[s]||(s=this.nearestHex("#"+s).substr(1)),s=this._colors[s],(s==="BOLD BLACK"||s==="BOLD%^%^BLACK")&&(s="mono11"),n.push("%^"+s+"%^"),i.push("%^"+s+"%^")):e[o].startsWith("/COLOR: ")?(n.pop(),this.cleanReset(i),i.push("%^RESET%^"),n.length>0&&i.push(n.join(""))):e[o].startsWith("BACKGROUND-COLOR: #")?(s=e[o].substr(19),this._colors[s]||(a=new X(s),s=this.nearestHex(a.toHex()).substr(1)),this._colors["B"+s]?s=this._colors["B"+s]:s=this._colors[s],s="%^B_"+s+"%^",n.push(s),i.push(s)):e[o].startsWith("BACKGROUND-COLOR: ")?(s=new X(e[o].substr(18)).toHex().substr(1),this._colors[s]||(s=this.nearestHex("#"+s).substr(1)),this._colors["B"+s]?s=this._colors["B"+s]:s=this._colors[s],s="%^B_"+s+"%^",n.push(s),i.push(s)):e[o].startsWith("/BACKGROUND-COLOR: ")?(n.pop(),this.cleanReset(i),i.push("%^RESET%^"),n.length>0&&i.push(n.join(""))):e[o].startsWith('"')&&i.push(e[o].substring(1,e[o].length-1));break}return i.join("")}cleanReset(t){let e=t.length-1;for(;e>=0;e--)if(t[e].startsWith("%^"))t.pop();else return t;return t}nearestHex(t){var e=this,i=function(s){var o=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;s=s.replace(o,function(f,c,y,u){return[c,c,y,y,u,u].join()});var r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?/i,a=r.exec(s),l=a?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null;return l},n=function(s){if(!s)throw new Error("The hex you provided is not formatted correctly. Please try in a format such as '#FFF' or '#DDFFDD'.");for(var o=Number.MAX_SAFE_INTEGER,r=null,a=0;a<e.colorList.length;a++){var l=e.colorList[a],f=Math.sqrt(Math.pow(s.r-l.rgb.r,2)+Math.pow(s.g-l.rgb.g,2)+Math.pow(s.b-l.rgb.b,2));f<o&&(o=f,r=l.hex)}return r};return n(i(t))}remove(){tinymce.remove(`#${this._element.id}`)}initialize(){this.isSimple||(this.initPlugins(),tinymce.init({license_key:"gpl",custom_colors:!1,selector:`textarea#${this._element.id}`,height:500,menubar:!1,browser_spellcheck:!0,resize:!0,statusbar:!1,nowrap:!0,force_br_newlines:!0,forced_root_block:"div",plugins:"pinkfish insertdatetime pinkfishtextcolor nonbreaking",color_picker_callback:(t,e,i)=>{this.openColorDialog(i,e||"")},color_picker_caption:"More&hellip;",textcolor_rows:"3",textcolor_cols:"8",toolbar:"send | append | undo redo | pinkfishforecolor pinkfishbackcolor | italic underline strikethrough overline dblunderline flash reverse | clear | copy copyformatted | insertdatetime",toolbar_mode:"sliding",content_css:"css/tinymce.content.min.css",formats:{bold:{inline:"strong",exact:!0,links:!0,remove_similar:!0},italic:{inline:"em",exact:!0,links:!0,remove_similar:!0},overline:{inline:"span",classes:"overline",links:!0,remove_similar:!0},dblunderline:{inline:"span",classes:"dblunderline",links:!0,remove_similar:!0},flash:{inline:"span",classes:"flash",links:!0,remove_similar:!0},reverse:{inline:"span",classes:"reverse",links:!0,remove_similar:!0},underline:{inline:"span",classes:"underline",links:!0,remove_similar:!0},strikethrough:{inline:"span",classes:"strikeout",links:!0,remove_similar:!0},forecolor:{inline:"span",styles:{textDecoration:"inherit",border:"inherit",color:"%value"},exact:!0,links:!0,remove_similar:!0},hilitecolor:{inline:"span",styles:{textDecoration:"inherit",border:"inherit",backgroundColor:"%value"},exact:!0,links:!0,remove_similar:!0}},init_instance_callback:t=>{t.shortcuts.add("ctrl+shift+c","Copy formatted",()=>Ot(this.getFormattedSelection().replace(/(?:\r)/g,""))),t.on("PastePreProcess",e=>{client.getOption("enableDebug")&&client.debug("Advanced Before Editor PastePreProcess: "+e.content),this.clearReverse($(".reverse",$(t.getDoc()).contents())),e.content=e.content.replace(/<\/p>/g,"<br>"),e.content=e.content.replace(/<\/h[1-6]>/g,"<br>"),e.content=e.content.replace(/<\/li>/g,"<br>");for(var i=/<pre(.*?)>((.|\s)*)<\/pre>/mgi,n;(n=i.exec(e.content))!==null;)n.index===i.lastIndex&&i.lastIndex++,e.content=e.content.substring(0,n.index)+e.content.substring(n.index,i.lastIndex).replace(/(\r\n|\r|\n)/g,"<br/>").replaceAll("  ","&nbsp;&nbsp;")+e.content.substring(i.lastIndex);client.getOption("enableDebug")&&client.debug("Advanced After Editor PastePreProcess: "+e.content)}),t.on("PastePreProcess",()=>{this.addReverse($(".reverse",$(t.getDoc()).contents()))}),$(".mce-content-body",tinymce.activeEditor.getDoc()).css("font-size",client.getOption("cmdfontSize")),$(".mce-content-body",tinymce.activeEditor.getDoc()).css("font-family",client.getOption("cmdfont")+", monospace"),tinymce.activeEditor.formatter?tinymce.activeEditor.formatter.register("flash",{inline:"span",classes:client.getOption("flashing")?"flash":"noflash",links:!0,remove_similar:!0}):tinymce.activeEditor.settings.formats.flash={inline:"span",classes:client.getOption("flashing")?"flash":"noflash",links:!0,remove_similar:!0},this.loadColors(),this.setFormatted(this.value),t.on("click",e=>{this.emit("click",e)}),this.emit("editor-init"),this._init=!0},paste_data_images:!1,paste_webkit_styles:"color background background-color text-decoration",valid_elements:"strong/b,em/i,u,span[style],span[class],strike/s,br",valid_styles:{"*":"color,background,background-color,text-decoration,font-weight"},color_map:this._ColorTable}))}focus(){this.isSimple?this._element.focus():this._init&&tinymce.activeEditor&&tinymce.activeEditor.initialized&&tinymce.activeEditor.focus()}};var kt=class p extends fe{constructor(){super({title:'<i class="fas fa-cogs"></i> Settings',keepCentered:!0,resizable:!1,moveable:!1,center:!0,maximizable:!1}),this.body.style.padding="10px",this.buildMenu();let h="";h+=`<button id="${this.id}-cancel" type="button" class="float-end btn btn-light" title="Cancel dialog">Cancel</button>`,h+=`<button id="${this.id}-save" type="button" class="float-end btn btn-primary" title="Confirm dialog">Save</button>`,h+=`<button id="${this.id}-reset" type="button" class="float-start btn btn-light" title="Reset settings">Reset</button>`,h+=`<button id="${this.id}-reset-all" type="button" class="float-start btn btn-light" title="Reset All settings">Reset All</button>`,h+='<div class="vr float-start" style="margin-right: 4px;height: 37px;"></div>',h+=`<button id="${this.id}-export" type="button" class="float-start btn btn-light" title="Export settings">Export</button>`,h+=`<button id="${this.id}-import" type="button" class="float-start btn btn-light" title="Import settings">Import</button>`,this.footer.innerHTML=h,this.footer.querySelector(`#${this.id}-cancel`).addEventListener("click",()=>{Ce(this._page),this.close()}),this.footer.querySelector(`#${this.id}-export`).addEventListener("click",()=>{var t=ge(this.settings);t.version=2,fileSaveAs.show(JSON.stringify(t),"oiMUD.settings.txt","text/plain")}),this.footer.querySelector(`#${this.id}-import`).addEventListener("click",()=>{be("Import settings").then(t=>{ye(t[0]).then(e=>{try{var i=JSON.parse(e),n,s;if(i.version===1){for(n=0,s=W.length;n<s;n++)this.settings[W[n][0]]=i[W[n][0]];this.emit("import-rooms",i.rooms)}else if(i.version===2&&!i.profiles)for(n=0,s=W.length;n<s;n++)this.settings[W[n][0]]=i[W[n][0]];else setTimeout(function(){new Ve("Invalid file","Unable to import file, not a valid settings file",4).showModal()},50);this.loadPageSettings()}catch(o){setTimeout(function(){new Ve("Error importing","Error importing file.",3).showModal()},50),client.error(o)}}).catch(client.error)}).catch(()=>{})}),this.footer.querySelector(`#${this.id}-reset`).addEventListener("click",()=>{if(this._page==="settings-colors"){let t=new Ae("Reset colors","Reset colors?");t.on("button-click",e=>{if(e.button===4){var i,n=this.settings.colors=[];for(i=0;i<16;i++)this.setColor("color"+i,n[i]||this.getDefaultColor(i));for(i=256;i<280;i++)this.setColor("color"+i,n[i]||this.getDefaultColor(i));this.body.querySelector("#colorScheme").value=0}}),t.showModal()}else if(this._page&&this._page!=="settings"&&this._page.length){let t=this._page.split("-"),e=Pt(t[t.length-1].match(/([A-Z]|^[a-z])[a-z]+/g).join(" ")),i=new Ae(`Reset ${e} settings`,`Reset ${e} settings?`);i.on("button-click",n=>{if(n.button===4){let s=this.body.querySelectorAll("input,select,textarea");for(let o=0,r=s.length;o<r;o++)this.settings[s[o].id]=we.defaultValue(s[o].id),s[o].type==="checkbox"?s[o].checked=this.settings[s[o].id]:s[o].value=this.settings[s[o].id]}}),i.showModal()}else{let t=new Ae("Reset all settings","Reset all settings?");t.on("button-click",e=>{e.button===4&&this.settings.reset()}),t.showModal()}}),this.footer.querySelector(`#${this.id}-reset-all`).addEventListener("click",()=>{let t=new Ae("Reset all settings","Reset all settings?");t.on("button-click",e=>{e.button===4&&this.settings.reset()}),t.showModal()}),this.footer.querySelector(`#${this.id}-save`).addEventListener("click",()=>{Ce(this._page);for(var t in this.settings)this.settings.hasOwnProperty(t)&&we.setValue(t,this.settings[t]);client.clearCache(),client.loadOptions(),this.close()}),this.settings=new we}setPage(h){this._page=h;let t=h.split("-"),e="",i=t.length-1;for(let n=0,s=t.length;n<s;n++){let o=Pt(t[n].match(/([A-Z]|^[a-z])[a-z]+/g).join(" "));n===i?e+='<li class="breadcrumb-item">'+o+"</li>":e+='<li class="breadcrumb-item" aria-current="page"><a href="#'+t.slice(0,n+1).join("-")+'">'+o+"</a></li>"}this.title='<i class="float-start fas fa-cogs" style="padding: 2px;margin-right: 2px;"></i> <ol class="float-start breadcrumb">'+e+"</ol>",h==="settings"?(this._menu&&(this._menu.style.display="none"),this.body.style.left="",this.footer.querySelector(`#${this.id}-reset`)&&(this.footer.querySelector(`#${this.id}-reset`).style.display="none"),this.body.innerHTML=p.menuTemplate,p.addPlugins(this.body.querySelector("div.contents"))):(this._menu&&(this._menu.style.display=""),this.footer.querySelector(`#${this.id}-reset`)&&(this.footer.querySelector(`#${this.id}-reset`).style.display=""),this.body.style.left="200px"),this.body.scrollTop=0,this.loadPageSettings()}buildMenu(){this.dialog.insertAdjacentHTML("beforeend",p.menuTemplate.replace(' style="top:0;position: absolute;left:0;bottom:49px;right:0;"',"")),this._menu=this.dialog.querySelector(".contents"),this._menu.classList.add("settings-menu"),p.addPlugins(this._menu),this._page==="settings"&&(this._menu.style.display="none"),this.body.style.left="200px"}loadPageSettings(){let h=this.body.querySelectorAll("input,select,textarea");if(this._page==="settings-colors"){var t,e=this.settings.colors||[];for(t=0;t<16;t++)this.setColor("color"+t,e[t]||this.getDefaultColor(t));for(t=256;t<280;t++)this.setColor("color"+t,e[t]||this.getDefaultColor(t));for(let i=0,n=h.length;i<n;i++)h[i].addEventListener("change",s=>{let o=s.currentTarget||s.target,r=o.value,a=parseInt(o.id.substring(5),10);var l=this.settings.colors||[];!l[a]||l[a].length===0?this.getDefaultColor(a)!==r&&(l[a]=r):this.getDefaultColor(a)!==r?delete l[a]:l[a]=r,this.settings.colors=l}),h[i].addEventListener("input",s=>{let o=s.currentTarget||s.target,r=o.value,a=parseInt(o.id.substring(5),10);!this.settings.colors[a]||this.settings.colors[a].length===0?this.getDefaultColor(a)!==r&&(this.settings.colors[a]=r):this.getDefaultColor(a)!==r?delete this.settings.colors[a]:this.settings.colors[a]=r})}else for(let i=0,n=h.length;i<n;i++)if(h[i].type==="radio")h[i].checked=""+this.settings[h[i].name]===h[i].value,h[i].addEventListener("change",s=>{let o=s.currentTarget||s.target;o.checked&&(this.settings[o.name]=this.convertType(o.value,typeof this.settings[o.name]))});else if(h[i].type==="checkbox"){if(h[i].dataset.enum==="true"){let s=h[i].name||h[i].id.substring(0,h[i].id.lastIndexOf("-")),o=+h[i].id.substring(h[i].id.lastIndexOf("-")+1);(this.settings[s]&o)===o&&(h[i].checked=!0)}else h[i].checked=this.settings[h[i].id];h[i].addEventListener("change",s=>{let o=s.currentTarget||s.target;if(o.dataset.enum==="true"){let r=o.name||o.id.substring(0,o.id.lastIndexOf("-")),a=this.body.querySelectorAll(`[name=${r}]`),l=0;for(let f=0,c=a.length;f<c;f++)a[f].checked&&(l|=+a[f].value);this.settings[r]=l}else this.settings[o.id]=o.checked||!1})}else h[i].value=this.settings[h[i].id],h[i].addEventListener("change",s=>{let o=s.currentTarget||s.target;this.setValue(o.id,o.value)}),h[i].addEventListener("input",s=>{let o=s.currentTarget||s.target;this.setValue(o.id,o.value)})}setColor(h,t){!t||typeof t>"u"||t.length===0?this.body.querySelector("#"+h).value="":this.body.querySelector("#"+h).value=this.colorHex(t)}colorHex(h){return h?(h=new X(h),h.ok?h.toHex():""):!1}getDefaultColor(h){return h===0?"rgb(0,0,0)":h===1?"rgb(128, 0, 0)":h===2?"rgb(0, 128, 0)":h===3?"rgb(128, 128, 0)":h===4?"rgb(0, 0, 128)":h===5?"rgb(128, 0, 128)":h===6?"rgb(0, 128, 128)":h===7?"rgb(192, 192, 192)":h===8?"rgb(128, 128, 128)":h===9?"rgb(255, 0, 0)":h===10?"rgb(0, 255, 0)":h===11?"rgb(255, 255, 0)":h===12?"rgb(0, 0, 255)":h===13?"rgb(255, 0, 255)":h===14?"rgb(0, 255, 255)":h===15?"rgb(255, 255, 255)":h===256?"rgb(0, 0, 0)":h===257?"rgb(118, 0, 0)":h===258?"rgb(0, 108, 0)":h===259?"rgb(145, 136, 0)":h===260?"rgb(0, 0, 108)":h===261?"rgb(108, 0, 108)":h===262?"rgb(0, 108, 108)":h===263?"rgb(160, 160, 160)":h===264?"rgb(0, 0, 0)":h===265?"rgb(128, 0, 0)":h===266?"rgb(0, 128, 0)":h===267?"rgb(128, 128, 0)":h===268?"rgb(0, 0, 128)":h===269?"rgb(128, 0, 128)":h===270?"rgb(0, 128, 128)":h===271?"rgb(192, 192, 192)":h===272?"rgb(0,0,0)":h===273?"rgb(0, 255, 255)":h===274?"rgb(0,0,0)":h===275?"rgb(255, 255, 0)":h===276?"rgb(0, 0, 0)":h===277?"rgb(192, 192, 192)":h===278?"rgb(128, 0, 0)":h===279?"rgb(192, 192, 192)":h===280?"rgb(255,255,255)":""}setValue(h,t){t=="false"&&(t=!1),t=="true"&&(t=!0),t=="null"&&(t=null),t=="undefined"&&(t=void 0),typeof t=="string"&&parseFloat(t).toString()==t&&(t=parseFloat(t)),this.settings[h]=this.convertType(t,this.settings[h])}convertType(h,t){if(typeof h===t)return h;switch(t){case"number":return typeof h=="string"&&parseFloat(h).toString()==h?parseFloat(h):Number(h);case"boolean":return!!h}return h}static addPlugins(h){let t=client.plugins.length,e,i;for(let n=0;n<t;n++)if(client.plugins[n].settings&&client.plugins[n].settings.length)for(i=client.plugins[n].settings.length,e=0;e<i;e++){let s=client.plugins[n].settings[e];if(typeof s.action!="string")continue;let o=`<a href="#${s.action}" class="list-group-item list-group-item-action">${s.icon||""}${s.name||""}</a>`;if("position"in s){if(typeof s.position=="string"){if(h.querySelector(s.position)){h.querySelector(s.position).insertAdjacentHTML("afterend",o);continue}}else if(s.position>=0&&s.position<h.children.length){h.children[s.position].insertAdjacentHTML("afterend",o);continue}}h.insertAdjacentHTML("beforeend",o)}}static get menuTemplate(){return'<div class="contents list-group list-group-flush" style="top:0;position: absolute;left:0;bottom:49px;right:0;"><a href="#settings-general" class="list-group-item list-group-item-action"><i class="fas fa-cogs"></i> General</a><a href="#settings-display" class="list-group-item list-group-item-action"><i class="fas fa-display"></i> Display</a><a href="#settings-colors" class="list-group-item list-group-item-action"><i class="fas fa-palette"></i> Colors</a><a href="#settings-commandLine" class="list-group-item list-group-item-action"><i class="fas fa-terminal"></i> Command line</a><a href="#settings-tabCompletion" class="list-group-item list-group-item-action"><i class="fa-solid fa-arrow-right-to-bracket"></i> Tab completion</a><a href="#settings-telnet" class="list-group-item list-group-item-action"><i class="fas fa-network-wired"></i> Telnet</a><a href="#settings-scripting" class="list-group-item list-group-item-action"><i class="fas fa-code"></i> Scripting</a><a href="#settings-specialCharacters" class="list-group-item list-group-item-action"><i class="fa-regular fa-file-code"></i> Special characters</a><a href="#settings-advanced" class="list-group-item list-group-item-action"><i class="fa-solid fa-sliders"></i> Advanced</a></div>'}};var Y,j;function Oi(){let p;ai(),client.input.on("history-navigate",()=>{(client.getOption("commandAutoSize")||client.getOption("commandScrollbars"))&&Te()}),client.on("options-loaded",()=>{if(client.commandInput.removeEventListener("input",Te),client.commandInput.removeEventListener("change",Te),ci(),pi(),(client.getOption("commandAutoSize")||client.getOption("commandScrollbars"))&&Te(),j&&(j.resetState(client.getOption("windows.editor")||{center:!0}),Y.simple!=client.getOption("simpleEditor"))){let h="";Y.isSimple||(h=Y.getFormattedText().replace(/(?:\r)/g,"")),Y.simple=client.getOption("simpleEditor"),Y.isSimple?(Y.value=h,j.showFooter(),j.header.querySelector("#adv-editor-switch").title="Switch to advanced",setTimeout(()=>Y.focus(),100)):(j.hideFooter(),j.header.querySelector("#adv-editor-switch").title="Switch to simple")}}),client.on("set-title",h=>{window.document.title=h}),document.getElementById("btn-adv-editor").addEventListener("click",h=>{if(!j){j=new fe(Object.assign({},client.getOption("windows.editor")||{center:!0},{title:'<i class="fas fa-edit"></i> Advanced editor',id:"adv-editor"})),j.on("resized",e=>{client.setOption("windows.editor",e)}),j.on("moved",e=>{client.setOption("windows.editor",e)}),j.on("maximized",()=>{client.setOption("windows.editor",j.windowState)}),j.on("restored",()=>{client.setOption("windows.editor",j.windowState)}),j.on("shown",()=>{client.setOption("windows.editor",j.windowState),Y.initialize()}),j.on("closing",()=>{Y.remove()}),j.on("closed",()=>{client.setOption("windows.editor",j.windowState),Ce("editor")}),j.on("canceling",()=>{Y.remove()}),j.on("canceled",()=>{client.setOption("windows.editor",j.windowState),Ce("editor")}),j.on("focus",()=>Y.focus());let t=document.createElement("textarea");t.classList.add("form-control","form-control-sm"),t.id="adv-editor-txt",j.body.appendChild(t),j.body.style.overflow="hidden",Y||(Y=new xt(t,!client.getOption("simpleEditor"))),Y.on("close",()=>{j.close()}),Y.on("editor-init",()=>Y.focus()),Y.on("click",()=>j.focus()),j.dialog.editor=Y,tinymce&&j.header.querySelector("#adv-editor-max").insertAdjacentHTML("afterend",'<button type="button" class="btn btn-light float-end" id="adv-editor-switch" title="Switch to advanced" style="padding: 0 4px;margin-top: -1px;"><i class="bi-shuffle"></i></button>'),j.footer.innerHTML=`<button id="btn-adv-editor-clear" type="button" class="float-start btn btn-light" title="Clear editor">Clear</button>
                <button id="btn-adv-editor-append" type="button" class="float-start btn btn-light" title="Append file...">Append file...</button>
                <button id="btn-adv-editor-send" type="button" class="float-end btn btn-primary" title="Send">Send</button>`,Y.isSimple||(j.header.querySelector("#adv-editor-switch").title="Switch to simple"),j.header.querySelector("#adv-editor-switch").addEventListener("click",()=>{client.setOption("simpleEditor",!Y.simple);let e="";Y.isSimple||(e=Y.getFormattedText().replace(/(?:\r)/g,"")),Y.simple=!Y.simple,Y.isSimple?(Y.value=e,j.showFooter(),j.header.querySelector("#adv-editor-switch").title="Switch to advanced",setTimeout(()=>Y.focus(),100)):(j.hideFooter(),j.header.querySelector("#adv-editor-switch").title="Switch to simple")}),document.getElementById("btn-adv-editor-append").addEventListener("click",()=>{be("Append file",!1).then(e=>{ye(e[0]).then(i=>{Y.insert(i)}).catch(client.error)}).catch(()=>{})}),document.getElementById("btn-adv-editor-send").addEventListener("click",()=>{client.sendCommand(Y.value()),client.getOption("editorClearOnSend")&&Y.clear(),client.getOption("editorCloseOnSend")&&j.close()}),document.getElementById("btn-adv-editor-clear").addEventListener("click",()=>{Y.clear(),Y.focus()}),Y.isSimple||j.hideFooter()}j.show(),Y.isSimple&&Y.focus()}),p=client.getOption("windows.editor"),p&&p.show&&document.getElementById("btn-adv-editor").click(),document.getElementById("btn-command-history").addEventListener("show.bs.dropdown",function(){document.body.appendChild(document.getElementById("command-history-menu"))}),document.getElementById("btn-command-history").addEventListener("hidden.bs.dropdown",function(){document.getElementById("btn-command-history").parentElement.appendChild(document.getElementById("command-history-menu"))}),client.commandInput.removeEventListener("input",Te),client.commandInput.removeEventListener("change",Te),ci(),pi(),(client.getOption("commandAutoSize")||client.getOption("commandScrollbars"))&&Te(),window.addEventListener("hashchange",hi,!1),window.addEventListener("load",hi)}function Ce(p){if(!(!p||p.length===0)){p=p.trim(),p.startsWith("#")&&(p=p.substring(1));var h=decodeURI(window.location.hash.substring(1)).split(",").filter(t=>t.trim()!==p);window.location.hash=h.join(",")}}function hi(){if(!(!window.location.hash||window.location.hash.length<2)){var p=decodeURI(window.location.hash.substring(1)).split(",").map(h=>h.trim());for(let h=p.length-1;h>=0;h--)switch(p[h]){case"about":st("about");break;case"editor":document.getElementById("btn-adv-editor").click();break;default:p[h].startsWith("settings")&&st(p[h]);break}}}var te={};function st(p){switch(p){case"about":return te.about||(te.about=new fe({title:'<i class="bi-info-circle"></i> About',noFooter:!0,resizable:!1,center:!0,maximizable:!1}),te.about.on("closed",()=>{delete te.about,Ce(p)}),te.about.on("canceled",()=>{delete te.about,Ce(p)})),ui(te.about,p,1,!0).catch(h=>{client.error(h)}),te.about}if(p.startsWith("settings"))return te.settings||(te.settings=new kt,te.settings.on("closed",()=>{delete te.settings,Ce(p)}),te.settings.on("canceled",()=>{delete te.settings,Ce(p)})),p==="settings"?(te.settings.dialog.dataset.path=p,te.settings.dialog.dataset.fullPath=p,te.settings.dialog.dataset.hash=window.location.hash,te.settings.setPage(p),te.settings.showModal()):ui(te.settings,p,2,!1).then(()=>{te.settings.setPage(p)}).catch(h=>{client.error(h)}),te.settings}function ui(p,h,t,e){return new Promise((i,n)=>{var s=h.split("/");$.ajax({url:"dialogs/"+s[0]+".htm",cache:!1,type:"GET"}).done(function(o){p.dialog.dataset.path=s[0],p.dialog.dataset.fullPath=h,p.dialog.dataset.hash=window.location.hash,p.body.innerHTML=o;let r=p.body.querySelectorAll("script");for(let a=0,l=r.length;a<l;a++)new Function("body","client","dialog",r[a].textContent).apply(client,[p.body,client,p]);t==1?p.show():t===2&&p.showModal(),i(o)}).fail(function(o){e&&client.enableDebug?p.body.innerHTML=`<h1 style="width: 100%;text-align:center">Error loading ${h}</h1> ${o.statusText}`:e?p.body.innerHTML=`<h1 style="width: 100%;text-align:center">Error loading ${h}</h1>`:p.body.innerHTML="",n(h+": "+s.statusText)})})}function Te(){Ge(()=>{Di()},250,"resizeCommand")}async function ci(){(client.getOption("commandAutoSize")||client.getOption("commandScrollbars"))&&(client.commandInput.addEventListener("input",Te),client.commandInput.addEventListener("change",Te)),client.getOption("commandWordWrap")?(document.getElementById("commandMeasure").style.whiteSpace="pre-wrap",document.getElementById("commandMeasure").style.overflowWrap="anywhere"):(document.getElementById("commandMeasure").style.whiteSpace="",document.getElementById("commandMeasure").style.overflowWrap=""),client.getOption("commandScrollbars")?(document.getElementById("commandMeasure").style.overflow="auto",client.commandInput.style.overflow="auto"):(document.getElementById("commandMeasure").style.overflow="",client.commandInput.style.overflow="")}var Qe={};function pi(){let p=document.getElementById("commandMeasure");document.body.appendChild(p);let h=client.commandInput.parentElement,t=window.getComputedStyle(h);p.style.fontSize=client.commandInput.style.fontSize,p.style.fontFamily=client.commandInput.style.fontFamily,p.style.width=client.commandInput.offsetWidth+"px";let e=p.innerHTML;p.innerHTML="W";let i=client.getOption("commandMinLines"),n=p.offsetHeight;i=n*(i<1?1:i);let s=parseFloat(t.borderTopWidth)||0;s+=parseFloat(t.borderBottomWidth)||0,s+=parseFloat(t.paddingTop)||0,s+=parseFloat(t.paddingBottom)||0;let o=t.inset.split(" ");s+=(parseFloat(o[0])||0)*2,p.innerHTML=e,h.style.height=n+s+"px",client.commandInput.parentElement.style.height=n+"px",client.commandInput.closest("nav").style.height=n+6+"px",client.display.container.style.bottom=n+s+"px",Qe={measure:p,cmd:h,cmdSize:t,height:n,padding:s,minHeight:i}}function Di(){let p=Qe.measure,h=Qe.cmd;p.innerHTML=client.commandInput.value+`
`;let t=p.offsetHeight;t<Qe.minHeight&&(t=Qe.minHeight);let e=Qe.padding;h.style.height=t+e+"px",client.commandInput.parentElement.style.height=t+"px",client.commandInput.closest("nav").style.height=t+6+"px",client.display.container.style.bottom=t+e+"px"}window.initializeInterface=Oi;})();
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
/**
 * A class to parse color values
 * @author Stoyan Stefanov <sstoo@gmail.com>
 * @link   http://www.phpied.com/rgb-color-parser-in-javascript/
 * @license Use it if you like it
 */
//# sourceMappingURL=oiMUD.min.js.map
